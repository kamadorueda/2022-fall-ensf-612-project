{
  "_url": "https://github.com/PowerShell/PowerShell/issues/3064",
  "author": "lzybkr",
  "body": "In rare cases, it was possible to cause high contention on a lock used\r\nwhile compiling code to run in the interpreter.\r\n\r\nThis fixes the problem in a couple different ways:\r\n\r\n* Use ConditionalWeakTable which has finer granularity in locking\r\n* Avoid dictionary lookups in the most common cases\r\n  - There really aren't too many real cases, I could have covered them\r\n    all, but keeping the code generic is useful for the future.\r\n\r\nNot quite related, but I noticed we didn't cache certain interpreter\r\ninstructions and it made sense to add a cache because we generate a lot\r\nof array-init instructions.",
  "closed_at": "2017-02-07T07:09:55Z",
  "comments": [
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "Can we have a comparison of compiling a large script / module, something like this one: https://github.com/PowerShell/PowerShellGet/blob/development/PowerShellGet/PSModule.psm1\r\n\r\nThis is to verify we do not have any regressions in compilation times.\r\n\r\n",
      "created_at": "2017-01-27T22:58:07Z",
      "updated_at": "2017-01-27T22:58:07Z"
    },
    {
      "author": "lzybkr",
      "author_association": "MEMBER",
      "body": "The difference is not measurable - other factors like garbage collection introduce too much variability in the measurements to detect a difference.\r\n\r\nThe performance improvement would only be noticeable with many threads (more then the number of cores) all compiling at the same time.",
      "created_at": "2017-01-27T23:41:31Z",
      "updated_at": "2017-01-27T23:41:31Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "I understand that the improvement is not noticeable. But, can we sanity check that there is no major regression, since we do not have any performance tests.",
      "created_at": "2017-01-27T23:45:06Z",
      "updated_at": "2017-01-27T23:45:06Z"
    },
    {
      "author": "lzybkr",
      "author_association": "MEMBER",
      "body": "I did sanity check which is how I came to the conclusion that the difference is not measurable.",
      "created_at": "2017-01-27T23:52:11Z",
      "updated_at": "2017-01-27T23:52:11Z"
    }
  ],
  "created_at": "2017-01-27T21:59:23Z",
  "number": 3064,
  "state": "closed",
  "title": "Fix lock contention during script compilation",
  "updated_at": "2018-01-09T20:42:43Z"
}