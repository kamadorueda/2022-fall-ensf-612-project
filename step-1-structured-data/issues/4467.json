{
  "_url": "https://github.com/PowerShell/PowerShell/issues/4467",
  "author": "markekraus",
  "body": "<!--\r\n\r\nIf it is a bug report:\r\n- make sure you are able to repro it on the latest released version. \r\nYou can install the latest version from https://github.com/PowerShell/PowerShell/releases\r\n- Search the existing issues.\r\n- Refer to the [FAQ](../docs/FAQ.md).\r\n- Refer to the [known issues](../docs/KNOWNISSUES.md).\r\n- Fill out the following repro template\r\n\r\nIf it's not a bug, please remove the template and elaborate the issue in your own words.\r\n-->\r\nThe `Content-Type` header appears to be missing everywhere except `$response.BaseResponse.Content.Headers.ContentType`. it is even being removed from `$response.RawContent` . it happens regardless of using `-UseBasicParsing` or not, regardless of `-method` and regardless of `-UserAgent`.\r\n\r\nSteps to reproduce\r\n------------------\r\n\r\n```powershell\r\nDescribe 'Invoke-WebRequest' {\r\n    Context 'Response: Content-Type Header' {\r\n        $Uri = 'http://httpbin.org/headers'\r\n        $response = Invoke-WebRequest -Uri $Uri\r\n        It \"Has BaseResponse.Content.Headers.ContentType\" {\r\n            $response.BaseResponse.Content.Headers.ContentType | \r\n            Should Not BeNullOrEmpty\r\n        }\r\n        It \"Has Headers.'Content-Type'\" {\r\n            $response.Headers.ContainsKey('Content-Type') | Should Be $True\r\n            $response.Headers.'Content-Type' | Should Not BeNullOrEmpty\r\n        }\r\n        It \"Has BaseResponse.Headers.'Content-Type'\" {\r\n            $response.BaseResponse.Headers.Keys -contains 'Content-Type' | Should Be $True\r\n            $response.BaseResponse.Headers.Get('Content-Type') | Should Not BeNullOrEmpty\r\n        }\r\n        It \"Has BaseResponse.ContentType\" {\r\n            $response.BaseResponse.ContentType | Should Not BeNullOrEmpty\r\n        }\r\n        It \"Has Content-Type in the RawContent\" {\r\n            $response.RawContent -match 'Content-Type' | Should Be $True\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nExpected behavior\r\n-----------------\r\n\r\n```none\r\nDescribing Invoke-WebRequest\r\n\r\n  Context Response: Content-Type Header\r\n    [+] Has BaseResponse.Content.Headers.ContentType.MediaType 12.62s\r\n    [+] Has Headers.'Content-Type' 11.36s\r\n    [+] Has BaseResponse.Headers.'Content-Type' 28ms\r\n    [+] Has BaseResponse.ContentType 10ms\r\n    [+] Has Content-Type in the RawContent 18ms\r\n```\r\n\r\nActual behavior\r\n---------------\r\n\r\n```none\r\nDescribing Invoke-WebRequest\r\n   Context Response: Content-Type Header\r\n    [+] Has BaseResponse.Content.Headers.ContentType 13.59s\r\n    [-] Has Headers.'Content-Type' 42ms\r\n      Expected: {True}\r\n      But was:  {False}\r\n      at line: 10 in\r\n      10:             $response.Headers.ContainsKey('Content-Type') | Should Be $True\r\n    [-] Has BaseResponse.Headers.'Content-Type' 23ms\r\n      Expected: {True}\r\n      But was:  {False}\r\n      at line: 14 in\r\n      14:             $response.BaseResponse.Headers.Keys -contains 'Content-Type' | Should Be $True\r\n    [-] Has BaseResponse.ContentType 24ms\r\n      Expected: value to not be empty\r\n      at line: 18 in\r\n      18:             $response.BaseResponse.ContentType | Should Not BeNullOrEmpty\r\n    [-] Has Content-Type in the RawContent 28ms\r\n      Expected: {True}\r\n      But was:  {False}\r\n      at line: 21 in\r\n      21:             $response.RawContent -match 'Content-Type' | Should Be $True\r\n```\r\n\r\nEnvironment data\r\n----------------\r\n\r\n<!-- provide the output of $PSVersionTable -->\r\n\r\n```powershell\r\n> $PSVersionTable\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.0.0-beta\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.0-beta.4\r\nOS                             Microsoft Windows 10.0.15063\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n",
  "closed_at": "2017-08-03T16:16:30Z",
  "comments": [
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Compared to Windows PowerShell 5.1 it seems that `Content-Length` is also missing",
      "created_at": "2017-08-03T15:58:16Z",
      "updated_at": "2017-08-03T15:58:16Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Looks like this is `by design` of `HttpResponseMessage` (you'll have to open an issue with corefx if you want it changed).  You can still get them, but they are in a different part of the object:\r\n\r\n```powershell\r\nPS C:\\Users\\slee\\repos\\PowerShell> $o = Invoke-WebRequest http://bing.com\r\nPS C:\\Users\\slee\\repos\\PowerShell> $o.Headers\r\n\r\nKey                       Value\r\n---                       -----\r\nCache-Control             {max-age=0, private}\r\nDate                      {Thu, 03 Aug 2017 16:15:23 GMT}\r\nP3P                       {CP=\"NON UNI COM NAV STA LOC CURa DEVa PSAa PSDa OUR IND\"}\r\nSet-Cookie                {SRCHD=AF=NOFORM; domain=.bing.com; expires=Sat, 03-Aug-2019 16:15:24 GMT; path=/, SRCHUID...\r\nVary                      {Accept-Encoding}\r\nStrict-Transport-Security {max-age=10886400; includeSubDomains; preload}\r\nX-MSEdge-Ref              {Ref A: 54EF10511D70472CACD48B2E03FDB68F Ref B: WSTEDGE0518 Ref C: 2017-08-03T16:15:24Z}\r\n\r\n\r\nPS C:\\Users\\slee\\repos\\PowerShell> $o.BaseResponse.Content.Headers\r\n\r\nKey            Value\r\n---            -----\r\nContent-Length {127796}\r\nContent-Type   {text/html; charset=utf-8}\r\n\r\n\r\nPS C:\\Users\\slee\\repos\\PowerShell> $o.BaseResponse.Headers\r\n\r\nKey                       Value\r\n---                       -----\r\nCache-Control             {max-age=0, private}\r\nDate                      {Thu, 03 Aug 2017 16:15:23 GMT}\r\nP3P                       {CP=\"NON UNI COM NAV STA LOC CURa DEVa PSAa PSDa OUR IND\"}\r\nSet-Cookie                {SRCHD=AF=NOFORM; domain=.bing.com; expires=Sat, 03-Aug-2019 16:15:24 GMT; path=/, SRCHUID...\r\nVary                      {Accept-Encoding}\r\nStrict-Transport-Security {max-age=10886400; includeSubDomains; preload}\r\nX-MSEdge-Ref              {Ref A: 54EF10511D70472CACD48B2E03FDB68F Ref B: WSTEDGE0518 Ref C: 2017-08-03T16:15:24Z}\r\n```\r\n\r\nAs you can see, the `Headers` property of the output object just mirrors `.BaseResponse.Headers`",
      "created_at": "2017-08-03T16:16:30Z",
      "updated_at": "2017-08-03T16:16:30Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "The new location on the objects is somewhat understandable, but, what about it being missing from `RawResponse` on `Microsoft.PowerShell.Commands.BasicHtmlWebResponseObject`? \r\n\r\n```powershell\r\n$Uri = 'http://httpbin.org/headers'\r\n$response = Invoke-WebRequest -Uri $Uri\r\n$response.RawContent\r\n````\r\n\r\n5.1: \r\n```none\r\nHTTP/1.1 200 OK\r\nConnection: keep-alive\r\nAccess-Control-Allow-Origin: *\r\nAccess-Control-Allow-Credentials: true\r\nX-Processed-Time: 0.000962972640991\r\nContent-Length: 181\r\nContent-Type: application/json\r\nDate: Thu, 03 Aug 2017 16:23:14 GMT\r\nServer: meinheld/0.6.1\r\nVia: 1.1 vegur\r\nX-Powered-By: Flask\r\n\r\n{\r\n  \"headers\": {\r\n    \"Connection\": \"close\", \r\n    \"Host\": \"httpbin.org\", \r\n    \"User-Agent\": \"Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) WindowsPowerShell/5.1.14393.1480\"\r\n  }\r\n}\r\n```\r\n\r\n6:\r\n```none\r\nHTTP/1.1 200 OK\r\nConnection: keep-alive\r\nDate: Thu, 03 Aug 2017 16:21:22 GMT\r\nVia: 1.1 vegur\r\nServer: meinheld/0.6.1\r\nAccess-Control-Allow-Origin: *\r\nAccess-Control-Allow-Credentials: true\r\nX-Powered-By: Flask\r\nX-Processed-Time: 0.000738143920898\r\n\r\n{\r\n  \"headers\": {\r\n    \"Accept-Encoding\": \"peerdist\",\r\n    \"Connection\": \"close\",\r\n    \"Host\": \"httpbin.org\",\r\n    \"User-Agent\": \"Mozilla/5.0 (Windows NT; Microsoft Windows 10.0.14393 ; en-US) WindowsPowerShell/6.0.0\",\r\n    \"X-P2P-Peerdist\": \"Version=1.1\",\r\n    \"X-P2P-Peerdistex\": \"MinContentInformation=1.0, MaxContentInformation=2.0\"\r\n  }\r\n}\r\n```\r\nOne would expect the `RawContent` to truly be a \"Raw Content\". Is this also related to the CoreFX change? Is it something that should be worked around in PowerShell 6? Or should the expectation change that `Contet-Type` and `Content-Length` will not be available in `RawContent`?\r\n",
      "created_at": "2017-08-03T16:28:42Z",
      "updated_at": "2017-08-03T16:28:42Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "The big difference between 6 and 5.1 is that 5.1 uses the WebResponse class while 6 uses the HttpResponseMessage class due to differences between CoreFx and .Net.  In the case of `RawContent`, it's just a \"manual\" serialization of HttpResponseMessage where those headers are not present.  If coreFx put it \"back\", they would just show up with this cmdlet.\r\n\r\nWe could add some specialized code to just add them, but it seems the correct change is in corefx.",
      "created_at": "2017-08-03T20:39:00Z",
      "updated_at": "2017-08-03T20:39:00Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "Digging around the CoreFX source for `System.Net.Http.HttpResponseMessage`, It appears the separation of the content headers is very much deliberate. The `ToString()` [override](https://github.com/karajas/corefx/blob/master/src/System.Net.Http/src/System/Net/Http/HttpResponseMessage.cs#L167) is calling `HeaderUtilities.DumpHeaders()` and passing both `_headers` and `_content`.  I don't think there is any chance of that being reversed.\r\n\r\nI'll do a PR for replicating that functionality in `ContentHelper`",
      "created_at": "2017-08-03T22:18:23Z",
      "updated_at": "2017-08-03T22:18:23Z"
    }
  ],
  "created_at": "2017-08-02T22:33:31Z",
  "number": 4467,
  "state": "closed",
  "title": "Invoke-WebRequest removes the Content-Type header from WebResponseObject's",
  "updated_at": "2017-08-03T22:18:23Z"
}