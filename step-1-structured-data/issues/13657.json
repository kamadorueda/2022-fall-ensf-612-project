{
  "_url": "https://github.com/PowerShell/PowerShell/issues/13657",
  "author": "mklement0",
  "body": "Follow-up from #13636:\r\n\r\nModule auto-loading that occurs while `$VerbosePreference = 'Continue'` is in effect is always quiet with respect to the module _itself_, but verbose messages unexpectedly surface if the module happens to have _module dependencies_ and/or happens to execute PowerShell code that potentially produces verbose output.\r\n\r\nAdditionally, it appears that verbose messages surfaced this way cannot be redirected with `4>`.\r\n\r\nAuto-loading of modules should _never_ emit verbose messages: It is an engine-internal feature, whereas verbose output requested of a cmdlet should only emit verbose messages emitted by the _cmdlet itself_.\r\n\r\nSpecifically, unexpected verbose output is produced in the following scenarios:\r\n\r\n* always: dependent modules imported via the `RequiredModules` and `NestedModules` module-manifest keys\r\n* depending on the specific code executed:\r\n    * run-in-the-caller's-scope-on-import scripts specified via `ScriptsToProcess`\r\n    * top-level code executed in `*.psm1` files being imported, notably calls to `Export-ModuleMember`. \r\n\r\n**Note**: An alternative to making auto-loading completely silent in terms of verbose output is to let it emit a _single_ message, indicating only the import of the directly targeted module _itself_; e.g. \r\n`Loading module from path '/Users/jdoe/.powershell/Modules/PowerShellGet/PowerShellGet.psd1'`\r\n\r\n## Steps to reproduce\r\n\r\n```powershell\r\n# OK: PSReadLine has no module dependencies / runs no scripts - NO OUPTUT\r\n& { Remove-Module -Ea Ignore PSReadLine; $VerbosePreference = 'Continue'; $null = Get-PSReadLineOption; $VerbosePreference = 'SilentlyContinue' } \r\n\r\n\r\n# Unexpected output: Module PowerShellGet depends on module PackageManagement \r\n# - import of the latter produces verbose output.\r\n& { Remove-Module -ea Ignore PowerShellGet, PackageManagement; $VerbosePreference = 'Continue'; $null = Get-InstalledModule; $VerbosePreference = 'SilentlyContinue' }\r\n```\r\n\r\nNote: No Pester tests are used, because there is seemingly no way to capture the verbose messages being emitted (neither `4>&1` nor `*>&1` work).\r\n\r\n## Expected behavior\r\n\r\nBoth commands should produce no output.\r\n\r\n## Actual behavior\r\n\r\nThe second test produces output, because the loading of the dependent `PackageManagement` module - not the `PowerShellGet` module itself - unexpectedly emitted verbose messages:\r\n\r\n```powershell\r\nVERBOSE: Loading module from path '/Users/mklement/.powershell-PREVIEW/Modules/PackageManagement/PackageManagement.psm1'.\r\nVERBOSE: Loading module from path '/Users/mklement/.powershell-PREVIEW/Modules/PackageManagement/PackageManagement.psd1'.\r\nVERBOSE: Loading 'FormatsToProcess' from path '/Users/mklement/.powershell-PREVIEW/Modules/PackageManagement/PackageManagement.format.ps1xml'.\r\nVERBOSE: Loading module from path '/Users/mklement/.powershell-PREVIEW/Modules/PackageManagement/PackageManagement.psm1'.\r\nVERBOSE: Exporting cmdlet 'Find-Package'.\r\nVERBOSE: Exporting cmdlet 'Find-PackageProvider'.\r\nVERBOSE: Exporting cmdlet 'Get-Package'.\r\nVERBOSE: Exporting cmdlet 'Get-PackageProvider'.\r\nVERBOSE: Exporting cmdlet 'Get-PackageSource'.\r\nVERBOSE: Exporting cmdlet 'Import-PackageProvider'.\r\nVERBOSE: Exporting cmdlet 'Install-Package'.\r\nVERBOSE: Exporting cmdlet 'Install-PackageProvider'.\r\nVERBOSE: Exporting cmdlet 'Register-PackageSource'.\r\nVERBOSE: Exporting cmdlet 'Save-Package'.\r\nVERBOSE: Exporting cmdlet 'Set-PackageSource'.\r\nVERBOSE: Exporting cmdlet 'Uninstall-Package'.\r\nVERBOSE: Exporting cmdlet 'Unregister-PackageSource'.\r\nVERBOSE: Importing cmdlet 'Find-Package'.\r\nVERBOSE: Importing cmdlet 'Find-PackageProvider'.\r\nVERBOSE: Importing cmdlet 'Get-Package'.\r\nVERBOSE: Importing cmdlet 'Get-PackageProvider'.\r\nVERBOSE: Importing cmdlet 'Get-PackageSource'.\r\nVERBOSE: Importing cmdlet 'Import-PackageProvider'.\r\nVERBOSE: Importing cmdlet 'Install-Package'.\r\nVERBOSE: Importing cmdlet 'Install-PackageProvider'.\r\nVERBOSE: Importing cmdlet 'Register-PackageSource'.\r\nVERBOSE: Importing cmdlet 'Save-Package'.\r\nVERBOSE: Importing cmdlet 'Set-PackageSource'.\r\nVERBOSE: Importing cmdlet 'Uninstall-Package'.\r\nVERBOSE: Importing cmdlet 'Unregister-PackageSource'.\r\n```\r\n\r\n## Environment data\r\n\r\n```none\r\nPowerShell Core 7.1.0-preview.7\r\n```\r\n",
  "closed_at": null,
  "comments": [],
  "created_at": "2020-09-18T19:57:13Z",
  "labels": [
    "Issue-Question",
    "WG-Engine"
  ],
  "number": 13657,
  "state": "open",
  "title": "Module auto-loading unexpectedly surfaces import-related verbose messages for modules with dependencies",
  "updated_at": "2020-09-23T18:04:16Z"
}