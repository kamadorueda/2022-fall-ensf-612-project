{
  "_url": "https://github.com/PowerShell/PowerShell/issues/9509",
  "author": "SteveL-MSFT",
  "body": "<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\nThe current logic of `Get-ChildItem -Recurse` for the FileSystemProvider is that if it's a symlink, we don't recurse into it unless `-FollowSymLink` is specified.  However, OneDrive reparse points aren't symlinks (in that they don't link to the local filesystem).  There is another flag (on Windows) to indicate if the reparse point is a named surrogate which means it IS a symlink.  So the fix is to check for this flag and if it's not a named surrogate (aka symlink), it is ok to recurse into it.\r\n\r\nManually verified with OneDrive.\r\n\r\n## PR Context\r\n\r\nFix https://github.com/PowerShell/PowerShell/issues/9461\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n- **Testing - New and feature**\r\n    - [x] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n",
  "closed_at": "2019-05-07T00:28:01Z",
  "comments": [
    {
      "author": "sba923",
      "author_association": "CONTRIBUTOR",
      "body": "Impressive fix... relying on very undocumented stuff if you ask me... unless \"named surrogates\" and \"data.dwReserved0 & 0x20000000\" is documented somewhere. @SteveL-MSFT?\r\n\r\n+ my understanding is that there won't be a 6.3 before 7.0, correct? ",
      "created_at": "2019-05-03T21:16:27Z",
      "updated_at": "2019-05-03T21:16:27Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@sba923 correct, next version is 7.0-preview.1.  As noted in the comments in the change, the use of `dwReserved0 & 0x20000000` is documented via the macro published in the Windows SDK header.  I agree that it would have been better as an API (or even better just another FileAttribute), but that's what we have to work with right now.",
      "created_at": "2019-05-03T21:56:13Z",
      "updated_at": "2019-05-03T21:56:13Z"
    },
    {
      "author": "sba923",
      "author_association": "CONTRIBUTOR",
      "body": "@SteveL-MSFT Thanks for the confirmation about 7.0. I had missed the comment with the reference to the `IsReparseTagNameSurrogate` macro, sorry for that. Reparse point tags are documented [here](https://docs.microsoft.com/en-us/windows/desktop/FileIO/reparse-point-tags), this documents the `N` (Name surrogate) bit with value `0x20000000`, and links to [another documentation for the macro](https://docs.microsoft.com/en-us/windows/desktop/api/Winnt/nf-winnt-isreparsetagnamesurrogate).\r\n\r\nThe [documentation for WIN32_FIND_DATAA](https://docs.microsoft.com/en-us/windows/desktop/api/minwinbase/ns-minwinbase-_win32_find_dataa) documents that symlinks use a reparse point tag of `IO_REPARSE_TAG_SYMLINK (0xA000000C)` that has the `N` bit set. To satisfy my curiosity, I will check what reparse point tag (with the `N` bit **not** set) is used by OneDrive (and request that it be added to the documentation).",
      "created_at": "2019-05-03T22:40:26Z",
      "updated_at": "2019-05-03T22:40:26Z"
    },
    {
      "author": "sba923",
      "author_association": "CONTRIBUTOR",
      "body": "I've collected my findings about the reparse tags used by OneDrive in [this spreadsheet](https://1drv.ms/x/s!AjBPRo9wXw9s4t0Rqnbtg-9QHSNSwQ).\r\n\r\n[https://docs.microsoft.com/en-us/windows/desktop/w8cookbook/placeholder-files](https://docs.microsoft.com/en-us/windows/desktop/w8cookbook/placeholder-files) is definitely outdated, as Windows 10 OneDrive doesn't use `IO_REPARSE_TAG_FILE_PLACEHOLDER` anymore. Instead, it uses a number of tags from `IO_REPARSE_TAG_CLOUD_1` to `IO_REPARSE_TAG_CLOUD_F` (on my system I found only 3 values being used), with a `IO_REPARSE_TAG_CLOUD_MASK` that apparently can be used to compute `(tag & IO_REPARSE_TAG_CLOUD_MASK) >> 12` and get some value between 1 and 15 that the OneDrive sync client probably uses as information about the item...\r\n\r\nI'm not sure where to post the request to document all this. @SteveL-MSFT: can you help?",
      "created_at": "2019-05-12T07:54:04Z",
      "updated_at": "2019-05-12T07:54:04Z"
    },
    {
      "author": "sba923",
      "author_association": "CONTRIBUTOR",
      "body": "For now I've opened https://github.com/MicrosoftDocs/feedback/issues/1484 and https://github.com/MicrosoftDocs/feedback/issues/1483",
      "created_at": "2019-05-12T08:16:18Z",
      "updated_at": "2019-05-12T08:16:18Z"
    }
  ],
  "created_at": "2019-05-01T18:33:21Z",
  "number": 9509,
  "state": "closed",
  "title": "Enable recursion into OneDrive",
  "updated_at": "2019-08-21T19:43:31Z"
}