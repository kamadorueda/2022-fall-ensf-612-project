{
  "_url": "https://github.com/PowerShell/PowerShell/issues/6665",
  "author": "HouzuoGuo",
  "body": "Steps to reproduce\r\n------------------\r\n\r\nUse PowerShell v6.0.2 on MacOS 10.13.4, repeatedly run `new-pssession` and fail the authentication process.\r\n\r\nEventually, `pwsh` crashes with the following message:\r\n\r\n    pwsh(18552,0x700002b6d000) malloc: *** error for object 0x7fbf94f66220: pointer being freed was not allocated\r\n\r\nThe pwsh software was installed via the recommended method using `brew`. The crash occurs 100% of the time under the scenario.\r\n\r\nEnvironment data\r\n----------------\r\n\r\n```\r\nName                           Value                                                                                                                    \r\n----                           -----                                                                                                                    \r\nPSVersion                      6.0.2                                                                                                                    \r\nPSEdition                      Core                                                                                                                     \r\nGitCommitId                    v6.0.2                                                                                                                   \r\nOS                             Darwin 17.5.0 Darwin Kernel Version 17.5.0: Mon Mar  5 22:24:32 PST 2018; root:xnu-4570.51.1~1/RELEASE_X86_64            \r\nPlatform                       Unix                                                                                                                     \r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}                                                                                                  \r\nPSRemotingProtocolVersion      2.3                                                                                                                      \r\nSerializationVersion           1.1.0.1                                                                                                                  \r\nWSManStackVersion              3.0\r\n```\r\n\r\nThe following complete interaction was captured from a crash:\r\n\r\n```\r\nhoward@mac-hz-dot-gl ~> pwsh\r\nPowerShell v6.0.2\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/howard> new-pssession -computername 192.168.143.130 -authentication basic -credential Administrator                                            \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nPassword for user Administrator: ********\r\n\r\nnew-pssession : [192.168.143.130] Connecting to remote server 192.168.143.130 failed with the following error message : MI_RESULT_ACCESS_DENIED For more information, see the about_Remote_Troubleshooting Help topic.\r\nAt line:1 char:1\r\n+ new-pssession -computername 192.168.143.130 -authentication basic -cr ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : OpenError: (System.Manageme....RemoteRunspace:RemoteRunspace) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : 2,PSSessionOpenFailed\r\nPS /Users/howard> new-pssession -computername 192.168.143.130 -authentication basic -credential Administrator                                            \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nPassword for user Administrator: \r\n\r\nnew-pssession : [192.168.143.130] Connecting to remote server 192.168.143.130 failed with the following error message : MI_RESULT_ACCESS_DENIED For more information, see the about_Remote_Troubleshooting Help topic.\r\nAt line:1 char:1\r\n+ new-pssession -computername 192.168.143.130 -authentication basic -cr ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : OpenError: (System.Manageme....RemoteRunspace:RemoteRunspace) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : 2,PSSessionOpenFailed\r\nPS /Users/howard> new-pssession -computername 192.168.143.130 -authentication basic -credential Administrator                                            \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nPassword for user Administrator: \r\n\r\nnew-pssession : [192.168.143.130] Connecting to remote server 192.168.143.130 failed with the following error message : MI_RESULT_ACCESS_DENIED For more information, see the about_Remote_Troubleshooting Help topic.\r\nAt line:1 char:1\r\n+ new-pssession -computername 192.168.143.130 -authentication basic -cr ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : OpenError: (System.Manageme....RemoteRunspace:RemoteRunspace) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : 2,PSSessionOpenFailed\r\nPS /Users/howard> new-pssession -computername 192.168.143.130 -authentication basic -credential Administrator                                            \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nPassword for user Administrator: \r\n\r\nnew-pssession : [192.168.143.130] Connecting to remote server 192.168.143.130 failed with the following error message : MI_RESULT_ACCESS_DENIED For more information, see the about_Remote_Troubleshooting Help topic.\r\nAt line:1 char:1\r\n+ new-pssession -computername 192.168.143.130 -authentication basic -cr ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : OpenError: (System.Manageme....RemoteRunspace:RemoteRunspace) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : 2,PSSessionOpenFailed\r\nPS /Users/howard> new-pssession -computername 192.168.143.130 -authentication basic -credential Administrator                                            \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nPassword for user Administrator: \r\n\r\nnew-pssession : [192.168.143.130] Connecting to remote server 192.168.143.130 failed with the following error message : MI_RESULT_ACCESS_DENIED For more information, see the about_Remote_Troubleshooting Help topic.\r\nAt line:1 char:1\r\n+ new-pssession -computername 192.168.143.130 -authentication basic -cr ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : OpenError: (System.Manageme....RemoteRunspace:RemoteRunspace) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : 2,PSSessionOpenFailed\r\nPS /Users/howard> \r\nPS /Users/howard> new-pssession -computername 192.168.143.130 -authentication basic -credential Administrator                                            \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nPassword for user Administrator: \r\n\r\npwsh(18552,0x700002b6d000) malloc: *** error for object 0x7fbf94f66220: pointer being freed was not allocated\r\n*** set a breakpoint in malloc_error_break to debug\r\nfish: 'pwsh' terminated by signal SIGABRT (Abort)\r\nhoward@mac-hz-dot-gl ~> pwsh\r\nPowerShell v6.0.2\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/howard> \u23ce                                                                                                                                      howard@mac-hz-dot-gl ~> \r\nhoward@mac-hz-dot-gl ~> \r\nhoward@mac-hz-dot-gl ~> pwsh\r\nPowerShell v6.0.2\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/howard> $PSVersionTable                                                                                                                        \r\n\r\nName                           Value                                                                                                                    \r\n----                           -----                                                                                                                    \r\nPSVersion                      6.0.2                                                                                                                    \r\nPSEdition                      Core                                                                                                                     \r\nGitCommitId                    v6.0.2                                                                                                                   \r\nOS                             Darwin 17.5.0 Darwin Kernel Version 17.5.0: Mon Mar  5 22:24:32 PST 2018; root:xnu-4570.51.1~1/RELEASE_X86_64            \r\nPlatform                       Unix                                                                                                                     \r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}                                                                                                  \r\nPSRemotingProtocolVersion      2.3                                                                                                                      \r\nSerializationVersion           1.1.0.1                                                                                                                  \r\nWSManStackVersion              3.0                                                                                                                      \r\n\r\n\r\nPS /Users/howard> \r\n```",
  "closed_at": "2019-05-31T22:00:51Z",
  "comments": [
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "This is likely https://github.com/Microsoft/omi/issues/502.  If you pass bad credentials or the connection fails for some other reason, there's a stale memory reference in libmi.  The issue has been fixed and I'll be publishing an updated psrpclient for linux and mac once I finish my verification.",
      "created_at": "2018-04-16T21:15:09Z",
      "updated_at": "2018-04-16T21:15:09Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This issue has been marked as external and has not had any activity for **1 day**. It has been be closed for housekeeping purposes.",
      "created_at": "2019-05-31T22:00:33Z",
      "updated_at": "2019-05-31T22:00:33Z"
    }
  ],
  "created_at": "2018-04-16T12:16:13Z",
  "number": 6665,
  "state": "closed",
  "title": "after consecutive failed new-pssession commands, powershell runs into trouble \"pointer being freed was not allocated\"",
  "updated_at": "2019-05-31T22:00:51Z"
}