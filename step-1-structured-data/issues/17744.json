{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17744",
  "author": "cmichaelingram",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nWe have a Windows Service that runs as LOCALSYSTEM that uses the PowerShell SDK to periodically run pwsh commands.  The calls to import modules with the UseWindowsPowershell parameter are failing. \r\n\r\nI was able to narrow the down the scope of the repro steps to what I have below.  I used the ActiveDirectory module as my example to import, but we are also seeing this behavior on other modules we import with the UseWindowsPowershell parameter.  \r\n\r\n1. Open pwsh as LOCAL SYSTEM Account.  (I used `psexec -s -i pwsh.exe` from a command prompt on a test machine).\r\n2. Run `Import-Module ActiveDirectory -UseWindowsPowerShell`.  If you don't have the ActiveDirectory module installed, see here: https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps.  I've also found running this command will produce the same results,` Import-Module Microsoft.Powershell.Management -UseWindowsPowerShell -NoClobber`\r\n3. Import-Module fails.\r\n![image](https://user-images.githubusercontent.com/31104435/180496333-af95b9f6-c5de-486e-bffb-97d162cc2b57.png)\r\n4. Message logged to the PowerShell Core Operational Event logs is misleading as it seems to indicate it failed to create module in c:\\windows\\temp folder.\r\n![image](https://user-images.githubusercontent.com/31104435/180497039-023f0912-3376-4512-b1fb-df17adfd9b9e.png)\r\n\r\n\r\nWORKAROUND:\r\n1. Close the pwsh window.  \r\n2. Create the directory: c:\\windows\\system32\\config\\systemprofile\\documents\\powershell\\modules.  C:\\windows\\system32\\config\\systemprofile is the $HOME folder for the LOCAL SYSTEM account.  \r\n3. Open pwsh as LOCAL SYSTEM Account (I used `psexec -s -i pwsh.exe `from a command prompt).\r\n4. Run `Import-Module ActiveDirectory -UseWindowsPowerShell `\r\n5. ActiveDirectory module successfully imports.\r\n![image](https://user-images.githubusercontent.com/31104435/180496613-288a8c0e-985f-4bed-8c67-007221d8ac22.png)\r\n\n\n### Expected behavior\n\n```console\nModule is successfully imported.\n```\n\n\n### Actual behavior\n\n```console\nModule is not imported and a failure message is returned.\n```\n\n\n### Error details\n\n```console\nImport-Module: Failed to generate proxies for remote module 'ActiveDirectory'. The -OutputModule parameter does not resolve to a path, and a user module path cannot be found for the provided name.\n```\n\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.5\r\nPSEdition                      Core\r\nGitCommitId                    7.2.5\r\nOS                             Microsoft Windows 10.0.17763\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": null,
  "comments": [],
  "created_at": "2022-07-22T18:03:52Z",
  "labels": [
    "WG-Engine",
    "Needs-Triage"
  ],
  "number": 17744,
  "state": "open",
  "title": "Import-Module with UseWindowsPowerShell parameter as LOCALSYSTEM account fails if $HOME\\Documents\\Powershell\\Modules directory does not exist.",
  "updated_at": "2022-07-24T14:16:33Z"
}