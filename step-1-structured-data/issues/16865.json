{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16865",
  "author": "DerekZiemba",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\n`Format-Volume -DriveLetter New-VirtualDisk`\r\n\r\nI made a typo for the drive letter argument and powershell instantly formatted without hesitation volumes: N,E,W,-,V,I,R,T,U,A,L,D,I,S,K\r\n\r\nIn this scenario, it should either prompt for confirmation to preventing catastrophe or error out on `-DriveLetter a_bunch_of_chars` while accepting -DriveLetter a,_,b,u,n,c... instead for char[].\r\n\r\n\r\nFull Details:\r\nhttps://www.reddit.com/r/DataHoarder/comments/snreoa/i_just_completely_wiped_all_my_most_important/\r\n\r\nThis guy summarized quite well what should actually happen and how to fix it:\r\nhttps://www.reddit.com/r/DataHoarder/comments/snreoa/i_just_completely_wiped_all_my_most_important/hw8i9wm/\r\n\r\n> > The description for the -DriveLetter parameter doesn't say anything about looping over char[], so it never should have been implemented that way.\r\n> \r\n> It's implicitly mentioned by the fact that it takes a char array as input, instead of just a single char. IMO the documentation is fine, the real problem here is that they didn't implement ShouldProcess properly.  \r\n> \"Dangerous\" commands in PowerShell are supposed to prompt for confirmation but clearly this command didn't. Looking at the module source under: \"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\Modules\\Storage\\Volume.cdxml\" they did correctly remember to add this for that command:\r\n> \r\n>     <Cmdlet>\r\n>         <CmdletMetadata Verb=\"Format\" ConfirmImpact=\"High\" Aliases=\"Initialize-Volume\" />\r\n>         <Method MethodName=\"Format\">\r\n>     ...\r\n> \r\n> They just forgot to add:\r\n> \r\n>     <CmdletAdapterPrivateData>\r\n> \t  <Data Name=\"ClientSideShouldProcess\" />\r\n>     </CmdletAdapterPrivateData>\r\n> \r\n> to the class definition so it doesn't prompt like it should. If you add that it prompts as you would expect:\r\n> \r\n>     PS C:\\Windows\\system32> Format-Volume -DriveLetter D,E\r\n> \r\n>     Confirm\r\n>     Are you sure you want to perform this action?\r\n>     Performing the operation \"Format\" on target \"MSFT_Volume (ObjectId = \"{1}\\\\mycomputername\\root/Microsoft/Windows/S...)\".\r\n>     [Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is \"Y\"):\r\n> \r\n>     Confirm\r\n>     Are you sure you want to perform this action?\r\n>     Performing the operation \"Format\" on target \"MSFT_Volume (ObjectId = \"{1}\\\\mycomputername\\root/Microsoft/Windows/S...)\".\r\n>     [Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is \"Y\"):\r\n> \r\n> It's a shame Microsoft don't make all of their modules open source so issues like this can be fixed. Sure we can report the problem to Microsoft and wait for them to fix it, but for small issues like this it's more efficient with PRs.\n\n### Expected behavior\n\n```console\nPS> Format-Volume -DriveLetter New-VirtualDisk\r\n\r\n\r\nConfirm\r\nAre you sure you want to perform this action?\r\nPerforming the operation \"Format\" on target \"MSFT_Volume (ObjectId = \"{1}\\\\mycomputername\\root/Microsoft/Windows/S...)\".\r\n[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is \"Y\"):\r\n\r\nConfirm\r\nAre you sure you want to perform this action?\r\nPerforming the operation \"Format\" on target \"MSFT_Volume (ObjectId = \"{1}\\\\mycomputername\\root/Microsoft/Windows/S...)\".\r\n[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is \"Y\"):\n```\n\n\n### Actual behavior\n\n```console\nPS C:\\WINDOWS\\system32> Format-Volume -DriveLetter New-VirtualDisk\r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'N'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (N:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'e'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (e:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'w'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (w:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to '-'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (-:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'V'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (V:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'i'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (i:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'r'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (r:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 't'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (t:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'u'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (u:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'a'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (a:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'l'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (l:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'D'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (D:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'i'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (i:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 's'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (s:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\r\n \r\nFormat-Volume : No MSFT_Volume objects found with property 'DriveLetter' equal to 'k'.  Verify the value of the property and retry.\r\nAt line:1 char:1\r\n+ Format-Volume -DriveLetter New-VirtualDisk\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (k:Char) [Format-Volume], CimJobException\r\n    + FullyQualifiedErrorId : CmdletizationQuery_NotFound_DriveLetter,Format-Volume\n```\n\n\n### Error details\n\n_No response_\n\n### Environment data\n\n```powershell\nPS C:\\WINDOWS\\system32> $PSVersionTable\r\n\r\nName                           Value                                                                                                                                                                    \r\n----                           -----                                                                                                                                                                    \r\nPSVersion                      5.1.19041.1320                                                                                                                                                           \r\nPSEdition                      Desktop                                                                                                                                                                  \r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}                                                                                                                                                  \r\nBuildVersion                   10.0.19041.1320                                                                                                                                                          \r\nCLRVersion                     4.0.30319.42000                                                                                                                                                          \r\nWSManStackVersion              3.0                                                                                                                                                                      \r\nPSRemotingProtocolVersion      2.3                                                                                                                                                                      \r\nSerializationVersion           1.1.0.1\n```\n\n\n### Visuals\n\n\r\n![image](https://user-images.githubusercontent.com/7283693/153331917-338b6fcf-b7e5-4e7f-a700-24e4613d8891.png)\r\n",
  "closed_at": "2022-02-11T19:00:42Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "The repository is for PowerShell 7 only, not Windows PowerShell. Also the cmdlet is not in the repository. Please report the issue to Windows team with Windows Feedback tool.",
      "created_at": "2022-02-10T03:57:01Z",
      "updated_at": "2022-02-10T03:57:01Z"
    },
    {
      "author": "jhoneill",
      "author_association": "NONE",
      "body": "Actually @iSazonov   there are a couple of things we might want to check. \r\nThis is a CIM cmdlet  defined in `%windir%\\System32\\WindowsPowerShell\\v1.0\\Modules\\Storage\\Volume.cdxml`\r\n\r\nHere's the definition of the drive letter parameter\r\n```\r\n            <!-- DriveLetter -->\r\n            <Property PropertyName=\"DriveLetter\">\r\n              <Type PSType=\"System.Char\" />\r\n              <RegularQuery>\r\n                <CmdletParameterMetadata IsMandatory=\"true\" ValueFromPipelineByPropertyName=\"true\" CmdletParameterSets=\"ByDriveLetter\" Position=\"0\" />\r\n              </RegularQuery>\r\n            </Property>\r\n```\r\nThat says it is of type `system.char`. \r\nHere's what I see if **7.2.1**  compiles that \r\n```\r\n    [Parameter(ParameterSetName='ByDriveLetter', Mandatory=$true, Position=0, ValueFromPipelineByPropertyName=$true)]\r\n    [ValidateNotNull()]\r\n    [char[]]\r\n    ${DriveLetter},\r\n```\r\nNow it has become `char[]`    so \"a string like \"Label\"  will be cast to  l, a, b, e, l ;    \r\nI get that we want people to be able to write X,Y but this side effect really needs a backstop of prompting, and this should prompt  and the XML suggests it should prompt\r\n```\r\n      <Cmdlet>\r\n        <CmdletMetadata Verb=\"Format\" ConfirmImpact=\"High\" Aliases=\"Initialize-Volume\" />\r\n```\r\n\r\nAnd the compiled result on 7.2.1 has all the right things to prompt. \r\n```\r\n[CmdletBinding(DefaultParameterSetName='ByDriveLetter', SupportsShouldProcess=$true, ConfirmImpact='High', PositionalBinding=$false)]\r\n```\r\n\r\nI don't have a spare drive to format, but the error when the letter doesn't exist suggest the call to do the format is being issued without prompting the user.   I may be reading it wrongly, but it does look a possible issue with all CIM cmdlets.  \r\n\r\n",
      "created_at": "2022-02-10T13:10:22Z",
      "updated_at": "2022-02-10T13:10:22Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "As the OP notes, the XML definition is missing this xml:\r\n```xml\r\n<CmdletAdapterPrivateData>\r\n<Data Name=\"ClientSideShouldProcess\" />\r\n</CmdletAdapterPrivateData>\r\n```\r\n\r\nWhich is what seems to actually trigger the command to prompt before doing something. The current definition just defines `[CmdletBinding(SupportsShouldProcess, ConfirmImpact = 'High')]` without actually ever calling `$PSCmdlet.ShouldProcess()`. The latter is what makes it actually prompt, the former just indicates it supports `-WhatIf` and `-Confirm` parameters without ever checking for them.",
      "created_at": "2022-02-10T14:02:32Z",
      "updated_at": "2022-02-10T14:03:39Z"
    },
    {
      "author": "jhoneill",
      "author_association": "NONE",
      "body": "> As the OP notes, the XML definition is missing this xml:\r\n> \r\n\r\nI should have read more carefully.  If it is that which is missing then the CIM cmdlet definition **is** being processed correctly. \r\n(A char becoming char[] is probably right so you can specify X , Y but when it explodes a string problems ensue). \r\n\r\n",
      "created_at": "2022-02-10T17:42:44Z",
      "updated_at": "2022-02-10T17:42:44Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This issue has been marked as external and has not had any activity for **1 day**. It has been be closed for housekeeping purposes.",
      "created_at": "2022-02-11T19:00:41Z",
      "updated_at": "2022-02-11T19:00:41Z"
    }
  ],
  "created_at": "2022-02-10T03:38:47Z",
  "number": 16865,
  "state": "closed",
  "title": "A Copy-Paste error for DriveLetter will instantly wipe all drives with a letter in the argument `Format-Volume -DriveLetter New-VirtualDisk`",
  "updated_at": "2022-02-11T19:00:42Z"
}