{
  "_url": "https://github.com/PowerShell/PowerShell/issues/7125",
  "author": "rjmholt",
  "body": "## PR Summary\r\n\r\n**TLDR**: Factors out module GUID/version checking logic to all use the same code path.\r\n\r\nThis PR routes all of the module GUID/version checking through `ModuleIntrinsics.IsModuleMatchingSpec()` (or a sub-method of it), so that all the version checking is consistent and DRY.\r\n\r\nPreviously the code had a number of 6-line if-conditions and cascading if-elses that all check module versioning in a slightly different way. I've tried to identify the common logic and unify it all.\r\n\r\n### Breaking Change Summary\r\n\r\nFix #7496 \r\nPrevious to this PR, having a module loaded with one version, meant that importing a different version of that module would give you the (wrong) loaded version. This change fixes the version check so that the loaded module is only used when it is the correct version. See https://github.com/PowerShell/PowerShell/issues/7496.\r\n\r\n### Tests\r\n\r\nTests for this PR were already added in https://github.com/PowerShell/PowerShell/pull/7499. This PR just removes the `-Pending` flags from the tests around the breaking change (on the basis that the previous behaviour was a bug).\r\n\r\nFixes https://github.com/PowerShell/PowerShell/issues/7496.\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` to the beginning of the title and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] User-facing [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed - Issue link:\r\n- **Testing - New and feature**\r\n    - [ ] Not Applicable or can only be tested interactively\r\n    - **OR**\r\n    - [x] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [x] [Add `[feature]` if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n\r\n<!-- Reviewable:start -->\r\n---\r\nThis change is\u2002[<img src=\"https://reviewable.io/review_button.svg\" height=\"34\" align=\"absmiddle\" alt=\"Reviewable\"/>](https://reviewable.io/reviews/powershell/powershell/7125)\r\n<!-- Reviewable:end -->\r\n",
  "closed_at": "2018-11-01T20:41:52Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": ">Also, if our testing coverage on this should be improved, I'm happy to add tests to this PR \r\n\r\nTo make a quality check of this change we are forced to do a lot of tests locally. So it makes sense to start by reviewing and extending the tests in the repo. I see that we don't actually have the tests for this code. I think we could add the new tests in new separate PR and then continue the PR. The `Import-Module.Tests.ps1` file is already large so we could create new `Import-Module-Versions.Tests.ps1`.",
      "created_at": "2018-06-21T06:36:26Z",
      "updated_at": "2018-06-21T06:36:26Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "Ah so there *is* an Import-Module.Tests.ps1? It\u2019s not under /test/powershell/engine/Module like I expected. Where is it?\r\n\r\nYes agreed we should bulk up the tests in another PR to merge before this one. I\u2019ve been thinking about doing that but now I know there\u2019s a test file I will see what we already have...",
      "created_at": "2018-06-21T13:41:32Z",
      "updated_at": "2018-06-21T13:41:32Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "See  `test\\powershell\\Modules\\Microsoft.PowerShell.Core\\` subdirectory.",
      "created_at": "2018-06-21T15:12:56Z",
      "updated_at": "2018-06-21T15:12:56Z"
    },
    {
      "author": "anmenaga",
      "author_association": "CONTRIBUTOR",
      "body": "@rjmholt It would be good to see a green `[Feature]` test pass result. Can you please run it again?",
      "created_at": "2018-07-30T20:37:10Z",
      "updated_at": "2018-07-30T20:37:10Z"
    },
    {
      "author": "anmenaga",
      "author_association": "CONTRIBUTOR",
      "body": "@daxian-dbw @BrucePay We need to get some traction on this; this PR is sitting without a review for more than a month now...",
      "created_at": "2018-07-30T20:39:14Z",
      "updated_at": "2018-07-30T20:39:14Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "I need to write tests for this I would say. Will mark as WIP.",
      "created_at": "2018-07-30T20:43:08Z",
      "updated_at": "2018-07-30T20:43:39Z"
    },
    {
      "author": "stale[bot]",
      "author_association": "NONE",
      "body": "This PR has been automatically marked as stale because it has not had activity in the last 30 days. It will be closed if no further activity occurs within 10 days.\nThank you for your contributions.\nCommunity members are welcome to grab these works.\n",
      "created_at": "2018-09-09T21:48:58Z",
      "updated_at": "2018-09-09T21:48:58Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@rjmholt Please resolve the merge conflict.",
      "created_at": "2018-09-10T03:48:57Z",
      "updated_at": "2018-09-10T03:48:57Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "I have now rebased this to include the 774 tests I wrote",
      "created_at": "2018-09-28T22:39:17Z",
      "updated_at": "2018-09-28T22:39:17Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "~~I've removed the breaking change tag since I think another PR has already made the relevant change. This PR changes no tests and passes all existing.~~\r\n\r\nThis is wrong. That test PR skips those tests. This PR should enable them.\r\n\r\n**EDIT**: Tests are now enabled, and pass.",
      "created_at": "2018-09-29T01:36:54Z",
      "updated_at": "2018-10-11T16:28:40Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "Windows test failure is:\r\n```\r\n++++++?++++++\r\n2018-10-10T23:48:47.4155281Z       [-] ResolveDestination for address \r\n2018-10-10T23:48:47.4163493Z         Expected strings to be the same, but they were different.\r\n2018-10-10T23:48:47.4170377Z         String lengths are both 15.\r\n2018-10-10T23:48:47.4182758Z         Strings differ at index 0.\r\n2018-10-10T23:48:47.4190319Z         Expected: {factoryvm-az387}\r\n2018-10-10T23:48:47.4198841Z         But was:  {aion.f2pool.com}\r\n2018-10-10T23:48:47.4206302Z         -----------^\r\n2018-10-10T23:48:47.4213664Z         171:             $result.Destination | Should -BeExactly $resolvedName\r\n2018-10-10T23:48:47.4220802Z         at Invoke-Assertion, D:\\a\\1\\s\\src\\powershell-win-core\\bin\\Release\\netcoreapp2.1\\win7-x64\\publish\\Modules\\Pester\\4.2.0\\Functions\\Assertions\\Should.ps1: line 206\r\n2018-10-10T23:48:47.4229034Z         at <ScriptBlock>, D:\\a\\1\\s\\test\\powershell\\Modules\\Microsoft.PowerShell.Management\\Test-Connection.Tests.ps1: line 171\r\n2018-10-10T23:48:52.2124211Z +++\r\n```\r\n\r\nGotten it twice now. Building again.",
      "created_at": "2018-10-11T16:27:50Z",
      "updated_at": "2018-10-11T16:27:50Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@rjmholt given that I am also seeing this issue in #7993, I think this is something that changed in the build outside your code.\r\n\r\nNot sure exactly when this happened, though it appears to be a recent issue.",
      "created_at": "2018-10-11T16:36:53Z",
      "updated_at": "2018-10-11T16:36:53Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "@vexx32 it looks like a CI infrastructure configuration problem -- some kind of IP/DNS state has changed and the test depends on it.",
      "created_at": "2018-10-11T16:42:18Z",
      "updated_at": "2018-10-11T16:42:52Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Fix for CI is in #7987",
      "created_at": "2018-10-11T17:50:47Z",
      "updated_at": "2018-10-11T17:50:47Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I'd expect that we add new tests because of \"breaking change\".",
      "created_at": "2018-10-12T04:39:14Z",
      "updated_at": "2018-10-12T04:39:14Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@rjmholt Can you please summarize what the breaking change is in the PR description?",
      "created_at": "2018-10-12T05:13:03Z",
      "updated_at": "2018-10-12T05:13:03Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "@iSazonov Tests were added in https://github.com/PowerShell/PowerShell/pull/7499. I added the tests for the new behaviour then and have removed the `-Pending` flag in this PR.",
      "created_at": "2018-10-12T16:42:20Z",
      "updated_at": "2018-10-12T16:42:20Z"
    },
    {
      "author": "anmenaga",
      "author_association": "CONTRIBUTOR",
      "body": "@rjmholt Please address remaining couple of minor issues that Ilya pointed out and this will be ready.",
      "created_at": "2018-10-23T19:00:08Z",
      "updated_at": "2018-10-23T19:00:08Z"
    },
    {
      "author": "anmenaga",
      "author_association": "CONTRIBUTOR",
      "body": "@adityapatwardhan this looks ready.",
      "created_at": "2018-10-29T21:11:35Z",
      "updated_at": "2018-10-29T21:11:35Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@rjmholt Please address two comments.",
      "created_at": "2018-10-30T04:07:09Z",
      "updated_at": "2018-10-30T04:07:09Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@rjmholt Please address comments from @iSazonov. After that, is seems ready to merge.",
      "created_at": "2018-10-30T17:02:20Z",
      "updated_at": "2018-10-30T17:02:20Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "@adityapatwardhan, @iSazonov Feedback addressed -- let me know if any further changes are required.",
      "created_at": "2018-10-30T23:14:07Z",
      "updated_at": "2018-10-30T23:14:07Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@rjmholt please have a look at failing CI.",
      "created_at": "2018-10-30T23:27:55Z",
      "updated_at": "2018-10-30T23:28:12Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@SteveL-MSFT  The newly added test is failing. It is marked as Feature and Feature tests were not run when the PR got merged.",
      "created_at": "2018-10-30T23:30:50Z",
      "updated_at": "2018-10-30T23:30:50Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Looking",
      "created_at": "2018-10-31T01:06:31Z",
      "updated_at": "2018-10-31T01:06:31Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Test fix https://github.com/PowerShell/PowerShell/pull/8152",
      "created_at": "2018-10-31T01:24:23Z",
      "updated_at": "2018-10-31T01:24:35Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@rjmholt Please look CodeFactor issues and fix if they in your code.",
      "created_at": "2018-10-31T05:01:09Z",
      "updated_at": "2018-10-31T05:01:09Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@adityapatwardhan @TravisEz13 Could you please reword the merged commit? [Breaking change] was skipped in description.",
      "created_at": "2018-11-02T03:24:15Z",
      "updated_at": "2018-11-02T03:24:15Z"
    }
  ],
  "created_at": "2018-06-21T01:16:49Z",
  "number": 7125,
  "state": "closed",
  "title": "Refactor module version/GUID comparison logic",
  "updated_at": "2018-11-02T03:24:16Z"
}