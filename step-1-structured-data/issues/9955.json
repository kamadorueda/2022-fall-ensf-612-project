{
  "_url": "https://github.com/PowerShell/PowerShell/issues/9955",
  "author": "AikenBM",
  "body": "If the first column header in a csv file or from csv data begins with a `#` or with `\"#`, then both  `ConvertFrom-Csv` and `Import-Csv` do not parse the file or data correctly. If the second row of the input (i.e., the first row of data) is blank, then the commands fail to parse the data correctly.\r\n\r\nWhile the problem is particularly highlighted by the row of empty data, I believe the actual problem is just that these commands assume that if the first line of input begins with `#` or `\"#` that it _must_ be a type information line. \r\n\r\nBy type information line, I'm referring to the first line of output of these commands:\r\n\r\n```\r\nPS C:\\> Get-ChildItem C:\\Windows\\ | Select-Object Name, LastWriteTime -First 1 | ConvertTo-Csv -IncludeTypeInformation\r\n#TYPE Selected.System.IO.DirectoryInfo\r\n\"Name\",\"LastWriteTime\"\r\n\"addins\",\"9/15/2018 3:33:54 AM\"\r\n```\r\n\r\nThis issue was first identified in [this StackOverflow question](https://stackoverflow.com/q/56673905/696808).\r\n\r\n# Steps to reproduce\r\n\r\nExample 1:\r\n\r\n```powershell\r\n$data = @'\r\n#,Labels,Machine Name,System Description,IP,User Logged,Disk Free C\r\n,,,,,,\r\n6,\"computers-PRO,Desktop,Office 2010,OS Windows 7,Update Adobe Reader\",PRO-MEDASST,91-0-928,172.10.201.111,CHR\\\\jeniferc,6.3\r\n7,Update Adobe Reader,RED,empty,172.10.201.5,,9.5\r\n8,Update Adobe Reader,SIER,empty,172.10.201.5,,6.8\r\n'@\r\n$data | ConvertFrom-Csv\r\n```\r\n\r\nExample 2:\r\n\r\n```powershell\r\n$data = @'\r\n\"#\",Labels,Machine Name,System Description,IP,User Logged,Disk Free C\r\n,,,,,,\r\n6,\"computers-PRO,Desktop,Office 2010,OS Windows 7,Update Adobe Reader\",PRO-MEDASST,91-0-928,172.10.201.111,CHR\\\\jeniferc,6.3\r\n7,Update Adobe Reader,RED,empty,172.10.201.5,,9.5\r\n8,Update Adobe Reader,SIER,empty,172.10.201.5,,6.8\r\n'@\r\n$data | ConvertFrom-Csv\r\n```\r\n\r\nThis next example which doesn't have a row of empty data fields in the CSV also does not parse correctly, though it behaves differently. It uses the first row of data as the headers.\r\n\r\nExample 3:\r\n\r\n```powershell\r\n$data = @'\r\n#,Labels,Machine Name,System Description,IP,User Logged,Disk Free C\r\n6,\"computers-PRO,Desktop,Office 2010,OS Windows 7,Update Adobe Reader\",PRO-MEDASST,91-0-928,172.10.201.111,CHR\\\\jeniferc,6.3\r\n7,Update Adobe Reader,RED,empty,172.10.201.5,,9.5\r\n8,Update Adobe Reader,SIER,empty,172.10.201.5,,6.8\r\n'@\r\n$data | ConvertFrom-Csv\r\n```\r\nIf the contents of `data.csv` are the same as the value of the `$data` above, then this also reproduces the error:\r\n\r\n```powershell\r\nImport-Csv data.csv\r\n```\r\n\r\nNote that removing the line of blank values does not change the behavior.\r\n\r\n# Expected behavior\r\n\r\nThe commands should know that the first line is not a type information line, and should try to parse it as the header row for the CSV data.\r\n\r\n```none\r\n#                  :\r\nLabels             :\r\nMachine Name       :\r\nSystem Description :\r\nIP                 :\r\nUser Logged        :\r\nDisk Free C        :\r\n\r\n#                  : 6\r\nLabels             : computers-PRO,Desktop,Office 2010,OS Windows 7,Update Adobe Reader\r\nMachine Name       : PRO-MEDASST\r\nSystem Description : 91-0-928\r\nIP                 : 172.10.201.111\r\nUser Logged        : CHR\\\\jeniferc\r\nDisk Free C        : 6.3\r\n\r\n#                  : 7\r\nLabels             : Update Adobe Reader\r\nMachine Name       : RED\r\nSystem Description : empty\r\nIP                 : 172.10.201.5\r\nUser Logged        :\r\nDisk Free C        : 9.5\r\n\r\n#                  : 8\r\nLabels             : Update Adobe Reader\r\nMachine Name       : SIER\r\nSystem Description : empty\r\nIP                 : 172.10.201.5\r\nUser Logged        :\r\nDisk Free C        : 6.8\r\n```\r\n\r\n# Actual behavior\r\n\r\nExamples 1 & 2 do this:\r\n\r\n```none\r\nWARNING: One or more headers were not specified. Default names starting with \"H\" have been used in place of any missing headers.\r\n\r\nH1\r\n--\r\n6\r\n7\r\n8\r\n\r\n```\r\n\r\nExample 3 does this:\r\n\r\n```none\r\n6                                                                  : 7\r\ncomputers-PRO,Desktop,Office 2010,OS Windows 7,Update Adobe Reader : Update Adobe Reader\r\nPRO-MEDASST                                                        : RED\r\n91-0-928                                                           : empty\r\n172.10.201.111                                                     : 172.10.201.5\r\nCHR\\\\jeniferc                                                      :\r\n6.3                                                                : 9.5\r\n\r\n6                                                                  : 8\r\ncomputers-PRO,Desktop,Office 2010,OS Windows 7,Update Adobe Reader : Update Adobe Reader\r\nPRO-MEDASST                                                        : SIER\r\n91-0-928                                                           : empty\r\n172.10.201.111                                                     : 172.10.201.5\r\nCHR\\\\jeniferc                                                      :\r\n6.3                                                                : 6.8\r\n```\r\n\r\n# Environment data\r\n\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.2.1\r\nPSEdition                      Core\r\nGitCommitId                    6.2.1\r\nOS                             Microsoft Windows 10.0.17763\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\nUnfortunately, I do not currently have access to a system where I can install PowerShell 7.0 previews to test on.\r\n",
  "closed_at": "2020-05-07T15:41:01Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@AikenBM It was a compromise read either raw or smart with W3C standard support. The standard uses '#' as special char at first position in header. Our conclusion was that following to the standard is better, users would need workarounds only for edge cases like you share.\r\nYou can see the code here:\r\nhttps://github.com/PowerShell/PowerShell/blob/master/src/Microsoft.PowerShell.Commands.Utility/commands/utility/CsvCommands.cs#L1285-L1314\r\n\r\n> Unfortunately, I do not currently have access to a system where I can install PowerShell 7.0 previews to test on.\r\n\r\nYou can download zip file from the site and install 7.0 Preview side-by-side.",
      "created_at": "2019-06-21T10:47:41Z",
      "updated_at": "2019-06-21T10:47:41Z"
    },
    {
      "author": "AikenBM",
      "author_association": "NONE",
      "body": "> @AikenBM It was a compromise read either raw or smart with W3C standard support. The standard uses '#' as special char at first position in header. Our conclusion was that following to the standard is better, users would need workarounds only for edge cases like you share.\r\n\r\nBy that I presume you mean the [Model for Tabular Data and Metadata](https://www.w3.org/TR/tabular-data-model/) on the [Web and the Metadata Vocabulary for Tabular Data](https://www.w3.org/TR/tabular-metadata/). The second is necessary, because that's the only document I can find that refers to `#` being the default character. The first one for general tabular data and to which the metadata recommendation refers to, says [the default comment character is null](https://www.w3.org/TR/2015/REC-tabular-data-model-20151217/#parsing), while [the metadata recommendation seems to say that the value should be user-configurable](https://www.w3.org/TR/tabular-metadata/#dialect-descriptions) with a default value of `#`. I'm just skimming, though, so I may be misreading things. I'd also point out that both documents repeatedly state that they *are not* attempting define any CSV standard (RFC4180 does that), but instead trying to describe how CSV data are actually used.\r\n\r\nHowever, let's set aside entirely any argument over the W3C standard and [RFC4180](https://tools.ietf.org/html/rfc4180). The problem is that even if I accept that the `#` is in widespread use as a comment character, **the commands are _still_ not consistent with that rule**. \r\n\r\nFirst I state my understanding of the rule: In a CSV format file, the leading character of `#` indicates a comment row which must be ignored by the parser.\r\n\r\nLet's take these two CSV sets of data:\r\n\r\n```powershell\r\n$CommentLine1 = @'\r\n#,2,3\r\nA,B,C\r\n4,5,6\r\n'@\r\n\r\n$CommentLine2 = @'\r\nA,B,C\r\n#,2,3\r\n4,5,6\r\n'@\r\n```\r\n\r\nThe above two variables with CSV data should be parsed identically in any circumstance. The `#` indicates a header, so the parser should always ignore those lines. That's not the case. \r\n\r\n```powershell\r\nPS C:\\> # Comment Line 1\r\nPS C:\\> $CommentLine1 | ConvertFrom-Csv\r\n\r\nA B C\r\n- - -\r\n4 5 6\r\n\r\n\r\nPS C:\\> # Comment Line 1 - Split\r\nPS C:\\> -split $CommentLine1 | ConvertFrom-Csv\r\n\r\nA B C\r\n- - -\r\n4 5 6\r\n\r\n\r\nPS C:\\> # Comment Line 2\r\nPS C:\\> $CommentLine2 | ConvertFrom-Csv\r\n\r\nA B C\r\n- - -\r\n# 2 3\r\n4 5 6\r\n\r\n\r\nPS C:\\> # No Quotes Comment Line 2 - Split\r\nPS C:\\> -split $CommentLine2 | ConvertFrom-Csv\r\n\r\nA B C\r\n- - -\r\n4 5 6\r\n```\r\n\r\nSee how the third example with a comment on line 2 and no `-split` isn't consistent with the others?\r\n\r\nAlso note that it's this third example that indicates how Import-Csv will handle the data:\r\n\r\n```powershell\r\nPS C:\\> $CommentLine2 | Set-Content ~\\test.csv\r\nPS C:\\> Import-Csv ~\\test.csv\r\n\r\nA B C\r\n- - -\r\n# 2 3\r\n4 5 6\r\n```\r\n\r\nIt's different again if you try it with quoted CSV data:\r\n\r\n```powershell\r\n$QuotedCommentLine1 = @'\r\n\"#\",\"2\",\"3\"\r\n\"A\",\"B\",\"C\"\r\n\"4\",\"5\",\"6\"\r\n'@\r\n\r\n$QuotedCommentLine2 = @'\r\n\"A\",\"B\",\"C\"\r\n\"#\",\"2\",\"3\"\r\n\"4\",\"5\",\"6\"\r\n'@\r\n```\r\n\r\nFirst, I think it's important to note that, by my understanding of the rule, _neither_ of the above sets of CSV data have any comments. The first character of the line is _not_ `#`. It's `\"`. I am going to take some convincing to think that it's appropriate to treat a quoted escape character as the escape character. You'll note that when `ConvertTo-Csv -IncludeTypeInformation` is specified or `Export-Csv -IncludeTypeInformation` is specified, the type information line is _not_ quoted.\r\n\r\nHere's the output:\r\n\r\n```powershell\r\nPS C:\\> # Quoted Comment Line 1\r\nPS C:\\> $QuotedCommentLine1 | ConvertFrom-Csv\r\n\r\nA B C\r\n- - -\r\n4 5 6\r\n\r\n\r\nPS C:\\> # Quoted Comment Line 1 - Split\r\nPS C:\\> -split $QuotedCommentLine1 | ConvertFrom-Csv\r\n\r\nA B C\r\n- - -\r\n4 5 6\r\n\r\n\r\nPS C:\\> # Quoted Comment Line 2\r\nPS C:\\> $QuotedCommentLine2 | ConvertFrom-Csv\r\n\r\nA B C\r\n- - -\r\n# 2 3\r\n4 5 6\r\n\r\n\r\nPS C:\\> # Quoted Comment Line 2 - Split\r\nPS C:\\> -split $QuotedCommentLine2 | ConvertFrom-Csv\r\n\r\nA B C\r\n- - -\r\n# 2 3\r\n4 5 6\r\n```\r\n\r\nHere, the system behaves completely differently if the comment is on the first line instead of on the second line. This makes no sense at all. First of all, there are no comments in this CSV data. Second of all, even if they _were_ comments, why is a comment on line 1 treated differently than a comment on line 2? Further, this behavior is totally inconsistent with the behavior of the non-quoted data! For reference, `Import-Csv` behaves identically here.\r\n\r\nWhat I believe needs to happen is:\r\n\r\n1. There needs to be consistency of operation in how these commands parse the data.\r\n2. There should be a way to set or ignore the comment character, per the W3C recommendations.\r\n\r\n> > Unfortunately, I do not currently have access to a system where I can install PowerShell 7.0 previews to test on.\r\n> \r\n> You can download zip file from the site and install 7.0 Preview side-by-side.\r\n\r\nYou don't understand. I currently have access to two different systems: A Windows 10 Enterprise workstation and a Windows 10 Enterprise laptop both owned by my organization. I am allowed to install software on these systems, but I am prohibited from installing preview or beta software of any kind without approval. I would have to check, but I'm fairly certain I'm not allowed to install Hyper-V or other virtualization software to circumvent these policies. My personally owned workstations are currently 1,200 miles away and powered off, and they will be until the end of August.\r\n\r\nWhen I say I have no access to  a system I can test on, I mean I have no access to a system I can test on!\r\n",
      "created_at": "2019-06-24T22:30:30Z",
      "updated_at": "2019-06-24T22:30:30Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@AikenBM Thanks for your investigations! As I commented above it is an expected behavior for the edge case. No need complicate the parser (we want to keep it fastest) until we get an important business case (like Aparche, ISS, or nginx will start writing logs of this format).",
      "created_at": "2019-06-25T07:42:11Z",
      "updated_at": "2019-06-25T07:42:11Z"
    },
    {
      "author": "jangliss",
      "author_association": "NONE",
      "body": "I'm surprised this was rejected as \"By Design\".  The behavior has changed from previous versions (such as 5.1.18362.145), not documented anywhere that I've found, other than this bug report and Stack Overflow post, and a potential breaking change for many. \r\n\r\nAs @AikenBM suggested, a quoted \"#\" is not a line starting with #, so shouldn't be treated as a comment, and yet is being done so. I've got plenty of CSV files that use a \"#\" to represent a record number.  This will mean changes required to read the file, either by loading the whole file and replacing the # with something else, or changing the export.\r\n\r\nAs a side note, the code appears to have explicit definition to handle the W3C Common log format, but only the \"#Fields:\" directive, when the guidance suggests there is also Version, Software, Start-Date, End-Date, Date, and Remark.",
      "created_at": "2019-10-18T21:47:21Z",
      "updated_at": "2019-10-18T21:47:21Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": ">  I've got plenty of CSV files that use a \"#\" to represent a record number.\r\n\r\nWhat is source of the files?",
      "created_at": "2019-10-19T08:04:43Z",
      "updated_at": "2019-10-19T08:04:43Z"
    }
  ],
  "created_at": "2019-06-19T21:15:26Z",
  "labels": [
    "Issue-Question",
    "Resolution-By Design",
    "WG-Cmdlets-Utility"
  ],
  "number": 9955,
  "state": "closed",
  "title": "Import-Csv and ConvertFrom-Csv fail to parse if the first header begins with a \"#\"",
  "updated_at": "2020-05-07T15:41:01Z"
}