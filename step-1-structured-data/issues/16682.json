{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16682",
  "author": "asaf-frieder",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\n$Script:InvariantCulture = [System.Globalization.CultureInfo]::InvariantCulture\r\n$Script:InvariantCultureSessionOption = New-CimSessionOption -Culture $Script:InvariantCulture -UICulture $Script:InvariantCulture -Protocol DCOM\r\n$securePassword = ConvertTo-SecureString \"password\" -AsPlainText -Force\r\n$credentials = New-Object System.Management.Automation.PSCredential (\"Domain\\User\", $securePassword)\r\n$sessionParameters = @{\r\nComputerName = \"target_name\"\r\nSessionOption = $Script:InvariantCultureSessionOption\r\nCredential = $credentials\r\n}\r\n$sessionParameters.Authentication = [Microsoft.Management.Infrastructure.Options.PasswordAuthenticationMechanism]::Kerberos\r\n$session = New-CimSession @sessionParameters\r\n\r\n\r\n(Domain, User, password and target_name replace the original internal information)\n\n### Expected behavior\n\n```console\nPS > $session = New-CimSession @sessionParameters\r\nPS > $session\r\n\r\n\r\nId           : 4\r\nName         : CimSession4\r\nInstanceId   : e9c595d5-200d-4d9d-adb7-e1e14c72d20a\r\nComputerName : target_name\r\nProtocol     : DCOM\n```\n\n\n### Actual behavior\n\n```console\n$session = New-CimSession @sessionParameters\r\nThe RPC server is unavailable\r\nWhen looking in wireshark it appears we receive \"eRR-S-PRINCIPAL-UNKNOWN (7)\" It seems that when the Cim connection is attempting to authenticate the Kerberos it attempts to ask for a ticket to the domain instead of the expected SPN.\r\n\r\nWe have successfully connected:\r\n1) When not using Kerberos enforcement (the above code without setting the Authentication)\r\n2) Using Kerberos with WinRM (New-PSSession)\r\n3) With legacy WMI methods (that use DCOM)\r\nGet-WmiObject -ComputerName \"target_name\" -Impersonation Impersonate -Credential $credentials -Class win32_OperatingSystem -Authority \"Kerberos:domain\\target_name\"\r\n\r\nWith the last example it seems that the SPN it tried to authenticate was the target_name not the domain (as it did in the failed cim connection)\n```\n\n\n### Error details\n\n```console\nNew-CimSession : The RPC server is unavailable.\r\nAt line:1 char:12\r\n+ $session = New-CimSession @sessionParameters\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : NotSpecified: (:) [New-CimSession], CimException\r\n    + FullyQualifiedErrorId : HRESULT 0x800706ba,Microsoft.Management.Infrastructure.CimCmdlets.NewCimSessionCommand\r\n    + PSComputerName        : target_name\n```\n\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.19041.1023\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.19041.1023\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": null,
  "comments": [],
  "created_at": "2021-12-30T19:16:36Z",
  "number": 16682,
  "state": "open",
  "title": "New-CimSession fails when combining DCOM with Kerberos ",
  "updated_at": "2021-12-31T10:03:52Z"
}