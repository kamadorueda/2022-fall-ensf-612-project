{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17187",
  "author": "AnderT",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nI am remotely controlling a Hyper-V cluster, I need to import the correct Hyper-V module.\r\nThat works and I can call Get-VM fine.\r\nI then call Get-VM from inside a  'Foreach-object -Parallel' loop and am told I am using the incorrect module.\r\n\r\n# Import correct Hyper-V version\r\nRemove-Module Hyper-V\r\nImport-Module Hyper-V -RequiredVersion 1.1\r\nGet-Module Hyper-V\r\n\r\nClear-Host\r\n\r\n$postClusterPatchVMStates = @{}\r\n\r\n$Object = New-Object PSObject -Property @{\r\n    VMName       = 'AUECKA01'\r\n    Hostname     = 'AUECKHV01'}\r\n\r\n$postClusterPatchVMStates.Add('AUECKA01', $Object)\r\n\r\n$Object = New-Object PSObject -Property @{\r\n    VMName       = 'AUECKAP01'\r\n    Hostname     = 'AUECKHV01'}\r\n\r\n$postClusterPatchVMStates.Add('AUECKAP01', $Object)\r\n\r\n# Outside of 'Foreach-object -Parallel' all works fine\r\nGet-VM -Name $postClusterPatchVMStates['AUECKA01'].VMName -ComputerName $postClusterPatchVMStates['AUECKA01'].Hostname\r\nGet-VM -Name $postClusterPatchVMStates['AUECKAP01'].VMName -ComputerName $postClusterPatchVMStates['AUECKAP01'].Hostname\r\n\r\n$postClusterPatchVMStates.Values | Foreach-object -Parallel {  \r\n\r\n    $node = $_.Hostname\r\n    $vMName = $_.VMName\r\n\r\n    # Outside of 'Foreach-object -Parallel', not so much, says that I am using the wrong module.\r\n    (Get-VM -Name $vMName -ComputerName $node)\r\n} \n\n### Expected behavior\n\n```console\nName             : AUECKA01\r\nState            : Running\r\nCpuUsage         : 0\r\nMemoryAssigned   : 17179869184\r\nMemoryDemand     : 0\r\nMemoryStatus     : \r\nUptime           : 04:24:27\r\nStatus           : Operating normally\r\nReplicationState : Disabled\r\nGeneration       : 1\r\n\r\n\r\nName             : AUECKAP01\r\nState            : Running\r\nCpuUsage         : 0\r\nMemoryAssigned   : 4294967296\r\nMemoryDemand     : 0\r\nMemoryStatus     : \r\nUptime           : 04:24:44\r\nStatus           : Operating normally\r\nReplicationState : Disabled\r\nGeneration       : 1\r\n\r\n\r\nName             : AUECKA01\r\nState            : Running\r\nCpuUsage         : 0\r\nMemoryAssigned   : 17179869184\r\nMemoryDemand     : 0\r\nMemoryStatus     : \r\nUptime           : 04:24:27\r\nStatus           : Operating normally\r\nReplicationState : Disabled\r\nGeneration       : 1\r\n\r\n\r\nName             : AUECKAP01\r\nState            : Running\r\nCpuUsage         : 0\r\nMemoryAssigned   : 4294967296\r\nMemoryDemand     : 0\r\nMemoryStatus     : \r\nUptime           : 04:24:44\r\nStatus           : Operating normally\r\nReplicationState : Disabled\r\nGeneration       : 1\n```\n\n\n### Actual behavior\n\n```console\nName             : AUECKA01\r\nState            : Running\r\nCpuUsage         : 0\r\nMemoryAssigned   : 17179869184\r\nMemoryDemand     : 0\r\nMemoryStatus     : \r\nUptime           : 04:24:27\r\nStatus           : Operating normally\r\nReplicationState : Disabled\r\nGeneration       : 1\r\n\r\n\r\nName             : AUECKAP01\r\nState            : Running\r\nCpuUsage         : 0\r\nMemoryAssigned   : 4294967296\r\nMemoryDemand     : 0\r\nMemoryStatus     : \r\nUptime           : 04:24:44\r\nStatus           : Operating normally\r\nReplicationState : Disabled\r\nGeneration       : 1\r\n\r\nGet-VM: \r\nLine |\r\n   7 |      (Get-VM -Name $vMName -ComputerName $node)\r\n     |       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | The Hyper-V module used in this Windows PowerShell session cannot be used for remote management of the server 'AUECKHV01'. Load a compatible version of the Hyper-V module, or use Powershell remoting to connect directly to the remote server. For more information, see http://go.microsoft.com/fwlink/p/?LinkID=532650.\r\nGet-VM: \r\nLine |\r\n   7 |      (Get-VM -Name $vMName -ComputerName $node)\r\n     |       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Hyper-V was unable to find a virtual machine with name \"AUECKA01\".\r\n\r\nException             : Microsoft.HyperV.PowerShell.VirtualizationException: Hyper-V was unable to find a virtual machine with name \"AUECKA01\".\r\nTargetObject          : AUECKA01\r\nCategoryInfo          : InvalidArgument: (AUECKA01:String) [Get-VM], VirtualizationException\r\nFullyQualifiedErrorId : InvalidParameter,Microsoft.HyperV.PowerShell.Commands.GetVM\r\nErrorDetails          : \r\nInvocationInfo        : System.Management.Automation.InvocationInfo\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 7\r\nPipelineIterationInfo : {0, 1}\r\n\r\nGet-VM: \r\nLine |\r\n   7 |      (Get-VM -Name $vMName -ComputerName $node)\r\n     |       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | The Hyper-V module used in this Windows PowerShell session cannot be used for remote management of the server 'AUECKHV01'. Load a compatible version of the Hyper-V module, or use Powershell remoting to connect directly to the remote server. For more information, see http://go.microsoft.com/fwlink/p/?LinkID=532650.\r\nGet-VM: \r\nLine |\r\n   7 |      (Get-VM -Name $vMName -ComputerName $node)\r\n     |       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Hyper-V was unable to find a virtual machine with name \"AUECKAP01\".\r\n\r\nException             : Microsoft.HyperV.PowerShell.VirtualizationException: Hyper-V was unable to find a virtual machine with name \"AUECKAP01\".\r\nTargetObject          : AUECKAP01\r\nCategoryInfo          : InvalidArgument: (AUECKAP01:String) [Get-VM], VirtualizationException\r\nFullyQualifiedErrorId : InvalidParameter,Microsoft.HyperV.PowerShell.Commands.GetVM\r\nErrorDetails          : \r\nInvocationInfo        : System.Management.Automation.InvocationInfo\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 7\r\nPipelineIterationInfo : {0, 1}\n```\n\n\n### Error details\n\n_No response_\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.2\r\nPSEdition                      Core\r\nGitCommitId                    7.2.2\r\nOS                             Microsoft Windows 10.0.14393\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": "2022-04-27T00:00:42Z",
  "comments": [
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "Aye, `Foreach-Object -Parallel` executes each branch in a separate context. If you want a specific version of the module imported for all the parallel executions, you'll need to run the import as part of the scriptblock provided to `Foreach-Object -Parallel` as well.",
      "created_at": "2022-04-24T14:10:56Z",
      "updated_at": "2022-04-24T14:11:08Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This issue has been marked as answered and has not had any activity for **1 day**. It has been closed for housekeeping purposes.",
      "created_at": "2022-04-27T00:00:42Z",
      "updated_at": "2022-04-27T00:00:42Z"
    }
  ],
  "created_at": "2022-04-24T05:33:39Z",
  "labels": [
    "Issue-Question",
    "Resolution-Answered"
  ],
  "number": 17187,
  "state": "closed",
  "title": "Wrong Hyper-V module used inside 'Foreach-object -Parallel' reported as wrong, but Ok out side of loop.",
  "updated_at": "2022-04-27T00:00:42Z"
}