{
  "_url": "https://github.com/PowerShell/PowerShell/issues/9300",
  "author": "JoeSalmeri",
  "body": "This is a followup to issue #8063 which appears closed but which did not fix the originally reported problem.\r\n\r\n# Steps to reproduce\r\n\r\nHi Steve,\r\n\r\nI have been anxiously awaiting this fix to test out the issues we discussed last year.\r\n\r\nUnfortunately the problems do not appear to be fixed and things appear to be seriously broken still to the point that the results are unusable.\r\n\r\nRun these commands\r\n\r\npwsh -noprofile\r\nGet-FormatData -PowerShellVersion 6.2 -TypeName System.IO.DirectoryInfo | Export-FormatData -LiteralPath DirectoryInfo.ps1xml\r\nGet-FormatData -PowerShellVersion 6.2 -TypeName System.IO.FileInfo      | Export-FormatData -LiteralPath FileInfo.ps1xml\r\nIf you compare DirectoryInfo.ps1xml and FileInfo.ps1xml you will find the are exactly the same, however, the output for a directory item versus a file item should not be the same as a directory does not contain a length.\r\n\r\nIgnoring that issue, the results returned are missing lots of XML code that was previously in FileSystem.format.ps1xml.\r\n\r\nI won't detail them all here as you can compare the results produced of Get-FormatData with the old FileSystem.format.ps1xml file to see them all, however, I will point out a few.\r\n\r\nFileSystem.format.ps1xml created a SelectionSet named FileSystemTypes and then used that and a CustomControlName FileSystemTypes-GroupingFormat for the view definitions. Those are all missing from the \"Get-FormatData\" results for System.IO.DirectoryInfo / System.IO.FileInfo.\r\n\r\nIgnore those issues, I attempted to merge my changes into the results returned from Get-FormatData and I found that my changes were not displaying so I did this simple test.\r\n\r\npwsh -noprofile\r\nGet-FormatData -PowerShellVersion 6.2 -TypeName System.IO.DirectoryInfo | Export-FormatData -LiteralPath DirectoryInfo.ps1xml\r\n\r\nEdit the DirectoryInfo.ps1xml file and make the following change:\r\n\r\n    Look for <Label>LastWriteTime</Label> and change it to <Label>XXXXWriteTime</Label>\r\n\r\nNow run\r\n\r\n    Update-FormatData -PrependPath .\\DirectoryInfo.ps1xml\r\n\r\nNow run Get-ChildItem and you will see that the label still says LastWriteTime instead of XXXXWriteTime\r\n\r\nNow run this to get what the updated formatting info looks like\r\n\r\n    Get-FormatData -PowerShellVersion 6.2 -TypeName System.IO.DirectoryInfo | Export-FormatData -LiteralPath DirectoryInfo2.ps1xml\r\n\r\nYou will find that it does show the change, however. there is another section after it that still has the label as \"LastWriteTime\".\r\nI believe all of these issues are because Get-FormatData is not returning the full and correct format data for these types.\r\n\r\nIf I run \"Update-FormatData -Prepend My,FileSystem.format.ps1\" which uses the modified version of the old FileSystem.format.ps1xml file that used to be included in PowerShell, then everything works correctly and it has my changes.\r\n\r\nSo we are back to the original problem.\r\n\r\nThere needs to be a way for me to obtain the format data being used (either via a file like it previously did or with Get-FormatData returning the correct formatting that is really being used).\r\n\r\nSince PowerShell is no longer including the *.format.ps1xml files and Get-FormatData is broken and does not return the correct format data I have no way to determine what changes were made in new versions of PowerShell so that I can integrate them into my modified version.\r\n\r\nI hope that this can be made a priority and get fixed soon.\r\n\r\nHoller if you want any more details.\r\n\r\nThanks!\r\n\r\nJoe\r\n",
  "closed_at": null,
  "comments": [
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@JoeSalmeri \r\nWe actually do you one format definition to display both objects.  The scripts embedded in the object take are of the issues of displaying or not displaying the length:\r\n\r\n```powershell\r\n$format = get-formatdata -TypeName System.IO.FileInfo -PowerShellVersion 6.2\r\n$format.FormatViewDefinition[0].Control.Rows[0].Columns[2].DisplayEntry.Value\r\n```\r\nresults:\r\n```powershell\r\nif ($_ -is [System.IO.DirectoryInfo]) { return '' }\r\nif ($_.Attributes -band [System.IO.FileAttributes]::Offline)\r\n{\r\n    return '({0})' -f $_.Length\r\n}\r\nreturn $_.Length\r\n```",
      "created_at": "2019-04-05T23:59:15Z",
      "updated_at": "2019-04-05T23:59:15Z"
    },
    {
      "author": "JoeSalmeri",
      "author_association": "NONE",
      "body": "@TravisEz13 \r\n\r\nThat explains why Get-FormatData for System.IO.DirectoryInfo and Get-FormatData for System.IO.FileInfo return the same results.\r\n\r\nI figured that you might be doing something like as part of the cleanup when the format.ps1xml files were integrated into the code, however, that does not address the main issue I reported that was supposed to be fixed.\r\n\r\nEither Get-FormatData is not returning the data properly or Export-FormatData is not properly formatting it into XML (or I'm making a mistake but I don't believe that is the case).\r\n\r\nFirst some quick background:\r\n\r\nI have some customization that I have made to the old FileSystem.format.ps1xml file.  With each new version of PS I have taken the newest version and integrated my changes into it to make sure that I picked up any changes that MS made.\r\n\r\nPS Core removed the format files and integrated them into the C# code and the solution I was given was to use Get-FormatData and Export-FormatData to create the XML which I could then tweak and then apply using Update-FormatData -Prepend.\r\n\r\nGet-FormatData had bugs which were to be fixed in PS Core 6.2 (by Steve)\r\n\r\nWith PS Core 6.2 available now I am testing out that functionality and the ability for me to re-integrate my changes.\r\n\r\nOk, now that you have the history here is a simple example that is not working properly:\r\n\r\npwsh -noprofile\r\nGet-FormatData -PowerShellVersion 6.2 -TypeName System.IO.DirectoryInfo | Export-FormatData -LiteralPath DirectoryInfo.ps1xml\r\n\r\nEdit the DirectoryInfo.ps1xml file and make the following change:\r\n\r\nLook for <Label>LastWriteTime</Label> and change it to <Label>XXXXWriteTime</Label>\r\nNow run\r\n\r\nUpdate-FormatData -PrependPath .\\DirectoryInfo.ps1xml\r\n\r\nNow run Get-ChildItem and see that it is not displaying the XXXXWriteTime label it is displaying LastWriteTime still.\r\n\r\nClearly there appears to be something wrong with roundtrip between Get-FormatData, Export-FormatData, Update-FormatData as a simple change like that should have not had any issues.\r\n\r\nNote: This is a simple change to illustrate that either Get-FormatData or Export-FormatData has a problem, my actual customization does a bunch of other things.\r\n\r\nWhen I compare the DirectoryInfo.ps1xml file created from Get-FormatData and Export-FormatData there are many differences from the old FileSystem.Format.ps1xml file (I listed some in my earlier reply).\r\n\r\nTo me it seems like the issue is still with Get-FormatData not properly returning the correct format data for DirectoryInfo so when I modify it and then try to reapply it does not work.\r\n\r\nIf I am making a mistake, could you please point out to me how to properly do the roundtrip to get the format data for DirectoryInfo as XML that I can modify and then reapply?\r\n\r\nThanks very much!\r\n\r\nRegards,\r\n\r\nJoe\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
      "created_at": "2019-04-06T01:04:56Z",
      "updated_at": "2019-04-06T01:04:56Z"
    },
    {
      "author": "JoeSalmeri",
      "author_association": "NONE",
      "body": "@TravisEz13 \r\n\r\nHi Travis, never heard anything back on this.\r\n\r\nWith the removal of the format files, there really needs to be a way to get the format data, export it, modify the exported format data and then re-apply the update.\r\n\r\nThe proposed solution I was given does not seem to work because EITHER Get-FormatData is still not fixed to get ALL the format data OR more likely Export-FormatData is not properly exporting all the format data retrieved.\r\n\r\nHere are the commands I was told to use:\r\n\r\n    Get-FormatData -PowerShellVersion 6.2 -TypeName System.IO.DirectoryInfo | Export-FormatData -LiteralPath DirectoryInfo.ps1xml\r\n\r\nModify DirectoryInfo.ps1xml using my editor/tools.\r\n\r\nUpdate-FormatData -PrependPath .\\DirectoryInfo.ps1xml\r\n\r\nIt is quite disappointing to see functionality removed when the replacement functionality does not appear to work properly\r\n\r\nIf I am incorrect and there are no more problems with Get-FormatData and Export-FormatData could you PLEASE provide some documentation or address my issue in that a roundtrip does not appear to be working?\r\n\r\nThis is on PowerShell Core 6.2 where it was all supposed to be fixed.\r\n\r\nThanks for your help.\r\n\r\nJoe\r\n\r\n\r\n\r\n\r\n",
      "created_at": "2019-05-28T00:08:57Z",
      "updated_at": "2019-05-28T00:14:34Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "To be honest we really need to have a cmdlet or something to _create_ format data that hooks into the C# APIs so that it's a lot easier to work with. Would be great to have a DSL-style module to make it really simple to work with. A lot of the C# APIs do a lot of method chaining to get things done, might be interesting to try to expose that as a series of cmdlets for use in PS, and improve `Update-FormatData` to accept this kind of input.",
      "created_at": "2019-05-28T01:36:35Z",
      "updated_at": "2019-05-28T01:36:35Z"
    },
    {
      "author": "JoeSalmeri",
      "author_association": "NONE",
      "body": "@vexx32 \r\n\r\nI agree that would be a welcome change.  \r\n\r\nMy issue is that the files are gone now and the methods that would allow me to modify still seem to be broken.  I am still using my modified FileSystem.format.ps1xml file from PS 5.  In the past I would check whenever that file was updated for any changes to make sure I kept my file updated with future PS changes. \r\n\r\nLooking at my changes they really come down to changing the format for numbers (length attribute) and dates.    The other changes are to adjust the width in output to handle the change in size for the number and date formats.\r\n\r\nIn Windows the formatting of Dates and Numbers is configured via Control Panel / Region and in Linux and also in other programming languages like Python they are configurable via locale.\r\n\r\nSince those are user defined settings for the formatting we are discussing it seems like PS should be using those settings instead of what it currently does or maybe we just need something like \r\n\r\n     SET-DEFAULT-NUMBER-FORMAT\r\n     SET-DEFAULT-DATE-FORMAT\r\n     SET-DEFAULT-DATETIME-FORMAT\r\n     SET-DEFAULT-TIME-FORMAT\r\n\r\nIf those existed then I suspect that I would not need the width changes I make because PS would adjust it's output based on the widths defined in those defaults.\r\n\r\nIs this even on the radar of any of the developers since we lost functionality and the suggestion methods are broken?\r\n\r\nThanks!\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
      "created_at": "2019-05-31T11:20:57Z",
      "updated_at": "2019-05-31T11:20:57Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "Number and datetime formats are typically controlled by culture settings, if I'm not mistaken? You might be able to adjust those from the objects Get/Set-Culture work with.",
      "created_at": "2019-05-31T11:24:02Z",
      "updated_at": "2019-05-31T11:24:02Z"
    },
    {
      "author": "JoeSalmeri",
      "author_association": "NONE",
      "body": "Hi Vexx32,\r\n\r\nSorry just saw this as I did not receive the normal email notification.\r\n\r\n(Get-Culture).NumberFormat has the desired settings but they are not being used by the built in formats.\r\n\r\n\r\n\r\n",
      "created_at": "2019-08-20T13:05:45Z",
      "updated_at": "2019-08-20T13:05:45Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "I would try modifying the settings with the objects you get from Get-Culture, and then pass them back into Set-Culture and/or $PSCulture/$PSUICulture\r\n\r\n```powershell\r\n$Culture = Get-Culture\r\n$Culture.NumberFormat = <# set number format #>\r\n$Culture | Set-Culture\r\n$PSUICulture = $PSCulture = $Culture\r\n```",
      "created_at": "2019-08-20T13:11:50Z",
      "updated_at": "2019-08-20T13:11:50Z"
    },
    {
      "author": "JoeSalmeri",
      "author_association": "NONE",
      "body": "@vexx32,\r\n\r\n(Get-Culture).NumberFormat has \r\n\r\nNumberGroupSizes         : {3}\r\nNumberGroupSeparator     : ,\r\n\r\nbut the views defined for System.IO.DirectoryInfo and System.IO.FileInfo do not use the   culture information when displaying the file sizes (length property).\r\n\r\nIn my custom format.sp1xml I just format them the way I want but it seems to me that the real issue is that the views defined do not use the culture settings.  If the internal views were changed to use the culture settings then everyone would get the values displayed in their native format (or could change the culture settings as you suggested) and I would not need my custom formats.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
      "created_at": "2019-08-20T14:42:40Z",
      "updated_at": "2019-08-20T14:42:40Z"
    },
    {
      "author": "marckassay",
      "author_association": "NONE",
      "body": "> I believe all of these issues are because Get-FormatData is not returning the full and correct format data for these types.\r\n\r\n@JoeSalmeri, just dropping in real quick as I haven't read this thread fully but did a search for 'scriptblock' and found nothing. You suspected it may be `Get-FormatData` causing issues. But that is being piped into `Export-FormatData`. That format type, DirectoryInfo, contains scripts, which if needed, would have to be explicitly requested by using the `IncludeScriptBlock` switch parameter for `Export-FormatData`. ",
      "created_at": "2020-01-15T17:10:05Z",
      "updated_at": "2020-01-15T17:10:05Z"
    },
    {
      "author": "JoeSalmeri",
      "author_association": "NONE",
      "body": "@marckassay \r\n\r\nThanks for chiming in regarding this issue.\r\n\r\nJust to summarize for you.\r\n\r\nPowerShell no longer includes the *.ps1xml files that previously shipped with it.\r\n\r\nPreviously whenever a new PS version came out, I copied the ps1xml file and reapplied my customizations and then used Update-FormatData to load my changes.  I did this so that my customizations always included any changes that MSFT made to the ps1xml files.\r\n\r\nOnce the files were removed I have been trying to use Get-FormatData to get the full source for DirectoryInfo so that I can apply my customizations to it.   \r\n\r\nOriginally there was a bug (which is supposed to be fixed now) but I have tried the recommendations and still do not receive the full format data.\r\n\r\nHere are the commands recommended that I am using (with your suggestion now included):\r\n\r\nGet-FormatData -TypeName System.IO.DirectoryInfo -PowerShellVersion 7.0 | \r\n    Export-FormatData -LiteralPath DirectoryInfo.ps1xml -IncludeScriptBlock\r\n\r\nIf I issue that command AFTER I load my customizations then the DirectionInfo.ps1mxl file DOES contain the ScriptBlocks that I had defined in my ps1xml file.\r\n\r\nIf I start powershell without my profile (which loads my customizations) using\r\n\r\npwsh -noprofile\r\n\r\nand then issue the above Get-FormatData command then the DirectoryInfo.ps1xml file DOES NOT contain any ScriptBlocks.\r\n\r\n\r\nAfter initially reporting the issue about not being able to get the full format data for DirectoryInfo, I also asked how the \"length\" field information was handled using the new FormatData (where DirectoryInfo and FileFileInfo were merged)  because only files have a length.\r\n\r\nAbove you can see @TravisEz13 reply where he showed the following:\r\n\r\n    $format = get-formatdata -TypeName System.IO.FileInfo -PowerShellVersion 6.2\r\n    $format.FormatViewDefinition[0].Control.Rows[0].Columns[2].DisplayEntry.Value\r\n\r\nWhich produced\r\n\r\nif ($_ -is [System.IO.DirectoryInfo]) { return '' }\r\nif ($_.Attributes -band [System.IO.FileAttributes]::Offline)\r\n{\r\n    return '({0})' -f $_.Length\r\n}\r\nreturn $_.Length\r\n\r\nHowever, using the Get-FormatData command above, that information does not appear in the ps1xml file.\r\n\r\nTo summarize, I am trying to get the full format data for DirectoryFileInfo so that I can export it customize to my liking and then Update-FormatData to load my customizations.  \r\n\r\nI use this approach so that if Microsoft ever makes changes to the format data then I will not lose those changes in my customizations.\r\n\r\nIf you issue the pwsh -noprofile command followed by the Get-FormatData command above and look at the resulting DirectoryInfo.ps1xml file you will see that no Script blocks exist and it does NOT include the ScriptBlock shown by @TravisEz13 \r\n\r\nInterestingly the resulting XML contains the following:\r\n\r\n    <PropertyName>LengthString</PropertyName>\r\n\r\nhowever, if you issue\r\n\r\ndir | gm *\r\n\r\nthe resulting object does not contain a LengthString property.\r\n\r\nIf you issue the following commands from @TravisEz13  now on PS 7 rc 2\r\n\r\n$format = get-formatdata -TypeName System.IO.FileInfo -PowerShellVersion 6.2\r\n$format.FormatViewDefinition[0].Control.Rows[0].Columns[2].DisplayEntry.Value\r\n\r\n you get\r\n     LengthString\r\n\r\nSo something else has changed again since @TravisEz13 reply\r\n\r\n\r\nOne of the formating changes that I make in my customizations is to add commas to the length property.  Above you will see a recommendation to use Get-Culture to configure my desired format, however, that does now work because DirectoryInfo does not honor the culture settings.\r\n\r\n\r\n\r\nSo the end goal is to use Get-FormatData and Export-FormatData to produce the complete format data that is being used by DirectoryInfo now that the ps1xml files are removed.   \r\n\r\nIt appears that this is still broken and not possible to do.\r\n\r\nIt is frustrating that the ps1xml files were removed before the replacement code to extract the format data was working properly.\r\n\r\nThis is not an intermittent problem and therefore it should be easy to debug why we can no longer get the complete formatdata for DirectoryInfo.\r\n\r\nPlease try the above commands and you will see what I am talking about.\r\n\r\nHopefully someone will investigate and either fix the problem or provide the correct commands to get the full format data.\r\n\r\nHoller if you need more details.\r\n\r\nThanks again!\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
      "created_at": "2020-01-19T19:14:21Z",
      "updated_at": "2020-01-19T19:14:21Z"
    },
    {
      "author": "marckassay",
      "author_association": "NONE",
      "body": "@JoeSalmeri thanks for the thorough explanation! I didn't realize that ps1xml are excluded in shipment until you mentioned, as it is still mentioned in the docs, and obviously still can be used in PowerShell. So it's just PowerShell today doesn't return all or correct ps1xml data, in the scenarios you mentioned.",
      "created_at": "2020-01-22T15:52:56Z",
      "updated_at": "2020-01-22T15:52:56Z"
    },
    {
      "author": "JoeSalmeri",
      "author_association": "NONE",
      "body": "@marckassay sure no problem!\r\n\r\nYou are correct (at least last time I had checked) that the documentation still references the ps1xml files.\r\n\r\nIt is really frustrating that the files were removed before the complete replacement solution was in place.\r\n\r\nUnfortunately the issue does not seem to get any priority.\r\n\r\n\r\n",
      "created_at": "2020-01-22T16:07:54Z",
      "updated_at": "2020-01-22T16:07:54Z"
    },
    {
      "author": "JoeSalmeri",
      "author_association": "NONE",
      "body": "@TravisEz13 \r\n\r\nSo with PS 7.2 released I decided to revisit the issues I reported here.\r\n\r\nIt looks like the Get-FormatData part works but Export-FormatData is still broken.\r\n\r\nThis can be seen by doing the following\r\n\r\nGet-FormatData -TypeName System.IO.DirectoryInfo | Export-FormatData -Path fi.ps1xml -IncludeScriptBlock\r\n\r\nfollowed by\r\n\r\nUpdate-FormatData -PrePendPath \r\n\r\nThen do a Get-ChildItem on a folder than contains other folders and also files and noticed the messed up output.\r\n\r\nI have resolved the items that Export-FormatData forgot to export but I have one remaining issue that I could not resolve and was hoping that you help me out.\r\n\r\nIn most view it has the following:\r\n\r\n<GroupBy>\r\n   <PropertyName>PSParentPath</PropertyName>\r\n</GroupBy>\r\n\r\nThe issue is that PSParentPath has a value like this:\r\n\r\n   Microsoft.PowerShell.Core\\FileSystem::/usr/bin\r\n\r\n* /usr/bin replaced with whatever directory you were displaying\r\n\r\nBack in the days of the old format files it had the following code which stripped that out of PSParentPath\r\n\r\n    <Controls>\r\n        <Control>\r\n            <Name>FileSystemTypes-GroupingFormat</Name>\r\n            <CustomControl>\r\n                <CustomEntries>\r\n                    <CustomEntry>\r\n                        <CustomItem>\r\n                            <Frame>\r\n                                <CustomItem>\r\n                                    <Text AssemblyName=\"System.Management.Automation\" BaseName=\"FileSystemProviderStrings\" ResourceId=\"DirectoryDisplayGrouping\"/>\r\n                                    <ExpressionBinding>\r\n                                        <ScriptBlock>\r\n                                            $_.PSParentPath.Replace(\"Microsoft.PowerShell.Core\\FileSystem::\", \"\")\r\n                                        </ScriptBlock>\r\n                                    </ExpressionBinding>\r\n                                </CustomItem>\r\n                            </Frame>\r\n                        </CustomItem>\r\n                    </CustomEntry>\r\n                </CustomEntries>\r\n            </CustomControl>\r\n        </Control>\r\n    </Controls>\r\n\r\nI have been unable to figure out how the NEW formatting is removing the  \"Microsoft.PowerShell.Core\\FileSystem::\" as that custom control is no longer in the format data.\r\n\r\nWhen ps is installed the NEW format data removes it even though I cannot find anything in the code that does it, however,\r\nwhen I do the Get-FormatData | Export-FormatData and then Update-FormatData it starts displaying the \r\n\"Microsoft.PowerShell.Core\\FileSystem::\" again for each group.\r\n\r\nHow is that getting removed now that the control is no longer created?  (or if it is I don't see it in the format data)\r\nObviously something else is missing the get / export update formatdata cycle but I have not been able to figure out what it is.\r\n\r\nCan you please point me at how this is now done?\r\n\r\nThanks!\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
      "created_at": "2021-11-11T23:29:30Z",
      "updated_at": "2021-11-11T23:29:30Z"
    },
    {
      "author": "JoeSalmeri",
      "author_association": "NONE",
      "body": "Ok, I went to the PS source code in in this file\r\n\r\nPowerShell-7.2.0/src/System.Management.Automation/FormatAndOutput/DefaultFormatters/FileSystem_format_ps1xml.cs\r\n\r\nThe view definitions are created and I see that it creates a shared custom control to the string used for PSParent grouping.\r\n\r\nI cannot find that definition in the Get-FormatData returned or in the Export-FormatData written to the file.\r\n\r\nObviously I can add the above Control code in my previous message to the ps1xml file but is there a way to extract that data so that get-formatdata and export-formatdata include it?\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
      "created_at": "2021-11-12T01:03:22Z",
      "updated_at": "2021-11-12T01:03:22Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@JoeSalmeri Thanks for your investigations!\r\n\r\nI'd ask you to reword the issue to get progress easily. \r\n1. Pick up a type (which is not in FormatData already)\r\n2. Create format XML file (or some files to demonstrate issues by one) for it\r\n3. Do import/get/export to xml\r\n4. Compare source and result xml files\r\n\r\nSuch process helps us to understand the issue(s) easily and write new tests for future PSs.\r\n\r\nAlso. it seems we had a discussion to add XML output for Get-FormatData or something like. This could helps too.\r\n\r\nThen, you could review related issues #11596, #11308, #11307.\r\n\r\n/cc @daxian-dbw @mklement0 who could advice.",
      "created_at": "2021-11-12T05:21:19Z",
      "updated_at": "2021-11-12T05:21:43Z"
    },
    {
      "author": "JoeSalmeri",
      "author_association": "NONE",
      "body": "@iSazonov \r\n\r\nI cannot pick a type that is not in the FormatData because the entire issue is based on changing one of the built in format types\r\nand the fact that doing a roundtrip ( Get-FormatData, Export-FormatData, Update-FormatData) does not work because the Get-FormatData and ExportData do not produce the complete existing format data that the PS source code creates.\r\n\r\nIt is easy to demonstrate this with the following example:\r\n\r\npwsh -noprofile\r\n\r\nmd ./test-dir\r\necho 'file-1' > ./test-dir/file-1\r\necho 'file-2' > ./test-dir/file-2\r\nmd ./test-dir/test-dir2\r\nmd ./test-dir/test-dir3\r\n\r\nGet-ChildItem ./test-dir\r\n\r\n        Directory: /home/joe/test-dir\r\n\r\n    UnixMode   User             Group                 LastWriteTime           Size Name\r\n    --------   ----             -----                 -------------           ---- ----\r\n    drwx------ joe              joe-denise         11/12/2021 09:08              0 test-dir2\r\n    drwx------ joe              joe-denise         11/12/2021 09:08              0 test-dir3\r\n    -rw------- joe              joe-denise         11/12/2021 09:08              7 file-1\r\n    -rw------- joe              joe-denise         11/12/2021 09:08              7 file-2\r\n\r\nGet-FormatData -Type System.IO.DirectoryInfo | Export-FormatData -IncludeScriptBlock -Path DirectoryInfo.ps1xml\r\n\r\nUpdate-FormatData -PrePend ./DirectoryInfo.ps1xml\r\n\r\nGet-ChildItem ./test-dir\r\n\r\n       PSParentPath: Microsoft.PowerShell.Core\\FileSystem::/home/joe/test-dir\r\n\r\n    UnixMode   User             Group                 LastWriteTime           Size Name\r\n    --------   ----             -----                 -------------           ---- ----\r\n    drwx------ joe              joe-denise         11/12/2021 09:08              0 test-dir2\r\n    drwx------ joe              joe-denise         11/12/2021 09:08              0 test-dir3\r\n\r\n    LastWriteTime : 11/12/2021 9:08:14 AM\r\n    Length        : 7\r\n    Name          : file-1\r\n\r\n\r\n    LastWriteTime : 11/12/2021 9:08:14 AM\r\n    Length        : 7\r\n    Name          : file-2\r\n\r\nNo changes were made to the System.IO.DirectoryInfo that was retrieved, yet now the\r\nGet-ChildItem output is messed up and has two problems.\r\n\r\nThe first issue that jumps right out is the fact that directories are being displayed\r\nin table format whereas files are being displayed in list format.\r\n\r\n\"Get-ChildItem ./test-dir | Format-Table\" still produces the messed up output.\r\n\r\n\"Get-ChildItem ./test-dir/ | Format-Table -View children\" which is the view that\r\nis the default view on Windows also has output that is messed up and has the\r\nsame two problems:\r\n\r\n       PSParentPath: Microsoft.PowerShell.Core\\FileSystem::/home/joe/test-dir\r\n\r\n    Mode                 LastWriteTime         Length Name\r\n    ----                 -------------         ------ ----\r\n    d----          11/12/2021  9:08 AM                test-dir2\r\n    d----          11/12/2021  9:08 AM                test-dir3\r\n\r\n    LastWriteTime : 11/12/2021 9:16:01 AM\r\n    Length        : 7\r\n    Name          : file-1\r\n\r\n\r\n    LastWriteTime : 11/12/2021 9:16:01 AM\r\n    Length        : 7\r\n    Name          : file-2\r\n\r\nThe reason the first issue occurs is because Export-FormatData is not exporting\r\ncomplete data and is missing <TypeName> values which were there when the\r\nsource code created them and are also in the Get-Format data produced.\r\n\r\nPS Source code reference:\r\n\r\n    PowerShell-7.2.0/src/System.Management.Automation/FormatAndOutput/DefaultFormatters/FileSystem_format_ps1xml.cs\r\n\r\nIt is easy to fix the bad DirectoryInfo.ps1xml file that Export-FormatData created\r\nby adding back the missing <TypeName> information in the file created.\r\n\r\nThe second issue is with the directory line.\r\n\r\nWhen it is working that line says:\r\n\r\n        Directory: /home/joe/test-dir\r\n\r\nWhen the bad DirectoryInfo.ps1xml file that Export-FormatData created\r\nis reloaded then it says:\r\n\r\n        PSParentPath: Microsoft.PowerShell.Core\\FileSystem::/home/joe/test-dir\r\n\r\nThat one took me a lot longer to figure out until I looked at the PS source code\r\nreferenced above.\r\n\r\nIn the old days when PS included the *.format.ps1xml files the custom control\r\nwas included in the files.\r\n\r\nThose files were removed from the release and moved into the source code\r\nwhere it has the code to add the custom control but Get-FormatData / Export-FormatData\r\nis not including that custom control in the output they generate and therefore\r\nyou get the PSParentPath value above instead of the PSParent value that\r\nis modified by the custom control in line 17 of the source code.\r\n\r\nAlthough the above was done on Linux using the new childrenWithUnixStat, I\r\nalso showed that the children table view is also broke, and these same issues\r\noccur on Windows 10 too ( with the exception of the childrenWithUnixStat view\r\nwhich only exists on Linux).\r\n\r\nFor the first issue shown, the data is in the Get-FormatData output, the\r\nproblem is that Export-FormatData does not export everything and is missing\r\nthe additional <TypeName> values.\r\n\r\nTo fix that issue Export-FormatData needs to be fixed to include ALL <TypeName> values, not just the first one.\r\n\r\nFor the second issue shown, it looks like Get-FormatData output does not\r\ninclude the custom control from the source code and therefore Export-FormatData\r\ndoes not have the information to export.\r\n\r\nTo fix that issue Get-FormatData needs to also output the custom control that is created in the PS source code and Export-FormatData needs to export the custom control that would then be output by Get-FormatData.\r\n\r\nThis gives you a detailed example of exactly what is broken (with the source code references to show what should have been output) and also the what code is broken and causing the issues.\r\n\r\nThis is 100% reproducible using the example above and is an issue on BOTH Linux and Windows.\r\n\r\nIf you need anything else please let me know but with the details above and example it should be clear exactly what the problems are and what needs to be done to fix them.\r\n\r\nThanks!\r\n\r\nHave a great day!\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
      "created_at": "2021-11-12T14:48:12Z",
      "updated_at": "2021-11-12T14:55:19Z"
    }
  ],
  "created_at": "2019-04-05T19:32:49Z",
  "labels": [
    "Issue-Bug",
    "WG-Cmdlets-Utility"
  ],
  "number": 9300,
  "state": "open",
  "title": "Question: not getting expected results for get-formatdata",
  "updated_at": "2021-11-15T18:52:43Z"
}