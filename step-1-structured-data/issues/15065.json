{
  "_url": "https://github.com/PowerShell/PowerShell/issues/15065",
  "author": "brwilkinson",
  "body": "## Steps to reproduce\r\n\r\n- Load a new session\r\n- Check the PSReadline Module version that was loaded\r\n- Look at all of the Module versions that are available on the system\r\n- pwsh is loading the first Module it finds, not the latest version of the module in all PSModulepath locations.\r\n\r\n#### 7.2.0-preview.4\r\n\r\n```powershell\r\n#----------------------------\r\n# what is loaded ?\r\ngmo psreadline\r\n\r\nModuleType Version PreRelease Name       ExportedCommands\r\n---------- ------- ---------- ----       ----------------\r\nScript     2.1.0              PSReadLine {Get-PSReadLineKeyHandler, Get-PSReadLineOption, Remove-PSReadLineKeyHandler, Set-PSReadLineKeyHandler\u2026}\r\n\r\n#----------------------------\r\n# what is available to load ?\r\ngmo psreadline -All -ListAvailable\r\n\r\n    Directory: C:\\program files\\windowsapps\\microsoft.powershellpreview_7.2.4.0_x64__8wekyb3d8bbwe\\Modules\r\n\r\nModuleType Version PreRelease Name       PSEdition ExportedCommands\r\n---------- ------- ---------- ----       --------- ----------------\r\nScript     2.1.0              PSReadLine Desk      {Get-PSReadLineKeyHandler, Set-PSReadLineKeyHandler, Remove-PSReadLineKeyHandler, Get-PSReadLineOption\u2026}\r\nScript     0.0                PSReadLine Desk      {Set-PSReadLineKeyHandler, Get-PSReadLineKeyHandler, Get-PSReadLineOption, Remove-PSReadLineKeyHandler\u2026}\r\n\r\n    Directory: C:\\Program Files\\WindowsPowerShell\\Modules\r\n\r\nModuleType Version PreRelease Name       PSEdition ExportedCommands\r\n---------- ------- ---------- ----       --------- ----------------\r\nScript     2.2.0   beta2      PSReadLine Desk      {Get-PSReadLineKeyHandler, Set-PSReadLineKeyHandler, Remove-PSReadLineKeyHandler, Get-PSReadLineOption\u2026}\r\nScript     0.0                PSReadLine Desk      PSConsoleHostReadLine\r\n\r\n\r\n$env:PSModulePath -split \";\"\r\nD:\\OneDrive\\Documents\\PowerShell\\Modules\r\nC:\\Program Files\\PowerShell\\Modules\r\nc:\\program files\\windowsapps\\microsoft.powershellpreview_7.2.4.0_x64__8wekyb3d8bbwe\\Modules\r\nD:\\OneDrive\\Documents\\WindowsPowerShell\\Modules\r\nC:\\Program Files\\WindowsPowerShell\\Modules\r\nC:\\WINDOWS\\system32\\WindowsPowerShell\\v1.0\\Modules\r\n```\r\n#### same in 7.1.2\r\n```powershell\r\ngmo psreadline\r\n\r\nModuleType Version PreRelease Name       ExportedCommands\r\n---------- ------- ---------- ----       ----------------\r\nScript     2.1.0              PSReadLine {Get-PSReadLineKeyHandler, Get-PSReadLineOption, Remove-PSReadLineKeyHandler, Set-PSReadLineKeyHandler\u2026}\r\n\r\ngmo psreadline -All -ListAvailable\r\n\r\n    Directory: C:\\Program Files\\PowerShell\\Modules\r\n\r\nModuleType Version PreRelease Name       PSEdition ExportedCommands\r\n---------- ------- ---------- ----       --------- ----------------\r\nScript     2.1.0              PSReadLine Desk      {Get-PSReadLineKeyHandler, Set-PSReadLineKeyHandler, Remove-PSReadLineKeyHandler, Get-PSReadLineOption\u2026}\r\nScript     0.0                PSReadLine Desk      {Get-PSReadLineKeyHandler, Set-PSReadLineKeyHandler, Get-PSReadLineOption, Remove-PSReadLineKeyHandler\u2026}\r\n\r\n    Directory: C:\\Program Files\\WindowsPowerShell\\Modules\r\n\r\nModuleType Version PreRelease Name       PSEdition ExportedCommands\r\n---------- ------- ---------- ----       --------- ----------------\r\nScript     2.2.0   beta2      PSReadLine Desk      {Get-PSReadLineKeyHandler, Set-PSReadLineKeyHandler, Remove-PSReadLineKeyHandler, Get-PSReadLineOption\u2026}\r\nScript     0.0                PSReadLine Desk      {Get-PSReadLineKeyHandler, Set-PSReadLineKeyHandler, Get-PSReadLineOption, Remove-PSReadLineKeyHandler\u2026}\r\n\r\n$env:PSModulePath -split \";\"\r\nD:\\OneDrive\\Documents\\PowerShell\\Modules\r\nC:\\Program Files\\PowerShell\\Modules\r\nc:\\program files\\powershell\\7\\Modules\r\nD:\\OneDrive\\Documents\\WindowsPowerShell\\Modules\r\nC:\\Program Files\\WindowsPowerShell\\Modules\r\nC:\\WINDOWS\\system32\\WindowsPowerShell\\v1.0\\Modules\r\n```\r\n\r\n## Expected behavior\r\nload the newest/latest module in all psmodulepath directories\r\n\r\n## Actual behavior\r\nloading the version in the first psmodulepath directory that it finds ? OR only it's local module dir ?\r\n\r\n## workaround\r\n- only available in non MSIX/Store version of PowerShell.\r\n````powershell\r\n# remove the module from the local/first directory\r\nrm 'C:\\Program Files\\PowerShell\\Modules\\PSReadLine\\' -Recurse -Force\r\n\r\n# start new session, it successfully load the latest.\r\ngmo psreadline\r\n\r\nModuleType Version PreRelease Name       ExportedCommands\r\n---------- ------- ---------- ----       ----------------\r\nScript     2.2.0   beta2      PSReadLine {Get-PSReadLineKeyHandler, Get-PSReadLineOption, Remove-PSReadLineKeyHandler, Set-PSReadLineKeyHandler\u2026}\r\n\r\n````",
  "closed_at": "2021-08-13T02:58:10Z",
  "comments": [
    {
      "author": "kilasuit",
      "author_association": "COLLABORATOR",
      "body": "> pwsh is loading the first Module it finds, not the latest version of the module in all PSModulepath locations.\r\n\r\nThis is **expected** behaviour & one that I don't seen it changing as it is based on the way that PowerShell discovers and organises it's module cache. This is built based on the ordering of PSModulePath which means that PowerShell will not simply load the latest version available and will as you've noticed will load in path order, which I admit may seem counter intuitive. The design as this is right now ensures that an admin push of a newer version of a module to any of the All Users locations `C:\\Program Files\\PowerShell\\Modules`, `c:\\program files\\powershell\\7\\Modules`, `C:\\Program Files\\WindowsPowerShell\\Modules` does not impact anything that may be requiring a version the user may have installed in their userpath location.\r\n\r\nPowerShell already gives lots of ways to ensure correct loading of the right version of the module from whatever location it is installed in by allowing passing of a PSModuleInfo object like in my below function or explicitly telling Import-Module to load either a `RequiredVersion` or a `MinimumVersion` or a full path to a `psm1` or `psd1`\r\n\r\nI however get round this with this little function though perhaps a future enhancement to `Import-Module` could be to add a `Latest` switch that essentially does this \r\n\r\n```powershell\r\nfunction Import-LatestModule  {\r\n    [CmdletBinding()]\r\n    [Alias('iplmo')]\r\n    param (\r\n     # Parameter help description\r\n     [Parameter(Mandatory=$true, Position=0)]\r\n     [String]\r\n     $Module   \r\n    )\r\n    Get-Module $module -ListAvailable | Sort-Object Version -Descending -Top 1 | Import-Module\r\n}\r\n```",
      "created_at": "2021-08-12T09:19:29Z",
      "updated_at": "2021-08-12T09:19:29Z"
    },
    {
      "author": "brwilkinson",
      "author_association": "NONE",
      "body": "It seems you are correct, however I was sure this wasn't the original behavior with Windows PowerShell ? ... however testing below is seems that it is the current behavior, which I am surprised.\r\n\r\n```powershell\r\n$env:PSModulePath -split \";\"\r\nD:\\OneDrive\\Documents\\WindowsPowerShell\\Modules\r\nC:\\Program Files\\WindowsPowerShell\\Modules\r\n```\r\n\r\n\r\n```powershell\r\nfind-module profiler -AllVersions\r\n\r\nVersion              Name                                Repository           Description\r\n-------              ----                                ----------           -----------\r\n3.1.1                Profiler                            PSGallery            Script, ScriptBlock and module performan\u2026\r\n3.0.2                Profiler                            PSGallery\r\n\r\ninstall-module profiler -Scope AllUsers\r\ninstall-module profiler -Scope CurrentUser -RequiredVersion 3.0.2\r\n\r\ngmo profiler -listavailable\r\n\r\n    Directory: D:\\OneDrive\\Documents\\WindowsPowerShell\\Modules\r\n\r\nModuleType Version    PreRelease Name                                PSEdition ExportedCommands\r\n---------- -------    ---------- ----                                --------- ----------------\r\nScript     3.0.2                 Profiler                            Desk      {Invoke-Script, Trace-Script, Get-LatestTrace, Show-ScriptExecution}\r\n\r\n    Directory: C:\\Program Files\\WindowsPowerShell\\Modules\r\n\r\nModuleType Version    PreRelease Name                                PSEdition ExportedCommands\r\n---------- -------    ---------- ----                                --------- ----------------\r\nScript     3.1.1                 Profiler                            Desk      {Invoke-Script, Trace-Script, Get-LatestTrace, Show-ScriptExecution}\r\n```\r\n\r\nWindows Powershell + PowerShell both loading the first one it finds... I am sure it didn't always do this however?!?!\r\n\r\n```powershell\r\nTrace-Script -ScriptBlock {gps}\r\n...\r\n\r\ngmo profiler\r\n\r\nModuleType Version    PreRelease Name                                ExportedCommands\r\n---------- -------    ---------- ----                                ----------------\r\nScript     3.0.2                 Profiler\r\n```\r\n\r\n",
      "created_at": "2021-08-13T00:16:19Z",
      "updated_at": "2021-08-13T00:16:19Z"
    },
    {
      "author": "brwilkinson",
      "author_association": "NONE",
      "body": "Will close, since I didn't realize this was the same behavior as WMF 5.1.\n",
      "created_at": "2021-08-13T02:58:05Z",
      "updated_at": "2021-08-13T02:58:05Z"
    }
  ],
  "created_at": "2021-03-19T17:53:58Z",
  "labels": [
    "Issue-Question",
    "Resolution-Answered",
    "WG-Cmdlets-Core"
  ],
  "number": 15065,
  "state": "closed",
  "title": "PowerShell not loading the latest Modules from ENV:PSModulePath",
  "updated_at": "2021-08-13T03:12:01Z"
}