{
  "_url": "https://github.com/PowerShell/PowerShell/issues/12423",
  "author": "ChrisLynchHPE",
  "body": "# Steps to reproduce\r\n\r\nI am using a script ([here](https://stackoverflow.com/a/48323495/3399822), that is slightly modified to support web form file upload) that works just fine in PowerShell 5.0 and 5.1 within Windows, which uploads files to a web service.  It reads the file in chunks, and transfers the bytes to the target web service. This is the file I am trying to transfer:\r\n\r\n```powershell\r\n[posh-worker1]: PS C:\\Testing> $file | fl\r\n\r\n    Directory: \\\\fileserver\\share\\dir1\r\n\r\nName           : isoimage1.iso\r\nLength         : 1379500032\r\nCreationTime   : 2/24/2019 10:47:19 PM\r\nLastWriteTime  : 2/24/2019 10:18:15 PM\r\nLastAccessTime : 2/24/2019 10:47:19 PM\r\nMode           : -a---\r\nLinkType       :\r\nTarget         :\r\nVersionInfo    : File:             \\\\fileserver\\share\\dir1\\isoimage1.iso\r\n                 InternalName:\r\n                 OriginalFilename:\r\n                 FileVersion:\r\n                 FileDescription:\r\n                 Product:\r\n                 ProductVersion:\r\n                 Debug:            False\r\n                 Patched:          False\r\n                 PreRelease:       False\r\n                 PrivateBuild:     False\r\n                 SpecialBuild:     False\r\n                 Language:\r\n```\r\n\r\nWhen I run this in either PowerShell Core using a Remote PSSession (when setting `$PSSessionConfigurationName = 'PowerShell.7'` to ensure the remote is PowerShell 7) from a Windows 10 to Windows 10 (both 1909) system, I get the following:\r\n\r\n```powershell\r\nErrorRecord                 : Exception of type 'System.OutOfMemoryException' was thrown.\r\nWasThrownFromThrowStatement : False\r\nTargetSite                  : Void Throw()\r\nStackTrace                  :    at System.Management.Automation.Internal.PipelineProcessor.SynchronousExecuteEnumerate\r\n                              (Object input)\r\n                                 at System.Management.Automation.Runspaces.LocalPipeline.InvokeHelper()\r\n                                 at System.Management.Automation.Runspaces.LocalPipeline.InvokeThreadProc()\r\nMessage                     : Exception of type 'System.OutOfMemoryException' was thrown.\r\nData                        : {}\r\nInnerException              : System.OutOfMemoryException: Exception of type 'System.OutOfMemoryException' was thrown.\r\n                                 at System.IO.MemoryStream.set_Capacity(Int32 value)\r\n                                 at System.IO.MemoryStream.EnsureCapacity(Int32 value)\r\n                                 at System.IO.MemoryStream.Write(Byte[] buffer, Int32 offset, Int32 count)\r\n                                 at CallSite.Target(Closure , CallSite , Object , Byte[] , Int32 , Object )\r\nHelpLink                    :\r\nSource                      : System.Private.CoreLib\r\nHResult                     : -2146233087\r\n```\r\n\r\nI found some folks talking about how PowerShell limits the amount of RAM allocated to the remote session, which is 150MB.  I adjusted it using the following on the remote system:\r\n\r\n```powershell\r\nSet-Item WSMan:\\localhost\\Shell\\MaxMemoryPerShellMB 1000000\r\nSet-Item WSMan:\\localhost\\Plugin\\Microsoft.PowerShell\\Quotas\\MaxMemoryPerShellMB 1000000\r\nRestart-Service WinRM\r\n```\r\n\r\nThe very same code is successful without setting `$PSSessionConfigurationName = 'PowerShell.7'` before initiating an Enter-PSSession command.\r\n\r\nThis obviously did not help.  So not sure where else to turn.\r\n\r\nYou may ask why I'm not using something like Invoke-WebRequest?  Well, I need additional progress indicator and HTTPS cert validation that Invoke-WebRequet and Invoke-RestMethod just cannot provide.\r\n\r\n# Expected behavior\r\n\r\nI should be able to take the same code I wrote for PowerShell 5.1 to work within PowerShell 7, when using a PS Remote Session.\r\n\r\n# Environment data\r\n\r\n```powershell\r\n\r\n# When setting $PSSessionConfigurationName = 'PowerShell.7' from the initiating client\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.0.0\r\nPSEdition                      Core\r\nGitCommitId                    7.0.0\r\nOS                             Microsoft Windows 10.0.18363\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\n# When NOT setting $PSSessionConfigurationName = 'PowerShell.7' from the initiating client\r\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.18362.752\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.18362.752\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\n\r\n```\r\n",
  "closed_at": "2020-09-30T20:28:37Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": ".Net MSFT team recommends to migrate to .Net Core. So it's time to migrate Windows PowerShell scripts to PowerShell 7. \r\nIn PowerShell 7 web cmdlets was optimized for many scenarios and do not consume large memory. These optimizations will be never ported to Windows PowerShell.\r\n(If you see issues with these cmdlets please report.)\r\nSo you can continue to use Windows PowerShell while you can but it is recommended to begin migration to PowerShell 7.\r\n\r\n@PaulHigin Have you thoughts about the backward compatibility scenario?",
      "created_at": "2020-04-22T12:34:03Z",
      "updated_at": "2020-04-22T12:34:03Z"
    },
    {
      "author": "fMichaleczek",
      "author_association": "NONE",
      "body": "> I found some folks talking about how PowerShell limits the amount of RAM allocated to the remote session, which is 150MB. I adjusted it using the following on the remote system:\r\n> \r\n> ```powershell\r\n> Set-Item WSMan:\\localhost\\Shell\\MaxMemoryPerShellMB 1000000\r\n> Set-Item WSMan:\\localhost\\Plugin\\Microsoft.PowerShell\\Quotas\\MaxMemoryPerShellMB 1000000\r\n> Restart-Service WinRM\r\n> ```\r\nCan you verify the output of this command  on the remote server  ?\r\n`Get-Item WSMan:\\localhost\\Plugin\\*\\Quotas\\MaxMemoryPerShellMB`\r\n\r\nI think you have set the MaxMemory for Windows PowerShell but not for PowerShell 7. \r\n\r\n\r\n",
      "created_at": "2020-04-22T14:43:28Z",
      "updated_at": "2020-04-22T14:43:28Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "There haven't been any changes that I am aware of in PS7 remoting affecting max allowed memory.  The default values are the same for either Windows PowerShell (\"microsoft.powershell\") or PowerShell 7 (\"powershell.7\").  In both cases the default value is unlimited ([int]::MaxValue).\r\n\r\nBut you can check the configuration on the target machine, to see if it has changed from the default value, as @fMichaleczek  points out.  You should check both the individual endpoint plugin, but also the overall quota setting for the machine:\r\n\r\n```powershell\r\n# Individual powershell.7 plugin\r\ndir WSMan:\\localhost\\Plugin\\Microsoft.PowerShell\\Quotas\\MaxMemoryPerShellMB\r\n\r\n# Machine wide max shell memory\r\ndir WSMan:\\localhost\\Shell\\MaxMemoryPerShellMB\r\n```",
      "created_at": "2020-04-22T15:44:08Z",
      "updated_at": "2020-04-22T15:44:08Z"
    },
    {
      "author": "fMichaleczek",
      "author_association": "NONE",
      "body": "@PaulHigin I think you're wrong. There is a dedicated plugin configured for each version of PowerShell. (And if i remember, it was the same with PS2.0 + PS3-5.1) and the value of 1Gb is hardcoded in Install-PowerShellRemoting.ps1.\r\n\r\nThis is the result of my previous command on my computer :\r\n```\r\nPS> Get-Item WSMan:\\localhost\\Plugin\\*\\Quotas\\MaxMemoryPerShellMB | Select PSPath, Value\r\n\r\nPSPath                                                                           Value\r\n------                                                                           -----\r\nWSMan::localhost\\Plugin\\microsoft.powershell\\Quotas\\MaxMemoryPerShellMB          2147483647\r\nWSMan::localhost\\Plugin\\microsoft.powershell.workflow\\Quotas\\MaxMemoryPerShellMB 2147483647\r\nWSMan::localhost\\Plugin\\microsoft.powershell32\\Quotas\\MaxMemoryPerShellMB        2147483647\r\nWSMan::localhost\\Plugin\\PowerShell.7\\Quotas\\MaxMemoryPerShellMB                  1024\r\nWSMan::localhost\\Plugin\\PowerShell.7.0.0\\Quotas\\MaxMemoryPerShellMB              1024\r\n```\r\n\r\nThis is conform to the file Install-PowerShellRemoting.ps1\r\n\r\n```\r\nPS> Get-Content $PSHome\\Install-PowerShellRemoting.ps1 | Where { $_ -like \"*MaxMemoryPerShellMB*\" -or $_ -like \"*\\Plugin\\*\" }\r\n\r\n$regKey = \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\WSMAN\\Plugin\\$pluginEndpointName\"\r\n    <Quotas IdleTimeoutms=\"7200000\" MaxConcurrentUsers=\"5\" MaxProcessesPerShell=\"15\" MaxMemoryPerShellMB=\"1024\" MaxShellsPerUser=\"25\"\r\n```\r\n",
      "created_at": "2020-04-22T16:27:30Z",
      "updated_at": "2020-04-22T16:27:30Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "Yes, there is a quotas setting for each endpoint (plugin) configured on the target machine.  But there is also a machine wide setting that sets max values allowed for each individual plugin.  In any case the default quota values is unlimited for the latest versions of PowerShell (Windows PowerShell 5.1, PS 6, PS 7).  Earlier versions of PowerShell had arbitrary fixed default values, but this was opened up for later versions.",
      "created_at": "2020-04-22T17:10:30Z",
      "updated_at": "2020-04-22T17:10:30Z"
    },
    {
      "author": "fMichaleczek",
      "author_association": "NONE",
      "body": "@PaulHigin this is my report and test. \r\n\r\n## Protocol\r\n\r\nI use this simple code to reproduce the memory consumption\r\n`1..50|%{$x=1}{[array]$x+=$x}`\r\n\r\nI monitor the memory of the wsmprovhost.exe process\r\n\r\nThe Shell config is default : \r\n```\r\nPS C:\\Windows\\System32> dir WSMan:\\localhost\\Shell\\MaxMemoryPerShellMB\r\n   WSManConfig: Microsoft.WSMan.Management\\WSMan::localhost\\Shell\r\n\r\nType            Name                           SourceOfValue   Value\r\n----            ----                           -------------   -----\r\nSystem.String   MaxMemoryPerShellMB                            2147483647\r\n```\r\n\r\n## PowerShell.7 / MaxMemoryPerShellMB = 1Gb (default)\r\n\r\n\"OperationStopped: Exception of type 'System.OutOfMemoryException' was thrown\"\r\nwsmprovhost.exe consume less than 1Gb\r\n\r\n## PowerShell.7 / MaxMemoryPerShellMB = 4Gb\r\n\r\n\"Array dimensions exceeded supported range.\"\r\nwsmprovhost.exe consume over 3Gb\r\n\r\n## Machine wide setting\r\n\r\nWhen I change the quota, I see this warning : \r\n```\r\nThe updated configuration is effective only if it is less than or equal to the value of global quota WSMan:\\localhost\\Shell\\MaxMemoryPerShellMB. \r\nVerify the value for the global quota using the PowerShell cmdlet \"Get-Item WSMan:\\localhost\\Shell\\MaxMemoryPerShellMB\".\r\n```\r\n\r\n## Windows PowerShell 5.1 default quota\r\n\r\nIn theory and practical, I think there is no quota for Windows PowerShell 5.1 on Win10 Updated and  i found that very very dangerous (i will have to verify default quota on Windows Server...)\r\n",
      "created_at": "2020-04-22T18:13:34Z",
      "updated_at": "2020-04-22T18:13:34Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": ">> In theory and practical, I think there is no quota for Windows PowerShell 5.1 on Win10 Updated and i found that very very dangerous (i will have to verify default quota on Windows Server...)\r\n\r\nThat is only the default setting.  You can set the quotas to whatever makes sense for your needs.",
      "created_at": "2020-04-23T16:02:35Z",
      "updated_at": "2020-04-23T16:02:35Z"
    },
    {
      "author": "fMichaleczek",
      "author_association": "NONE",
      "body": "@PaulHigin @iSazonov\r\n\r\n- I think the PowerShell Comitee will have to examine if we stay like that or if we have to align PowerShell on Windows to Windows PowerShell ?  Introduce an additional step to the PowerShell installer when you choose to enable PSRemoting should be a great idea (to force people to know what they do) but i understand it costs a lot of works.\r\n\r\n- There is also a need to update about_session_configurations for PowerShell 6+ because it give wrong information who apply to Window PowerShell (SessionName = Microsoft.PowerShell).\r\n[about_session_configurations/V7](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_session_configurations?view=powershell-7)\r\n\r\nI dislike the idea to give unlimited memory with a long time out (2h). If you want to reproduce my issue, i give bellow an example who could consume unlimited memory (limited for 3Gb in this example) for 2h on Windows PowerShell. SSH protocol has a KeepAlive mecanism, so it's easy to have a small timeout on openssh-server. PSRemoting over WinRM is a popular thing, I think adding a KeepAlive mecanism on client side, could resolve the issue and doesn't need a change on the protocol.\r\n\r\n## Comparaison PSRemoting\r\n\r\n| Parameters                    | Windows PowerShell over WinRM | PowerShell over WinRM | PowerShell over OpenSSH |\r\n| ----------------------------- | ----------------------------- | --------------------- | ----------------------- |\r\n| IdleTimeoutms                 | 7200000                       | 7200000               | 3000 (1)                |\r\n| MaxConcurrentCommandsPerShell | 2147483647                    | 1000                  | N/A                     |\r\n| MaxConcurrentUsers            | 2147483647                    | 5                     | N/A                     |\r\n| MaxIdleTimeoutms              | 2147483647                    | 43200000              | N/A                     |\r\n| MaxMemoryPerShellMB           | 2147483647                    | 1024                  | N/A                     |\r\n| MaxProcessesPerShell          | 2147483647                    | 15                    | N/A                     |\r\n| MaxShells                     | 2147483647                    | 25                    | N/A                     |\r\n| MaxShellsPerUser              | 2147483647                    | 25                    | N/A                     |\r\n\r\n(1) source : [What is the default idle timeout for OpenSSH?](https://unix.stackexchange.com/questions/150402/what-is-the-default-idle-timeout-for-openssh)\r\n\r\n## Issue with a long time out and unlimited memory\r\n\r\nFrom an admin pwsh.exe :  \r\n```\r\n& {\r\n# start a process of pwsh which connect to Windows PS Endpoint and execute a high memory job\r\n$proc = start pwsh @(\"-noexit\", \"-c\", 'icm -session (nsn localhost -conf Microsoft.PowerShell) { try {1..50|%{$x=1}{[array]$x+=$x}} catch {$_} }') -Win Hidden -Pass\r\n\r\n# wait a little that the invoke command have consume enough memory\r\nsleep -s 60\r\n\r\n# kill the process\r\nkill $proc.ID\r\n\r\n# verify the wsmprovhost memory consumption\r\ngps wsmprovhost | select Name,@{N='WorkingSetInMb';E={[Math]::Round($_.ws/1MB)}}\r\n\r\n}\r\n```\r\n\r\nResult : \r\n```\r\nName        WorkingSetInMb\r\n----        --------------\r\nwsmprovhost           2876\r\n```\r\n\r\nThe memory come back after the WinRM timeout the session (2h).",
      "created_at": "2020-04-23T19:50:27Z",
      "updated_at": "2020-04-23T19:50:27Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": ">  Introduce an additional step to the PowerShell installer when you choose to enable PSRemoting should be a great idea\r\n\r\nI think we should keep Installer simple otherwise it will confuse and annoying users.\r\n\r\n> There is also a need to update about_session_configurations for PowerShell 6+\r\n\r\nPlease open new issue in PowerShell-Docs repo or pull PR there.\r\n\r\nAlso I think we could increase MaxMemoryPerShellMB up to 2 Gb for PowerShell Core - modern computers have usually 2 and more Gb memory. Although it was more correct to make it more frugal.\r\n\r\n\r\n",
      "created_at": "2020-04-24T04:26:18Z",
      "updated_at": "2020-04-24T04:26:18Z"
    },
    {
      "author": "ChrisLynchHPE",
      "author_association": "NONE",
      "body": "I'm closing this issue, as it appears to be related to the DotNet legacy API not handling 2GB or larger objects properly during IO read stream operations, and have since opened a new question (#13721).",
      "created_at": "2020-09-30T20:28:37Z",
      "updated_at": "2020-09-30T20:28:37Z"
    }
  ],
  "created_at": "2020-04-21T21:51:09Z",
  "number": 12423,
  "state": "closed",
  "title": "Attempting to upload large file (>1GB) using HttpWebRequest results in System.OutOfMemoryException within PowerShell 7",
  "updated_at": "2020-09-30T20:28:38Z"
}