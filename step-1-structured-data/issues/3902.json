{
  "_url": "https://github.com/PowerShell/PowerShell/issues/3902",
  "author": "Bluecakes",
  "body": "\r\n<!--\r\n\r\nIf it is a bug report:\r\n- make sure you are able to repro it on the latest released version. \r\nYou can install the latest version from https://github.com/PowerShell/PowerShell/releases\r\n- Search the existing issues.\r\n- Refer to the [FAQ](../docs/FAQ.md).\r\n- Refer to the [known issues](../docs/KNOWNISSUES.md).\r\n- Fill out the following repro template\r\n\r\nIf it's not a bug, please remove the template and elaborate the issue in your own words.\r\n-->\r\n\r\nHey PowerShell extension team,\r\n\r\nThanks so much for the brilliant extension for PowerShell support in Visual Studio Code, i seem to be having a weird error in which the PowerShell Editor Services is trying to access one of the folders under the **$RECYCLE.BIN** folder in my external usb drive (Which being a system folder is denied access to pretty much everyone but the system).\r\n\r\nI am able to reproduce this error on the latest 1.2.0 version of the PowerShell extension, please see the details below and let me know if you'd like any additional info.\r\n\r\nSteps to reproduce\r\n------------------\r\n\r\nI have enabled verbose logging and reproduced the issue a few time to generate some verbose logs, please find those zipped and attached here -> [logs.zip](https://github.com/PowerShell/PowerShell/files/1043277/logs.zip)\r\n\r\n1. Open Visual Studio Code\r\n3. File -> Open Folder -> Select E:\\\r\n3. Create a new document (Ctrl + N)\r\n4. Paste the following code\r\n\r\n```PowerShell\r\n\tforeach ($domain in \"testlab01.contoso.com\", \"testlab02.contoso.com\")\r\n\t{\r\n\t\t$namingContext = $(get-adrootdse -server $domain).defaultnamingcontext\r\n\t\t$computers = Get-ADComputer -Server $domain -Properties lastlogondate, pwdlastset, distinguishedname, operatingsystem, extensionattribute1 -ldapfilter \"(&(!operatingSystem=*server*)(operatingSystem=*))\"\r\n\t\t\r\n\t\t$countdelete = 0\r\n\t\t\r\n\t\tforeach ($Computer in $computers)\r\n\t\t{\r\n\t\t}\r\n\t}\r\n```\r\n\r\n5. Right click on **$computers** and select the **Find All References** option\r\n\r\nIf i close Visual Studio Code completely or press **Ctrl + Shift + P** and choose **Reload Window** and follow the **Steps to reproduce** the terminating error reoccurs.\r\n\r\nOnce the error occurs, all PowerShell extension features stop working (Intellisense, PSScriptAnalyzer etc) until i either reload the window or close and reopen Visual Studio Code.\r\n\r\nIf i continue using Visual Studio Code after the error has occured, about a minute later Visual Studio Code will show an error up the top that says\r\n\r\n```\r\nThe PowerShell session has terminated due to an error, would you like to restart it? Yes No Close\r\n```\r\n\r\nExpected behavior\r\n-----------------\r\nPeek window should come up showing a reference to \"foreach ($computer in $computers)\"\r\n\r\nActual behavior\r\n---------------\r\nPeek window shows up with the text \"Loading\" and never finishes loading\r\nTerminal shows the following error\r\n\r\n```PowerShell\r\nPowerShell Integrated Console\r\n\r\nPS E:\\>\r\n\r\nA terminating error occurred in PowerShell Editor Services:\r\n\r\nOne or more errors occurred.\r\n   at System.Threading.Tasks.Task.ThrowIfExceptional(Boolean includeTaskCanceledExceptions)\r\n   at System.Threading.Tasks.Task.Wait(Int32 millisecondsTimeout, CancellationToken cancellationToken)\r\n   at Microsoft.PowerShell.EditorServices.Protocol.MessageProtocol.ProtocolEndpoint.WaitForExit()\r\n   at CallSite.Target(Closure , CallSite , Object )\r\nOne or more errors occurred.\r\n\r\nAccess to the path 'e:\\$RECYCLE.BIN\\S-1-5-21-1296309925-1638090579-3947801505-1001' is denied.\r\n   at System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath)\r\n   at System.IO.FileSystemEnumerableIterator`1.AddSearchableDirsToStack(SearchData localSearchData)\r\n   at System.IO.FileSystemEnumerableIterator`1.MoveNext()\r\n   at Microsoft.PowerShell.EditorServices.Workspace.<EnumeratePSFiles>d__14.MoveNext()\r\n   at Microsoft.PowerShell.EditorServices.LanguageService.<FindReferencesOfSymbol>d__15.MoveNext()\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at Microsoft.PowerShell.EditorServices.Protocol.Server.LanguageServer.<HandleReferencesRequest>d__31.MoveNext()\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at Microsoft.PowerShell.EditorServices.Protocol.MessageProtocol.MessageDispatcher.<DispatchMessage>d__6.MoveNext()\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at Microsoft.PowerShell.EditorServices.Protocol.MessageProtocol.ProtocolEndpoint.<ListenForMessages>d__47.MoveNext()\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at Microsoft.PowerShell.EditorServices.Utility.AsyncContext.Start(Func`1 asyncMainFunc)\r\n   at System.Threading.Tasks.Task.Execute()\r\n```\r\n\r\nEnvironment data\r\n----------------\r\n\r\nVisual Studio Code 1.12.2\r\nShell 1.6.6\r\nRenderer 56.0.2924.87\r\nNode 7.4.0\r\n\r\nExtensions\r\nAuto Fold 1.0.6\r\nC# 1.10.0\r\nC# XML Documentation Comments 0.0.15\r\nGit History 0.2.0\r\nPowerShell 1.2.0\r\nVSCode Simpler icons with Angular 1.3.0\r\n\r\nPowershell PSVersionTable output\r\n\r\n```PowerShell\r\nPS E:\\> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.14393.1198\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.14393.1198\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\n\r\n\r\nPS E:\\>\r\n```\r\n",
  "closed_at": "2017-06-01T03:14:51Z",
  "comments": [
    {
      "author": "Bluecakes",
      "author_association": "NONE",
      "body": "I just noticed that i may have submitted this issue in the wrong area of PowerShell on GitHub, i've resubmitted the issue on the **vscode-powershell** GitHub, please feel free to close this issue if it is not relevant to this forum.\r\n\r\n[Issue on vscode-powershell](https://github.com/PowerShell/vscode-powershell/issues/813)",
      "created_at": "2017-06-01T03:04:27Z",
      "updated_at": "2017-06-01T03:04:27Z"
    },
    {
      "author": "daviwil",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks!  I'll close this one since you filed the other in the right place :)",
      "created_at": "2017-06-01T03:14:51Z",
      "updated_at": "2017-06-01T03:14:51Z"
    }
  ],
  "created_at": "2017-06-01T00:24:06Z",
  "number": 3902,
  "state": "closed",
  "title": "PowerShell Editor Services terminating error trying to access external USB recycle bin",
  "updated_at": "2017-06-01T03:36:07Z"
}