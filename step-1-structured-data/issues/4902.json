{
  "_url": "https://github.com/PowerShell/PowerShell/issues/4902",
  "author": "daxian-dbw",
  "body": "Update build and package scripts to create portable Linux packages.\r\nFix the second task of #3961\r\n- [x] Update packaging script to package native binaries published and remove unneeded dependencies\r\n\r\nHelp Needed\r\n--------------\r\n**I need help from the team to verify the single DEB/RPM package on different distros.**\r\n\r\nBackground Information\r\n--------------------\r\n- \"RID `Linux-x64` isn't any different from `Ubuntu.16.04-x64`. The change we've made to enable the portable Linux-x64 rid was that we dynamically load OpenSSL and ICU libraries at runtime and we can also handle few missing APIs in various versions of CURL, so we can handle subtle differences between the distros. We don't build any distro specific binaries, so the `dotnet publish` publishes the same files when using those 2 RIDs respectively.\" See https://github.com/PowerShell/PowerShell/issues/3961#issuecomment-330796735\r\n\r\n- \"if you build the libpsl-native.so on CentOS 7, then it should be as portable as the dotnet stuff (we build it on CentOS 7 to ensure that it doesn't depend on newer glibc).\" See https://github.com/PowerShell/PowerShell/issues/3961#issuecomment-331009082\r\n\r\nTherefore, we need to use the `Linux-x64` `libpsl-native.so` built on CentOS 7 for all Linux distros. The way to do that is to create nuget package for `libpsl` and consume it from our build.\r\n\r\nNative Dependencies of `dotnet-runtime-2.0.0` packages\r\n--------------------------------------------------------------\r\nThe dependencies below were got by inspecting the `dotnet-runtime-2.0.0` packages (You can get those packages from https://www.microsoft.com/net/download/linux).\r\n### DEB\r\n- Ubuntu 16.04 depends\r\n   - libc6, libcurl3, libgcc1, libgssapi-krb5-2, liblttng-ust0, libstdc++6, libunwind8, libuuid1, zlib1g, libssl1.0.0, libicu55\r\n- Ubuntu 14.04 depends\r\n   - libc6, libcurl3, libgcc1, libgssapi-krb5-2, liblttng-ust0, libstdc++6, libunwind8, libuuid1, zlib1g, libssl1.0.0, libicu52\r\n- Ubuntu 17.04 depends\r\n   - libc6, libcurl3, libgcc1, libgssapi-krb5-2, liblttng-ust0, libstdc++6, libunwind8, libuuid1, zlib1g, libssl1.0.0, libicu57\r\n- Debian-stretch (9) depends\r\n   - libc6, libcurl3, libgcc1, libgssapi-krb5-2, liblttng-ust0, libstdc++6, libunwind8, libuuid1, zlib1g, libssl1.0.2, libicu57\r\n- Debian-jessie (8) depends\r\n   - libc6, libcurl3, libgcc1, libgssapi-krb5-2, liblttng-ust0, libstdc++6, libunwind8, libuuid1, zlib1g, libssl1.0.0, libicu52\r\n\r\n### RPM\r\n- CentOS 7/Oracle Linux 7/openSUSE depend\r\n   - openssl-libs, libcurl\r\n   - However, when installing `dotnet-sdk-2.0.0`, two more packages are required to be manually installed: libunwind, libicu.\r\n- Fedora 26\r\n   - openssl-libs, libcurl\r\n   - However, when installing `dotnet-sdk-2.0.0`, three more packages are required to be manually installed: libunwind, libicu, compat-openssl10\r\n\r\nAs shown above:\r\nThe only difference in DEB world is libicu (libicu52, libicu55, libicu57).\r\nThe only difference in RPM world is that Fedora needs `compat-openssl10` (see https://www.microsoft.com/net/core#linuxfedora). **`compat-openssl10` might be required only for dotnet-sdk toolings, but I'm not sure.**\r\n\r\nMajor Changes\r\n-----------------\r\n- Move the Unix native component build out of `Start-PSBuild` to `Start-BuildNativeUnixBinaries`\r\n- Pack `libps1-native` into a nuget package `libpsl`. It includes binaries for `linux-x64`, `linux-arm` and `osx`. **NOTE:** the `linux-x64` version `libps1-native.so` is built on CentOS 7.\r\n- Update the package script to use the correct dependencies and also use names for .deb and .rpm names.\r\n   - **NOTE1:** for DEB, since `libicu` is different on different distros, I decided to use `libicu-dev` which will pull in the correct packages for `libicu` for different distros.\r\n   - **NOTE2:** for RPM, since `compat-openssl10` is only available to Fedora, I don't include it in the dependencies. We can do the same as .NET Core (https://www.microsoft.com/net/core#linuxfedora), asking Fedora users to install `compat-openssl10` manually.\r\n   - **NOTE3:** the updated package names are: `powershell_6.0.0-beta.20_amd64.deb` and `powershell-6.0.0_beta.22-1.rhel.7.x86_64.rpm`. I use `rhel.7` because dotnet-runtime-2.0.0 use it in the name `dotnet-runtime-2.0.0-rhel.7-x64.rpm`.\r\n\r\nDistros that I have verified\r\n-----------------------------\r\n1. DEB package built from Ubuntu.16.04\r\n    - Works on Ubuntu.16.04 and Ubuntu.14.04\r\n    - Haven't tried on Ubuntu.17.04, Debian 8 and Debian 9\r\n2. RPM package built from CentOS 7\r\n    - Works on CentOS7, openSUSE.42.2\r\n       - **Attention:** installing RPM on openSUSE has the same issue as `dotnet-runtime-2.0.0` package. It's quoted below from https://www.microsoft.com/net/core#linuxopensuse.\r\n       - Haven't tried on other RedHat distros\r\n> \"Note: When installing the SDK, SUSE and OpenSUSE may report that nothing provides libcurl. libcurl should already be installed on supported versions of both distros. Run zypper search libcurl to confirm. The error will present 2 'solutions'. Choose 'Solution 2' to continue installing .NET Core.\" \r\n",
  "closed_at": "2017-09-25T19:49:43Z",
  "comments": [
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@adityapatwardhan  Can you review?",
      "created_at": "2017-09-25T17:47:31Z",
      "updated_at": "2017-09-25T17:47:31Z"
    }
  ],
  "created_at": "2017-09-22T23:56:29Z",
  "number": 4902,
  "state": "closed",
  "title": "Create generic Linux-x64 packages that are portable to all supported Linux distros",
  "updated_at": "2017-09-25T21:20:25Z"
}