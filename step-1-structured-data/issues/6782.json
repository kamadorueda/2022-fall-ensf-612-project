{
  "_url": "https://github.com/PowerShell/PowerShell/issues/6782",
  "author": "markekraus",
  "body": "## PR Summary\r\n\r\n* fixes  #6780\r\n* When `-Form` is used, the field names and the filename value will be enclosed in quotes\r\n* fixes multipart/form-data submission issues with some APIs\r\n* brings functionality closer to modern browsers and curl\r\n\r\nSince `-Form` has not been released in an actual release version, this is not a breaking change. \r\n\r\nThere is no decent way to test this as the metadata for text fields is lost when the form is processed in ASP.NET.  Only way would be to return the raw request body and parse it with regex.\r\n\r\n## PR Checklist\r\n\r\n- [X] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [X] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [X] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [X] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [X] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` to the beginning of the title and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [X] Not Applicable\r\n    - **OR**\r\n    - [ ] User-facing [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed - Issue link:\r\n- **Testing - New and feature**\r\n    - [X] Not Applicable or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [X] [Add `[feature]` if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n",
  "closed_at": "2018-05-08T04:18:10Z",
  "comments": [
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Should we open an issue against corefx?  If corefx supports/fixes this in the future, will we have double quotes?",
      "created_at": "2018-05-01T00:06:02Z",
      "updated_at": "2018-05-01T00:06:02Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "At this point it would be a breaking change in CoreFX. This is the same behavior for `System.Net.Http.MultipartFormDataContent` in .NET Framework 4.5 when it was added. I found a [blog article form 2013](https://blog.xdumaine.com/uploading-a-photo-as-multipart-form-data-in-c/) that references this issue.  If they did add this, they would probably do so through a new property in which case we wouldn't be broken.",
      "created_at": "2018-05-01T00:33:36Z",
      "updated_at": "2018-05-01T00:33:36Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "I found this https://github.com/dotnet/corefx/issues/26886#issuecomment-381697212 though, this begs the question why every browser and curl wraps the name and filename fields values in quotes and .NET does not?",
      "created_at": "2018-05-01T00:38:29Z",
      "updated_at": "2018-05-01T00:38:29Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Seems it is important fix so we need to add tests. Maybe use output with `-WhatIf`?",
      "created_at": "2018-05-01T19:09:11Z",
      "updated_at": "2018-05-01T19:09:11Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov if you can, please provide a code example... otherwise I have no clue what you are suggesting :)\r\n\r\nSince the request output is generated inside the HttpClient code, we can't really access it. Only way I can think of would be to echo the raw response back from WebListener and regex for the fields and quotes. That or create a special endpoint on WebListener and do the regex there. If you try to process the request in ASP.NET as a form, you lose the content disposition headers which is where this is stored.\r\n\r\nI'm not sure this warrants the level of effort and code it would take to make a meaningful test for it.",
      "created_at": "2018-05-01T19:21:21Z",
      "updated_at": "2018-05-01T19:21:21Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I believe we should have tests for the uploading.\r\nI assumed that we could do verbose output of the form but seems it is impossible. So we need full feature tests. Perhaps @JamesWTruher and @adityapatwardhan have ideas about this tests.",
      "created_at": "2018-05-01T19:51:16Z",
      "updated_at": "2018-05-01T19:51:16Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@markekraus I think it would be ok to add a test to weblistener to specifically return the field names and values as raw text.  Since the values are controlled by the Pester test, it should know exactly what should be returned without having to resort to regex",
      "created_at": "2018-05-01T20:26:24Z",
      "updated_at": "2018-05-01T20:26:24Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@SteveL-MSFT The problem is the ASP.NET does not provide whether or not the feild names are quoted when you consume the response as a form. The only way to test that is to echo back the raw HTTP request as a string.",
      "created_at": "2018-05-01T20:34:57Z",
      "updated_at": "2018-05-01T20:34:57Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@markekraus I see, so you either get just the name value pairs stripped of the quotes or the entire raw request.  It seems the risk is low and the cost is high.  I would be fine creating a new issue to add such a test in the future, particularly if it's useful beyond this specific issue.",
      "created_at": "2018-05-02T00:31:04Z",
      "updated_at": "2018-05-02T00:31:04Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "Added #6794 to track possible adding an echo controller to WebListener.",
      "created_at": "2018-05-02T08:19:57Z",
      "updated_at": "2018-05-02T08:19:57Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": ">the cost is high\r\n\r\n@markekraus implemented WebListener  so fast that I'm still amazed :-)",
      "created_at": "2018-05-02T12:52:33Z",
      "updated_at": "2018-05-02T12:52:33Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@daxian-dbw Do you agree that we use the `$\"\"` string interpolation? Usually we use formatting with explicit culture.",
      "created_at": "2018-05-02T12:56:06Z",
      "updated_at": "2018-05-02T12:58:10Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "I don't have a strong opinion. I don't want to block people from using C# language features :)\r\nWhen converting an interpolated string to a string instance, the current culture is used, which seems fine in this change. But be careful if you want a culture-invariant string.",
      "created_at": "2018-05-02T17:49:40Z",
      "updated_at": "2018-05-02T17:49:40Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@daxian-dbw Thanks!\r\n\r\n@markekraus [ConvertTo\\<T\\>](https://github.com/PowerShell/PowerShell/blob/da40c6efb787c7800103d02dae0b768d51032d9b/src/System.Management.Automation/engine/LanguagePrimitives.cs#L1654) uses InvariantCulture. I believe we should keep consistency.",
      "created_at": "2018-05-02T18:06:33Z",
      "updated_at": "2018-05-02T18:06:33Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "Yea. I'm not married to any particular string formater or interpolation method. So, whatever works best. `String.Format(CultureInfo.InvariantCulture, \"\\\"{0}\\\"\", ...)`?",
      "created_at": "2018-05-02T18:11:43Z",
      "updated_at": "2018-05-02T18:11:43Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "We could\r\n```c#\r\n = \"\\\"\" + ... + \"\\\"\";\r\n```",
      "created_at": "2018-05-02T18:31:15Z",
      "updated_at": "2018-05-02T18:31:15Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Sorry for wrong close.",
      "created_at": "2018-05-02T18:32:19Z",
      "updated_at": "2018-05-02T18:32:19Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "You can also choose culture with the string interpolation:\r\n```c#\r\nFormattableString message = $\"The speed of light is {speedOfLight:N3} km/s.\";\r\nstring messageInInvariantCulture = FormattableString.Invariant(message);\r\n```\r\nSee https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/tokens/interpolated",
      "created_at": "2018-05-02T18:33:17Z",
      "updated_at": "2018-05-02T18:33:17Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I think that the double formatting superfluous here. \r\nConcatenating enough.\r\nOr we could use `String.Create()` from .Net Core 2.1 (later).",
      "created_at": "2018-05-02T18:49:14Z",
      "updated_at": "2018-05-02T18:49:14Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov Does the culture on these even matter? I'm not doing any format transformations, I'm just shoving one string inside another. ",
      "created_at": "2018-05-02T19:26:56Z",
      "updated_at": "2018-05-02T19:26:56Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I remember that we have already corrected misuses of culture in formatting. So I'm trying to be careful here. \r\nIf culture is not important here, we should not use this pattern at all.\r\nNow we have already merged #6718 and can use .Net Core 2.1 features - it is very optimized for string manipulations. \r\nI believe here we could use `String.Create()`. Samples: \r\nhttps://msdn.microsoft.com/en-us/magazine/mt814808.aspx\r\nhttp://source.dot.net/#System.Private.Uri/System/Uri.cs,1412\r\n\r\n",
      "created_at": "2018-05-03T04:26:11Z",
      "updated_at": "2018-05-03T04:26:11Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov I'm saying that I believe the culture isn't important here because they are already strings when being interpolated and I am not performing any transformations on it. What I understand happens here is is `myString.ToString(CultureInfo.CurrentCulture)` That does nothing on a string because it is already a string. It would only affect it if it was some other kind of object or if we were performing a formatting operation on that string. I'm not aware of any instance where it would actually change anything in the string. it's not going to strip or change foreign culture characters.\r\n\r\nSo I'm asking.. does it even matter here? as far as I can tell, what ever string interpolation, concatenation, creation, and building method would all produce the same strings in the end because we are just dealing with combining strings and not doing any formatting or transformations (those are already done by `ConvertTo<String>()` before the interpolation).\r\n\r\nhttps://docs.microsoft.com/en-us/dotnet/api/system.string.tostring?view=netcore-2.0#System_String_ToString_System_IFormatProvider_ :\r\n\r\n> Returns this instance of String; no actual conversion is performed.",
      "created_at": "2018-05-03T09:14:47Z",
      "updated_at": "2018-05-03T09:14:47Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": ">So I'm asking.. does it even matter here?\r\n\r\nNo. The discussion is about _code style_. Bad style is a open door for camouflaged bugs. Therefore, we require explicit curly braces in the `if` and explicit culture in formattings - after fixing and discussing the latter we even added manuals to our documentation #4983 \r\nHere I wanted to understand whether we can use `$\"\"` and now believe that we should not use this.",
      "created_at": "2018-05-03T09:53:04Z",
      "updated_at": "2018-05-03T09:53:04Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "... why is this bad style? what is wrong with `$\"\"`?  I really don't understand what your objecttion is. You don't like it?",
      "created_at": "2018-05-03T10:00:46Z",
      "updated_at": "2018-05-03T10:00:46Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov Also, I cannot figure out how you intend to use String.Create() here. Can you provide me with an example relevant to this PR? It seems like it is overkill for string concatenation.",
      "created_at": "2018-05-03T10:17:58Z",
      "updated_at": "2018-05-03T10:17:58Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I am very sorry for noisy. We had culture related bugs in string operations.\r\nYou can see that we have special helper methods in [StringUtil.cs](https://github.com/PowerShell/PowerShell/blob/master/src/System.Management.Automation/utils/StringUtil.cs#L17) to follow a good style. I believe we should use the best practise. \r\nYour code works right (I hope :-) ) but somebody can use the pattern latter in another place _mistakenly_.\r\n\r\n>Also, I cannot figure out how you intend to use String.Create() here.\r\n\r\nYou could ignore this today. I hope we'll do code cleanups to reduce allocations and use the pattern too.",
      "created_at": "2018-05-03T10:18:29Z",
      "updated_at": "2018-05-03T10:20:23Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "ok.. so `$\"\"` is banned even when used properly? So what is the best way to concat strings in this project then? using `+` has a perf hit so that's out. `String.Concat()` is in the same boat and needs multiple calls. `String.Create()` is confusing (seriously.. what is a `TState`? why is that not documented anywhere? how exactly would you even use this to concat string?) In this case, `String.Format()` and `$\"\"` are identical. I could use `String.Format()` with the explicit formatter, but that seems really verbose for just enclosing a string in quotes.",
      "created_at": "2018-05-03T10:25:47Z",
      "updated_at": "2018-05-03T10:25:47Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": ">ok.. so $\"\" is banned even when used properly?\r\n\r\nIf other maintainers agree that we should always use _explicit_ culture then yes.\r\n\r\nPreviously we use + for concatinations for few arguments (~< 5). Othervise StringBuilder is preferable.\r\nCurrently we can and should use .Net Core 2.1 and C# 7.2 features to decrease allocations.\r\nNow we can use `ValueStringBuilder`, `String.Create()`, Span<T> and many new string method overloads.\r\n\r\nIn the case I'd use `String.Create()`. Although you can ignore it now and use +.\r\nSample:\r\n```c#\r\n            var name = LanguagePrimitives.ConvertTo<String>(fieldName);\r\n            contentDisposition.Name = String.Create(2+name.Length, name, (Span<char> destination, string str) =>\r\n            {\r\n                destination[0] = '\"';\r\n                str.AsSpan().CopyTo(destination.Slice(1));\r\n                destination[destination.Length-1] = '\"';\r\n            });\r\n```",
      "created_at": "2018-05-03T11:36:35Z",
      "updated_at": "2018-05-03T11:36:35Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "> If other maintainers agree that we should always use explicit culture then yes.\r\n\r\nWhy? Why always use explicit culture? String concatenation does not require it. It _is_ relvant when doing formatting or transformations, but just combining strings it's senseless.\r\n\r\n> Previously we use + for concatinations for few arguments (~< 5). \r\n\r\nIf this will unblock this PR so it will be merged, I will change it to use `+`. I still challenge the logic behind this debate.\r\n\r\n> In the case I'd use String.Create(). \r\n\r\nWhy? That is a seriously over-complicated verbose and tough to follow piece code just to put `\"` around a string. I get it if we were working with concatenating some large strings or this code was being called so many times that performance really matters. but this is a fairly esoteric feature that wont be used often or heavily and it's more important the the code be readable here than to squeeze every ounce of performance out of it.\r\n\r\n",
      "created_at": "2018-05-03T11:47:57Z",
      "updated_at": "2018-05-03T11:47:57Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> this is a fairly esoteric feature that wont be used often or heavily\r\n\r\nWe never know exactly what users will do.",
      "created_at": "2018-05-03T12:12:42Z",
      "updated_at": "2018-05-03T12:12:42Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "> We never know exactly what users will do.\r\n\r\nWe do know that this is a form submission style that is not as widely adopted as standard forms. We do know that the intended purpose of this submission method is GUI browser based communications. We do know that some APIs do use this for file uploads, but not all. We do know that while there have been asks for this feature to be added, not many. \r\n\r\nIf I didn't have my own personal need for it, it may never have even entered consideration to be adopted in the web cmdlets.\r\n\r\nYes, we are not clairvoyant and we cannot know 100% what users will do, but, let's be realistic here: the string concatenation for quoting field names filename values and of this feature is NEVER going to be a performance concern. Especially when it is already associated with slow, long running, and memory intense tasks (uploading data). The few fractions of a millisecond shaved off and memory usage saved by using `String.Create()` here is severely outweighed by a multitude of other critical performance losses happening at the same time in the same feature.\r\n\r\nWhat I do know for certain is that I will have to look at this code in the future. And very likely, someone else will too. I do know that String.Create() is complex and not easy to read. I do know that I can skim the `$\"\"` method and see very quickly what is being done. I do know that It takes me a few seconds to figure out that the code you provided is just wrapping a string in quotes.\r\n\r\nIf you want to add a string concatenation utility method that allows us to abstract `String.Create()` throughout the project, I would consider using that. But I don't see the need to add such a thing directly in the web cmdlets. I also don't see any benefit at all in using direct `String.Create()` calls here either.",
      "created_at": "2018-05-03T12:39:54Z",
      "updated_at": "2018-05-03T12:39:54Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Forget about `String.Create()` - you could use `String.Concat()` or +.\r\n\r\n>I do know that I can skim the $\"\" method and see very quickly what is being done. I do know that It takes me a few seconds to figure out that the code you provided is just wrapping a string in quotes.\r\n\r\nThis is not obviously for code reviewer. My first impression was that it evidently. Then there were questions. Why we use formatting if we need quoting? Why we use `InvariantCulture` in `ConvertTo` and `CurrentCulture` in `$\"\"`? What's the trick? Should we worry about allocations? - we just had a discussion that PowerShell sometimes consumes too much resources and we should be more thrifty. As a result, we received a good exchange of views. It was useful for me to know your point of view.\r\n\r\nSumming up this discussion I think `String.Concat()` will be the best pattern here.\r\n",
      "created_at": "2018-05-03T14:02:05Z",
      "updated_at": "2018-05-03T14:02:05Z"
    },
    {
      "author": "rkeithhill",
      "author_association": "COLLABORATOR",
      "body": "In this case, the compiler will translate the `+` concatenated strings to a call to `String.Concat()`:\r\n\r\n![image](https://user-images.githubusercontent.com/5177512/39581608-3354927c-4ea9-11e8-9d5f-5c5f5772a018.png)\r\n",
      "created_at": "2018-05-03T14:09:38Z",
      "updated_at": "2018-05-03T14:09:50Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@rkeithhill What plugin you use in VS Code to see IL? ",
      "created_at": "2018-05-03T14:18:19Z",
      "updated_at": "2018-05-03T14:18:57Z"
    },
    {
      "author": "rkeithhill",
      "author_association": "COLLABORATOR",
      "body": "I use JetBrains' dotPeek.  Since `String.Concat()` has an overload that takes `params string[]`, I assume it take as many as you supply it.  But I haven't tested that. Here it is with 8 concats:\r\n![image](https://user-images.githubusercontent.com/5177512/39582645-9f3519ba-4eab-11e8-85cd-c35e4eea37ba.png)\r\nBTW the compiler is smart about concatenating string literals:\r\n![image](https://user-images.githubusercontent.com/5177512/39582764-e492bd0a-4eab-11e8-98e5-e0960f61f036.png)\r\n",
      "created_at": "2018-05-03T14:26:21Z",
      "updated_at": "2018-05-03T14:33:42Z"
    },
    {
      "author": "rkeithhill",
      "author_association": "COLLABORATOR",
      "body": "It would be much appreciated if this PR makes it in for Preview3.  Just sayin'.  :-)",
      "created_at": "2018-05-04T20:37:31Z",
      "updated_at": "2018-05-04T20:37:31Z"
    }
  ],
  "created_at": "2018-04-30T23:42:05Z",
  "number": 6782,
  "state": "closed",
  "title": "Quote Multipart/Form-Data Field Names",
  "updated_at": "2018-05-08T04:18:10Z"
}