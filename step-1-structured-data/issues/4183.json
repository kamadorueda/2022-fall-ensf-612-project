{
  "_url": "https://github.com/PowerShell/PowerShell/issues/4183",
  "author": "pldmgg",
  "body": "Steps to reproduce\r\n------------------\r\n\r\nInstall PowerShell Core 6 Beta 3 on a Debian 8 machine:\r\n\r\n```\r\ncurl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -\r\ncurl https://packages.microsoft.com/config/ubuntu/14.04/prod.list | sudo tee /etc/apt/sources.list.d/microsoft.list\r\nsudo apt-get update\r\nsudo apt-get install -y powershell\r\n```\r\n\r\nInstall OpenSSH-Win64 0.0.17.0 and PowerShell 6 Beta 3 on Windows Server 2016 or Windows Server 2012 R2 using the following install function:\r\n\r\nhttps://github.com/pldmgg/misc-powershell/blob/master/MyFunctions/Install-WinSSH.ps1\r\n\r\n```\r\nInstall-WinSSH -NewSSHKeyName \"testadmin-to-Debian8Jessie\" -NewSSHKeyPurpose \"testadmin-to-Debian8Jessie\" -SetupPowerShell6\r\n```\r\n\r\n(Probably not necessary in order to recreate, but for the sake of completely recreating environment...)\r\nAdd $HOME\\\\.ssh\\testadmin-to-Debian8Jessie.pub to ~/.ssh/authorized_keys on Debian8Jessie machine.\r\n\r\nSSH from Debian8Jessie to Windows 2012R2 or Windows 2016 to make sure ssh works and update ~/.ssh/known_hosts:\r\n\r\n(NOTE: \"testadmin\" is a Domain Admin account on the test2.lab domain)\r\n\r\n```\r\npdadmin@Debian8Jessie:~/.ssh$ ssh testadmin@Win12ws.test2.lab\r\nThe authenticity of host 'win12ws.test2.lab (192.168.2.145)' can't be established.\r\nECDSA key fingerprint is [sic].\r\nAre you sure you want to continue connecting (yes/no)? yes\r\nWarning: Permanently added 'win12ws.test2.lab,192.168.2.145' (ECDSA) to the list of known hosts.\r\ntestadmin@win12ws.test2.lab's password:\r\nMicrosoft Windows [Version 6.3.9600]\r\n(c) 2013 Microsoft Corporation. All rights reserved.\r\nClink v0.4.8 [git:d565ad] Copyright (c) 2012-2016 Martin Ridgers\r\nhttp://mridgers.github.io/clink\r\n\r\n\r\ntestadmin@WIN12WS C:\\Users\\testadmin>exit\r\nConnection to win12ws.test2.lab closed.\r\n```\r\n\r\nStart PowerShell on the Debian8Jessie machine and attempt to use either New-PSSession or Enter-PSSession:\r\n\r\n```\r\npdadmin@Debian8Jessie:~/.ssh$ powershell\r\nPowerShell v6.0.0-beta.3\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nPS /home/pdadmin/.ssh> Enter-PSSession -HostName Win12WS.test2.lab -UserName testadmin -Debug\r\ntestadmin@win12ws.test2.lab's password:\r\nEnter-PSSession : The background process reported an error with the following message: The SSH client\r\nsession has ended with error message: Write failed: Broken pipe.\r\nAt line:1 char:1\r\n+ Enter-PSSession -HostName Win12WS.test2.lab -UserName testadmin -Debu ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ResourceUnavailable: (:) [Enter-PSSession], PSRemotingTransportExceptio\r\n   n\r\n    + FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,\r\n   Microsoft.PowerShell.Commands.EnterPSSessionCommand\r\n```\r\n\r\n\r\nExpected behavior\r\n-----------------\r\n\r\nActually create New-PSSession or actually Enter-PSSession on Windows 2016 / 2012R2 host.\r\n\r\nActual behavior\r\n---------------\r\n\r\nSee above error message regarding \"Broken pipe\"\r\n\r\nEnvironment data\r\n----------------\r\n\r\nNOTE: Both PowerShell 5.1 and PowerShell Core 6 Beta 3 are installed on Windows host (same for Windows 2016 and Windows 2012 R2):\r\n\r\nWindows 2012 R2 PS 5.1 PSVersionTable...\r\n\r\n```\r\nPS C:\\Users\\testadmin> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.14409.1005\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.14409.1005\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\n\r\n```\r\n\r\nWindows 2012 R2 PS Core 6 Beta 3 PSVersionTable...\r\n\r\n```\r\nPS C:\\Users\\testadmin> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.0.0-beta\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.0-beta.3\r\nOS                             Microsoft Windows 10.0.14393\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\nWindows 2016 PS 5.1 PSVersionTable...\r\n\r\n```\r\nPS C:\\Users\\testadmin> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.14393.1358\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.14393.1358\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\n```\r\n\r\nWindows 2016 PS Core 6 Beta 3 PSVersionTable...\r\n\r\n```\r\nPS C:\\Users\\testadmin> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.0.0-beta\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.0-beta.3\r\nOS                             Microsoft Windows 10.0.14393\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\nDebian8Jessie PS Core 6 Beta 3 PSVersionTable...\r\n\r\n```\r\nPS /home/pdadmin/.ssh> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.0.0-beta\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.0-beta.3\r\nOS                             Linux 3.16.0-4-amd64 #1 SMP Debian 3.16.43-2+deb8u1 (2017-06-18)\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\nOther Notes\r\n----------------\r\nThe only scenario in which New/Enter-PSSession throws this \"Broken pipe\" error is Debian -> Windows. Every other scenario works fine (i.e. Windows -> Windows, Windows -> Debian, Debian -> Debian)",
  "closed_at": "2017-07-04T14:01:41Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Please check your steps with https://github.com/PowerShell/PowerShell/tree/master/demos/SSHRemoting",
      "created_at": "2017-07-04T12:33:00Z",
      "updated_at": "2017-07-04T12:33:00Z"
    },
    {
      "author": "pldmgg",
      "author_association": "NONE",
      "body": "@iSazonov - \r\n\r\nI triple checked those steps. No configuration errors that I can see.\r\n\r\nHere are my sshd_config files in case it helps diagnosis -\r\n\r\nFrom Windows 2016 and/or Windows 2012R2 machines:\r\n\r\nhttps://gist.github.com/pldmgg/7707298f38201c2c42e151c5d9541f9d\r\n\r\nFrom Debian 8 Jessie machine:\r\n\r\nhttps://gist.github.com/pldmgg/2270053fb3487c35c1bb12f75797f217",
      "created_at": "2017-07-04T13:12:55Z",
      "updated_at": "2017-07-04T13:13:27Z"
    },
    {
      "author": "pldmgg",
      "author_association": "NONE",
      "body": "Found the issue in my Windows 2016 / 2012 R2 sshd_config\r\n\r\nThe Subsystem entry was referencing the wrong version (i.e. 5.1) of PowerShell. So I changed...\r\n\r\n```\r\nSubsystem\tpowershell\tpowershell -sshd -NoLogo -NoProfile\r\n```\r\n\r\n...to...\r\n\r\n```\r\nSubsystem       powershell      C:/Program Files/PowerShell/6.0.0-beta.3/powershell.exe -sshs -NoLogo -NoProfile\r\n```",
      "created_at": "2017-07-04T14:01:32Z",
      "updated_at": "2017-07-04T14:01:32Z"
    }
  ],
  "created_at": "2017-07-04T11:09:39Z",
  "number": 4183,
  "state": "closed",
  "title": "New/Enter-PSSession from Debian 8 Jessie using PS Core 6 Beta 3 to Win Server 2016 / Win Server 2012 R2 SSH Error -  Write failed: Broken pipe.",
  "updated_at": "2017-07-04T14:10:02Z"
}