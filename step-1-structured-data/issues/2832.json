{
  "_url": "https://github.com/PowerShell/PowerShell/issues/2832",
  "author": "nadiasvertex",
  "body": "Also, add ubuntu-16.10-x64 to the list of architectures to build for.",
  "closed_at": "2016-12-28T21:59:52Z",
  "comments": [
    {
      "author": "msftclas",
      "author_association": "NONE",
      "body": "Hi __@nadiasvertex__, I'm your friendly neighborhood Microsoft Pull Request Bot (You can call me MSBOT). Thanks for your contribution!\r\n    <span>\r\n        In order for us to evaluate and accept your PR, we ask that you sign a contribution license agreement. It's all electronic and will take just minutes. I promise there's no faxing. https://cla.microsoft.com.\r\n    </span>\r\n\r\nTTYL, MSBOT;\r\n",
      "created_at": "2016-12-02T00:34:32Z",
      "updated_at": "2016-12-02T00:34:32Z"
    },
    {
      "author": "nadiasvertex",
      "author_association": "CONTRIBUTOR",
      "body": "That sounds great. I will make th or changes.\n\nOn Mon, Dec 5, 2016, 2:05 PM Sergei Vorobev <notifications@github.com>\nwrote:\n\n> *@vors* commented on this pull request.\n> ------------------------------\n>\n> In build.sh <https://github.com/PowerShell/PowerShell/pull/2832>:\n>\n> >\n>  if hash powershell 2>/dev/null; then\n>      echo 'Continuing with `powershell -noprofile -c Start-PSBuild`'\n>      powershell -noprofile -c \"Import-Module ./build.psm1; Start-PSBuild\"\n>  else\n> -    echo 'No `powershell`, see docs/building/linux.md or macos.md to build PowerShell!'\n> +   echo 'Continuing with full manual build'\n> +   ./build-from-scratch.sh\n>\n> You right, it's silly.\n> I was thinking we are using this script for the CI build and didn't want\n> to complicate the CI troubleshooting.\n> But turns out that script is not used and purely for the convenience here.\n>\n> Please, ignore my comment about the separating logic into a different\n> file: since we call it anyway, there is no need to do it. Sorry for going\n> back and forth on it.\n>\n> Couple more things:\n>\n>    - build.sh will never be as fully-featured as build.psm1 file. I.e.\n>    build.psm1 can find dotnet, if it's not in the path, can run dotnet\n>    build or dotnet publish, etc. I think it's better to avoid duplicating\n>    all such logic and use build.sh precisely for the bootstrapping on the\n>    new platforms. If we agree about this purpose, then my suggestion would be\n>    to replace\n>\n> pushd src/powershell-unix\n> dotnet build --configuration Linux\n> popd\n>\n> by\n>\n> dotnet publish --configuration Linux ./src/powershell-unix/ --output bin\n>\n> And add an echo message about the build location, something like You can\n> run powershell from bin/.\n>\n>    1. publish will create a self-contained build of powershell.\n>    2. Putting it in bin/ will allow to avoid complicated logic about\n>    figuring out where the build was made\n>    3. this version could be used for the build with .psm1 and would not\n>    interfere with the standard location (avoid \"file in use\" problem).\n>\n>\n>    - build.sh doesn't perform analog of Restore-PSModule (adding PS\n>    modules from myget and psgallery). It's worth to have a message with this\n>    information at the end of the build to avoid confusion.\n>\n> \u2014\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/PowerShell/PowerShell/pull/2832>, or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/AB8JvCcph1OdwgySUuL4jaQkQbE6FVSyks5rFGB3gaJpZM4LCEBA>\n> .\n>\n",
      "created_at": "2016-12-08T00:58:25Z",
      "updated_at": "2016-12-08T00:58:25Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "I like this change a lot \ud83d\ude04 ",
      "created_at": "2016-12-16T18:26:55Z",
      "updated_at": "2016-12-16T18:26:55Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@nadiasvertex your build issue with #2735 complaining about Microsoft.CodeAnalysis.dll is due to `src/TypeCatalogParser/Main.cs` the call `x.Name.ToLower()` making the filenames in lowercase and thus later on not matching the case-sensitive paths.  Not sure why this was there explicitly, but removing that call (changing to just `x.Name`) will get you past this.",
      "created_at": "2016-12-19T18:03:11Z",
      "updated_at": "2016-12-19T18:03:33Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "@SteveL-MSFT `x.Name.ToLower()` is there explicitly because of .NET CLI's behavior, per #2162. We verified this was intended change on their end in https://github.com/dotnet/cli/issues/4141.\r\n\r\nIf `CamelCasePaths` are being created for .NET CLI restored packages, then one of three things is ocurring: either an old version of `dotnet` is being used (a build before 3546), or the latest builds changed behavior  (again), or `dotnet` has disparate behavior among platforms.",
      "created_at": "2016-12-19T19:36:37Z",
      "updated_at": "2016-12-19T19:39:30Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@andschwa well, this is awkward since dotnet restore on my Ubuntu 16.10 system has packages with Pascal casing...\r\n\r\nremoving the ToLower() I can get a build on 16.10 using this change, but getting an exception starting powershell",
      "created_at": "2016-12-19T19:42:42Z",
      "updated_at": "2016-12-19T19:44:11Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "@SteveL-MSFT file a bug with .NET CLI, see if they purposefully changed it back \ud83d\ude04 ",
      "created_at": "2016-12-20T00:11:20Z",
      "updated_at": "2016-12-20T00:11:20Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@andschwa I think the difference is a breaking change they made with preview3 vs preview2.  On my Windows box and Ubuntu16.10, I have preview2 (as far as I can tell, preview3 isn't available on 16.10).  My Ubuntu16.04 box has preview3.  This PR may have to wait until we have preview3.",
      "created_at": "2016-12-20T17:22:55Z",
      "updated_at": "2016-12-20T17:23:23Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "@SteveL-MSFT @nadiasvertex:\r\n\r\nI installed the exact build that `Start-PSBootstrap` is currently pinned to on an Ubuntu 16.10 box, did a `dotnet restore`, and confirmed that these packages are *not* restored lower-cased:\r\n\r\n```sh\r\ndocker run -it ubuntu:16.10 bash\r\napt-get update\r\napt-get install libunwind8 libicu57 libcurl3 git curl\r\ncurl -sO https://raw.githubusercontent.com/dotnet/cli/v1.0.0-preview2-1-3177/scripts/obtain/dotnet-install.sh\r\nbash dotnet-install.sh -c preview -v 1.0.0-preview2-1-00317\r\ngit clone https://github.com/PowerShell/PowerShell.git\r\ncd PowerShell/\r\n~/.dotnet/dotnet --version\r\n~/.dotnet/dotnet restore\r\nls ~/.nuget/packages/\r\n```\r\nAnd got:\r\n```\r\n1.0.0-preview2-1-003177.dotnetSentinel\r\nLibuv\r\nMicrosoft.Build\r\nMicrosoft.Build.Framework\r\nMicrosoft.Build.Utilities.Core\r\nMicrosoft.CSharp\r\nMicrosoft.CodeAnalysis.Analyzers\r\nMicrosoft.CodeAnalysis.CSharp\r\nMicrosoft.CodeAnalysis.Common\r\nMicrosoft.CodeAnalysis.VisualBasic\r\nMicrosoft.DiaSymReader\r\nMicrosoft.DiaSymReader.Native\r\nMicrosoft.DotNet.Cli.Utils\r\n...\r\n```\r\n\r\nSo I dug a bit further, and in 32a8601f926b164bbdf74ad1b6c4c8ef927fe1a8 the `ToLower()` was removed because:\r\n\r\n> .NET Core 1.1 ships with an older dotnet/cli than has currently been used, so we revert to use case-sensitive directory names for dependencies.\r\n\r\nThis commit was made December 8, so I'd recommend @nadiasvertex you pull PowerShell and get the latest changes, as the bug you hit appears fixed.\r\n",
      "created_at": "2016-12-20T19:16:56Z",
      "updated_at": "2016-12-20T19:16:56Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "(This corresponds to @SteveL-MSFT finding the change is in preview3, but not preview2; and I didn't realize we'd reverted the tooling back that far.)",
      "created_at": "2016-12-20T19:18:13Z",
      "updated_at": "2016-12-20T19:18:13Z"
    }
  ],
  "created_at": "2016-12-02T00:34:28Z",
  "number": 2832,
  "state": "closed",
  "title": "build: Update build.sh to run fully manual build",
  "updated_at": "2016-12-28T21:59:52Z"
}