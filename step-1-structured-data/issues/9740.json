{
  "_url": "https://github.com/PowerShell/PowerShell/issues/9740",
  "author": "chriskuech",
  "body": "I have a function that accepts pipeline input and validates the input using validation attributes.  When the function receives invalid input passed by parameter, the validation attribute throws an error that can be caught using `try/catch`; however, when the function receives invalid input via the pipeline, the validation attribute throws an error that cannot be caught using `try/catch`.  This makes it impossible to write negative Pester tests on functions that validate pipeline input using validation attributes, because `| Should -Throw` will not catch the error, so the test will always fail.\r\n\r\n# Steps to reproduce\r\n\r\n```powershell\r\n\r\nfunction repro {\r\n  param(\r\n    [Parameter(Mandatory, ValueFromPipeline)]\r\n    [ValidateScript( { throw \"uh oh\" } )]\r\n    [string] $param\r\n  )\r\n}\r\n\r\ntry {\r\n  repro \"arg\"\r\n} catch {\r\n  Write-Host \"This error is caught\"\r\n}\r\n\r\ntry {\r\n  \"arg\" | repro\r\n} catch {\r\n  Write-Host \"...so why isn't this error caught?\"\r\n}\r\n\r\n```\r\n\r\n# Expected behavior\r\n\r\n```none\r\nThis error is caught\r\n...so why isn't this error caught?\r\n```\r\n\r\n# Actual behavior\r\n\r\n```none\r\nThis error is caught\r\nrepro : Cannot validate argument on parameter 'param'. uh oh\r\nAt line:28 char:11\r\n+   \"arg\" | repro\r\n+           ~~~~~\r\n+ CategoryInfo          : InvalidData: (arg:String) [repro], ParameterBindingValidationException\r\n+ FullyQualifiedErrorId : ParameterArgumentValidationError,repro\r\n```\r\n\r\n# Environment data\r\n\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.2.0\r\nPSEdition                      Core\r\nGitCommitId                    6.2.0\r\nOS                             Darwin 18.6.0 Darwin Kernel V\u2026\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n",
  "closed_at": null,
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@chriskuech Thanks for your contribution!\r\n\r\nRelated #3769",
      "created_at": "2019-05-28T03:46:31Z",
      "updated_at": "2019-05-29T03:08:09Z"
    },
    {
      "author": "chriskuech",
      "author_association": "NONE",
      "body": "@iSazonov , can you elaborate more on why you believe this to be a duplicate?\r\n\r\nThe issue you linked is for attributes failing silently; however, mine seems to be the opposite--attributes failing so loudly that they cannot be caught.  Also, unlike in the issue you linked, there's nothing wrong with my attributes--they are valid attributes, as shown in the first `try/catch` of my repro.  My issue is exclusively when the parameter value is passed by pipeline input.\r\n\r\nYours seems to be about _user_ error when _defining invalid_ validation attributes.  Mine seems to be about an _internal_ error when _applying valid_ validation attributes.",
      "created_at": "2019-05-28T20:27:49Z",
      "updated_at": "2019-05-28T20:27:49Z"
    },
    {
      "author": "chriskuech",
      "author_association": "NONE",
      "body": "Also I'm curious if there are two (interrelated) issues:\r\n1. Why is the attribute throwing an error when applied to pipeline input?\r\n2. Why is the thrown error not being caught by `try/catch`?",
      "created_at": "2019-05-28T20:33:08Z",
      "updated_at": "2019-05-29T03:10:43Z"
    },
    {
      "author": "scrthq",
      "author_association": "NONE",
      "body": "@chriskuech Not to sidetrack from the original focus of this working with `throw`, but this is behaving differently yet still not working correctly when using `$PSCmdlet.ThrowTerminatingError()`. Hopefully this helps add to the original issue:\r\n\r\nUpdated `repro` function:\r\n\r\n```powershell\r\nfunction repro {\r\n    param(\r\n        [Parameter(Mandatory, ValueFromPipeline)]\r\n        [ValidateScript({\r\n            $PSCmdlet.ThrowTerminatingError([System.Management.Automation.ErrorRecord]::new(\r\n                ([System.IO.FileNotFoundException]\"Uh oh!\"),\r\n                'Repro.Error',\r\n                [System.Management.Automation.ErrorCategory]::InvalidArgument,\r\n                $_\r\n            ))\r\n        })]\r\n        [string] $param\r\n    )\r\n}\r\n```\r\n\r\nUsing your sample triggers the catch block on both, but prints the error on the second as well as the catch block's Write-Host statement:\r\n\r\n```powershell\r\ntry {\r\n    repro \"arg\"\r\n}\r\ncatch {\r\n    Write-Host \"This error is caught\"\r\n}\r\n\r\ntry {\r\n    \"arg\" | repro\r\n} catch {\r\n    Write-Host \"...so why isn't this error caught?\"\r\n}\r\nThis error is caught\r\nrepro:\r\nLine |\r\n   9 |      \"arg\" | repro\r\n     |              ~~~~~\r\n     | Cannot validate argument on parameter 'param'. The pipeline has been stopped.\r\n...so why isn't this error caught?\r\n```\r\n\r\nWrapping it in a scriptblock and invoking it yields the expected response, but it's swallowing the errors in the scriptblock scope from what it seems:\r\n\r\n```powershell\r\n{\r\n    try {\r\n        repro \"arg\"\r\n    }\r\n    catch {\r\n        Write-Host \"This error is caught\"\r\n    }\r\n    try {\r\n        \"arg\" | repro\r\n    } catch {\r\n        Write-Host \"...so why isn't this error caught?\"\r\n    }\r\n}.Invoke()\r\nThis error is caught\r\n...so why isn't this error caught?\r\n```\r\n\r\nWhich seems like a win, but\u00a0trying to run those in a Pester test halts the pipeline before it can evaluate the result:\r\n\r\n```powershell\r\nImport-Module Pester\r\n{repro \"arg\"} | Should -Throw\r\n{\"arg\" | repro} | Should -Throw\r\nrepro:\r\nLine |\r\n   3 |  {\"arg\" | repro} | Should -Throw\r\n     |           ~~~~~\r\n     | Cannot validate argument on parameter 'param'. The pipeline has been stopped.\r\n```\r\n\r\n***\r\n\r\nEnvironment info:\r\n\r\n```powershell\r\n>> $PSVersionTable; Get-Module Pester\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.0-preview.2\r\nPSEdition                      Core\r\nGitCommitId                    7.2.0-preview.2\r\nOS                             Darwin 20.2.0 Darwin Kernel Version 20.2.0: Wed Dec  2 20:39:59 PST 2020; root:xnu-7195.60.75~1/RELEASE_X86_64\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\nName              : Pester\r\nPath              : /Users/nferrell/.local/share/powershell/Modules/Pester/4.10.1/Pester.psm1\r\nDescription       : Pester provides a framework for running BDD style Tests to execute and validate PowerShell commands inside of PowerShell and offers a\r\n                    powerful set of Mocking Functions that allow tests to mimic and mock the functionality of any command inside of a piece of PowerShell\r\n                    code being tested. Pester tests can execute any command or script that is accessible to a pester test file. This can include functions,\r\n                    Cmdlets, Modules and scripts. Pester can be run in ad hoc style in a console or it can be integrated into the Build scripts of a\r\n                    Continuous Integration system.\r\nGuid              : a699dea5-2c73-4616-a270-1f7abb777e71\r\nVersion           : 4.10.1\r\nModuleBase        : /Users/nferrell/.local/share/powershell/Modules/Pester/4.10.1\r\nModuleType        : Script\r\nPrivateData       : {PSData}\r\nAccessMode        : ReadWrite\r\nExportedAliases   : {[Add-ShouldOperator, Add-ShouldOperator], [And, And], [But, But], [Given, Given]\u2026}\r\nExportedCmdlets   : {}\r\nExportedFunctions : {[Add-AssertionOperator, Add-AssertionOperator], [AfterAll, AfterAll], [AfterEach, AfterEach], [AfterEachFeature, AfterEachFeature]\u2026}\r\nExportedVariables : {}\r\nNestedModules     : {Axiom, Format, TypeClass}\r\n```",
      "created_at": "2021-02-11T05:22:35Z",
      "updated_at": "2021-02-11T05:32:58Z"
    },
    {
      "author": "thedavecarroll",
      "author_association": "NONE",
      "body": "@SteveL-MSFT Could you take a look at this issue?\r\n\r\nI wasn't sure if there was a way to tag the new `WG-Engine` members.\r\n\r\n**Additional Info** \r\nIt appears that `ValidateRangeAttribute` works correctly against each item in the pipeline, but does not fail the entire pipeline or terminate the function if an element of the array is out of range or an incorrect type.\r\n\r\nAnd `ValidateCountAttribute` is not able to get a count because it requires the entire array.\r\n\r\n```powershell\r\nfunction Test-MaxCount {\r\n    [CmdletBinding()]\r\n    param(\r\n        [Parameter(Mandatory,Position = 0,ValueFromPipeline)]\r\n        [ValidateRange(1,9)]\r\n        [ValidateCount(1,10)]\r\n        [int[]]$Value\r\n    )\r\n    begin {\r\n        $Data = [System.Collections.ArrayList]::new()\r\n    }\r\n    process {\r\n        [void]$Data.Add($Input)\r\n    }\r\n    end {\r\n        if ($Data.Count -gt 10) {\r\n            throw (\"The parameter requires at least 1 value(s) and no more than 10 value(s) - {0} value(s) were provided. END BLOCK\" -f $Data.Count)\r\n        } else {\r\n            'Count: {0}' -f $Data.Count\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n```conole\r\nPS7.1.1 > 1,2,5,6,7,8,9,8,4,4,4,4,6,5 | Test-ValidateCount\r\nException: D:\\Test-ValidateCount.ps1:17\r\nLine |\r\n  17 |              throw (\"The parameter requires at least 1 value(s) and no \u2026\r\n     |              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | The parameter requires at least 1 value(s) and no more than 10 value(s) - 14 value(s) were provided.\r\n     | END BLOCK\r\n\r\nPS7.1.1 > 1,2,5,6,7,8,9,8,4,4,4,4,6,5,'G' | Test-MaxCount\r\nTest-MaxCount: The input object cannot be bound to any parameters for the command either because the command does not take pipeline input or the input and its properties do not match any of the parameters that take pipeline input.\r\nException: D:\\GitHub\\IronScripterSolutions\\2021-02-09\\2-Advanced.ps1:17\r\nLine |\r\n  17 |              throw (\"The parameter requires at least 1 value(s) and no \u2026\r\n     |              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | The parameter requires at least 1 value(s) and no more than 10 value(s) - 14 value(s) were provided.\r\n     | END BLOCK\r\n\r\nPS7.1.1 > 1,2,5,6,7,8,9,8,4,4,4,4,6,5,10 | Test-MaxCount\r\nTest-MaxCount: Cannot validate argument on parameter 'Value'. The 10 argument is greater than the maximum allowed range of 9. Supply an argument that is less than or equal to 9 and then try the command again.\r\nException: D:\\GitHub\\IronScripterSolutions\\2021-02-09\\2-Advanced.ps1:17\r\nLine |\r\n  17 |              throw (\"The parameter requires at least 1 value(s) and no \u2026\r\n     |              ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | The parameter requires at least 1 value(s) and no more than 10 value(s) - 14 value(s) were provided.\r\n     | END BLOCK\r\n\r\n\r\nPS7.1.1 > 1,2,5,6,7,8,9,8,4,4 | Test-MaxCount\r\nCount: 10\r\n```\r\n\r\n**Updated Docs and Guidance**\r\nPipeline support is a significant boon for PowerShell, as is the `Validate*` parameter decorators. \r\n\r\nIf this will not be resolved anytime soon, there should be verbiage included in the [about_Functions_Advanced_Parameters validation section](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_functions_advanced_parameters?view=powershell-7.1#parameter-and-variable-validation-attributes).\r\n\r\nAdditionally, guidance on possible workarounds, if any, would be well appreciated.\r\n\r\nThanks!",
      "created_at": "2021-02-11T06:26:27Z",
      "updated_at": "2021-02-11T06:34:19Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> And `ValidateCountAttribute` is not able to get a count because it requires the entire array.\r\n\r\nPipeline enumerates inputs. You should send entire array as a single object if you want ValidateCount works on it.\r\n\r\n----\r\n\r\nI believe the behavior in a pipeline is by-design - I have no idea where we could insert \"catch exception\" into a pipeline.",
      "created_at": "2021-02-11T15:35:45Z",
      "updated_at": "2021-02-11T15:36:10Z"
    }
  ],
  "created_at": "2019-05-27T21:13:57Z",
  "number": 9740,
  "state": "open",
  "title": "Validation Attribute errors on pipeline input cannot be caught",
  "updated_at": "2021-02-11T15:36:10Z"
}