{
  "_url": "https://github.com/PowerShell/PowerShell/issues/8407",
  "author": "vexx32",
  "body": "## PR Summary\r\n\r\nCurrently Get-Variable sends output to the pipeline without enumerating it when using `-ValueOnly`. This is at odds with almost every other cmdlet, and furthermore is at odds with the intuitive behaviour &mdash; I think it is reasonable to expect (indeed, that the _intent_ for this switch is for) the variable value to be returned in the same manner as it is when simply calling the variable.\r\n\r\nIn other words, it appears reasonable to expect that the two statements following the declaration should be equivalent:\r\n\r\n```powershell\r\n$a = 1, 2, 3, 4, 5\r\n$a | Get-Member\r\nGet-Variable -Name a -ValueOnly | Get-Member\r\n```\r\n\r\nIf this behaviour is instead actually _intentional_, then it needs to be documented properly ([it isn't](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/get-variable?view=powershell-6#optional-parameters)), but I suspect it is more a matter of oversight than design here.\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [ ] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` to the beginning of the title and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [ ] Not Applicable\r\n    - **OR**\r\n    - [x] User-facing [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed - Issue link:\r\n- **Testing - New and feature**\r\n    - [ ] Not Applicable or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [ ] [Add `[feature]` if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n",
  "closed_at": "2019-01-09T23:51:17Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Formally it is a breaking change. /cc @SteveL-MSFT \r\n\r\n@mklement0 Could you please look the change too?",
      "created_at": "2018-12-06T13:33:46Z",
      "updated_at": "2018-12-06T13:33:46Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "We don't cover the code by tests. \ud83d\ude15 \r\n@vexx32 please add tests.",
      "created_at": "2018-12-06T13:35:09Z",
      "updated_at": "2018-12-06T13:35:09Z"
    },
    {
      "author": "mklement0",
      "author_association": "CONTRIBUTOR",
      "body": "The motivation for the change makes perfect sense to me and the change looks good. Nice catch, @vexx32. ",
      "created_at": "2018-12-06T14:56:28Z",
      "updated_at": "2018-12-06T14:56:28Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "I can't really take the credit. @HumanEquivalentUnit stumbled across it trying to creatively troll someone on Reddit, apparently. \ud83d\ude02\r\n\r\nI'll get some tests together during lunch. \ud83d\ude04 ",
      "created_at": "2018-12-06T15:04:27Z",
      "updated_at": "2018-12-06T15:04:27Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@iSazonov @PaulHigin For a minute I was thinking \"typical `Should` tests won't account for this... will they?\"\r\n\r\nAnd yet, despite a _horrifically_ confusing error message, they **do**:\r\n![image](https://user-images.githubusercontent.com/32407840/49602681-09ff5700-f957-11e8-87b0-6c71a8220131.png)\r\n\r\n/cc @nohwnd",
      "created_at": "2018-12-06T18:01:28Z",
      "updated_at": "2018-12-06T18:07:31Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": ">And yet, despite a horrifically confusing error message, they do\r\n\r\nPerhaps it could be reported to Pester.",
      "created_at": "2018-12-07T03:32:10Z",
      "updated_at": "2018-12-07T03:32:10Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "I have notified one of the maintainers both here and in the PowerShell Slack. I'll file an issue as well, just to be absolutely sure it's filed somewhere and not forgotten. \ud83d\ude04 ",
      "created_at": "2018-12-07T03:38:19Z",
      "updated_at": "2018-12-07T03:38:19Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Current test with checking types isn't good for me.\r\n\r\n> Get-Variable -Name a -ValueOnly | Get-Member\r\n\r\nI think a key in the test is that `Get-Member` has parameter with `ValueFromPipeline = true`\r\nSeems we could use Compare-Object with DifferenceObject parameter like \r\n`Get-Variable -Name a -ValueOnly | Compare-Object -ReferenceObject $expected | Should ...`",
      "created_at": "2018-12-07T04:12:37Z",
      "updated_at": "2018-12-07T04:12:37Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@iSazonov This is the only especially sensible method I can think of apart from the Get-Member test. Interestingly, `Compare-Object` does _not_ notice the difference; running that Compare-Object line (omitting the `Should`) gives no output. Appending `-IncludeEqual` indicates that it thinks both collections are equal and contain the same items.\r\n\r\nWhich is perfectly correct, I suppose, but it doesn't seem to distinguish the enumerated/not enumerated like one can by checking the type directly; indeed, it seems to me that this may be the only straightforward method to do so.\r\n\r\nIt's a bit of a tricky problem, and I acknowledge that there aren't a lot of good and easy ways to test it due to many cmdlets simply having an implicit *assumption* that piped objects will be enumerated and quietly handling those that don't, in an effort to make things like `$a | Compare-Object -ReferenceObject $b` and `Compare-Object -ReferenceObject $a -DifferenceObject $b` functionally equivalent.",
      "created_at": "2018-12-07T05:05:36Z",
      "updated_at": "2018-12-07T05:05:36Z"
    },
    {
      "author": "mklement0",
      "author_association": "CONTRIBUTOR",
      "body": "A pragmatic solution would be:\r\n\r\n```powershell\r\n(Get-Variable var1 -ValueOnly | Measure-Object).Count | Should -Be 3\r\n```\r\n\r\nIf the array contained in `$var1` were unexpectedly sent to the pipeline as a single object, the result would be `1`.",
      "created_at": "2018-12-07T05:19:12Z",
      "updated_at": "2018-12-07T05:19:43Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@mklement0 Thanks! It would nice test.",
      "created_at": "2018-12-07T05:24:45Z",
      "updated_at": "2018-12-07T05:24:45Z"
    },
    {
      "author": "nohwnd",
      "author_association": "NONE",
      "body": "I also think that the approach that @mklement0 proposed is the easiest and most reliable. The reason for the assertion failure is the same. Internally `Should -Be` compares [the count](https://github.com/pester/Pester/blob/master/Functions/Assertions/Be.ps1#L209) of items on both sides and fails when they differ. \r\n\r\nDepending on your version of Pester you might consider adding a `-Because` that would better explain what is the reason for the failure is.",
      "created_at": "2018-12-07T07:58:15Z",
      "updated_at": "2018-12-07T07:58:15Z"
    },
    {
      "author": "stale[bot]",
      "author_association": "NONE",
      "body": "This PR has been automatically marked as stale because it has not had activity in the last 30 days. It will be closed if no further activity occurs within 10 days.\nThank you for your contributions.\nCommunity members are welcome to grab these works.\n",
      "created_at": "2019-01-07T07:20:28Z",
      "updated_at": "2019-01-07T07:20:28Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "Pending committee decision.",
      "created_at": "2019-01-07T11:07:54Z",
      "updated_at": "2019-01-07T11:07:54Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@PowerShell/powershell-committee reviewed this.  Agree that there is inconsistency, but there isn't clear value to taking this breaking change (likely breaking Pester usage which is highly impactful and may represent wider usage of existing behavior).  Need to verify we have sufficient documentation on existing behavior.",
      "created_at": "2019-01-09T23:50:42Z",
      "updated_at": "2019-01-09T23:51:12Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@SteveL-MSFT can you expand upon how that would break Pester? ",
      "created_at": "2019-01-10T00:26:52Z",
      "updated_at": "2019-01-10T00:26:52Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@vexx32 looking at your example, we believed that Pester relies on current behavior.  Correct us if that is not true.",
      "created_at": "2019-01-10T00:38:51Z",
      "updated_at": "2019-01-10T00:38:51Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "As far as I know (/cc @nohwnd as I'm sure he knows more than I where Pester's internals are concerned), Pester doesn't currently rely on `Get-Variable -ValueOnly` to compare items in any way.\r\n\r\nWhich example are you referring to? The example in the PR description doesn't have anything to do with Pester itself:\r\n\r\n```powershell\r\n$a = 1, 2, 3, 4, 5\r\n$a | Get-Member\r\nGet-Variable -Name a -ValueOnly | Get-Member\r\n```\r\n\r\nThese simply differ because with Get-Variable (and as far as I know, apart from `ConvertFrom-Json` where it is intentional due to JSON structure, it's the **only** cmdlet that does this) doesn't enumerate its output, so there's no difference between `gv -val a | gm` and `gm -inp (gv -val a)`\r\n\r\nThe initial Pester test that I used to verify the behaviour is this:\r\n```powershell\r\nGet-Variable -Name var1 -ValueOnly | Should -Be $var1\r\n```\r\n\r\nAnd the reason this currently _fails_ is simply because `Should` is _expecting_ that a pipeline enumerates the output, so it **deliberately assumes** that any input that comes in implicitly has an already-discarded collection wrapper and matches things to the `-Be` provided parameter values accordingly.\r\n\r\nThe only way this breaks Pester itself would be if someone was using that exact test format and relying on the behaviour of `Get-Variable -ValueOnly` itself over the pipeline, which _may_ certainly be a concern, but to my knowledge Pester doesn't use that cmdlet specifically in this way, so it should remain unaffected. (Were I to need this, after all, I would opt instead for `Get-Variable` _without_ `-ValueOnly`, so that I could simply get the returned object and examine its `.Value` property, which is guaranteed to be true to life, pipeline or not.\r\n\r\nIf it did rely on that behaviour, I think I would expect the test to continue to fail once the change is made in the Get-Variable cmdlet, and we definitely saw the behaviour change as expected judging by the CI results and my own local tests.\r\n\r\nI will of course respect the committee's decision, but I just want to make sure we're not retaining inconsistent behaviour without giving it a thorough look-see. \ud83d\ude04 ",
      "created_at": "2019-01-10T00:56:14Z",
      "updated_at": "2019-01-10T00:56:14Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@vexx32 thanks for the details.  I think the overall conclusion from @PowerShell/powershell-committee is that we don't know how much impact there is with users relying on the current behavior.  A simple search on GItHub turned up a number of scripts using `Get-Variable -ValueOnly`, but it's not easy to see how many use this in a pipeline (directly or indirectly).  The Pester remark may have been incorrect, but wasn't the deciding factor.  It's also not clear how much value this provides (other than consistency) to justify the breaking change.",
      "created_at": "2019-01-10T02:19:22Z",
      "updated_at": "2019-01-10T02:19:22Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "Roger that, I appreciate you taking the time to clarify! Personally, I think consistency is _super_ valuable but I also recognise that it's... dicey... at best to change long-standing behaviour for its sole sake. \ud83d\ude04 ",
      "created_at": "2019-01-10T02:32:12Z",
      "updated_at": "2019-01-10T02:32:12Z"
    },
    {
      "author": "nohwnd",
      "author_association": "NONE",
      "body": "@vexx32 you analysis is correct. (If Pester relied on that behavior we could work around it by adding a case that would change based on the version of PowerShell, there are few conditional fixes and features like this already, but I also respect the decision of the committee of course :) )",
      "created_at": "2019-01-10T12:55:59Z",
      "updated_at": "2019-01-10T12:55:59Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@SteveL-MSFT Mostly for completeness' sake:\r\n\r\n I'm not an expert with GH search, but from what I can see, it appears that `Get-Variable -ValueOnly` is almost never used in a pipeline context that would be affected, at least on Github (potentially _because_ of this confusion?)\r\n\r\nhttps://github.com/search?q=language%3APowerShell+%22Get-Variable+-ValueOnly+%7C%22&type=Code\r\n\r\nScrolling through these results, I see a few common patterns:\r\n\r\n* `(Get-Variable myVar -ValueOnly) | ...` - not affected due to parentheses forcing collection of output and re-output anyway (see: `(Get-Variable a -ValueOnly) | Should -Be $a`)\r\n* `Get-Variable -Name <reserved scalar variable e.g., MyInvocation> -ValueOnly`\r\n* Use in non-pipeline contexts, or in pipeline contexts with scalar values (which are unaffected because there is no need to enumerate them on output to pipeline)\r\n\r\nIt seems that in a majority of cases I can find, people are using it to code defensively (safely getting values in strict mode, for example) and as such are well aware of the limitation; I note around one instance of `(Get-Variable -Name myVar -ValueOnly) | Some-Command` every couple of pages, and the only instances where it is used without parentheses seem to be ones where the variable has been recently explicitly declared as a scalar value.\r\n\r\nThat said, however, I don't think this is enough to go on. There are a fair few alias-forms of the command and parameter that can be used, and in general I would expect less carefully-coded forms of the command to crop up more frequently in a search for those. For now I think we can probably leave it as-is -- but we absolutely should document this oddity. \ud83d\ude04 ",
      "created_at": "2019-01-10T14:27:44Z",
      "updated_at": "2019-01-10T14:27:44Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Such fixes is good candidates for next LTS version if we'll produce LTS versions. We could mark such PRs with \"Next-LTS\" label.",
      "created_at": "2019-01-10T14:59:11Z",
      "updated_at": "2019-01-10T14:59:11Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Perhaps add this to https://github.com/PowerShell/PowerShell/issues/6745\r\n",
      "created_at": "2019-01-10T19:24:53Z",
      "updated_at": "2019-01-10T19:24:53Z"
    }
  ],
  "created_at": "2018-12-06T04:15:30Z",
  "number": 8407,
  "state": "closed",
  "title": "Use correct overload for Write-Object in Get-Variable",
  "updated_at": "2019-01-22T13:19:38Z"
}