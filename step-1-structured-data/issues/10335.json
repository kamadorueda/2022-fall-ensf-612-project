{
  "_url": "https://github.com/PowerShell/PowerShell/issues/10335",
  "author": "KirkMunro",
  "body": "Attempting to invoke a command in the host runspace when it is busy incorrectly results in the message buffers being closed, which prevents further invocations from working properly if they write messages to those buffers.\r\n\r\n# Steps to reproduce\r\n\r\n```powershell\r\n# Note: This uses the call operator because the commands must all be run in\r\n# one shot to reproduce the issue.\r\n& {\r\n    $ps = [powershell]::Create()\r\n    $ps.Runspace = $host.Runspace\r\n    try {\r\n        $ps.AddScript('Get-Date').Invoke() > $null\r\n    } finally {\r\n        $ps.Dispose()\r\n    }\r\n\r\n    [ScriptBlock]::Create({Write-Error 'An error'}).Invoke() > $null\r\n}\r\n```\r\n\r\n# Expected behavior\r\n\r\n```none\r\nException calling \"Invoke\" with \"0\" argument(s): \"The pipeline was not run because a pipeline is already running. Pipelines cannot be run concurrently.\"\r\nAt line:5 char:9\r\n+         $ps.AddScript('Get-Date').Invoke() > $null\r\n+         ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : NotSpecified: (:) [], MethodInvocationException\r\n+ FullyQualifiedErrorId : PSInvalidOperationException\r\n```\r\n\r\n# Actual behavior\r\n\r\n```none\r\nException calling \"Invoke\" with \"0\" argument(s): \"The pipeline was not run because a pipeline is already running. Pipelines cannot be run concurrently.\"\r\nAt line:5 char:9\r\n+         $ps.AddScript('Get-Date').Invoke() > $null\r\n+         ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : NotSpecified: (:) [], MethodInvocationException\r\n+ FullyQualifiedErrorId : PSInvalidOperationException\r\n\r\nException calling \"Invoke\" with \"0\" argument(s): \"Objects cannot be added to a closed buffer. Make sure the buffer is open for Add and Insert operations to succeed.\"\r\nAt line:10 char:5\r\n+     [ScriptBlock]::Create({Write-Error 'An error'}).Invoke() > $null\r\n+     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : NotSpecified: (:) [], MethodInvocationException\r\n+ FullyQualifiedErrorId : CmdletInvocationException\r\n```\r\n\r\n# Environment data\r\n\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.2.1\r\nPSEdition                      Core\r\nGitCommitId                    6.2.1\r\nOS                             Microsoft Windows 10.0.17763\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\nNote: This also repros on PowerShell 5.1, so this is not a new issue.",
  "closed_at": null,
  "comments": [],
  "created_at": "2019-08-09T16:15:23Z",
  "labels": [
    "Issue-Bug",
    "WG-Engine"
  ],
  "number": 10335,
  "state": "open",
  "title": "Message buffers are closed prematurely if you attempt to invoke a command in the host runspace while it is busy",
  "updated_at": "2020-01-30T14:06:21Z"
}