{
  "_url": "https://github.com/PowerShell/PowerShell/issues/2777",
  "author": "mirichmo",
  "body": "This issue only appears when the Win7-x86 version of PowerShell Core is run on Windows 7. Windows 8 and later properly handle the situation. The problem is that the OS is not properly identifying the API set that contains GetCurrentThread(). Microsoft.Management.Infrastructure.Native.dll lists `api-ms-win-core-processthreads-l1-1-2.dll` as a dependency and this is properly resolved in most versions of Windows. On Win 7, it doesn't resolve it to either kernel32 or `api-ms-win-core-processthreads-l1-1-0.dll` (the API set that exports the function).\r\n\r\nA workaround is to copy `C:\\windows\\system32\\api-ms-win-core-processthreads-l1-1-0.dll` to `c:\\windows\\system32\\api-ms-win-core-processthreads-l1-1-2.dll`. This will enable the DLL loader to resolve the DLL by name.\r\n\r\nSteps to reproduce\r\n------------------\r\n1. Install the 6.0.0-alpha.13 win7-x86 MSI on a Win 7 x86 VM\r\n2. Start PowerShell Core\r\n3. Get-CimInstance Win32_ComputerSystem\r\n\r\nExpected behavior\r\n-----------------\r\nIt returns the Win32_ComputerSystem object\r\n\r\nActual behavior\r\n---------------\r\nPS C:\\Windows\\system32> get-ciminstance win32_computersystem\r\nget-ciminstance : Unable to find an entry point named 'GetCurrentThread' in DLL 'api-ms-win-core-processthreads-l1-1-2.dll'.\r\nAt line:1 char:1\r\n+ get-ciminstance win32_computersystem\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : NotSpecified: (root\\cimv2:win32_computersystem:String) [Get-CimInstance], EntryPointNotFoundException\r\n    + FullyQualifiedErrorId : CimCmdlet_EntryPointNotFoundException,Microsoft.Management.Infrastructure.CimCmdlets.GetCimInstanceCommand\r\n\r\nPS C:\\Windows\\system32> $error[0] | fl * -force\r\n\r\nwriteErrorStream      : True\r\nPSMessageDetails      :\r\nOriginInfo            :\r\nException             : System.EntryPointNotFoundException: Unable to find an entry point named 'GetCurrentThread' in DLL\r\n                        'api-ms-win-core-processthreads-l1-1-2.dll'.\r\n                           at GetCurrentThread()\r\n                           at Microsoft.Management.Infrastructure.Native.OperationHandle.ReleaseHandle()\r\n                           at System.Runtime.InteropServices.SafeHandle.InternalDispose()\r\n                           at System.Runtime.InteropServices.SafeHandle.Dispose(Boolean disposing)\r\n                           at System.Runtime.InteropServices.SafeHandle.Dispose()\r\n                           at Microsoft.Management.Infrastructure.Internal.Operations.CimOperation.Dispose(Boolean disposing)\r\n                           at Microsoft.Management.Infrastructure.Internal.Operations.CimAsyncCallbacksReceiverBase.DisposeOperationWhenPossibleWorker(CimOperation cimOperation)\r\n                           at Microsoft.Management.Infrastructure.Internal.Operations.CimAsyncCallbacksReceiverBase.InvokeWhenOperationIsSet(Action`1 action)\r\n                           at Microsoft.Management.Infrastructure.Internal.Operations.CimAsyncCallbacksReceiverBase.DisposeOperationWhenPossible()\r\n                           at Microsoft.Management.Infrastructure.Internal.Operations.CimAsyncObserverProxyBase`1.ProcessNativeCallback(OperationCallbackProcessingContext callbackProcessingContext, T currentItem, Boolean moreResults, MiResult operationResult, String errorMessage, InstanceHandle errorDetailsHandle)\r\n                           at Microsoft.Management.Infrastructure.Internal.Operations.CimAsyncInstanceObserverProxy.InstanceResultCallback(OperationCallbackProcessingContextcallbackProcessingContext, OperationHandle operationHandle, InstanceHandle instanceHandle, Boolean moreResults, MiResult operationResult, String errorMessage, InstanceHandle errorDetailsHandle)\r\n                           at Microsoft.Management.Infrastructure.Native.ExceptionSafeInstanceResultCallback.InvokeUserCallback()\r\n                           at Microsoft.Management.Infrastructure.Native.OperationCallbacks.InvokeWithUserFilteredExceptionHandler(Action tryBody, Func`2 userFilter, Action`1 catchBody)\r\nTargetObject          : root\\cimv2:win32_computersystem\r\nCategoryInfo          : NotSpecified: (root\\cimv2:win32_computersystem:String)[Get-CimInstance], EntryPointNotFoundException\r\nFullyQualifiedErrorId : CimCmdlet_EntryPointNotFoundException,Microsoft.Management.Infrastructure.CimCmdlets.GetCimInstanceCommand\r\nErrorDetails          :\r\nInvocationInfo        : System.Management.Automation.InvocationInfo\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\nPipelineIterationInfo : {0, 1}\r\n\r\n\r\nEnvironment data\r\n----------------\r\n6.0.0-alpha.13\r\n",
  "closed_at": "2017-11-10T20:02:22Z",
  "comments": [
    {
      "author": "MRhoades-Brown-CTL",
      "author_association": "NONE",
      "body": "Hi,\r\n\r\nI also get this issue with Windows 7 x64 and the latest version:\r\n\r\n```\r\nPS C:\\Program Files\\PowerShell\\6.0.0-alpha.18> $env:PROCESSOR_ARCHITECTURE\r\nAMD64\r\nPS C:\\Program Files\\PowerShell\\6.0.0-alpha.18> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nCLRVersion\r\nWSManStackVersion              3.0\r\nBuildVersion                   3.0.0.0\r\nGitCommitId                    v6.0.0-alpha.18\r\nSerializationVersion           1.1.0.1\r\nPSRemotingProtocolVersion      2.3\r\nPSEdition                      Core\r\nPSVersion                      6.0.0-alpha\r\n\r\n\r\nPS C:\\Program Files\\PowerShell\\6.0.0-alpha.18> Get-CimInstance -ClassName Win32_OperatingSystem\r\nGet-CimInstance : Unable to find an entry point named 'GetCurrentThread' in DLL 'api-ms-win-core-processthreads-l1-1-2.dll'.\r\nAt line:1 char:1\r\n+ Get-CimInstance -ClassName Win32_OperatingSystem\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : NotSpecified: (root\\cimv2:Win32_OperatingSystem:String) [Get-CimInstance], EntryPointNotFoundException\r\n    + FullyQualifiedErrorId : CimCmdlet_EntryPointNotFoundException,Microsoft.Management.Infrastructure.CimCmdlets.GetCimInstanceCommand\r\n\r\nPS C:\\Program Files\\PowerShell\\6.0.0-alpha.18> $Error[0] | fl * -Force\r\n\r\n\r\nwriteErrorStream      : True\r\nPSMessageDetails      :\r\nOriginInfo            :\r\nException             : System.EntryPointNotFoundException: Unable to find an entry point named 'GetCurrentThread' in DLL 'api-ms-win-core-processthreads-l1-1-2.dll'.\r\n                           at GetCurrentThread()\r\n                           at Microsoft.Management.Infrastructure.Native.OperationHandle.ReleaseHandle()\r\n                           at System.Runtime.InteropServices.SafeHandle.InternalDispose()\r\n                           at Microsoft.Management.Infrastructure.Internal.Operations.CimOperation.Dispose(Boolean disposing)\r\n                           at Microsoft.Management.Infrastructure.Internal.Operations.CimAsyncCallbacksReceiverBase.DisposeOperationWhenPossibleWorker(CimOperation cimOperation)\r\n                           at Microsoft.Management.Infrastructure.Internal.Operations.CimAsyncCallbacksReceiverBase.InvokeWhenOperationIsSet(Action`1 action)\r\n                           at Microsoft.Management.Infrastructure.Internal.Operations.CimAsyncObserverProxyBase`1.ProcessNativeCallback(OperationCallbackProcessingContext\r\n                        callbackProcessingContext, T currentItem, Boolean moreResults, MiResult operationResult, String errorMessage, InstanceHandle errorDetailsHandle)\r\n                           at Microsoft.Management.Infrastructure.Internal.Operations.CimAsyncInstanceObserverProxy.InstanceResultCallback(OperationCallbackProcessingContext\r\n                        callbackProcessingContext, OperationHandle operationHandle, InstanceHandle instanceHandle, Boolean moreResults, MiResult operationResult, String errorMessage,\r\n                        InstanceHandle errorDetailsHandle)\r\n                           at Microsoft.Management.Infrastructure.Native.ExceptionSafeInstanceResultCallback.InvokeUserCallback()\r\n                           at Microsoft.Management.Infrastructure.Native.OperationCallbacks.InvokeWithUserFilteredExceptionHandler(Action tryBody, Func`2 userFilter, Action`1 catchBody)\r\nTargetObject          : root\\cimv2:Win32_OperatingSystem\r\nCategoryInfo          : NotSpecified: (root\\cimv2:Win32_OperatingSystem:String) [Get-CimInstance], EntryPointNotFoundException\r\nFullyQualifiedErrorId : CimCmdlet_EntryPointNotFoundException,Microsoft.Management.Infrastructure.CimCmdlets.GetCimInstanceCommand\r\nErrorDetails          :\r\nInvocationInfo        : System.Management.Automation.InvocationInfo\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\nPipelineIterationInfo : {0, 1}\r\n```\r\n",
      "created_at": "2017-07-17T11:14:03Z",
      "updated_at": "2017-07-17T11:14:03Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "Fixed by releasing https://powershell.myget.org/feed/powershell-core/package/nuget/Microsoft.Management.Infrastructure/1.0.0-alpha07\r\n",
      "created_at": "2017-11-10T20:02:16Z",
      "updated_at": "2017-11-10T20:02:16Z"
    }
  ],
  "created_at": "2016-11-23T23:28:17Z",
  "labels": [
    "Issue-Bug",
    "Area-Maintainers-Build",
    "WG-Cmdlets",
    "Resolution-Fixed"
  ],
  "number": 2777,
  "state": "closed",
  "title": "Get-CimInstance fails on Win7-x86 when run on Win 7",
  "updated_at": "2017-11-12T18:10:59Z"
}