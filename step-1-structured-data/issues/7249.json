{
  "_url": "https://github.com/PowerShell/PowerShell/issues/7249",
  "author": "rjmholt",
  "body": "<!--\r\n\r\nFor Windows PowerShell 5.1 issues, suggestions, or feature requests please use the following link instead:\r\n- Windows PowerShell [UserVoice](https://windowsserver.uservoice.com/forums/301869-powershell)\r\n\r\nIf it is a bug report:\r\n- make sure you are able to repro it on the latest released version. \r\nYou can install the latest version from https://github.com/PowerShell/PowerShell/releases\r\n- Search the existing issues.\r\n- Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- Refer to the [known issues](https://docs.microsoft.com/powershell/scripting/whats-new/known-issues-ps6?view=powershell-6).\r\n- Fill out the following repro template:\r\n\r\nIf it's not a bug, please remove the template and elaborate the issue in your own words.\r\n-->\r\n\r\n`Stop-Job` Feature test sometimes fails on UNIX platforms in CI\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/c2bbc2291aaa1992f00c227ba66251866b86afe9/test/powershell/Modules/Microsoft.PowerShell.Core/Job.Tests.ps1#L61-L67\r\n\r\nWith the error\r\n```\r\n Context jobs which take time\r\n++[localhost] The background process closed or ended abnormally.\r\n+ CategoryInfo : OpenError: (localhost:String) [], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : 2101,PSSessionStateBroken\r\n [-] Stop-Job will stop a job 647ms\r\n Expected $null or empty, but got {[localhost] The background process closed or ended abnormally.}.\r\n 65: $err | Should -BeNullOrEmpty\r\n at Invoke-Assertion, /home/travis/build/PowerShell/PowerShell/src/powershell-unix/bin/Release/netcoreapp2.1/linux-x64/publish/Modules/Pester/4.2.0/Functions/Assertions/Should.ps1: line 206\r\n at <ScriptBlock>, /home/travis/build/PowerShell/PowerShell/test/powershell/Modules/Microsoft.PowerShell.Core/Job.Tests.ps1: line 65\r\n```\r\n\r\n\r\nSteps to reproduce\r\n------------------\r\nHaven't been able to work out how to reproduce this error, it has only been seen in CI on UNIX so far.\r\n\r\nExpected behavior\r\n-----------------\r\n\r\n`Stop-Job` should cause the job state to be set to `Stopped` and the test should pass.\r\n\r\nActual behavior\r\n---------------\r\n\r\nThe job state comes back as `Failed` and the test fails. Given the error message and where it comes from in the code:\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/057eeddbd6f34fcd9f322d0792b102ee8934c6b9/src/System.Management.Automation/engine/remoting/fanin/OutOfProcTransportManager.cs#L693-L714\r\n\r\nIt looks like the job process itself is exiting prematurely for some reason.\r\n\r\nEnvironment data\r\n----------------\r\n\r\nOccurring in `master` branch of PowerShell on Linux and macOS.\r\n\r\nProposed Solution\r\n---------------------\r\n\r\n* Add information to the error message about the process' exit code and stderr\r\n* Add syslog (on Linux) and os_log (on macOS) output to build artefacts in Travis\r\n* Add core dump files to build artefacts on Travis",
  "closed_at": null,
  "comments": [],
  "created_at": "2018-07-09T17:45:45Z",
  "number": 7249,
  "state": "open",
  "title": "Stop-Job intermittently failing in UNIX CI builds",
  "updated_at": "2018-07-09T17:45:45Z"
}