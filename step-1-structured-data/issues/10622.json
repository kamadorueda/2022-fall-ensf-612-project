{
  "_url": "https://github.com/PowerShell/PowerShell/issues/10622",
  "author": "iSazonov",
  "body": "<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\n1. Bring back Certificate provider parameters:\r\n    - DNSName \r\n    - DocumentEncryptionCert\r\n    - EKU\r\n    - ExpiringInDays\r\n    - SSLServerAuthentication\r\n\r\n2. Add new tests and update existing tests. (There are many style issues - will fix in follow PR.)\r\n3. Update test certificate for EKU and DNSName tests.\r\n4. Remove old unneeded code.\r\n\r\n## PR Context\r\n\r\nRelated #3847\r\n\r\nAfter removing undocumented certificate API in PR #3818 we lost some parameters in Certificate provider.\r\n\r\nWe need to review documentation because the parameters is not all documented and it seems they do not always documented correctly. \r\n(For reference https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.security/about/about_certificate_provider?view=powershell-6)\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [x] None\r\n    - **OR**\r\n    - [ ] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n        - [ ] Experimental feature name(s): <!-- Experimental feature name(s) here -->\r\n- **User-facing changes**\r\n    - [ ] Not Applicable\r\n    - **OR**\r\n    - [x] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: https://github.com/MicrosoftDocs/PowerShell-Docs/issues/6059\r\n- **Testing - New and feature**\r\n    - [ ] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [x] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [ ] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [ ] I have considered the user experience from a tooling perspective and enumerated concerns in the summary. This may include:\r\n        - Impact on [PowerShell Editor Services](https://github.com/PowerShell/PowerShellEditorServices) which is used in the [PowerShell extension](https://github.com/PowerShell/vscode-powershell) for VSCode (which runs in a different PS Host).\r\n        - Impact on Completions (both in the console and in editors) - one of PowerShell's most powerful features.\r\n        - Impact on [PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer) (which provides linting & formatting in the editor extensions).\r\n        - Impact on [EditorSyntax](https://github.com/PowerShell/EditorSyntax) (which provides syntax highlighting with in VSCode, GitHub, and many other editors).\r\n",
  "closed_at": "2020-06-02T18:44:18Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "It seems Get-PfxCertificate _crush_ the pwsh process if open \"GoodCertificate\" which I updated. All works well on Windows and Linux but fail on MacOs. Looks like a bug on MacOs. At least pwsh should return an error and doesn't crush. \r\nI haven't MacOs and can not investigate in depth. I need help to resolve the issue.",
      "created_at": "2019-09-25T13:59:28Z",
      "updated_at": "2019-09-25T14:00:27Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@iSazonov I don't have time to review now.  Blocking this PR, until I can organize a security review.",
      "created_at": "2019-09-25T21:37:59Z",
      "updated_at": "2019-09-25T21:37:59Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Add WIP while waiting security review.",
      "created_at": "2019-09-26T03:10:51Z",
      "updated_at": "2019-09-26T03:10:51Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "macOS tests are hanging\r\n\r\n```\r\n  Describing CmsMessage cmdlets and Get-PfxCertificate basic tests\r\nCertificate written to /var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/protectedCert.pfx\r\nEnter password:                                                                                                                                                                                                                                                                                                                                 \r\nExecution of { & $powershell $PSFlags -c $command } by build.psm1: line 1231 failed with exit code 1\r\nAt /Users/vsts/agent/2.158.0/work/1/s/build.psm1:2074 char:17\r\n+                 throw $errorMessage\r\n+                 ~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : OperationStopped: (Execution of { & $p\\u2026ed with exit code 1:String) [], RuntimeException\r\n+ FullyQualifiedErrorId : Execution of { & $powershell $PSFlags -c $command } by build.psm1: line 1231 failed with exit code 1\r\n```",
      "created_at": "2019-10-07T22:32:06Z",
      "updated_at": "2019-10-07T22:32:06Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@TravisEz13 \r\n> macOS tests are hanging\r\n\r\nI did not change anything except the certificate. I tend to think it's a bug outside PowerShell :-(\r\nI haven't MacOs and I only can revert to old certificate and generate new for new tests to \r\nminimize area.\r\n",
      "created_at": "2019-10-08T03:07:36Z",
      "updated_at": "2019-10-08T03:07:36Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@iSazonov Definitely seems related to your change.  ",
      "created_at": "2019-10-10T20:56:41Z",
      "updated_at": "2019-10-10T20:56:41Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@TravisEz13 I see :-( Can you help to create and pull MacOs compatible certificate?",
      "created_at": "2019-10-11T17:29:12Z",
      "updated_at": "2019-10-11T17:29:12Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "Maybe @rjmholt can help.   ",
      "created_at": "2019-11-08T19:45:33Z",
      "updated_at": "2019-11-08T19:45:33Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "Took out the WIP to run build",
      "created_at": "2019-11-08T19:52:02Z",
      "updated_at": "2019-11-08T19:52:02Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "While I'm waiting for the build:\r\n\r\n> Enter password:\r\n\r\nThat looks like a prompt. Is it possible there's a parameter now missing, or a certificate it's trying to use that requires a password?",
      "created_at": "2019-11-08T19:54:38Z",
      "updated_at": "2019-11-08T19:54:38Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "Reproduced this on my mac. The password is being prompted for when `Get-PfxCertificate` is invoked.",
      "created_at": "2019-11-08T23:08:24Z",
      "updated_at": "2019-11-08T23:08:24Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "Giving nothing for the password prompt here led to this error:\r\n\r\n```\r\nGet-PfxCertificate : MAC verification failed during PKCS12 import (wrong password?)\r\n```",
      "created_at": "2019-11-08T23:10:17Z",
      "updated_at": "2019-11-08T23:10:17Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "Also tried the protected certificate's password, and that didn't work",
      "created_at": "2019-11-08T23:13:49Z",
      "updated_at": "2019-11-08T23:13:49Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "I've now debugged this and trying to read the certificate without a password is throwing an exception:\r\n\r\n```\r\n{Interop+AppleCrypto+AppleCommonCryptoCryptographicException: MAC verification failed during PKCS12 import (wrong password?)\r\n   at Interop.AppleCrypto.X509ImportCertificate(Byte[] bytes, X509ContentType contentType, SafePasswordHandle importPassword, SafeKeychainHandle keychain, Boolean exportable, SafeSecIdentityHandle& identityHandle)\r\n   at Internal.Cryptography.Pal.AppleCertificatePal.FromBlob(Byte[] rawData, SafePasswordHandle password, X509KeyStorageFlags keyStorageFlags)\r\n   at System.Security.Cryptography.X509Certificates.X509Certificate..ctor(String fileName, SecureString password, X509KeyStorageFlags keyStorageFlags)\r\n   at System.Security.Cryptography.X509Certificates.X509Certificate2..ctor(String fileName, SecureString password, X509KeyStorageFlags keyStorageFlags)\r\n   at Microsoft.PowerShell.Commands.GetPfxCertificateCommand.GetCertFromPfxFile(String path, SecureString password) in /Users/rjmholt/Documents/Dev/Microsoft/PowerShell/src/Microsoft.PowerShell.Security/security/CertificateCommands.cs:line 215\r\n   at Microsoft.PowerShell.Commands.GetPfxCertificateCommand.ProcessRecord() in /Users/rjmholt/Documents/Dev/Microsoft/PowerShell/src/Microsoft.PowerShell.Security/security/CertificateCommands.cs:line 148}\r\n```\r\n\r\n<img width=\"1396\" alt=\"Screen Shot 2019-11-08 at 15 55 07\" src=\"https://user-images.githubusercontent.com/7009879/68518289-27f8ca00-0240-11ea-94fd-9e89bf69ed5f.png\">\r\n\r\nIt seems like macOS thinks the certificate needs a password. Some ideas:\r\n\r\n- Something about how the certificate is created has been changed\r\n- There's something that now works on Catalina but not on Mojave (which I'm running)\r\n- There's a corefx bug\r\n- There's a macOS bug\r\n\r\nGiven that these tests pass without this PR, I'm not sure what to make of it.",
      "created_at": "2019-11-08T23:57:44Z",
      "updated_at": "2019-11-08T23:57:44Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@PoshChan  Please remind me in 24 hours",
      "created_at": "2020-05-21T22:58:01Z",
      "updated_at": "2020-05-21T22:58:01Z"
    },
    {
      "author": "PoshChan",
      "author_association": "COLLABORATOR",
      "body": "@TravisEz13, this is the reminder you requested 24 hours ago",
      "created_at": "2020-05-22T22:58:48Z",
      "updated_at": "2020-05-22T22:58:48Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as Review Needed because it has been there has not been any activity for **7 days**.\nMainainer, Please provide feedback and/or mark it as `Waiting on Author`",
      "created_at": "2020-05-30T02:00:14Z",
      "updated_at": "2020-05-30T02:00:14Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "Can you resolve the conflicts?",
      "created_at": "2020-05-30T17:35:51Z",
      "updated_at": "2020-05-30T17:35:51Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@PoshChan  Please remind me in 1 hour",
      "created_at": "2020-06-01T19:57:52Z",
      "updated_at": "2020-06-01T19:57:52Z"
    },
    {
      "author": "PoshChan",
      "author_association": "COLLABORATOR",
      "body": "@TravisEz13, this is the reminder you requested 1 hour ago",
      "created_at": "2020-06-01T20:58:05Z",
      "updated_at": "2020-06-01T20:58:05Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.1.0-preview.4` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.1.0-preview.4)\n",
      "created_at": "2020-06-25T19:06:53Z",
      "updated_at": "2020-06-25T19:06:53Z"
    }
  ],
  "created_at": "2019-09-25T10:16:40Z",
  "number": 10622,
  "state": "closed",
  "title": "Bring back Certificate provider parameters",
  "updated_at": "2020-06-25T19:06:53Z"
}