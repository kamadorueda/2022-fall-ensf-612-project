{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17153",
  "author": "t00",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nOn Amazon EC2 linux:\r\n```\r\nsudo yum install -y powershell gssntlmssp\r\nsudo pwsh -Command 'Install-Module -Name PSWSMan'\r\nsudo pwsh -Command 'Install-WSMan'\r\n```\r\n\r\nOn Windows instance:\r\nSet up remote powershell access and open ports 5985-5986.\r\n\r\nCreate a file which is over 284715 bytes and pwsh to run commands:\r\n\r\n```\r\ndd if=/dev/zero of=./test count=1 bs=284716\r\npwsh\r\nPS> $pass = ConvertTo-SecureString \"MyPassword\" -AsPlainText -Force\r\nPS> $cred = New-Object System.Management.Automation.PSCredential (\"SERVERNAME\\Administrator\", $pass)\r\nPS> $ses = New-PSSession -ComputerName myserver.company.com -Credential $cred\r\nPS> Copy-Item \"./test\" -Destination \"C:\\inetpub\\Website\\\" -ToSession $ses -Recurse -Force\r\n```\r\n\n\n### Expected behavior\n\n```console\nCopying progress indicator, no error.\n```\n\n\n### Actual behavior\n\n```console\nCopying stuck on:\r\nCopying /home/user/test to C:/inetpub\u2026 [From localhost to myserver.company.com                ]\r\n\r\nNo progress, stops only on: killall -9 pwsh\n```\n\n\n### Error details\n\n```console\nA lot of messages related to futex in strace:\r\n\r\n\r\nfutex(0x7f0c652145e8, FUTEX_WAKE_PRIVATE, 1) = 0\r\nfutex(0x7f0c652145e8, FUTEX_WAKE_PRIVATE, 1) = 0\r\nfutex(0x558e3f6e15a8, FUTEX_WAIT_PRIVATE, 2, NULL) = -1 EAGAIN (Resource temporarily unavailable)\r\nfutex(0x558e3f6e15a8, FUTEX_WAKE_PRIVATE, 1) = 0\r\nmprotect(0x7f0c69fc5000, 4096, PROT_READ|PROT_WRITE) = 0\r\nmadvise(0x7f0c69fc5000, 4096, MADV_DODUMP) = 0\r\nfutex(0x558e3f6e15f8, FUTEX_WAKE_PRIVATE, 1) = 1\r\nmprotect(0x7f0c69fc6000, 4096, PROT_READ|PROT_WRITE) = 0\r\nmadvise(0x7f0c69fc6000, 4096, MADV_DODUMP) = 0\r\nfutex(0x558e3f6e15fc, FUTEX_WAKE_PRIVATE, 1) = 1\r\nmprotect(0x7f0c69fc7000, 4096, PROT_READ|PROT_WRITE) = 0\r\nmadvise(0x7f0c69fc7000, 4096, MADV_DODUMP) = 0\r\nfutex(0x558e3f6e15f8, FUTEX_WAKE_PRIVATE, 1) = 1\r\nfutex(0x558e3f6e15fc, FUTEX_WAIT_PRIVATE, 0, NULL) = -1 EAGAIN (Resource temporarily unavailable)\r\nfutex(0x558e3f6e15a8, FUTEX_WAKE_PRIVATE, 1) = 0\r\nfutex(0x7f0cde7dd404, FUTEX_WAIT_PRIVATE, 0, NULL) = -1 EAGAIN (Resource temporarily unavailable)\r\nfutex(0x7f0cde7dd3b0, FUTEX_WAKE_PRIVATE, 1) = 0\r\nmprotect(0x7f0c30420000, 65536, PROT_READ|PROT_WRITE) = 0\r\nmadvise(0x7f0c30420000, 65536, MADV_DODUMP) = 0\r\nmprotect(0x7f0c69fca000, 4096, PROT_READ|PROT_WRITE) = 0\r\nmadvise(0x7f0c69fca000, 4096, MADV_DODUMP) = 0\r\nfutex(0x558e3f6e15f8, FUTEX_WAKE_PRIVATE, 1) = 1\r\nfutex(0x558e3f7a4ca0, FUTEX_WAKE_PRIVATE, 1) = 0\r\nfutex(0x558e3f7a4ca0, FUTEX_WAKE_PRIVATE, 1) = 0\r\ngetpid()                                = 26496\r\nsendto(49, \"<134>Apr 14 17:19:47 powershell[\"..., 173, MSG_NOSIGNAL, NULL, 0) = 173\r\nmprotect(0x7f0c69fba000, 4096, PROT_READ|PROT_WRITE) = 0\r\nmadvise(0x7f0c69fba000, 4096, MADV_DODUMP) = 0\r\nmprotect(0x7f0c69eae000, 4096, PROT_READ|PROT_WRITE) = 0\r\nmadvise(0x7f0c69eae000, 4096, MADV_DODUMP) = 0\r\nmprotect(0x7f0c69eae000, 4096, PROT_READ|PROT_WRITE|PROT_EXEC) = 0\r\nfutex(0x558e3f73afe4, FUTEX_WAKE_PRIVATE, 1) = 1\r\nfutex(0x558e3f73af90, FUTEX_WAKE_PRIVATE, 1) = 1\r\nlstat(\"/opt/microsoft/powershell/7/profile.ps1\", 0x7ffc35e5ce40) = -1 ENOENT (No such file or directory)\r\nlstat(\"/opt/microsoft/powershell/7/Microsoft.PowerShell_profile.ps1\", 0x7ffc35e5ce40) = -1 ENOENT (No such file or directory)\r\nlstat(\"/var/lib/jenkins/.config/powershell/profile.ps1\", 0x7ffc35e5ce40) = -1 ENOENT (No such file or directory)\r\nlstat(\"/var/lib/jenkins/.config/powershell/Microsoft.PowerShell_profile.ps1\", 0x7ffc35e5ce40) = -1 ENOENT (No such file or directory)\r\nfutex(0x558e3f6b3488, FUTEX_WAKE_PRIVATE, 1) = 0\r\nfutex(0x558e3f6b3488, FUTEX_WAKE_PRIVATE, 1) = 0\r\nfutex(0x7f0c64534790, FUTEX_WAKE_PRIVATE, 1) = 0\r\nfutex(0x7f0c64534740, FUTEX_WAKE_PRIVATE, 1) = 1\r\nmprotect(0x7f0c69fd2000, 4096, PROT_READ|PROT_WRITE) = 0\r\nmadvise(0x7f0c69fd2000, 4096, MADV_DODUMP) = 0\r\nfutex(0x7f0cde809728, FUTEX_WAKE_PRIVATE, 1) = 1\r\nfutex(0x558e3f6b34dc, FUTEX_WAIT_PRIVATE, 0, NULL) = -1 EAGAIN (Resource temporarily unavailable)\r\nfutex(0x558e3f6b3488, FUTEX_WAKE_PRIVATE, 1) = 0\r\nfutex(0x558e3f7d8d24, FUTEX_WAKE_PRIVATE, 1) = 1\r\nfutex(0x7f0c652145e8, FUTEX_WAKE_PRIVATE, 1) = 0\r\nfutex(0x7f0c652145e8, FUTEX_WAKE_PRIVATE, 1) = 0\r\nfutex(0x7f0c652145e8, FUTEX_WAIT_PRIVATE, 2, NULL) = -1 EAGAIN (Resource temporarily unavailable)\r\nfutex(0x7f0c65214638, FUTEX_WAKE_PRIVATE, 1) = 1\r\nfutex(0x7f0c652145e8, FUTEX_WAKE_PRIVATE, 1) = 0\r\nfutex(0x7f0c6521463c, FUTEX_WAIT_PRIVATE, 0, NULL) = -1 EAGAIN (Resource temporarily unavailable)\r\nfutex(0x7f0c652145e8, FUTEX_WAKE_PRIVATE, 1) = 0\r\nmmap(NULL, 10006528, PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_STACK, -1, 0) = 0x7f0c2de70000\r\nmprotect(0x7f0c2de71000, 10002432, PROT_READ|PROT_WRITE) = 0\r\nclone(child_stack=0x7f0c2e7f9fb0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tidptr=0x7f0c2e7fa9d0, tls=0x7f0c2e7fa700, child_tidptr=0x7f0c2e7fa9d0) = 26532\r\nfutex(0x558e3f915d30, FUTEX_WAIT_PRIVATE, 0, NULL) = 0\r\nfutex(0x558e3f915ce0, FUTEX_WAKE_PRIVATE, 1) = 0\r\ngetpid()                                = 26496\r\nopen(\"/proc/self/task/26532/comm\", O_RDWR) = 110\r\nwrite(110, \"Pipeline Execut\", 15)       = 15\r\nclose(110)                              = 0\r\nsched_getparam(26532, [0])              = 0\r\nsched_getscheduler(26532)               = 0 (SCHED_OTHER)\r\nsched_get_priority_max(SCHED_OTHER)     = 0\r\nsched_get_priority_min(SCHED_OTHER)     = 0\r\nsched_setscheduler(26532, SCHED_OTHER, [0]) = 0\r\nwrite(109, \"*\", 1)                      = 1\r\nsched_yield()                           = 0\r\nfutex(0x558e3f6eab80, FUTEX_WAIT_PRIVATE, 0, NULL\r\nCopying /home/user/test to C:/inetpub\u2026 [From localhost to myserver.company.com                 ]\r\n```\n```\n\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.2\r\nPSEdition                      Core\r\nGitCommitId                    7.2.2\r\nOS                             Linux 5.10.102-99.473.amzn2.x86_64 #1 SMP Wed Mar 2 19:14:12 UTC 2022\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\nuname -a\r\nLinux ip-10-0-0-171.eu-west-2.compute.internal 5.10.102-99.473.amzn2.x86_64 #1 SMP Wed Mar 2 19:14:12 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": null,
  "comments": [
    {
      "author": "t00",
      "author_association": "NONE",
      "body": "Please find below remote environment data obtained while connected to a session using Enter-PSSession:\r\n\r\n```\r\nName                           Value                                                                                                                                                                  \r\n----                           -----                                                                                                                                                                  \r\nPSVersion                      5.1.14393.4583                                                                                                                                                         \r\nPSEdition                      Desktop                                                                                                                                                                \r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}                                                                                                                                                \r\nBuildVersion                   10.0.14393.4583                                                                                                                                                        \r\nCLRVersion                     4.0.30319.42000                                                                                                                                                        \r\nWSManStackVersion              3.0                                                                                                                                                                    \r\nPSRemotingProtocolVersion      2.3                                                                                                                                                                    \r\nSerializationVersion           1.1.0.1                 \r\n```\r\n\r\nAbove copy operation works fine when connecting from a Windows machine.",
      "created_at": "2022-04-19T09:43:08Z",
      "updated_at": "2022-04-19T09:43:42Z"
    },
    {
      "author": "menasheh",
      "author_association": "NONE",
      "body": "This makes PowerShell useless in the context of deployment scripts to windows servers.",
      "created_at": "2022-06-01T20:37:32Z",
      "updated_at": "2022-06-01T20:37:32Z"
    },
    {
      "author": "t00",
      "author_association": "NONE",
      "body": "@SeeminglyScience Do you possibly have any updates on the issue? I am using scp as a workaround; is pwsh data stream channel even suitable to handle arbitrarily large data or maybe it is recommended to use it for pushing a remotely executed script only, hence the limitation? More important, why it works on Windows while on Linux transfer fails?\r\n",
      "created_at": "2022-08-23T18:13:35Z",
      "updated_at": "2022-08-23T18:13:35Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "WSMan is not officially supported on Unix.\r\n\r\nYou should try SSH.",
      "created_at": "2022-08-24T04:40:15Z",
      "updated_at": "2022-08-24T04:40:15Z"
    }
  ],
  "created_at": "2022-04-14T17:22:07Z",
  "number": 17153,
  "state": "open",
  "title": "pwsh on Linux freezes when trying to copy a file larger than 284715 bytes to a Windows server",
  "updated_at": "2022-08-24T04:40:16Z"
}