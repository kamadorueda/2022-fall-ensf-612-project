{
  "_url": "https://github.com/PowerShell/PowerShell/issues/7305",
  "author": "daxian-dbw",
  "body": "## PR Summary\r\n\r\nFix #7150\r\n\r\n- Make switch-statement report correct error position when it fails to evaluate the condition.\r\n- Make for-statement report correct error position when it fails to evaluate the initializer.\r\n\r\n**Before:**\r\n```powershell\r\nPS> $test = 1; switch ($null[0]) { default {} }\r\nCannot index into a null array.\r\nAt line:1 char:1\r\n+ $test = 1; switch ($null[0]) { default {} }\r\n+ ~~~~~~~~~\r\n+ CategoryInfo          : InvalidOperation: (:) [], RuntimeException\r\n+ FullyQualifiedErrorId : NullArray\r\n\r\nPS> $test = 1; for ($null[0];;) {}\r\nCannot index into a null array.\r\nAt line:1 char:1\r\n+ $test = 1; for ($null[0];;) {}\r\n+ ~~~~~~~~~\r\n+ CategoryInfo          : InvalidOperation: (:) [], RuntimeException\r\n+ FullyQualifiedErrorId : NullArray\r\n```\r\n**After:**\r\n```powershell\r\nPS> $test = 1; switch ($null[0]) { default {} }\r\nCannot index into a null array.\r\nAt line:1 char:20\r\n+ $test = 1; switch ($null[0]) { default {} }\r\n+                    ~~~~~~~~\r\n+ CategoryInfo          : InvalidOperation: (:) [], RuntimeException\r\n+ FullyQualifiedErrorId : NullArray\r\n\r\nPS> $test = 1; for ($null[0];;) {}\r\nCannot index into a null array.\r\nAt line:1 char:17\r\n+ $test = 1; for ($null[0];;) {}\r\n+                 ~~~~~~~~\r\n+ CategoryInfo          : InvalidOperation: (:) [], RuntimeException\r\n+ FullyQualifiedErrorId : NullArray\r\n```\r\n\r\n### Break point check\r\n\r\n#### For switch-statement condition, retain the same behavior as is:\r\n\r\n**Script Content**\r\n```powershell\r\nPS> cat .\\about2.ps1\r\n$Test = 1..2\r\nswitch ($Test)\r\n{\r\n    default {'a'}\r\n}\r\n```\r\n\r\n```powershell\r\nPS> .\\about2.ps1\r\nEntering debug mode. Use h or ? for help.\r\n\r\nHit Line breakpoint on 'F:\\tmp\\about2.ps1:1'\r\n\r\nAt F:\\tmp\\about2.ps1:1 char:1\r\n+ $Test = 1..2\r\n+ ~~~~~~~~~~~~\r\nPS>> v\r\nAt F:\\tmp\\about2.ps1:2 char:9\r\n+ switch ($Test)\r\n+         ~~~~~\r\nPS>> v\r\nAt F:\\tmp\\about2.ps1:4 char:14\r\n+     default {'a'}\r\n+              ~~~\r\nPS>> v\r\na\r\nAt F:\\tmp\\about2.ps1:2 char:9\r\n+ switch ($Test)\r\n+         ~~~~~\r\nPS>> v\r\nAt F:\\tmp\\about2.ps1:4 char:14\r\n+     default {'a'}\r\n+              ~~~\r\nPS>> v\r\na\r\nAt F:\\tmp\\about2.ps1:2 char:9\r\n+ switch ($Test)\r\n+         ~~~~~\r\nPS>> v\r\n```\r\n\r\n#### For for-statement initializer, fix the incorrect breaking point position when the initializer is a simple command expression:\r\n\r\n**Script Content**\r\n```powershell\r\nPS> cat .\\about2.ps1\r\n$i = 1\r\nfor ('str'.Length;\r\n     $i -gt 0; $i--)\r\n{\r\n    \"v\"\r\n}\r\n```\r\n\r\n**Before:**\r\n```powershell\r\nPS> .\\about2.ps1\r\nHit Line breakpoint on 'F:\\tmp\\about2.ps1:1'\r\n\r\nAt F:\\tmp\\about2.ps1:1 char:1\r\n+ $i = 1\r\n+ ~~~~~~\r\nPS>> v\r\nAt F:\\tmp\\about2.ps1:3 char:6\r\n+      $i -gt 0; $i--)\r\n+      ~~~~~~~~\r\nPS>> v\r\nAt F:\\tmp\\about2.ps1:5 char:5\r\n+     \"v\"\r\n+     ~~~\r\nPS>> v\r\nv\r\nAt F:\\tmp\\about2.ps1:3 char:16\r\n+      $i -gt 0; $i--)\r\n+                ~~~~\r\nPS:40>> v\r\nAt F:\\tmp\\about2.ps1:3 char:6\r\n+      $i -gt 0; $i--)\r\n+      ~~~~~~~~\r\nPS>> v\r\n```\r\n\r\n**After:**\r\n```powershell\r\nPS> .\\about2.ps1\r\nHit Line breakpoint on 'F:\\tmp\\about2.ps1:1'\r\n\r\nAt F:\\tmp\\about2.ps1:1 char:1\r\n+ $i = 1\r\n+ ~~~~~~\r\nPS>> v\r\nAt F:\\tmp\\about2.ps1:2 char:6\r\n+ for ('str'.Length;\r\n+      ~~~~~~~~~~~~\r\nPS>> v\r\nAt F:\\tmp\\about2.ps1:3 char:6\r\n+      $i -gt 0; $i--)\r\n+      ~~~~~~~~\r\nPS>> v\r\nAt F:\\tmp\\about2.ps1:5 char:5\r\n+     \"v\"\r\n+     ~~~\r\nPS>> v\r\nv\r\nAt F:\\tmp\\about2.ps1:3 char:16\r\n+      $i -gt 0; $i--)\r\n+                ~~~~\r\nPS>> v\r\nAt F:\\tmp\\about2.ps1:3 char:6\r\n+      $i -gt 0; $i--)\r\n+      ~~~~~~~~\r\nPS>> v\r\n```\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [ ] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` to the beginning of the title and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [ ] Not Applicable\r\n    - **OR**\r\n    - [x] User-facing [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [x] Issue filed - Issue link:\r\n- **Testing - New and feature**\r\n    - [ ] Not Applicable or can only be tested interactively\r\n    - **OR**\r\n    - [x] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [x] [Add `[feature]` if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n",
  "closed_at": "2018-07-25T16:56:33Z",
  "comments": [
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@BrucePay Can you please review this PR when you have time? Thanks!",
      "created_at": "2018-07-19T23:38:14Z",
      "updated_at": "2018-07-19T23:38:14Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@SteveL-MSFT I corrected the condition sequence point update for while/do-while/do-until loops and if-statement as well. More tests are added. Please take another look when you have time. Thanks!",
      "created_at": "2018-07-23T22:28:20Z",
      "updated_at": "2018-07-23T22:28:20Z"
    }
  ],
  "created_at": "2018-07-18T01:03:29Z",
  "number": 7305,
  "state": "closed",
  "title": "Fix error position for switch-statement condition and for-statement initializer",
  "updated_at": "2018-07-25T16:56:41Z"
}