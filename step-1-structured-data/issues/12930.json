{
  "_url": "https://github.com/PowerShell/PowerShell/issues/12930",
  "author": "vexx32",
  "body": "# PR Summary\r\n\r\nPermits the following syntax:\r\n\r\n```ps1\r\n$scriptblock = { Write-Host 'event triggered' }\r\n$ps = [powershell]::Create()\r\n# Add event handler\r\n$ps.InvocationStateChanged += $scriptblock\r\n\r\n# Remove event handler\r\n$ps.InvocationStateChanged -= $scriptblock\r\n```\r\n\r\n## Changes\r\n\r\n- Expose `PSEvent` static and instance members of classes & enable tab completion for them.\r\n- Add handling in the compiler to bind event (de)registration for `-=` or `+=` only if the LHS is a `MemberExpressionAst`, combined with a runtime check for the LHS value being `PSEvent`.\r\n- Add a new binder type which will map the event member to its add/remove method as appropriate and then offload to `PSInvokeMemberBinder` with that method name.\r\n\r\n## PR Context\r\n\r\nSee #12926 for some additional context, but my thoughts are essentially: events are currently not discoverable and very annoying to work with in PowerShell, sometimes requiring reliance on implementation details.\r\n\r\nI do not believe this can be considered a breaking change, since the only place it applies is specifically for event members, which were previously pretty much entirely inaccessible prior to this change.\r\n\r\nResolves #12926 \r\n\r\nWith respect to tooling, there shouldn't be any breaking points, but event members will be offered in tab completion results with these changes, which may be considered unexpected in some circumstances.\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [x] None\r\n    - **OR**\r\n    - [ ] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n        - [ ] Experimental feature name(s): <!-- Experimental feature name(s) here -->\r\n- **User-facing changes**\r\n    - [ ] Not Applicable\r\n    - **OR**\r\n    - [x] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n- **Testing - New and feature**\r\n    - [ ] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [x] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [ ] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [x] I have considered the user experience from a tooling perspective and enumerated concerns in the summary. This may include:\r\n        - Impact on [PowerShell Editor Services](https://github.com/PowerShell/PowerShellEditorServices) which is used in the [PowerShell extension](https://github.com/PowerShell/vscode-powershell) for VSCode (which runs in a different PS Host).\r\n        - Impact on Completions (both in the console and in editors) - one of PowerShell's most powerful features.\r\n        - Impact on [PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer) (which provides linting & formatting in the editor extensions).\r\n        - Impact on [EditorSyntax](https://github.com/PowerShell/EditorSyntax) (which provides syntax highlighting with in VSCode, GitHub, and many other editors).\r\n",
  "closed_at": null,
  "comments": [
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@TravisEz13 is it intentional that test results do not appear to be publicly viewable anywhere? Azure Pipelines reports a test pass percentage, but all the links lead to a blank page, and the Tests tab is missing from those pipeline jobs.\r\n\r\nThe few tests I could find failing in the log don't appear related at all, but I couldn't find all of them (and I'm not sure if there's a different way I need to be re-running failed jobs at the moment, too).",
      "created_at": "2020-06-10T04:48:17Z",
      "updated_at": "2020-06-10T04:48:17Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@vexx32 There is a reference to test results\r\n![image](https://user-images.githubusercontent.com/22290914/84228317-2b1ea600-ab00-11ea-8a7c-77c996ca5bc0.png)\r\n",
      "created_at": "2020-06-10T04:53:19Z",
      "updated_at": "2020-06-10T04:53:19Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@vexx32 There seems to be some change to Azure DevOps.  The actual pipeline was not changed at all.  The Azure DevOps app was just installed to allow integration with more GitHub bots.  I suggest opening feedback in Azure DevOps, filing an issue with the link and mentioning me.  I can follow up from there.",
      "created_at": "2020-06-10T05:01:55Z",
      "updated_at": "2020-06-10T05:01:55Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@iSazonov yep! But I can only see the log files, which lack any kind of summary as to exactly which failed. The logs are thousands of lines long, surely we're not expected to painfully read through all of them for a few tiny `-` characters and attempt to infer which tests might have failed. \ud83e\udd14 \r\n\r\nOh, hold on... okay on one of the result pages I can see it, but the Azure Pipelines pages themselves don't seem to have a proper summary of results from what I can see.",
      "created_at": "2020-06-10T05:02:01Z",
      "updated_at": "2020-06-10T05:02:01Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@vexx32  I can definitely see the logs though, in an incognito window.  Just the test tab is gone.",
      "created_at": "2020-06-10T05:07:05Z",
      "updated_at": "2020-06-10T05:07:22Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@vexx32 we have moved to stage build for windows a long time ago...  We moved the rest of the pipelines to stages... You may just be seeing the stage GUI and not be used to it.\r\n![image](https://user-images.githubusercontent.com/10873629/84229215-e06c4200-aa9d-11ea-8894-192606771b0a.png)\r\nYou have to click into the failed stage to see the results.",
      "created_at": "2020-06-10T05:09:48Z",
      "updated_at": "2020-06-10T05:09:48Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@TravisEz13 filed here: https://developercommunity.visualstudio.com/content/problem/1072124/individual-test-results-failures-not-shown-in-buil.html\r\n\r\nDidn't see any links pointing to a GH issues thing or anything, hopefully that's sufficient for now.\r\n\r\nYeah, that's about what I'm seeing. Makes it a bit tricky since our test output is very condensed and at most I just see rows of `+++++++` / `+++-+` marking individual tests passing/failing. Anyway, located the failing test for now... should have expected that one. \ud83d\ude01 \r\n\r\nI can see the stages and the logs individually, but... not super useful; tests tab just inexplicably gone \ud83d\ude42 \r\n\r\n<blockquote><img src=\"/themes/thub/images/favicon.ico\" width=\"48\" align=\"right\"><div><strong><a href=\"https://developercommunity.visualstudio.com/content/problem/1072124/individual-test-results-failures-not-shown-in-buil.html\">Individual Test Results / Failures not shown in build results - Developer Community</a></strong></div><div>Developer Community for Visual Studio Product family</div></blockquote>",
      "created_at": "2020-06-10T05:11:11Z",
      "updated_at": "2020-06-10T05:12:12Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@vexx32 to find failure search for `[-]`.  Going offline now...",
      "created_at": "2020-06-10T05:15:08Z",
      "updated_at": "2020-06-10T05:15:08Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "MacOS Failure is a known issue and not a new failure: https://github.com/PowerShell/PowerShell/issues/12935",
      "created_at": "2020-06-11T13:46:27Z",
      "updated_at": "2020-06-11T13:46:27Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as Review Needed because it has been there has not been any activity for **7 days**.\nMainainer, Please provide feedback and/or mark it as `Waiting on Author`",
      "created_at": "2020-06-18T14:00:16Z",
      "updated_at": "2020-06-18T14:00:16Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@daxian-dbw friendly ping for review \ud83d\ude0a ",
      "created_at": "2020-06-24T13:24:40Z",
      "updated_at": "2020-06-24T13:24:40Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "> @daxian-dbw friendly ping for review \ud83d\ude0a\r\n\r\nSorry for the delay ... reviewing this one now.",
      "created_at": "2020-08-04T19:33:06Z",
      "updated_at": "2020-08-04T19:33:06Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as Review Needed because it has been there has not been any activity for **7 days**.\nMaintainer, please provide feedback and/or mark it as `Waiting on Author`",
      "created_at": "2020-08-15T02:00:11Z",
      "updated_at": "2020-08-15T02:00:11Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@rjmholt @iSazonov is there anything left for me to do here? \ud83d\udc96 ",
      "created_at": "2020-11-11T17:53:52Z",
      "updated_at": "2020-11-11T17:53:52Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@vexx32 I am currently focusing on style fixes prior to the 7.1 release. I hope we have a couple of weeks for this.\r\n",
      "created_at": "2020-11-11T18:02:49Z",
      "updated_at": "2020-11-11T18:02:49Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "No worries, just wanted to make sure this didn't get forgotten about \ud83d\udc96 ",
      "created_at": "2020-11-11T18:15:46Z",
      "updated_at": "2020-11-11T18:15:46Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as Review Needed because it has been there has not been any activity for **7 days**.\nMaintainer, please provide feedback and/or mark it as `Waiting on Author`",
      "created_at": "2020-11-19T02:00:09Z",
      "updated_at": "2020-11-19T02:00:09Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@rjmholt @iSazonov  friendly ping for review \ud83d\ude42 ",
      "created_at": "2021-06-18T19:21:54Z",
      "updated_at": "2021-06-18T19:21:54Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@vexx32 I'm sorry, I'm out of the loop. The only thing I didn't see in the tests and what worries me is whether there is a problem with different Runspaces and threads?",
      "created_at": "2021-06-24T17:25:16Z",
      "updated_at": "2021-06-24T17:25:16Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@iSazonov Yes and no. The majority of cases will \"just work\" with the already built in eventing logic, really. This functionally works just the same as you can go ahead and call `$obj.add_<event-name>($scriptblock)` on any object that has event handlers already, or `Register-ObjectEvent`.\r\n\r\nGiven we already have a cmdlet, this could be considered essentially syntax sugar (with some added discoverability) for similar functionality. I think there are some slight differences, but I'll be honest and say I'm not 100% sure what those will end up being.\r\n\r\nMy general understanding is that scriptblocks tend to be runspace-bound, and as a result will generally run on the thread that registered the event initially, when that thread is able to run them. @daxian-dbw or @rjmholt may be more familiar with the underpinnings here.",
      "created_at": "2021-06-24T19:09:37Z",
      "updated_at": "2021-06-24T19:09:51Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@vexx32 Thanks for clarify!\r\n\r\n> Expose event members as actual object members, allowing their names to register for tab completion, and the PSEvent metadata to be shown to users accessing the event.\r\n\r\nIs this implemented? Have we tests for this?",
      "created_at": "2021-06-25T05:15:22Z",
      "updated_at": "2021-06-25T05:15:22Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "Aye, it is. There isn't an explicit test for it, come to think of it. The change to the tab completion test that comes back with `34` members instead of `33` now is a result of that, one of the members is an event.\r\n\r\nI'll add an explicit one this afternoon, I think I can use a stopwatch / timer as a simple object with events on it that I can query for proving out the tab completion.",
      "created_at": "2021-06-25T14:16:31Z",
      "updated_at": "2021-06-25T14:16:31Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@iSazonov I added the missing tab completion test. I also rebased to get this branch to pull in some of the newer changes and pass CI.",
      "created_at": "2021-06-26T01:50:24Z",
      "updated_at": "2021-06-26T01:50:24Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as Review Needed because it has been there has not been any activity for **7 days**.\nMaintainer, please provide feedback and/or mark it as `Waiting on Author`",
      "created_at": "2021-07-05T02:00:47Z",
      "updated_at": "2021-07-05T02:00:47Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@daxian-dbw Could you please review or make a conclusion about closing the PR?",
      "created_at": "2022-01-19T06:40:53Z",
      "updated_at": "2022-01-19T06:40:53Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "/rebase",
      "created_at": "2022-01-19T06:41:06Z",
      "updated_at": "2022-01-19T06:41:06Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as Review Needed because it has been there has not been any activity for **7 days**.\nMaintainer, please provide feedback and/or mark it as `Waiting on Author`",
      "created_at": "2022-01-26T14:00:50Z",
      "updated_at": "2022-01-26T14:00:50Z"
    }
  ],
  "created_at": "2020-06-10T04:01:04Z",
  "number": 12930,
  "state": "open",
  "title": "Compile += / -= to bind & handle event (de)registration directly",
  "updated_at": "2022-01-26T14:00:51Z"
}