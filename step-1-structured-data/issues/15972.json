{
  "_url": "https://github.com/PowerShell/PowerShell/issues/15972",
  "author": "sliekens",
  "body": "### Prerequisites\r\n\r\n- [X] Write a descriptive title.\r\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- [X] Search the existing issues.\r\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n\r\n### Steps to reproduce\r\n\r\nUsing Invoke-RestMethod with `-FollowRelLink` works when the server returns a Link header with relation type `rel=\"next\"`, but not when the relation type is `rel=next` without quotes, although [the Web Linking RFC](https://datatracker.ietf.org/doc/html/rfc5988#page-6) allows it. Quotes are only required under specific circumstances, never for [IANA relation types](https://www.iana.org/assignments/link-relations/link-relations.xhtml).\r\n\r\n```\r\n  relation-types = relation-type\r\n                 | <\"> relation-type *( 1*SP relation-type ) <\">\r\n  relation-type  = reg-rel-type | ext-rel-type\r\n  reg-rel-type   = LOALPHA *( LOALPHA | DIGIT | \".\" | \"-\" )\r\n  ext-rel-type   = URI\r\n```\r\n\r\n> Note that extension relation types are REQUIRED to be absolute URIs in Link headers, and MUST be quoted if they contain a semicolon (\";\") or comma (\",\") (as these characters are used as delimiters in the header itself).\r\n\r\nThe Regex pattern can be found here. https://github.com/PowerShell/PowerShell/blob/e70ad6ce251d2e1d4ef79e31756cededde7ccc91/src/Microsoft.PowerShell.Commands.Utility/commands/utility/WebCmdlet/Common/WebRequestPSCmdlet.Common.cs#L1833\r\n\r\n### Expected behavior\r\n\r\n```console\r\nPS> Invoke-RestMethod \"https://api.guildwars2.com/v2/quaggans?page=0&page_size=10\" -FollowRelLink\r\n\r\nid           url\r\n--           ---\r\n404          https://static.staticwars.com/quaggans/404.jpg\r\naloha        https://static.staticwars.com/quaggans/aloha.jpg\r\nattack       https://static.staticwars.com/quaggans/attack.jpg\r\nbear         https://static.staticwars.com/quaggans/bear.jpg\r\nbowl         https://static.staticwars.com/quaggans/bowl.jpg\r\nbox          https://static.staticwars.com/quaggans/box.jpg\r\nbreakfast    https://static.staticwars.com/quaggans/breakfast.jpg\r\nbubble       https://static.staticwars.com/quaggans/bubble.jpg\r\ncake         https://static.staticwars.com/quaggans/cake.jpg\r\ncheer        https://static.staticwars.com/quaggans/cheer.jpg\r\ncoffee       https://static.staticwars.com/quaggans/coffee.jpg\r\nconstruction https://static.staticwars.com/quaggans/construction.jpg\r\ncow          https://static.staticwars.com/quaggans/cow.jpg\r\ncry          https://static.staticwars.com/quaggans/cry.jpg\r\nelf          https://static.staticwars.com/quaggans/elf.jpg\r\nghost        https://static.staticwars.com/quaggans/ghost.jpg\r\ngirl         https://static.staticwars.com/quaggans/girl.jpg\r\nhat          https://static.staticwars.com/quaggans/hat.jpg\r\nhelmut       https://static.staticwars.com/quaggans/helmut.jpg\r\nhoodie-down  https://static.staticwars.com/quaggans/hoodie-down.jpg\r\nhoodie-up    https://static.staticwars.com/quaggans/hoodie-up.jpg\r\nkillerwhale  https://static.staticwars.com/quaggans/killerwhale.jpg\r\nknight       https://static.staticwars.com/quaggans/knight.jpg\r\nlollipop     https://static.staticwars.com/quaggans/lollipop.jpg\r\nlost         https://static.staticwars.com/quaggans/lost.jpg\r\nmoving       https://static.staticwars.com/quaggans/moving.jpg\r\nparty        https://static.staticwars.com/quaggans/party.jpg\r\npresent      https://static.staticwars.com/quaggans/present.jpg\r\nquaggan      https://static.staticwars.com/quaggans/quaggan.jpg\r\nrain         https://static.staticwars.com/quaggans/rain.jpg\r\nscifi        https://static.staticwars.com/quaggans/scifi.jpg\r\nseahawks     https://static.staticwars.com/quaggans/seahawks.jpg\r\nsleep        https://static.staticwars.com/quaggans/sleep.jpg\r\nsummer       https://static.staticwars.com/quaggans/summer.jpg\r\nvacation     https://static.staticwars.com/quaggans/vacation.jpg\r\n```\r\n\r\n\r\n### Actual behavior\r\n\r\n```console\r\nPS> Invoke-RestMethod \"https://api.guildwars2.com/v2/quaggans?page=0&page_size=10\" -FollowRelLink\r\n\r\nid        url\r\n--        ---\r\n404       https://static.staticwars.com/quaggans/404.jpg\r\naloha     https://static.staticwars.com/quaggans/aloha.jpg\r\nattack    https://static.staticwars.com/quaggans/attack.jpg\r\nbear      https://static.staticwars.com/quaggans/bear.jpg\r\nbowl      https://static.staticwars.com/quaggans/bowl.jpg\r\nbox       https://static.staticwars.com/quaggans/box.jpg\r\nbreakfast https://static.staticwars.com/quaggans/breakfast.jpg\r\nbubble    https://static.staticwars.com/quaggans/bubble.jpg\r\ncake      https://static.staticwars.com/quaggans/cake.jpg\r\ncheer     https://static.staticwars.com/quaggans/cheer.jpg\r\n```\r\n\r\n\r\n### Error details\r\n\r\n_No response_\r\n\r\n### Environment data\r\n\r\n```powershell\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.4\r\nPSEdition                      Core\r\nGitCommitId                    7.1.4\r\nOS                             Microsoft Windows 10.0.19043\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\n\r\n### Visuals\r\n\r\n![image](https://user-images.githubusercontent.com/1583241/130359652-208d0c65-713c-4939-a79f-424b1eea4666.png)\r\n\r\n",
  "closed_at": "2021-08-26T22:11:16Z",
  "comments": [
    {
      "author": "sliekens",
      "author_association": "CONTRIBUTOR",
      "body": "This is caused by the lazy `.*?` expression in the _rel_ capturing group. If the numbered capturing group for the quote is empty, then the _rel_ named group will also be empty (because the shortest possible match for `.*` is the empty string itself).\r\n\r\n```\r\n// Always results in an empty match when the quote is missing\r\n(\\\"?)(?<rel>.+*)\\1\r\n```\r\n\r\nI came up with this pattern that uses conditional expressions instead of trying to match an empty capturing group.\r\n\r\n```\r\n<(?<url>.*?)>;\\s*rel=(?<quoted>\")?(?<rel>(?(quoted).*?|[^,;]*))(?(quoted)\")\r\n```\r\n\r\nI tested the pattern with quotes and without quotes, both work now.\r\n\r\nWith quotes\r\n\r\n![image](https://user-images.githubusercontent.com/1583241/130362914-c75101f5-4296-4fc0-acee-474f72a86f4c.png)\r\n\r\nWithout quotes\r\n\r\n![image](https://user-images.githubusercontent.com/1583241/130362922-d5ffc533-12c3-42f1-847a-0bc0acd1ed9b.png)\r\n\r\n\r\n",
      "created_at": "2021-08-22T16:15:09Z",
      "updated_at": "2021-08-22T16:35:06Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:This issue was addressed in #15973, which has now been successfully released as `v7.3.0-preview.1`.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.3.0-preview.1)\n",
      "created_at": "2021-12-16T20:00:30Z",
      "updated_at": "2021-12-16T20:00:30Z"
    }
  ],
  "created_at": "2021-08-22T14:45:40Z",
  "number": 15972,
  "state": "closed",
  "title": "Invoke-RestMethod: Link relation type is not captured by Regex when value is not quoted",
  "updated_at": "2021-12-16T20:00:30Z"
}