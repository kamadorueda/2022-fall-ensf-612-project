{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17866",
  "author": "YuxinHan258",
  "body": "### Prerequisites\r\n\r\n- [X] Write a descriptive title.\r\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- [X] Search the existing issues.\r\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n\r\n### Steps to reproduce\r\n\r\n(After installation, open the error message) \u5b89\u88c5\u540e\uff0c\u6253\u5f00\u62a5\u9519\r\n\r\n\r\n\r\nPowerShell 7.2.5\r\nCopyright (c) Microsoft Corporation.\r\n\r\nhttps://aka.ms/powershell\r\nType 'help' to get help.\r\n\r\nFatal error. System.AccessViolationException: Attempted to read or write protected memory. This is often an indication that other memory is corrupt.\r\n   at System.Management.Automation.AmsiUtils+AmsiNativeMethods.AmsiCloseSession(IntPtr, IntPtr)\r\n   at System.Management.Automation.AmsiUtils.WinCloseSession()\r\n   at System.Management.Automation.Runspaces.PipelineBase..ctor(System.Management.Automation.Runspaces.Runspace, System.Management.Automation.Runspaces.CommandCollection, Boolean, Boolean, System.Management.Automation.Internal.ObjectStreamBase, System.Management.Automation.Internal.ObjectStreamBase, System.Management.Automation.Internal.ObjectStreamBase, System.Management.Automation.PSInformationalBuffers)\r\n   at System.Management.Automation.PowerShell+Worker.ConstructPipelineAndDoWork(System.Management.Automation.Runspaces.Runspace, Boolean)\r\n   at System.Management.Automation.PowerShell+Worker.CreateRunspaceIfNeededAndDoWork(System.Management.Automation.Runspaces.Runspace, Boolean)\r\n   at System.Management.Automation.PowerShell.CoreInvokeHelper[[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]](System.Management.Automation.PSDataCollection`1<System.__Canon>, System.Management.Automation.PSDataCollection`1<System.__Canon>, System.Management.Automation.PSInvocationSettings)\r\n   at System.Management.Automation.PowerShell.CoreInvoke[[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]](System.Management.Automation.PSDataCollection`1<System.__Canon>, System.Management.Automation.PSDataCollection`1<System.__Canon>, System.Management.Automation.PSInvocationSettings)\r\n   at System.Management.Automation.PowerShell.CoreInvoke[[System.__Canon, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]](System.Collections.IEnumerable, System.Management.Automation.PSDataCollection`1<System.__Canon>, System.Management.Automation.PSInvocationSettings)\r\n   at System.Management.Automation.PowerShell.Invoke(System.Collections.IEnumerable, System.Management.Automation.PSInvocationSettings)\r\n   at System.Management.Automation.Runspaces.InitialSessionState.ProcessOneModule(System.Management.Automation.Runspaces.Runspace, System.String, System.Management.Automation.PSModuleInfo, System.String, System.Collections.Generic.HashSet`1<System.Management.Automation.CommandInfo>)\r\n   at System.Management.Automation.Runspaces.InitialSessionState.ProcessModulesToImport(System.Management.Automation.Runspaces.Runspace, System.Collections.IEnumerable, System.String, System.Collections.Generic.HashSet`1<System.Management.Automation.CommandInfo>, System.Collections.Generic.HashSet`1<System.String>)\r\n   at System.Management.Automation.Runspaces.InitialSessionState.BindRunspace(System.Management.Automation.Runspaces.Runspace, System.Management.Automation.PSTraceSource)\r\n   at System.Management.Automation.Runspaces.LocalRunspace.DoOpenHelper()\r\n   at System.Management.Automation.Runspaces.LocalRunspace.OpenHelper(Boolean)\r\n   at System.Management.Automation.Runspaces.RunspaceBase.CoreOpen(Boolean)\r\n   at System.Management.Automation.Runspaces.RunspaceBase.Open()\r\n   at Microsoft.PowerShell.ConsoleHost.OpenConsoleRunspace(System.Management.Automation.Runspaces.Runspace, Boolean)\r\n   at Microsoft.PowerShell.ConsoleHost.DoCreateRunspace(System.String, Boolean, Boolean, System.String, System.Collections.ObjectModel.Collection`1<System.Management.Automation.Runspaces.CommandParameter>)\r\n   at Microsoft.PowerShell.ConsoleHost.CreateRunspace(System.Object)\r\n   at Microsoft.PowerShell.ConsoleHost.DoRunspaceLoop(System.String, Boolean, System.Collections.ObjectModel.Collection`1<System.Management.Automation.Runspaces.CommandParameter>, Boolean, System.String)\r\n   at Microsoft.PowerShell.ConsoleHost.Run(Microsoft.PowerShell.CommandLineParameterParser, Boolean)\r\n   at Microsoft.PowerShell.ConsoleHost.Start(System.String, System.String)\r\n   at Microsoft.PowerShell.UnmanagedPSEntry.Start(System.String[], Int32)\r\n   at Microsoft.PowerShell.ManagedPSEntry.Main(System.String[])\r\n\r\n[\u5df2\u9000\u51fa\u8fdb\u7a0b\uff0c\u4ee3\u7801\u4e3a 3221225477 (0xc0000005)]\r\n\r\n### Expected behavior\r\n\r\n```console\r\nHope to use (\u5e0c\u671b\u53ef\u4ee5\u4f7f\u7528)\r\n```\r\n\r\n\r\n### Actual behavior\r\n\r\n```console\r\nCan't open (\u65e0\u6cd5\u6253\u5f00)\r\n```\r\n\r\n\r\n### Environment data\r\n\r\n```powershell\r\n\u7248\u672c\tWindows 10 \u5bb6\u5ead\u4e2d\u6587\u7248\r\n\u7248\u672c\u53f7\t21H2\r\n\u5b89\u88c5\u65e5\u671f\t\u200e2021/\u200e8/\u200e5\r\n\u64cd\u4f5c\u7cfb\u7edf\u5185\u90e8\u7248\u672c\t19044.1889\r\n\u4f53\u9a8c\tWindows Feature Experience Pack 120.2212.4180.0\r\n```\r\n\r\n\r\n### OS Data\r\n\r\n```powershell\r\n(Unable to open after installation) \u5b89\u88c5\u540e\u65e0\u6cd5\u6253\u5f00\r\n```\r\n\r\n\r\n### Visuals\r\n\r\n_No response_",
  "closed_at": "2022-08-11T03:07:06Z",
  "comments": [
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "This is failing a call to Windows.  You will likely have to open a support request with windows do see why this is failing on your machine.\r\n\r\nBecause it is AMSI, I think it could also be your antivirus software.",
      "created_at": "2022-08-10T17:21:16Z",
      "updated_at": "2022-08-10T17:24:09Z"
    },
    {
      "author": "YuxinHan258",
      "author_association": "NONE",
      "body": "\r\n\r\n\r\n> This is failing a call to Windows. You will likely have to open a support request with windows do see why this is failing on your machine.\r\n> \r\n> Because it is AMSI, I think it could also be your antivirus software.\r\n\r\n\u611f\u8c22\u60a8\u7684\u5e2e\u52a9\uff0c\u662f\u56e0\u4e3a\u5b89\u88c5\u4e86 Symantec Endpoint Protection \u8fd9\u4e2a\u8f6f\u4ef6\u5bfc\u81f4\u65e0\u6cd5\u4f7f\u7528power shell \uff0cSymantec Endpoint Protection\u592a\u53ef\u6068\u4e86\uff0c\u5df2\u7ecf\u5378\u8f7d\u3002\r\n",
      "created_at": "2022-08-11T03:06:51Z",
      "updated_at": "2022-08-11T03:06:51Z"
    }
  ],
  "created_at": "2022-08-10T05:54:28Z",
  "labels": [
    "WG-Security"
  ],
  "number": 17866,
  "state": "closed",
  "title": "AMSI close session fails with error about protected memory",
  "updated_at": "2022-08-11T03:07:11Z"
}