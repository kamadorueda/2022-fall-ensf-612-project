{
  "_url": "https://github.com/PowerShell/PowerShell/issues/4937",
  "author": "LDSpits",
  "body": "This pr fixes #4913, I have not written any tests, If these are required then please notify me of this and Ill add them\r\n",
  "closed_at": "2017-10-06T20:59:32Z",
  "comments": [
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "Minor Nit: I suggest you change the title of the PR to something like 'User Agent now reports the OS platform'.  When I first read the title, I was expecting to find a behavioral change that is dependent on the OS platform.",
      "created_at": "2017-09-28T17:37:17Z",
      "updated_at": "2017-09-28T17:37:17Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@LDSpits Thanks for the update. Can you please add corresponding tests? You can use https://github.com/PowerShell/PowerShell/blob/master/test/powershell/Modules/Microsoft.PowerShell.Utility/WebCmdlets.Tests.ps1#L456 as an example to get `user-agent`.",
      "created_at": "2017-09-29T01:06:02Z",
      "updated_at": "2017-09-29T01:06:02Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@LDSpits One more thing, when you push new commits, please make sure the message of the last commit contains `[Feature]` in it so that it will trigger a full test run. Web cmdlets tests by default are not included in CI runs, so we need a full test run to validate changes related to them. Thanks!",
      "created_at": "2017-09-29T18:04:55Z",
      "updated_at": "2017-09-29T18:04:55Z"
    },
    {
      "author": "LDSpits",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov @daxian-dbw @markekraus Is it really nessesary to move the tests to a new file? shouldn't we add the test to WebCmdlets.tests.ps1 since most of the infrastructure required for the tests is already inside of there?",
      "created_at": "2017-10-01T15:30:18Z",
      "updated_at": "2017-10-01T17:04:01Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@LDSpits My preference would be for the tests to remain in `WebCmdlets.tests.ps1` along with the other `User-Agent` test. They should be new `It` blocks in the same file preferably right after the current ones. Here is the one for `Invoke-WebRequest`:\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/2e901e53c3c1bfc3eebd66c3ae3223cd3ca6a499/test/powershell/Modules/Microsoft.PowerShell.Utility/WebCmdlets.Tests.ps1#L456-L467",
      "created_at": "2017-10-01T15:36:23Z",
      "updated_at": "2017-10-01T15:36:23Z"
    },
    {
      "author": "LDSpits",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov @daxian-dbw @markekraus can I ask a few questions about tests? I was in the process of adding tests for ``execute-webrequest``. I have copied over most of the code from the ``Invoke-WebRequest returns User-Agent`` test with only changing the regex to ``'.*\\(Windows NT \\d+\\.\\d*;.*\\) PowerShell\\/\\d+\\.\\d+\\.\\d+.*'``. this test failed however. so I tested the regex using powershell (to ensure i was using the same regex parsing engine as pester). However this returned true. So now im puzzled as to why it failed. Could you maybe give some pointers?\r\n\r\npowershell code used to test regex:\r\n```powershell\r\nPS C:\\Users\\spits\\Desktop\\Development\\Powershell\\PowerShell> $bingdings =[System.Reflection.BindingFlags]::NonPublic -b\r\nxor [System.Reflection.BindingFlags]::Static\r\nPS C:\\Users\\spits\\Desktop\\Development\\Powershell\\PowerShell> [Microsoft.PowerShell.Commands.PSUserAgent].GetProperty('Us\r\nerAgent',$bingdings).GetValue($null,$null) -match '.*\\(Windows NT \\d+\\.\\d*;.*\\) PowerShell\\/\\d+\\.\\d+\\.\\d+.*'\r\nTrue\r\n```\r\n\r\nCurrent (windows) test:\r\n\r\n```powershell\r\nIt \"Invoke-WebRequest returns Correct User-Agent on Windows\" {\r\n\r\n        $uri = Get-WebListenerUrl -Test 'Get'\r\n        $command = \"Invoke-WebRequest -Uri '$uri' -TimeoutSec 5\"\r\n\r\n        $result = ExecuteWebCommand -command $command\r\n        ValidateResponse -response $result\r\n\r\n        # Validate response content\r\n        $jsonContent = $result.Output.Content | ConvertFrom-Json\r\n        $jsonContent.headers.'User-Agent' | Should MatchExactly '.*\\(Windows NT \\d+\\.\\d*;.*\\) PowerShell\\/\\d+\\.\\d+\\.\\d+.*'\r\n    }\r\n```\r\n\r\npester test message:\r\n```powershell\r\nDescribing Invoke-WebRequest tests\r\n [-] Invoke-WebRequest returns Correct User-Agent on MacOSX 6.87s\r\n   Expected: {Mozilla/5.0 (Windows NT; Microsoft Windows 10.0.16296 ; nl-NL) PowerShell/6.0.0} to exactly match the expression {.*\\(Macintosh;.*\\) PowerShell\\/\\d+\\.\\d+\\.\\d+.*}\r\n   at line: 466 in C:\\Users\\spits\\Desktop\\Development\\Powershell\\PowerShell\\test\\powershell\\Modules\\Microsoft.PowerShell\r\n.Utility\\WebCmdlets.Tests.ps1\r\n   466:         $jsonContent.headers.'User-Agent' | Should MatchExactly '.*\\(Macintosh;.*\\) PowerShell\\/\\d+\\.\\d+\\.\\d+.*'\r\n [-] Invoke-WebRequest returns Correct User-Agent on Linux 1.14s\r\n   Expected: {Mozilla/5.0 (Windows NT; Microsoft Windows 10.0.16296 ; nl-NL) PowerShell/6.0.0} to exactly match the expr\r\nession {.*\\(Linux;.*\\) PowerShell\\/\\d+\\.\\d+\\.\\d+.*}\r\n   at line: 479 in C:\\Users\\spits\\Desktop\\Development\\Powershell\\PowerShell\\test\\powershell\\Modules\\Microsoft.PowerShell\r\n.Utility\\WebCmdlets.Tests.ps1\r\n   479:         $jsonContent.headers.'User-Agent' | Should MatchExactly '.*\\(Linux;.*\\) PowerShell\\/\\d+\\.\\d+\\.\\d+.*'\r\n [-] Invoke-WebRequest returns Correct User-Agent on Windows 1.08s\r\n   Expected: {Mozilla/5.0 (Windows NT; Microsoft Windows 10.0.16296 ; nl-NL) PowerShell/6.0.0} to exactly match the expression {.*\\(Windows NT \\d+\\.\\d*;.*\\) PowerShell\\/\\d+\\.\\d+\\.\\d+.*}\r\n   at line: 492 in C:\\Users\\spits\\Desktop\\Development\\Powershell\\PowerShell\\test\\powershell\\Modules\\Microsoft.PowerShell\r\n.Utility\\WebCmdlets.Tests.ps1\r\n   492:         $jsonContent.headers.'User-Agent' | Should MatchExactly '.*\\(Windows NT \\d+\\.\\d*;.*\\) PowerShell\\/\\d+\\.\\\r\nd+\\.\\d+.*'\r\n```",
      "created_at": "2017-10-04T21:10:25Z",
      "updated_at": "2017-10-04T21:10:25Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@LDSpits It looks like you are not using a version of PowerShell Compiled with your changes. The pester output shows `Mozilla/5.0 (Windows NT; Microsoft Windows 10.0.16296 ; nl-NL) PowerShell/6.0.0` as the user-agent. note that the `<major>.<minor>` is missing after `Windows NT`",
      "created_at": "2017-10-04T21:21:10Z",
      "updated_at": "2017-10-04T21:21:42Z"
    },
    {
      "author": "LDSpits",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov @daxian-dbw @markekraus the Travis build is erroring? had a problem with the previous build on the http proxy tests...",
      "created_at": "2017-10-06T12:24:34Z",
      "updated_at": "2017-10-06T12:24:34Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@LDSpits Its related to #5005. We need to fix the other delay tests. ~I'll create an issue for it.~ PR  #5035",
      "created_at": "2017-10-06T12:57:59Z",
      "updated_at": "2017-10-06T13:06:12Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "#5035 has been merged and I restarted the CI builds. Hopefully the CI will pass this time.",
      "created_at": "2017-10-06T18:22:57Z",
      "updated_at": "2017-10-06T18:22:57Z"
    },
    {
      "author": "LDSpits",
      "author_association": "CONTRIBUTOR",
      "body": "Let's hope they'll pass this time \ud83d\ude04 ",
      "created_at": "2017-10-06T19:09:45Z",
      "updated_at": "2017-10-06T19:09:45Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@LDSpits Thanks for your contribution!\r\n@markekraus @iSazonov Thank you for the thorough review!",
      "created_at": "2017-10-06T21:00:35Z",
      "updated_at": "2017-10-06T21:00:35Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@LDSpits Thanks for doing this!",
      "created_at": "2017-10-06T21:05:21Z",
      "updated_at": "2017-10-06T21:05:21Z"
    },
    {
      "author": "LDSpits",
      "author_association": "CONTRIBUTOR",
      "body": "@daxian-dbw @iSazonov  @markekraus No problem, expect to see me around \ud83d\ude04 ",
      "created_at": "2017-10-06T21:13:34Z",
      "updated_at": "2017-10-06T21:13:53Z"
    }
  ],
  "created_at": "2017-09-28T09:29:07Z",
  "number": 4937,
  "state": "closed",
  "title": "User Agent now reports the OS platform",
  "updated_at": "2017-10-06T21:14:03Z"
}