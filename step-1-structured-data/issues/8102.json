{
  "_url": "https://github.com/PowerShell/PowerShell/issues/8102",
  "author": "FLVSD",
  "body": "Hello,\r\n\r\nInvoke-Webrequest -Method Head seems to fail to follow redirect and returns error 404 instead of 301.\r\n\r\nStrangely enough, it succeeds after same URL has been opened in browser or without option -Method Head.\r\n\r\nSteps to reproduce\r\n------------------\r\n(I don't like to put a real life URL here, but I find it important to be able to reproduce exactly as seen)\r\n\r\n```\r\nInvoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg -Method Head -MaximumRedirection 10\r\n\r\nInvoke-WebRequest : Le serveur distant a retourn\u00e9 une erreur\u00a0: (404) Introuvable.\r\nAu caract\u00e8re Ligne:1 : 1\r\n+ Invoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/fl ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : InvalidOperation : (System.Net.HttpWebRequest:HttpWebRequest) [Invoke-WebRequest], WebException\r\n    + FullyQualifiedErrorId : WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand\r\n```\r\n\r\n=> Sniffer indicates 301 Permanently moved to https://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg\r\n\r\nSame issue when trying to open directly HTTPS uri that HTTP uri is redirected to:\r\n\r\n```\r\nInvoke-WebRequest -Uri https://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg -Method Head -MaximumRedirection 10\r\n\r\nInvoke-WebRequest : Le serveur distant a retourn\u00e9 une erreur\u00a0: (404) Introuvable.\r\nAu caract\u00e8re Ligne:1 : 1\r\n+ Invoke-WebRequest -Uri https://www.fondationlouisvuitton.fr/content/f ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : InvalidOperation : (System.Net.HttpWebRequest:HttpWebRequest) [Invoke-WebRequest], WebException\r\n    + FullyQualifiedErrorId : WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand\r\n```\r\n\r\nNow opening succeeds if -Method Head is not specified:\r\n\r\n```\r\nInvoke-WebRequest -Uri https://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg\r\n\r\n\r\nStatusCode        : 200\r\nStatusDescription : OK\r\nContent           : {255, 216, 255, 224...}\r\nRawContent        : HTTP/1.1 200 OK\r\n                    X-Content-Type-Options: nosniff\r\n                    X-Frame-Options: SAMEORIGIN\r\n                    Connection: keep-alive\r\n                    Strict-Transport-Security: max-age=86400\r\n                    Content-Length: 223987\r\n                    Cache-Control: max-age=7185\r\n                    Co...\r\nHeaders           : {[X-Content-Type-Options, nosniff], [X-Frame-Options, SAMEORIGIN], [Connection, keep-alive], [Strict-Transport-Security, max-age=86400]...}\r\nRawContentLength  : 223987\r\n```\r\n\r\nAnd if I try again specifying -Method Head, it now works !\r\n\r\n```\r\nInvoke-WebRequest -Uri https://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg -Method Head -MaximumRedirection 10\r\n\r\n\r\nStatusCode        : 200\r\nStatusDescription : OK\r\nContent           : {}\r\nRawContent        : HTTP/1.1 200 OK\r\n                    X-Content-Type-Options: nosniff\r\n                    X-Frame-Options: SAMEORIGIN\r\n                    Connection: keep-alive\r\n                    Strict-Transport-Security: max-age=86400\r\n                    Content-Length: 223987\r\n                    Cache-Control: max-age=7175\r\n                    Co...\r\nHeaders           : {[X-Content-Type-Options, nosniff], [X-Frame-Options, SAMEORIGIN], [Connection, keep-alive], [Strict-Transport-Security, max-age=86400]...}\r\nRawContentLength  : 0\r\n```\r\n```\r\nInvoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg -Method Head -MaximumRedirection 10\r\n\r\n\r\nStatusCode        : 200\r\nStatusDescription : OK\r\nContent           : {}\r\nRawContent        : HTTP/1.1 200 OK\r\n                    X-Content-Type-Options: nosniff\r\n                    X-Frame-Options: SAMEORIGIN\r\n                    Connection: keep-alive\r\n                    Strict-Transport-Security: max-age=86400\r\n                    Content-Length: 223987\r\n                    Cache-Control: max-age=5896\r\n                    Co...\r\nHeaders           : {[X-Content-Type-Options, nosniff], [X-Frame-Options, SAMEORIGIN], [Connection, keep-alive], [Strict-Transport-Security, max-age=86400]...}\r\nRawContentLength  : 0\r\n```\r\nPlease note that opening the URL is a browser succeeds, and also seem to make the invoke-webrequest -Method Head behave properly...\r\n\r\nExpected behavior\r\n-----------------\r\nEither succeed and return statuscode 301, or follow redirection and return statuscode 200, depending on value of -MaximumRedirection:\r\n\r\n```\r\nInvoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg -Method Head -MaximumRedirection 10\r\n\r\n\r\nStatusCode        : 200\r\nStatusDescription : OK\r\nContent           : {}\r\nRawContent        : HTTP/1.1 200 OK\r\n                    X-Content-Type-Options: nosniff\r\n                    X-Frame-Options: SAMEORIGIN\r\n                    Connection: keep-alive\r\n                    Strict-Transport-Security: max-age=86400\r\n                    Content-Length: 223987\r\n                    Cache-Control: max-age=5896\r\n                    Co...\r\nHeaders           : {[X-Content-Type-Options, nosniff], [X-Frame-Options, SAMEORIGIN], [Connection, keep-alive], [Strict-Transport-Security, max-age=86400]...}\r\nRawContentLength  : 0\r\n```\r\n\r\nActual behavior\r\n---------------\r\nFails with error 404 whatever the value of -MaximumRedirection.\r\nSucceeds if the URI is opened once with browser or with Invoke-Webrequest without specifying -Method Head.\r\n\r\nEnvironment data\r\n----------------\r\n\r\n```\r\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.16299.248\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.16299.248\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\n```\r\n",
  "closed_at": "2018-10-22T12:16:41Z",
  "comments": [
    {
      "author": "FLVSD",
      "author_association": "NONE",
      "body": "BTW, before anyone points me to upgrading to v6.0 core, please note that I have the same issue with v6.0 core:\r\n\r\n```\r\n$PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.0.2\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.2\r\nOS                             Microsoft Windows 10.0.16299\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\nError 404 while trying to open the URI while specifying -Method Head:\r\n\r\n```\r\nInvoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg -Method Head -MaximumRedirection 10\r\n\r\nInvoke-WebRequest : Response status code does not indicate success: 404 (Not Found).\r\nAt line:1 char:1\r\n+ Invoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/fl ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : InvalidOperation: (Method: HEAD, R...rShell/6.0.2\r\n}:HttpRequestMessage) [Invoke-WebRequest], HttpResponseException\r\n+ FullyQualifiedErrorId : WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand\r\n```\r\n\r\nSuccess while trying to open the URI without specifying -Method Head:\r\n\r\n```\r\nInvoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg -MaximumRedirection 10\r\n\r\n\r\nStatusCode        : 200\r\nStatusDescription : OK\r\nContent           : {255, 216, 255, 224...}\r\nRawContent        : HTTP/1.1 200 OK\r\n                    Cache-Control: max-age=7192\r\n                    Connection: close\r\n                    Date: Mon, 22 Oct 2018 09:58:50 GMT\r\n                    Server: Apache\r\n                    X-Content-Type-Options: nosniff\r\n                    X-Frame-Options: SAMEORIGIN\r\n                    Strict-Transport-Sec...\r\nHeaders           : {[Cache-Control, System.String[]], [Connection, System.String[]], [Date, System.String[]], [Server, System.String[]]...}\r\nRawContentLength  : 223987\r\nRelationLink      : {}\r\n```\r\nThen success again while trying to open the URI while specifying -Method Head:\r\n\r\n```\r\nInvoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-pa\r\nrreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg -Method Head -MaximumRedirection 10\r\n\r\n\r\nStatusCode        : 200\r\nStatusDescription : OK\r\nContent           : {}\r\nRawContent        : HTTP/1.1 200 OK\r\n                    Cache-Control: max-age=7189\r\n                    Connection: close\r\n                    Date: Mon, 22 Oct 2018 09:58:53 GMT\r\n                    Server: Apache\r\n                    X-Content-Type-Options: nosniff\r\n                    X-Frame-Options: SAMEORIGIN\r\n                    Strict-Transport-Sec...\r\nHeaders           : {[Cache-Control, System.String[]], [Connection, System.String[]], [Date, System.String[]], [Server, System.String[]]...}\r\nRawContentLength  : 0\r\nRelationLink      : {}\r\n```",
      "created_at": "2018-10-22T10:04:50Z",
      "updated_at": "2018-10-22T10:04:50Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "Please also take a moment to verify that it does not work with the latest version of PowerShell Core. I believe the updates to the web cmdlet happened after 6.0.2, if I'm not mistaken. :)",
      "created_at": "2018-10-22T11:09:32Z",
      "updated_at": "2018-10-22T11:09:53Z"
    },
    {
      "author": "FLVSD",
      "author_association": "NONE",
      "body": "Thanks for your suggestion.\r\n\r\nUpgraded PSH core to v6.1, and got exactly the same behaviour:\r\n\r\n```\r\n$PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.1.0\r\nPSEdition                      Core\r\nGitCommitId                    6.1.0\r\nOS                             Microsoft Windows 10.0.16299\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n```\r\nInvoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg -Method Head -MaximumRedirection 10\r\nInvoke-WebRequest : Response status code does not indicate success: 404 (Not Found).\r\nAt line:1 char:1\r\n+ Invoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/fl ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : InvalidOperation: (Method: HEAD, R...rShell/6.1.0\r\n}:HttpRequestMessage) [Invoke-WebRequest], HttpResponseException\r\n+ FullyQualifiedErrorId : WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand\r\n```\r\n```\r\nInvoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg -MaximumRedirection 10\r\n\r\n\r\nStatusCode        : 200\r\nStatusDescription : OK\r\nContent           : {255, 216, 255, 224...}\r\nRawContent        : HTTP/1.1 200 OK\r\n                    Server: Apache\r\n                    X-Content-Type-Options: nosniff\r\n                    X-Frame-Options: SAMEORIGIN\r\n                    Cache-Control: max-age=1061\r\n                    Date: Mon, 22 Oct 2018 11:40:27 GMT\r\n                    Connection: keep-alive\r\n                    Strict-Transpor...\r\nHeaders           : {[Server, System.String[]], [X-Content-Type-Options, System.String[]], [X-Frame-Options,\r\n                    System.String[]], [Cache-Control, System.String[]]...}\r\nRawContentLength  : 223987\r\nRelationLink      : {}\r\n```\r\n```\r\nInvoke-WebRequest -Uri http://www.fondationlouisvuitton.fr/content/flvinternet/en/expositions/hors-les-murs/philippe-parreno-marilyn/_jcr_content/image.flvcrop.2048.5000.jpeg -Method Head -MaximumRedirection 10\r\n\r\n\r\nStatusCode        : 200\r\nStatusDescription : OK\r\nContent           : {}\r\nRawContent        : HTTP/1.1 200 OK\r\n                    Server: Apache\r\n                    X-Content-Type-Options: nosniff\r\n                    X-Frame-Options: SAMEORIGIN\r\n                    Cache-Control: max-age=1057\r\n                    Date: Mon, 22 Oct 2018 11:40:31 GMT\r\n                    Connection: keep-alive\r\n                    Strict-Transpor...\r\nHeaders           : {[Server, System.String[]], [X-Content-Type-Options, System.String[]], [X-Frame-Options,\r\n                    System.String[]], [Cache-Control, System.String[]]...}\r\nRawContentLength  : 0\r\nRelationLink      : {}\r\n```\r\n",
      "created_at": "2018-10-22T11:46:14Z",
      "updated_at": "2018-10-22T11:46:14Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "This problem appears to be with the web server you are trying to reach, not with Invoke-WebRequest. I cannot reproduce this with other sites. You will need to contact the owners of that web server for support on accessing their site. They may have ant-scraping or robot protections in place that are being triggered by the request. `HEAD` is not universally supported by all web servers and implementations may vary. The web server may also be filtering based on your IP, User-Agent, and session tokens. These things require additional changes to your calls in order to properly obtain data from some sites.\r\n\r\n\r\n```powershell\r\n$uri = 'https://httpbin.org/redirect-to?status_code=301&url=https://httpbin.org/get'\r\nInvoke-WebRequest -method HEAD -Uri  $uri -MaximumRedirection 10\r\n```",
      "created_at": "2018-10-22T12:15:05Z",
      "updated_at": "2018-10-22T12:15:05Z"
    },
    {
      "author": "FLVSD",
      "author_association": "NONE",
      "body": "Thanks for your comment. The good news is that this website is ours. The bad news is that we are not aware of any exotic configuration that would prevent this.\r\n\r\nWe will however look into this more deeply. It could also be a side effect of the CDN.\r\n\r\nHowever, I still find it strange that it would work without the -Method Head, and that it would work with the -Method Head once it has worked once without. Maybe this could point to a cache effect (and to the CDN).\r\n\r\nI will keep you posted on my finding so that we can hopefully conclude it is not a PSH bug.",
      "created_at": "2018-10-22T12:34:41Z",
      "updated_at": "2018-10-22T12:34:41Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@FLVSD CDN could definitely cause this behavior along with application firewalls. If you are able to run the query directly against your servers instead of the CDN you can at least rule out yor server config.\r\n\r\nCDN's are complex beasts and they are primarily written to work with web browsers. They often have speciqal configurations for curl and wget, but Invoke-WebRequest is not as well known. You may be able to get around CDN issue by using the `-UserAgent` and supplying a User-Gent header for curl or wget.",
      "created_at": "2018-10-22T13:20:44Z",
      "updated_at": "2018-10-22T13:20:44Z"
    },
    {
      "author": "FLVSD",
      "author_association": "NONE",
      "body": "Thanks again for your suggestion.\r\n\r\nWe have good support from our CDN, and I have opened a support ticket with them to plan a diagnostics session. They will also be in a position to give us some highlights on how our servers react, so I guess they should be able to point us in the right direction.",
      "created_at": "2018-10-22T13:47:20Z",
      "updated_at": "2018-10-22T13:47:20Z"
    }
  ],
  "created_at": "2018-10-22T09:42:48Z",
  "labels": [
    "Issue-Question",
    "Resolution-Answered",
    "WG-Cmdlets-Utility"
  ],
  "number": 8102,
  "state": "closed",
  "title": "Invoke-Webrequest -Method Head fails to follow redirect and returns error 404 instead of 301",
  "updated_at": "2018-10-22T13:47:20Z"
}