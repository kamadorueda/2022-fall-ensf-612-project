{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16214",
  "author": "malfuncion",
  "body": "### Prerequisites\r\n\r\n- [X] Write a descriptive title.\r\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- [X] Search the existing issues.\r\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n\r\n### Steps to reproduce\r\n\r\nWhen using 7.1.4 I have a default profile that defines the $PSDefaultParameterValues, adding a specific server for my domain controller. The same profile works on Powershell Core  5.1, fails to read in values in 7.1.4. Same issue with profile or manual setting variables on -norprofile. \r\n\r\n\u276f get-aduser User.Name\r\nGet-ADUser: Unable to find a default server with Active Directory Web Services running.\r\n\u276f $PSDefaultParameterValues\r\nName                           Value\r\n----                           -----\r\n*-AD*:Server                   adserverName.[privateinfo].com\r\n\r\n### Expected behavior\r\n\r\n```console\r\n\u276f $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.19041.1237\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.19041.1237\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\n\r\n\u276f Get-AdUser Some.User\r\nGet-AdUser : Cannot find an object with identity: 'Some.User' under: 'DC=[PRIVATEINFO],DC=local'.\r\nAt line:1 char:1\r\n+ Get-AdUser Some.User\r\n+ ~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (Some.User:ADUser) [Get-ADUser], ADIdentityNotFoundException\r\n    + FullyQualifiedErrorId : ActiveDirectoryCmdlet:Microsoft.ActiveDirectory.Management.ADIdentityNotFoundException,M\r\n   icrosoft.ActiveDirectory.Management.Commands.GetADUser\r\n\u276f $PSDefaultParameterValues\r\n\r\nName                           Value\r\n----                           -----\r\n*-AD*:Server                   adserverName.[privateinfo].com\r\n```\r\n\r\n\r\n### Actual behavior\r\n\r\n```console\r\n\u276f get-aduser User.Name\r\nGet-ADUser: Unable to find a default server with Active Directory Web Services running.\r\n```\r\n\r\n\r\n### Error details\r\n\r\n```console\r\nOriginInfo            : localhost\r\nException             :\r\n    Type                           : System.Management.Automation.RemoteException\r\n    SerializedRemoteException      : Microsoft.ActiveDirectory.Management.ADServerDownException: Unable to find a default server with Active Directory Web Services running. ---> Microsoft.ActiveDirectory.Management.ADException: Unable\r\nto find a default server with flags: 'MinimumDirectoryServiceVersion:Windows2000 | ADWS | ReturnDnsName'.\r\n                                     --- End of inner exception stack trace ---\r\n                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.DiscoverServerName(Boolean forceDiscovery)\r\n                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.CreateEndpointAddress(String configName)\r\n                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.InitializeChannel[TChannel](TChannel& channel, ChannelFactory`1& chFactory, String endpointName, CommunicationException& commException)\r\n                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.SearchAnObject(ADSearchRequest request)\r\n                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.Search(ADSearchRequest request)\r\n                                     at Microsoft.ActiveDirectory.Management.ADWebServiceStoreAccess.Microsoft.ActiveDirectory.Management.IADSyncOperations.Search(ADSessionHandle handle, ADSearchRequest request)\r\n                                     at Microsoft.ActiveDirectory.Management.ADObjectSearcher.GetRootDSE()\r\n                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetRootDSE()\r\n                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetConnectedStore()\r\n                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetCmdletSessionInfo()\r\n                                     at Microsoft.ActiveDirectory.Management.Commands.ADGetCmdletBase`3.ADGetCmdletBaseProcessCSRoutine()\r\n                                     at Microsoft.ActiveDirectory.Management.CmdletSubroutinePipeline.Invoke()\r\n                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.ProcessRecord()\r\n    SerializedRemoteInvocationInfo : System.Management.Automation.InvocationInfo\r\n    ErrorRecord                    :\r\n        Exception             :\r\n            Type                           : System.Management.Automation.RemoteException\r\n            SerializedRemoteException      : Microsoft.ActiveDirectory.Management.ADServerDownException: Unable to find a default server with Active Directory Web Services running. --->\r\nMicrosoft.ActiveDirectory.Management.ADException: Unable to find a default server with flags: 'MinimumDirectoryServiceVersion:Windows2000 | ADWS | ReturnDnsName'.\r\n                                             --- End of inner exception stack trace ---\r\n                                             at Microsoft.ActiveDirectory.Management.AdwsConnection.DiscoverServerName(Boolean forceDiscovery)\r\n                                             at Microsoft.ActiveDirectory.Management.AdwsConnection.CreateEndpointAddress(String configName)\r\n                                             at Microsoft.ActiveDirectory.Management.AdwsConnection.InitializeChannel[TChannel](TChannel& channel, ChannelFactory`1& chFactory, String endpointName, CommunicationException& commException)\r\n                                             at Microsoft.ActiveDirectory.Management.AdwsConnection.SearchAnObject(ADSearchRequest request)\r\n                                             at Microsoft.ActiveDirectory.Management.AdwsConnection.Search(ADSearchRequest request)\r\n                                             at Microsoft.ActiveDirectory.Management.ADWebServiceStoreAccess.Microsoft.ActiveDirectory.Management.IADSyncOperations.Search(ADSessionHandle handle, ADSearchRequest request)\r\n                                             at Microsoft.ActiveDirectory.Management.ADObjectSearcher.GetRootDSE()\r\n                                             at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetRootDSE()\r\n                                             at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetConnectedStore()\r\n                                             at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetCmdletSessionInfo()\r\n                                             at Microsoft.ActiveDirectory.Management.Commands.ADGetCmdletBase`3.ADGetCmdletBaseProcessCSRoutine()\r\n                                             at Microsoft.ActiveDirectory.Management.CmdletSubroutinePipeline.Invoke()\r\n                                             at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.ProcessRecord()\r\n            SerializedRemoteInvocationInfo : System.Management.Automation.InvocationInfo\r\n            ErrorRecord                    :\r\n                Exception             :\r\n                    Type                           : System.Management.Automation.RemoteException\r\n                    SerializedRemoteException      : Microsoft.ActiveDirectory.Management.ADServerDownException: Unable to find a default server with Active Directory Web Services running. --->\r\nMicrosoft.ActiveDirectory.Management.ADException: Unable to find a default server with flags: 'MinimumDirectoryServiceVersion:Windows2000 | ADWS | ReturnDnsName'.\r\n                                                     --- End of inner exception stack trace ---\r\n                                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.DiscoverServerName(Boolean forceDiscovery)\r\n                                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.CreateEndpointAddress(String configName)\r\n                                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.InitializeChannel[TChannel](TChannel& channel, ChannelFactory`1& chFactory, String endpointName, CommunicationException&\r\ncommException)\r\n                                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.SearchAnObject(ADSearchRequest request)\r\n                                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.Search(ADSearchRequest request)\r\n                                                     at Microsoft.ActiveDirectory.Management.ADWebServiceStoreAccess.Microsoft.ActiveDirectory.Management.IADSyncOperations.Search(ADSessionHandle handle, ADSearchRequest request)\r\n                                                     at Microsoft.ActiveDirectory.Management.ADObjectSearcher.GetRootDSE()\r\n                                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetRootDSE()\r\n                                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetConnectedStore()\r\n                                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetCmdletSessionInfo()\r\n                                                     at Microsoft.ActiveDirectory.Management.Commands.ADGetCmdletBase`3.ADGetCmdletBaseProcessCSRoutine()\r\n                                                     at Microsoft.ActiveDirectory.Management.CmdletSubroutinePipeline.Invoke()\r\n                                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.ProcessRecord()\r\n                    SerializedRemoteInvocationInfo : System.Management.Automation.InvocationInfo\r\n                    ErrorRecord                    :\r\n                        Exception             :\r\n                            Type                           : System.Management.Automation.RemoteException\r\n                            SerializedRemoteException      : Microsoft.ActiveDirectory.Management.ADServerDownException: Unable to find a default server with Active Directory Web Services running. --->\r\nMicrosoft.ActiveDirectory.Management.ADException: Unable to find a default server with flags: 'MinimumDirectoryServiceVersion:Windows2000 | ADWS | ReturnDnsName'.\r\n                                                             --- End of inner exception stack trace ---\r\n                                                             at Microsoft.ActiveDirectory.Management.AdwsConnection.DiscoverServerName(Boolean forceDiscovery)\r\n                                                             at Microsoft.ActiveDirectory.Management.AdwsConnection.CreateEndpointAddress(String configName)\r\n                                                             at Microsoft.ActiveDirectory.Management.AdwsConnection.InitializeChannel[TChannel](TChannel& channel, ChannelFactory`1& chFactory, String endpointName,\r\nCommunicationException& commException)\r\n                                                             at Microsoft.ActiveDirectory.Management.AdwsConnection.SearchAnObject(ADSearchRequest request)\r\n                                                             at Microsoft.ActiveDirectory.Management.AdwsConnection.Search(ADSearchRequest request)\r\n                                                             at Microsoft.ActiveDirectory.Management.ADWebServiceStoreAccess.Microsoft.ActiveDirectory.Management.IADSyncOperations.Search(ADSessionHandle handle, ADSearchRequest request)\r\n                                                             at Microsoft.ActiveDirectory.Management.ADObjectSearcher.GetRootDSE()\r\n                                                             at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetRootDSE()\r\n                                                             at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetConnectedStore()\r\n                                                             at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetCmdletSessionInfo()\r\n                                                             at Microsoft.ActiveDirectory.Management.Commands.ADGetCmdletBase`3.ADGetCmdletBaseProcessCSRoutine()\r\n                                                             at Microsoft.ActiveDirectory.Management.CmdletSubroutinePipeline.Invoke()\r\n                                                             at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.ProcessRecord()\r\n                            SerializedRemoteInvocationInfo : System.Management.Automation.InvocationInfo\r\n                            ErrorRecord                    :\r\n                                Exception             :\r\n                                    Type                           : System.Management.Automation.RemoteException\r\n                                    SerializedRemoteException      : Microsoft.ActiveDirectory.Management.ADServerDownException: Unable to find a default server with Active Directory Web Services running. --->\r\nMicrosoft.ActiveDirectory.Management.ADException: Unable to find a default server with flags: 'MinimumDirectoryServiceVersion:Windows2000 | ADWS | ReturnDnsName'.\r\n                                                                     --- End of inner exception stack trace ---\r\n                                                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.DiscoverServerName(Boolean forceDiscovery)\r\n                                                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.CreateEndpointAddress(String configName)\r\n                                                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.InitializeChannel[TChannel](TChannel& channel, ChannelFactory`1& chFactory, String endpointName,\r\nCommunicationException& commException)\r\n                                                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.SearchAnObject(ADSearchRequest request)\r\n                                                                     at Microsoft.ActiveDirectory.Management.AdwsConnection.Search(ADSearchRequest request)\r\n                                                                     at Microsoft.ActiveDirectory.Management.ADWebServiceStoreAccess.Microsoft.ActiveDirectory.Management.IADSyncOperations.Search(ADSessionHandle handle, ADSearchRequest\r\nrequest)\r\n                                                                     at Microsoft.ActiveDirectory.Management.ADObjectSearcher.GetRootDSE()\r\n                                                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetRootDSE()\r\n                                                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetConnectedStore()\r\n                                                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.GetCmdletSessionInfo()\r\n                                                                     at Microsoft.ActiveDirectory.Management.Commands.ADGetCmdletBase`3.ADGetCmdletBaseProcessCSRoutine()\r\n                                                                     at Microsoft.ActiveDirectory.Management.CmdletSubroutinePipeline.Invoke()\r\n                                                                     at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.ProcessRecord()\r\n                                    SerializedRemoteInvocationInfo : System.Management.Automation.InvocationInfo\r\n                                    ErrorRecord                    : \u2026\r\n                                    Message                        : Unable to find a default server with Active Directory Web Services running.\r\n                                    HResult                        : -2146233087\r\n                                TargetObject          : User.Name\r\n                                CategoryInfo          : ResourceUnavailable: (User.Name:ADUser) [Get-ADUser], ADServerDownException\r\n                                FullyQualifiedErrorId : ActiveDirectoryServer:1355,Microsoft.ActiveDirectory.Management.Commands.GetADUser\r\n                            Message                        : Unable to find a default server with Active Directory Web Services running.\r\n                            HResult                        : -2146233087\r\n                        TargetObject          : User.Name\r\n                        CategoryInfo          : ResourceUnavailable: (User.Name:ADUser) [Get-ADUser], ADServerDownException\r\n                        FullyQualifiedErrorId : ActiveDirectoryServer:1355,Microsoft.ActiveDirectory.Management.Commands.GetADUser\r\n                    Message                        : Unable to find a default server with Active Directory Web Services running.\r\n                    HResult                        : -2146233087\r\n                TargetObject          : User.Name\r\n                CategoryInfo          : ResourceUnavailable: (User.Name:ADUser) [Get-ADUser], ADServerDownException\r\n                FullyQualifiedErrorId : ActiveDirectoryServer:1355,Microsoft.ActiveDirectory.Management.Commands.GetADUser\r\n            Message                        : Unable to find a default server with Active Directory Web Services running.\r\n            HResult                        : -2146233087\r\n        TargetObject          : User.Name\r\n        CategoryInfo          : ResourceUnavailable: (User.Name:ADUser) [Get-ADUser], ADServerDownException\r\n        FullyQualifiedErrorId : ActiveDirectoryServer:1355,Microsoft.ActiveDirectory.Management.Commands.GetADUser\r\n    Message                        : Unable to find a default server with Active Directory Web Services running.\r\n    HResult                        : -2146233087\r\nTargetObject          : User.Name\r\nCategoryInfo          : ResourceUnavailable: (User.Name:ADUser) [Get-ADUser], ADServerDownException\r\nFullyQualifiedErrorId : ActiveDirectoryServer:1355,Microsoft.ActiveDirectory.Management.Commands.GetADUser\r\n```\r\n\r\n\r\n### Environment data\r\n\r\n```powershell\r\nFails: Name                           Value\r\n----                           -----\r\nPSVersion                      7.1.4\r\nPSEdition                      Core\r\nGitCommitId                    7.1.4\r\nOS                             Microsoft Windows 10.0.19043\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\nWorks: \r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.19041.1237\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.19041.1237\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\n```\r\n\r\n\r\n### Visuals\r\n\r\n_No response_",
  "closed_at": "2022-03-12T00:00:41Z",
  "comments": [
    {
      "author": "pauldapps",
      "author_association": "NONE",
      "body": "I believe this is due to the `WinPSCompatSession` that's required for the ActiveDirectory module to work.\n\nWhat you may be able to do is manually inject the default parameter values into the compat session with: `get-pssession`, `invoke-command`, and/or `enter-pssession` \n\nTesting done with my initial curiosity is showing that doesn't actually work, but I'll keep playing with it.",
      "created_at": "2022-03-09T22:27:29Z",
      "updated_at": "2022-03-09T22:28:00Z"
    },
    {
      "author": "SeeminglyScience",
      "author_association": "COLLABORATOR",
      "body": "The `ActiveDirectory` module was actually updated to run in-process in PowerShell 7. Can you double check that you've installed it from features on demand? I believe it's called `RSAT: Active Directory Domain Services and Lightweight Directory Services Tools`",
      "created_at": "2022-03-10T14:37:00Z",
      "updated_at": "2022-03-10T14:37:00Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This issue has been marked as answered and has not had any activity for **1 day**. It has been closed for housekeeping purposes.",
      "created_at": "2022-03-12T00:00:40Z",
      "updated_at": "2022-03-12T00:00:40Z"
    }
  ],
  "created_at": "2021-10-08T17:32:42Z",
  "labels": [
    "Issue-Question",
    "Resolution-Answered",
    "Needs-Triage"
  ],
  "number": 16214,
  "state": "closed",
  "title": "$PSDefaultValues not reading",
  "updated_at": "2022-03-12T00:00:41Z"
}