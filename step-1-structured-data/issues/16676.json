{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16676",
  "author": "MartinGC94",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nType in any of the following lines and add a linebreak after the equals sign:\r\n```\r\nusing namespace whatever =\r\nusing module whatever =\r\nusing type whatever =\r\nusing command whatever =\r\n```\r\nAs soon as you add the new line, PSReadline will display a parser error:\r\n\r\n```\r\nSystem.NullReferenceException: Object reference not set to an instance of an object.\r\n   at System.Management.Automation.Language.Parser.ExtentOf(Token first, Ast last)\r\n   at System.Management.Automation.Language.Parser.UsingStatementRule(Token usingToken)\r\n   at System.Management.Automation.Language.Parser.UsingStatementsRule()\r\n```\r\nThe same thing happens in PowerShell 5.1\n\n### Expected behavior\n\n```console\nNo errors thrown.\n```\n\n\n### Actual behavior\n\n```console\nSystem.NullReferenceException: Object reference not set to an instance of an object.\r\n   at System.Management.Automation.Language.Parser.ExtentOf(Token first, Ast last)\r\n   at System.Management.Automation.Language.Parser.UsingStatementRule(Token usingToken)\r\n   at System.Management.Automation.Language.Parser.UsingStatementsRule()\r\n```\n```\n\n\n### Error details\n\n```console\nPS C:\\Users\\Martin> get-error\r\n\r\nException             :\r\n    Type           : System.Management.Automation.MethodInvocationException\r\n    ErrorRecord    :\r\n        Exception             :\r\n            Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n            Message : Exception calling \"ReadLine\" with \"3\" argument(s): \"Unrecoverable error in PowerShell.\"\r\n            HResult : -2146233087\r\n        CategoryInfo          : NotSpecified: (:) [], ParentContainsErrorRecordException\r\n        FullyQualifiedErrorId : ParseException\r\n        InvocationInfo        :\r\n            ScriptLineNumber : 7\r\n            OffsetInLine     : 5\r\n            HistoryId        : -1\r\n            ScriptName       : C:\\Users\\Martin\\Documents\\PowerShell\\Modules\\PSReadLine\\2.2.0\\PSReadLine.psm1\r\n            Line             : [Microsoft.PowerShell.PSConsoleReadLine]::ReadLine($host.Runspace, $ExecutionContext, $lastRunStatus)\r\n\r\n            PositionMessage  : At C:\\Users\\Martin\\Documents\\PowerShell\\Modules\\PSReadLine\\2.2.0\\PSReadLine.psm1:7 char:5\r\n                               +     [Microsoft.PowerShell.PSConsoleReadLine]::ReadLine($host.Runspace \u2026\r\n                               +     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n            PSScriptRoot     : C:\\Users\\Martin\\Documents\\PowerShell\\Modules\\PSReadLine\\2.2.0\r\n            PSCommandPath    : C:\\Users\\Martin\\Documents\\PowerShell\\Modules\\PSReadLine\\2.2.0\\PSReadLine.psm1\r\n            CommandOrigin    : Internal\r\n        ScriptStackTrace      : at PSConsoleHostReadLine, C:\\Users\\Martin\\Documents\\PowerShell\\Modules\\PSReadLine\\2.2.0\\PSReadLine.psm1: line 7\r\n    TargetSite     :\r\n        Name          : ConvertToMethodInvocationException\r\n        DeclaringType : System.Management.Automation.ExceptionHandlingOps, System.Management.Automation, Version=7.2.0.10, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n        MemberType    : Method\r\n        Module        : System.Management.Automation.dll\r\n    Message        : Exception calling \"ReadLine\" with \"3\" argument(s): \"Unrecoverable error in PowerShell.\"\r\n    Data           : System.Collections.ListDictionaryInternal\r\n    InnerException :\r\n        Type           : System.Management.Automation.ParseException\r\n        Message        : Unrecoverable error in PowerShell.\r\n        ErrorRecord    :\r\n            Exception             :\r\n                Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n                Message : Unrecoverable error in PowerShell.\r\n                HResult : -2146233087\r\n            CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException\r\n            FullyQualifiedErrorId : Parse\r\n        TargetSite     :\r\n            Name          : ParseInput\r\n            DeclaringType : System.Management.Automation.Language.Parser\r\n            MemberType    : Method\r\n            Module        : System.Management.Automation.dll\r\n        InnerException :\r\n            Type       : System.NullReferenceException\r\n            TargetSite :\r\n                Name          : ExtentOf\r\n                DeclaringType : System.Management.Automation.Language.Parser\r\n                MemberType    : Method\r\n                Module        : System.Management.Automation.dll\r\n            Message    : Object reference not set to an instance of an object.\r\n            Source     : System.Management.Automation\r\n            HResult    : -2147467261\r\n            StackTrace :\r\n   at System.Management.Automation.Language.Parser.ExtentOf(Token first, Ast last)\r\n   at System.Management.Automation.Language.Parser.UsingStatementRule(Token usingToken)\r\n   at System.Management.Automation.Language.Parser.UsingStatementsRule()\r\n   at System.Management.Automation.Language.Parser.ScriptBlockRule(Token lCurly, Boolean isFilter, StatementAst predefinedStatementAst)\r\n   at System.Management.Automation.Language.Parser.ParseTask(String fileName, String input, List`1 tokenList, Boolean recursed, ParseMode parseMode)\r\n   at System.Management.Automation.Language.Parser.Parse(String fileName, String input, List`1 tokenList, ParseError[]& errors, ParseMode parseMode)\r\n   at System.Management.Automation.Language.Parser.ParseInput(String input, String fileName, Token[]& tokens, ParseError[]& errors)\r\n        Source         : System.Management.Automation\r\n        HResult        : -2146233087\r\n        StackTrace     :\r\n   at System.Management.Automation.Language.Parser.ParseInput(String input, String fileName, Token[]& tokens, ParseError[]& errors)\r\n   at System.Management.Automation.Language.Parser.ParseInput(String input, Token[]& tokens, ParseError[]& errors)\r\n   at Microsoft.PowerShell.PSConsoleReadLine.ParseInput()\r\n   at Microsoft.PowerShell.PSConsoleReadLine.GenerateRender(String defaultColor)\r\n   at Microsoft.PowerShell.PSConsoleReadLine.ForceRender()\r\n   at Microsoft.PowerShell.PSConsoleReadLine.Render()\r\n   at Microsoft.PowerShell.PSConsoleReadLine.Insert(String s)\r\n   at Microsoft.PowerShell.PSConsoleReadLine.ReadLine(Runspace runspace, EngineIntrinsics engineIntrinsics, CancellationToken cancellationToken, Nullable`1 lastRunStatus)\r\n   at Microsoft.PowerShell.PSConsoleReadLine.ReadLine(Runspace runspace, EngineIntrinsics engineIntrinsics, Nullable`1 lastRunStatus)\r\n   at CallSite.Target(Closure , CallSite , Type , Object , Object , Object )\r\n    Source         : System.Management.Automation\r\n    HResult        : -2146233087\r\n    StackTrace     :\r\n   at System.Management.Automation.ExceptionHandlingOps.ConvertToMethodInvocationException(Exception exception, Type typeToThrow, String methodName, Int32 numArgs, MemberInfo memberInfo)\r\n   at CallSite.Target(Closure , CallSite , Type , Object , Object , Object )\r\n   at System.Dynamic.UpdateDelegates.UpdateAndExecute4[T0,T1,T2,T3,TRet](CallSite site, T0 arg0, T1 arg1, T2 arg2, T3 arg3)\r\n   at System.Management.Automation.Interpreter.DynamicInstruction`5.Run(InterpretedFrame frame)\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\r\nCategoryInfo          : NotSpecified: (:) [], MethodInvocationException\r\nFullyQualifiedErrorId : ParseException\r\nInvocationInfo        :\r\n    ScriptLineNumber : 7\r\n    OffsetInLine     : 5\r\n    HistoryId        : -1\r\n    ScriptName       : C:\\Users\\Martin\\Documents\\PowerShell\\Modules\\PSReadLine\\2.2.0\\PSReadLine.psm1\r\n    Line             : [Microsoft.PowerShell.PSConsoleReadLine]::ReadLine($host.Runspace, $ExecutionContext, $lastRunStatus)\r\n\r\n    PositionMessage  : At C:\\Users\\Martin\\Documents\\PowerShell\\Modules\\PSReadLine\\2.2.0\\PSReadLine.psm1:7 char:5\r\n                       +     [Microsoft.PowerShell.PSConsoleReadLine]::ReadLine($host.Runspace \u2026\r\n                       +     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    PSScriptRoot     : C:\\Users\\Martin\\Documents\\PowerShell\\Modules\\PSReadLine\\2.2.0\r\n    PSCommandPath    : C:\\Users\\Martin\\Documents\\PowerShell\\Modules\\PSReadLine\\2.2.0\\PSReadLine.psm1\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at PSConsoleHostReadLine, C:\\Users\\Martin\\Documents\\PowerShell\\Modules\\PSReadLine\\2.2.0\\PSReadLine.psm1: line 7\n```\n\n\n### Environment data\n\n```powershell\nPS C:\\Users\\Martin> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.0-preview.10\r\nPSEdition                      Core\r\nGitCommitId                    7.2.0-preview.10\r\nOS                             Microsoft Windows 10.0.19044\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": "2022-07-19T17:42:31Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@MartinGC94 Good catch! If you want to fix I'd suggest to start with formal nullable annotations of the parser code.",
      "created_at": "2021-12-28T03:44:03Z",
      "updated_at": "2021-12-28T03:44:03Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:This issue was addressed in #16745, which has now been successfully released as `v7.3.0-preview.7`.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.3.0-preview.7)\n",
      "created_at": "2022-08-12T00:01:56Z",
      "updated_at": "2022-08-12T00:01:56Z"
    }
  ],
  "created_at": "2021-12-28T00:57:48Z",
  "number": 16676,
  "state": "closed",
  "title": "Parser throws with using statement aliases on new lines",
  "updated_at": "2022-08-12T00:01:56Z"
}