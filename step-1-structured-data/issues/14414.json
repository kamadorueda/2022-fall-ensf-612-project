{
  "_url": "https://github.com/PowerShell/PowerShell/issues/14414",
  "author": "SteveL-MSFT",
  "body": "<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\nThe current progress bar is large and complex and provides a different experience on Windows vs Linux/macOS.  Redo the progress bar to be a single line leveraging ANSI escape sequence to render progress. `$PSStyle.Progress` now controls configuration:\r\n\r\n`$PSStyle.Progress.Style` is an ANSI string setting the rendering style\r\n`$PSStyle.Progress.MaxWidth` sets the max width of the view, defaults to 120.  Set to 0 for console width.\r\n`$PSStyle.Progress.View` is an enum with values `Minimal` and `Classic` where `Classic` is existing rendering with no changes.  Current default is `Minimal`.\r\n\r\nExample:\r\n\r\n![Screen-Recording-2021-01-28-at-7](https://user-images.githubusercontent.com/11859881/106226950-33b21280-619d-11eb-9961-d029e3e24a8a.gif)\r\n\r\nSince this visualization is built into the console host, the new settings would not apply to other hosts like EditorServices.\r\n\r\nFix https://github.com/PowerShell/PowerShell/issues/14426\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [ ] None\r\n    - **OR**\r\n    - [x] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n        - [x] Experimental feature name(s): `PSAnsiProgress`\r\n- **User-facing changes**\r\n    - [ ] Not Applicable\r\n    - **OR**\r\n    - [x] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [x] Issue filed: https://github.com/MicrosoftDocs/PowerShell-Docs/issues/7195\r\n- **Testing - New and feature**\r\n    - [x] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [ ] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [x] I have considered the user experience from a tooling perspective and enumerated concerns in the summary. This may include:\r\n        - Impact on [PowerShell Editor Services](https://github.com/PowerShell/PowerShellEditorServices) which is used in the [PowerShell extension](https://github.com/PowerShell/vscode-powershell) for VSCode (which runs in a different PS Host).\r\n        - Impact on Completions (both in the console and in editors) - one of PowerShell's most powerful features.\r\n        - Impact on [PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer) (which provides linting & formatting in the editor extensions).\r\n        - Impact on [EditorSyntax](https://github.com/PowerShell/EditorSyntax) (which provides syntax highlighting with in VSCode, GitHub, and many other editors).\r\n",
  "closed_at": "2021-02-05T18:50:21Z",
  "comments": [
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Noticed an initial rendering issue with the `Expand-Archive` example I need to fix",
      "created_at": "2020-12-14T17:39:56Z",
      "updated_at": "2020-12-14T17:39:56Z"
    },
    {
      "author": "jhoneill",
      "author_association": "NONE",
      "body": "One of the attractions of the existing progress reporting is it can list things with a fair amount of detail and when they are done, the **output goes away**. This seems to end up with **clutter left behind** and the formatting makes it very \"attention grabbing\"    \r\nI would actually want to turn off progress indications if they did that, and would stop using `write-progress` in my code. \r\n\r\n\r\n",
      "created_at": "2020-12-14T18:16:05Z",
      "updated_at": "2020-12-14T18:16:05Z"
    },
    {
      "author": "doctordns",
      "author_association": "COLLABORATOR",
      "body": "> One of the attractions of the existing progress reporting is it can list things with a fair amount of detail and when they are done, the **output goes away**. This seems to end up with **clutter left behind** and the formatting makes it very \"attention grabbing\"\r\n> I would actually want to turn off progress indications if they did that, and would stop using `write-progress` in my code.\r\n\r\nThis progress bar and pop up stuff is also an issue for me in VS Code. Using VS Code and doing server management pops up all manner of stuff that obscures what is going on in the screen and does not go away. I'd like to see this addressed in general. ",
      "created_at": "2020-12-14T18:21:23Z",
      "updated_at": "2020-12-14T18:21:23Z"
    },
    {
      "author": "Jaykul",
      "author_association": "CONTRIBUTOR",
      "body": "> One of the attractions of the existing progress reporting is it can list things with a fair amount of detail and when they are done, the **output goes away**. This seems to end up with **clutter left behind** and the formatting makes it very \"attention grabbing\"\r\n\r\nThe current implementation is **far** bigger and more attention grabbing -- I wrote a script just last week using Invoke-RestMethod repeatedly which ended up completely obscuring the _more important_ actual output of the script behind a wall of RestMethod progress reports that weren't cleaned up until the script ended.\r\n\r\nObviously one can always turn off progress output (we already do this on PS5.1 because of performance problems), but I think leaving behind a trace of the progress _that was_ is better than the current situation where the progress is totally gone after the fact --regardless of outcome. Currently scripts _cannot_ rely heavily on progress to report state because if they crash, the information is completely lost.\r\n\r\nHaving said that, I have two other questions:\r\n1. Have you tested this with _long_ status strings? There's currently nothing preventing people from writing multiple lines worth of information into a Status or an Activity, right?\r\n2. Is there an option to still have multi-line output? I'm concerned that using the same space for the text and the progress is going to make this hard to deal with for some users...",
      "created_at": "2020-12-14T23:23:59Z",
      "updated_at": "2020-12-14T23:23:59Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@Jaykul regarding long status messages, I did test that and the current PR explicitly truncates it adding an ellipsis to the end.  This is similar to how content is truncated in other parts of PowerShell formatting.  Anyone writing progress needs to be thoughtful on the information being presented (like long file paths).  I'd rather than support multi-line output.\r\n\r\nDo you have a scenario that requires multi-line progress output?  Keep in mind that nested and multi-progress bars is supported, but each bar is limited to one line currently.",
      "created_at": "2020-12-14T23:53:33Z",
      "updated_at": "2020-12-14T23:53:33Z"
    },
    {
      "author": "jhoneill",
      "author_association": "NONE",
      "body": "> > One of the attractions of the existing progress reporting is it can list things with a fair amount of detail and when they are done, the **output goes away**. This seems to end up with **clutter left behind** and the formatting makes it very \"attention grabbing\"\r\n> \r\n> The current implementation is **far** bigger and more attention grabbing -- I wrote a script just last week using Invoke-RestMethod repeatedly which ended up completely obscuring the _more important_ actual output of the script behind a wall of RestMethod progress reports that weren't cleaned up until the script ended.\r\n> \r\n\r\nThe important thing is they are cleaned up when the script ends. The job of Write-Progress is to give the user some indication that the script hasn't hung. That's it. If you want information about what happened that's for Write-Debug, or Write-Verbose, or in the case of people who feel the strong urge to generate lots of display on the console  Write-host` with `-foreground`\r\n\r\n\r\n> Obviously one can always turn off progress output (we already do this on PS5.1 because of performance problems), but I think leaving behind a trace of the progress _that was_ is better than the current situation where the progress is totally gone after the fact --regardless of outcome. \r\n\r\nThere are two different requirements, printing \"chatty\" output which a programmer expects a user to read, and providing something which says \"still working, haven't crashed\". \r\n\r\n>Currently scripts _cannot_ rely heavily on progress to report state because if they crash, the information is completely lost.\r\n\r\nNor should they . Imagine if  (say) the copy dialog in explorer remained open to tell you how many bytes / files had been copied at what speed afterwards. You don't care, the tasks was completed without errors, you can get on with the next task without stopping to read about what happened which is past your ability to change. \r\n \r\n",
      "created_at": "2020-12-15T00:10:04Z",
      "updated_at": "2020-12-15T00:10:04Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Note that leaving the progress on screen is modeled after various Linux utilities.  I can certainly see arguments for both sides.",
      "created_at": "2020-12-15T00:16:01Z",
      "updated_at": "2020-12-15T00:16:01Z"
    },
    {
      "author": "jhoneill",
      "author_association": "NONE",
      "body": "> Note that leaving the progress on screen is modeled after various Linux utilities. I can certainly see arguments for both sides.\r\n\r\nWell yes, the unix world doesn't have verbose, debug, information and progress to write to, so all manner of garbage goes to standard output (and of course there isn't the distinction between \"For human eyeballs\" and \"Output\" that PowerShell has)  \r\n\r\nBeing cleaner and tidier is one of the attractions of PowerShell.   Getting the error output to be shorter was held to be a Good Thing, yes?    \r\nDevelopers have figured out what should be transient (something for eyeballs while work is happening) generally don't force users to read stuff they don't need to, and make most of the \"hey this is what the program has done\" stuff  verbose / debug. It works well , but nothing is stopping developers writing commands in the style of Linux, just replace write-verbose with write-host .  So this proposal doesn't allow anything extra but would take away something good and distinctive.   \r\n\r\nAnything which has a loop of display progress message, output a row, and remove the progress message will - I suspect - get the messages interleaved with the output. \r\n",
      "created_at": "2020-12-15T01:51:41Z",
      "updated_at": "2020-12-15T01:51:41Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Native commands actually use stderr for the purpose of progress/verbose/warning/error messages and stdout is only for output.  In this case, it's no different in that pipelining/redirection (unless stream(s) other than output is specified) only happens for output/stdout.  I'm thinking of making whether it stays or clears user settable at least during the experimental phase to get real world usage feedback.",
      "created_at": "2020-12-15T03:44:59Z",
      "updated_at": "2020-12-15T03:44:59Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I'd prefer to keep current (release version) behavior _in the PR_. I wonder we discuss this in the PR. I think we should discuss this in an issue for **all** kinds of progress bar. There are some issues with feedback for progress bar. Current design/implementation has fundamental difficulties and we could improve this.",
      "created_at": "2020-12-15T04:00:33Z",
      "updated_at": "2020-12-15T04:00:33Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Created https://github.com/PowerShell/PowerShell/issues/14426, let's have the design discussion there and keep discussion here for code review",
      "created_at": "2020-12-15T05:41:35Z",
      "updated_at": "2020-12-15T05:41:35Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as stale because it has been marked as requiring author feedback but has not had any activity for **15 days**. It will be closed if no further activity occurs **within 10 days of this comment**.",
      "created_at": "2021-01-02T08:00:09Z",
      "updated_at": "2021-01-02T08:00:09Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Found an issue with how progress is rendered when objects are emitted to pipeline.  Looks like I'll have to support clearing in all cases to make this work.",
      "created_at": "2021-01-20T17:31:27Z",
      "updated_at": "2021-01-20T17:31:27Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> Found an issue with how progress is rendered when objects are emitted to pipeline. Looks like I'll have to support clearing in all cases to make this work.\r\n\r\nOh, make sense if the PR is named _simpler_?",
      "created_at": "2021-01-20T18:07:52Z",
      "updated_at": "2021-01-20T18:07:52Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Remaining codefactor are existing style or by-design",
      "created_at": "2021-01-29T03:25:34Z",
      "updated_at": "2021-01-29T03:25:34Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "The CI tests are being flaky recently. I retried the failed CIs twice but both got test failures related to `WinCompat`:\r\n> Additional tests for Import-Module with WinCompat.Tests that ErrorAction/WarningAction have effect when Import-Module with WinCompat is used. Verify that Warning is generated with default WarningAction\r\n\r\nGiven that the second to last commit had successful CI runs (only CodeFactor failed which can be ignored) and the last commit only made trivial changes to code that is unrelated to the failed `WinCompat` tests, I will merge this PR.",
      "created_at": "2021-02-05T18:50:01Z",
      "updated_at": "2021-02-05T18:50:01Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@SteveL-MSFT Just noticed a small issue with the new progress bar:\r\n\r\n![image](https://user-images.githubusercontent.com/127450/107076596-7d53bc00-67a0-11eb-8cf9-492c96bd0e03.png)\r\n\r\nWhen the `MaxWidth` is not big enough and the message cannot be fully displayed, I expect the message will be truncated with ellipsis `...`, but it displays only 1 dot.",
      "created_at": "2021-02-05T18:56:23Z",
      "updated_at": "2021-02-05T18:56:23Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "Ah, another issue, when `MaxWidth` is too small to have enough space for the `[...]` part, progress rendering will fail with exceptions:\r\n```\r\nPS:12> $PSStyle.Progress.MaxWidth = 10\r\nPS:13> Expand-Archive -Path .\\source.zip -DestinationPath C:\\arena\\tmp\\deleteme\r\nWrite-Progress: C:\\arena\\repos\\powershell\\src\\powershell-win-core\\bin\\debug\\net5.0\\win7-x64\\publish\\Modules\\Microsoft.PowerShell.Archive\\Microsoft.PowerShell.Archive.psm1:1179\r\nLine |\r\n1179 |          Write-Progress -Activity $cmdletName -Status $status -Percent \u2026\r\n     |          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Length cannot be less than zero. (Parameter 'length')\r\n\r\nRemove-Item: C:\\arena\\repos\\powershell\\src\\powershell-win-core\\bin\\debug\\net5.0\\win7-x64\\publish\\Modules\\Microsoft.PowerShell.Archive\\Microsoft.PowerShell.Archive.psm1:418\r\nLine |\r\n 418 |  \u2026               $expandedItems | % { Remove-Item \"$_\" -Force -Recurse }\r\n     |                                       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Cannot find path 'C:\\arena\\tmp\\deleteme\\PowerShell-7.2.0-preview.1\\.devcontainer\\' because it\r\n     | does not exist.\r\n\r\nRemove-Item: C:\\arena\\repos\\powershell\\src\\powershell-win-core\\bin\\debug\\net5.0\\win7-x64\\publish\\Modules\\Microsoft.PowerShell.Archive\\Microsoft.PowerShell.Archive.psm1:418\r\nLine |\r\n 418 |  \u2026               $expandedItems | % { Remove-Item \"$_\" -Force -Recurse }\r\n     |                                       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Cannot find path 'C:\\arena\\tmp\\deleteme\\PowerShell-7.2.0-preview.1\\.devcontainer\\Dockerfile'\r\n     | because it does not exist.\r\n\r\nRemove-Item: C:\\arena\\repos\\powershell\\src\\powershell-win-core\\bin\\debug\\net5.0\\win7-x64\\publish\\Modules\\Microsoft.PowerShell.Archive\\Microsoft.PowerShell.Archive.psm1:418\r\nLine |\r\n 418 |  \u2026               $expandedItems | % { Remove-Item \"$_\" -Force -Recurse }\r\n     |                                       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Cannot find path\r\n     | 'C:\\arena\\tmp\\deleteme\\PowerShell-7.2.0-preview.1\\.devcontainer\\devcontainer.json' because it\r\n     | does not exist.\r\n\r\nRemove-Item: C:\\arena\\repos\\powershell\\src\\powershell-win-core\\bin\\debug\\net5.0\\win7-x64\\publish\\Modules\\Microsoft.PowerShell.Archive\\Microsoft.PowerShell.Archive.psm1:418\r\nLine |\r\n 418 |  \u2026               $expandedItems | % { Remove-Item \"$_\" -Force -Recurse }\r\n     |                                       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Cannot find path 'C:\\arena\\tmp\\deleteme\\PowerShell-7.2.0-preview.1\\.devcontainer\\fedora30\\'\r\n     | because it does not exist.\r\n\r\nRemove-Item: C:\\arena\\repos\\powershell\\src\\powershell-win-core\\bin\\debug\\net5.0\\win7-x64\\publish\\Modules\\Microsoft.PowerShell.Archive\\Microsoft.PowerShell.Archive.psm1:418\r\nLine |\r\n 418 |  \u2026               $expandedItems | % { Remove-Item \"$_\" -Force -Recurse }\r\n     |                                       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Cannot find path\r\n     | 'C:\\arena\\tmp\\deleteme\\PowerShell-7.2.0-preview.1\\.devcontainer\\fedora30\\Dockerfile' because it\r\n     | does not exist.\r\n\r\nRemove-Item: C:\\arena\\repos\\powershell\\src\\powershell-win-core\\bin\\debug\\net5.0\\win7-x64\\publish\\Modules\\Microsoft.PowerShell.Archive\\Microsoft.PowerShell.Archive.psm1:418\r\nLine |\r\n 418 |  \u2026               $expandedItems | % { Remove-Item \"$_\" -Force -Recurse }\r\n     |                                       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Cannot find path\r\n     | 'C:\\arena\\tmp\\deleteme\\PowerShell-7.2.0-preview.1\\.devcontainer\\fedora30\\devcontainer.json'\r\n     | because it does not exist.\r\n\r\nRemove-Item: C:\\arena\\repos\\powershell\\src\\powershell-win-core\\bin\\debug\\net5.0\\win7-x64\\publish\\Modules\\Microsoft.PowerShell.Archive\\Microsoft.PowerShell.Archive.psm1:418\r\nLine |\r\n 418 |  \u2026               $expandedItems | % { Remove-Item \"$_\" -Force -Recurse }\r\n     |                                       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Cannot find path 'C:\\arena\\tmp\\deleteme\\PowerShell-7.2.0-preview.1\\.editorconfig' because it does\r\n     | not exist.\r\n\r\nWrite-Progress: C:\\arena\\repos\\powershell\\src\\powershell-win-core\\bin\\debug\\net5.0\\win7-x64\\publish\\Modules\\Microsoft.PowerShell.Archive\\Microsoft.PowerShell.Archive.psm1:1179\r\nLine |\r\n1179 |          Write-Progress -Activity $cmdletName -Status $status -Percent \u2026\r\n     |          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Length cannot be less than zero. (Parameter 'length')\r\n```",
      "created_at": "2021-02-05T18:59:43Z",
      "updated_at": "2021-02-05T18:59:43Z"
    },
    {
      "author": "SeeminglyScience",
      "author_association": "COLLABORATOR",
      "body": "> Since this visualization is built into the console host, the new settings would not apply to other hosts like EditorServices.\r\n\r\nPSES holds onto a copy of `ConsoleHost` and uses it's implementation of `WriteProgress`.  I don't think it's likely to cause issues, but it will apply there as well.",
      "created_at": "2021-02-05T19:00:15Z",
      "updated_at": "2021-02-05T19:00:15Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.2.0-preview.3` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.2.0-preview.3)\n",
      "created_at": "2021-02-12T02:07:22Z",
      "updated_at": "2021-02-12T02:07:22Z"
    }
  ],
  "created_at": "2020-12-14T16:10:56Z",
  "number": 14414,
  "state": "closed",
  "title": "Add minimal progress bar using ANSI rendering",
  "updated_at": "2021-02-12T02:07:22Z"
}