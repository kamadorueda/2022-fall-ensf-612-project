{
  "_url": "https://github.com/PowerShell/PowerShell/issues/12792",
  "author": "heaths",
  "body": "Fixes #11995 and fixes #12011 based on changes described in https://github.com/PowerShell/PowerShell/issues/12011#issuecomment-596105112.",
  "closed_at": "2020-05-27T22:45:12Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@heaths Please look CI fail.",
      "created_at": "2020-05-26T08:03:56Z",
      "updated_at": "2020-05-26T08:03:56Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@heaths take a look at https://dev.azure.com/powershell/PowerShell/_build/results?buildId=53706&view=logs&j=1057fe42-c88b-5deb-88ad-59245c714665&t=1888043b-254d-5761-80ec-47d0d8adc59a, the test detected some file changes, if this is expected, just follow the instructions in the output",
      "created_at": "2020-05-26T14:29:37Z",
      "updated_at": "2020-05-26T14:29:37Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "I updated the wxs for you and filed:  https://github.com/PowerShell/PowerShell/issues/12799",
      "created_at": "2020-05-26T17:26:08Z",
      "updated_at": "2020-05-26T17:26:08Z"
    },
    {
      "author": "heaths",
      "author_association": "CONTRIBUTOR",
      "body": "@TravisEz13, thanks. I was going to get to this tonight.\r\n\r\nWere these actually removed, though? I'm not clear on whether their presence or not is actually a bug. They aren't needed except for `ARPPRODUCTICON` which must reference a row in the `Icon` table but, unless you're advertising your product (almost no one does that anymore - Office stopped over a decade ago), shouldn't be used for shortcuts.",
      "created_at": "2020-05-26T22:36:16Z",
      "updated_at": "2020-05-26T22:36:16Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> Were these actually removed, though?\r\n\r\nI wonder too how WiX works - wxs file still contains references to the icons.",
      "created_at": "2020-05-27T04:07:07Z",
      "updated_at": "2020-05-27T04:07:07Z"
    },
    {
      "author": "heaths",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov, what exactly do you mean? As a long-time developer on WiX (I designed and implemented many features in it, most notably package ref-counting that other installers use as well), I could probably explain if you can clarify what you meant.\r\n\r\nWhen the `<Icon>` is used, the binding (during linking, which is light.exe) knows to stream in a file reference; otherwise, when just a normal `<File>` is process the binder puts it in a cabinet that is later left external or streamed into the MSI based on `<Media>` entries (`<MediaTemplate>` provides default behavior and is often easier for most packages).\r\n\r\nMy main change here was to remove most GUIDs. They aren't needed, except for the `UpgradeCode` property (you normally want that fixed) and shared components without a single key path resource. In fact, just being a shared component - if it always resolves to the same key path - will get the same GUID. This change is mainly about letting WiX create a durable GUID based on the key path at build time, which is far more reliable and easier than people having to maintain it, which wasn't being done here and the main problem with files and registry values not getting cleaned up (they were ref-counted). See https://heaths.dev/setup/2020/05/13/simple-wix-project.html for more explanation and links to many of my old blog posts on what is now the VS Setup team blog (used to be my professional blog - which I used mostly for team purposes - up until a year or so ago).\n\n<blockquote><div>Heath Stewart\u2019s Blog</div><div><strong><a href=\"https://heaths.dev/setup/2020/05/13/simple-wix-project.html\">Simple WiX Project</a></strong></div><div>Globally-unique identifiers (GUIDs) are often the brunt of jokes. Windows Installer packages (.msi files) are full of them, from the required ProductCode, to highly-recommended UpgradeCode, package codes, and required component GUIDs. Authoring an MSI doesn\u2019t require you create and manage so many GUIDs, however. In fact, Windows Installer XML (WiX) has in the last few years made great strides in making sure you don\u2019t have to, and recommends you don\u2019t.</div></blockquote>",
      "created_at": "2020-05-27T17:34:43Z",
      "updated_at": "2020-05-27T17:34:46Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> what exactly do you mean?\r\n\r\nI mean @TravisEz13 's commit and your question \"Were these actually removed, though?\".",
      "created_at": "2020-05-27T17:49:50Z",
      "updated_at": "2020-05-27T17:49:50Z"
    },
    {
      "author": "heaths",
      "author_association": "CONTRIBUTOR",
      "body": "Last I updated the file via `git rebase` they were still there.",
      "created_at": "2020-05-27T18:03:56Z",
      "updated_at": "2020-05-27T18:03:56Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Yes, they are on file system. My concern is that it seems wxs file contains references to the files.",
      "created_at": "2020-05-27T18:10:58Z",
      "updated_at": "2020-05-27T18:10:58Z"
    },
    {
      "author": "heaths",
      "author_association": "CONTRIBUTOR",
      "body": "They shouldn't anymore. It's possible when I generated my repo wasn't entirely clean. It was a bit behind before I rebased on upstream/master this past weekend since I've been swamped with work stuff.",
      "created_at": "2020-05-27T18:54:16Z",
      "updated_at": "2020-05-27T18:54:16Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@heaths \r\n> Were these actually removed, though? I'm not clear on whether their presence or not is actually a bug. \r\n\r\nin CI we generate multiple packages at at time.  There is probably a bug where one of the package generations deletes the icons.  There is code in the packaging to create a staging folder.  We need to make sure all types of packages that add/or remove files from the build use a staging directory.\r\n\r\nI filed a bug to investigate.\r\n\r\n> I updated the wxs for you and filed: #12799",
      "created_at": "2020-05-27T22:08:22Z",
      "updated_at": "2020-05-27T22:08:22Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "https://github.com/PowerShell/PowerShell/issues/12799 was an existing bug.   We can merge this PR.",
      "created_at": "2020-05-27T22:13:53Z",
      "updated_at": "2020-05-27T22:13:53Z"
    },
    {
      "author": "heaths",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks. If I can find time, there's some more clean-up I'd like to do (you can do almost everything in the .wxs itself, which makes it easier to maintain since it's not spread all over), but wasn't necessary for now. I also recommend passing parameters instead of setting environment variables, as the scope is smaller (though, at least you scope them to the current and child processes).",
      "created_at": "2020-05-27T23:19:45Z",
      "updated_at": "2020-05-27T23:19:45Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@heaths Thanks for great contribution!",
      "created_at": "2020-05-28T07:56:16Z",
      "updated_at": "2020-05-28T07:56:16Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "Thanks for your contribution",
      "created_at": "2020-05-28T17:01:32Z",
      "updated_at": "2020-05-28T17:01:32Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.1.0-preview.4` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.1.0-preview.4)\n",
      "created_at": "2020-06-25T19:03:26Z",
      "updated_at": "2020-06-25T19:03:26Z"
    }
  ],
  "created_at": "2020-05-26T07:37:18Z",
  "number": 12792,
  "state": "closed",
  "title": "Fix MSI upgrade and shortcut issues",
  "updated_at": "2020-07-01T00:14:01Z"
}