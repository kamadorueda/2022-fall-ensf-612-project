{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16894",
  "author": "et1975",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nVery esoteric setup, but I can consistently reproduce pwsh child process stared via `Enter-PSSession` over SSH crashing with `SIGABRT` when using Posh-SSH to upload a file over SFTP.\r\nAlpine and Debian show the same problem.\r\n\r\nReproduction Steps\r\nUse an mcr powershell container as the base, add SSHD and configure Powershell subsystem.\r\nSomething like\r\n\r\n```\r\nFROM mcr.microsoft.com/powershell:7.2.1-debian-bullseye-slim\r\nRUN apt-get update \\\r\n    && apt-get -y install openssh-server \\\r\n    && rm -rf /var/lib/apt/lists/* \\\r\n    && mkdir -p /var/run/sshd \\\r\n    && ssh-keygen -A \\\r\n    && sed \"s/Subsystem.*sftp.*/Subsystem powershell \\/usr\\/bin\\/pwsh -sshs -NoLogo -NoProfile/\" -i /etc/ssh/sshd_config\r\nENTRYPOINT [\"/usr/sbin/sshd\", \"-D\", \"-e\"]\r\n```\r\n\r\nStart remote session into such a container, initiate an upload with `Set-SFTPItem` - it crashes at random, the larger the file the more likely it is to happen.\r\n> \"The SSH client session has ended with error message: The SSH transport process has abruptly terminated causing this remote session to break.\"\r\n\r\n\n\n### Expected behavior\n\n```console\nShould not crash.\n```\n\n\n### Actual behavior\n\n```console\nCrashes with this stack trace:\r\n\r\n* thread #39, name = '.NET ThreadPool', stop reason = signal SIGABRT\r\n    frame #0: 0x00007fcd715fbce1 libc.so.6`raise + 321\r\nlibc.so.6`raise:\r\n->  0x7fcd715fbce1 <+321>: movq   0x108(%rsp), %rax\r\n    0x7fcd715fbce9 <+329>: subq   %fs:0x28, %rax\r\n    0x7fcd715fbcf2 <+338>: jne    0x7fcd715fbd14            ; <+372>\r\n    0x7fcd715fbcf4 <+340>: movl   %r8d, %eax\r\n(lldb) clrstack\r\nOS Thread Id: 0x2632 (39)\r\n        Child SP               IP Call Site\r\n00007FCB4F7FD680 00007fcd715fbce1 [HelperMethodFrame: 00007fcb4f7fd680] \r\n00007FCB4F7FD800 00007FCD01FB9158 System.ThrowHelper.ThrowArgumentOutOfRange_IndexException() [/_/src/libraries/System.Private.CoreLib/src/System/ThrowHelper.cs @ 101]\r\n00007FCB4F7FD810 00007FCCFCEB10C1 System.Collections.Generic.List`1[[System.__Canon, System.Private.CoreLib]].get_Item(Int32) [/_/src/libraries/System.Private.CoreLib/src/System/Collections/Generic/List.cs @ 150]\r\n00007FCB4F7FD820 00007FCCF876B8F1 System.Management.Automation.PSDataCollection`1[[System.__Canon, System.Private.CoreLib]].get_Item(Int32)\r\n00007FCB4F7FD860 00007FCCF83BE6F8 System.Management.Automation.ServerPowerShellDriver.HandleProgressAdded(System.Object, System.Management.Automation.DataAddedEventArgs)\r\n00007FCB4F7FD8A0 00007FCCF876CE5D System.Management.Automation.PSDataCollection`1[[System.__Canon, System.Private.CoreLib]].RaiseDataAddedEvent(System.Guid, Int32)\r\n00007FCB4F7FD8E0 00007FCCF876CD44 System.Management.Automation.PSDataCollection`1[[System.__Canon, System.Private.CoreLib]].RaiseEvents(System.Guid, Int32)\r\n00007FCB4F7FD940 00007FCCF876CF85 System.Management.Automation.PSDataCollection`1[[System.__Canon, System.Private.CoreLib]].InternalAdd(System.Guid, System.__Canon)\r\n00007FCB4F7FD9A0 00007FCCF833CE4A System.Management.Automation.PSInformationalBuffers.AddProgress(System.Management.Automation.ProgressRecord)\r\n00007FCB4F7FD9B0 00007FCCF85C2D32 System.Management.Automation.Internal.Host.InternalHostUserInterface.WriteProgress(Int64, System.Management.Automation.ProgressRecord)\r\n00007FCB4F7FD9E0 00007FCD01FB6A1E SSH.OperationProgressHelper+<>c__DisplayClass9_0.<.ctor>b__1(UInt64)\r\n00007FCB4F7FDA30 00007FCCFFBC2B14 System.Threading.QueueUserWorkItemCallback.Execute() [/_/src/libraries/System.Private.CoreLib/src/System/Threading/ThreadPoolWorkQueue.cs @ 907]\r\n00007FCB4F7FDA60 00007FCCFF349F20 System.Threading.ThreadPoolWorkQueue.Dispatch()\r\n00007FCB4F7FDAD0 00007FCCF74A3B35 System.Threading.PortableThreadPool+WorkerThread.WorkerThreadStart() [/_/src/libraries/System.Private.CoreLib/src/System/Threading/PortableThreadPool.WorkerThread.cs @ 63]\r\n00007FCB4F7FDCF0 00007fcd71140747 [DebuggerU2MCatchHandlerFrame: 00007fcb4f7fdcf0] \r\n```\n```\n\n\n### Error details\n\n_No response_\n\n### Environment data\n\n```powershell\nPS /> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.1\r\nPSEdition                      Core\r\nGitCommitId                    7.2.1\r\nOS                             Linux 5.10.76-linuxkit #1 SMP Mon Nov 8 10:21:19 UTC 2021\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": null,
  "comments": [
    {
      "author": "et1975",
      "author_association": "NONE",
      "body": "Found a workaround: `$ProgressPreference = \"SilentlyContinue\"`\r\n\r\n",
      "created_at": "2022-02-17T15:39:45Z",
      "updated_at": "2022-02-17T15:39:45Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@WG-Remoting\r\n@et1975  Thanks for the report.  It looks like the out-of-range exception is being generated here.\r\nhttps://github.com/PowerShell/PowerShell/blob/7cc9c874730e87b06dbe54d50e77c1c472996c54/src/System.Management.Automation/engine/remoting/server/ServerPowerShellDriver.cs#L552\r\n\r\nThis is very old code with what looks like a hack to adjust the data collection index.  Needs further investigation.",
      "created_at": "2022-04-07T17:22:24Z",
      "updated_at": "2022-04-07T17:22:24Z"
    }
  ],
  "created_at": "2022-02-17T14:59:43Z",
  "labels": [
    "Issue-Bug",
    "WG-Remoting",
    "Needs-Investigation"
  ],
  "number": 16894,
  "state": "open",
  "title": "Powershell running as a child process spawned by SSHD on linux crashes on progress tracking",
  "updated_at": "2022-04-07T17:22:49Z"
}