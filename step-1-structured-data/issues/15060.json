{
  "_url": "https://github.com/PowerShell/PowerShell/issues/15060",
  "author": "techienickb",
  "body": "---\r\nname: Bug report\ud83d\udc1b\r\nabout: Unable to connect to exchange powershell with PowerShell.net 7.1x\r\ntitle: \"Unable to connect to exchange powershell with PowerShell.net 7.1x\"\r\nlabels: Needs-Triage\r\nassignees: ''\r\n\r\n---\r\n## Steps to reproduce\r\n\r\n```csharp\r\n//Set Credential\r\nSecureString s = new SecureString();\r\nConfig.GetValue<string>(pass).ToCharArray().ToList().ForEach(p => s.AppendChar(p));\r\n\r\n//Use a public client app to get a OAuth token for CUBOT\r\nvar publicClientApplication = PublicClientApplicationBuilder.Create(appid).WithTenantId(Config.GetSection(\"AzureAd\").GetValue<string>(\"tenantId\")).Build();\r\nvar tokenworker = publicClientApplication.AcquireTokenByUsernamePassword(new string[] { \"https://outlook.office365.com/.default\" }, Config.GetValue<string>(user), s).ExecuteAsync();\r\ntokenworker.Wait();\r\n\r\nRunspace runspace = System.Management.Automation.Runspaces.RunspaceFactory.CreateRunspace();\r\nPowerShell powershell = PowerShell.Create();\r\nPSCommand command = new PSCommand();\r\n\r\n\r\ns = new SecureString();\r\n//convert the OAuth Token into a SecureString\r\n$\"Bearer {tokenworker.Result.AccessToken}\".ToCharArray().ToList().ForEach(p => s.AppendChar(p));\r\n\r\n//Create a Powershell Credential using the CUBot User and the OAuth SecureString\r\nPSCred = new PSCredential(Config.GetValue<string>(\"poshuser\"), s);\r\n\r\ncommand.AddCommand(\"New-PSSession\");\r\ncommand.AddParameter(\"ConfigurationName\", \"Microsoft.Exchange\");\r\n//convert basic auth to modern with the query string\r\ncommand.AddParameter(\"ConnectionUri\", new Uri(\"https://outlook.office365.com/powershell-liveid/?BasicAuthToOAuthConversion=true\"));\r\ncommand.AddParameter(\"Credential\", PSCred);\r\n//Yes still basic auth but we are passing the OAuth token not a password\r\ncommand.AddParameter(\"Authentication\", \"Basic\");\r\ncommand.AddParameter(\"AllowRedirection\");\r\npowershell.Commands = command;\r\n\r\nrunspace.Open();\r\npowershell.Runspace = runspace;\r\nResult = powershell.Invoke(); \r\n```\r\n\r\n## Expected behavior\r\n\r\n```none\r\nsuccessfully connects to exchange online\r\n```\r\n\r\n## Actual behavior\r\n\r\n```none\r\nunable to connect\r\n```\r\n\r\n## Environment data\r\n\r\n\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.3\r\nPSEdition                      Core\r\nGitCommitId                    7.1.3\r\nOS                             Microsoft Windows 10.0.21387\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\nC# .net core 5\r\nWindows 10/Azure App Service\r\n```\r\n\r\nIssue is in all 7.1.x builds of the SDK System.Management.Automation namespaces.\r\nThis script works in 7.0.x but does not in 7.1.x\r\n\r\nThe error you get is to unable to connect to remote resource/connection closed.  Again this code works in 7.0.x (inc 7.0.6) but does not in 7.1.3",
  "closed_at": null,
  "comments": [
    {
      "author": "jborean93",
      "author_association": "COLLABORATOR",
      "body": "Can you share the full error from `powershell.Streams.Error`? This is important to try and figure out if the error is failing to load the `libmi` library or an actual connection error from WSMan.",
      "created_at": "2021-03-18T18:58:04Z",
      "updated_at": "2021-03-18T18:58:04Z"
    },
    {
      "author": "techienickb",
      "author_association": "NONE",
      "body": "\"[outlook.office365.com] An error has occurred which PowerShell cannot handle. A remote session might have ended.\"\r\n\r\n\r\n\u00a0 | Name | Value | Type\r\n-- | -- | -- | --\r\n\u25e2 | [0] | {[outlook.office365.com] An error has occurred which PowerShell cannot handle. A remote session might have ended.} | System.Management.Automation.ErrorRecord\r\n\u25e2 | CategoryInfo | {OpenError: (System.Management.A\u2026tion.RemoteRunspace:RemoteRunspace) [New-PSSession], PSRemotingDataStructureException} | System.Management.Automation.ErrorCategoryInfo\r\n\u25b6 | Exception | {\"An error has occurred which PowerShell cannot handle. A remote session might have ended.\"} | System.Exception {System.Management.Automation.Remoting.PSRemotingDataStructureException}\r\n\u00a0 | FullyQualifiedErrorId | \"PSSessionOpenFailed\" | string\r\n\u25b6 | InvocationInfo | Command = {New-PSSession} | System.Management.Automation.InvocationInfo\r\n\r\n\r\n",
      "created_at": "2021-03-19T09:03:56Z",
      "updated_at": "2021-03-19T09:04:06Z"
    },
    {
      "author": "jborean93",
      "author_association": "COLLABORATOR",
      "body": "Hmm I\u2019m not sure why this is sorry it is not what I was expecting.",
      "created_at": "2021-03-19T20:40:49Z",
      "updated_at": "2021-03-19T20:40:49Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "Remoting working group:\r\n@techienickb Please update the issue description with all the information from the issue template which is here:\r\nhttps://github.com/PowerShell/PowerShell/blob/master/.github/ISSUE_TEMPLATE/Bug_Report.md\n\n<blockquote><img src=\"https://repository-images.githubusercontent.com/49609581/aad0ad80-cdec-11ea-8248-a37bc0571bfd\" width=\"48\" align=\"right\"><div><img src=\"https://github.githubassets.com/favicons/favicon.svg\" height=\"14\"> GitHub</div><div><strong><a href=\"https://github.com/PowerShell/PowerShell\">PowerShell/PowerShell</a></strong></div><div>PowerShell for every system! Contribute to PowerShell/PowerShell development by creating an account on GitHub.</div></blockquote>",
      "created_at": "2021-05-19T21:23:44Z",
      "updated_at": "2021-05-19T21:23:46Z"
    },
    {
      "author": "techienickb",
      "author_association": "NONE",
      "body": "> \r\n> \r\n> Remoting working group:\r\n> @techienickb Please update the issue description with all the information from the issue template which is here:\r\n> https://github.com/PowerShell/PowerShell/blob/master/.github/ISSUE_TEMPLATE/Bug_Report.md\r\n> \r\n> > <img alt=\"\" width=\"48\" src=\"https://repository-images.githubusercontent.com/49609581/aad0ad80-cdec-11ea-8248-a37bc0571bfd\"><img alt=\"\" height=\"14\" src=\"https://camo.githubusercontent.com/b6a12909f1e31185a69a73d59208c507a992236d3230f9fc18e85058ae3d19e7/68747470733a2f2f6769746875622e6769746875626173736574732e636f6d2f66617669636f6e732f66617669636f6e2e737667\"> GitHub**[PowerShell/PowerShell](https://github.com/PowerShell/PowerShell)**PowerShell for every system! Contribute to PowerShell/PowerShell development by creating an account on GitHub.\r\n\r\nSorry for the delay, I've now updated with the template\n\n<blockquote><img src=\"https://repository-images.githubusercontent.com/49609581/aad0ad80-cdec-11ea-8248-a37bc0571bfd\" width=\"48\" align=\"right\"><div><img src=\"https://github.githubassets.com/favicons/favicon.svg\" height=\"14\"> GitHub</div><div><strong><a href=\"https://github.com/PowerShell/PowerShell\">PowerShell/PowerShell</a></strong></div><div>PowerShell for every system! Contribute to PowerShell/PowerShell development by creating an account on GitHub.</div></blockquote>",
      "created_at": "2021-05-26T17:15:40Z",
      "updated_at": "2021-05-26T17:15:42Z"
    },
    {
      "author": "techienickb",
      "author_association": "NONE",
      "body": "Any update on this issue?  Testing in .net 6 and the latest preview (7.2.0) of the SDK.\r\n```\r\n\r\n`fail: Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddleware[1]\r\n      An unhandled exception has occurred while executing the request.\r\n      System.Management.Automation.RuntimeException: An error has occurred which PowerShell cannot handle. A remote session might have ended.\r\n       ---> System.Management.Automation.Remoting.PSRemotingDataStructureException: An error has occurred which PowerShell cannot handle. A remote session might have ended.\r\n       ---> System.NotSupportedException: BinaryFormatter serialization and deserialization are disabled within this application. See https://aka.ms/binaryformatter for more information.\r\n         at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Serialize(Stream serializationStream, Object graph) in System.Runtime.Serialization.Formatters.dll:token 0x60001c7+0x11\r\n         at System.Management.Automation.Remoting.RemoteSessionCapability.GetCurrentTimeZoneInByteFormat() in System.Management.Automation.dll:token 0x6004807+0x15\r\n         at System.Management.Automation.RemotingEncoder.GenerateClientSessionCapability(RemoteSessionCapability capability, Guid runspacePoolId) in System.Management.Automation.dll:token 0x6003537+0x7\r\n         at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerImpl.HandleNegotiationSendingStateChange() in System.Management.Automation.dll:token 0x6004654+0x0\r\n         at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerImpl.HandleStateChanged(Object sender, RemoteSessionStateEventArgs arg) in System.Management.Automation.dll:token 0x6004653+0x2a\r\n         at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerStateMachine.RaiseStateMachineEvents() in System.Management.Automation.dll:token 0x600460f+0x10\r\n         at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerStateMachine.ProcessEvents() in System.Management.Automation.dll:token 0x600460d+0x56\r\n         --- End of inner exception stack trace ---\r\n         at Microsoft.Exchange.Management.ExoPowershellSnapin.NewExoPSSession.HandleError(PSDataCollection1 errors) in Microsoft.Exchange.Management.ExoPowershellGalleryModule.dll:token 0x600007b+0x37\r\n         at Microsoft.Exchange.Management.ExoPowershellSnapin.NewExoPSSession.ExecutePsCommand(PSCommand command) in Microsoft.Exchange.Management.ExoPowershellGalleryModule.dll:token 0x6000076+0x1d\r\n         at Microsoft.Exchange.Management.ExoPowershellSnapin.NewExoPSSession.ProcessNewConnection() in Microsoft.Exchange.Management.ExoPowershellGalleryModule.dll:token 0x6000077+0x57c\r\n         at Microsoft.Exchange.Management.ExoPowershellSnapin.NewExoPSSession.ProcessRecord() in Microsoft.Exchange.Management.ExoPowershellGalleryModule.dll:token 0x600006e+0xf\r\n         at System.Management.Automation.Cmdlet.DoProcessRecord() in System.Management.Automation.dll:token 0x6001e2a+0x0\r\n         at System.Management.Automation.CommandProcessor.ProcessRecord() in System.Management.Automation.dll:token 0x6002100+0x0\r\n         --- End of inner exception stack trace ---\r\n         at System.Management.Automation.Runspaces.AsyncResult.EndInvoke() in System.Management.Automation.dll:token 0x60051a6+0x82\r\n         at System.Management.Automation.PowerShell.EndInvoke(IAsyncResult asyncResult) in System.Management.Automation.dll:token 0x60027ff+0x67\r\n         at System.Threading.Tasks.TaskFactory1.FromAsyncCoreLogic(IAsyncResult iar, Func2 endFunction, Action1 endAction, Task1 promise, Boolean requiresSynchronization) in System.Private.CoreLib.dll:token 0x60031be+0xf\r\n      --- End of stack trace from previous location ---\r\n         at CU.M365Management.PS.HostedRunspace.RunScript(String scriptContents, Dictionary2 scriptParameters) in H:\\source\\repos\\CU M365 Management Web\\CU.M365Management\\PS\\RunspaceStarter.cs:line 89\r\n         at CU.M365Management.Controllers.NewExPoShController.Get() in H:\\source\\repos\\CU M365 Management Web\\CU.M365Management\\Controllers\\NewExPoShController.cs:line 34\r\n         at lambda_method923(Closure , Object )\r\n         at Microsoft.AspNetCore.Mvc.Infrastructure.ActionMethodExecutor.TaskOfActionResultExecutor.Execute(IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments) in Microsoft.AspNetCore.Mvc.Core.dll:token 0x6000fc3+0x5b\r\n         at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeActionMethodAsync>g__Logged|12_1(ControllerActionInvoker invoker) in Microsoft.AspNetCore.Mvc.Core.dll:token 0x60009c1+0x153\r\n         at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeNextActionFilterAsync>g__Awaited|10_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted) in Microsoft.AspNetCore.Mvc.Core.dll:token 0x60009bd+0x6a\r\n         at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Rethrow(ActionExecutedContextSealed context) in Microsoft.AspNetCore.Mvc.Core.dll:token 0x60009ba+0x15\r\n         at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Next(State& next, Scope& scope, Object& state, Boolean& isCompleted) in Microsoft.AspNetCore.Mvc.Core.dll:token 0x60009b5+0x39a\r\n         at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeInnerFilterAsync>g__Awaited|13_0(ControllerActionInvokerrollerActionInvokrollerActrollerActionrollerActionInvorollerAcrollerArollerollerollerorollerActionInvoker invoker, Task lastTask, SrollerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted) in Microsoft.AspNetCore.Mvc.Core.dll:token 0x60009c2+0x6e\r\n         at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeFilterPipelineAsync>g__Awaited|20_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted) in Microsoft.AspNetCore.Mvc.Core.dll:token 0x6000a81+0x65\r\n         at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker) in Microsoft.AspNetCore.Mvc.Core.dll:token 0x6000a7e+0x172\r\n         at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker) in Microsoft.AspNetCore.Mvc.Core.dll:token 0x6000a7e+0x21d\r\n         at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|6_0(Endpoint endpoint, Task requestTask, ILogger logger) in Microsoft.AspNetCore.Routing.dll:token 0x60000ab+0x5e\r\n         at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context) in Microsoft.AspNetCore.Authorization.Policy.dll:token 0x6000013+0x16b\r\n         at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context) in Microsoft.AspNetCore.Authentication.dll:token 0x6000049+0x3be\r\n         at NSwag.AspNetCore.Middlewares.SwaggerUiIndexMiddleware.Invoke(HttpContext context) in NSwag.AspNetCore.dll:token 0x6000099+0x27a\r\n         at NSwag.AspNetCore.Middlewares.RedirectToIndexMiddleware.Invoke(HttpContext context) in NSwag.AspNetCore.dll:token 0x6000097+0x178\r\n         at NSwag.AspNetCore.Middlewares.SwaggerUiIndexMiddleware.Invoke(HttpContext context) in NSwag.AspNetCore.dll:token 0x6000099+0x27a\r\n         at NSwag.AspNetCore.Middlewares.RedirectToIndexMiddleware.Invoke(HttpContext context) in NSwag.AspNetCore.dll:token 0x6000097+0x178\r\n         at NSwag.AspNetCore.Middlewares.OpenApiDocumentMiddleware.Invoke(HttpContext context) in NSwag.AspNetCore.dll:token 0x6000093+0x204\r\n         at NSwag.AspNetCore.Middlewares.OpenApiDocumentMiddleware.Invoke(HttpContext context) in NSwag.AspNetCore.dll:token 0x6000093+0x204\r\n         at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddleware.Invoke(HttpContext context) in Microsoft.AspNetCore.Diagnostics.dll:token 0x60000aa+0x82\r\n```",
      "created_at": "2021-09-06T14:36:00Z",
      "updated_at": "2021-09-06T14:38:14Z"
    },
    {
      "author": "techienickb",
      "author_association": "NONE",
      "body": "Found a solution, re-enable the Binary Formatter Serialization.  I don't understand how powershell remote needs this when remote powershell is a core part of powershell but at least I have a working solution.\r\n`<EnableUnsafeBinaryFormatterSerialization>true</EnableUnsafeBinaryFormatterSerialization>`",
      "created_at": "2021-11-15T15:03:17Z",
      "updated_at": "2021-11-15T15:03:17Z"
    },
    {
      "author": "solbirn",
      "author_association": "NONE",
      "body": "Any updates? Can't PS remote from Azure Function (C#, net6) even when EnableUnsafeBinaryFormatterSerialization is enabled in project",
      "created_at": "2021-12-17T15:13:10Z",
      "updated_at": "2021-12-17T15:13:10Z"
    }
  ],
  "created_at": "2021-03-18T13:08:15Z",
  "labels": [
    "Issue-Bug",
    "WG-Remoting",
    "Needs-Investigation"
  ],
  "number": 15060,
  "state": "open",
  "title": "PowerShell SDK 7.2.x unable to connect to Exchange remotes",
  "updated_at": "2022-05-11T22:32:59Z"
}