{
  "_url": "https://github.com/PowerShell/PowerShell/issues/15788",
  "author": "Astraea0",
  "body": "### Prerequisites\r\n\r\n- [X] Write a descriptive title.\r\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- [X] Search the existing issues.\r\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n\r\n### Steps to reproduce\r\n\r\nWhen running `Get-ADPrincipalGroupMembership` using an admin account that is marked as \"sensitive and cannot be delegated\", an unspecified error occurs. This is happening on an admin workstation, not on the DC.\r\n\r\nThe exact command I'm attempting to run is:\r\n`Get-ADPrincipalGroupMembership -Identity \"adtest\"`\r\n\r\nThis error does not occur when using a standard user account. We use admin accounts for various tasks and it seems to be **only** this command that causes an error.\r\n\r\nStrangely on this account I can run `Get-ADUser`, `Get-ADGroupMember`, `Get-ADObject`, etc. I can even run `Add-ADPrincipalGroupMembership` and `Remove-ADPrincipalGroupMembership` while using this non-delegated admin account without issue. I'm also able to view the contents of the **Member Of** tab in ADUC with both accounts.\r\n\r\nI believe this is a bug with this particular command in the ActiveDirectory module.\r\n\r\nFor now my workaround is to just use my regular account for these lookups or to use `(Get-ADUser -Identity adtest -Properties MemberOf).MemberOf`\r\n\r\n### Expected behavior\r\n\r\n```console\r\nPS C:\\> Get-ADPrincipalGroupMembership -Identity adtest\r\n\r\ndistinguishedName : CN=Domain Users,CN=Users,DC=contoso,DC=com\r\nGroupCategory     : Security\r\nGroupScope        : Global\r\nname              : Domain Users\r\nobjectClass       : group\r\nobjectGUID        : c48b2114-2fe7-4282-b296-a0d3b4c80141\r\nSamAccountName    : Domain Users\r\nSID               : S-1-5-21-1444237352-1323246715-1848914655-513\r\n```\r\n\r\n\r\n### Actual behavior\r\n\r\n```console\r\nPS C:\\> Get-ADPrincipalGroupMembership -Identity adtest\r\nGet-ADPrincipalGroupMembership: An unspecified error has occurred\r\n```\r\n\r\n\r\n### Error details\r\n\r\n```console\r\nException             :\r\n    Type               : Microsoft.ActiveDirectory.Management.ADException\r\n    ServerErrorMessage : An operations error occurred.\r\n\r\n    TargetSite         :\r\n        Name          : GetExceptionFromErrorCode\r\n        DeclaringType : Microsoft.ActiveDirectory.Management.ExceptionHelper, Microsoft.ActiveDirectory.Management, Version=10.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n        MemberType    : Method\r\n        Module        : Microsoft.ActiveDirectory.Management.dll\r\n    StackTrace         :\r\n   at Microsoft.ActiveDirectory.Management.ExceptionHelper.GetExceptionFromErrorCode(Int32 errorCode, String errorMessage, String serverErrorMessage, Exception innerException)\r\n   at Microsoft.ActiveDirectory.Management.AdwsConnection.ThrowExceptionForErrorCode(String message, String errorCode, String extendedErrorMessage, Exception innerException)\r\n   at Microsoft.ActiveDirectory.Management.AdwsConnection.ThrowException(CustomActionFault caFault, FaultException faultException)\r\n   at Microsoft.ActiveDirectory.Management.AdwsConnection.GetADPrincipalGroupMembership(GetADPrincipalGroupMembershipRequest request)\r\n   at Microsoft.ActiveDirectory.Management.ADWebServiceStoreAccess.Microsoft.ActiveDirectory.Management.IADAccountManagement.GetADPrincipalGroupMembership(ADSessionHandle handle, GetADPrincipalGroupMembershipRequest request)\r\n   at Microsoft.ActiveDirectory.Management.ADAccountManagement.GetPrincipalGroupMembership(String partitionDN, String principalDN, String resourceContextServer, String resourceContextPartition)\r\n   at Microsoft.ActiveDirectory.Management.Commands.GetADPrincipalGroupMembership.GetGroupMembershipProcessCSRoutine()\r\n   at Microsoft.ActiveDirectory.Management.CmdletSubroutinePipeline.Invoke()\r\n   at Microsoft.ActiveDirectory.Management.Commands.ADCmdletBase`1.ProcessRecord()\r\n    Message            : An unspecified error has occurred\r\n    InnerException     :\r\n        Type       : System.ServiceModel.FaultException`1[[schemas.microsoft.com._2008._1.ActiveDirectory.CustomActions.GetADPrincipalGroupMembershipFault, Microsoft.ActiveDirectory.Management, Version=10.0.0.0, Culture=neutral,\r\nPublicKeyToken=31bf3856ad364e35]]\r\n        Detail     : schemas.microsoft.com._2008._1.ActiveDirectory.CustomActions.GetADPrincipalGroupMembershipFault\r\n        Action     : http://schemas.microsoft.com/2008/1/ActiveDirectory/Data/fault\r\n        Code       : System.ServiceModel.FaultCode\r\n        Message    : Active Directory returned an error processing the operation.\r\n        Reason     : Active Directory returned an error processing the operation.\r\n        TargetSite :\r\n            Name          : HandleReply\r\n            DeclaringType : System.ServiceModel.Channels.ServiceChannel, System.Private.ServiceModel, Version=4.7.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a\r\n            MemberType    : Method\r\n            Module        : System.Private.ServiceModel.dll\r\n        StackTrace :\r\n   at System.ServiceModel.Channels.ServiceChannel.HandleReply(ProxyOperationRuntime operation, ProxyRpc& rpc)\r\n   at System.ServiceModel.Channels.ServiceChannel.Call(String action, Boolean oneway, ProxyOperationRuntime operation, Object[] ins, Object[] outs, TimeSpan timeout)\r\n   at System.ServiceModel.Channels.ServiceChannelProxy.InvokeService(MethodCall methodCall, ProxyOperationRuntime operation)\r\n   at System.ServiceModel.Channels.ServiceChannelProxy.Invoke(MethodInfo targetMethod, Object[] args)\r\n--- End of stack trace from previous location ---\r\n   at System.Reflection.DispatchProxyGenerator.Invoke(Object[] args)\r\n   at generatedProxy_3.GetADPrincipalGroupMembership(GetADPrincipalGroupMembershipRequest )\r\n   at Microsoft.ActiveDirectory.Management.AdwsConnection.GetADPrincipalGroupMembership(GetADPrincipalGroupMembershipRequest request)\r\n        Source     : System.Private.ServiceModel\r\n        HResult    : -2146233088\r\n    Source             : Microsoft.ActiveDirectory.Management\r\n    HResult            : -2146233088\r\nCategoryInfo          : NotSpecified: (adtest:ADPrincipal) [Get-ADPrincipalGroupMembership], ADException\r\nFullyQualifiedErrorId : ActiveDirectoryServer:0,Microsoft.ActiveDirectory.Management.Commands.GetADPrincipalGroupMembership\r\nInvocationInfo        :\r\n    MyCommand        : Get-ADPrincipalGroupMembership\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 1\r\n    HistoryId        : 12\r\n    Line             : Get-ADPrincipalGroupMembership -Identity adtest\r\n    PositionMessage  : At line:1 char:1\r\n                       + Get-ADPrincipalGroupMembership -Identity adtest\r\n                       + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    InvocationName   : Get-ADPrincipalGroupMembership\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n```\r\n\r\n\r\n### Environment data\r\n\r\n```powershell\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.3\r\nPSEdition                      Core\r\nGitCommitId                    7.1.3\r\nOS                             Microsoft Windows 10.0.18363\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\n```\r\nPS C:\\> Get-WindowsCapability -Online | ? {$_.State -eq \"Installed\" -and $_.Name -like \"Rsat*\"}\r\n\r\nName  : Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0\r\nState : Installed\r\n```\r\n\r\n\r\n### Visuals\r\n\r\n_No response_",
  "closed_at": "2021-07-19T17:14:03Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "The cmdlet is not in the repo. Please use Windows Feedback tool to report the issue.",
      "created_at": "2021-07-19T04:52:29Z",
      "updated_at": "2021-07-19T04:52:29Z"
    },
    {
      "author": "Astraea0",
      "author_association": "NONE",
      "body": "For anyone who comes across this in the future - if you're using an account with delegation disabled to run `Get-ADPrincipalGroupMembership`, you may need to add the `-ResourceContextServer` parameter and specify the domain. Certain domain/forest setups require this and I guess disabling delegation makes this very strict.",
      "created_at": "2021-07-20T19:00:37Z",
      "updated_at": "2021-07-20T19:00:37Z"
    }
  ],
  "created_at": "2021-07-16T18:19:35Z",
  "labels": [
    "Resolution-External"
  ],
  "number": 15788,
  "state": "closed",
  "title": "Unspecified Error when running Get-ADPrincipalGroupMembership using Non-delegated Account",
  "updated_at": "2021-07-20T19:00:37Z"
}