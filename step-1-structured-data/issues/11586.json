{
  "_url": "https://github.com/PowerShell/PowerShell/issues/11586",
  "author": "PaulHigin",
  "body": "<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\nThis change fixes a problem in Invoke-Command against a remote session and that session is abruptly terminated, but no error is reported.\r\n\r\n## PR Context\r\n\r\nIn certain conditions, an abrupt session termination results in an Invoke-Command pipeline state going to 'Stopped' with an exception.  Currently this is ignored in job processing because a user initiated stop is not an error.  But a stopped state due to an error that is not 'PipelineStoppedException' (such as a remote transport exception) should not be ignored, but instead be treated as an error so that Invoke-Command will report it.\r\n\r\nThe fix is to update job error processing to correctly handle this error state.\r\n\r\nRepro steps\r\n-------------\r\n```powershell\r\n$session = New-PSSession -cn vm1\r\nInvoke-Command -Session $session -ScriptBlock { 1..1000 | % { sleep 1; \"Output $_\" } }\r\n\r\n# Turn off virtual machine vm1\r\n\r\n# Result\r\n# No error is reported by Invoke-Command\r\n\r\n# Expected\r\nOpenError: [vm1] Processing data from remote server vm1 failed with the following error message: The request for the Windows Remote Shell with ShellId 8E31C82A-7B31-41F0-B882-E60EF7634D33 failed because the shell was not found on the server. Possible causes are: the specified ShellId is incorrect or the shell no longer exists on the server. Provide the correct ShellId or create a new shell and retry the operation. For more information, see the about_Remote_Troubleshooting Help topic.\r\n```\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [x] None\r\n    - **OR**\r\n    - [ ] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n        - [ ] Experimental feature name(s): <!-- Experimental feature name(s) here -->\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n- **Testing - New and feature**\r\n    - [x] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [x] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [ ] I have considered the user experience from a tooling perspective and enumerated concerns in the summary. This may include:\r\n        - Impact on [PowerShell Editor Services](https://github.com/PowerShell/PowerShellEditorServices) which is used in the [PowerShell extension](https://github.com/PowerShell/vscode-powershell) for VSCode (which runs in a different PS Host).\r\n        - Impact on Completions (both in the console and in editors) - one of PowerShell's most powerful features.\r\n        - Impact on [PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer) (which provides linting & formatting in the editor extensions).\r\n        - Impact on [EditorSyntax](https://github.com/PowerShell/EditorSyntax) (which provides syntax highlighting with in VSCode, GitHub, and many other editors).\r\n",
  "closed_at": "2020-02-05T23:27:58Z",
  "comments": [
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "This is a possible breaking change.  Some job ending states that used to be 'Stopped' with Exception, will now be 'Failed' with Exception.  But I feel this is the correct behavior.  The only time a 'Stopped' state is not an error is if there is no associated exception, or the exception is 'PipelineStopped'.",
      "created_at": "2020-01-15T01:10:45Z",
      "updated_at": "2020-01-15T01:10:45Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@PoshChan  Please retry windows",
      "created_at": "2020-01-15T16:39:11Z",
      "updated_at": "2020-01-15T16:39:11Z"
    },
    {
      "author": "PoshChan",
      "author_association": "COLLABORATOR",
      "body": "@PaulHigin, successfully started retry of `PowerShell-CI-Windows`",
      "created_at": "2020-01-15T16:39:48Z",
      "updated_at": "2020-01-15T16:39:48Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@JamesWTruher  No, the repro is difficult to automate and still get the right error path.  We don't need another fragile test.",
      "created_at": "2020-01-15T18:48:08Z",
      "updated_at": "2020-01-15T18:48:08Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@PowerShell/powershell-committee reviewed this and agree that the scenario where the pipeline is stopped with an error that is not a PipelineStoppedException it is a failure case, so this change is accepted.",
      "created_at": "2020-01-15T23:25:35Z",
      "updated_at": "2020-01-15T23:26:06Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@TravisEz13  This change created a subtle regression.  Please hold off merging until I have pushed the fix.",
      "created_at": "2020-01-31T19:43:12Z",
      "updated_at": "2020-01-31T19:43:12Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@SteveL-MSFT , @JamesWTruher  Please re-review the changes.  I have added a fix to the regression and also fixed the Stop-Job tests so that they will catch bad final state.\r\n\r\nThe regression was due to the pipeline returning a RemoteException exception on a pipeline stop instead of a PipelineStoppedException exception I was previously checking.  A pipeline stopped RemoteException will contain an ErrorRecord with FQEID of 'PipelineStopped'.\r\n\r\nThe Stop-Job tests were not catching the incorrect final state because they ran before the job was actually running.  Fix is to wait until job is running and returning data to the client.",
      "created_at": "2020-01-31T21:00:38Z",
      "updated_at": "2020-01-31T21:00:38Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@SteveL-MSFT  Please re-review.",
      "created_at": "2020-02-03T15:29:12Z",
      "updated_at": "2020-02-03T15:29:12Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@SteveL-MSFT  ping...",
      "created_at": "2020-02-05T17:11:32Z",
      "updated_at": "2020-02-05T17:11:32Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.0.0-rc.3` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.0.0-rc.3)\n",
      "created_at": "2020-02-21T23:56:06Z",
      "updated_at": "2020-02-21T23:56:06Z"
    }
  ],
  "created_at": "2020-01-15T01:05:49Z",
  "number": 11586,
  "state": "closed",
  "title": "Fix `Invoke-Command` missing error on session termination.",
  "updated_at": "2020-02-24T15:48:55Z"
}