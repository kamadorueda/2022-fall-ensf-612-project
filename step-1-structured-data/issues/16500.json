{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16500",
  "author": "ChrisGuzak",
  "body": "### Prerequisites\r\n\r\n- [X] Write a descriptive title.\r\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- [X] Search the existing issues.\r\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n\r\n### Steps to reproduce\r\n\r\nI tried Store installed Release and Preview version of PowerShell and the .msi install. All have the same defect. This impacts me as a module I use, TShell, depends on 32bit WindowsPowerShell. The same usage works fine from 64bit, installed in another location works fine too. I diffed the 2 modules and found the `fullclr` folder is missing from the store version and a file, `PSGetModuleInfo.xml` is also not present.\r\n\r\n. Start the 32bit sessions this way\r\n`Enter-PSSession -ComputerName . -EnableNetworkAccess -ConfigurationName Microsoft.PowerShell32`, or via Start.Run...\r\n`c:\\windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe`\r\n\r\nRunning this command fails (error output below)\r\n```PowerShell\r\nImport-Module -Verbose 'C:\\program files\\windowsapps\\microsoft.powershell_7.2.0.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\PackageManagement.psd1'\r\n```\r\n\r\n`PackageManagment` 1.4.7 is installed in these 2 locations, the first from the store install, the second from Windows.\r\n\r\n`C:\\program files\\windowsapps\\microsoft.powershell_7.2.0.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement` `C:\\Program Files\\WindowsPowerShell\\Modules\\PackageManagement\\1.4.7`\r\n\r\nMaybe the store version should not include this module, instead depend on the system provided copy (that works).\r\n\r\n### Expected behavior\r\n\r\n```console\r\nthis is the output in the working (64bit, or other location) case\r\n\r\nImport-PackageManagementBug\r\nVERBOSE: Loading module from path 'C:\\program files\\windowsapps\\microsoft.powershell_7.2.0.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\PackageManagement.psd1'.\r\nVERBOSE: Loading 'FormatsToProcess' from path 'C:\\program files\\windowsapps\\microsoft.powershell_7.2.0.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\PackageManagement.format.ps1xml'.\r\nVERBOSE: Loading module from path 'C:\\program files\\windowsapps\\microsoft.powershell_7.2.0.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\PackageManagement.psm1'.\r\nVERBOSE: Exporting cmdlet 'Find-Package'.\r\nVERBOSE: Exporting cmdlet 'Find-PackageProvider'.\r\nVERBOSE: Exporting cmdlet 'Get-Package'.\r\nVERBOSE: Exporting cmdlet 'Get-PackageProvider'.\r\nVERBOSE: Exporting cmdlet 'Get-PackageSource'.\r\nVERBOSE: Exporting cmdlet 'Import-PackageProvider'.\r\nVERBOSE: Exporting cmdlet 'Install-Package'.\r\nVERBOSE: Exporting cmdlet 'Install-PackageProvider'.\r\nVERBOSE: Exporting cmdlet 'Register-PackageSource'.\r\nVERBOSE: Exporting cmdlet 'Save-Package'.\r\nVERBOSE: Exporting cmdlet 'Set-PackageSource'.\r\nVERBOSE: Exporting cmdlet 'Uninstall-Package'.\r\nVERBOSE: Exporting cmdlet 'Unregister-PackageSource'.\r\nVERBOSE: Importing cmdlet 'Find-Package'.\r\nVERBOSE: Importing cmdlet 'Find-PackageProvider'.\r\nVERBOSE: Importing cmdlet 'Get-Package'.\r\nVERBOSE: Importing cmdlet 'Get-PackageProvider'.\r\nVERBOSE: Importing cmdlet 'Get-PackageSource'.\r\nVERBOSE: Importing cmdlet 'Import-PackageProvider'.\r\nVERBOSE: Importing cmdlet 'Install-Package'.\r\nVERBOSE: Importing cmdlet 'Install-PackageProvider'.\r\nVERBOSE: Importing cmdlet 'Register-PackageSource'.\r\nVERBOSE: Importing cmdlet 'Save-Package'.\r\nVERBOSE: Importing cmdlet 'Set-PackageSource'.\r\nVERBOSE: Importing cmdlet 'Uninstall-Package'.\r\nVERBOSE: Importing cmdlet 'Unregister-PackageSource'.\r\n```\r\n\r\n\r\n### Actual behavior\r\n\r\n```console\r\nImport-Module -Verbose 'C:\\program files\\windowsapps\\microsoft.powershellpreview_7.2.101.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\PackageManagement.psd1'\r\nVERBOSE: Loading module from path 'C:\\program\r\nfiles\\windowsapps\\microsoft.powershellpreview_7.2.101.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\PackageManagement.\r\npsd1'.\r\nVERBOSE: Loading 'FormatsToProcess' from path 'C:\\program\r\nfiles\\windowsapps\\microsoft.powershellpreview_7.2.101.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\PackageManagement.\r\nformat.ps1xml'.\r\nVERBOSE: Loading module from path 'C:\\program\r\nfiles\\windowsapps\\microsoft.powershellpreview_7.2.101.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\PackageManagement.\r\npsm1'.\r\nImport-Module : The specified module 'C:\\program files\\windowsapps\\microsoft.powershellpreview_7.2.101.0_x64__8wekyb3d8\r\nbbwe\\Modules\\PackageManagement\\fullclr\\Microsoft.PackageManagement.dll' was not loaded because no valid module file\r\nwas found in any module directory.\r\nAt C:\\program files\\windowsapps\\microsoft.powershellpreview_7.2.101.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\Pack\r\nageManagement.psm1:38 char:17\r\n+ $OneGetModule = Import-Module -Name $OneGetModulePath -PassThru\r\n+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ResourceUnavailable: (C:\\program file...eManagement.dll:String) [Import-Module], FileNot\r\n   FoundException\r\n    + FullyQualifiedErrorId : Modules_ModuleNotFound,Microsoft.PowerShell.Commands.ImportModuleCommand\r\n\r\nImport-Module : The specified module 'C:\\program files\\windowsapps\\microsoft.powershellpreview_7.2.101.0_x64__8wekyb3d8\r\nbbwe\\Modules\\PackageManagement\\fullclr\\Microsoft.PowerShell.PackageManagement.dll' was not loaded because no valid\r\nmodule file was found in any module directory.\r\nAt C:\\program files\\windowsapps\\microsoft.powershellpreview_7.2.101.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\Pack\r\nageManagement.psm1:39 char:19\r\n+ $PSOneGetModule = Import-Module -Name $PSOneGetModulePath -PassThru\r\n+                   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ResourceUnavailable: (C:\\program file...eManagement.dll:String) [Import-Module], FileNot\r\n   FoundException\r\n    + FullyQualifiedErrorId : Modules_ModuleNotFound,Microsoft.PowerShell.Commands.ImportModuleCommand\r\n```\r\n\r\n\r\n### Error details\r\n\r\n```console\r\nPS C:\\windows\\SysWOW64\\WindowsPowerShell\\v1.0> $error\r\nImport-Module : The specified module 'C:\\program files\\windowsapps\\microsoft.powershell_7.2.0.0_x64__8wekyb3d8bbwe\\Modu\r\nles\\PackageManagement\\fullclr\\Microsoft.PowerShell.PackageManagement.dll' was not loaded because no valid module file\r\nwas found in any module directory.\r\nAt C:\\program\r\nfiles\\windowsapps\\microsoft.powershell_7.2.0.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\PackageManagement.psm1:39\r\nchar:19\r\n+ $PSOneGetModule = Import-Module -Name $PSOneGetModulePath -PassThru\r\n+                   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ResourceUnavailable: (C:\\program file...eManagement.dll:String) [Import-Module], FileNot\r\n   FoundException\r\n    + FullyQualifiedErrorId : Modules_ModuleNotFound,Microsoft.PowerShell.Commands.ImportModuleCommand\r\n\r\nImport-Module : The specified module 'C:\\program files\\windowsapps\\microsoft.powershell_7.2.0.0_x64__8wekyb3d8bbwe\\Modu\r\nles\\PackageManagement\\fullclr\\Microsoft.PackageManagement.dll' was not loaded because no valid module file was found\r\nin any module directory.\r\nAt C:\\program\r\nfiles\\windowsapps\\microsoft.powershell_7.2.0.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement\\PackageManagement.psm1:38\r\nchar:17\r\n+ $OneGetModule = Import-Module -Name $OneGetModulePath -PassThru\r\n+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ResourceUnavailable: (C:\\program file...eManagement.dll:String) [Import-Module], FileNot\r\n   FoundException\r\n    + FullyQualifiedErrorId : Modules_ModuleNotFound,Microsoft.PowerShell.Commands.ImportModuleCommand\r\n\r\nMissing function body in function declaration.\r\nImport-Module : The specified module 'PSReadline' was not loaded because no valid module file was found in any module\r\ndirectory.\r\n    + CategoryInfo          : ResourceUnavailable: (PSReadline:String) [Import-Module], FileNotFoundException\r\n    + FullyQualifiedErrorId : Modules_ModuleNotFound,Microsoft.PowerShell.Commands.ImportModuleCommand\r\n```\r\n\r\n\r\n### Environment data\r\n\r\n```powershell\r\nPSVersion                      5.1.22000.282\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.22000.282\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\n```\r\n\r\n\r\n### Visuals\r\n\r\n![image](https://user-images.githubusercontent.com/2507280/142773914-d3ce3fd8-2c88-447a-989a-9e45e6ffa854.png)\r\n",
  "closed_at": "2021-12-02T12:00:39Z",
  "comments": [
    {
      "author": "ChrisGuzak",
      "author_association": "NONE",
      "body": "ideas for solutions include \r\n~1) fixing this PackageManagement to include all of the missing files.~\r\n2) Releasing a new version of Windows PowerShell version of PackageManagement to 1.4.8 so it will be selected over 1.4.7.\r\n3) Install the Windows PowerShell version of this package and make sure it is selected (first in the module path?)",
      "created_at": "2021-11-24T17:59:47Z",
      "updated_at": "2022-01-10T20:40:52Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "The `fullclr` folder is not included in the `PackageManagement` module shipped with PS 7.2 on purpose. That module is under `$PSHOME\\Modules`, which is a private module path for a specific PowerShell installation, and thus it's not supposed to be used by a different PowerShell instance, especially not by Windows PowerShell.",
      "created_at": "2021-12-01T03:01:51Z",
      "updated_at": "2021-12-01T03:01:51Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This issue has been marked as answered and has not had any activity for **1 day**. It has been closed for housekeeping purposes.",
      "created_at": "2021-12-02T12:00:38Z",
      "updated_at": "2021-12-02T12:00:38Z"
    },
    {
      "author": "ChrisGuzak",
      "author_association": "NONE",
      "body": "but this breaks a usage scenario.",
      "created_at": "2022-01-10T19:47:02Z",
      "updated_at": "2022-01-10T20:39:02Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "> this breaks a usage scenario \r\n\r\nWhat is the scenario? Did you have both `C:\\program files\\windowsapps\\microsoft.powershell_7.2.0.0_x64__8wekyb3d8bbwe\\Modules\\PackageManagement` and `C:\\Program Files\\WindowsPowerShell\\Modules\\PackageManagement\\1.4.7` somehow in your module path?\r\n\r\n> the MSI install does not have this problem.\r\n\r\nBut you mentioned MSI doesn't work either:\r\n> I tried this with the Release and Preview version of PowerShell installed via the Store, and then with the .mis installed version. **All have the same behavior**.",
      "created_at": "2022-01-10T20:02:15Z",
      "updated_at": "2022-01-10T20:02:15Z"
    },
    {
      "author": "ChrisGuzak",
      "author_association": "NONE",
      "body": "The scenario is running 32-bit Windows PowerShell after installing PowerShell and then trying to use the PackageManagement module. It fails to load and everything that depends on that is broken. I believe I had both of those paths on my module path.\r\n\r\nMSI has the same problem (sorry for the confusion). I updated the description above to make this clear.\r\n\r\nBut I see now I no longer am suffering as the selection logic seems to account for the PSEdition (Desktop vs Core). See below that I have 2 copies of 1.47 installed, the one under `c:\\program files\\powershell\\7` is missing the native DLLs that cause the problem. But now the second one, `C:\\Program Files\\WindowsPowerShell` is selected and works.\r\n\r\nDid something change with the module selection logic that now avoids this problem? I've updated PowerShell since then so perhaps this issue was addressed?\r\n\r\n```PowerShell\r\nGet-Module -ListAvailable PackageManagement\r\n\r\n    Directory: C:\\program files\\powershell\\7\\Modules\r\n\r\nModuleType Version    PreRelease Name                                PSEdition ExportedComm\r\n                                                                               ands\r\n---------- -------    ---------- ----                                --------- ------------\r\nScript     1.4.7                 PackageManagement                   Desk      {Find-Packa\u2026\r\n\r\n    Directory: C:\\Program Files\\WindowsPowerShell\\Modules\r\n\r\nModuleType Version    PreRelease Name                                PSEdition ExportedComm\r\n                                                                               ands\r\n---------- -------    ---------- ----                                --------- ------------\r\nScript     1.4.7                 PackageManagement                   Desk      {Find-Packa\u2026\r\nBinary     1.0.0.1               PackageManagement                   Desk      {Find-Packa\u2026\r\n```\r\n\r\n",
      "created_at": "2022-01-10T20:09:17Z",
      "updated_at": "2022-01-12T15:30:22Z"
    },
    {
      "author": "ChrisGuzak",
      "author_association": "NONE",
      "body": "https://docs.microsoft.com/en-us/answers/questions/328264/access-to-the-cloud-file-is-denied-when-install-az.html\r\n\r\nI think this may be related, but I noticed I get this error \u201cAccess to the cloud file is denied\u201d because my Documents folder is in OneDrive and the Modules files are not all available locally. Still investigating but FYI.\n\n<blockquote><div><strong><a href=\"https://docs.microsoft.com/en-us/answers/questions/328264/access-to-the-cloud-file-is-denied-when-install-az.html\">Access to the cloud file is denied when install az powershell - Microsoft Q&A</a></strong></div><div>Microsoft Q&A is the best place to get answers to all your technical questions on Microsoft products and services. Community. Forum.</div></blockquote>",
      "created_at": "2022-01-18T18:37:54Z",
      "updated_at": "2022-01-18T18:37:56Z"
    }
  ],
  "created_at": "2021-11-21T18:12:04Z",
  "number": 16500,
  "state": "closed",
  "title": "PackageManagment module installed by PowerShell does not work from 32bit PowerShell.exe, works fine from 64bit",
  "updated_at": "2022-01-18T18:37:56Z"
}