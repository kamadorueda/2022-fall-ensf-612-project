{
  "_url": "https://github.com/PowerShell/PowerShell/issues/15527",
  "author": "Fs00",
  "body": "# PR Summary\r\n\r\nThis PR slightly improves PowerShell start-up performance on Windows by using `AssemblyInformationalVersionAttribute` in `AmsiUtils.Init` to retrieve PowerShell product version instead of `ProcessModule.FileVersionInfo`, which is notably slower.\r\nAlso, the code that handled possible errors coming from `ProcessModule.FileVersionInfo` has been removed.\r\n\r\nHere is the startup performance difference before and after the PR (launched `Measure-Command { .\\pwsh -noprofile -c exit }` 15 times on a Release build):\r\n\r\n**master branch:**\r\n356,89, 357,19, 356,40, 362,44, 354,41, 355,71, 359,56, 358,05, 350,51, 365,41, 356,74, 357,24, 357,06, 353,06, 353,05\r\nBest: 350,51 ms\r\nWorst: 365,41 ms\r\nAverage: **356,91 ms**\r\n\r\n**This PR:**\r\n358,31, 347,59, 350,51, 352,66, 348,42, 351,90, 350,34, 354,94, 351,55, 339,00, 344,30, 345,26, 347,64, 351,45, 343,43\r\nBest: 339,00 ms\r\nWorst: 358,31 ms\r\nAverage: **349,15 ms**\r\n\r\nContributes to #14268.\r\n\r\n## PR Context\r\n\r\nThis chance for optimization has been discovered by @iSazonov in https://github.com/PowerShell/PowerShell/pull/14332#issuecomment-739549844.\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [x] None\r\n    - **OR**\r\n    - [ ] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- **Testing - New and feature**\r\n    - [x] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [x] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [ ] I have considered the user experience from a tooling perspective and opened an issue in the relevant tool repository.\r\n",
  "closed_at": "2021-06-14T19:04:36Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Since it is about startup performance please share perf results for just startup. Either `Measure-Command { .\\pwsh -noprofile -c exit }` or PerfView.",
      "created_at": "2021-06-06T15:19:31Z",
      "updated_at": "2021-06-06T15:19:31Z"
    },
    {
      "author": "Fs00",
      "author_association": "CONTRIBUTOR",
      "body": "Here are the results in milliseconds of running `Measure-Command { .\\pwsh -noprofile -c exit }` on a debug build 15 times:\r\n\r\n**master branch:**\r\n854,19, 807,08, 817,18, 804,88, 820,26, 810,25, 817,35, 829,89, 804,71, 804,96, 809,28, 815,76, 811,47, 810,23, 800,47\r\nBest: 800,47 ms\r\nWorst: 854,19 ms\r\nAverage: **814,53 ms**\r\n\r\n**This PR:**\r\n785,93, 788,26, 795,68, 786,38, 789,25, 792,89, 791,65, 806,51, 781,68, 791,21, 796,45, 796,87, 791,29, 785,23, 787,25\r\nBest: 781,68 ms\r\nWorst: 806,51 ms\r\nAverage: **791,10 ms**",
      "created_at": "2021-06-06T16:38:32Z",
      "updated_at": "2021-06-06T16:38:32Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> on a debug build 15 times:\r\n\r\nPlease do all perf test on Release ( Start-PSBuild -Configuration Release -CrossGen)",
      "created_at": "2021-06-06T17:45:21Z",
      "updated_at": "2021-06-06T17:45:21Z"
    },
    {
      "author": "Fs00",
      "author_association": "CONTRIBUTOR",
      "body": "Same test done on Release build:\r\n\r\n**master branch:**\r\n356,89, 357,19, 356,40, 362,44, 354,41, 355,71, 359,56, 358,05, 350,51, 365,41, 356,74, 357,24, 357,06, 353,06, 353,05\r\nBest: 350,51 ms\r\nWorst: 365,41 ms\r\nAverage: **356,91 ms**\r\n\r\n**This PR:**\r\n358,31, 347,59, 350,51, 352,66, 348,42, 351,90, 350,34, 354,94, 351,55, 339,00, 344,30, 345,26, 347,64, 351,45, 343,43\r\nBest: 339,00 ms\r\nWorst: 358,31 ms\r\nAverage: **349,15 ms**",
      "created_at": "2021-06-07T06:59:04Z",
      "updated_at": "2021-06-07T06:59:15Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@Fs00 Thanks for perf test sharing! Please add this in the PR description.",
      "created_at": "2021-06-07T07:14:22Z",
      "updated_at": "2021-06-07T07:14:22Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Not for the PR but while we are here - what do you think about using new c#  feature - source generator - for getting ProductVersion?",
      "created_at": "2021-06-14T18:40:33Z",
      "updated_at": "2021-06-14T18:40:33Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@iSazonov That sounds like a nice thing to try. Not just the product version, any reflection tasks that can be deterministically done at build time can be considered to be lifted to the source generator.",
      "created_at": "2021-06-14T19:04:02Z",
      "updated_at": "2021-06-14T19:04:02Z"
    },
    {
      "author": "Fs00",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for merging!",
      "created_at": "2021-06-14T19:10:58Z",
      "updated_at": "2021-06-14T19:10:58Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@Fs00 Thanks for your contribution!",
      "created_at": "2021-06-14T22:16:30Z",
      "updated_at": "2021-06-14T22:16:30Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.2.0-preview.7` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.2.0-preview.7)\n",
      "created_at": "2021-06-17T16:59:09Z",
      "updated_at": "2021-06-17T16:59:09Z"
    }
  ],
  "created_at": "2021-06-05T10:11:09Z",
  "number": 15527,
  "state": "closed",
  "title": "Retrieve productVersion using informational version attribute in AmsiUtils.Init()",
  "updated_at": "2021-06-17T16:59:09Z"
}