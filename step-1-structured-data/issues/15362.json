{
  "_url": "https://github.com/PowerShell/PowerShell/issues/15362",
  "author": "niharaobsec",
  "body": "\r\nCommand:\r\n```\r\nInstall-Module -Name ExchangeOnlineManagement -RequiredVersion 2.0.4 -Force\r\n\r\nConnect-ExchangeOnline -CertificateFilePath '<path_to_cert>' -CertificatePassword (ConvertTo-SecureString -String '<my_password>' -AsPlainText -Force) -AppID 'my-app-id' -Organization 'myorg.onmicrosoft.com'\r\n```\r\n\r\nEnvironment:\r\nRunning in a Docker container: mcr.microsoft.com/azure-powershell:5.9.0-ubuntu-18.04\r\n\r\n```\r\n$PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.3\r\nPSEdition                      Core\r\nGitCommitId                    7.1.3\r\nOS                             Linux 5.10.25-linuxkit #1 SMP Tue Mar 23 09:27:39 UTC 2021\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\nError:\r\n```\r\nException: /root/.local/share/powershell/Modules/ExchangeOnlineManagement/2.0.4/netCore/ExchangeOnlineManagement.psm1:475\r\nLine |\r\n 475 |  \u2026 PSSession = New-ExoPSSession -ExchangeEnvironmentName $ExchangeEnviro \u2026\r\n     |                ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Connecting to remote server outlook.office365.com failed with the following error message :\r\n     | MI_RESULT_FAILED For more information, see the about_Remote_Troubleshooting Help topic.\r\n```\r\n\r\nError Log:\r\n```\r\nVersion,Organization,ScriptName,ScriptExecutionGuid,CommandName,CommandParams,RecordCount,SentBytesCount,TotalLatencyMs,ErrorLog\r\nv2,,,,Connect-ExchangeOnline,CertificateFilePath;CertificatePassword;AppId;Organization;EnableErrorReporting;LogDirectoryPath;LogLevel,0,0,0,FullyQualifiedErrorId=1PSSessionOpenFailed;CategoryInfo=OpenError: (System.Management.A\u2026tion.RemoteRunspace:RemoteRunspace) [New-PSSession] PSRemotingTransportException;ExceptionType=System.Management.Automation.Remoting.PSRemotingTransportException;ErrorCode=1;TransportMessage=MI_RESULT_FAILED;;ExceptionMessage=System.Management.Automation.Remoting.PSRemotingTransportException: Connecting to remote server outlook.office365.com failed with the following error message : MI_RESULT_FAILED For more information see the about_Remote_Troubleshooting Help topic.\\n   at Microsoft.Exchange.Management.ExoPowershellSnapin.NewExoPSSession.HandleError(PSDataCollection`1 errors)\\n   at Microsoft.Exchange.Management.ExoPowershellSnapin.NewExoPSSession.ExecutePsCommand(PSCommand command)\\n   at Microsoft.Exchange.Management.ExoPowershellSnapin.NewExoPSSession.ProcessNewConnection()\\n   at Microsoft.Exchange.Management.ExoPowershellSnapin.NewExoPSSession.ProcessRecord()\\n   at System.Management.Automation.Cmdlet.DoProcessRecord() in /PowerShell/src/System.Management.Automation/engine/cmdlet.cs:line 173\\n   at System.Management.Automation.CommandProcessor.ProcessRecord() in /PowerShell/src/System.Management.Automation/engine/CommandProcessor.cs:line 388|\r\n```",
  "closed_at": "2022-01-08T04:00:50Z",
  "comments": [
    {
      "author": "jborean93",
      "author_association": "COLLABORATOR",
      "body": "There's a good chance that you are hitting the 1KiB password limit on the WSMan library https://github.com/microsoft/omi/blob/e4d72481fa2f805148c9c8f4d0183b3e2d7814a8/Unix/http/httpcommon.h#L124. Using modern auth with WSMan essentially encodes your OAuth token as a base64 value encoded value in the header. If that base64 value exceeds 1024 characters then the library will return a failure.\r\n\r\nThis is just a guess really but without proper error messages from the `libmi` library (outside of the PowerShell team) there's little that it can do. You could try out my fork of the `omi` library with the [PSWSMan](https://www.powershellgallery.com/packages/PSWSMan/2.2.0) module. You do need root access to install the required libraries as it replaces the `libmi.so` in the pwsh dir but judging by the paths in your error that doesn't seem to be a problem. One thing this fork does is to bump the maximum password length from 1KiB to 8KiB which is closer to the standard limit on most web servers.\n\n<blockquote><img src=\"https://opengraph.githubassets.com/561acf1009bcb4cab0a2078b2feefeb3fb583e3b7b710bed53a3bd6f6f3710c8/microsoft/omi\" width=\"48\" align=\"right\"><div><img src=\"https://github.githubassets.com/favicons/favicon.svg\" height=\"14\"> GitHub</div><div><strong><a href=\"https://github.com/microsoft/omi\">microsoft/omi</a></strong></div><div>Open Management Infrastructure. Contribute to microsoft/omi development by creating an account on GitHub.</div></blockquote>",
      "created_at": "2021-05-07T23:53:25Z",
      "updated_at": "2021-05-07T23:53:27Z"
    },
    {
      "author": "Karrade7",
      "author_association": "NONE",
      "body": "First of all @jborean93 thank you for your work on PSWSMan. Now that I've waded into the same sea of issues and incompatibilities, I really appreciate the time you took to build your fork. I recently ran into the same issue as the poster, even though there are posts saying the same setup should work. I'm wondering if something new broke. I get the same MI_RESULT_FAILED error.\r\n\r\n\r\nI tried to used PSWSMan to workaround as follows in a docker container with the following docker file:\r\n```\r\nFROM mcr.microsoft.com/azure-powershell\r\nRUN apt-get update -y\r\nRUN sh -c \"yes | pwsh -Command 'Install-Module -Name PSWSMan'\"\r\nRUN pwsh -Command 'Install-WSMan'\r\nRUN mkdir -p /usr/local/share/pwsh\r\nWORKDIR /usr/local/share/pwsh\r\nENTRYPOINT [\"/usr/bin/pwsh\"]\r\n```\r\n\r\nbut when running this container and attempting to connect to ExchangeOnline I get the following error:\r\n\r\n```\r\nPS /usr/local/share/pwsh> Connect-ExchangeOnline -Device   \r\nException: /root/.local/share/powershell/Modules/ExchangeOnlineManagement/2.0.4/netCore/ExchangeOnlineManagement.psm1:475\r\nLine |\r\n 475 |  \u2026 PSSession = New-ExoPSSession -ExchangeEnvironmentName $ExchangeEnviro \u2026\r\n     |                ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | Connecting to remote server outlook.office365.com failed with the following error message : error:00000000:lib(0):func(0):reason(0) For more information, see the about_Remote_Troubleshooting Help topic.\r\n\r\nPS /usr/local/share/pwsh> \r\n```\r\n\r\nAny other ideas? Am I using WSMan wrong? Thanks!\r\n",
      "created_at": "2021-05-09T22:52:04Z",
      "updated_at": "2021-05-09T22:52:04Z"
    },
    {
      "author": "jborean93",
      "author_association": "COLLABORATOR",
      "body": "> error:00000000:lib(0):func(0):reason(0)\r\n\r\nDarn I was at least hoping it would share the OpenSSL error but for some reason it's just return a status of 0. You aren't doing anything wrong, the fact that you got at least some OpenSSL msg back indicates that you are using the new library.\r\n\r\nOne extra thing you can try is to create the following file at `/opt/omi/etc/omicli.conf` with the following contents\r\n\r\n```\r\nloglevel = DEBUG\r\nlogpath = /tmp/\r\nlogfile = omi-pwsh.log\r\n```\r\n\r\nOnce you do that and run the PowerShell code again this should give you a lot of info around how the `libmi` tried to connect to the endpoint. I would search for `MI_RESULT_FAILED` or maybe just `MI_RESULT` and try and find out what happened just before that. For example on a local test when I connect to an endpoint with an invalid certificate I get the following in my log\r\n\r\n```\r\n2021/05/11 03:39:09 [268250,268288] DEBUG: null(0): EventId=45297 Priority=DEBUG MI_Client Application Initialize: application=0x7f8c1c0b36a0, internal-application=0x7f8c1c057430\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45283 Priority=DEBUG Enter Application_NewSession with application (0x7f8c1c0b36a0), protocol (null), destination(server2019.domain.test), session (0x7f8c1c0be2f8).\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45293 Priority=DEBUG Enter Session_Create with application (0x7f8c1c0b36a0), protocol (null), destination(server2019.domain.test), session (0x7f8c1c0be2f8).\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45292 Priority=DEBUG Session called: Session_ImpersonateClientInternal\r\n2021/05/11 03:39:10 [268250,268388] DEBUG: null(0): EventId=45142 Priority=DEBUG InteractionProtocolHandler_Protocol_RunThread\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45303 Priority=DEBUG MI_Client Session Create: application=0x7f8c1c0b36a0, session=0x7f8c1c0be2f8, internal-session=0x7f8c1c00e570\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45292 Priority=DEBUG Session called: Session_RevertImpersonation\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45284 Priority=DEBUG Leave Application_NewSession with session (0x7f8c1c0be2f8).\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45295 Priority=DEBUG Enter Session_AccessCheck - session (0x7f8c1c0be2f8)\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45289 Priority=DEBUG Increase refcount for thunk handle: 0x7f8c1c011630\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45290 Priority=DEBUG Get correct thunk handle 0x7f8c27ffb720 from generic handle: 0x7f8c1c0be2f8\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45288 Priority=DEBUG Decrease refcount without release thunk handle: 0x7f8c1c011630\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45296 Priority=DEBUG Leave Session_AccessCheck on session (0x7f8c1c0be2f8) with for operation (create instance).\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45292 Priority=DEBUG Session called: Session_GetApplication\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45289 Priority=DEBUG Increase refcount for thunk handle: 0x7f8c1c011630\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45290 Priority=DEBUG Get correct thunk handle 0x7f8c27ffb730 from generic handle: 0x7f8c1c0be2f8\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45288 Priority=DEBUG Decrease refcount without release thunk handle: 0x7f8c1c011630\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45292 Priority=DEBUG Session called: Session_GetProtocolHandlerSession\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45289 Priority=DEBUG Increase refcount for thunk handle: 0x7f8c1c011630\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45290 Priority=DEBUG Get correct thunk handle 0x7f8c27ffb730 from generic handle: 0x7f8c1c0be2f8\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45288 Priority=DEBUG Decrease refcount without release thunk handle: 0x7f8c1c011630\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45292 Priority=DEBUG Session called: Session_ImpersonateClient\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45292 Priority=DEBUG Session called: Session_GetProtocolHandlerApplication\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45289 Priority=DEBUG Increase refcount for thunk handle: 0x7f8c1c011630\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45290 Priority=DEBUG Get correct thunk handle 0x7f8c27ffb730 from generic handle: 0x7f8c1c0be2f8\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45288 Priority=DEBUG Decrease refcount without release thunk handle: 0x7f8c1c011630\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45292 Priority=DEBUG Session called: Session_RegisterOperation\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45289 Priority=DEBUG Increase refcount for thunk handle: 0x7f8c1c011630\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45290 Priority=DEBUG Get correct thunk handle 0x7f8c27ffb720 from generic handle: 0x7f8c1c0be2f8\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45288 Priority=DEBUG Decrease refcount without release thunk handle: 0x7f8c1c011630\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45289 Priority=DEBUG Increase refcount for thunk handle: 0x7f8c1c015630\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45325 Priority=DEBUG MI_Client Operation Create Instance: session=0x7f8c1c0be2f8, operation=0x7f8c1c0be310, internal-operation=0x7f8c1c014cc0, namespace=<null>\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): _CreateConnectorSocket - Begin. host: server2019.domain.test, port: 5986, secure? 1\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): _CreateSocketAndConnect - Begin\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): _CreateSocketAndConnect - OK exit\r\n2021/05/11 03:39:10 [268250,268288] INFO: null(0): EventId=40032 Priority=INFO Selector_AddHandler: selector=0x7f8c785a97a8, handler=0x7f8c1c283d60, name=HTTP_CLIENT\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): _CreateConnectorSocket - OK exit. socket: 105, secure: 1, timeout: 01:00.000\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45146 Priority=DEBUG InteractionProtocolHandler_Session_Connect passed !\r\n2021/05/11 03:39:10 [268250,268288] DEBUG: null(0): EventId=45292 Priority=DEBUG Session called: Session_RevertImpersonation\r\n2021/05/11 03:39:10 [268250,268388] DEBUG: null(0): EventId=45156 Priority=DEBUG (E)Protocol _RequestCallback: scheduling connect event on first read for ProtocolSocket 0x7f8c1c283d60\r\n2021/05/11 03:39:10 [268250,268388] DEBUG: null(0): EventId=45131 Priority=DEBUG InteractionProtocolHandler_Operation_Strand_PostControl 0x7f8c1c0bcb70\r\n2021/05/11 03:39:10 [268250,268388] DEBUG: null(0): EventId=45132 Priority=DEBUG ==== InteractionProtocolHandler_Session_ConnectionEvents() PROTOCOLEVENT_CONNECT\r\n2021/05/11 03:39:10 [268250,268388] DEBUG: null(0): EventId=45148 Priority=DEBUG ProtocolSocket: Posting message for interaction [0x7f8c1c1bf678]<-0x7f8c1c0bd3e8\r\n2021/05/11 03:39:10 [268250,268388] DEBUG: null(0): EventId=45206 Priority=DEBUG Sending msg(0x7f8c1c1bdf18:4109:CreateInstanceReq:2711) on own thread\r\n2021/05/11 03:39:10 [268250,268388] ERROR: null(0): EventId=20129 Priority=ERROR SSL error 20 verifying with certificate:\r\n2021/05/11 03:39:10 [268250,268388] ERROR: null(0): HttpClient_StartRequestV2 - SSL connect returned OpenSSL error 1 (error:1416F086:SSL routines:tls_process_server_certificate:certificate verify failed)\r\n2021/05/11 03:39:10 [268250,268388] DEBUG: null(0): EventId=45128 Priority=DEBUG InteractionProtocolHandler_Operation_Strand_Post: 0x7f8c1c0bcb70, msg(0x7f8c18000b98:4:PostResultMsg:0)\r\n2021/05/11 03:39:10 [268250,268388] DEBUG: null(0): EventId=45129 Priority=DEBUG MI_Result = MI_RESULT_FAILED\r\n2021/05/11 03:39:10 [268250,268388] DEBUG: null(0): EventId=45307 Priority=DEBUG MI_Client Operation Instance Result (async): session=0x7f8c1c0be2f8, operation=0x7f8c1c0be310, internal-operation=0x7f8c1c014cc0, resultCode=1, moreResults=FALSE\r\n2021/05/11 03:39:10 [268250,268388] DEBUG: null(0): EventId=45292 Priority=DEBUG Session called: Session_ImpersonateClient\r\n```\r\n\r\nIn particular I can see the error occurred when verifying the certificate\r\n\r\n```\r\nERROR: null(0): HttpClient_StartRequestV2 - SSL connect returned OpenSSL error 1 (error:1416F086:SSL routines:tls_process_server_certificate:certificate verify failed)\r\nDEBUG: null(0): EventId=45128 Priority=DEBUG InteractionProtocolHandler_Operation_Strand_Post: 0x7f8c1c0bcb70, msg(0x7f8c18000b98:4:PostResultMsg:0)\r\nDEBUG: null(0): EventId=45129 Priority=DEBUG MI_Result = MI_RESULT_FAILED\r\n```\r\n\r\nThis might help to indicate more as to what may have gone wrong. I doubt it would be the case but you could try disabling certificate verification that PSWSMan does by running `Disable-WSManCertVerification -All` before your connect command. I would expect another error message if it was cert validation. ",
      "created_at": "2021-05-11T03:46:05Z",
      "updated_at": "2021-05-11T03:46:05Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "/cc @joeyaiello @SteveL-MSFT for the WSMan remoting issue on Linux.",
      "created_at": "2021-05-11T17:24:25Z",
      "updated_at": "2021-05-11T17:24:25Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This issue has been marked as \"Waiting on Author\" and has not had any activity for **7 day**. It has been closed for housekeeping purposes.",
      "created_at": "2022-01-08T04:00:48Z",
      "updated_at": "2022-01-08T04:00:48Z"
    }
  ],
  "created_at": "2021-05-07T18:40:48Z",
  "number": 15362,
  "state": "closed",
  "title": "MI_RESULT_FAILED Error with Connect-ExchangeOnline running in app only mode ",
  "updated_at": "2022-01-08T04:00:50Z"
}