{
  "_url": "https://github.com/PowerShell/PowerShell/issues/6430",
  "author": "rjmholt",
  "body": "## PR Summary\r\n\r\n<!-- summarize your PR between here and the checklist -->\r\n\r\nTests of `Get-FileHash` currently rely on a static asset, whose encoding depends on platform configurations. This causes hash output to be platform-dependent and makes tests fail.\r\n\r\nThis PR changes the tests to write raw bytes to the test file first, so that the platform does not influence the outcome of the test.\r\n\r\nPartially addresses #6413 and possibly #5960 and #6369.\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` to the beginning of the title and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] User-facing [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed - Issue link:\r\n- **Testing - New and feature**\r\n    - [x] Not Applicable or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [x] [Add `[feature]` if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n",
  "closed_at": "2018-03-20T22:11:38Z",
  "comments": [
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "Just to document: the actual byte string used is \"&lt;BOM&gt;Get-Module\\n\" encoded in UTF-8. The BOM may be controversial, but that's what matches the hashes that were already there, so is the simplest solution.\r\n\r\nWere it not for the BOM, I would have preferred\r\n```powershell\r\n[System.IO.File]::WriteAllText($testDocument, \"Get-Module`n\", [System.Text.Encoding]::UTF8)\r\n```\r\nBut I wasn't sure how to force a BOM into that.\r\n\r\nEDIT: the above implementation actually includes a BOM. The implementation we use has\r\n```powershell\r\n[System.IO.File::WriteAllText($testDocument, \"Get-Module`n\", [System.Text.UTF8Encoding]::new($false))\r\n```\r\nwhere the `$false` means \"do **not** use BOM\"",
      "created_at": "2018-03-19T18:47:26Z",
      "updated_at": "2018-03-19T23:46:58Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "I've restarted the Travis CI job, since none of the tests failed.\r\n\r\nThe problem was this:\r\n![Travis CI failure](https://imgur.com/lS9Sg2L.png)",
      "created_at": "2018-03-20T00:26:45Z",
      "updated_at": "2018-03-20T00:26:45Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "@dantraMSFT with this merged, are #6369 and #5960 still issues?",
      "created_at": "2018-03-21T01:31:43Z",
      "updated_at": "2018-03-21T01:31:43Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "Also, I was waiting til the end to squash my commits -- should I have done that earlier?",
      "created_at": "2018-03-21T05:53:28Z",
      "updated_at": "2018-03-21T05:53:28Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Clear about WriteAllText :-)\r\n\r\nI wonder - I was sure we excluded these assert files from the Git recoding \ud83d\ude15 But it doesn't matter anymore - I agree that it is better to create them in runtime.\r\nAs for the BOM I believe we should keep these tests because the BOM is still widely used and this cmdlet should work with it correctly. I've PR #3395 and I fear that I can ruin something without these tests.",
      "created_at": "2018-03-21T05:58:07Z",
      "updated_at": "2018-03-21T05:58:07Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I think if we copy a file (with BOM too) from Windows 7 to Windows Server 2016 - the hash should be the same on both platforms.",
      "created_at": "2018-03-21T06:00:55Z",
      "updated_at": "2018-03-21T06:00:55Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@rjmholt don't worry about squashing, it happens at merge time",
      "created_at": "2018-03-21T17:06:15Z",
      "updated_at": "2018-03-21T17:06:15Z"
    },
    {
      "author": "rjmholt",
      "author_association": "COLLABORATOR",
      "body": "@SteveL-MSFT Awesome\r\n\r\n@iSazonov I agree, we should add some more tests that have strings with BOMs and line endings in. One because that helps us verify the `Get-FileHash` cmdlet, but also because having that test fail is often a good indicator that other things could be happening.",
      "created_at": "2018-03-21T17:57:16Z",
      "updated_at": "2018-03-21T17:57:16Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@rjmholt Have you plans to add the tests? Otherwise please open new tracking Issue.",
      "created_at": "2018-03-22T03:36:29Z",
      "updated_at": "2018-03-22T03:36:29Z"
    }
  ],
  "created_at": "2018-03-19T16:52:39Z",
  "number": 6430,
  "state": "closed",
  "title": "Change `Get-FileHash` tests to use raw bytes",
  "updated_at": "2018-06-22T22:55:24Z"
}