{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17085",
  "author": "CloudViking86",
  "body": "### Prerequisites\r\n\r\n- [X] Write a descriptive title.\r\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- [X] Search the existing issues.\r\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n\r\n### Steps to reproduce\r\n\r\nI recently had quite a weird behaviour when using \"Invoke-Restmethod\";\r\n* I was doing a 'POST' with a payload (\"body\") that I wasn't actually sure was 100% right\r\n* The response even with the \"-Verbose\" parameter was;\r\n```\r\nVERBOSE: POST with 4475-byte payload\r\nVERBOSE: received -byte response of content type application/json\r\nInvoke-RestMethod:\r\n```\r\n* Upon checking in Postman I can see that the response body was <null> but I could also see the actual issue; \"Status 403 Forbidden\" (I had only read-privileges' on the API which explained why my initial GET's where working)\r\n\r\nShouldn't the response from \"Invoke-Restmethod\" be \"403 Forbidden\" or similar even though the actual response body is <null>?\r\n\r\nWhen running \"Get-Error\" to post this there I can clearly see that it is \"403\" but shouldn't this be shown directly when \"Invoke-Restmethod\" error out?\r\n\r\nBest Regards\r\n\r\n### Expected behavior\r\n\r\n```console\r\nInvoke-RestMethod : The remote server returned an error: (403) Forbidden.\r\n```\r\n\r\n\r\n### Actual behavior\r\n\r\n```console\r\nInvoke-RestMethod:\r\n^ i.e. <null> after the semicolon\r\n```\r\n\r\n\r\n### Error details\r\n\r\n```console\r\nException             : \r\n    Type       : Microsoft.PowerShell.Commands.HttpResponseException\r\n    Response   : StatusCode: 403, ReasonPhrase: 'Forbidden', Version: 1.1, Content: System.Net.Http.HttpConnectionResponseContent, Headers:\r\n                 {\r\n                 Server: nginx/1.21.6\r\n                 Date: Wed, 30 Mar 2022 12:46:38 GMT\r\n                 Transfer-Encoding: chunked\r\n                 Connection: keep-alive\r\n                 Vary: Accept-Encoding\r\n                 Cache-Control: no-cache, no-store, max-age=0, must-revalidate\r\n                 Pragma: no-cache\r\n                 X-Frame-Options: SAMEORIGIN\r\n                 X-Robots-Tag: none\r\n                 X-UA-Compatible: IE=Edge,chrome=1\r\n                 X-Request-ID: 35820fb270233138b1f266f5c9dfaff8\r\n                 X-Runtime: 0.070207\r\n                 Strict-Transport-Security: max-age=15552000; includeSubDomains\r\n                 Content-Type: application/json; charset=utf-8\r\n                 Expires: Fri, 01 Jan 1990 00:00:00 GMT\r\n                 }\r\n    TargetSite : \r\n        Name          : ThrowTerminatingError\r\n        DeclaringType : System.Management.Automation.MshCommandRuntime, System.Management.Automation, Version=7.2.2.500, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n        MemberType    : Method\r\n        Module        : System.Management.Automation.dll\r\n    Message    : Response status code does not indicate success: 403 (Forbidden).\r\n    Source     : System.Management.Automation\r\n    HResult    : -2146233088\r\n    StackTrace : \r\n   at System.Management.Automation.MshCommandRuntime.ThrowTerminatingError(ErrorRecord errorRecord)\r\nTargetObject          : Method: POST, RequestUri: 'https://api.meraki.com/api/v1/networks/<redacted>/groupPolicies', Version: 1.1, Content: System.Net.Http.ByteArrayContent, Headers:\r\n                        {\r\n                        Authorization: Bearer <redacted>\r\n                        Accept: application/json\r\n                        User-Agent: Mozilla/5.0\r\n                        User-Agent: (Windows NT 10.0; Microsoft Windows 10.0.19044; en-US)\r\n                        User-Agent: PowerShell/7.2.2\r\n                        Content-Length: 4475\r\n                        Content-Type: application/json\r\n                        }\r\nCategoryInfo          : InvalidOperation: (Method: POST, Reque\u2026application/json\r\n                        }:HttpRequestMessage) [Invoke-RestMethod], HttpResponseException\r\nFullyQualifiedErrorId : WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeRestMethodCommand\r\nErrorDetails          : \r\nInvocationInfo        : \r\n    MyCommand        : Invoke-RestMethod\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 1\r\n    HistoryId        : 30\r\n    Line             : Invoke-Restmethod -Headers $headers -Method POST -Uri $($meraki_baseurl + $meraki_networks + \"/\" + $get_networkid_jpn + \"/\" + \"groupPolicies\") -Body $grouppolicy_json -PreserveAuthorizationOnRedirect -Verbose\r\n    PositionMessage  : At line:1 char:1\r\n                       + Invoke-Restmethod -Headers $headers -Method POST -Uri $($meraki_baseu \u2026\r\n                       + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    InvocationName   : Invoke-Restmethod\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n```\r\n\r\n\r\n### Environment data\r\n\r\n```powershell\r\name                           Value\r\n----                           -----\r\nPSVersion                      7.2.2\r\nPSEdition                      Core\r\nGitCommitId                    7.2.2\r\nOS                             Microsoft Windows 10.0.19044\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\n\r\n### Visuals\r\n\r\n![prntscrn_pscore_invoke-restmethod_403_bugreport_300322](https://user-images.githubusercontent.com/45990856/160843557-763a976d-5e9a-4626-bf9f-57bf0e981081.PNG)\r\n",
  "closed_at": null,
  "comments": [
    {
      "author": "OsvaldoRino",
      "author_association": "NONE",
      "body": "> ### Prerequisites\r\n> * [x]  Write a descriptive title.\r\n> * [x]  Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n> * [x]  Search the existing issues.\r\n> * [x]  Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n> * [x]  Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n> \r\n> ### Steps to reproduce\r\n> I recently had quite a weird behaviour when using \"Invoke-Restmethod\";\r\n> \r\n> * I was doing a 'POST' with a payload (\"body\") that I wasn't actually sure was 100% right\r\n> * The response even with the \"-Verbose\" parameter was;\r\n> \r\n> ```\r\n> VERBOSE: POST with 4475-byte payload\r\n> VERBOSE: received -byte response of content type application/json\r\n> Invoke-RestMethod:\r\n> ```\r\n> \r\n>  * Upon checking in Postman I can see that the response body was  but I could also see the actual issue; \"Status 403 Forbidden\" (I had only read-privileges' on the API which explained why my initial GET's where working)\r\n> \r\n> Shouldn't the response from \"Invoke-Restmethod\" be \"403 Forbidden\" or similar even though the actual response body is ?\r\n> \r\n> When running \"Get-Error\" to post this there I can clearly see that it is \"403\" but shouldn't this be shown directly when \"Invoke-Restmethod\" error out?\r\n> \r\n> Best Regards\r\n> \r\n> ### Expected behavior\r\n> ```\r\n> Invoke-RestMethod : The remote server returned an error: (403) Forbidden.\r\n> ```\r\n> \r\n> ### Actual behavior\r\n> ```\r\n> Invoke-RestMethod:\r\n> ^ i.e. <null> after the semicolon\r\n> ```\r\n> \r\n> ### Error details\r\n> ```\r\n> Exception             : \r\n>     Type       : Microsoft.PowerShell.Commands.HttpResponseException\r\n>     Response   : StatusCode: 403, ReasonPhrase: 'Forbidden', Version: 1.1, Content: System.Net.Http.HttpConnectionResponseContent, Headers:\r\n>                  {\r\n>                  Server: nginx/1.21.6\r\n>                  Date: Wed, 30 Mar 2022 12:46:38 GMT\r\n>                  Transfer-Encoding: chunked\r\n>                  Connection: keep-alive\r\n>                  Vary: Accept-Encoding\r\n>                  Cache-Control: no-cache, no-store, max-age=0, must-revalidate\r\n>                  Pragma: no-cache\r\n>                  X-Frame-Options: SAMEORIGIN\r\n>                  X-Robots-Tag: none\r\n>                  X-UA-Compatible: IE=Edge,chrome=1\r\n>                  X-Request-ID: 35820fb270233138b1f266f5c9dfaff8\r\n>                  X-Runtime: 0.070207\r\n>                  Strict-Transport-Security: max-age=15552000; includeSubDomains\r\n>                  Content-Type: application/json; charset=utf-8\r\n>                  Expires: Fri, 01 Jan 1990 00:00:00 GMT\r\n>                  }\r\n>     TargetSite : \r\n>         Name          : ThrowTerminatingError\r\n>         DeclaringType : System.Management.Automation.MshCommandRuntime, System.Management.Automation, Version=7.2.2.500, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n>         MemberType    : Method\r\n>         Module        : System.Management.Automation.dll\r\n>     Message    : Response status code does not indicate success: 403 (Forbidden).\r\n>     Source     : System.Management.Automation\r\n>     HResult    : -2146233088\r\n>     StackTrace : \r\n>    at System.Management.Automation.MshCommandRuntime.ThrowTerminatingError(ErrorRecord errorRecord)\r\n> TargetObject          : Method: POST, RequestUri: 'https://api.meraki.com/api/v1/networks/<redacted>/groupPolicies', Version: 1.1, Content: System.Net.Http.ByteArrayContent, Headers:\r\n>                         {\r\n>                         Authorization: Bearer <redacted>\r\n>                         Accept: application/json\r\n>                         User-Agent: Mozilla/5.0\r\n>                         User-Agent: (Windows NT 10.0; Microsoft Windows 10.0.19044; en-US)\r\n>                         User-Agent: PowerShell/7.2.2\r\n>                         Content-Length: 4475\r\n>                         Content-Type: application/json\r\n>                         }\r\n> CategoryInfo          : InvalidOperation: (Method: POST, Reque\u2026application/json\r\n>                         }:HttpRequestMessage) [Invoke-RestMethod], HttpResponseException\r\n> FullyQualifiedErrorId : WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeRestMethodCommand\r\n> ErrorDetails          : \r\n> InvocationInfo        : \r\n>     MyCommand        : Invoke-RestMethod\r\n>     ScriptLineNumber : 1\r\n>     OffsetInLine     : 1\r\n>     HistoryId        : 30\r\n>     Line             : Invoke-Restmethod -Headers $headers -Method POST -Uri $($meraki_baseurl + $meraki_networks + \"/\" + $get_networkid_jpn + \"/\" + \"groupPolicies\") -Body $grouppolicy_json -PreserveAuthorizationOnRedirect -Verbose\r\n>     PositionMessage  : At line:1 char:1\r\n>                        + Invoke-Restmethod -Headers $headers -Method POST -Uri $($meraki_baseu \u2026\r\n>                        + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n>     InvocationName   : Invoke-Restmethod\r\n>     CommandOrigin    : Internal\r\n> ScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n> ```\r\n> \r\n> ### Environment data\r\n> ```powershell\r\n> ame                           Value\r\n> ----                           -----\r\n> PSVersion                      7.2.2\r\n> PSEdition                      Core\r\n> GitCommitId                    7.2.2\r\n> OS                             Microsoft Windows 10.0.19044\r\n> Platform                       Win32NT\r\n> PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\n> PSRemotingProtocolVersion      2.3\r\n> SerializationVersion           1.1.0.1\r\n> WSManStackVersion              3.0\r\n> ```\r\n> \r\n> ### Visuals\r\n> ![prntscrn_pscore_invoke-restmethod_403_bugreport_300322](https://user-images.githubusercontent.com/45990856/160843557-763a976d-5e9a-4626-bf9f-57bf0e981081.PNG)\r\n\r\n",
      "created_at": "2022-03-30T19:26:56Z",
      "updated_at": "2022-03-30T19:26:56Z"
    },
    {
      "author": "jhoneill",
      "author_association": "NONE",
      "body": "The error details field contains the page body that was returned, and that is what is shown in a short error. In this case its null. I just tried creating a 404 error and got masses of text in the message and where you have a blank line where you get the error.  Null pages or massively verbose ones aren't helpful. But there will be scripts out there which look for things in the body returned as a response when there is an error, so changing this would break things.  ",
      "created_at": "2022-03-30T19:34:18Z",
      "updated_at": "2022-03-30T19:34:18Z"
    }
  ],
  "created_at": "2022-03-30T13:18:15Z",
  "labels": [
    "WG-Cmdlets-Utility",
    "Needs-Triage"
  ],
  "number": 17085,
  "state": "open",
  "title": "Invoke-Restmethod | If response is <null> I should still see the HTTP Status Code in the error?",
  "updated_at": "2022-04-02T03:39:12Z"
}