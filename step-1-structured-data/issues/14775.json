{
  "_url": "https://github.com/PowerShell/PowerShell/issues/14775",
  "author": "KUTlime",
  "body": "This issue is partially an issue of Windows PowerShell and PowerShell. \r\n\r\nWhen I try pass a PSCustomObject loaded from JSON from PowerShell into Windows PowerShell, it will fail once JSON pass a certain size level.\r\n\r\nPowerShell 7.1.1 and Windows PowerShell throw different errors and **passing through of PSCustomObject argument** doesn't work from properly. It depends on the argument size or complexity, see this screenshot.\r\n\r\n![2021-02-12 150531 l5lxRrDMSR](https://user-images.githubusercontent.com/8374320/107780631-39842800-6d47-11eb-94af-ccd914a0a66b.png)\r\n\r\n### The problem disappears when I remove any two subkeys from `root\\WebApp` in the configuration JSON.\r\n\r\n## Steps to reproduce\r\n\r\nFor a minimal, reproducible example, see [this](https://github.com/PowerShell/PowerShell/issues/14775#issuecomment-779687941) comment. When I debug the PS run, it pointed me to STDOUT/STDIN buffer size too.\r\n\r\n```powershell\r\n$configuration = Get-Content .\\configuration.json | ConvertFrom-Json\r\n$block = {param([pscustomobject]$inputArgument) $PSVersionTable; Write-Host ('Test ' + $inputArgument.AxisUser.Name)}\r\npowershell -nologo -noprofile $block -Args $configuration\r\n```\r\n\r\n## Expected behavior\r\n\r\n### Windows PowerShell\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.18362.1171\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.18362.1171\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nTest String from json\r\n```\r\n\r\n### PowerShell 7.1.1\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.18362.1171\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.18362.1171\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nTest String from json\r\n```\r\n\r\n\r\n## Actual behavior\r\n\r\n### Windows PowerShell\r\n```none\r\nProgram 'powershell.exe' failed to run: Filename or Extension too longAt line:1\r\nchar:1\r\n+ powershell -nologo -noprofile $block -Args $configuration\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.\r\nAt line:1 char:1\r\n+ powershell -nologo -noprofile $block -Args $configuration\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException\r\n    + FullyQualifiedErrorId : NativeCommandFailed\r\n```\r\n\r\n### PowerShell 7.1.1\r\n```none\r\nResourceUnavailable: Program 'powershell.exe' failed to run: The Process object must have the UseShellExecute property set to false in order to use environment variables.At line:1 char:1\r\n+ powershell -nologo -noprofile $block -Args $configuration\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.\r\n```\r\n\r\n## Environment data\r\n\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.1\r\nPSEdition                      Core\r\nGitCommitId                    7.1.1\r\nOS                             Microsoft Windows 10.0.18363\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\n## Configuration JSON\r\n\r\n```json\r\n{\r\n    \"SupportedPSVersion\": \"7.1.0\",\r\n    \"Localhost\": true,\r\n    \"SourceCodeLocalPath\": \"%USERPROFILE%\\\\source\\\\CompanyName\\\\ProductName\\\\\",\r\n    \"AzureDevOpsUser\": {\r\n        \"Name\": \"\",\r\n        \"Password\": \"\"\r\n    },\r\n    \"VPNUserName\": \"John.Doe\",\r\n    \"ProductNameUser\": {\r\n        \"Name\": \"String from json\",\r\n        \"FullName\": \"ProductName DEV user\",\r\n        \"Password\": \"123456\",\r\n        \"Group\": \"Department\"\r\n    },\r\n    \"NetworkHost\": \"0.0.0.0\",\r\n    \"AppPool\": {\r\n        \"Name\": \"ProductName\"\r\n    },\r\n    \"Website\": [\r\n        {\r\n            \"Name\": \"ProductNameWeb\",\r\n            \"Port\": 1810,\r\n            \"ApplicationPool\": \"ProductName\",\r\n            \"BindingInformation\": \"*:1810:\",\r\n            \"Id\": 2,\r\n            \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\",\r\n            \"SelfSignedCertificatePassword\": \"WithGreatPowerComesGreatResponsibility\"\r\n        },\r\n        {\r\n            \"Name\": \"ProductNameApp\",\r\n            \"Port\": 1985,\r\n            \"ApplicationPool\": \"ProductName\",\r\n            \"BindingInformation\": \"*:1985:\",\r\n            \"Id\": 3,\r\n            \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\"\r\n        }\r\n    ],\r\n    \"FrontendWebsiteId\": 2,\r\n    \"BackendWebsiteId\": 3,\r\n    \"FrontendEndpointToSubstitude\": \"ProductNamev2devweb1.ProductNamegraphics.tv\",\r\n    \"BackendEndpointToSubstitude\": \"ProductNamev2devapp1.ProductNamegraphics.tv\",\r\n    \"WebApp\": {\r\n        \"Portal\": {\r\n            \"FilePathToConfig\": \"%USERPROFILE%\\\\source\\\\CompanyName\\\\ProductName\\\\portal\\\\CompanyName.Portal.Web\\\\Root.Web.Release-Dev.config\",\r\n            \"TargetAbsolutePathToConfig\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Web.config\",\r\n            \"ProjectsToPublish\": [\r\n                {\r\n                    \"RelativeProjectPath\": \"portal\\\\CompanyName.Portal.Web\\\\CompanyName.Portal.Web.csproj\",\r\n                    \"RelativePublishProfilePath\": \"portal\\\\CompanyName.Portal.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                },\r\n                {\r\n                    \"RelativeProjectPath\": \"portal\\\\CompanyName.Portal.API\\\\CompanyName.Portal.API.csproj\",\r\n                    \"RelativePublishProfilePath\": \"portal\\\\CompanyName.Portal.API\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                },\r\n                {\r\n                    \"RelativeProjectPath\": \"portal\\\\CompanyName.Portal.Application.WebService\\\\CompanyName.Portal.Application.WebService.csproj\",\r\n                    \"RelativePublishProfilePath\": \"portal\\\\CompanyName.Portal.Application.WebService\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                }\r\n            ],\r\n            \"SymbolicLinkToCreate\": [],\r\n            \"AppToCreateOnFrontendWebsite\": [\r\n                {\r\n                    \"Name\": \"Portal\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Portal\"\r\n                },\r\n                {\r\n                    \"Name\": \"PortalApi\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\PortalApi\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnBackendWebsite\": [\r\n                {\r\n                    \"Name\": \"Portal\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\CompanyName.Portal.Application.WebService\"\r\n                }\r\n            ],\r\n            \"HomePageFiles\": {\r\n                \"TargetWebApplication\": \"Portal\",\r\n                \"Name\": \"HomePageFiles\",\r\n                \"PhysicalPath\": \"\\\\\\\\0.0.0.0\\\\pogo\\\\ProductNamev2\\\\dev\\\\Portal\\\\HomePageFiles\"\r\n            }\r\n        },\r\n        \"Track\": {\r\n            \"ProjectsToPublish\": [\r\n                {\r\n                    \"RelativeProjectPath\": \"track\\\\CompanyName.Track.Web\\\\CompanyName.Track.Web.csproj\",\r\n                    \"RelativePublishProfilePath\": \"track\\\\CompanyName.Track.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                },\r\n                {\r\n                    \"RelativeProjectPath\": \"track\\\\CompanyName.Track.Api\\\\CompanyName.Track.Api.csproj\",\r\n                    \"RelativePublishProfilePath\": \"track\\\\CompanyName.Track.Api\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                },\r\n                {\r\n                    \"RelativeProjectPath\": \"track\\\\CompanyName.Track.WebService\\\\CompanyName.Track.WebService.csproj\",\r\n                    \"RelativePublishProfilePath\": \"track\\\\CompanyName.Track.WebService\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                },\r\n                {\r\n                    \"RelativeProjectPath\": \"track\\\\CompanyName.Track.ConfigurationDomain\\\\CompanyName.Track.ConfigurationDomain.csproj\",\r\n                    \"RelativePublishProfilePath\": \"track\\\\CompanyName.Track.ConfigurationDomain\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                }\r\n            ],\r\n            \"SymbolicLinkToCreate\": [\r\n                {\r\n                    \"RelativePublishProfilePath\": \"track\\\\CompanyName.Track.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\",\r\n                    \"TargetRelativePath\": \"bin\\\\Shared\",\r\n                    \"SourcePath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Portal\\\\bin\"\r\n                },\r\n                {\r\n                    \"RelativePublishProfilePath\": \"track\\\\CompanyName.Track.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\",\r\n                    \"TargetRelativePath\": \"Shared\",\r\n                    \"SourcePath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Portal\\\\Shared\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnFrontendWebsite\": [\r\n                {\r\n                    \"Name\": \"Track\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Track\"\r\n                },\r\n                {\r\n                    \"Name\": \"TrackApi\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\CompanyName.Track.Api\"\r\n                },\r\n                {\r\n                    \"Name\": \"ConfigurationDomain\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\CompanyName.Track.ConfigurationDomain\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnBackendWebsite\": [\r\n                {\r\n                    \"Name\": \"Track\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\CompanyName.Track.WebService\"\r\n                }\r\n            ],\r\n            \"Cache\": {\r\n                \"LocalFolderPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\TrackCache\",\r\n                \"Name\": \"TrackCache\\\\Cache\",\r\n                \"PhysicalPath\": \"\\\\\\\\1.1.1.1\\\\pogo\\\\ProductNamev2\\\\dev\\\\track\"\r\n            },\r\n            \"VueJS\": {\r\n                \"RelativeSourcePath\": \"track\\\\CompanyName.Track.Web\\\\\",\r\n                \"RelativeBuildPath\": \"track\\\\CompanyName.Track.Web\\\\src\\\\build\",\r\n                \"Destination\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Track\\\\src\\\\\"\r\n            }\r\n        },\r\n        \"ProductNameAPI\": {\r\n            \"ProjectsToPublish\": [\r\n                {\r\n                    \"RelativeProjectPath\": \"ProductNameapi\\\\ProductNameAPI\\\\ProductNameAPI.csproj\",\r\n                    \"RelativePublishProfilePath\": \"ProductNameapi\\\\ProductNameAPI\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                }\r\n            ],\r\n            \"SymbolicLinkToCreate\": [],\r\n            \"AppToCreateOnFrontendWebsite\": [\r\n                {\r\n                    \"Name\": \"ProductNameApi\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\ProductNameApi\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnBackendWebsite\": []\r\n        },\r\n        \"Compose\": {\r\n            \"ProjectsToPublish\": [\r\n                {\r\n                    \"RelativeProjectPath\": \"compose\\\\CompanyName.Compose.Web\\\\CompanyName.Compose.Web.csproj\",\r\n                    \"RelativePublishProfilePath\": \"compose\\\\CompanyName.Compose.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                }\r\n            ],\r\n            \"SymbolicLinkToCreate\": [\r\n                {\r\n                    \"RelativePublishProfilePath\": \"compose\\\\CompanyName.Compose.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\",\r\n                    \"TargetRelativePath\": \"bin\\\\Shared\",\r\n                    \"SourcePath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Portal\\\\bin\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnFrontendWebsite\": [\r\n                {\r\n                    \"Name\": \"Compose\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Compose\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnBackendWebsite\": []\r\n        },\r\n        \"Charts\": {\r\n            \"ProjectsToPublish\": [\r\n                {\r\n                    \"RelativeProjectPath\": \"charts\\\\CompanyName.Charts.Web\\\\CompanyName.Charts.Web.csproj\",\r\n                    \"RelativePublishProfilePath\": \"charts\\\\CompanyName.Charts.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                }\r\n            ],\r\n            \"SymbolicLinkToCreate\": [\r\n                {\r\n                    \"RelativePublishProfilePath\": \"charts\\\\CompanyName.Charts.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\",\r\n                    \"TargetRelativePath\": \"bin\\\\Shared\",\r\n                    \"SourcePath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Portal\\\\bin\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnFrontendWebsite\": [\r\n                {\r\n                    \"Name\": \"Charts\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Charts\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnBackendWebsite\": [],\r\n            \"VueJS\": {\r\n                \"RelativeSourcePath\": \"charts\\\\CompanyName.Charts.Web\\\\\",\r\n                \"RelativeBuildPath\": \"charts\\\\CompanyName.Charts.Web\\\\src\\\\build\",\r\n                \"Destination\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Charts\\\\src\\\\\"\r\n            }\r\n        },\r\n        \"Order\": {\r\n            \"ProjectsToPublish\": [\r\n                {\r\n                    \"RelativeProjectPath\": \"order\\\\CompanyName.Order.Web\\\\CompanyName.Order.Web.csproj\",\r\n                    \"RelativePublishProfilePath\": \"order\\\\CompanyName.Order.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                }\r\n            ],\r\n            \"SymbolicLinkToCreate\": [\r\n                {\r\n                    \"RelativePublishProfilePath\": \"order\\\\CompanyName.Order.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\",\r\n                    \"TargetRelativePath\": \"bin\\\\Shared\",\r\n                    \"SourcePath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Portal\\\\bin\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnFrontendWebsite\": [\r\n                {\r\n                    \"Name\": \"Order\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Order\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnBackendWebsite\": [],\r\n            \"MediaFormatImages\": {\r\n                \"LocalFolderPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\MediaFormatImages\",\r\n                \"Name\": \"MediaFormatImages\",\r\n                \"PhysicalPath\": \"\\\\\\\\1.1.1.1\\\\pogo\\\\ProductNamev2\\\\dev\\\\Order\\\\MediaFormatImages\"\r\n            }\r\n        },\r\n        \"Typefaces\": {\r\n            \"ProjectsToPublish\": [\r\n                {\r\n                    \"RelativeProjectPath\": \"typefaces\\\\CompanyName.Typefaces.Web\\\\CompanyName.Typefaces.Web.csproj\",\r\n                    \"RelativePublishProfilePath\": \"typefaces\\\\CompanyName.Typefaces.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                }\r\n            ],\r\n            \"SymbolicLinkToCreate\": [\r\n                {\r\n                    \"RelativePublishProfilePath\": \"typefaces\\\\CompanyName.Typefaces.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\",\r\n                    \"TargetRelativePath\": \"bin\\\\Shared\",\r\n                    \"SourcePath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Portal\\\\bin\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnFrontendWebsite\": [\r\n                {\r\n                    \"Name\": \"Typefaces\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Typefaces\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnBackendWebsite\": []\r\n        },\r\n        \"Transport\": {\r\n            \"ProjectsToPublish\": [\r\n                {\r\n                    \"RelativeProjectPath\": \"transport\\\\CompanyName.Transport.Web\\\\CompanyName.Transport.Web.csproj\",\r\n                    \"RelativePublishProfilePath\": \"transport\\\\CompanyName.Transport.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\"\r\n                }\r\n            ],\r\n            \"SymbolicLinkToCreate\": [\r\n                {\r\n                    \"RelativePublishProfilePath\": \"transport\\\\CompanyName.Transport.Web\\\\Properties\\\\PublishProfiles\\\\FolderProfile.pubxml\",\r\n                    \"TargetRelativePath\": \"bin\\\\Shared\",\r\n                    \"SourcePath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Portal\\\\bin\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnFrontendWebsite\": [\r\n                {\r\n                    \"Name\": \"Transport\",\r\n                    \"PhysicalPath\": \"%SystemDrive%\\\\inetpub\\\\wwwroot\\\\Transport\"\r\n                }\r\n            ],\r\n            \"AppToCreateOnBackendWebsite\": []\r\n        }\r\n    },\r\n    \"NuGet\": {\r\n        \"RestoreProjectForAzureCredentialManager\": \"%USERPROFILE%\\\\source\\\\CompanyName\\\\ProductName\\\\portal\\\\CompanyName.Portal.Web\\\\CompanyName.Portal.Web.csproj\"\r\n    }\r\n}\r\n```\r\n",
  "closed_at": null,
  "comments": [
    {
      "author": "iRon7",
      "author_association": "NONE",
      "body": "Unlike the CMD prompt, PowerShell doesn't automatically [Expand Environmental Variables](https://devblogs.microsoft.com/scripting/powertip-expand-environmental-variables-with-powershell/) which leaves an invalid json file. This means that you will need to explicitly expand the `$configuration` file before passing it as an argument.\r\n\r\nIn other works, your long/complex json configuration works fine for me when it is first expanded:\r\n```PowerShell\r\n$configuration = Get-Content .\\configuration.json | ConvertFrom-Json\r\n$configuration = [System.Environment]::ExpandEnvironmentVariables($configuration)\r\n$block = {param([pscustomobject]$inputArgument) $PSVersionTable; Write-Host ('Test ' + $inputArgument.AxisUser.Name)}\r\npowershell -nologo -noprofile $block -Args $configuration\r\n```",
      "created_at": "2021-02-13T08:37:15Z",
      "updated_at": "2021-02-13T12:44:33Z"
    },
    {
      "author": "KUTlime",
      "author_association": "NONE",
      "body": "@iRon7 Thx for explanation! This will solve my main problem.\r\n\r\nThe question is if PowerShell should or should not have the same behaviour here.",
      "created_at": "2021-02-13T09:53:24Z",
      "updated_at": "2021-02-13T09:53:24Z"
    },
    {
      "author": "iRon7",
      "author_association": "NONE",
      "body": "> The question is if PowerShell should or should not have the same behaviour here.\r\n\r\nSince Windows PowerShell, PowerShell Core has undergone quiet some changes along with the NewtonSoft JSON engine (see e.g.: [PowerShell 7 Changes to JSON Cmdlets](https://powershell.anovelidea.org/powershell/ps7now-changes-to-json-cmdlets/), this shows in minor discrepancies along with the error descriptions.",
      "created_at": "2021-02-13T12:37:37Z",
      "updated_at": "2021-02-13T12:37:37Z"
    },
    {
      "author": "KUTlime",
      "author_association": "NONE",
      "body": "Oh, I see... Make sense. \n\nThe only thing which is a mystery to me is why PowerShell does not protest about the configuration JSON file until the JSON reaches some particular level (size). ",
      "created_at": "2021-02-13T13:46:12Z",
      "updated_at": "2021-02-13T13:46:12Z"
    },
    {
      "author": "iRon7",
      "author_association": "NONE",
      "body": "I need to correct my initial answer a bit as you (obviously) will need to expand the environment variables prior the `ConvertTo-Json` Conversion (it appears to work because the `$Configuration` holds nothing more then a Json `String`):\r\n\r\n```PowerShell\r\n$configuration = Get-Content .\\configuration.json\r\n$configuration = [System.Environment]::ExpandEnvironmentVariables($configuration) | ConvertFrom-Json\r\n$block = {param([pscustomobject]$inputArgument) $PSVersionTable; Write-Host 'Test ' $inputArgument.AxisUser.Name}\r\npowershell -nologo -noprofile $block -Args $configuration\r\n```\r\n\r\nBut as you will see this will fail at the second statement, with:\r\n\r\n> `ConvertFrom-Json: Conversion from JSON failed with error:`\r\n> `Bad JSON escape sequence: \\U. Path 'SourceCodeLocalPath', line 1, position 92.`\r\n\r\nAnd this is because `%USERPROFILE%` expands to something like <strike>`C:\\Users\\Username`</strike> which is not a valid Json value as the backslashes (escapes characters) should be escaped themselves, thus: `C:\\\\Users\\\\Username`",
      "created_at": "2021-02-13T18:17:03Z",
      "updated_at": "2021-02-15T14:46:30Z"
    },
    {
      "author": "iRon7",
      "author_association": "NONE",
      "body": "Besides, why using the [`pwsh`](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_pwsh) command-line interface which requires to pass arguments (`-args`) in a cumbersome **`<arg-array>`** (knowing that `ConvertFrom-Json` converts your Json string to a complex object).\r\nIt would be much easier to just use a cmdlet like [`Invoke-Command`](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/invoke-command) which accepts objects:\r\n\r\n```PowerShell\r\n$configuration = Get-Content .\\configuration.json | ConvertFrom-Json\r\n$block = {$PSVersionTable; Write-Host 'Test' $Input.ProductNameUser.Name}\r\n# powershell -nologo -noprofile $block -Args $configuration\r\nInvoke-Command $Block -InputObject $configuration\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.1\r\nPSEdition                      Core\r\nGitCommitId                    7.1.1\r\nOS                             Microsoft Windows 10.0.19042\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\nTest String from json\r\n```",
      "created_at": "2021-02-15T09:18:11Z",
      "updated_at": "2021-02-15T14:47:09Z"
    },
    {
      "author": "KUTlime",
      "author_association": "NONE",
      "body": "I have to redirect to Windows PowerShell. `Invoke-Command` doesn't support this.\r\n\r\nIn addition, even after I expand the environmental variables in the JSON string, the problem with redirection to Windows PowerShell remains.",
      "created_at": "2021-02-15T14:40:43Z",
      "updated_at": "2021-02-15T14:40:43Z"
    },
    {
      "author": "KUTlime",
      "author_association": "NONE",
      "body": "It looks like this problem has nothing to do with the environmental variables in the JSON. I just used a JSON with no environmental variables with the same results.\r\n\r\n```log\r\nResourceUnavailable: Program 'powershell.exe' failed to run: The Process object must have the UseShellExecute property set to false in order to use environment variables.At line:1 char:1\r\n+ powershell -nologo -noprofile $block -args $configuration\r\n```",
      "created_at": "2021-02-16T08:33:54Z",
      "updated_at": "2021-02-16T08:33:54Z"
    },
    {
      "author": "iRon7",
      "author_association": "NONE",
      "body": "Agree, I guess it has something to do with the STDOUT/STDIN buffer size and leave it to the PowerShell guys to answer...\r\n\r\nA [Minimal, Reproducible Example](https://stackoverflow.com/help/minimal-reproducible-example) of this issue would be:\r\n```PowerShell\r\npowershell {''} -Args ('x' * 100000)\r\n```\r\n\r\nResults in an error:\r\n> `ResourceUnavailable: Program 'powershell.exe' failed to run: The Process object must have the UseShellExecute property set to false in order to use environment variables.At line:1 char:1`\r\n\r\n(Where the error doesn't appear with smaller strings, e.g.: `powershell {''} -Args ('x' * 10000)`\r\n\r\n\r\n",
      "created_at": "2021-02-16T08:59:39Z",
      "updated_at": "2021-03-11T17:51:33Z"
    }
  ],
  "created_at": "2021-02-12T14:41:58Z",
  "labels": [
    "WG-Interactive-Console",
    "Needs-Triage"
  ],
  "number": 14775,
  "state": "open",
  "title": "STDOUT/STDIN buffer size error when passing arguments into Windows PowerShell",
  "updated_at": "2021-03-11T17:51:33Z"
}