{
  "_url": "https://github.com/PowerShell/PowerShell/issues/7987",
  "author": "SteveL-MSFT",
  "body": "## PR Summary\r\n\r\nCurrently, if a format.ps1xml file has attributes on the `<Configuration>` node, it is a terminating error.  We should allow for loose validation so that common attributes from other tooling is simply ignored if not understood.  @PowerShell/powershell-committee had discussed this and agreed with making this change.  Fix is to use a different method to find the root node that allows for attributes.\r\n\r\nTypes.ps1xml doesn't have this strict validation so no change was needed, but added tests for both format and types ps1xml.\r\n\r\nThere was a separate issue causing tests to fail.  A separate test used an invalid ps1xml file with update-formatdata.  Expectation is that an invalid file wouldn't be bound to the runspace so it didn't need to run in a separate runspace.  However, the runspace initialsessionstate kept this file in its list so subsequent attempts to update-formatdata (like importing a module that contains ps1xml) will again attempt to update with the invalid ps1xml file and result in a confusing error.  Fix is to revert initialsession state to previous list of format files if there is a failure updating the formats.  Renamed some of the test ps1xml files to be unique to determine which was causing the failure.\r\n\r\nAlso removed `Pending` from a test that passes.\r\n\r\nAddress one aspect of #7749\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` to the beginning of the title and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] User-facing [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed - Issue link:\r\n- **Testing - New and feature**\r\n    - [ ] Not Applicable or can only be tested interactively\r\n    - **OR**\r\n    - [x] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [ ] [Add `[feature]` if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n",
  "closed_at": "2018-10-12T18:31:21Z",
  "comments": [
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Figured out cause of test failure, but not sure why yet.  A different test is updating formatdata with invalid ps1xml.  Somehow, this causes importing of some (but not all) modules to fail complaining about the invalid ps1xml file.  Can repro it manually with 6.1.0 without my change so my change is unrelated, but looks like a real bug.  Investigating further.",
      "created_at": "2018-10-11T02:29:17Z",
      "updated_at": "2018-10-11T02:29:17Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "It appears the problem is that the invalid format ps1xml still gets into the formattable of the session so when importing a module that has a format.ps1xml it fails to update due to the previously bad format.ps1xml file still being cached.",
      "created_at": "2018-10-11T03:02:35Z",
      "updated_at": "2018-10-11T03:02:35Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@anmenaga can you re-review?  Had to make additional fixes due to CI test failures",
      "created_at": "2018-10-11T05:11:36Z",
      "updated_at": "2018-10-11T05:11:36Z"
    },
    {
      "author": "anmenaga",
      "author_association": "CONTRIBUTOR",
      "body": "Looks good to me.\r\nOn a side note, looks like DNS resolution fix is unrelated to this PR topic and probably should have gone into a separate PR to expedite merging it.",
      "created_at": "2018-10-11T20:06:42Z",
      "updated_at": "2018-10-11T20:09:00Z"
    },
    {
      "author": "anmenaga",
      "author_association": "CONTRIBUTOR",
      "body": "@adityapatwardhan this contains fix for CI failures. Please give this PR a priority.",
      "created_at": "2018-10-11T20:07:25Z",
      "updated_at": "2018-10-11T20:07:25Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "I'll submit the test-connection test fix as separate PR since it's affecting other PRs",
      "created_at": "2018-10-11T22:11:58Z",
      "updated_at": "2018-10-11T22:11:58Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@SteveL-MSFT now that the test CI fix is merge, please remove the fix in this PR.",
      "created_at": "2018-10-11T23:57:11Z",
      "updated_at": "2018-10-11T23:57:11Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@adityapatwardhan can you update your review?",
      "created_at": "2018-10-12T17:59:23Z",
      "updated_at": "2018-10-12T17:59:23Z"
    }
  ],
  "created_at": "2018-10-10T20:54:06Z",
  "number": 7987,
  "state": "closed",
  "title": "Allow root node of format.ps1xml to have attributes that are ignored",
  "updated_at": "2020-03-10T21:01:19Z"
}