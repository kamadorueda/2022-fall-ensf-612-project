{
  "_url": "https://github.com/PowerShell/PowerShell/issues/4961",
  "author": "tannergooding",
  "body": "### Repro\r\nTake the following simple C# program:\r\n```C#\r\nusing System;\r\n\r\nclass Program\r\n{\r\n    static void Main(string[] args)\r\n    {\r\n        Console.Write('\\n');\r\n        Console.Out.Write('\\n');\r\n        Console.OpenStandardOutput().WriteByte((byte)('\\n'));\r\n    }\r\n}\r\n```\r\n\r\nCompile it and execute the program under Powershell, redirecting the output to a file:\r\n\r\n### Expected Behavior\r\nOne would expect that if you redirected this to a file, it would contain:\r\n```\r\n\\n\r\n\\n\r\n\\n\r\n```\r\n\r\nI expect, that if I tell my program to output '\\n' and then redirect that to a file, it is written exactly as '\\n'.\r\n\r\nI expect, that if I tell my program to write raw bytes to the console, and then redirect that to a file, it is written exactly as given.\r\n\r\nI expect in both of these cases, if I do not redirect, that the output is written to the console exactly as given.\r\n\r\n### Actual Behavior\r\nHowever, Powershell force converts all bytes equaling '\\n' to '\\r\\n', so instead you get:\r\n```\r\n\\r\\n\r\n\\r\\n\r\n\\r\\n\r\n```\r\n\r\nAdditionally, it will further translate other bytes written to it into the encoding it \"assumes\" (Unicode by default for `> Out.txt` and the specific encoding for `| Out-File Out.txt -encoding`). This can cause egregious errors for output that **should** be written to the file exactly as given, unless otherwise specified.\r\n",
  "closed_at": "2017-09-30T19:56:44Z",
  "comments": [
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "This behavior is highly dependent on the method which which you are creating the file. Can you provide both the `$PSVersionTable` output and some PowerShell code to reproduce the issue? In some cases, this behavior is \"by design\"  in others there are known issues (or ongoing debates), or this could be completely new. One cannot tell which is the case without relevant PowerShell code.",
      "created_at": "2017-09-30T10:28:49Z",
      "updated_at": "2017-09-30T10:29:29Z"
    },
    {
      "author": "tannergooding",
      "author_association": "NONE",
      "body": "Open `cmd.exe` and do the following:\r\n```\r\nD:\\>mkdir repro\r\n\r\nD:\\>cd repro\r\n\r\nD:\\repro>dotnet new console\r\nThe template \"Console Application\" was created successfully.\r\n\r\nProcessing post-creation actions...\r\nRunning 'dotnet restore' on D:\\repro\\repro.csproj...\r\n  Restoring packages for D:\\repro\\repro.csproj...\r\n  Generating MSBuild file D:\\repro\\obj\\repro.csproj.nuget.g.props.\r\n  Generating MSBuild file D:\\repro\\obj\\repro.csproj.nuget.g.targets.\r\n  Restore completed in 219.23 ms for D:\\repro\\repro.csproj.\r\n\r\n\r\nRestore succeeded.\r\n\r\n\r\nD:\\repro>notepad Program.cs\r\n\r\nD:\\repro>\r\n```\r\n\r\nSet the contents of Program.cs to:\r\n```\r\nusing System;\r\n\r\nclass Program\r\n{\r\n    static void Main(string[] args)\r\n    {\r\n        Console.Write('P');\r\n        Console.Write('4');\r\n        Console.Write('\\n');\r\n        Console.Write('2');\r\n        Console.Write('0');\r\n        Console.Write('0');\r\n        Console.Write(' ');\r\n        Console.Write('2');\r\n        Console.Write('0');\r\n        Console.Write('0');\r\n        Console.Write('\\n');\r\n\r\n        Console.Out.Write('P');\r\n        Console.Out.Write('4');\r\n        Console.Out.Write('\\n');\r\n        Console.Out.Write('2');\r\n        Console.Out.Write('0');\r\n        Console.Out.Write('0');\r\n        Console.Out.Write(' ');\r\n        Console.Out.Write('2');\r\n        Console.Out.Write('0');\r\n        Console.Out.Write('0');\r\n        Console.Out.Write('\\n');\r\n\r\n        Console.OpenStandardOutput().WriteByte((byte)('P'));\r\n        Console.OpenStandardOutput().WriteByte((byte)('4'));\r\n        Console.OpenStandardOutput().WriteByte((byte)('\\n'));\r\n        Console.OpenStandardOutput().WriteByte((byte)('2'));\r\n        Console.OpenStandardOutput().WriteByte((byte)('0'));\r\n        Console.OpenStandardOutput().WriteByte((byte)('0'));\r\n        Console.OpenStandardOutput().WriteByte((byte)(' '));\r\n        Console.OpenStandardOutput().WriteByte((byte)('2'));\r\n        Console.OpenStandardOutput().WriteByte((byte)('0'));\r\n        Console.OpenStandardOutput().WriteByte((byte)('0'));\r\n        Console.OpenStandardOutput().WriteByte((byte)('\\n'));\r\n    }\r\n}\r\n```\r\n\r\nNext, continue on the command line with:\r\n```\r\nD:\\repro\r\nD:\\repro>dotnet run > CMD.txt\r\n\r\nD:\\repro>D:\\PowerShell-6.0.0-beta.7-win-x64\\powershell.exe\r\nPowerShell v6.0.0-beta.7\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nPS D:\\repro> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.0.0-beta\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.0-beta.7\r\nOS                             Microsoft Windows 10.0.16299\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\n\r\nPS D:\\repro> dotnet run > PS-1.txt\r\nPS D:\\repro> C:\\Windows\\System32\\fc.exe /B .\\CMD.txt .\\PS-1.txt\r\nComparing files .\\CMD.txt and .\\PS-1.TXT\r\n00000000: 50 FF\r\n00000001: 34 FE\r\n00000002: 0A 50\r\n00000003: 32 00\r\n00000004: 30 34\r\n00000005: 30 00\r\n00000006: 20 0D\r\n00000007: 32 00\r\n00000008: 30 0A\r\n00000009: 30 00\r\n0000000A: 0A 32\r\n0000000B: 50 00\r\n0000000C: 34 30\r\n0000000D: 0A 00\r\n0000000E: 32 30\r\n0000000F: 30 00\r\n00000010: 30 20\r\n00000011: 20 00\r\n00000013: 30 00\r\n00000015: 0A 00\r\n00000016: 50 30\r\n00000017: 34 00\r\n00000018: 0A 0D\r\n00000019: 32 00\r\n0000001A: 30 0A\r\n0000001B: 30 00\r\n0000001C: 20 50\r\n0000001D: 32 00\r\n0000001E: 30 34\r\n0000001F: 30 00\r\n00000020: 0A 0D\r\nFC: .\\PS-1.TXT longer than .\\CMD.txt\r\n\r\n\r\nPS D:\\repro> dotnet run | Out-File -filePath PS-2.txt\r\nPS D:\\repro> C:\\Windows\\System32\\fc.exe /B .\\CMD.txt .\\PS-2.txt\r\nComparing files .\\CMD.txt and .\\PS-2.TXT\r\n00000000: 50 FF\r\n00000001: 34 FE\r\n00000002: 0A 50\r\n00000003: 32 00\r\n00000004: 30 34\r\n00000005: 30 00\r\n00000006: 20 0D\r\n00000007: 32 00\r\n00000008: 30 0A\r\n00000009: 30 00\r\n0000000A: 0A 32\r\n0000000B: 50 00\r\n0000000C: 34 30\r\n0000000D: 0A 00\r\n0000000E: 32 30\r\n0000000F: 30 00\r\n00000010: 30 20\r\n00000011: 20 00\r\n00000013: 30 00\r\n00000015: 0A 00\r\n00000016: 50 30\r\n00000017: 34 00\r\n00000018: 0A 0D\r\n00000019: 32 00\r\n0000001A: 30 0A\r\n0000001B: 30 00\r\n0000001C: 20 50\r\n0000001D: 32 00\r\n0000001E: 30 34\r\n0000001F: 30 00\r\n00000020: 0A 0D\r\nFC: .\\PS-2.TXT longer than .\\CMD.txt\r\n\r\nPS D:\\repro>\r\n```\r\n\r\nYou can repeat for `dotnet run | Out-File -filePath <fileName> -encoding {encoding}` and see similar results. Below is the hex dump for each:\r\n```\r\nCMD.txt\r\n    50 34 0A\r\n    32 30 30 20 32 30 30 0A\r\n    50 34 0A\r\n    32 30 30 20 32 30 30 0A\r\n    50 34 0A\r\n    32 30 30 20 32 30 30 0A\r\nPS-1.txt, PS-2.txt, PS-Unknown.txt, PS-String.txt, PS-Unicode.txt\r\n    FF FE\r\n    50 00 34 00 0D 00 0A 00\r\n    32 00 30 00 30 00 20 00 32 00 30 00 30 00 0D 00 0A 00\r\n    50 00 34 00 0D 00 0A 00\r\n    32 00 30 00 30 00 20 00 32 00 30 00 30 00 0D 00 0A 00\r\n    50 00 34 00 0D 00 0A 00\r\n    32 00 30 00 30 00 20 00 32 00 30 00 30 00 0D 00 0A 00\r\nPS-BigEndianUnicode.txt\r\n    FE FF\r\n    00 50 00 34 00 0D 00 0A\r\n    00 32 00 30 00 30 00 20 00 32 00 30 00 30 00 0D 00 0A\r\n    00 50 00 34 00 0D 00 0A\r\n    00 32 00 30 00 30 00 20 00 32 00 30 00 30 00 0D 00 0A\r\n    00 50 00 34 00 0D 00 0A\r\n    00 32 00 30 00 30 00 20 00 32 00 30 00 30 00 0D 00 0A\r\nPS-UTF8.txt\r\n    EF BB BF\r\n    50 34 0D 0A\r\n    32 30 30 20 32 30 30 0D 0A\r\n    50 34 0D 0A\r\n    32 30 30 20 32 30 30 0D 0A\r\n    50 34 0D 0A 32 30 30 20 32 30 30 0D 0A\r\nPS-UTF7.txt\r\n    50 34 0D 0A\r\n    32 30 30 20 32 30 30 0D 0A\r\n    50 34 0D 0A\r\n    32 30 30 20 32 30 30 0D 0A\r\n    50 34 0D 0A\r\n    32 30 30 20 32 30 30 0D 0A\r\nPS-UTF32.txt (UTF32)\r\n    FF FE 00 00\r\n    50 00 00 00 34 00 00 00 0D 00 00 00 0A 00 00 00\r\n    32 00 00 00 30 00 00 00 30 00 00 00 20 00 00 00 32 00 00 00 30 00 00 00 30 00 00 00 0D 00 00 00 0A 00 00 00\r\n    50 00 00 00 34 00 00 00 0D 00 00 00 0A 00 00 00\r\n    32 00 00 00 30 00 00 00 30 00 00 00 20 00 00 00 32 00 00 00 30 00 00 00 30 00 00 00 0D 00 00 00 0A 00 00 00\r\n    50 00 00 00 34 00 00 00 0D 00 00 00 0A 00 00 00\r\n    32 00 00 00 30 00 00 00 30 00 00 00 20 00 00 00 32 00 00 00 30 00 00 00 30 00 00 00 0D 00 00 00 0A 00 00 00\r\nPS-ASCII.txt, PS-Default.txt, PS-OEM.txt\r\n    50 34 0D 0A\r\n    32 30 30 20 32 30 30 0D 0A\r\n    50 34 0D 0A\r\n    32 30 30 20 32 30 30 0D 0A\r\n    50 34 0D 0A\r\n    32 30 30 20 32 30 30 0D 0A\r\n```\r\n\r\nFrom this, I can see the following problems:\r\n* None of the encodings give the exact output desired (due to forced translation of '\\n' to '\\r\\n')\r\n  * This means there is no \"workaround\" (I would expect, at the very least, there to be a `-encoding Byte` option, as some other commands have)\r\n* UTF-8 enforces addition of the BOM (may be undesirable in some scenarios)\r\n* When no encoding is specified, it transforms the bytes to be Unicode\r\n  * This means my output is \"broken\" and \"twice as big\", by default\r\n* The default is not `-encoding Default`, it is `-encoding Unicode`\r\n",
      "created_at": "2017-09-30T15:46:41Z",
      "updated_at": "2017-09-30T15:46:41Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@tannergooding thanks for the thorough investigation.  The encoding issue should be addressed by https://github.com/PowerShell/PowerShell/issues/4878, the EOL issue is probably https://github.com/PowerShell/PowerShell/issues/2145",
      "created_at": "2017-09-30T16:05:57Z",
      "updated_at": "2017-09-30T16:05:57Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I believe it is dup with great repo.",
      "created_at": "2017-09-30T19:19:08Z",
      "updated_at": "2017-09-30T19:19:08Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Agree that the other two issues have this covered, @tannergooding let me know if you don't agree.",
      "created_at": "2017-09-30T19:56:44Z",
      "updated_at": "2017-09-30T19:56:44Z"
    }
  ],
  "created_at": "2017-09-30T05:27:37Z",
  "number": 4961,
  "state": "closed",
  "title": "Powershell translates all output bytes that equal '\\n' to '\\r\\n'",
  "updated_at": "2017-09-30T19:56:44Z"
}