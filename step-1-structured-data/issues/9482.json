{
  "_url": "https://github.com/PowerShell/PowerShell/issues/9482",
  "author": "lwajswaj",
  "body": "<!--\r\n\r\nFor Windows PowerShell 5.1 issues, suggestions, or feature requests please use the following link instead:\r\nWindows PowerShell [UserVoice](https://windowsserver.uservoice.com/forums/301869-powershell)\r\n\r\nThis repository is **ONLY** for PowerShell Core 6 issues.\r\n\r\n- Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- Search the existing issues.\r\n- Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- Refer to the [known issues](https://docs.microsoft.com/powershell/scripting/whats-new/known-issues-ps6?view=powershell-6).\r\n\r\n-->\r\n\r\n# Steps to reproduce\r\nIn an elevated powershell core window, choose a module from system path (not user path) and issue Update-Module for it:\r\n\r\n```powershell\r\nPS C:\\Users\\Leandro> $env:PSModulePath\r\nC:\\Users\\Leandro\\Documents\\PowerShell\\Modules;C:\\Program Files\\PowerShell\\Modules;c:\\program files\\windowspowershellcore\\Modules;C:\\WINDOWS\\system32\\WindowsPowerShell\\v1.0\\Modules\r\nPS C:\\Users\\Leandro> Gci \"C:\\Program Files\\PowerShell\\Modules\\Az.Automation\"\r\n\r\n\r\n    Directory: C:\\Program Files\\PowerShell\\Modules\\Az.Automation\r\n\r\nMode                LastWriteTime         Length Name\r\n----                -------------         ------ ----\r\nd-----        17/02/2019    21:25                1.1.0\r\nd-----        08/03/2019    22:55                1.1.1\r\nd-----        06/04/2019    11:24                1.2.0\r\n\r\nPS C:\\Users\\Leandro> update-module AZ.Automation -verbose\r\nVERBOSE: Checking for updates for module 'Az.Automation'.\r\nVERBOSE: Repository details, Name = 'PSGallery', Location = 'https://www.powershellgallery.com/api/v2/'; IsTrusted = 'True'; IsRegistered = 'True'.\r\nVERBOSE: Using the provider 'PowerShellGet' for searching packages.\r\nVERBOSE: Using the specified source names : 'PSGallery'.\r\nVERBOSE: Getting the provider object for the PackageManagement Provider 'NuGet'.VERBOSE: The specified Location is 'https://www.powershellgallery.com/api/v2/' and PackageManagementProvider is 'NuGet'.\r\nVERBOSE: Searching repository 'https://www.powershellgallery.com/api/v2/FindPackagesById()?id='Az.Automation'' for ''.\r\nVERBOSE: Total package yield:'1' for the specified package 'Az.Automation'.\r\nVERBOSE: Performing the operation \"Update-Module\" on target \"Version '1.2.0' of\r\nmodule 'Az.Automation', updating to version '1.2.1'\".\r\nVERBOSE: The installation scope is specified to be 'CurrentUser'.\r\nVERBOSE: The specified module will be installed in 'C:\\Users\\Leandro\\Documents\\PowerShell\\Modules'.\r\nVERBOSE: An update for the module 'Az.Automation' was found with version '1.2.1'.\r\nVERBOSE: The specified Location is 'NuGet' and PackageManagementProvider is 'NuGet'.\r\nVERBOSE: Downloading module 'Az.Automation' with version '1.2.1' from the repository 'https://www.powershellgallery.com/api/v2/'.\r\nVERBOSE: Searching repository 'https://www.powershellgallery.com/api/v2/FindPackagesById()?id='Az.Automation'' for ''.\r\nVERBOSE: Package 'Az.Accounts' is already installed.\r\nVERBOSE: Package 'Az.Accounts' is already installed.\r\nVERBOSE: InstallPackage' - name='Az.Automation', version='1.2.1',destination='C:\\Users\\Leandro\\AppData\\Local\\Temp\\1176232375'\r\nVERBOSE: DownloadPackage' - name='Az.Automation', version='1.2.1',destination='C:\\Users\\Leandro\\AppData\\Local\\Temp\\1176232375\\Az.Automation.1.2.1\\Az.Automation.1.2.1.nupkg', uri='https://www.powershellgallery.com/api/v2/package/Az.Automation/1.2.1'\r\nVERBOSE: Downloading 'https://www.powershellgallery.com/api/v2/package/Az.Automation/1.2.1'.\r\nVERBOSE: Completed downloading 'https://www.powershellgallery.com/api/v2/package/Az.Automation/1.2.1'.\r\nVERBOSE: Completed downloading 'Az.Automation'.\r\nVERBOSE: InstallPackageLocal' - name='Az.Automation', version='1.2.1',destination='C:\\Users\\Leandro\\AppData\\Local\\Temp\\1176232375'\r\nVERBOSE: Validating the 'Az.Automation' module contents under 'C:\\Users\\Leandro\\AppData\\Local\\Temp\\1176232375\\Az.Automation.1.2.1' path.\r\nVERBOSE: Test-ModuleManifest successfully validated the module manifest file 'C:\\Users\\Leandro\\AppData\\Local\\Temp\\1176232375\\Az.Automation.1.2.1'.\r\nVERBOSE: Validating the authenticode signature and publisher of the catalog file or module manifest file of the module 'Az.Automation'.\r\nVERBOSE: Catalog file 'Az.Automation.cat' is not found in the contents of the module 'Az.Automation' being installed.\r\nVERBOSE: For publisher validation, current module 'Az.Automation' with version '1.2.1' with publisher name '' from root certificate authority ''. Is this module signed by Microsoft: 'False'.\r\nVERBOSE: For publisher validation, using the previously-installed module 'Az.Automation' with version '1.2.0' under 'C:\\Program Files\\PowerShell\\Modules\\Az.Automation\\1.2.0' with publisher name '' from root certificate authority ''. Is this module signed by Microsoft: 'False'.\r\nVERBOSE: Checking for possible command collisions for the module 'Az.Automation' commands.\r\nVERBOSE: Module 'Az.Automation' was installed successfully to path 'C:\\Users\\Leandro\\Documents\\PowerShell\\Modules\\Az.Automation\\1.2.1'.\r\nPS C:\\Users\\Leandro> Gci \"C:\\Program Files\\PowerShell\\Modules\\Az.Automation\"\r\n\r\n\r\n    Directory: C:\\Program Files\\PowerShell\\Modules\\Az.Automation\r\n\r\nMode                LastWriteTime         Length Name\r\n----                -------------         ------ ----\r\nd-----        17/02/2019    21:25                1.1.0\r\nd-----        08/03/2019    22:55                1.1.1\r\nd-----        06/04/2019    11:24                1.2.0\r\n\r\nPS C:\\Users\\Leandro> gci \"C:\\Users\\Leandro\\Documents\\PowerShell\\Modules\\Az.Automation\"\r\n\r\n\r\n    Directory: C:\\Users\\Leandro\\Documents\\PowerShell\\Modules\\Az.Automation\r\n\r\nMode                LastWriteTime         Length Name\r\n----                -------------         ------ ----\r\nd-----        26/04/2019    22:30                1.2.1\r\n\r\nPS C:\\Users\\Leandro>\r\n```\r\n\r\n# Expected behavior\r\n\r\n```none\r\nModule should be placed in the system path (in my example \"C:\\Program Files\\PowerShell\\Modules\\Az.Automation\")\r\n```\r\n\r\n# Actual behavior\r\n\r\n```none\r\nModule was placed in the user path (in my example \"C:\\Users\\Leandro\\Documents\\PowerShell\\Modules\\Az.Automation\"\r\n```\r\n\r\n# Environment data\r\n\r\n<!-- provide the output of $PSVersionTable -->\r\n\r\n```none\r\nPS C:\\Users\\Leandro> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.2.0\r\nPSEdition                      Core\r\nGitCommitId                    6.2.0\r\nOS                             Microsoft Windows 10.0.17763\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n",
  "closed_at": "2019-09-29T16:16:50Z",
  "comments": [
    {
      "author": "lwajswaj",
      "author_association": "NONE",
      "body": "These modules were installed using -Scope AllUsers.\r\n\r\nUpdate-Module doesn't expose an -Scope parameter:\r\n\r\n```powershell\r\nPS C:\\Users\\Leandro> Get-Help Update-Module\r\n\r\nNAME\r\n    Update-Module\r\n\r\nSYNTAX\r\n    Update-Module [[-Name] <string[]>] [-RequiredVersion <string>]\r\n    [-MaximumVersion <string>] [-Credential <pscredential>] [-Proxy <uri>]\r\n    [-ProxyCredential <pscredential>] [-Force] [-AllowPrerelease]\r\n    [-AcceptLicense] [-WhatIf] [-Confirm] [<CommonParameters>]\r\n\r\n\r\nALIASES\r\n    upmo\r\n\r\n\r\nREMARKS\r\n    Get-Help cannot find the Help files for this cmdlet on this computer. It\r\n    is displaying only partial help.\r\n        -- To download and install Help files for the module that includes\r\n    this cmdlet, use Update-Help.\r\n        -- To view the Help topic for this cmdlet online, type: \"Get-Help\r\n    Update-Module -Online\" or\r\n           go to https://go.microsoft.com/fwlink/?LinkID=398576.\r\n```",
      "created_at": "2019-04-27T11:54:40Z",
      "updated_at": "2019-04-27T11:54:40Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@chuanjiao it seems the goal here is to have update-module correctly work for modules in the system path. It doesn't look like @lwajswaj wants the module to be in the user-specific path.",
      "created_at": "2019-04-27T14:22:39Z",
      "updated_at": "2019-04-27T14:22:39Z"
    },
    {
      "author": "lwajswaj",
      "author_association": "NONE",
      "body": "Yes, exactly. I'm expecting modules to be updated in the system path\n\nEl s\u00e1b., 27 abr. 2019 11:23, vexx32 <notifications@github.com> escribi\u00f3:\n\n> @chuanjiao <https://github.com/chuanjiao> it seems the goal here is to\n> have update-module correctly work for modules in the system path. It\n> doesn't look like @lwajswaj <https://github.com/lwajswaj> wants the\n> module to be in the user-specific path.\n>\n> \u2014\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/PowerShell/PowerShell/issues/9482#issuecomment-487290095>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/ABREDHHIZMZ3O2FGLGLGBO3PSROVLANCNFSM4HI3FNTQ>\n> .\n>\n",
      "created_at": "2019-04-27T15:03:22Z",
      "updated_at": "2019-04-27T15:03:22Z"
    },
    {
      "author": "fMichaleczek",
      "author_association": "NONE",
      "body": "@lwajswaj You should move your issue to PowerShellGet repository instead.\r\n\r\nThe behavior is located here  :  [Get-InstallationScope.ps1#L2](https://github.com/PowerShell/PowerShellGet/blob/6926ad42e61fc54c5f5b1cdc9e9d8dfceccc2c80/src/PowerShellGet/private/functions/Get-InstallationScope.ps1#L2)\r\n\r\n> Determine scope. We prefer CurrentUser scope even if the older module is installed for AllUsers, unless:\r\n> old module is installed for all users, we are elevated, AND using Windows PowerShell\r\n> This is to mirror newer behavior of Install-Module.\r\n\r\n",
      "created_at": "2019-04-28T23:26:33Z",
      "updated_at": "2019-04-28T23:26:33Z"
    },
    {
      "author": "lwajswaj",
      "author_association": "NONE",
      "body": "OK, the issue with this preference is it doesn't play well when module is required at system level such as modules needed to be executed by SYSTEM or a Service Account (like the case of an Azure DevOps hosted agent).",
      "created_at": "2019-04-28T23:31:11Z",
      "updated_at": "2019-04-28T23:31:11Z"
    }
  ],
  "created_at": "2019-04-27T01:33:05Z",
  "number": 9482,
  "state": "closed",
  "title": "Update-Module places modules in user path (even when running as Administrator)",
  "updated_at": "2019-09-29T16:16:50Z"
}