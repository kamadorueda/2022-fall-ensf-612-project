{
  "_url": "https://github.com/PowerShell/PowerShell/issues/9622",
  "author": "vexx32",
  "body": "<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\nAdds `[ValidateProperty()]` attribute for duck-typing parameters, allowing function and cmdlet authors to accept arbitrary PSObject input provided the object(s) provides at least the specified named properties.\r\n\r\n## PR Context\r\n\r\nResolves #7835. See issue for context.\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [ ] Not Applicable\r\n    - **OR**\r\n    - [x] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n- **Testing - New and feature**\r\n    - [ ] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [x] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n",
  "closed_at": "2019-10-25T12:00:33Z",
  "comments": [
    {
      "author": "PoshChan",
      "author_association": "COLLABORATOR",
      "body": "@vexx32, your last commit had 3 failures in `PowerShell-CI-windows`\r\nType accelerators.BuiltIn Accelerators.Error occurred in Context block\r\n```powershell\r\nUnable to find type [System.Management.Automation.ValidateProperty].\r\nAt D:\\a\\1\\s\\test\\powershell\\Language\\Parser\\TypeAccelerator.Tests.ps1:303 char:35\r\n```\r\nTests for parameter binding.Default value conversion tests.ValidateScript can use custom ErrorMessage\r\n```powershell\r\nExpected strings to be the same, but they were different.\r\nExpected length: 80\r\nActual length:   82\r\nStrings differ at index 60.\r\nExpected: '...led '$_ -g...'\r\nBut was:  '...led ' $_ -...'\r\nat <ScriptBlock>, D:\\a\\1\\s\\test\\powershell\\Language\\Scripting\\ParameterBinding.Tests.ps1: line 391\r\n391:             $err.Exception.Message | Should -BeExactly \"Cannot validate argument on parameter 'p'. Item '2' failed '`$_ -gt 2' validation\"\r\n```\r\nTests for parameter binding.Default value conversion tests.ValidateProperty can use custom ErrorMessage\r\n```powershell\r\nExpected strings to be the same, but they were different.\r\nExpected length: 79\r\nActual length:   111\r\nStrings differ at index 60.\r\nExpected: '...led 'a,b' ...'\r\nBut was:  '...led '[Syst...'\r\nat <ScriptBlock>, D:\\a\\1\\s\\test\\powershell\\Language\\Scripting\\ParameterBinding.Tests.ps1: line 413\r\n413:             $err.Exception.Message | Should -BeExactly \"Cannot validate argument on parameter 'p'. Item '2' failed 'a,b' property check\"\r\n```\r\n",
      "created_at": "2019-05-17T04:38:09Z",
      "updated_at": "2019-05-17T04:38:09Z"
    },
    {
      "author": "PoshChan",
      "author_association": "COLLABORATOR",
      "body": "@vexx32, your last commit had 2 failures in `PowerShell-CI-macos`\r\nType accelerators.BuiltIn Accelerators.Should have all the type accelerators\r\n```powershell\r\nExpected 99, but got 100.\r\nat <ScriptBlock>, /Users/vsts/agent/2.150.3/work/1/s/test/powershell/Language/Parser/TypeAccelerator.Tests.ps1: line 445\r\n445:             $TypeAccelerators.Count | Should -Be $totalAccelerators\r\n```\r\nTests for parameter binding.Default value conversion tests.ValidateScript can use custom ErrorMessage\r\n```powershell\r\nExpected strings to be the same, but they were different.\r\nExpected length: 80\r\nActual length:   82\r\nStrings differ at index 60.\r\nExpected: '...led '$_ -g...'\r\nBut was:  '...led ' $_ -...'\r\nat <ScriptBlock>, /Users/vsts/agent/2.150.3/work/1/s/test/powershell/Language/Scripting/ParameterBinding.Tests.ps1: line 391\r\n391:             $err.Exception.Message | Should -BeExactly \"Cannot validate argument on parameter 'p'. Item '2' failed '`$_ -gt 2' validation\"\r\n```\r\n",
      "created_at": "2019-05-17T05:01:13Z",
      "updated_at": "2019-05-17T05:01:13Z"
    },
    {
      "author": "PoshChan",
      "author_association": "COLLABORATOR",
      "body": "@vexx32, your last commit had 2 failures in `PowerShell-CI-windows`\r\nType accelerators.BuiltIn Accelerators.Should have all the type accelerators\r\n```powershell\r\nExpected 104, but got 105.\r\nat <ScriptBlock>, D:\\a\\1\\s\\test\\powershell\\Language\\Parser\\TypeAccelerator.Tests.ps1: line 445\r\n445:             $TypeAccelerators.Count | Should -Be $totalAccelerators\r\n```\r\nTests for parameter binding.Default value conversion tests.ValidateScript can use custom ErrorMessage\r\n```powershell\r\nExpected strings to be the same, but they were different.\r\nExpected length: 80\r\nActual length:   82\r\nStrings differ at index 60.\r\nExpected: '...led '$_ -g...'\r\nBut was:  '...led ' $_ -...'\r\nat <ScriptBlock>, D:\\a\\1\\s\\test\\powershell\\Language\\Scripting\\ParameterBinding.Tests.ps1: line 391\r\n391:             $err.Exception.Message | Should -BeExactly \"Cannot validate argument on parameter 'p'. Item '2' failed '`$_ -gt 2' validation\"\r\n```\r\n",
      "created_at": "2019-05-17T05:01:58Z",
      "updated_at": "2019-05-17T05:01:58Z"
    },
    {
      "author": "PoshChan",
      "author_association": "COLLABORATOR",
      "body": "@vexx32, your last commit had 2 failures in `PowerShell-CI-linux`\r\nType accelerators.BuiltIn Accelerators.Should have all the type accelerators\r\n```powershell\r\nExpected 99, but got 100.\r\nat <ScriptBlock>, /home/vsts/work/1/s/test/powershell/Language/Parser/TypeAccelerator.Tests.ps1: line 445\r\n445:             $TypeAccelerators.Count | Should -Be $totalAccelerators\r\n```\r\nTests for parameter binding.Default value conversion tests.ValidateScript can use custom ErrorMessage\r\n```powershell\r\nExpected strings to be the same, but they were different.\r\nExpected length: 80\r\nActual length:   82\r\nStrings differ at index 60.\r\nExpected: '...led '$_ -g...'\r\nBut was:  '...led ' $_ -...'\r\nat <ScriptBlock>, /home/vsts/work/1/s/test/powershell/Language/Scripting/ParameterBinding.Tests.ps1: line 391\r\n391:             $err.Exception.Message | Should -BeExactly \"Cannot validate argument on parameter 'p'. Item '2' failed '`$_ -gt 2' validation\"\r\n```\r\n",
      "created_at": "2019-05-17T05:04:14Z",
      "updated_at": "2019-05-17T05:04:14Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@vexx32 Please move all formatting in new PR.",
      "created_at": "2019-05-17T11:58:20Z",
      "updated_at": "2019-05-17T11:58:20Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "Wasn't intentional, VS Code got snarky, it seems. \ud83d\ude42 \r\n\r\nI'll do a quick pass in a separate PR for just formatting to help with that.",
      "created_at": "2019-05-17T12:36:15Z",
      "updated_at": "2019-05-17T12:36:15Z"
    },
    {
      "author": "KirkMunro",
      "author_association": "CONTRIBUTOR",
      "body": "Calling out specific feedback on the related issue, [here](https://github.com/PowerShell/PowerShell/issues/7835#issuecomment-493478503).",
      "created_at": "2019-05-17T14:42:10Z",
      "updated_at": "2019-05-17T14:42:10Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "Cheers, @KirkMunro! \r\n\r\n@iSazonov did a full style pass for `Attributes.cs` in #9625. I'll move onto the other one VS Code was nitpicking about in a bit. ",
      "created_at": "2019-05-19T14:18:46Z",
      "updated_at": "2019-05-19T14:19:40Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@vexx32 Please rebase and resolve failures.",
      "created_at": "2019-06-21T01:08:02Z",
      "updated_at": "2019-06-21T01:08:02Z"
    },
    {
      "author": "KirkMunro",
      "author_association": "CONTRIBUTOR",
      "body": "@vexx32 Coming back to this one (since it just jumped into view again in my email watch list for this repo), and forgive me if I already asked this, but part of me wonders \"why?\" for this PR. We can already specify a custom type name in an attribute (e.g. `[PSTypeName('My.Custom.Type.Name')]`), and in my mind that's a better way to identify intent for a `PSObject` that is passed in, rather than look for specific parameters, especially since error handling will tell them what they should be passing in.\r\n\r\nFor example:\r\n\r\n```none\r\nPS C:\\> function Get-Something {\r\n>>     [CmdletBinding()]\r\n>>     [OutputType('That.Is.Something')]\r\n>>     param()\r\n>>     [pscustomobject]@{\r\n>>         PSTypeName = 'That.Is.Something'\r\n>>         One = 'Fish'\r\n>>         Two = 'Fish'\r\n>>     }\r\n>>     [pscustomobject]@{\r\n>>         PSTypeName = 'That.Is.Something.Else'\r\n>>         Red = 'Fish'\r\n>>         Blue = 'Fish'\r\n>>     }\r\n>> }\r\nPS C:\\> $one,$two = Get-Something\r\nPS C:\\> function Test-Something {\r\n>>     [CmdletBinding()]\r\n>>     [OutputType([bool])]\r\n>>     param(\r\n>>         [Parameter(Mandatory, Position=0)]\r\n>>         [ValidateNotNull()]\r\n>>         [PSTypeName('That.Is.Something')]\r\n>>         $Something\r\n>>     )\r\n>>     $true\r\n>> }\r\nPS C:\\> Test-Something -Something $one\r\nTrue\r\nPS C:\\> Test-Something -Something $two\r\nTest-Something : Cannot bind argument to parameter 'Something', because PSTypeNames of the argument\r\ndo not match the PSTypeName required by the parameter: That.Is.Something.\r\nAt line:1 char:27\r\n+ Test-Something -Something $two\r\n+                           ~~~~\r\n    + CategoryInfo          : InvalidArgument: (:) [Test-Something], ParameterBindingArgumentTransformationException\r\n    + FullyQualifiedErrorId : MismatchedPSTypeName,Test-Something\r\n```",
      "created_at": "2019-06-21T01:28:40Z",
      "updated_at": "2019-06-21T01:28:40Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "Have you heard of duck typing? Objects with similar property names may often have similar design intents despite coming from different sources. This kind of system allows folks to design a command with a particular input in mind and then to just make it work.\r\n\r\nThough, coming back to this now, it occurs to me that you kind of already can do this, at least with `ValueFromPipelineByPropertyName`, but it's a bit tricky to work with in some instances. This would just make it a bit easier in cases where you want to consolidate all the otherwise messy parameters into a single input object.\r\n\r\nI'll rebase this soon, I have a few things to get to.",
      "created_at": "2019-06-21T01:52:18Z",
      "updated_at": "2019-06-21T01:52:18Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@PoshChan please remind me in 9 days.",
      "created_at": "2019-06-21T02:05:13Z",
      "updated_at": "2019-06-21T02:05:13Z"
    },
    {
      "author": "KirkMunro",
      "author_association": "CONTRIBUTOR",
      "body": "I know duck typing very well, yes, but I still think the community should learn to use `PSTypeName` much more, and yeah, when I read this I also thought about `ValueFromPipelineByPropertyName` as well. With respect to that, I'm curious what you're inferring to by this:\r\n\r\n> but it's a bit tricky to work with in some instances",
      "created_at": "2019-06-21T10:58:25Z",
      "updated_at": "2019-06-21T10:58:25Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "I mean, using ValueFromPipelineByPropertyName needs 1 parameter per property. That can get pretty darn messy when you want to validate say 10 or so properties, especially if you need to take other parameters that aren't meant to come from the object itself.\r\n\r\nResults in some unfortunately messy design patterns... :/",
      "created_at": "2019-06-21T11:04:09Z",
      "updated_at": "2019-06-21T11:04:09Z"
    },
    {
      "author": "KirkMunro",
      "author_association": "CONTRIBUTOR",
      "body": "On the flipside to that, if you're really checking 10 or so properties I'd argue you should be using a custom PSTypeName and checking for that type name instead. :eyes:",
      "created_at": "2019-06-21T12:45:41Z",
      "updated_at": "2019-06-21T12:45:41Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "That's true, but there's no real guarantee that the object has been constructed properly in that instance, so that too only feels like a half-solution to the problem. ",
      "created_at": "2019-06-21T14:23:19Z",
      "updated_at": "2019-06-21T14:23:19Z"
    },
    {
      "author": "KirkMunro",
      "author_association": "CONTRIBUTOR",
      "body": "If you're accepting a custom object as input, you should be receiving that custom object as output from somewhere else. Is that a fair statement? That's the only real way to get anything close to a guarantee. Otherwise what about the types of the values on the members in those objects...those could cause all sorts of issues in a command.\r\n\r\nNo matter what, when you're working with custom objects, there is potential for an issue somewhere, but isn't that a design issue for the command author to think about? I don't really think someone shouldn't be writing commands that take a custom object as pipeline input with the expectation that the scripter will create the custom object, in which case the command they get that object from can give it to them with PSTypeName already set. For individual property validation, we have `ValueFromPipelineByPropertyName` which not only will only have a value if the property was there on the object piped into the command, but it also validates type, checks against null, or other validators that may be important.\r\n\r\nSomething that might help me find this less questionable is a specific, non-contrived example where the issue you're trying to solve here is actually a problem in PowerShell today that would best be solved by this new attribute. Do we have one of those in a PowerShell issue somewhere?",
      "created_at": "2019-06-21T15:39:43Z",
      "updated_at": "2019-06-21T15:39:43Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@daxian-dbw Ping..",
      "created_at": "2019-08-20T23:39:43Z",
      "updated_at": "2019-08-20T23:39:43Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@vexx32 can you resolve the merge conflict",
      "created_at": "2019-08-20T23:39:59Z",
      "updated_at": "2019-08-20T23:39:59Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as stale because it has been marked as requiring author feedback but has not had any activity for **30 days**. It will be closed if no further activity occurs **within 10 days of this comment**.",
      "created_at": "2019-10-15T12:00:31Z",
      "updated_at": "2019-10-15T12:00:31Z"
    }
  ],
  "created_at": "2019-05-17T04:21:05Z",
  "number": 9622,
  "state": "closed",
  "title": "Add ValidatePropertyAttribute for duck-typing parameters",
  "updated_at": "2020-06-13T22:08:57Z"
}