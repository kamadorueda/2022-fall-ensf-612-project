{
  "_url": "https://github.com/PowerShell/PowerShell/issues/14757",
  "author": "jessey-git",
  "body": "## Steps to reproduce\r\n\r\n```powershell\r\nmkdir test\r\ncd test\r\n\r\necho \"\" > foo.exe\r\necho \"\" > foo_bar.cmd\r\necho \"\" > foo_bar_zar.cmd\r\nmkdir foo\r\n\r\n.\\f <tab> <tab> <tab> <tab> ...\r\n```\r\n\r\n## Expected behavior\r\n\r\n```none\r\nExpected tab completion order as follows -- matches pwsh 7.0.x, windows explorer, cmd, AND linux Bash\r\n.\\foo\\  .\\foo.exe  .\\foo_bar.cmd  .\\foo_bar_zar.cmd\r\n```\r\n\r\n## Actual behavior\r\n\r\n```none\r\nRegression in ordering\r\n.\\foo\\  .\\foo_bar_zar.cmd  .\\foo_bar.cmd  .\\foo.exe\r\n```\r\n\r\nDo the right thing and fix the regression.\r\n",
  "closed_at": null,
  "comments": [
    {
      "author": "mklement0",
      "author_association": "CONTRIBUTOR",
      "body": "There was indeed a change in behavior between Windows PowerShell and PowerShell (Core), in support of cross-platform consistency, so I don't think it's a regression (though I cannot speak to what extent there was awareness that the behaviors diverged as a result).\r\n\r\nThe PowerShell (Core)-internal change between 7.0.5 and 7.1 is owed to a change in .NET itself outside PowerShell's control (presumably, just moving to a new .NET version did it - I have no information on what prompted the change in .NET).\r\n\r\n```powershell\r\n# Reports \"! . _\" in 7.0.5 vs. \"_ ! .\" in 7.1 and later on a US-English machine.\r\n[string[]] $a = '!', '_', '.'; [Array]::Sort($a, [StringComparer]::CurrentCultureIgnoreCase); $a -join ' '\r\n```\r\n\r\nHowever, even 7.05 didn't sort the same as `cmd.exe` with respect to non-ASCII characters:\r\n\r\nIt is also important to note that there is _no_ consistent behavior across the other shells and GUI file managers such as File Explorer.\r\n\r\nThe summary is:\r\n\r\n* Each platform individually exhibits different behaviors in the (native-shell) terminal vs. in the GUI file manager (notably, natural sorting of trailing numbers).\r\n\r\n* Different Unix-like platforms behave differently (macOS vs. Linux).\r\n\r\n* Windows PowerShell exhibits different behavior with `Get-ChildItem` (ordinal sorting (by code-point value), as reported by the .NET file-enumeration APIs) vs. with tab-completion (lexical) - an unfortunate inconsistency.\r\n\r\n* PowerShell (Core) now uses lexical sorting consistently, on all platforms, which means case-insensitive, current-culture-sensitive sorting; on Unix-like platforms it _must_ do its own sorting, because the underlying system APIs enumerate files unsorted.\r\n\r\n---\r\n\r\nI see the following options:\r\n\r\n* (a) Leave everything as is, which has two benefits:\r\n  * Simple implementation.\r\n  * Consistent behavior across all platforms - even if it doesn't match any platform's native sorting.\r\n\r\n* (b) Try to emulate the native shells _platform-specifically_, which would mean: \r\n  * Increased implementation complexity.\r\n  * Ordinal sorting on Windows and macOS.\r\n  * _Modified_ lexical sorting on Linux (emulating the specifics may be tricky, unless it is provided by a system call)\r\n\r\n* (c) Stick with consistent cross-platform behavior, but switch to the \"majority\" sorting, which would be ordinal, because 2 out of 3 platforms - Windows and macOS - use it, but in terms of actual PowerShell usage Linux is probably the more important platform.\r\n\r\nFrom a PowerShell (Core) perspective (alone), (b) and (c) would be breaking changes, given that a change wouldn't just affect the interactive experience (tab-completion) but also the order in which files are listed with `Get-Item` / `Get-ChildItem`.\r\n\r\n---\r\n\r\nFor anyone who wants to experiment with the sort orders, here's test code:\r\n\r\n<details>\r\n```powershell\r\n& {\r\n  Push-Location ($td = New-Item -Force -ItemType Directory (Join-Path ([io.path]::GetTempPath()) $PID))\r\n\r\n  $names = 'foo', 'foo_bar.cmd', 'foo_bar_cmd', 'foo_bar!cmd', 'f\u00f6o', 'foo10', 'foo2'\r\n\r\n  $null = New-Item -Force $names\r\n\r\n  '-- Ordinal sort'\r\n  [Array]::Sort($names, [StringComparer]::OrdinalIgnoreCase); $names\r\n\r\n  '-- Lexical sort (current culture)'\r\n  [Array]::Sort($names, [StringComparer]::CurrentCultureIgnoreCase); $names\r\n\r\n  '-- Tab-completion'\r\n  (TabExpansion2 -inputScript 'Get-Item ' -cursorColumn 9).CompletionMatches.CompletionText\r\n\r\n  '-- Get-ChildItem' # also applies to -Path and -Filter wildcards\r\n  (Get-ChildItem).Name\r\n\r\n  if ($env:OS -eq 'Windows_NT') {\r\n    \"-- cmd /c dir (Windows)\"\r\n    cmd /c dir /b\r\n\r\n  } else {\r\n    \"-- ls ($(uname))\"\r\n    ls -1\r\n  }\r\n\r\n  Invoke-Item . # Show the folder in the platform's GUI file manager.\r\n\r\n  Read-Host '-- GUI File Manager launched; press Enter to clean up and exit; to test tab-completion in the native shell, press Ctrl-C now, and enter a native shell; rerun the script without aborting later to clean up'\r\n\r\n  Pop-Location; Remove-Item $td -Recurse\r\n}\r\n```\r\n</details>\r\n",
      "created_at": "2021-02-18T20:31:32Z",
      "updated_at": "2021-02-18T20:31:52Z"
    },
    {
      "author": "jessey-git",
      "author_association": "NONE",
      "body": "Any movement here?  I don't see why, in any universe, '_' should come before '.' for file listing or tab-completion...",
      "created_at": "2021-10-03T23:12:11Z",
      "updated_at": "2021-10-03T23:12:11Z"
    },
    {
      "author": "ckrueger1979",
      "author_association": "NONE",
      "body": "@jessey-git\r\nIt's at least consistent with the output of get-childitem.",
      "created_at": "2021-11-10T09:34:26Z",
      "updated_at": "2021-11-10T09:34:26Z"
    },
    {
      "author": "jessey-git",
      "author_association": "NONE",
      "body": "@ckruegerkpmg Not really. Get-ChildItem always used to match.\r\n\r\nHere's the output from 7.0.6 in a real directory and which matches tab-completion behavior as well as more of typical expectations.\r\n```\r\nGet-ChildItem *blender*\r\n\r\n    Directory: F:\\source\\blender-git\\blender-20211022-asan\\bin\\Debug\r\n\r\nMode                 LastWriteTime         Length Name\r\n----                 -------------         ------ ----\r\nd----          10/22/2021  2:39 PM                blender.crt\r\n-a---           11/5/2021  4:30 PM      529417728 blender.exe\r\n-a---           11/5/2021  4:30 PM           2026 blender.exp\r\n-a---          10/22/2021  2:43 PM           3740 blender.lib\r\n-a---           11/5/2021  4:30 PM      286814208 blender.pdb\r\n-a---           3/11/2021  1:43 PM            832 blender_debug_gpu.cmd\r\n-a---           4/19/2020  2:48 PM            871 blender_debug_gpu_glitchworkaround.cmd\r\n-a---           4/19/2020  2:48 PM            821 blender_debug_log.cmd\r\n-a---           4/19/2020  2:48 PM            806 blender_factory_startup.cmd\r\n-a---           4/19/2020  2:48 PM            554 blender_oculus.cmd\r\n-a---           11/5/2021  4:29 PM           2040 blender_test.exp\r\n-a---           11/4/2021  2:59 PM           3924 blender_test.lib\r\n-a---          10/30/2021 12:02 AM        1103360 blender-launcher.exe\r\n-a---          10/30/2021 12:02 AM        1003520 blender-launcher.pdb\r\n```\r\n\r\nHere is what 7.2.0 believes is the way to sort for no good reason... hilariously bad:\r\n```\r\nGet-ChildItem *blender* \r\n\r\n    Directory: C:\\Users\\fxgltf\\test\r\n\r\nMode                 LastWriteTime         Length Name\r\n----                 -------------         ------ ----\r\nd----          11/10/2021  9:28 PM                blender.crt\r\n-a---           4/19/2020  9:48 PM            871 blender_debug_gpu_glitchworkaround.cmd\r\n-a---           3/11/2021  9:43 PM            832 blender_debug_gpu.cmd\r\n-a---           4/19/2020  9:48 PM            821 blender_debug_log.cmd\r\n-a---           4/19/2020  9:48 PM            806 blender_factory_startup.cmd\r\n-a---           4/19/2020  9:48 PM            554 blender_oculus.cmd\r\n-a---           11/5/2021 11:29 PM           2040 blender_test.exp\r\n-a---           11/4/2021  9:59 PM           3924 blender_test.lib\r\n-a---          10/30/2021  7:02 AM        1103360 blender-launcher.exe\r\n-a---          10/30/2021  7:02 AM        1003520 blender-launcher.pdb\r\n-a---           11/5/2021 11:30 PM      529417728 blender.exe\r\n-a---           11/5/2021 11:30 PM           2026 blender.exp\r\n-a---          10/22/2021  9:43 PM           3740 blender.lib\r\n-a---           11/5/2021 11:30 PM      286814208 blender.pdb\r\n```\r\n\r\nWhy is `_` sorted first before `-` or `.`?  It is possible to be consistent across the platforms without this stupid sort order (and match much more closely everyone else).  The proper order should be \"-\", \".\", and then \"_\" minimally.",
      "created_at": "2021-11-10T21:27:43Z",
      "updated_at": "2021-11-10T22:18:49Z"
    }
  ],
  "created_at": "2021-02-11T08:51:19Z",
  "number": 14757,
  "state": "open",
  "title": "Tab completion regression in ordering (does not match Linux shells, Windows explorer, or cmd)",
  "updated_at": "2021-11-10T22:18:49Z"
}