{
  "_url": "https://github.com/PowerShell/PowerShell/issues/15633",
  "author": "Sarafian",
  "body": "## Steps to reproduce\r\nHave a copy of https://github.com/maxhauser/semver/blob/v2.0.6/Semver/SemVersion.cs in file `SemVersion.cs`\r\nand then do \r\n\r\n```powershell\r\nAdd-Type -Path \"$PSScriptRoot\\CS\\SemVersion.cs\"\r\n```\r\n\r\nSource code has `NETSTANDARD` precompile directives.\r\n\r\n## Expected behavior\r\n\r\nWhen running on a linux image e.g. on AppVeyor, the command should execute successfully\r\n\r\n## Actual behavior\r\n\r\nWhen running on a windows image (e.g. my desktop), the command works successfully.\r\n\r\nError is raised in linux image \r\n```none\r\n/home/appveyor/projects/semverps/Src/Modules/SemVerPS/CS/SemVersion.cs(513,10): error CS0618: 'SecurityPermissionAttribute' is obsolete: 'Code Access Security is not supported or honored by the runtime.'        \r\n     | [SecurityPermission(SecurityAction.Demand, SerializationFormatter = true)]          ^\r\n```\r\n\r\n## Environment data\r\n\r\nAppVeyor instance\r\n\r\n```\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.3\r\nPSEdition                      Core\r\nGitCommitId                    7.1.3\r\nOS                             Linux 5.4.0-1048-azure #50~18.04.1-Ubuntu SMP Fri May 14 15:30:12 UTC 2021\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\nAnd the `Get-ChildItem ENV:\\`\r\n\r\n```none\r\nGet-ChildItem ENV:\\\r\nName                           Value\r\n----                           -----\r\n_                              /usr/bin/printenv\r\nACCEPT_EULA                    Y\r\nAPPVEYOR                       true\r\nAPPVEYOR_ACCOUNT_NAME          Alex61243\r\nAPPVEYOR_API_URL               http://localhost:32805/\r\nAPPVEYOR_BUILD_FOLDER          /home/appveyor/projects/semverps\r\nAPPVEYOR_BUILD_ID              39688481\r\nAPPVEYOR_BUILD_NUMBER          15\r\nAPPVEYOR_BUILD_VERSION         1.0.15\r\nAPPVEYOR_BUILD_WORKER_IMAGE    Ubuntu1804\r\nAPPVEYOR_CONSOLE_DISABLE_PTY   false\r\nAPPVEYOR_JOB_ID                9vlmeqshdi8cnvxc\r\nAPPVEYOR_JOB_NUMBER            1\r\nAPPVEYOR_PROJECT_ID            660096\r\nAPPVEYOR_PROJECT_NAME          SemVerPS\r\nAPPVEYOR_PROJECT_SLUG          semverps\r\nAPPVEYOR_REPO_BRANCH           v2.0.6-pester-v5\r\nAPPVEYOR_REPO_COMMIT           9183e407dd61f29c66c30c6f3139eee9b929709e\r\nAPPVEYOR_REPO_COMMIT_AUTHOR    Alex Sarafian\r\nAPPVEYOR_REPO_COMMIT_AUTHOR_E\u2026 dev1978@outlook.com\r\nAPPVEYOR_REPO_COMMIT_MESSAGE   Updated to v2.0.6. Fixed tests for Pester v5\r\nAPPVEYOR_REPO_COMMIT_TIMESTAMP 2021-06-21T17:13:56.0000000Z\r\nAPPVEYOR_REPO_NAME             Sarafian/SemVerPS\r\nAPPVEYOR_REPO_PROVIDER         gitHub\r\nAPPVEYOR_REPO_SCM              git\r\nAPPVEYOR_REPO_TAG              false\r\nAPPVEYOR_URL                   https://ci.appveyor.com\r\nASPNETCORE_ENVIRONMENT         Production\r\nCI                             true\r\nCI_FREEBSD                     false\r\nCI_LINUX                       true\r\nCI_MACOS                       false\r\nCI_WINDOWS                     false\r\nDEBIAN_FRONTEND                noninteractive\r\nDOTNET_CLI_TELEMETRY_OPTOUT    1\r\nDOTNET_PRINT_TELEMETRY_MESSAGE false\r\nDYLD_LIBRARY_PATH              /home/appveyor/.gvm/pkgsets/go1.16.4/global/overlay/lib:\r\nENABLENUGETPACKAGERESTORE      true\r\nGEM_HOME                       /home/appveyor/.rvm/gems/ruby-2.7.2\r\nGEM_PATH                       /home/appveyor/.rvm/gems/ruby-2.7.2:/home/appveyor/.rvm/gems/ruby-2.7.2@global\r\nGOPATH                         /home/appveyor/.gvm/pkgsets/go1.16.4/global\r\nGOROOT                         /home/appveyor/.gvm/gos/go1.16.4\r\ngvm_go_name                    go1.16.4\r\nGVM_OVERLAY_PREFIX             /home/appveyor/.gvm/pkgsets/go1.16.4/global/overlay\r\nGVM_PATH_BACKUP                /home/appveyor/.gvm/bin:/home/appveyor/.nvm/versions/node/v8.17.0/bin:/opt/octopus:/opt/appveyor/build-agent:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin:/home/appveyor/.dotnet/tools\r\ngvm_pkgset_name                global\r\nGVM_ROOT                       /home/appveyor/.gvm\r\nGVM_VERSION                    1.0.22\r\nHOME                           /home/appveyor\r\nINVOCATION_ID                  f8916d4312c74a319f0e145f03e6e3f4\r\nIRBRC                          /home/appveyor/.rvm/rubies/ruby-2.7.2/.irbrc\r\nJAVA_HOME                      /usr/lib/jvm/java-9-openjdk-amd64\r\nJAVA_HOME_10_X64               /usr/lib/jvm/java-10-openjdk-amd64/\r\nJAVA_HOME_11_X64               /usr/lib/jvm/java-11-openjdk-amd64/\r\nJAVA_HOME_12_X64               /usr/lib/jvm/java-12-openjdk-amd64/\r\nJAVA_HOME_13_X64               /usr/lib/jvm/java-13-openjdk-amd64/\r\nJAVA_HOME_14_X64               /usr/lib/jvm/java-14-openjdk-amd64/\r\nJAVA_HOME_15_X64               /usr/lib/jvm/java-15-openjdk-amd64/\r\nJAVA_HOME_7_X64                /usr/lib/jvm/java-7-openjdk-amd64/\r\nJAVA_HOME_8_X64                /usr/lib/jvm/java-8-openjdk-amd64\r\nJAVA_HOME_9_X64                /usr/lib/jvm/java-9-openjdk-amd64/\r\nJAVA_TOOL_OPTIONS              -Dfile.encoding=UTF8\r\nJOURNAL_STREAM                 9:38058\r\nLANG                           C.UTF-8\r\nLD_LIBRARY_PATH                /home/appveyor/.gvm/pkgsets/go1.16.4/global/overlay/lib:\r\nLOGNAME                        appveyor\r\nMY_RUBY_HOME                   /home/appveyor/.rvm/rubies/ruby-2.7.2\r\nNVM_BIN                        /home/appveyor/.nvm/versions/node/v8.17.0/bin\r\nNVM_DIR                        /home/appveyor/.nvm\r\nOLDPWD                         /opt/appveyor/build-agent\r\nPATH                           /home/appveyor/.rvm/gems/ruby-2.7.2/bin:/home/appveyor/.rvm/gems/ruby-2.7.2@global/bin:/home/appveyor/.rvm/rubies/ruby-2.7.2/bin:/usr/lib/jvm/java-9-openjdk-amd64/bin:/home/appveyor/.gvm/pkgsets/go1.16.4/glo\u2026\r\nPKG_CONFIG_PATH                /home/appveyor/.gvm/pkgsets/go1.16.4/global/overlay/lib/pkgconfig:\r\nPSModulePath                   /home/appveyor/.local/share/powershell/Modules:/usr/local/share/powershell/Modules:/opt/microsoft/powershell/7/Modules\r\nPWD                            /opt/appveyor/build-agent\r\nRUBY_VERSION                   ruby-2.7.2\r\nrvm_bin_path                   /home/appveyor/.rvm/bin\r\nrvm_path                       /home/appveyor/.rvm\r\nrvm_prefix                     /home/appveyor\r\nrvm_version                    1.29.12 (latest)\r\nS_COLORS                       auto\r\nSHELL                          /bin/bash\r\nSHLVL                          1\r\nTERM                           xterm-256color\r\nUSER                           appveyor\r\nXDG_DATA_DIRS                  /usr/local/share:/usr/share:/var/lib/snapd/desktop\r\n\r\n```\r\n\r\n## Suggestion\r\n\r\nI understand that the `Add-Type` is not a compiler and that the directives are for the compiler but `Add-Type` does do part of a compiler by converting the C# code to an assembly. This compilation (conversion) should somehow respect the stack the .net environment that powershell/dotnet is running on. ",
  "closed_at": "2021-06-23T12:00:07Z",
  "comments": [
    {
      "author": "SeeminglyScience",
      "author_association": "COLLABORATOR",
      "body": "It does honor preprocessor directives, it just doesn't define the constant `NETSTANDARD`.  That's part of the `targets` processing done by the `dotnet` CLI.\r\n\r\nI'm not going to weigh in on if something needs to change here, but as a workaround you can use `-TypeDefinition` and conditionally prepend `\"#define NETSTANDARD\" + [Environment]::NewLine`.",
      "created_at": "2021-06-21T18:47:56Z",
      "updated_at": "2021-06-21T18:47:56Z"
    },
    {
      "author": "Sarafian",
      "author_association": "NONE",
      "body": "Out of curiocity, which directives does it honor?\r\n\r\n> I'm not going to weigh in on if something needs to change here, but as a workaround you can use -TypeDefinition and conditionally prepend \"#define NETSTANDARD\" + [Environment]::NewLine.\r\n\r\nThought about the same",
      "created_at": "2021-06-21T19:03:23Z",
      "updated_at": "2021-06-21T19:03:23Z"
    },
    {
      "author": "SeeminglyScience",
      "author_association": "COLLABORATOR",
      "body": "AFAIK it honors all of them.  It's just the constant `NETSTANDARD` that isn't already defined like it would be with the `dotnet` tool chain.",
      "created_at": "2021-06-21T19:07:35Z",
      "updated_at": "2021-06-21T19:07:35Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This issue has been marked as answered and has not had any activity for **1 day**. It has been closed for housekeeping purposes.",
      "created_at": "2021-06-23T12:00:06Z",
      "updated_at": "2021-06-23T12:00:06Z"
    }
  ],
  "created_at": "2021-06-21T17:35:25Z",
  "labels": [
    "Issue-Question",
    "Resolution-Answered",
    "Needs-Triage"
  ],
  "number": 15633,
  "state": "closed",
  "title": "Add-Type should align with precompile directives of host environment like a compiler would do",
  "updated_at": "2021-06-23T12:00:07Z"
}