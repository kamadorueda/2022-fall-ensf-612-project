{
  "_url": "https://github.com/PowerShell/PowerShell/issues/4196",
  "author": "chunqingchen",
  "body": "Fix issue #3325 \r\n\r\nSummary of the issue:\r\n\r\nvisual studio cannot import the right assembly contains in their test vsix package through package manage console. It will always load the assembly contains in the vs location\r\n\r\nRoot cause of the issue:\r\nloadassembly funtion will always try to load the assembly based on the assembly name first, then try the filename. In this case, no matter what assembly path psd1 file gives, ps will ignore and load the assembly in the vs cache.\r\n\r\nFix:\r\nSince the filename is given, we should try it first before going to the assembly name.\r\n\r\nThe test scenario of this issue is very specific and does not contains in our ps enviroment. Attached the screen shot before/after the fix.\r\n\r\nBefore the fix:\r\n![image](https://user-images.githubusercontent.com/16246343/27954472-007e0c64-62c5-11e7-9777-8e3eab72a75c.png)\r\n\r\nAfter the fix:\r\n![image](https://user-images.githubusercontent.com/16246343/27954510-2a9de87a-62c5-11e7-970b-b0bdfcbe50c9.png)\r\n",
  "closed_at": "2017-09-29T18:58:57Z",
  "comments": [
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Can you add a synthetic test case?",
      "created_at": "2017-07-14T21:46:52Z",
      "updated_at": "2017-07-14T21:46:52Z"
    },
    {
      "author": "chunqingchen",
      "author_association": "CONTRIBUTOR",
      "body": "@SteveL-MSFT test is added",
      "created_at": "2017-08-01T04:09:15Z",
      "updated_at": "2017-08-01T04:09:15Z"
    },
    {
      "author": "chunqingchen",
      "author_association": "CONTRIBUTOR",
      "body": "@SteveL-MSFT your comments are resolved. thank you\r\n",
      "created_at": "2017-08-03T00:06:41Z",
      "updated_at": "2017-08-03T00:06:41Z"
    },
    {
      "author": "chunqingchen",
      "author_association": "CONTRIBUTOR",
      "body": "@SteveL-MSFT your comment is resolved thanks",
      "created_at": "2017-08-04T01:41:37Z",
      "updated_at": "2017-08-04T01:41:37Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "This change seems risky to me.\r\n1. If an assembly is already loaded, and you try to load another same assembly file of a different version, `Assembly.LoadFrom` will throw; if you want to load another assembly file with the same version, then the already loaded assembly will be returned. See an example here:\r\n```\r\nPS:6> [System.Reflection.AssemblyName]::GetAssemblyName(\"F:\\tmp\\System.Management.Automation.dll\")\r\n\r\nVersion        Name\r\n-------        ----\r\n6.0.1.0        System.Management.Automation\r\n\r\nPS:7> [psobject].Assembly.GetName()\r\n\r\nVersion        Name\r\n-------        ----\r\n6.0.0.0        System.Management.Automation\r\n\r\nPS:8> [System.Reflection.Assembly]::LoadFrom(\"F:\\tmp\\System.Management.Automation.dll\")\r\nException calling \"LoadFrom\" with \"1\" argument(s): \"Could not load file or assembly 'System.Management.Automation,\r\nVersion=6.0.1.0, Culture=neutral, PublicKeyToken=null'.\"\r\nAt line:1 char:1\r\n+ [System.Reflection.Assembly]::LoadFrom(\"F:\\tmp\\System.Management.Auto ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : NotSpecified: (:) [], MethodInvocationException\r\n    + FullyQualifiedErrorId : FileLoadException\r\n```\r\n2. The original code prefers to assemblies in GAC, while the altered code prefers to file name. This is a behavior change, and since we now looking for GAC assemblies in powershell core for `Assembly.Load` call, this change could cause problems.\r\n\r\nAdd @lzybkr to reviewers to get more inputs on this change.",
      "created_at": "2017-08-04T19:26:17Z",
      "updated_at": "2017-08-04T19:26:17Z"
    },
    {
      "author": "chunqingchen",
      "author_association": "CONTRIBUTOR",
      "body": "@daxian-dbw \r\nAccording to dongbo's concern about the exception. If user has specified the file path of the assembly, we should load the assembly according to user's willing. If an exception is thrown as assembly is already loaded, user should correct the file path or just give assembly name instead.\r\n\r\nLoading assembly in GAC regardless user's given file path is exactly where the bug scenario comes from.\r\n\r\n@lzybkr  your comments are resolved.",
      "created_at": "2017-08-31T10:42:07Z",
      "updated_at": "2017-08-31T10:42:07Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@chunqingchen please don't override existing commit history. Instead, push new commits to address comments.\r\nAlso, please make sure you add `[Feature]` label to your next commit message so that all tests can be validated with your fix.",
      "created_at": "2017-09-20T20:08:57Z",
      "updated_at": "2017-09-20T20:08:57Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@chunqingchen if we decide to take this breaking change, then it'd better go in as soon as possible so that we have more time to validate the potential impact. Can you please address the comments as soon as you get a chance?",
      "created_at": "2017-09-22T15:28:23Z",
      "updated_at": "2017-09-22T15:28:23Z"
    },
    {
      "author": "chunqingchen",
      "author_association": "CONTRIBUTOR",
      "body": "@daxian-dbw thanks for your comments. your comment is resolved.",
      "created_at": "2017-09-27T12:44:58Z",
      "updated_at": "2017-09-27T12:44:58Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@chunqingchen Thanks for the update, I left a few more comments. Please push new commits to address the commits without overriding the commit history.",
      "created_at": "2017-09-27T19:37:58Z",
      "updated_at": "2017-09-27T19:37:58Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@chunqingchen Please fix the test failure.",
      "created_at": "2017-09-29T00:25:11Z",
      "updated_at": "2017-09-29T00:25:11Z"
    },
    {
      "author": "chunqingchen",
      "author_association": "CONTRIBUTOR",
      "body": "thanks @daxian-dbw , checks are passed.",
      "created_at": "2017-09-29T02:11:36Z",
      "updated_at": "2017-09-29T02:11:36Z"
    }
  ],
  "created_at": "2017-07-07T09:33:59Z",
  "number": 4196,
  "state": "closed",
  "title": "PS should try to load the assembly from file path first before loading from assemblyName",
  "updated_at": "2017-09-29T18:58:57Z"
}