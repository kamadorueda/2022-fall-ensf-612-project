{
  "_url": "https://github.com/PowerShell/PowerShell/issues/13829",
  "author": "jmiller76",
  "body": "## Steps to reproduce\r\n\r\nWindows Server 2016 -1607 14393.3986\r\nand \r\nMicrosoft Windows 10.0.19041  \r\n\r\nboth with.\r\nPowerShell-7.0.3-win-x86\r\n\r\n```powershell\r\n\tGet-Counter '\\Memory\\Available MBytes'\r\n```\r\ninteresting enough:\r\n> pwsh -command {Get-Counter '\\Memory\\Available MBytes'} \r\ncalled from CMD does not seem to generate a visible stacktrace.\r\n\r\n## Expected behavior\r\n\r\n```none\r\nResult or Error (if the command is not supported in 32bit.)\r\n```\r\n\r\n## Actual behavior\r\n\r\n```none\r\nFatal error. Internal CLR error. (0x80131506)                                                                              at System.Runtime.InteropServices.Marshal.PtrToStructureHelper(IntPtr, System.Object, Boolean)                          at System.Runtime.InteropServices.Marshal.PtrToStructureHelper(IntPtr, System.Type)                                     at System.Runtime.InteropServices.Marshal.PtrToStructure(IntPtr, System.Type)                                           at Microsoft.Powershell.Commands.GetCounter.PdhNative.PdhHelper.GetCounterInfoPlus(IntPtr, UInt32 ByRef, UInt32 ByRef, UInt64 ByRef)                                                                                                            at Microsoft.Powershell.Commands.GetCounter.PdhNative.PdhHelper.ReadNextSet(Microsoft.PowerShell.Commands.GetCounter.PerformanceCounterSampleSet ByRef, Boolean)                                                                                at Microsoft.PowerShell.Commands.GetCounterCommand.ProcessGetCounter()                                                  at Microsoft.PowerShell.Commands.GetCounterCommand.EndProcessing()                                                      at System.Management.Automation.Cmdlet.DoEndProcessing()                                                                at System.Management.Automation.CommandProcessorBase.Complete()                                                         at System.Management.Automation.CommandProcessorBase.DoComplete()                                                       at System.Management.Automation.Internal.PipelineProcessor.DoCompleteCore(System.Management.Automation.CommandProcessorBase)                                                                                                                    at System.Management.Automation.Internal.PipelineProcessor.SynchronousExecuteEnumerate(System.Object)                   at System.Management.Automation.PipelineOps.InvokePipeline(System.Object, Boolean, System.Management.Automation.CommandParameterInternal[][], System.Management.Automation.Language.CommandBaseAst[], System.Management.Automation.CommandRedirection[][], System.Management.Automation.Language.FunctionContext)                                                       at System.Management.Automation.Interpreter.ActionCallInstruction`6[[System.__Canon, System.Private.CoreLib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Boolean, System.Private.CoreLib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.__Canon, System.Private.CoreLib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.__Canon, System.Private.CoreLib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.__Canon, System.Private.CoreLib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.__Canon, System.Private.CoreLib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]].Run(System.Management.Automation.Interpreter.InterpretedFrame)                                                             at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(System.Management.Automation.Interpreter.InterpretedFrame)                                                                                                      at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(System.Management.Automation.Interpreter.InterpretedFrame)                                                                                                      at System.Management.Automation.Interpreter.Interpreter.Run(System.Management.Automation.Interpreter.InterpretedFrame)                                                                                                                          at System.Management.Automation.Interpreter.LightLambda.RunVoid1[[System.__Canon, System.Private.CoreLib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]](System.__Canon)                                                   at System.Management.Automation.DlrScriptCommandProcessor.RunClause(System.Action`1<System.Management.Automation.Language.FunctionContext>, System.Object, System.Object)                                                                       at System.Management.Automation.DlrScriptCommandProcessor.Complete()                                                    at System.Management.Automation.CommandProcessorBase.DoComplete()                                                       at System.Management.Automation.Internal.PipelineProcessor.DoCompleteCore(System.Management.Automation.CommandProcessorBase)                                                                                                                    at System.Management.Automation.Internal.PipelineProcessor.SynchronousExecuteEnumerate(System.Object)                   at System.Management.Automation.Runspaces.LocalPipeline.InvokeHelper()                                                  at System.Management.Automation.Runspaces.LocalPipeline.InvokeThreadProc()                                              at System.Management.Automation.Runspaces.LocalPipeline.InvokeThreadProcImpersonate()                                   at System.Management.Automation.Runspaces.PipelineThread.WorkerProc()                                                   at System.Threading.ThreadHelper.ThreadStart_Context(System.Object)                                                     at System.Threading.ExecutionContext.RunInternal(System.Threading.ExecutionContext, System.Threading.ContextCallback, System.Object)                                                                                                            at System.Threading.ThreadHelper.ThreadStart()                               \r\n```\r\n\r\nWe found this because someone manually installed 32bit PowerShell.  Windows 10 copy was from the Zip download 2016 server was from the MSI. (Stacktrace above on Windows 10 laptop)\r\n\r\n",
  "closed_at": "2022-07-27T20:36:44Z",
  "comments": [
    {
      "author": "jmiller76",
      "author_association": "NONE",
      "body": "ewww, that stack trace looks worse in rendered markdown then it was in the preview.  it was a simple reproduce on laptop, but if needed, I can provide more info.\r\n",
      "created_at": "2020-10-21T18:50:35Z",
      "updated_at": "2020-10-21T18:50:35Z"
    },
    {
      "author": "SeeminglyScience",
      "author_association": "COLLABORATOR",
      "body": "Looks like the problem is in how the `PDH_COUNTER_INFO` struct is defined here:\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/5b82b767558f682fef3ec53b5e5955981c2183ec/src/Microsoft.PowerShell.Commands.Diagnostics/PdhHelper.cs#L267-L294\r\n\r\nUsing `LayoutKind.Explicit` doesn't work when the struct contains pointer type fields outside of the union. Here's an example of how it can be declared differently to work in 32 bit processes:\r\n\r\n<details>\r\n\r\n<summary>\r\n\r\n**(Click to expand!)**</summary>\r\n\r\n```csharp\r\nusing System;\r\nusing System.Runtime.InteropServices;\r\n\r\n// Direct blittable struct translation. Needs edits if marshaling is desired (e.g. `string`)\r\n\r\n[StructLayout(LayoutKind.Sequential)]\r\npublic unsafe struct PDH_COUNTER_INFO\r\n{\r\n    public uint dwLength;\r\n\r\n    public uint dwType;\r\n\r\n    public uint CVersion;\r\n\r\n    public uint CStatus;\r\n\r\n    public int lScale;\r\n\r\n    public int lDefaultScale;\r\n\r\n    public nuint dwUserData;\r\n\r\n    public nuint dwQueryUserData;\r\n\r\n    public char* szFullPath;\r\n\r\n    public PdhDataUnion DataUnion;\r\n\r\n    public char* szExplainText;\r\n\r\n    public fixed uint DataBuffer[1];\r\n}\r\n\r\n[StructLayout(LayoutKind.Explicit)]\r\npublic unsafe struct PdhDataUnion\r\n{\r\n    [FieldOffset(0)]\r\n    public PDH_DATA_ITEM_PATH_ELEMENTS DataItemPath;\r\n\r\n    [FieldOffset(0)]\r\n    public PDH_COUNTER_PATH_ELEMENTS CounterPath;\r\n\r\n    [FieldOffset(0)]\r\n    public OtherUnionMember UnionMember3;\r\n}\r\n\r\n[StructLayout(LayoutKind.Sequential)]\r\npublic unsafe struct PDH_DATA_ITEM_PATH_ELEMENTS\r\n{\r\n    public char* szMachineName;\r\n\r\n    public Guid ObjectGUID;\r\n\r\n    public uint dwItemId;\r\n\r\n    public char* szInstanceName;\r\n}\r\n\r\n[StructLayout(LayoutKind.Sequential)]\r\npublic unsafe struct PDH_COUNTER_PATH_ELEMENTS\r\n{\r\n    public char* szMachineName;\r\n\r\n    public char* szObjectName;\r\n\r\n    public char* szInstanceName;\r\n\r\n    public char* szParentInstance;\r\n\r\n    public uint dwInstanceIndex;\r\n\r\n    public char* szCounterName;\r\n}\r\n\r\n[StructLayout(LayoutKind.Sequential)]\r\npublic unsafe struct OtherUnionMember\r\n{\r\n    public char* szMachineName;\r\n\r\n    public char* szObjectName;\r\n\r\n    public char* szInstanceName;\r\n\r\n    public char* szParentInstance;\r\n\r\n    public uint dwInstanceIndex;\r\n\r\n    public char* szCounterName;\r\n}\r\n```\r\n\r\n</details>",
      "created_at": "2020-10-21T19:48:19Z",
      "updated_at": "2022-07-14T19:27:09Z"
    }
  ],
  "created_at": "2020-10-21T18:49:25Z",
  "labels": [
    "Issue-Question",
    "WG-Cmdlets",
    "Release-Testing"
  ],
  "number": 13829,
  "state": "closed",
  "title": "PowerShell 7 (32bit) Crash on Get-Counter '\\Memory\\Available MBytes'",
  "updated_at": "2022-07-27T20:36:44Z"
}