{
  "_url": "https://github.com/PowerShell/PowerShell/issues/2220",
  "author": "andschwa",
  "body": "This PR does a number of things:\n- Adds a set of \"stable\" Dockerfiles that are pretty minimal derivations of the official upstream distributions with our dependencies and latest package installed\n- Adds a set of \"unstable\" Dockerfiles that are derivations of the stable images that then automatically build **and package** PowerShell (these are _much_ bigger images due to all the tools)\n- Adds a pretty basic launch script that builds, tags, and tests all the images (1% of Pester tests are failing due to being executed in a container environment)\n- Fixes `GetFullyQualfiedName()` native test to pass inside containers (`getaddrinfo` curiously fails with `ENOLINK`, which should be debugged; but the test is updated to at least assert that it failed the same way as the source)\n- Adds some options and changes to `build.psm1` to make it more friendly for containerization\n\nThis _does not_ update documentation, as I'd like @JamesWTruher, @raghushantha, @vors to test this out and see if it meets at least their starting needs.\n\nThis PR enables a \"one-click\" Linux packaging experience for maintainers. Running `launch.sh` results results in a set of three unstable images each with the corresponding distribution's package correctly made and installed (this package still needs to be tested in non-Docker environments). Setting `TEST=1` instead runs `Start-PSPester` in each container. The script is currently configurable through environment variables, and has minimal error handling. It could massively improved, but I'd like to not over-engineer it any further without feedback.\n\nThe distributions and kinds of images to be built are also parameterized, as well as the fork and branch that is to be used. Example invocation:\n\n``` sh\nFORK=andschwa BRANCH=docker DISTROS=ubuntu16.04 BUILDS=stable TEST=1 ./launch.sh\n```\n\nIt _obviously_ requires Docker to be installed on your machine, and a network connection.\n",
  "closed_at": "2016-09-13T01:27:36Z",
  "comments": [
    {
      "author": "msftclas",
      "author_association": "NONE",
      "body": "Hi **@andschwa**, I'm your friendly neighborhood Microsoft Pull Request Bot (You can call me MSBOT). Thanks for your contribution!\n    <p>\n        It looks like you're a Microsoft contributor (Andy Schwartzmeyer). If you're full-time, we DON'T require a Contribution License Agreement. If you are a vendor, please DO sign the electronic Contribution License Agreement. It will take 2 minutes and there's no faxing! https://cla.microsoft.com.\n    </p>\n\nTTYL, MSBOT;\n",
      "created_at": "2016-09-09T22:10:08Z",
      "updated_at": "2016-09-09T22:10:08Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "Resolves/replaces #2001, #1992, #2192.\n\nFor #2002, @vors, @lzybkr, and I are discussing which images to build via the hub and when. For now this decision is deferred.\n",
      "created_at": "2016-09-09T22:12:32Z",
      "updated_at": "2016-09-09T22:12:32Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "Assigned reviewers. This _needs_ to be tested by others for usability.\n",
      "created_at": "2016-09-09T22:21:50Z",
      "updated_at": "2016-09-09T22:21:50Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "Test with, at minimum:\n\n``` sh\nFORK=andschwa BRANCH=docker ./launch.sh\n```\n\nAs it will _not_ work with PowerShell's `master` branch (fixes are in this PR, in my fork's `docker` branch).\n",
      "created_at": "2016-09-09T22:25:09Z",
      "updated_at": "2016-09-09T22:25:09Z"
    },
    {
      "author": "vors",
      "author_association": "COLLABORATOR",
      "body": "Does `docker/launch.sh` require `sudo`? I'm getting this error without elevation:\n\n``` sh\nlocaladmin@vors-ubuntu:~/dev/PowerShell/docker$ FORK=andschwa BRANCH=docker DISTROS=ubuntu16.04 BUILDS=stable TEST=1 ./launch.sh\nTesting stable/ubuntu16.04\nFATA[0000] Post http:///var/run/docker.sock/v1.18/containers/create: dial unix /var/run/docker.sock: permission denied. Are you trying to connect to a TLS-enabled daemon without TLS?\n\n```\n\nWith sudo, works better and fails on `ARGS` command.\nI'm using ubuntu 14.04\n\n```\nlocaladmin@vors-ubuntu:~/dev/PowerShell/docker$ FORK=andschwa BRANCH=docker DISTROS=ubuntu16.04 BUILDS=stable TEST=1 sudo ./launch.sh\nBuilding stable/ubuntu14.04\nSending build context to Docker daemon  2.56 kB\nSending build context to Docker daemon\nStep 0 : FROM ubuntu:trusty\ntrusty: Pulling from ubuntu\n96a1ef3ccac0: Pull complete\n2415c9cbee29: Pull complete\n285141620f12: Pull complete\ncdc8a9d219b0: Pull complete\nc6fe6b5c116d: Pull complete\nae60f6d00fe1: Pull complete\nDigest: sha256:9e88b9b0e9245485367a7fd1a58234915d943ed8b6128a90e2ce3a63f49b9398\nStatus: Downloaded newer image for ubuntu:trusty\n ---> ae60f6d00fe1\nStep 1 : MAINTAINER Andrew Schwartzmeyer <andschwa@microsoft.com>\n ---> Running in 443cdd824511\n ---> b02a5ea2c7db\nRemoving intermediate container 443cdd824511\nStep 2 : ARG\nINFO[0021] Unknown instruction: ARG\n\n```\n",
      "created_at": "2016-09-09T23:04:40Z",
      "updated_at": "2016-09-09T23:05:32Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "That depends on how you've setup Docker. If you follow the Docker installation instructions, you'll see a clause on how to enable sudo-less Docker. I do this myself, but it's up to you.\n",
      "created_at": "2016-09-09T23:06:15Z",
      "updated_at": "2016-09-09T23:06:15Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "Also I'm using Docker 1.12 IIRC. The Docker instructions for Ubuntu state not to use the distribution's ancient packages, but to add their repository instead.\n",
      "created_at": "2016-09-09T23:07:24Z",
      "updated_at": "2016-09-09T23:07:24Z"
    },
    {
      "author": "vors",
      "author_association": "COLLABORATOR",
      "body": "After resolving docker setup-related problems, I'm getting this error on both ubuntu 14.04 and OS X\n\n``` sh\nlocaladmin@vors-ubuntu:~/dev/PowerShell/docker$ FORK=andschwa BRANCH=docker DISTROS=ubuntu16.04 BUILDS=stable TEST=1 ./launch.sh\nTesting stable/ubuntu16.04\nUnable to find image 'powershell/powershell:stable-ubuntu16.04' locally\nPulling repository docker.io/powershell/powershell\ndocker: Error: image powershell/powershell:stable-ubuntu16.04 not found.\nSee 'docker run --help'.\n\n```\n",
      "created_at": "2016-09-10T01:26:28Z",
      "updated_at": "2016-09-10T01:26:28Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "@vors don't run with `TEST=1` until you've built first; it's just a switch that goes from build to test; it doesn't do it in addition.\n",
      "created_at": "2016-09-10T02:02:18Z",
      "updated_at": "2016-09-10T02:02:18Z"
    },
    {
      "author": "vors",
      "author_association": "COLLABORATOR",
      "body": "Ah, great! Now all builds fine on both\n",
      "created_at": "2016-09-10T06:01:46Z",
      "updated_at": "2016-09-10T06:01:46Z"
    },
    {
      "author": "vors",
      "author_association": "COLLABORATOR",
      "body": "Besides `iex` issue and `;` in hashtable, looks good\n",
      "created_at": "2016-09-10T06:08:16Z",
      "updated_at": "2016-09-10T06:08:16Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "@vors the `;` issue is resolved. However, I don't want this PR hung up on finding a different solution to `Invoke-Expression $sudo`. If you want to update `Invoke-NativeExecutable` to take `-NoSudo`, that'd be great. But I don't think this PR should require it.\n\nThe `launch.sh` script is now documented, builds in parallel, logs, and copies the generated packages back out to the host.\n",
      "created_at": "2016-09-12T21:59:15Z",
      "updated_at": "2016-09-12T21:59:15Z"
    },
    {
      "author": "vors",
      "author_association": "COLLABORATOR",
      "body": "I agree. The PR is already too big and it's required for the alpha.10 release.\n",
      "created_at": "2016-09-13T01:27:29Z",
      "updated_at": "2016-09-13T01:27:29Z"
    }
  ],
  "created_at": "2016-09-09T22:10:05Z",
  "number": 2220,
  "state": "closed",
  "title": "Dockerize Linux build environments",
  "updated_at": "2016-09-13T01:27:36Z"
}