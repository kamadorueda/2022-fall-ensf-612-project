{
  "_url": "https://github.com/PowerShell/PowerShell/issues/7943",
  "author": "iSazonov",
  "body": "After we added reference to Windows Compatibility Pack we enable `[wmisearcher]` without any test - and it doesn't work.\r\n\r\nSteps to reproduce\r\n------------------\r\n\r\n```powershell\r\n $a=[wmisearcher]\"SELECT * FROM Win32_Process\"\r\n```\r\n\r\nExpected behavior\r\n-----------------\r\n```none\r\nNo exception\r\n```\r\n\r\nActual behavior\r\n---------------\r\n\r\n```\r\nCannot convert value \"SELECT CommandLine FROM Win32_Process\" to type \"System.Management.ManagementObjectSearcher\". Error: \"The type initializer for 'System.Management.ManagementPath' threw an exception.\"\r\nAt line:1 char:1\r\n+ $a=[wmisearcher]\"SELECT CommandLine FROM Win32_Process\"\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : InvalidArgument: (:) [], RuntimeException\r\n+ FullyQualifiedErrorId : InvalidCastToWMISearcher\r\n\r\n\r\n$error[0].Exception | fl -Force\r\n\r\n\r\nErrorRecord                 : Cannot convert value \"SELECT * FROM Win32_Process\" to type\r\n                              \"System.Management.ManagementObjectSearcher\". Error: \"The type initializer for\r\n                              'System.Management.ManagementPath' threw an exception.\"\r\nWasThrownFromThrowStatement : False\r\nMessage                     : Cannot convert value \"SELECT * FROM Win32_Process\" to type\r\n                              \"System.Management.ManagementObjectSearcher\". Error: \"The type initializer for\r\n                              'System.Management.ManagementPath' threw an exception.\"\r\nData                        : {}\r\nInnerException              : System.Management.Automation.PSInvalidCastException: Cannot convert value\r\n                              \"SELECT * FROM Win32_Process\" to type\r\n                              \"System.Management.ManagementObjectSearcher\". Error: \"The type initializer for\r\n                              'System.Management.ManagementPath' threw an exception.\" --->\r\n                              System.TypeInitializationException: The type initializer for\r\n                              'System.Management.ManagementPath' threw an exception. --->\r\n                              System.TypeInitializationException: The type initializer for\r\n                              'System.Management.WmiNetUtilsHelper' threw an exception. --->\r\n                              System.ArgumentNullException: Value cannot be null.\r\n                              Parameter name: ptr\r\n                                 at\r\n                              System.Runtime.InteropServices.Marshal.GetDelegateForFunctionPointer(IntPtr\r\n                              ptr, Type t)\r\n                                 at System.Runtime.InteropServices.Marshal.GetDelegateForFunctionPointer[TDele\r\n                              gate](IntPtr ptr)\r\n                                 at System.Management.WmiNetUtilsHelper.LoadDelegate[TDelegate](TDelegate&\r\n                              delegate_f, IntPtr hModule, String procName)\r\n                                 at System.Management.WmiNetUtilsHelper..cctor()\r\n                                 --- End of inner exception stack trace ---\r\n                                 at System.Management.MTAHelper.IsNoContextMTA()\r\n                                 at System.Management.MTAHelper.CreateInMTA(Type type)\r\n                                 at System.Management.ManagementPath.CreateWbemPath(String path)\r\n                                 at System.Management.ManagementPath..ctor(String path)\r\n                                 at System.Management.ManagementPath..cctor()\r\n                                 --- End of inner exception stack trace ---\r\n                                 at System.Management.ManagementScope._Clone(ManagementScope scope,\r\n                              IdentifierChangedEventHandler handler)\r\n                                 at System.Management.ManagementObjectSearcher..ctor(ManagementScope scope,\r\n                              ObjectQuery query, EnumerationOptions options)\r\n                                 at\r\n                              System.Management.Automation.LanguagePrimitives.ConvertToWMISearcher(Object\r\n                              valueToConvert, Type resultType, Boolean recursion, PSObject\r\n                              originalValueToConvert, IFormatProvider formatProvider, TypeTable backupTable)\r\n                              in C:\\Users\\sie\\Documents\\GitHub\\iSazonov\\PowerShell\\src\\System.Management.Autom\r\n                              ation\\engine\\LanguagePrimitives.cs:line 2340\r\n                                 --- End of inner exception stack trace ---\r\n                                 at\r\n                              System.Management.Automation.LanguagePrimitives.ConvertToWMISearcher(Object\r\n                              valueToConvert, Type resultType, Boolean recursion, PSObject\r\n                              originalValueToConvert, IFormatProvider formatProvider, TypeTable backupTable)\r\n                              in C:\\Users\\sie\\Documents\\GitHub\\iSazonov\\PowerShell\\src\\System.Management.Autom\r\n                              ation\\engine\\LanguagePrimitives.cs:line 2346\r\n                                 at System.Dynamic.UpdateDelegates.UpdateAndExecute1[T0,TRet](CallSite site,\r\n                              T0 arg0)\r\n                                 at System.Management.Automation.Interpreter.DynamicInstruction`2.Run(Interpre\r\n                              tedFrame frame) in C:\\Users\\sie\\Documents\\GitHub\\iSazonov\\PowerShell\\src\\System.\r\n                              Management.Automation\\engine\\interpreter\\DynamicInstructions.Generated.cs:line\r\n                              139\r\n                                 at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.R\r\n                              un(InterpretedFrame frame) in C:\\Users\\sie\\Documents\\GitHub\\iSazonov\\PowerShell\\\r\n                              src\\System.Management.Automation\\engine\\interpreter\\ControlFlowInstructions.cs:l\r\n                              ine 356\r\nTargetSite                  :\r\nStackTrace                  :\r\nHelpLink                    :\r\nSource                      :\r\nHResult                     : -2146233087\r\n\r\n```\r\n\r\nEnvironment data\r\n----------------\r\n\r\n<!-- provide the output of $PSVersionTable -->\r\n\r\n```powershell\r\n> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.1.0\r\nPSEdition                      Core\r\nGitCommitId                    6.1.0-92-gb941e62def5b0d74979c22fa01690ed68a454a8d\r\nOS                             Microsoft Windows 10.0.10240\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n",
  "closed_at": "2018-10-05T03:16:09Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Another repo\r\n\r\nSteps to reproduce\r\n------------------\r\n\r\n```powershell\r\n[System.Management.ManagementPath]::DefaultPath\r\n```\r\n\r\nExpected behavior\r\n-----------------\r\n```none\r\nNo exception\r\n```\r\n\r\nActual behavior\r\n---------------\r\n\r\n```\r\nThe type initializer for 'System.Management.ManagementPath' threw an exception.\r\nAt line:1 char:1\r\n+ [System.Management.ManagementPath]::DefaultPath\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : OperationStopped: (:) [], TypeInitializationException\r\n+ FullyQualifiedErrorId : System.TypeInitializationException\r\n\r\n $error[0].Exception | fl -Force\r\n\r\n\r\nTypeName       : System.Management.ManagementPath\r\nMessage        : The type initializer for 'System.Management.ManagementPath' threw an exception.\r\nData           : {}\r\nInnerException : System.TypeInitializationException: The type initializer for\r\n                 'System.Management.WmiNetUtilsHelper' threw an exception. ---> System.ArgumentNullException:\r\n                 Value cannot be null.\r\n                 Parameter name: ptr\r\n                    at System.Runtime.InteropServices.Marshal.GetDelegateForFunctionPointer(IntPtr ptr, Type\r\n                 t)\r\n                    at System.Runtime.InteropServices.Marshal.GetDelegateForFunctionPointer[TDelegate](IntPtr\r\n                 ptr)\r\n                    at System.Management.WmiNetUtilsHelper.LoadDelegate[TDelegate](TDelegate& delegate_f,\r\n                 IntPtr hModule, String procName)\r\n                    at System.Management.WmiNetUtilsHelper..cctor()\r\n                    --- End of inner exception stack trace ---\r\n                    at System.Management.MTAHelper.IsNoContextMTA()\r\n                    at System.Management.MTAHelper.CreateInMTA(Type type)\r\n                    at System.Management.ManagementPath.CreateWbemPath(String path)\r\n                    at System.Management.ManagementPath..ctor(String path)\r\n                    at System.Management.ManagementPath..cctor()\r\nTargetSite     : System.Management.ManagementScope _Clone(System.Management.ManagementScope,\r\n                 System.Management.IdentifierChangedEventHandler)\r\nStackTrace     :    at System.Management.ManagementScope._Clone(ManagementScope scope,\r\n                 IdentifierChangedEventHandler handler)\r\n                    at System.Management.ManagementObjectSearcher..ctor(ManagementScope scope, ObjectQuery\r\n                 query, EnumerationOptions options)\r\n                    at Microsoft.PowerShell.Commands.GetProcessCommand.RetrieveProcessCommandLine(Process\r\n                 process) in Process.cs:line 865\r\n                    at Microsoft.PowerShell.Commands.GetProcessCommand.AddCommandLineToProcess(Process\r\n                 process) in Process.cs:line 843\r\n                    at Microsoft.PowerShell.Commands.GetProcessCommand.ProcessRecord() in Process.cs:line 696\r\n                    at System.Management.Automation.Cmdlet.DoProcessRecord() in cmdlet.cs:line 170\r\n                    at System.Management.Automation.CommandProcessor.ProcessRecord() in CommandProcessor.cs:line\r\n                 346\r\nHelpLink       :\r\nSource         : System.Management\r\nHResult        : -2146233036\r\n\r\n\r\n\r\nPS > $error[0].Exception.InnerException | fl -Force\r\n\r\n\r\nTypeName       : System.Management.WmiNetUtilsHelper\r\nMessage        : The type initializer for 'System.Management.WmiNetUtilsHelper' threw an exception.\r\nData           : {}\r\nInnerException : System.ArgumentNullException: Value cannot be null.\r\n                 Parameter name: ptr\r\n                    at System.Runtime.InteropServices.Marshal.GetDelegateForFunctionPointer(IntPtr ptr, Type\r\n                 t)\r\n                    at System.Runtime.InteropServices.Marshal.GetDelegateForFunctionPointer[TDelegate](IntPtr\r\n                 ptr)\r\n                    at System.Management.WmiNetUtilsHelper.LoadDelegate[TDelegate](TDelegate& delegate_f,\r\n                 IntPtr hModule, String procName)\r\n                    at System.Management.WmiNetUtilsHelper..cctor()\r\nTargetSite     : Boolean IsNoContextMTA()\r\nStackTrace     :    at System.Management.MTAHelper.IsNoContextMTA()\r\n                    at System.Management.MTAHelper.CreateInMTA(Type type)\r\n                    at System.Management.ManagementPath.CreateWbemPath(String path)\r\n                    at System.Management.ManagementPath..ctor(String path)\r\n                    at System.Management.ManagementPath..cctor()\r\nHelpLink       :\r\nSource         : System.Management\r\nHResult        : -2146233036\r\n\r\n```\r\n",
      "created_at": "2018-10-04T10:40:21Z",
      "updated_at": "2018-10-04T10:40:21Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Seems root problem is in internal CoreFX method `System.Management.WmiNetUtilsHelper..cctor()`\r\n\r\n@SteveL-MSFT @daxian-dbw Can you confirm that the issue is not PowerShell issue. If so I'll open new issue in CoreFX repo.\r\n\r\nPS: I caught this problem when working on #1849 enhancing Get-Process cmdlet I used wmisearcher. (All other wmi code (like get-wmiobject) is excluded from compile. )",
      "created_at": "2018-10-04T10:52:30Z",
      "updated_at": "2018-10-04T11:01:34Z"
    },
    {
      "author": "RichardSiddaway",
      "author_association": "NONE",
      "body": "I just got this \r\n\r\n```\r\nPS>  $query = [wmisearcher]\"SELECT * FROM Win32_process WHERE Name LIKE 'p%'\"\r\nPS>  $query.get()\r\n\r\n```\r\nto work\r\n\r\nalso got these to work\r\n\r\n\r\n ```\r\n  $query = [wmisearcher]\"SELECT Commandline FROM Win32_process WHERE Name LIKE 'p%'\"\r\n   $query.get()\r\n  \r\n  $query = [wmisearcher]\"SELECT Commandline FROM Win32_process\"\r\n $query.get()\r\n\r\n\r\n```\r\nYour original code\r\n\r\n```\r\n$query = [wmisearcher]\"SELECT * FROM Win32_process\"\r\n$query.get()\r\n\r\n\r\n```\r\nAlso worked for me\r\n\r\n\r\nI can't reproduce your error\r\n\r\n```\r\nPS>  $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.1.0\r\nPSEdition                      Core\r\nGitCommitId                    6.1.0\r\nOS                             Microsoft Windows 10.0.17134\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\n```",
      "created_at": "2018-10-04T11:28:26Z",
      "updated_at": "2018-10-04T11:28:26Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@RichardSiddaway Thanks! My system is Microsoft Windows _10.0.10240_ - maybe it matters.",
      "created_at": "2018-10-04T12:57:02Z",
      "updated_at": "2018-10-04T12:57:02Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@iSazonov not repro'ing on my Win10 (newer internal build as I selfhost):\r\n\r\n```powershell\r\n([wmisearcher]\"select * from win32_computersystem\").Get()\r\n```\r\n",
      "created_at": "2018-10-04T16:24:45Z",
      "updated_at": "2018-10-04T16:25:05Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@SteveL-MSFT Thanks! I'll close the issue. If the problem only with 10.0.10240 we can reopen.\r\n\r\n(Only __Enterprise__ LTSC 10.0.10240 is supported until 2025, other 2017.)",
      "created_at": "2018-10-05T03:16:09Z",
      "updated_at": "2018-10-05T03:23:41Z"
    }
  ],
  "created_at": "2018-10-04T10:36:12Z",
  "number": 7943,
  "state": "closed",
  "title": "wmisearcher - The type initializer for 'System.Management.ManagementPath' threw an exception",
  "updated_at": "2018-10-30T05:59:41Z"
}