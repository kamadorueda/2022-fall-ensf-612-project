{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16942",
  "author": "gbrag-ms",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nSet the permission on a registry key, for example HKML:\\SOFTWARE\\DenySetValue, to Deny the Set Value permission for this key only:\r\n![image](https://user-images.githubusercontent.com/33157656/156207197-04b551a7-14e8-4cef-820b-2d06ba670d0b.png)\r\n\n\n### Expected behavior\n\n```console\nWith REG and REGEDIT we can still create subkeys on that key.\r\nThe key permissions are not preventing that.\n```\n\n\n### Actual behavior\n\n```console\nThe command New-Item HKLM:\\SOFTWARE\\DenySetValue\\TestPS fails with the error:\r\n\"New-Item: Requested registry access is not allowed\"\r\n\r\nChecking the source code I have found that PowerShell relies on the CreateSubKey method to create the subkey.\r\nCreateSubKey is a method of the object created with OpenSubKeyand passing the parameter writable = True\r\nThe permissions check in OpenSubKey is only allowing to create a writable object if both KEY_SET_VALUE and KEY_CREATE_SUB_KEY are permitted.\r\n\r\nThis is a possible workaround:\r\n$key = [Microsoft.Win32.RegistryKey]::OpenBaseKey([Microsoft.Win32.RegistryHive]::LocalMachine,\r\n[Microsoft.Win32.RegistryView]::Registry64) \r\n$sub = $key.OpenSubKey(\"software\\PSDenySetValue\",\r\n[Microsoft.Win32.RegistryKeyPermissionCheck]::ReadWriteSubTree,\r\n[System.Security.AccessControl.RegistryRights]::CreateSubKey) \r\n$sub.CreateSubKey(\"TestNet\")\n```\n\n\n### Error details\n\n```console\nPS C:\\Users\\administrator> get-error\r\n\r\nException             :\r\n    Type       : System.Security.SecurityException\r\n    TargetSite :\r\n        Name          : InternalOpenSubKeyCore\r\n        DeclaringType : Microsoft.Win32.RegistryKey\r\n        MemberType    : Method\r\n        Module        : Microsoft.Win32.Registry.dll\r\n    Message    : Requested registry access is not allowed.\r\n    Source     : Microsoft.Win32.Registry\r\n    HResult    : -2146233078\r\n    StackTrace :\r\n   at Microsoft.Win32.RegistryKey.InternalOpenSubKeyCore(String name, Boolean writable)\r\n   at Microsoft.Win32.RegistryKey.OpenSubKey(String name, Boolean writable)\r\n   at Microsoft.PowerShell.Commands.RegistryWrapper.OpenSubKey(String name, Boolean writable)\r\n   at Microsoft.PowerShell.Commands.RegistryProvider.GetRegkeyForPath(String path, Boolean writeAccess)\r\n   at Microsoft.PowerShell.Commands.RegistryProvider.GetRegkeyForPathWriteIfError(String path, Boolean writeAccess)\r\nTargetObject          : HKEY_LOCAL_MACHINE\\SOFTWARE\\DenySetValue\r\nCategoryInfo          : PermissionDenied: (HKEY_LOCAL_MACHINE\\SOFTWARE\\DenySetValue:String) [New-Item],\r\nSecurityException\r\nFullyQualifiedErrorId : System.Security.SecurityException,Microsoft.PowerShell.Commands.NewItemCommand\r\nInvocationInfo        :\r\n    MyCommand        : New-Item\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 1\r\n    HistoryId        : 1\r\n    Line             : New-Item HKLM:\\SOFTWARE\\DenySetValue\\TestPS\r\n    PositionMessage  : At line:1 char:1\r\n                       + New-Item HKLM:\\SOFTWARE\\DenySetValue\\TestPS\r\n                       + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    InvocationName   : New-Item\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\nPipelineIterationInfo :\n```\n\n\n### Environment data\n\n```powershell\nPS C:\\Users\\administrator> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.1\r\nPSEdition                      Core\r\nGitCommitId                    7.2.1\r\nOS                             Microsoft Windows 10.0.19044\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": null,
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "We use `public RegistryKey? OpenSubKey(string name, bool writable)` overload\r\nwhere writable permissions is defined as\r\nhttps://github.com/dotnet/runtime/blob/57bfe474518ab5b7cfe6bf7424a79ce3af9d6657/src/libraries/Common/src/Interop/Windows/Advapi32/Interop.RegistryConstants.cs#L37\r\n\r\nException place https://github.com/PowerShell/PowerShell/blob/ee6bc9527c2596f048088fa7b396d2664a11ad08/src/System.Management.Automation/namespaces/RegistryProvider.cs#L3441\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/ee6bc9527c2596f048088fa7b396d2664a11ad08/src/System.Management.Automation/namespaces/RegistryWrapper.cs#L180\r\n\r\n```powershell\r\n Get-Error\r\n\r\nException             :\r\n    Type       : System.Security.SecurityException\r\n    TargetSite :\r\n        Name          : InternalOpenSubKeyCore\r\n        DeclaringType : Microsoft.Win32.RegistryKey\r\n        MemberType    : Method\r\n        Module        : Microsoft.Win32.Registry.dll\r\n    Message    : Requested registry access is not allowed.\r\n    Source     : Microsoft.Win32.Registry\r\n    HResult    : -2146233078\r\n    StackTrace :\r\n   at Microsoft.Win32.RegistryKey.InternalOpenSubKeyCore(String name, Boolean writable)\r\n   at Microsoft.PowerShell.Commands.RegistryWrapper.OpenSubKey(String name, Boolean writable) in C:\\Users\\1\\Documents\\G\r\nitHub\\iSazonov\\PowerShell\\src\\System.Management.Automation\\namespaces\\RegistryWrapper.cs:line 180\r\n   at Microsoft.PowerShell.Commands.RegistryProvider.GetRegkeyForPath(String path, Boolean writeAccess) in C:\\Users\\1\\D\r\nocuments\\GitHub\\iSazonov\\PowerShell\\src\\System.Management.Automation\\namespaces\\RegistryProvider.cs:line 3555\r\n   at Microsoft.PowerShell.Commands.RegistryProvider.GetRegkeyForPathWriteIfError(String path, Boolean writeAccess) in\r\nC:\\Users\\1\\Documents\\GitHub\\iSazonov\\PowerShell\\src\\System.Management.Automation\\namespaces\\RegistryProvider.cs:line 34\r\n41\r\nTargetObject          : HKEY_LOCAL_MACHINE\\SOFTWARE\\DenySetValue\r\nCategoryInfo          : PermissionDenied: (HKEY_LOCAL_MACHINE\\SOFTWARE\\DenySetValue:String) [New-Item], Securi\r\ntyException\r\nFullyQualifiedErrorId : System.Security.SecurityException,Microsoft.PowerShell.Commands.NewItemCommand\r\nInvocationInfo        :\r\n    MyCommand        : New-Item\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 1\r\n    HistoryId        : 2\r\n    Line             : New-Item HKLM:\\SOFTWARE\\DenySetValue\\TestPS\r\n    PositionMessage  : At line:1 char:1\r\n                       + New-Item HKLM:\\SOFTWARE\\DenySetValue\\TestPS\r\n                       + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    InvocationName   : New-Item\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\nPipelineIterationInfo :\r\n```\n\n<blockquote><img src=\"https://opengraph.githubassets.com/a0f737a0c1cbf9bcc9728f6a829fdc123bdaca8912e3c3994f06f9b251f7b204/dotnet/runtime\" width=\"48\" align=\"right\"><div><img src=\"https://github.githubassets.com/favicons/favicon.svg\" height=\"14\"> GitHub</div><div><strong><a href=\"https://github.com/dotnet/runtime\">runtime/Interop.RegistryConstants.cs at 57bfe474518ab5b7cfe6bf7424a79ce3af9d6657 \u00b7 dotnet/runtime</a></strong></div><div>.NET is a cross-platform runtime for cloud, mobile, desktop, and IoT apps. - runtime/Interop.RegistryConstants.cs at 57bfe474518ab5b7cfe6bf7424a79ce3af9d6657 \u00b7 dotnet/runtime</div></blockquote>",
      "created_at": "2022-03-02T13:20:15Z",
      "updated_at": "2022-03-02T13:20:18Z"
    }
  ],
  "created_at": "2022-03-01T16:53:20Z",
  "labels": [
    "Issue-Enhancement",
    "WG-Engine-Providers",
    "Needs-Triage"
  ],
  "number": 16942,
  "state": "open",
  "title": "Inconsistent behavior when using New-Item on a registry key where Set Value was denied.",
  "updated_at": "2022-03-02T13:20:30Z"
}