{
  "_url": "https://github.com/PowerShell/PowerShell/issues/7763",
  "author": "arahja",
  "body": "<!--\r\n\r\nFor Windows PowerShell 5.1 issues, suggestions, or feature requests please use the following link instead:\r\n- Windows PowerShell [UserVoice](https://windowsserver.uservoice.com/forums/301869-powershell)\r\n\r\nIf it is a bug report:\r\n- make sure you are able to repro it on the latest released version. \r\nYou can install the latest version from https://github.com/PowerShell/PowerShell/releases\r\n- Search the existing issues.\r\n- Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- Refer to the [known issues](https://docs.microsoft.com/powershell/scripting/whats-new/known-issues-ps6?view=powershell-6).\r\n- Fill out the following repro template:\r\n\r\nIf it's not a bug, please remove the template and elaborate the issue in your own words.\r\n-->\r\nThis issue happens when hosting SMA.dll.\r\n\r\nI am attempting to write a C# core program using the powershell core SDK to run powershell scripts on remote Linux systems. Running on .net core is a requirement for this project. I am trying to loosely follow a guide I found on [CodeProject](https://www.codeproject.com/Articles/773685/Enable-Remote-PowerShell-Execution-in-Csharp).\r\n\r\nSteps to reproduce\r\n------------------\r\nThis is my code:\r\n\r\n```\r\nusing System;\r\nusing System.Management.Automation;\r\nusing System.Management.Automation.Runspaces;\r\n\r\nnamespace ConsoleApp1\r\n{\r\n    class Program\r\n    {\r\n        static void Main(string[] args)\r\n        {\r\n\r\n            SSHConnectionInfo connectionInfo = new SSHConnectionInfo(userName: \"user\", computerName: \"server\", keyFilePath: \"id_rsa\");\r\n\r\n\r\n            using (Runspace runspace = RunspaceFactory.CreateRunspace(connectionInfo))\r\n            {\r\n                runspace.Open(); // The program errors out here\r\n                runspace.Close();\r\n\r\n            }\r\n\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nExpected behavior\r\n-----------------\r\n\r\n```none\r\n\r\n```\r\n\r\nActual behavior\r\n---------------\r\n\r\nThis is the error I am receiving:\r\n\r\n```\r\nUnhandled Exception: System.Management.Automation.Remoting.PSRemotingDataStructureException: An error has occurred which PowerShell cannot handle. A remote session might have ended. ---> System.ArgumentException: The path is not of a legal form.\r\nParameter name: path\r\n   at System.IO.Path.GetDirectoryName(String path)\r\n   at System.Management.Automation.Runspaces.SSHConnectionInfo.StartSSHProcess(StreamWriter& stdInWriterVar, StreamReader& stdOutReaderVar, StreamReader& stdErrReaderVar)\r\n   at System.Management.Automation.Remoting.Client.SSHClientSessionTransportManager.CreateAsync()\r\n   at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerImpl.SendNegotiationAsync(RemoteSessionState sessionState)\r\n   at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerImpl.HandleStateChanged(Object sender, RemoteSessionStateEventArgs arg)\r\n   at System.Management.Automation.ExtensionMethods.SafeInvoke[T](EventHandler`1 eventHandler, Object sender, T eventArgs)\r\n   at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerStateMachine.RaiseStateMachineEvents()\r\n   at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerStateMachine.ProcessEvents()\r\n   --- End of inner exception stack trace ---\r\n   at System.Management.Automation.Runspaces.AsyncResult.EndInvoke()\r\n   at System.Management.Automation.Runspaces.Internal.RunspacePoolInternal.EndOpen(IAsyncResult asyncResult)\r\n   at System.Management.Automation.Runspaces.Internal.RemoteRunspacePoolInternal.Open()\r\n   at System.Management.Automation.RemoteRunspace.Open()\r\n   at ConsoleApp1.Program.Main(String[] args) in C:\\ConsoleApp1\\ConsoleApp1\\Program.cs:line 18\r\nPress any key to continue . . .\r\n```\r\nand\r\n```\r\n{System.Management.Automation.Remoting.PSRemotingDataStructureException: An error has occurred which PowerShell cannot handle. A remote session might have ended. ---> System.InvalidOperationException: Failed to start the SSH client process needed for the remoting connection with error: The filename, directory name, or volume label syntax is incorrect. ---> System.ComponentModel.Win32Exception: The filename, directory name, or volume label syntax is incorrect\r\n   at System.Management.Automation.Runspaces.SSHConnectionInfo.CreateProcessWithRedirectedStd(ProcessStartInfo startInfo, SafePipeHandle& stdInPipeServer, SafePipeHandle& stdOutPipeServer, SafePipeHandle& stdErrPipeServer)\r\n   at System.Management.Automation.Runspaces.SSHConnectionInfo.StartSSHProcessImpl(ProcessStartInfo startInfo, StreamWriter& stdInWriterVar, StreamReader& stdOutReaderVar, StreamReader& stdErrReaderVar)\r\n   --- End of inner exception stack trace ---\r\n   at System.Management.Automation.Runspaces.SSHConnectionInfo.StartSSHProcessImpl(ProcessStartInfo startInfo, StreamWriter& stdInWriterVar, StreamReader& stdOutReaderVar, StreamReader& stdErrReaderVar)\r\n   at System.Management.Automation.Runspaces.SSHConnectionInfo.StartSSHProcess(StreamWriter& stdInWriterVar, StreamReader& stdOutReaderVar, StreamReader& stdErrReaderVar)\r\n   at System.Management.Automation.Remoting.Client.SSHClientSessionTransportManager.CreateAsync()\r\n   at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerImpl.SendNegotiationAsync(RemoteSessionState sessionState)\r\n   at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerImpl.HandleStateChanged(Object sender, RemoteSessionStateEventArgs arg)\r\n   at System.Management.Automation.ExtensionMethods.SafeInvoke[T](EventHandler``1 eventHandler, Object sender, T eventArgs)\r\n   at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerStateMachine.RaiseStateMachineEvents()\r\n   at System.Management.Automation.Remoting.ClientRemoteSessionDSHandlerStateMachine.ProcessEvents()\r\n   --- End of inner exception stack trace ---\r\n   at System.Management.Automation.Runspaces.AsyncResult.EndInvoke()\r\n   at System.Management.Automation.Runspaces.Internal.RunspacePoolInternal.EndOpen(IAsyncResult asyncResult)\r\n   at System.Management.Automation.Runspaces.Internal.RemoteRunspacePoolInternal.Open()\r\n   at System.Management.Automation.RemoteRunspace.Open()\r\n   at remote_powershell.Program.Main(String[] args) in C:\\Users\\arahja\\Documents\\Visual Studio 2017\\Projects\\ConsoleApp1\\ConsoleApp1\\Program.cs:line 17}\tSystem.Management.Automation.Remoting.PSRemotingDataStructureException\r\n```\r\n\r\n\r\nIt appears that my C# program is [unable to find the openssh executable](https://github.com/PowerShell/PowerShell/blob/3cc9d26bc26aeab81137a8a54b9b510b4525abe7/src/System.Management.Automation/engine/remoting/common/RunspaceConnectionInfo.cs#L2032).\r\n\r\nEnvironment data\r\n----------------\r\n\r\nInstalled Software:\r\n- PowerShell Core 6.0.2\r\n\t- Version: 6.0.2\r\n\t- Environment Path: C:\\Program Files\\PowerShell\\6.0.2\\\r\n- .net Core 2 SDK\r\n\t- Version: 2.1.201\r\n\t- Environment Path: C:\\Program Files\\dotnet\\\r\n- OpenSSH\r\n\t- Version: OpenSSH_for_Windows_7.6p1 and LibreSSL 2.6.4\r\n\t- Environment Path: C:\\Program Files\\OpenSSH\\\r\n\r\n[NuGet Packages](https://powershell.myget.org/F/powershell-core/api/v3/index.json):\r\n- Microsoft.PowerShell.SDK\r\n\t- Version: 6.0.2\r\n- System.Management.Automation\r\n\t- Version: 6.0.2\r\n\r\n----------------\r\n",
  "closed_at": null,
  "comments": [
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "PSRP over SSH depends on ssh.exe being in the path",
      "created_at": "2018-09-11T20:36:25Z",
      "updated_at": "2018-09-11T20:36:25Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Just saw the discussion on the related issue.  Seems that @PaulHigin understands the issue and will work on this.",
      "created_at": "2018-09-11T20:38:04Z",
      "updated_at": "2018-09-11T20:38:04Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I think we should classify the Issue as a bug because the scenario doesn't work as expected.",
      "created_at": "2018-09-12T04:07:50Z",
      "updated_at": "2018-09-12T04:07:50Z"
    }
  ],
  "created_at": "2018-09-11T20:29:16Z",
  "labels": [
    "Issue-Bug",
    "Issue-Discussion",
    "WG-Remoting"
  ],
  "number": 7763,
  "state": "open",
  "title": "SSH connection fails ssh command look up without default runspace",
  "updated_at": "2020-12-07T19:38:58Z"
}