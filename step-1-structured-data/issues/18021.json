{
  "_url": "https://github.com/PowerShell/PowerShell/issues/18021",
  "author": "dkaszews",
  "body": "### Prerequisites\r\n\r\n- [X] Write a descriptive title.\r\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- [X] Search the existing issues.\r\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n\r\n### Steps to reproduce\r\n\r\n`Update-Help` does not work if the provided locale is a partial match (i.e. parent) of the available one. This means that if `en-US` is available, you have to provide exactly `en-US` and cannot just do `en`. I believe this is a bug for 2 reasons:\r\n\r\n1. It Makes Sense\u2122 that if user says \"I want to use English locale\", they mean \"Any English variant will do\", not \"I want to use English not associated with any country\".\r\n2. `Update-Help` with implicit locale has mechanism to fall back to parents. That is, if you don't provide explicit `-UICulture`, it uses the system, e.g. `en-GB`, then if that fails it tries `en`. The described bug means that fallbacks will always fail, unless the module uses exactly locale `en` without any country suffix, which they never do.\r\n\r\nThis can be fixed by changing `string.Equals` to `string.Contains` or some other function in `UpdatableHelpInfo.IsCultureSupported`.\r\n\r\n### Expected behavior\r\n\r\n```console\r\n> Update-Help -Module 'Microsoft.PowerShell.Core' -SourcePath 'assets' -Force -UICulture 'en-US'\r\n> Update-Help -Module 'Microsoft.PowerShell.Core' -SourcePath 'assets' -Force -UICulture 'en'\r\n> # No error reported means success\r\n```\r\n\r\n\r\n### Actual behavior\r\n\r\n```console\r\n> Update-Help -Module 'Microsoft.PowerShell.Core' -SourcePath 'assets' -Force -UICulture 'en-US'\r\n> Update-Help -Module 'Microsoft.PowerShell.Core' -SourcePath 'assets' -Force -UICulture 'en'\r\nUpdate-Help: Failed to update Help for the module(s) 'Microsoft.PowerShell.Core' with UI culture(s) {en} : Unable to retrieve the HelpInfo XML file for UI culture en. Make sure the HelpInfoUri property in the module manifest is valid or check your network connection and then try the command again..\r\nEnglish-US help content is available and can be installed using: Update-Help -UICulture en-US.\r\n```\r\n\r\n\r\n### Error details\r\n\r\n```console\r\nType        : System.Management.Automation.ActionPreferenceStopException\r\nErrorRecord :\r\n    Exception             :\r\n        Type    : System.Exception\r\n        Message : Failed to update Help for the module(s) 'Microsoft.PowerShell.Core' with UI culture(s) {en} : Unable to retrieve the HelpInfo XML file for UI culture en. Make sure the HelpInfoUri property\r\nin the module manifest is valid or check your network connection and then try the command again..\r\n                  English-US help content is available and can be installed using: Update-Help -UICulture en-US.\r\n        HResult : -2146233088\r\n    CategoryInfo          : ResourceUnavailable: (:) [Update-Help], Exception\r\n    FullyQualifiedErrorId : UnableToRetrieveHelpInfoXml,Microsoft.PowerShell.Commands.UpdateHelpCommand\r\n    InvocationInfo        :\r\n        MyCommand        : Update-Help\r\n        ScriptLineNumber : 1\r\n        OffsetInLine     : 1\r\n        HistoryId        : 38\r\n        Line             : Update-Help -Module 'Microsoft.PowerShell.Core' -SourcePath 'assets' -Force -ErrorAction Stop -Scope 'CurrentUser' -UICulture 'en'\r\n        PositionMessage  : At line:1 char:1\r\n                           + Update-Help -Module 'Microsoft.PowerShell.Core' -SourcePath 'assets'  \u2026\r\n                           + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n        InvocationName   : Update-Help\r\n        CommandOrigin    : Internal\r\n    ScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n    PipelineIterationInfo :\r\n\r\n\r\n\r\nTargetSite  :\r\n    Name          : Invoke\r\n    DeclaringType : System.Management.Automation.Runspaces.PipelineBase, System.Management.Automation, Version=7.3.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n    MemberType    : Method\r\n    Module        : System.Management.Automation.dll\r\nMessage     : The running command stopped because the preference variable \"ErrorActionPreference\" or common parameter is set to Stop: Failed to update Help for the module(s) 'Microsoft.PowerShell.Core' with\r\nUI culture(s) {en} : Unable to retrieve the HelpInfo XML file for UI culture en. Make sure the HelpInfoUri property in the module manifest is valid or check your network connection and then try the command\r\nagain..\r\n              English-US help content is available and can be installed using: Update-Help -UICulture en-US.\r\nData        : System.Collections.ListDictionaryInternal\r\nSource      : System.Management.Automation\r\nHResult     : -2146233087\r\nStackTrace  :\r\n   at System.Management.Automation.Runspaces.PipelineBase.Invoke(IEnumerable input) in /home/dkaszews/code/PowerShell/src/System.Management.Automation/engine/hostifaces/pipelinebase.cs:line 411\r\n   at System.Management.Automation.Runspaces.Pipeline.Invoke() in /home/dkaszews/code/PowerShell/src/System.Management.Automation/engine/hostifaces/Pipeline.cs:line 528\r\n   at Microsoft.PowerShell.Executor.ExecuteCommandHelper(Pipeline tempPipeline, Exception& exceptionThrown, ExecutionOptions options) in\r\n/home/dkaszews/code/PowerShell/src/Microsoft.PowerShell.ConsoleHost/host/msh/Executor.cs:line 403\r\n```\r\n\r\n\r\n### Environment data\r\n\r\n```powershell\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.3.0-preview.3\r\nPSEdition                      Core\r\nGitCommitId                    7.3.0-preview.3-311-g7f6b78257ebecc44ca2c3847b1241e91a61d0c97\r\nOS                             Linux 5.15.0-1013-raspi #15-Ubuntu SMP PREEMPT Mon Aug 8 06:33:06 UTC 2022\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\n\r\n### Visuals\r\n\r\n_No response_",
  "closed_at": null,
  "comments": [
    {
      "author": "dkaszews",
      "author_association": "CONTRIBUTOR",
      "body": "Found reason 3: locales are compared by globbing in `UpdatableHelpSystem.CreateHelpInfo`, and if you add `\"*\"` to `currentCulture` in the glob, partial locales will work. So someone implemented it as suggested, but incorrectly\r\n```csharp\r\nIEnumerable<WildcardPattern> patternList = SessionStateUtilities.CreateWildcardsFromStrings(\r\n    globPatterns: new[] { currentCulture },\r\n    options: WildcardOptions.IgnoreCase | WildcardOptions.CultureInvariant);\r\n```",
      "created_at": "2022-09-04T18:32:48Z",
      "updated_at": "2022-09-04T18:33:19Z"
    }
  ],
  "created_at": "2022-09-03T13:24:04Z",
  "number": 18021,
  "state": "open",
  "title": "Update-Help does not work with partial locale",
  "updated_at": "2022-09-06T19:26:19Z"
}