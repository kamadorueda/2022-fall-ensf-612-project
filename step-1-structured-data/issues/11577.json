{
  "_url": "https://github.com/PowerShell/PowerShell/issues/11577",
  "author": "michaelelleby",
  "body": "<!--\r\n\r\nFor Windows PowerShell 5.1 issues, suggestions, or feature requests please use the following link instead:\r\nWindows PowerShell [UserVoice](https://windowsserver.uservoice.com/forums/301869-powershell)\r\n\r\nThis repository is **ONLY** for PowerShell Core 6 and PowerShell 7+ issues.\r\n\r\n- Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- Search the existing issues.\r\n- Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- Refer to the [known issues](https://docs.microsoft.com/powershell/scripting/whats-new/known-issues-ps6?view=powershell-6).\r\n\r\n-->\r\n\r\n# Steps to reproduce\r\n\r\n```powershell\r\n[System.AppContext]::SetSwitch(\"System.Net.Http.UseSocketsHttpHandler\", $false)\r\nInvoke-RestMethod https://www.powershellgallery.com\r\nInvoke-WebRequest https://www.powershellgallery.com\r\n```\r\n\r\n# Expected behavior\r\n\r\n```none\r\nBoth requests should return HTML from https://www.powershellgallery.com as seen when running the same cmdlets in PowerShell 5.1\r\n```\r\n\r\n# Actual behavior\r\n\r\n```none\r\nBoth requests fail:\r\nInvoke-RestMethod: Response status code does not indicate success: 407 (Proxy Authentication Required).\r\nInvoke-WebRequest: Response status code does not indicate success: 407 (Proxy Authentication Required).\r\n```\r\n\r\n# Environment data\r\n\r\n<!-- provide the output of $PSVersionTable -->\r\n\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.0.0-rc.1\r\nPSEdition                      Core\r\nGitCommitId                    7.0.0-rc.1\r\nOS                             Microsoft Windows 10.0.16299\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\nSystem proxy settings \r\n![System proxy settings](https://user-images.githubusercontent.com/6172897/72324539-7a74bd80-36ab-11ea-9135-5624a05ae2b1.png)\r\n```\r\n",
  "closed_at": null,
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Related #9533",
      "created_at": "2020-01-14T13:02:10Z",
      "updated_at": "2020-01-14T13:02:10Z"
    },
    {
      "author": "larssb",
      "author_association": "NONE",
      "body": "I also have this issue. On a system with the following characteristics:\r\n\r\n1. Proxy PAC script being used for automated system-wide proxy configuration\r\n1. `Find-Module`,`Invoke-WebRequest` and similar cmdlets work fine on PS v5.1\r\n1. The same cmdlets do not work on v7 GA\r\n\r\n---\r\n\r\n# Errors\r\n\r\nThe error is: `Invoke-WebRequest: Response status code does not indicate success: 407 (Proxy Authentication Required).` ... this is the err when `[System.AppContext]::SetSwitch(\"System.Net.Http.UseSocketsHttpHandler\", $false)` has been executed before executing e.g. `Find-Module`\r\n\r\n# Debugging\r\n\r\n1.\r\n\r\nWithout executing `[System.AppContext]::SetSwitch(\"System.Net.Http.UseSocketsHttpHandler\", $false)`.\r\n\r\n== the error is: `WARNING: Unable to resolve package source 'https://www.powershellgallery.com/api/v2'.`\r\n\r\n2.\r\n\r\nSetting:\r\n\r\n```\r\n[system.net.webrequest]::defaultwebproxy = new-object system.net.webproxy('http://IP_OF_PROXY:8080')\r\n[system.net.webrequest]::defaultwebproxy.credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials\r\n[system.net.webrequest]::defaultwebproxy.BypassProxyOnLocal = $true\r\n```\r\nin $PROFILE\r\n\r\n== **does not help**.\r\n\r\n3. \r\n\r\nTrying to manually authenticate by setting:\r\n\r\n```\r\n$WebProxy = New-Object System.Net.WebProxy(\u201chttp://IP_OF_PROXY:8080\u201d,$true)\r\n$WebClient = New-Object net.webclient\r\n$WebClient.proxy.Credentials = New-Object System.Net.NetworkCredential($username,$password)\r\n```\r\n\r\n== **does not help**\r\n\r\n4.\r\n \r\nUsing the `-Proxy` parameter on the cmdlets\r\n\r\n== **does not help**\r\n\r\n5.\r\n\r\nTried `Unregister-PSRepository -Name PSGallery` >> `Register-PSRepository -Default` \r\n\r\n== **to no avail**\r\n\r\n# Various\r\n\r\nI've read the issues referred to in this issue posting as well as:\r\n\r\n#10460 \r\n#9495 (where @SteveL-MSFT mentions this to be verified working in v7 preview 3 (I'm on v7 GA))\r\n#7827",
      "created_at": "2020-03-10T14:20:44Z",
      "updated_at": "2020-03-10T14:20:44Z"
    },
    {
      "author": "eizedev",
      "author_association": "NONE",
      "body": "Same problem as @larssb here.\r\nI tried all the solutions that are mentioned to register the PSGallery repository or using any webcmdlets in our corporate network behind a proxy but nothing helped so far for PowerShell 7.:\r\n\r\n**Important**: The **following workaround**, as mentioned from @SteveL-MSFT [here](https://github.com/PowerShell/PowerShell/issues/9495#issuecomment-515592672), works with the currently logged in user! **BUT** as soon as I start a Powershell with a different user, it doesn't work with this user anymore (no matter which user i am using). The test users are also member of the local administrator group during tests.\r\n\r\nWorkaround with current user (NOT working when starting powershell as different user):\r\n```pwsh\r\n[System.AppContext]::SetSwitch(\"System.Net.Http.UseSocketsHttpHandler\", $false)\r\nInvoke-WebRequest https://www.powershellgallery.com\r\nRegister-PSRepository -Default -Verbose\r\n```\r\n\r\n**WebRequest with different user:** \r\n\r\n```pwsh\r\n[System.AppContext]::SetSwitch(\"System.Net.Http.UseSocketsHttpHandler\", $false)\r\nInvoke-WebRequest https://www.powershellgallery.com\r\n\r\nInvoke-WebRequest: Error 12002 calling WINHTTP_CALLBACK_STATUS_REQUEST_ERROR, 'Das Zeitlimit f\u00fcr den Vorgang wurde erreicht.'.\r\n[System.AppContext]::SetSwitch(\"System.Net.Http.UseSocketsHttpHandler\", $false)\r\nInvoke-WebRequest -Uri https://www.powershellgallery.com/api/v2 -SslProtocol Tls\r\nInvoke-WebRequest: Error 12002 calling WINHTTP_CALLBACK_STATUS_REQUEST_ERROR, 'Das Zeitlimit f\u00fcr den Vorgang wurde erreicht.'.\r\n\r\n[System.AppContext]::SetSwitch(\"System.Net.Http.UseSocketsHttpHandler\", $false)\r\nInvoke-WebRequest -Uri https://www.powershellgallery.com/api/v2 -SslProtocol Tls11\r\nInvoke-WebRequest: Error 12002 calling WINHTTP_CALLBACK_STATUS_REQUEST_ERROR, 'Das Zeitlimit f\u00fcr den Vorgang wurde erreicht.'.\r\n\r\n[System.AppContext]::SetSwitch(\"System.Net.Http.UseSocketsHttpHandler\", $false)\r\nInvoke-WebRequest -Uri https://www.powershellgallery.com/api/v2 -SslProtocol Tls12\r\nInvoke-WebRequest: Error 12002 calling WINHTTP_CALLBACK_STATUS_REQUEST_ERROR, 'Das Zeitlimit f\u00fcr den Vorgang wurde erreicht.'.\r\n\r\nInvoke-WebRequest -Uri https://40.87.85.101/api/v2 -SslProtocol Tls12 -SkipCertificateCheck\r\nInvoke-WebRequest: Error 12002 calling WINHTTP_CALLBACK_STATUS_REQUEST_ERROR, 'Das Zeitlimit f\u00fcr den Vorgang wurde erreicht.'.\r\n```\r\n\r\n**What have I tested?**\r\n\r\n```pwsh\r\n$PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.0.0\r\nPSEdition                      Core\r\nGitCommitId                    7.0.0\r\nOS                             Microsoft Windows 10.0.18363\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\n```pwsh\r\nResolve-DnsName www.powershellgallery.com\r\n\r\nName                           Type   TTL   Section    NameHost\r\n----                           ----   ---   -------    --------\r\nwww.powershellgallery.com      CNAME  30    Answer     powershellgallerytrafficmanager.trafficmanager.net\r\npowershellgallerytrafficmanage CNAME  30    Answer     psg-prod-eastus.cloudapp.net\r\nr.trafficmanager.net\r\n\r\nName       : psg-prod-eastus.cloudapp.net\r\nQueryType  : A\r\nTTL        : 10\r\nSection    : Answer\r\nIP4Address : 40.87.85.101\r\n```\r\n\r\n```pwsh\r\n[System.AppContext]::SetSwitch(\"System.Net.Http.UseSocketsHttpHandler\", $false)\r\n\r\n$DefaultProxy = \"http://proxyserver:8080\"\r\n$ProxyUri = New-Object System.Uri($DefaultProxy)\r\n[System.Net.WebRequest]::DefaultWebProxy = New-Object System.Net.WebProxy ($ProxyUri, $true)\r\n[System.Net.WebRequest]::DefaultWebProxy.BypassProxyOnLocal = $true\r\n```\r\n\r\nOR\r\n\r\n```pwsh\r\n[system.net.webrequest]::defaultwebproxy = new-object system.net.webproxy('http://proxyserver:8080')\r\n```\r\n\r\nTried both - with or without setting the credential properties (we are not using any credentials for our proxy)\r\n```pwsh\r\n[System.Net.WebRequest]::DefaultWebProxy\r\n\r\nAddress               : http://proxyserver:8080/\r\nBypassProxyOnLocal    : True\r\nBypassList            : {}\r\nBypassArrayList       : {}\r\nCredentials           : System.Net.SystemNetworkCredential\r\nUseDefaultCredentials : True\r\n```\r\n\r\nor \r\n\r\n```pwsh\r\n[System.Net.WebRequest]::DefaultWebProxy\r\n\r\nAddress               : http://proxyserver:8080/\r\nBypassProxyOnLocal    : True\r\nBypassList            : {}\r\nBypassArrayList       : {}\r\nCredentials           :\r\nUseDefaultCredentials : False\r\n```\r\n\r\nMore Details:\r\n\r\n```pwsh\r\n$webclient=New-Object System.Net.WebClient\r\nPS C:\\Git> $webclient\r\n\r\nEncoding                  : System.Text.UTF8Encoding+UTF8EncodingSealed\r\nBaseAddress               :\r\nCredentials               :\r\nUseDefaultCredentials     : False\r\nHeaders                   : {}\r\nQueryString               : {}\r\nResponseHeaders           :\r\nProxy                     : System.Net.WebProxy\r\nCachePolicy               :\r\nIsBusy                    : False\r\nAllowReadStreamBuffering  : False\r\nAllowWriteStreamBuffering : False\r\nSite                      :\r\nContainer                 :\r\n\r\n\r\nPS C:\\Git> $webclient.Proxy\r\n\r\nAddress               : http://proxyserver:8080/\r\nBypassProxyOnLocal    : True\r\nBypassList            : {}\r\nBypassArrayList       : {}\r\nCredentials           :\r\nUseDefaultCredentials : False\r\n```\r\n\r\nThen:\r\n```pwsh\r\nRegister-PSRepository -Default -Verbose\r\nVERBOSE: Performing the operation \"Register Module Repository.\" on target \"Module Repository 'PSGallery' () in provider 'PowerShellGet'.\".\r\n```\r\n\r\nResult:\r\n```pwsh\r\nGet-PSRepository -Verbose\r\nWARNING: Unable to find module repositories.\r\n```\r\n\r\nI tried setting the proxy configuration through registry in HKLM/HKCU:\r\n\r\n```pwsh\r\n'HKLM:\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Internet Settings':\r\n\r\nProxyEnable   : 1\r\nProxyServer   : proxyserver:8080\r\nProxyOverride : *.local;<local>;test123\r\n\r\n\r\n'HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings':\r\n\r\nProxyEnable   : 1\r\nProxyServer   : proxyserver:8080\r\nProxyOverride : *.local;<local>;test123\r\n\r\n\r\n'HKCU:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings':\r\n\r\nProxyEnable   : 1\r\nProxyServer   : proxyserver:8080\r\nProxyOverride : *.local;<local>;test123\r\n```\r\n\r\nI tried setting and using the WinHTTP proxy configuration through netsh\r\n\r\n```pwsh\r\nnetsh winhttp import proxy source=ie\r\n\r\nAktuelle WinHTTP-Proxyeinstellungen:\r\n\r\n    Proxyserver     :  proxyserver:8080\r\n    Umgehungsliste  :  *.local;<local>;test123\r\n```\r\n\r\nAlso using the `-Proxy` parameter on the cmdlets does not help.\r\n\r\nAfter each change I tried the registration process and the `Invoke-WebRequest` again\r\n\r\nEDIT:\r\nAfter reading [this](https://github.com/PowerShell/PowerShell/issues/7827#issuecomment-435798047) from @godeater post, i tried his solution and it is **working** for the webcmdlets but NOT for `Register-PSRepository`!\r\n\r\n```pwsh\r\n$env:http_proxy = 'http://proxyserver:8080'\r\n$PSDefaultParameterValues[\"*:proxy\"]=$env:http_proxy\r\nInvoke-WebRequest -Uri https://www.powershellgallery.com/api/v2\r\n\r\nStatusCode        : 200\r\nStatusDescription : OK\r\nContent           : <?xml version=\"1.0\" encoding=\"utf-8\"?><service xml:base=\"https://www.powershellgallery.com/api/v2\" xmlns=\"http://www.w3.org/2007/app\" xmlns:atom=\"http://www.w3.org/2005/Atom\"><workspace><atom:title ty\u2026\r\nRawContent        : HTTP/1.1 200 OK\r\n                    Cache-Control: no-cache\r\n                    Date: Wed, 15 Apr 2020 10:30:00 GMT\r\n                    Pragma: no-cache\r\n                    Server: Microsoft-IIS/10.0\r\n                    X-CorrelationId: 800034b7-0006-a400-b63f-84710c7967bb\r\n                    DataServiceVersion: \u2026\r\nHeaders           : {[Cache-Control, System.String[]], [Date, System.String[]], [Pragma, System.String[]], [Server, System.String[]]\u2026}\r\nImages            : {}\r\nInputFields       : {}\r\nLinks             : {}\r\nRawContentLength  : 338\r\nRelationLink      : {}\r\n```\r\n\r\nEDIT2: \r\nMhm... The `-Proxy` parameter on `Invoke-WebRequest` is also working without setting a `PSDefaultParameterValue` for `-Proxy`, but not with `Register-PSRepository`. So not a step in the right direction after all ;-)\r\n\r\nEDIT3:\r\nI can add a second PSRepository but also get the `Unable to resolve package source` error.\r\nAfter that the Repository exists, but no module can be installed/found or anything else\r\n```pwsh\r\nRegister-PSRepository -Name 'PSGallery2' -SourceLocation 'https://www.powershellgallery.com/api/v2/' -PublishLocation 'https://www.powershellgallery.com/api/v2/package/' -ScriptSourceLocation 'https://www.powershellgallery.com/api/v2/items/psscript/' -ScriptPublishLocation 'https://www.powershellgallery.com/api/v2/package/' -InstallationPolicy Trusted -PackageManagementProvider NuGet\r\n\r\nGet-PSRepository\r\n\r\nName                      InstallationPolicy   SourceLocation\r\n----                      ------------------   --------------\r\nPSGallery2                Trusted              https://www.powershellgallery.com/api/v2/\r\n\r\nFind-Module PowershellGet -Repository \"PSGallery2\"\r\nWARNING: Unable to resolve package source 'https://www.powershellgallery.com/api/v2/'.\r\nFind-Package: C:\\program files\\powershell\\7\\Modules\\PowerShellGet\\PSModule.psm1:8873\r\nLine |\r\n8873 |          PackageManagement\\Find-Package @PSBoundParameters | Microsoft \u2026\r\n     |          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | No match was found for the specified search criteria and module name 'PowershellGet'. Try Get-PSRepository to see all available registered module repositories.\r\n``` ",
      "created_at": "2020-04-15T10:31:37Z",
      "updated_at": "2020-04-15T10:54:52Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Please download and check with latest preview version.",
      "created_at": "2020-04-15T13:11:45Z",
      "updated_at": "2020-04-15T13:11:45Z"
    },
    {
      "author": "eizedev",
      "author_association": "NONE",
      "body": "@iSazonov \r\nthanks for the reply.\r\nI installed the latest preview 1 of 7.1, deleted my powershell profile and rerun the tests (Powershell started as different user).\r\nSame behavior/problems as before. Here is a screenshot:\r\n\r\n![image](https://user-images.githubusercontent.com/6794362/79344678-6ea9c900-7f30-11ea-93ba-2e56dd08ea1c.png)\r\n\r\n(WinHTTP and SystemProxy is set)\r\n\r\nEdit: \r\n\r\nOutput from $Error:\r\n\r\n![image](https://user-images.githubusercontent.com/6794362/79345730-c5fc6900-7f31-11ea-9c0f-617f5ab44cca.png)\r\n\r\nPowershellGet:\r\n\r\n```pwsh\r\nGet-Module PowershellGet -ListAvailable\r\n\r\n\r\n    Directory: C:\\program files\\powershell\\7-preview\\Modules\r\n\r\nModuleType Version    PreRelease Name                                PSEdition ExportedCommands\r\n---------- -------    ---------- ----                                --------- ----------------\r\nScript     2.2.3                 PowerShellGet                       Desk      {Find-Command, Find-DSCResource, Find-Module, Find-RoleCapability\u2026}\r\n\r\n    Directory: C:\\Program Files\\WindowsPowerShell\\Modules\r\n\r\nModuleType Version    PreRelease Name                                PSEdition ExportedCommands\r\n---------- -------    ---------- ----                                --------- ----------------\r\nScript     2.1.2                 PowerShellGet                       Desk      {Find-Command, Find-DSCResource, Find-Module, Find-RoleCapability\u2026}\r\nScript     1.0.0.1               PowerShellGet                       Desk      {Install-Module, Find-Module, Save-Module, Update-Module\u2026}\r\n```",
      "created_at": "2020-04-15T13:47:46Z",
      "updated_at": "2020-04-15T14:00:27Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Thanks! I also #9533. I guess it is .Net Core issue. If you can create simple repo on C# you could open new issue in .Net Runtime (perhaps it already is there).",
      "created_at": "2020-04-15T17:03:13Z",
      "updated_at": "2020-04-15T17:03:13Z"
    },
    {
      "author": "eizedev",
      "author_association": "NONE",
      "body": "For me this is unfortunately a show stopper to switch completely to Powershell 7, because in my daily work I very often start the powershell as a different user and therefore have to and want to work as normal as possible. I can install the modules with my standard user account and now have written a script for it but this is of course more than annoying.\r\n\r\nIt would be great if someone had a solution or at least an info if it is not directly related to Powershell but to .NET Core, PowershellGet or similar.",
      "created_at": "2020-04-17T07:58:43Z",
      "updated_at": "2020-04-17T07:58:43Z"
    },
    {
      "author": "larssb",
      "author_association": "NONE",
      "body": "@eizedev .... maybe [this](https://github.com/PowerShell/PowerShell/issues/9495#issuecomment-627839596) could the solution for you. I can't see you mentioning anything about your environment in regards to a proxy. But, give it a look.",
      "created_at": "2020-05-13T08:40:56Z",
      "updated_at": "2020-05-13T08:40:56Z"
    },
    {
      "author": "drmiru",
      "author_association": "NONE",
      "body": "This worked for me:\r\n\r\n$proxyUri = 'http://proxy.domain.com:8080'\r\n[System.Net.Http.HttpClient]::DefaultProxy = New-Object System.Net.Webproxy($proxyUri, $true)\r\n[System.Net.Http.HttpClient]::DefaultProxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials\r\n",
      "created_at": "2020-05-25T17:23:55Z",
      "updated_at": "2020-05-25T17:23:55Z"
    },
    {
      "author": "eizedev",
      "author_association": "NONE",
      "body": "> This worked for me:\r\n> \r\n> $proxyUri = 'http://proxy.domain.com:8080' [System.Net.Http.HttpClient]::DefaultProxy = New-Object System.Net.Webproxy($proxyUri, $true) [System.Net.Http.HttpClient]::DefaultProxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials\r\n\r\nSetting the proxy for the HttpClient also works for me. You could set the proxy as in  the example above, execute your commands and the unset the proxy for HttpClient this way afterwards:\r\n\r\n`[System.Net.Http.HttpClient]::DefaultProxy = New-Object System.Net.WebProxy($null)`",
      "created_at": "2022-05-31T09:47:03Z",
      "updated_at": "2022-05-31T09:47:03Z"
    }
  ],
  "created_at": "2020-01-14T07:55:17Z",
  "labels": [
    "Issue-Question",
    "WG-Cmdlets-Utility"
  ],
  "number": 11577,
  "state": "open",
  "title": "Web cmdlets and proxy",
  "updated_at": "2022-05-31T09:47:04Z"
}