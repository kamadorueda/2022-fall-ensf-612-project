{
  "_url": "https://github.com/PowerShell/PowerShell/issues/18481",
  "author": "fredx30",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nWhen i try to typecast a converted json string (using `ConvertFrom-Json`) to a specific PsObject the json string's $schema property interfers with the class definition.\r\n\r\nBelow i set up a sample of the issue using a sample user object that has been serialised from a json file.\n\n### Expected behavior\n\n```console\nI expect typecasting any successfull `ConvertFrom-Json $string` to be type-castable into the actual object.\r\n\r\n\r\nClass User {\r\n    [ValidateNotNullOrEmpty()][string]$username\r\n    [ValidateNotNullOrEmpty()][string]$password\r\n}\r\n\r\n$user = @'\r\n{\r\n    \"$schema\": \"userConfig.json\",\r\n    \"username\": \"Bob\",\r\n    \"password\": \"The-builder-badass!\"\r\n}\r\n'@\r\n$userSchema = @'\r\n{\r\n    \"$schema\": \"https://json-schema.org/draft/2020-12/schema\",\r\n    \"title\": \"User\",\r\n    \"type\": \"object\",\r\n    \"description\": \"A username password combination.\",\r\n    \"properties\": {\r\n        \"username\": {\r\n            \"type\": \"string\"\r\n        },\r\n        \"password\": {\r\n            \"type\": \"string\"\r\n        }\r\n    },\r\n    \"required\": [\"username\",\"password\"]\r\n}\r\n'@\r\n$user | Test-Json -Schema $userSchema # This is valid json! :)\r\n\r\n$user = $user | ConvertFrom-Json\r\n$user = [User]$user\r\n# Here this raises an error because the class user does not define $schema\n```\n\n\n### Actual behavior\n\n```console\nTo get the typecast to work one needs to manually drop the `$schema` property. \r\n\r\n\r\nClass User {\r\n    [ValidateNotNullOrEmpty()][string]$username\r\n    [ValidateNotNullOrEmpty()][string]$password\r\n}\r\n\r\n$user = @'\r\n{\r\n    \"$schema\": \"userConfig.json\",\r\n    \"username\": \"Bob\",\r\n    \"password\": \"The-builder-badass!\"\r\n}\r\n'@\r\n$userSchema = @'\r\n{\r\n    \"$schema\": \"https://json-schema.org/draft/2020-12/schema\",\r\n    \"title\": \"User\",\r\n    \"type\": \"object\",\r\n    \"description\": \"A username password combination.\",\r\n    \"properties\": {\r\n        \"username\": {\r\n            \"type\": \"string\"\r\n        },\r\n        \"password\": {\r\n            \"type\": \"string\"\r\n        }\r\n    },\r\n    \"required\": [\"username\",\"password\"]\r\n}\r\n'@\r\n$user | Test-Json -Schema $userSchema # This is valid json! :)\r\n\r\n$user = $user | ConvertFrom-Json\r\n$user = [User]$user\r\n# Here this raises an error because the class user does not define $schema\r\n\r\n# A workaround to fix this is as follows:\r\n$user = $user | Select-Object -ExcludeProperty '$schema'\r\n$user = [User]$user\n```\n\n\n### Error details\n\n```console\nType           : System.Management.Automation.RuntimeException\r\nErrorRecord    :\r\n    Exception             :\r\n        Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n        Message : Cannot convert value \"@{$schema=userConfig.json; username=Bob; password=The-builder-badass!}\" to\r\ntype \"User\". Error: \"Cannot convert the \"@{$schema=userConfig.json; username=Bob; password=The-builder-badass!}\" value\r\nof type \"System.Management.Automation.PSCustomObject\" to type \"User\".\"\r\n        HResult : -2146233087\r\n    CategoryInfo          : InvalidArgument: (:) [], ParentContainsErrorRecordException\r\n    FullyQualifiedErrorId : InvalidCastConstructorException\r\n    InvocationInfo        :\r\n        ScriptLineNumber : 1\r\n        OffsetInLine     : 1\r\n        HistoryId        : -1\r\n        Line             : $user = [User]$user\r\n        PositionMessage  : At line:1 char:1\r\n                           + $user = [User]$user\r\n                           + ~~~~~~~~~~~~~~~~~~~\r\n        CommandOrigin    : Internal\r\n    ScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\nTargetSite     :\r\n    Name          : Invoke\r\n    DeclaringType : System.Management.Automation.Runspaces.PipelineBase, System.Management.Automation,\r\nVersion=7.2.7.500, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n    MemberType    : Method\r\n    Module        : System.Management.Automation.dll\r\nMessage        : Cannot convert value \"@{$schema=userConfig.json; username=Bob; password=The-builder-badass!}\" to type\r\n\"User\". Error: \"Cannot convert the \"@{$schema=userConfig.json; username=Bob; password=The-builder-badass!}\" value of\r\ntype \"System.Management.Automation.PSCustomObject\" to type \"User\".\"\r\nData           : System.Collections.ListDictionaryInternal\r\nInnerException :\r\n    Type           : System.Management.Automation.PSInvalidCastException\r\n    ErrorRecord    :\r\n        Exception             :\r\n            Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n            Message : Cannot convert value \"@{$schema=userConfig.json; username=Bob; password=The-builder-badass!}\" to\r\ntype \"User\". Error: \"Cannot convert the \"@{$schema=userConfig.json; username=Bob; password=The-builder-badass!}\" value\r\nof type \"System.Management.Automation.PSCustomObject\" to type \"User\".\"\r\n            HResult : -2146233087\r\n        CategoryInfo          : InvalidArgument: (:) [], ParentContainsErrorRecordException\r\n        FullyQualifiedErrorId : InvalidCastConstructorException\r\n        InvocationInfo        :\r\n            ScriptLineNumber : 1\r\n            OffsetInLine     : 1\r\n            HistoryId        : -1\r\n            Line             : $user = [User]$user\r\n            PositionMessage  : At line:1 char:1\r\n                               + $user = [User]$user\r\n                               + ~~~~~~~~~~~~~~~~~~~\r\n            CommandOrigin    : Internal\r\n        ScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n    TargetSite     :\r\n        Name          : Convert\r\n        DeclaringType : System.Management.Automation.LanguagePrimitives+ConvertViaNoArgumentConstructor,\r\nSystem.Management.Automation, Version=7.2.7.500, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n        MemberType    : Method\r\n        Module        : System.Management.Automation.dll\r\n    Message        : Cannot convert value \"@{$schema=userConfig.json; username=Bob; password=The-builder-badass!}\" to\r\ntype \"User\". Error: \"Cannot convert the \"@{$schema=userConfig.json; username=Bob; password=The-builder-badass!}\" value\r\nof type \"System.Management.Automation.PSCustomObject\" to type \"User\".\"\r\n    Data           : System.Collections.ListDictionaryInternal\r\n    InnerException :\r\n        Type           : System.Management.Automation.PSInvalidCastException\r\n        ErrorRecord    :\r\n            Exception             :\r\n                Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n                Message : Cannot convert the \"@{$schema=userConfig.json; username=Bob; password=The-builder-badass!}\"\r\nvalue of type \"System.Management.Automation.PSCustomObject\" to type \"User\".\r\n                HResult : -2146233087\r\n            CategoryInfo          : InvalidArgument: (:) [], ParentContainsErrorRecordException\r\n            FullyQualifiedErrorId : ConvertToFinalInvalidCastException\r\n        TargetSite     :\r\n            Name          : SetObjectProperties\r\n            DeclaringType : System.Management.Automation.LanguagePrimitives\r\n            MemberType    : Method\r\n            Module        : System.Management.Automation.dll\r\n        Message        : Cannot convert the \"@{$schema=userConfig.json; username=Bob; password=The-builder-badass!}\"\r\nvalue of type \"System.Management.Automation.PSCustomObject\" to type \"User\".\r\n        InnerException :\r\n            Type       : System.InvalidOperationException\r\n            TargetSite :\r\n                Name          : CreateMemberNotFoundError\r\n                DeclaringType : System.Management.Automation.LanguagePrimitives\r\n                MemberType    : Method\r\n                Module        : System.Management.Automation.dll\r\n            Message    : The $schema property was not found for the User object. The available property is: [username\r\n<System.String>] , [password <System.String>]\r\n            Source     : System.Management.Automation\r\n            HResult    : -2146233079\r\n            StackTrace :\r\n   at System.Management.Automation.LanguagePrimitives.CreateMemberNotFoundError(PSObject pso, DictionaryEntry\r\nproperty, Type resultType)\r\n   at System.Management.Automation.LanguagePrimitives.SetObjectProperties(Object o, IDictionary properties, Type\r\nresultType, MemberNotFoundError memberNotFoundErrorAction, MemberSetValueError memberSetValueErrorAction, Boolean\r\nenableMethodCall, IFormatProvider formatProvider, Boolean recursion, Boolean ignoreUnknownMembers)\r\n   at System.Management.Automation.LanguagePrimitives.SetObjectProperties(Object o, PSObject psObject, Type\r\nresultType, MemberNotFoundError memberNotFoundErrorAction, MemberSetValueError memberSetValueErrorAction,\r\nIFormatProvider formatProvider, Boolean recursion, Boolean ignoreUnknownMembers)\r\n        Source         : System.Management.Automation\r\n        HResult        : -2147467262\r\n        StackTrace     :\r\n   at System.Management.Automation.LanguagePrimitives.SetObjectProperties(Object o, PSObject psObject, Type\r\nresultType, MemberNotFoundError memberNotFoundErrorAction, MemberSetValueError memberSetValueErrorAction,\r\nIFormatProvider formatProvider, Boolean recursion, Boolean ignoreUnknownMembers)\r\n   at System.Management.Automation.LanguagePrimitives.ConvertViaNoArgumentConstructor.Convert(Object valueToConvert,\r\nType resultType, Boolean recursion, PSObject originalValueToConvert, IFormatProvider formatProvider, TypeTable\r\nbackupTable, Boolean ignoreUnknownMembers)\r\n    Source         : System.Management.Automation\r\n    HResult        : -2147467262\r\n    StackTrace     :\r\n   at System.Management.Automation.LanguagePrimitives.ConvertViaNoArgumentConstructor.Convert(Object valueToConvert,\r\nType resultType, Boolean recursion, PSObject originalValueToConvert, IFormatProvider formatProvider, TypeTable\r\nbackupTable, Boolean ignoreUnknownMembers)\r\n   at System.Management.Automation.LanguagePrimitives.ConvertViaNoArgumentConstructor.Convert(Object valueToConvert,\r\nType resultType, Boolean recursion, PSObject originalValueToConvert, IFormatProvider formatProvider, TypeTable\r\nbackupTable)\r\n   at CallSite.Target(Closure , CallSite , Object )\r\n   at System.Dynamic.UpdateDelegates.UpdateAndExecute1[T0,TRet](CallSite site, T0 arg0)\r\n   at System.Management.Automation.Interpreter.DynamicInstruction`2.Run(InterpretedFrame frame)\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\r\nSource         : System.Management.Automation\r\nHResult        : -2146233087\r\nStackTrace     :\r\n   at System.Management.Automation.Runspaces.PipelineBase.Invoke(IEnumerable input)\r\n   at Microsoft.PowerShell.Executor.ExecuteCommandHelper(Pipeline tempPipeline, Exception& exceptionThrown,\r\nExecutionOptions options)\n```\n\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.7\r\nPSEdition                      Core\r\nGitCommitId                    7.2.7\r\nOS                             Microsoft Windows 10.0.22621\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n![image](https://user-images.githubusercontent.com/4283527/200385147-79429494-b0e3-4404-be5e-01e7628d45a1.png)\r\n",
  "closed_at": null,
  "comments": [],
  "created_at": "2022-11-07T18:18:51Z",
  "number": 18481,
  "state": "open",
  "title": "Error on $schema property when casting from json to PSObject",
  "updated_at": "2022-11-07T22:41:52Z"
}