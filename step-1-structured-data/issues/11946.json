{
  "_url": "https://github.com/PowerShell/PowerShell/issues/11946",
  "author": "NoMoreFood",
  "body": "# PR Summary\r\n\r\nModified Start-Process such that an unspecified working directory is correctly treated as literal when being resolved.\r\n\r\nFix #11940\r\n\r\n## PR Context\r\n\r\nProblem was discovered when investigating an error that resulted from executing Start-Process in a directory that contained wildcard characters. \r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [x] None\r\n    - **OR**\r\n    - [ ] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n        - [ ] Experimental feature name(s): <!-- Experimental feature name(s) here -->\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: \r\n- **Testing - New and feature**\r\n    - [] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [x] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [x] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [ ] I have considered the user experience from a tooling perspective and enumerated concerns in the summary. This may include:\r\n        - Impact on [PowerShell Editor Services](https://github.com/PowerShell/PowerShellEditorServices) which is used in the [PowerShell extension](https://github.com/PowerShell/vscode-powershell) for VSCode (which runs in a different PS Host).\r\n        - Impact on Completions (both in the console and in editors) - one of PowerShell's most powerful features.\r\n        - Impact on [PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer) (which provides linting & formatting in the editor extensions).\r\n        - Impact on [EditorSyntax](https://github.com/PowerShell/EditorSyntax) (which provides syntax highlighting with in VSCode, GitHub, and many other editors).\r\n",
  "closed_at": "2020-06-09T17:27:54Z",
  "comments": [
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "Although it might be a grey area, this is a breaking change as it changes how the arguments passed to `WorkingDirectory`, `RedirectStandardError`, `RedirectStandardInput`, and `RedirectStandardOutput` get resolved. Need the committee to weigh in.",
      "created_at": "2020-03-13T00:57:18Z",
      "updated_at": "2020-03-13T00:57:18Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@PowerShell/powershell-committee reviewed this, we propose that instead of always treating it as a literal, we would check if the path exists as a literal use it, otherwise fallback to the current behavior",
      "created_at": "2020-03-18T22:16:25Z",
      "updated_at": "2020-03-18T22:17:11Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "How?\r\n\r\nWorking Directory by definition cannot be a useful wildcarded path, which can usually be assumed to exist. If you have an incomplete path, you can tab complete the rest. If you _really_ need wildcards for any of these, you have `Get-Item` available.\r\n\r\nRedirection paths typically won't exist for most use cases (again, no use for wildcards if the path doesn't exist), but as I understand it the cmdlet isn't capable of writing to multiple paths anyway, can it?",
      "created_at": "2020-03-18T22:46:04Z",
      "updated_at": "2020-03-18T22:48:51Z"
    },
    {
      "author": "NoMoreFood",
      "author_association": "CONTRIBUTOR",
      "body": "@vexx32 Agreed.  In fact, when I force the command to match multiple matches for output redirection, the command says: `Start-Process: Cannot perform operation because the path resolved to more than one file. This command cannot operate on multiple files.`\r\n\r\n@SteveL-MSFT Certainly can't say that makes a lot of sense to me, but I can adjust the code if that's the verdict.  Should the documentation be updated to say it \"Sort Of\" supports wildcards?  Thoughts on redirection parameters as @vexx32 mentions?",
      "created_at": "2020-03-22T20:53:36Z",
      "updated_at": "2020-03-22T20:53:36Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "> Redirection paths typically won't exist for most use cases\r\n\r\nI agree that in most use cases the redirection files for standard output/error don't exist beforehand. But `-RedirectStandardInput` by definition requires an existing file. \r\nEven for `-RedirectStandardError` and `-RedirectStandardOutput`, it's hard to say the current wildcard behavior is not being used at all. I can imagine a CI system where a new log file is created every day in the format `ci-log-<date>.txt` and output/error of a process is supposed to be written to that log file. For this hypothetical scenario, it's natural to use a wildcard like `ci-log-*.txt` for those 2 parameters (only one file, which is created on that day, will be matched). I think that's why the committee decide to suggest a more conservative (less breaking) behavior.\r\n\r\n> Working Directory by definition cannot be a useful wildcarded path, which can usually be assumed to exist.\r\n\r\nOne can create two directories named `[a]b` and `ab`. `[a]b` is a valid wildcard that matches `ab`. Again, I think the committee's suggestion is more conservative (less breaking).",
      "created_at": "2020-03-30T17:09:15Z",
      "updated_at": "2020-03-30T17:09:15Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@daxian-dbw Based on your examples I can conclude that we should first make wildcard check and then literal.",
      "created_at": "2020-03-30T17:24:03Z",
      "updated_at": "2020-03-30T17:24:03Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@iSazonov that's a valid point and would seem to be less breaking as any existing usage expecting wildcard matching would continue to work",
      "created_at": "2020-03-31T15:06:37Z",
      "updated_at": "2020-03-31T15:06:37Z"
    },
    {
      "author": "NoMoreFood",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov @SteveL-MSFT @daxian-dbw @vexx32 It appears that PathUtils.ResolvePath() is not positioned well to do the sort of trial-and-error that's discussed.  Instead of biting off that task right now, what I've done adjusted this PR's scope to address the originally reported behavior that was causing Start-Process to fail when WorkingDirectory is not specified but the current directory is set to a path that contains wildcard-type characters.  (e.g. Set-Location 'C:\\Path[]'; Start-Process cmd.exe was failing).  I _believe_ this change is non-breaking and should be non-controversial.",
      "created_at": "2020-04-03T01:26:04Z",
      "updated_at": "2020-04-03T01:26:04Z"
    },
    {
      "author": "JamesWTruher",
      "author_association": "MEMBER",
      "body": "I think there are additional problems here and definitely some holes in our testing. As the following shows:\r\n```powershell\r\nDescribe \"Should be able to set location to name with wild card\" {\r\n    BeforeAll {\r\n        $testCases = @{ Name = 'foo[' },@{ Name = 'foo]' },@{ Name = 'foo[]' }, @{ Name = 'foo?' }, @{ Name = 'foo[?]' },\r\n            @{ Name = 'foo[*]' },@{ Name = 'foo[*' },@{ Name = 'foo*]' }\r\n    }\r\n\r\n    It \"Should be able to create and set the location to <Name>\" -TestCases $testCases {\r\n        param ( $Name )\r\n\r\n        if ( $Name -match \"\\*\" -and $IsWindows ) {\r\n            Set-ItResult -Skipped -Because \"'$Name' is not supported as directory name on Windows\"\r\n            return\r\n        }\r\n        \r\n        $item = New-Item -Type Directory -Path ${TESTDRIVE}/$Name\r\n        $item.Name | Should -Be $Name\r\n        \r\n        $i = Get-Item -LiteralPath ${TESTDRIVE}/$Name\r\n        $i.Name | Should -Be $Name\r\n\r\n        $location = Get-Location\r\n        try {\r\n            Set-Location -LiteralPath ${TESTDRIVE}/$Name\r\n            $sName = [System.IO.Path]::GetFileName((Get-Location ).Path)\r\n            $sName | Should -Be $Name\r\n        }\r\n        catch {\r\n            throw \"Set-Location $Name Failed\"\r\n        }\r\n        finally { \r\n            Set-Location -LiteralPath $location.Path\r\n        }\r\n    }\r\n}\r\n```\r\nwhen run on my Mac, I get the following result\r\n```powershell\r\nDescribing Should be able to set location to name with wild card\r\n  [+] Should be able to create and set the location to foo[ 36ms\r\n  [+] Should be able to create and set the location to foo] 13ms\r\n  [+] Should be able to create and set the location to foo[] 26ms\r\n  [+] Should be able to create and set the location to foo? 28ms\r\n  [+] Should be able to create and set the location to foo[?] 41ms\r\n  [-] Should be able to create and set the location to foo[*] 56ms\r\n    Expected strings to be the same, but they were different.\r\n    Expected length: 6\r\n    Actual length:   5\r\n    Strings differ at index 4.\r\n    Expected: 'foo[*]'\r\n    But was:  'foo[]'\r\n    18:         $i.Name | Should -Be $Name\r\n    at <ScriptBlock>, /tmp/zap/tt.tests.ps1: line 18\r\n  [-] Should be able to create and set the location to foo[* 17ms\r\n    Expected strings to be the same, but they were different.\r\n    String lengths are both 5.\r\n    Strings differ at index 4.\r\n    Expected: 'foo[*'\r\n    But was:  'foo[]'\r\n    18:         $i.Name | Should -Be $Name\r\n    at <ScriptBlock>, /tmp/zap/tt.tests.ps1: line 18\r\n  [-] Should be able to create and set the location to foo*] 20ms\r\n    Expected strings to be the same, but they were different.\r\n    String lengths are both 5.\r\n    Strings differ at index 3.\r\n    Expected: 'foo*]'\r\n    But was:  'foo[]'\r\n    18:         $i.Name | Should -Be $Name\r\n    at <ScriptBlock>, /tmp/zap/tt.tests.ps1: line 18\r\n```\r\nThe files present in `$TESTDRIVE` are:\r\n```powershell\r\nPS> ls $TESTDRIVE |ft -auto\r\n\r\n    Directory: /private/tmp/ea03bb1e-4ae5-46b7-af36-6341e4015b20\r\n\r\nUnixMode   User  Group  LastWriteTime Size Name\r\n--------   ----  -----  ------------- ---- ----\r\ndrwxr-xr-x james wheel 4/8/2020 13:27   64 foo?\r\ndrwxr-xr-x james wheel 4/8/2020 13:27   64 foo[\r\ndrwxr-xr-x james wheel 4/8/2020 13:27   64 foo[?]\r\ndrwxr-xr-x james wheel 4/8/2020 13:27   64 foo[]\r\ndrwxr-xr-x james wheel 4/8/2020 13:27   64 foo[*\r\ndrwxr-xr-x james wheel 4/8/2020 13:27   64 foo[*]\r\ndrwxr-xr-x james wheel 4/8/2020 13:27   64 foo]\r\ndrwxr-xr-x james wheel 4/8/2020 13:27   64 foo*]\r\n\r\n```\r\n",
      "created_at": "2020-04-08T20:28:53Z",
      "updated_at": "2020-04-08T20:28:53Z"
    },
    {
      "author": "NoMoreFood",
      "author_association": "CONTRIBUTOR",
      "body": "@JamesWTruher Yeah, I suspected that there are going to be these sort of wildcard processing issues I located in Start-Process in other cmdlets as well.  Unless you've already dove in, I'll look into the behavior you noted as a separate PR (unless you think it's somehow related to this specific fix for Start-Process).\r\n\r\nNote, for Windows your match should be more like `$Name -match '[<>:\"/\\|?*]' -and $IsWindows` since none of these characters are supported.  When these illegal characters are eliminated, it passes on Windows but only the three test cases are executed.  I'll try on MacOS later.",
      "created_at": "2020-04-09T00:01:12Z",
      "updated_at": "2020-04-09T00:01:12Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "The more I think about wildcards in the scenario the less I like it. I'd prefer literal paths - it is unnatural behavior to expand wildcards for these paths. I can\u2019t imagine that someone selects a working directory by wildcard, and especially a redirect file. It is unreliable and unpredictable.\r\n\r\n\r\n",
      "created_at": "2020-04-09T04:49:39Z",
      "updated_at": "2020-04-09T04:49:39Z"
    },
    {
      "author": "NoMoreFood",
      "author_association": "CONTRIBUTOR",
      "body": "@JamesWTruher Reproduced your Mac results.  Set-Location -LiteralPath definitely doesn't handle processing '*' characters very well whereas the native shells do just fine.  I do believe this is a separate issue though from the one this PR addresses though.  Will look at the underlying code tomorrow to verify... ",
      "created_at": "2020-04-09T05:21:43Z",
      "updated_at": "2020-04-09T05:21:43Z"
    },
    {
      "author": "NoMoreFood",
      "author_association": "CONTRIBUTOR",
      "body": "@JamesWTruher I confirmed the behavior you reported is a different issue and is related to the code called within Set-Location that's responsible for case normalization.  I have a potential fix and will submit that separately.  Please proceed with adjudicating _this_ PR as-is.\r\n\r\nUpdate: Noted behavior is corrected in https://github.com/PowerShell/PowerShell/pull/12294.  This includes an enhanced version of your test script.",
      "created_at": "2020-04-09T23:37:00Z",
      "updated_at": "2020-04-10T23:54:57Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@PowerShell/powershell-committee reviewed this, we agree that an implicit `WorkingDirectory` should be literal and never glob, so the targeted fix is fine for this PR (not a comment on the code itself but the intent).",
      "created_at": "2020-04-15T22:37:09Z",
      "updated_at": "2020-04-15T22:37:09Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as Review Needed because it has been there has not been any activity for **7 days**.\nMainainer, Please provide feedback and/or mark it as `Waiting on Author`",
      "created_at": "2020-05-27T02:01:32Z",
      "updated_at": "2020-05-27T02:01:32Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@daxian-dbw I think the PR is ready to merge.",
      "created_at": "2020-05-29T03:18:06Z",
      "updated_at": "2020-05-29T03:18:06Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as Review Needed because it has been there has not been any activity for **7 days**.\nMainainer, Please provide feedback and/or mark it as `Waiting on Author`",
      "created_at": "2020-06-05T14:00:15Z",
      "updated_at": "2020-06-05T14:00:15Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@NoMoreFood Thanks for your contribution!",
      "created_at": "2020-06-10T04:20:55Z",
      "updated_at": "2020-06-10T04:20:55Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.1.0-preview.4` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.1.0-preview.4)\n",
      "created_at": "2020-06-25T19:08:05Z",
      "updated_at": "2020-06-25T19:08:05Z"
    }
  ],
  "created_at": "2020-02-25T01:54:49Z",
  "number": 11946,
  "state": "closed",
  "title": "Start-Process: Correct Unspecified WorkingDirectory Resolution",
  "updated_at": "2020-06-25T19:08:05Z"
}