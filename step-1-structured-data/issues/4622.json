{
  "_url": "https://github.com/PowerShell/PowerShell/issues/4622",
  "author": "markekraus",
  "body": "Closes #4609 and replaces tests for #4546.\r\n\r\nThis test uses an ASP.NET Core 2.0 app to run a simple service to echo back the client certificate details if one was  provided. If a client cert is not provided, the details are empty and the status reports FAILED. The app runs in a Job.",
  "closed_at": "2017-08-31T09:30:36Z",
  "comments": [
    {
      "author": "msftclas",
      "author_association": "NONE",
      "body": "\r\n@markekraus,\nThanks for having already signed the Contribution License Agreement. Your agreement was validated by Microsoft. We will now review your pull request.\n_Thanks,\nMicrosoft Pull Request Bot_",
      "created_at": "2017-08-20T10:45:29Z",
      "updated_at": "2017-08-20T10:45:29Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@markekraus See as we prepare TestExe.csproj https://github.com/PowerShell/PowerShell/blob/b3e7fd374f2898f7e84b28229aada18a3fcbe23e/build.psm1#L780",
      "created_at": "2017-08-20T11:24:52Z",
      "updated_at": "2017-08-20T11:24:52Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov Thanks, I'll see how I can fit this one in into `Publish-PSTestTools`\r\n\r\non another note, the `mdspell` is falsely calling out `ASP.NET` in my `README.md`. Is there place to add that to be ignored? Or is there another way to handle it?\r\n\r\nedit: I assume i can modify `.spelling` to address that.",
      "created_at": "2017-08-20T11:58:22Z",
      "updated_at": "2017-08-20T13:27:38Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Yes, it is `.spelling` - add `Asp.Net` (case-sensitive).",
      "created_at": "2017-08-20T14:25:39Z",
      "updated_at": "2017-08-20T14:25:39Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@markekraus Can we replace our `ListenerHttp` script with the application (not in the PR)?",
      "created_at": "2017-08-20T14:39:55Z",
      "updated_at": "2017-08-20T14:39:55Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov In theory we could move all of the web tests to this (with some slight modifications, such as adding a Non-HTTPS listener to it), but, it would mean rewriting the existing features of HttpListener into ASP.NET. Or doing something that allowed PowerShell to manage the business logic.\r\n\r\nI was already considering switching the `Validate Invoke-WebRequest -SkipCertificateCheck` tests over to this new listener since the ServerCert fails as a self-signed cert.",
      "created_at": "2017-08-20T14:52:38Z",
      "updated_at": "2017-08-20T16:06:26Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@markekraus Please keep the PR as small as possibly - it is better to make cleanups later.\r\n\r\nIf we can move to the new application from `HttpListener` we should ask the test area experts to  this /cc @adityapatwardhan - if it will be approved we'll review the code with the point in mind.",
      "created_at": "2017-08-20T16:27:45Z",
      "updated_at": "2017-08-20T16:27:45Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov Should I roll back the baddssl changes?  Aside from those, the rest of the changes on this PR are interdependent.\r\n\r\nCan you restart the failed Travis CI test? it failed an unrelated test due to httpbin not being unavailable.",
      "created_at": "2017-08-20T16:38:48Z",
      "updated_at": "2017-08-20T16:38:48Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@markekraus Main rule is to keep PR as small as possible and don't add unneeded changes.\r\nSo I believe, yes, we should rollback - only keep the commit for follow PR. Also you can wait conclusion from @adityapatwardhan I asked to lead this change as the test area expert.\r\nMain question now to continue the review is - do we want move our web tests from `HttpListener` in future or not.",
      "created_at": "2017-08-20T16:49:22Z",
      "updated_at": "2017-08-20T16:49:48Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "Hmm... The macOS Build is \"passing\" but in actuality it is hitting an unhandled exception and exiting without property saying it has failed. \r\n\r\nhttps://travis-ci.org/PowerShell/PowerShell/jobs/266586350#L8280\r\n\r\nEdit:\r\n\r\nIt looks like macOS has a service that binds to port 8443. I will try switching to port 8083. \r\n\r\nThe bigger mystery to me is how this managed to terminate all tests without pester complaining about it and how this managed to bubble up from a Job process into the parent process and then up to pester.\r\n\r\nEdit 2: switching the port to 8083 fixed the issue in the macOS VM.",
      "created_at": "2017-08-20T21:34:40Z",
      "updated_at": "2017-08-21T09:34:19Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "It looks like the [AppVeyor build beta.5-4786](https://ci.appveyor.com/project/PowerShell/powershell/build/6.0.0-beta.5-4786#L97) failed due to temporary issue with `powershell.myget.org`. if someone could restart the build, that would be helpful. ",
      "created_at": "2017-08-21T09:47:54Z",
      "updated_at": "2017-08-21T09:47:54Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@markekraus It seems I haven't permissions. So you can \"rename\" last commit and push - it will be restart CI jobs.",
      "created_at": "2017-08-21T10:36:42Z",
      "updated_at": "2017-08-21T10:36:42Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov Now It looks like  https://dotnetcli.azureedge.net/dotnet/Sdk/2.0.0/dotnet-dev-osx-x64.2.0.0.tar.gz has disappeared. \r\n\r\nedit: rerunning the CI was successful, but Travis CI has not updated the status in the PR due to [some issues](https://www.traviscistatus.com/incidents/tjfn9tf5vp83).",
      "created_at": "2017-08-21T12:28:01Z",
      "updated_at": "2017-08-21T13:40:58Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@iSazonov I'm going to assign this to you as you've been involved while @adityapatwardhan is taking time off",
      "created_at": "2017-08-21T16:00:23Z",
      "updated_at": "2017-08-21T16:00:23Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@SteveL-MSFT We need get approve from test area experts because of significant changes in the PR - please ping anybody if @adityapatwardhan is busy.",
      "created_at": "2017-08-21T16:49:00Z",
      "updated_at": "2017-08-21T16:49:00Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "Thanks, @markekraus  and @iSazonov for all your work on this so far.",
      "created_at": "2017-08-21T18:21:21Z",
      "updated_at": "2017-08-21T18:21:21Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "Something is amiss with macOS and the client certificate. It was working with `Get-PfxCertificate` and the `ClientCert.pfx` then it started failing without any change to the cert or the `Get-PfxCertificate`. so I switched to `GetSelfSignedCert` and it was working a few commits ago. I made change to another portion of `WebCmdlets.Tests.ps1` but didn't touch this function and now it is failing to import the certificate with this function. I'll have to find some macOS environment to troubleshoot this in. \r\n\r\nupdate: I did some testing in a sierra machine and I'm seeing issues with some passwordless pkcs12 files, even when freshly created natively on the macOS. I think this is an upstream issue with macOS itself since the issue is the same with apple's key chain. it appears to work fine with the exact same pfx is password protected. \ud83e\udd37\u200d\u2642\ufe0f I will replace the ClientCert.pfx with a password protected one and update the `GetSelfSignedCert` private function. ",
      "created_at": "2017-08-22T10:59:51Z",
      "updated_at": "2017-08-22T17:52:17Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "After moving past the password protected pfx issue, I discovered that this is still not supported on macOS\r\n\r\n`The handler does not support client authentication certificates with this combination of libcurl (7.55.1)`\r\n\r\ndotnet/corefx#9728\r\ndotnet/corefx#19718\r\n\r\nIt was missed as passing on mac because of the issue reported in #4641. The test was actually failing\r\nhttps://travis-ci.org/PowerShell/PowerShell/jobs/265494069#L8693 but the CI reported passing. Then we ultimately marked the test pending so that we could address this through #4609 \r\n\r\n@TravisEz13 @iSazonov , I'm not sure where to go from here. It looks like this is definitely still unsupported in macOS. It does work in windows and Linux. I could make this test skipped/pending on macOS, but the bigger issue of this functionality being enable but not available in macOS, I'm unsure what to do.",
      "created_at": "2017-08-22T18:35:27Z",
      "updated_at": "2017-08-22T18:37:02Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "I don't think we should create a custom solution here and it definitely looks like we are blocked on macOS.  If the error is not clear, I would file an issue to clarify the error.  Mark the tests pending referencing the most relevant issue.\r\n\r\nI see our PM, @joeyaiello  has already mentioned on https://github.com/dotnet/corefx/issues/19718 that PowerShell needs this fix.\r\n\r\n@markekraus Thanks again for all your effort.",
      "created_at": "2017-08-22T18:59:06Z",
      "updated_at": "2017-08-22T19:00:28Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@TravisEz13 The test for this are currently set to pending in master. But, without these replacement tests, there is no need to add the `HttpsListener`. Essentially, this entire PR is probably not worth merging if the tests will remain pending unless we want this PR to add the `HttpsListner` in preparation for the future with the new tests pending. Would you like to go forward with adding the `HttpsListener` or should we close this PR and save the HttpsListener for when it is needed?",
      "created_at": "2017-08-22T19:12:49Z",
      "updated_at": "2017-08-22T19:12:49Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "Sorry, I should clarify.  You should detect if the tests are running on macOS and set them to skip.  We have this pattern for windows only features in many tests.",
      "created_at": "2017-08-22T21:23:53Z",
      "updated_at": "2017-08-22T21:23:53Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "Here is an example that skips for everything that is not Windows:  https://github.com/PowerShell/PowerShell/blob/e83fcca277a9dd81d5cb2ff56002b6179c34ec3b/test/powershell/engine/Api/BasicEngine.Tests.ps1#L7",
      "created_at": "2017-08-22T21:25:15Z",
      "updated_at": "2017-08-22T21:25:15Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@TravisEz13  Thanks for clarifying. I have adjusted the tests. I still kept the changes to client cert. It at least removes that hideous base64 block from the test file.",
      "created_at": "2017-08-22T21:59:28Z",
      "updated_at": "2017-08-22T21:59:28Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@markekraus Great investigations! I think we should open new tracking Issue for the MacOs issue (not 4609) and cross reference it to 3648 (and change comments in test files).",
      "created_at": "2017-08-23T09:10:07Z",
      "updated_at": "2017-08-23T09:10:07Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov #4650 created and comments updated.",
      "created_at": "2017-08-23T09:38:06Z",
      "updated_at": "2017-08-23T09:38:06Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@markekraus Thank you for your patience and your speedy work.\r\n\r\nLGTM.",
      "created_at": "2017-08-25T13:26:19Z",
      "updated_at": "2017-08-25T13:26:19Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov Thanks for being patient with me too and for all your suggestions!",
      "created_at": "2017-08-25T13:43:03Z",
      "updated_at": "2017-08-25T13:43:03Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@iSazonov can you formally approve?",
      "created_at": "2017-08-25T16:28:07Z",
      "updated_at": "2017-08-25T16:28:07Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "It will be good to get a review from test area experts.",
      "created_at": "2017-08-25T16:47:52Z",
      "updated_at": "2017-08-25T16:47:52Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Thanks! I'll merge on next week.",
      "created_at": "2017-08-25T17:37:30Z",
      "updated_at": "2017-08-25T17:37:30Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@markekraus Many thanks for great work!\r\n\r\nThe PR was merged and  way is opened for follow work:\r\n- [ ] - Cleanup HTTPS tests, replace #region with \"Context\".\r\n- [ ] - Cleanup HTTP test to use WebListener.\r\n\r\nPlease move the points to a tracking Issue.\r\n",
      "created_at": "2017-08-31T10:02:53Z",
      "updated_at": "2017-08-31T10:02:53Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov  I have opened #4179 to track the HTTPS tests. \r\n\r\nShould I continue the work for the second item under the already open #2504 or should I create a new issue?",
      "created_at": "2017-08-31T10:10:57Z",
      "updated_at": "2017-08-31T10:10:57Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@markekraus #2504 is good. Please leave a message about WebListener there for cross reference. And if you want work on this you should ask Travis there.",
      "created_at": "2017-08-31T14:57:19Z",
      "updated_at": "2017-08-31T14:57:19Z"
    }
  ],
  "created_at": "2017-08-20T10:45:24Z",
  "number": 4622,
  "state": "closed",
  "title": "Add test WebListener module and tests for Web Cmdlet Certificate Authentication",
  "updated_at": "2017-09-22T20:36:39Z"
}