{
  "_url": "https://github.com/PowerShell/PowerShell/issues/14671",
  "author": "PsychoData",
  "body": "Request Close by default, but allow Force to still Kill directly.\r\n\r\n<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\nChange Stop-Process to attempt to [CloseMainWindow](https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.process.closemainwindow?view=netcore-3.1) by default instead of [Kill](https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.process.kill?view=netcore-3.1) directly. \r\n\r\nThis should allow the Stop-Process to enable gentler close processes for things like \r\n\r\n- Tray Agents \r\n- Office Documents \r\n- Notepad windows\r\n- Any program/window which has a state that prefers to gracefully close itself when possible\r\n\r\n## PR Context\r\n\r\nOriginally prompted from https://github.com/PowerShell/PowerShell/issues/13664. When you try to close processes with Kill, they don't have a chance to handle anything, and are immediately closed and then disposed of. In some cases like Tray agents, this even leaves behind blank whole in tray agents and other remnants behind, \r\n\r\nCloseMainWindow sends a request for the program to close, instead of forcing it to close immediately. Which gives it a chance to [handle closing](https://docs.microsoft.com/en-us/dotnet/api/system.windows.window.closing?view=netcore-3.1) and prompt for things, save state to be recoverable later, or gracefully close their active connections.\r\n\r\nFor example, closing a PowerShell ISE Window that has an unopened document gracefully will result in ISE asking to save the document, but killing it will result in immediate close of the program. \r\n\r\n![image](https://user-images.githubusercontent.com/3719116/105913389-c23a5e80-5ffa-11eb-8dd7-905d4b19dc40.png)\r\n\r\nMy changes adjust so that `Get-Process $ProcessName | Stop-Process` will default to request a graceful Close, and will only Kill the process if the program cannot handle CloseMainWindow or -Force is specified. \r\n\r\nSome useful test-cases to demonstrate this\r\n\r\n - Notepad Prompts to close if you run a gentle close Stop-Process once, but falls back to kill on trying to run a second time, because the \"Do you want to Save?\" window is Modal\r\n   - Open Notepad and enter some text but do not save. \r\n   - Run `Stop-Process -name Notepad` and it should prompt to save changes. \r\n   - Do not close the prompt to save\r\n   - Run `Stop-Process -name Notepad` a second time (while the Save prompt is still open) and it will fail to request a gentle close, and will default to Killing the process directly, without saving any changes\r\n - Microsoft Word handles the close method and prompts to save with a custom window that is not Modal and will keep accepting gentle close Stop-Process requests without forcing it to close. \r\n   - Open Microsoft Word and enter some text but do not save\r\n   - Run `Stop-Process -name winword` and it should prompt to save changes. \r\n   - Do not close the prompt to save\r\n   - Run `Stop-Process -name winword` a second time (while the Save prompt is still open) and it will still generate a gentle close and word will continue waiting for you to Save/Not Save/Cancel\r\n   - Run `Stop-Process -name winword -Force` (while the Save prompt is open or not) and it will Kill the Process directly, skipping the prompt to Save/Not Save/Cancel \r\n - When Microsoft  Outlook is sent a Close signal, it will attempt to close sessions and finish sending any items in the outbox before closing itself, but with a Kill signal it closes immediately, without exiting gracefully\r\n   - Note in the animation below, when `Stop-Process Outlook` runs without -Force there is briefly a white icon shown for Outlook, which is labeled \"Outlook is Closing\"\r\n   - But when Closed with a KILL it immediately stops \r\n\r\n![image](https://i.imgur.com/DPzHUqV.gif)\r\n\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [ ] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [ ] None\r\n    - **OR**\r\n    - [ ] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n        - [ ] Experimental feature name(s): <!-- Experimental feature name(s) here -->\r\n- **User-facing changes**\r\n    - [ ] Not Applicable\r\n    - **OR**\r\n    - [x] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n- **Testing - New and feature**\r\n    - [X] ~~N/A~~ or **can only be tested interactively**\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [ ] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [ ] I have considered the user experience from a tooling perspective and enumerated concerns in the summary. This may include:\r\n        - Impact on [PowerShell Editor Services](https://github.com/PowerShell/PowerShellEditorServices) which is used in the [PowerShell extension](https://github.com/PowerShell/vscode-powershell) for VSCode (which runs in a different PS Host).\r\n        - Impact on Completions (both in the console and in editors) - one of PowerShell's most powerful features.\r\n        - Impact on [PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer) (which provides linting & formatting in the editor extensions).\r\n        - Impact on [EditorSyntax](https://github.com/PowerShell/EditorSyntax) (which provides syntax highlighting with in VSCode, GitHub, and many other editors).\r\n",
  "closed_at": "2021-03-16T06:00:03Z",
  "comments": [
    {
      "author": "PsychoData",
      "author_association": "NONE",
      "body": "I am not certain about some of these lower items on the checklist - this should definitely need some documentation updates to explain that Stop-Process will allow Processes to attempt to close gracefully, but if you need to Force a process to close, then -Force needs to be specified. \r\n\r\nThis may be something warranting a warning/deprecation notice for a version or two, as some people may have been lazily closing without Forcing it when they should have been -Force'ing.",
      "created_at": "2021-01-26T23:46:00Z",
      "updated_at": "2021-01-26T23:46:00Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as Review Needed because it has been there has not been any activity for **7 days**.\nMaintainer, please provide feedback and/or mark it as `Waiting on Author`",
      "created_at": "2021-02-04T14:00:08Z",
      "updated_at": "2021-02-04T14:00:08Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "I don't think is consistent with the committee advise on the issue.",
      "created_at": "2021-02-18T19:07:22Z",
      "updated_at": "2021-02-18T19:07:22Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This pull request has been automatically marked as stale because it has been marked as requiring author feedback but has not had any activity for **15 days**. It will be closed if no further activity occurs **within 10 days of this comment**.",
      "created_at": "2021-03-05T20:00:04Z",
      "updated_at": "2021-03-05T20:00:04Z"
    }
  ],
  "created_at": "2021-01-26T23:42:37Z",
  "number": 14671,
  "state": "closed",
  "title": "Change Stop-Process to request Close (instead of Kill) by default",
  "updated_at": "2021-03-16T06:00:03Z"
}