{
  "_url": "https://github.com/PowerShell/PowerShell/issues/12790",
  "author": "schuelermine",
  "body": "<!--\r\n\r\nFor Windows PowerShell 5.1 issues, suggestions, or feature requests please use the following link instead:\r\nWindows PowerShell [UserVoice](https://windowsserver.uservoice.com/forums/301869-powershell)\r\n\r\nThis repository is **ONLY** for PowerShell Core 6 and PowerShell 7+ issues.\r\n\r\n- Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- Search the existing issues.\r\n- Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- Refer to the [known issues](https://docs.microsoft.com/powershell/scripting/whats-new/known-issues-ps6).\r\n\r\n-->\r\n\r\n# Steps to reproduce\r\n\r\nType the following on Windows:\r\n\r\n```powershell\r\nNew-PSDrive -Name \"Drive\" -PSProvider FileSystem -Root \"C:\\\"\r\n\r\nSet-Location \"Drive:\"\r\n```\r\n\r\nThen, something like:\r\n\r\n```powershell\r\nAdd-Content \"Example-File\" \"Example\" -WhatIf\r\n```\r\n\r\nor\r\n\r\n```powershell\r\nSet-Content \"Example-File\" \"Example\" -WhatIf\r\n```\r\n\r\n# Expected behavior\r\n\r\nOne of the following is printed in the terminal:\r\n\r\n```none\r\nWhat if: Performing the operation \"Add Content\" on target \"Path: C:\\Example-File\".\r\n```\r\nor\r\n```none\r\nWhat if: Performing the operation \"Add Content\" on target \"Path: Drive:\\Example-File\".\r\n```\r\n\r\n# Actual behavior\r\n\r\nThis is printed in the terminal:\r\n\r\n```none\r\nWhat if: Performing the operation \"Add Content\" on target \"Path: Drive:\\C:\\Example-File\".\r\n```\r\n\r\nNote the path reading `Drive:\\C:\\Example-File`.\r\n\r\n# Environment data\r\n\r\n<!-- provide the output of $PSVersionTable -->\r\n\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.0.1\r\nPSEdition                      Core\r\nGitCommitId                    7.0.1\r\nOS                             Microsoft Windows 10.0.17763\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\n# Notes\r\n\r\nThe behavior on Linux is as expected:\r\n\r\n```powershell\r\nNew-PSDrive -Name \"Drive\" -PSProvider FileSystem -Root \"/\"\r\nSet-Location \"Drive:\"\r\nAdd-Content \"Example-File\" \"Example\" -WhatIf\r\n```\r\n\r\nreturns\r\n\r\n```none\r\nWhat if: Performing the operation \"Add Content\" on target \"Path: /Example-File\".\r\n```",
  "closed_at": null,
  "comments": [
    {
      "author": "ThomasNieto",
      "author_association": "CONTRIBUTOR",
      "body": "Did some investigation on this and found the cause of the issue. This issue only occurs when the file path does not exist and if the drive name does not match the root drive. For example, if using provider qualified names or if the root is not another drive it works as expected.\r\n\r\n```powershell\r\n# File exists using provider qualified path\r\nC:\\> Set-Content -Path Microsoft.PowerShell.Core\\FileSystem::C:\\exists.txt -Value 'hello' -WhatIf\r\nWhat if: Performing the operation \"Set Content\" on target \"Path: Microsoft.PowerShell.Core\\FileSystem::C:\\exists.txt\".\r\n\r\n# File doesn't exist using provider qualified path\r\nC:\\> Set-Content -Path Microsoft.PowerShell.Core\\FileSystem::C:\\does_notexist.txt -Value 'hello' -WhatIf\r\nWhat if: Performing the operation \"Set Content\" on target \"Path: Microsoft.PowerShell.Core\\FileSystem::C:\\does_notexist.txt\".\r\n\r\n# File exists using non-drive qualified path\r\nC:\\> Set-Content -Path \\\\localhost\\c$\\exists.txt -Value 'hello' -WhatIf\r\nWhat if: Performing the operation \"Set Content\" on target \"Path: Microsoft.PowerShell.Core\\FileSystem::\\\\localhost\\c$\\exists.txt\".\r\n\r\n# File doesn't exist using non-drive qualified path\r\nC:\\> Set-Content -Path \\\\localhost\\c$\\does_notexist.txt -Value 'hello' -WhatIf\r\nWhat if: Performing the operation \"Set Content\" on target \"Path: Microsoft.PowerShell.Core\\FileSystem::\\\\localhost\\c$\\does_notexist.txt\".\r\n\r\n# File exists using drive qualified path\r\nC:\\> Set-Content -Path C:\\exists.txt -Value 'hello' -WhatIf\r\nWhat if: Performing the operation \"Set Content\" on target \"Path: C:\\exists.txt\".\r\n\r\n# File doesn't exist using drive qualified path\r\nC:\\> Set-Content -Path C:\\does_notexist.txt -Value 'hello' -WhatIf\r\nWhat if: Performing the operation \"Set Content\" on target \"Path: C:\\does_notexist.txt\".\r\n\r\n# File exists using different drive qualified (Temp: maps to C:)\r\nC:\\> Set-Content -Path Temp:\\exists.txt -Value 'hello' -WhatIf\r\nWhat if: Performing the operation \"Set Content\" on target \"Path: Temp:\\exists.txt\".\r\n\r\n# File doesn't exist using different drive qualfied (Temp: maps to C:)\r\nC:\\> Set-Content -Path Temp:\\does_notexist.txt -Value 'hello' -WhatIf\r\nWhat if: Performing the operation \"Set Content\" on target \"Path: Temp:\\C:\\does_notexist.txt\".\r\n```\r\n\r\n`GetUnresolvedProviderPathFromPSPath` calls `GetProviderSpecificPath` which uses `drive.Root` and that returns `C:\\Example-File`. Once that is returned `GetUnresolvedProviderPathFromPSPath` uses that value to create a `FileInfo` object with a path of `C:\\Example-File` and sets the drive to be `Drive`. This mismatch causes the display issue.\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/4b9b0788ed28ea6d463ce857d1ed81bd4a977a59/src/Microsoft.PowerShell.Commands.Management/commands/management/ContentCommandBase.cs#L648-L661\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/4b9b0788ed28ea6d463ce857d1ed81bd4a977a59/src/System.Management.Automation/namespaces/LocationGlobber.cs#L2337-L2337",
      "created_at": "2020-10-20T01:23:13Z",
      "updated_at": "2020-10-20T01:23:13Z"
    },
    {
      "author": "ThomasNieto",
      "author_association": "CONTRIBUTOR",
      "body": "@vexx32 have an idea on the proper way to fix this? `path` on line 650 is `Drive:\\Example-File`. Once `GetUnresolvedProviderPathFromPSPath` is called it gets changed to `C:\\Example-File` due to line 2337 where `drive.Root` is used. However, `drive` on 657 is still pointing to `Drive:` instead of `C:`.",
      "created_at": "2020-10-20T21:08:26Z",
      "updated_at": "2020-10-20T21:08:26Z"
    }
  ],
  "created_at": "2020-05-25T23:46:23Z",
  "labels": [
    "Issue-Bug",
    "OS-Windows",
    "Up-for-Grabs",
    "WG-Engine-Providers"
  ],
  "number": 12790,
  "state": "open",
  "title": "WhatIf on file content manipulation cmdlets returns incorrect summary when in custom drive on Windows",
  "updated_at": "2020-10-20T21:08:26Z"
}