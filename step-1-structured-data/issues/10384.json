{
  "_url": "https://github.com/PowerShell/PowerShell/issues/10384",
  "author": "KirkMunro",
  "body": "# Steps to reproduce\r\n\r\nWhile working on #10338, I added a placeholder for future tests that I was going to add related to a new Experimental Feature. The reason for the \"future\" tests were because the initial PR work was to add SDK functionality, and then a follow-up PR was going to add parameters to some cmdlets that could be tested if the Experimental Feature was enabled. It turns out that if you do this, you'll get failures from a test in the `test\\powershell\\engine\\ExperimentalFeature\\Get-ExperimentalFeature.Tests.ps1` file on each of the platforms, and you may see a failure on a test in the `test\\powershell\\Modules\\Microsoft.PowerShell.Core\\CompatiblePSEditions.Module.Tests.ps1` file on the Windows platform as well.\r\n\r\nHere are the contents of my `test/tools/TestMetadata.json` file that resulted in the unexpected CI failures:\r\n\r\n```powershell\r\n{\r\n  \"ExperimentalFeatures\": {\r\n    \"ExpTest.FeatureOne\": [ \"test/powershell/engine/ExperimentalFeature/ExperimentalFeature.Basic.Tests.ps1\" ],\r\n    \"PSManageBreakpointsInRunspace\": [],\r\n    \"PSForEachObjectParallel\": [ \"test/powershell/Modules/Microsoft.PowerShell.Utility/Foreach-Object-Parallel.Tests.ps1\", \"test/powershell/Modules/Microsoft.PowerShell.Security/ConstrainedLanguageRestriction.Tests.ps1\" ]\r\n  }\r\n}\r\n```\r\n\r\n# Expected behavior\r\n\r\nThe CI tests should pass.\r\n\r\n# Actual behavior\r\n\r\nYou'll see failures like the following:\r\n\r\n```none\r\n@KirkMunro, your last commit had 2 failures in PowerShell-CI-windows\r\nPSModulePath changes interacting with other PowerShell processes.System32 module path prepended to PSModulePath.Allows PowerShell subprocesses to call core modules\r\n\r\nExpected $null, but got @(Get-ChildItem : The 'Get-ChildItem' command was found in the module 'Microsoft.PowerShell.Management', but the module could not be loaded. For more information, run 'Import-Module Microsoft.PowerShell.Management'., At line:1 char:1, + Get-ChildItem, + ~~~~~~~~~~~~~, + CategoryInfo          : ObjectNotFound: (Get-ChildItem:String) [], CommandNotFoundException, + FullyQualifiedErrorId : CouldNotAutoloadMatchingModule,  ).\r\nat <ScriptBlock>, D:\\a\\1\\s\\test\\powershell\\Modules\\Microsoft.PowerShell.Core\\CompatiblePSEditions.Module.Tests.ps1: line 353\r\n353:             $errors | Should -Be $null\r\n\r\nDefault enablement of Experimental Features.On preview builds, Experimental Features are enabled\r\n\r\nExpected: Feature PSCommandNotFoundSuggestion to be Enabled\r\nat <ScriptBlock>, D:\\a\\1\\s\\test\\powershell\\engine\\ExperimentalFeature\\Get-ExperimentalFeature.Tests.ps1: line 176\r\n176:             $expFeature.Enabled | Should -BeEnabled -Name $expFeature.Name\r\n```\r\n\r\n# Environment data\r\n\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.0.0-preview.2\r\nPSEdition                      Core\r\nGitCommitId                    7.0.0-preview.2-80-g93fff6de2121ab25144f5921c1c2d1aa71536bce\r\nOS                             Microsoft Windows 10.0.17763\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n",
  "closed_at": "2019-08-21T20:14:21Z",
  "comments": [
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "An empty array is not a place holder.\r\nFor each key-value pair in `TestMetadata.json`, CI will start a pwsh session with only that feature enabled, and then run the specified tests:\r\n - if the value is a non-empty array, run the tests defined in the array.\r\n - if the value is an empty array, run all powershell tests.\r\n\r\nSo, `\"PSManageBreakpointsInRunspace\": []` means starting a pwsh session with only the experimental feature `PSManageBreakpointsInRunspace` turned on, and then run all powershell tests in that session.\r\n\r\nFor the failure in `Get-ExperimentalFeature.Tests.ps1`, the corresponding tests were added recently after enabling all experimental features by default for preview releases. It assumes all experimental features should be enabled, and thus will fail with only `PSManageBreakpointsInRunspace` is turned on. No idea about the `CompatiblePSEditions.Module.Tests.ps1` failure though, it looks to me unrelated to any experimental feature.\r\n\r\nGiven that now all experimental features are enabled by default except for official release, there is no point to depend on `TestMetadata.json` for testing an experimental feature. The only purpose of it is to test the experimental feature infrastructure itself. However, tests for all experimental features should check if the expected feature is enabled, and skip the tests if not.",
      "created_at": "2019-08-20T07:22:51Z",
      "updated_at": "2019-08-20T07:22:51Z"
    },
    {
      "author": "KirkMunro",
      "author_association": "CONTRIBUTOR",
      "body": "Thank you for these details @daxian-dbw, they are very helpful.\r\n\r\n> An empty array is not a place holder.\r\n> For each key-value pair in `TestMetadata.json`, CI will start a pwsh session with only that feature enabled, and then run the specified tests:\r\n> \r\n>     * if the value is a non-empty array, run the tests defined in the array.\r\n> \r\n>     * if the value is an empty array, run all powershell tests.\r\n\r\nCan we add to that support for if the value is `$null` don't run any specific PowerShell tests? That could allow for identification that an Experimental Feature requires some manual testing.\r\n\r\n> So, \"PSManageBreakpointsInRunspace\": [] means starting a pwsh session with only the experimental feature PSManageBreakpointsInRunspace turned on, and then run all powershell tests in that session.\r\n\r\nI don't think many contributors are aware of that. It would be great if that behavior was documented in the Experimental Feature documentation. \r\n\r\n> No idea about the CompatiblePSEditions.Module.Tests.ps1 failure though, it looks to me unrelated to any experimental feature.\r\n\r\nThat's what I thought as well, yet that failure went away when I removed my update to `TestMetadata.json`. \ud83e\udd37\u200d\u2642 \r\n\r\n> Given that now all experimental features are enabled by default except for official release, there is no point to depend on TestMetadata.json for testing an experimental feature. The only purpose of it is to test the experimental feature infrastructure itself. However, tests for all experimental features should check if the expected feature is enabled, and skip the tests if not.\r\n\r\nThere is a minor issue with this: I discovered some tests that should have been skipped if an experimental feature was not enabled were accidentally enabled (and failing) all the time because of how I configured `TestMetadata.json`. Since tests are not just run in CI, but also in dev environments, I think all experimental feature test files (as identified in `TestMetadata.json`) should be run with experimental features disabled.\r\n\r\nNow that we're running tests with all experimental features on by default in preview builds, we should still depend on `TestMetadata.json`, but in the opposite way: use it to identify test files related to experimental features, and run those tests explicitly with all experimental features disabled. That will allow CI to catch Pester test issues early so that they don't impact other developers.",
      "created_at": "2019-08-20T13:58:34Z",
      "updated_at": "2019-08-20T13:58:34Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "> I don't think many contributors are aware of that. It would be great if that behavior was documented in the Experimental Feature documentation.\r\n\r\nAbsolutely. I will update the [`testing-guidelines`](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md) shortly after.\r\n\r\n> Can we add to that support for if the value is `$null` don't run any specific PowerShell tests? That could allow for identification that an Experimental Feature requires some manual testing.\r\n\r\nI'm not sure about the the usefulness of this setting because no one will monitor `TestMetadata.json` to track what experimental features requires manual testing.\r\n\r\n> we should still depend on TestMetadata.json, but in the opposite way: use it to identify test files related to experimental features, and run those tests explicitly with all experimental features disabled. That will allow CI to catch Pester test issues early so that they don't impact other developers.\r\n\r\nI agree that we should have a way to catch the experimental feature tests that do not skip tests appropriately when the corresponding feature is disabled. But `TestMetadata.json` cannot be simply used in the opposite way for this because we still depend on its current behavior to test the experimental feature infrastructure itself -- `ExpTest.FeatureOne` is not a real experimental feature that would be enabled by default, but a fake one only to test the experimental feature code. Having the developers to update the corresponding book-keeping file for the experimental feature tests to be added will also be a problem, as the tests will run by default and there won't be a reason to force them to update a file like `TestMetadata.json`.",
      "created_at": "2019-08-20T21:55:19Z",
      "updated_at": "2019-08-20T21:55:19Z"
    },
    {
      "author": "KirkMunro",
      "author_association": "CONTRIBUTOR",
      "body": "Ok. I'm going to close this out since you're going to update the `testing-guidelines` doc, and this is really a non-issue based on the additional information you provided (thanks for that).",
      "created_at": "2019-08-21T20:14:21Z",
      "updated_at": "2019-08-21T20:14:21Z"
    }
  ],
  "created_at": "2019-08-19T22:29:33Z",
  "labels": [
    "Issue-Question",
    "WG-Quality-Test",
    "Resolution-Answered"
  ],
  "number": 10384,
  "state": "closed",
  "title": "If you put a placeholder ExperimentalFeature in test/tools/TestMetadata.json with an empty array of test files, unrelated Pester tests will fail",
  "updated_at": "2019-08-23T10:55:59Z"
}