{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17549",
  "author": "ThomasNieto",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nI was writing a cmdlet in c# using both a custom argument completer and validator in VS Code. I noticed that a `ValidationMetadata` exception was being thrown when tab completing a partially complete parameter value. The `Validate` method is only getting called when the cmdlet has `IDynamicParameters` interface implemented. Some further details is that I can only see the exception when using the VS Code debugger, it seems like PowerShell console catches it as its not reported to console or in `Get-Error`.\r\n\r\n```powershell\r\n# Works as expected\r\nTest-Validate -Value Po{TAB}\r\n\r\n# Throws an error\r\nTest-ValidateDynamic -Value Po{TAB}\r\n```\r\n\r\n```csharp\r\nusing System.Collections;\r\nusing System.Collections.Generic;\r\nusing System.Management.Automation;\r\nusing System.Management.Automation.Language;\r\n\r\nnamespace Test\r\n{\r\n    [Cmdlet(VerbsDiagnostic.Test, \"Validate\")]\r\n    public class TestValidateCommand : PSCmdlet\r\n    {\r\n        [Parameter()]\r\n        [ArgumentCompleter(typeof(ValueCompleter))]\r\n        [ValidateValue]\r\n        public string Value { get; set; } = string.Empty;\r\n    }\r\n\r\n    [Cmdlet(VerbsDiagnostic.Test, \"ValidateDynamic\")]\r\n    public class TestValidateDynamicCommand : PSCmdlet, IDynamicParameters\r\n    {\r\n        [Parameter()]\r\n        [ArgumentCompleter(typeof(ValueCompleter))]\r\n        [ValidateValue]\r\n        public string Value { get; set; } = string.Empty;\r\n\r\n        public object GetDynamicParameters()\r\n        {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    public class ValidateValueAttribute : ValidateArgumentsAttribute\r\n    {\r\n        protected override void Validate(object arguments, EngineIntrinsics engineIntrinsics)\r\n        {\r\n            bool found = false;\r\n\r\n            foreach (var value in BusinessLogic.GetResults())\r\n            {\r\n                if (arguments.ToString().ToLower() == value.ToLower())\r\n                {\r\n                    found = true;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (!found)\r\n            {\r\n                throw new ValidationMetadataException();\r\n            }\r\n        }\r\n    }\r\n\r\n    public class ValueCompleter : IArgumentCompleter\r\n    {\r\n        public IEnumerable<CompletionResult> CompleteArgument(string commandName,\r\n                                                              string parameterName,\r\n                                                              string wordToComplete,\r\n                                                              CommandAst commandAst,\r\n                                                              IDictionary fakeBoundParameters)\r\n        {\r\n            var pattern = new WildcardPattern($\"{wordToComplete}*\", WildcardOptions.IgnoreCase);\r\n            \r\n            foreach (var result in BusinessLogic.GetResults())\r\n            {\r\n                if (pattern.IsMatch(result))\r\n                {\r\n                    yield return new CompletionResult(result);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public static class BusinessLogic\r\n    {\r\n        private static readonly string[] Results = new string[] { \"PowerShell\", \"Bash\", \"Python\" };\r\n        \r\n        public static IEnumerable<string> GetResults()\r\n        {\r\n            // Place code here to get dynamic runtime values\r\n            foreach (var item in Results)\r\n            {\r\n                yield return item;\r\n            }\r\n        }\r\n    }\r\n}\r\n```\n\n### Expected behavior\n\n```console\nValidate method should not be called during tab completion.\n```\n\n\n### Actual behavior\n\n```console\nValidate method is being called during tab completion.\n```\n\n\n### Error details\n\n_No response_\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.4\r\nPSEdition                      Core\r\nGitCommitId                    7.2.4\r\nOS                             Microsoft Windows 10.0.19043\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": null,
  "comments": [],
  "created_at": "2022-06-21T05:25:19Z",
  "labels": [
    "Needs-Triage",
    "WG-Engine-Module"
  ],
  "number": 17549,
  "state": "open",
  "title": "IDynamicParameters triggers ValidateArgumentsAttribute.Validate method on tab completion",
  "updated_at": "2022-07-25T16:37:13Z"
}