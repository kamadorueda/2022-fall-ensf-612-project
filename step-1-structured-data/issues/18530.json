{
  "_url": "https://github.com/PowerShell/PowerShell/issues/18530",
  "author": "masaru-iritani",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\n`Cert:\\` PSDrive provided by Certificate provider is unavailable on PowerShell 5.1 launched by cmd.exe if and only if the cmd.exe was launched on PowerShell 7.3. This issue causes an error on running a batch script which launches PowerShell 5.1.\r\n\r\nAlthough this issue happens on PowerShell 5.1, I file it for PowerShell 7.3 because it is reproduced only when cmd.exe is launched on PowerShell 7.3.\r\n\r\n| Environment | Issue |\r\n|:-:|:-:|\r\n| PS 5.1 | Not repro |\r\n| PS 5.1 on PS 7.3 | Not repro |\r\n| PS 5.1 on cmd on PS 5.1 | Not repro |\r\n| PS 5.1 on cmd on PS 7.2.7 | Not repro |\r\n| PS 5.1 on cmd on PS 7.3 | Repro |\r\n\n\n### Expected behavior\n\n```console\nPS> cmd /c C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -NoProfile -Command Get-PSDrive\r\n\r\nName           Used (GB)     Free (GB) Provider      Root               CurrentLocation\r\n----           ---------     --------- --------      ----               ---------------\r\nAlias                                  Alias\r\nC                 445.17         30.10 FileSystem    C:\\                ..._7.3.0.0_x64__8wekyb3d8bbwe\r\nCert                                   Certificate   \\\r\nD                 906.38         25.13 FileSystem    D:\\\r\nE                   0.06          0.42 FileSystem    E:\\\r\nEnv                                    Environment\r\nFunction                               Function\r\nHKCU                                   Registry      HKEY_CURRENT_USER\r\nHKLM                                   Registry      HKEY_LOCAL_MACHINE\r\nVariable                               Variable\r\nWSMan                                  WSMan\n```\n\n\n### Actual behavior\n\n```console\nPS> cmd /c C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -NoProfile -Command Get-PSDrive\r\n\r\nName           Used (GB)     Free (GB) Provider      Root               CurrentLocation\r\n----           ---------     --------- --------      ----               ---------------\r\nAlias                                  Alias\r\nC                 445.17         30.10 FileSystem    C:\\                ..._7.3.0.0_x64__8wekyb3d8bbwe\r\nCert                                   Certificate   \\\r\nD                 906.38         25.13 FileSystem    D:\\\r\nE                   0.06          0.42 FileSystem    E:\\\r\nEnv                                    Environment\r\nFunction                               Function\r\nHKCU                                   Registry      HKEY_CURRENT_USER\r\nHKLM                                   Registry      HKEY_LOCAL_MACHINE\r\nVariable                               Variable\r\nWSMan                                  WSMan\n```\n\n\n### Error details\n\n```console\nNo error is returned.\n```\n\n\n### Environment data\n\n```powershell\nPS> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.3.0\r\nPSEdition                      Core\r\nGitCommitId                    7.3.0\r\nOS                             Microsoft Windows 10.0.22623\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n[CertPSDriveUnavailable.zip](https://github.com/PowerShell/PowerShell/files/9985850/CertPSDriveUnavailable.zip) is a step recording capturing following steps.\r\n1. Launch PowerShell 7.3 with no profile.\r\n2. Run \"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -NoProfile -Command Get-PSDrive\" and get Cert PSDrive as expected.\r\n3. Run \"cmd /c C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -NoProfile -Command Get-PSDrive\" and get **no Cert PSDrive**.",
  "closed_at": null,
  "comments": [
    {
      "author": "dwtaber",
      "author_association": "CONTRIBUTOR",
      "body": "It looks like this bug was introduced in 7.3.0-preview.7.  More specifically, I believe it was introduced by #16355.  Check this out:\r\n\r\n```\r\nPS7.3> cmd /c powershell -noprofile\r\nWindows PowerShell\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\nPS5.1> Get-PSDrive cert\r\nGet-PSDrive : Cannot find drive. A drive with the name 'cert' does not exist.\r\nAt line:1 char:1\r\n+ Get-PSDrive cert\r\n+ ~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : ObjectNotFound: (cert:String) [Get-PSDrive], DriveNotFoundException\r\n    + FullyQualifiedErrorId : GetLocationNoMatchingDrive,Microsoft.PowerShell.Commands.GetPSDriveCommand\r\n\r\nPS5.1> Import-Module Microsoft.PowerShell.Security\r\nImport-Module : The following error occurred while loading the extended type data file: Error in TypeData \"System.Security.AccessControl.ObjectSecurity\":\r\nThe member AuditToString is already present.\r\nError in TypeData \"System.Security.AccessControl.ObjectSecurity\": The member AccessToString is already present.\r\nError in TypeData \"System.Security.AccessControl.ObjectSecurity\": The member Sddl is already present.\r\nError in TypeData \"System.Security.AccessControl.ObjectSecurity\": The member Access is already present.\r\nError in TypeData \"System.Security.AccessControl.ObjectSecurity\": The member Group is already present.\r\nError in TypeData \"System.Security.AccessControl.ObjectSecurity\": The member Owner is already present.\r\nError in TypeData \"System.Security.AccessControl.ObjectSecurity\": The member Path is already present.\r\nAt line:1 char:1\r\n+ Import-Module Microsoft.PowerShell.Security\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : InvalidOperation: (:) [Import-Module], RuntimeException\r\n    + FullyQualifiedErrorId : FormatXmlUpdateException,Microsoft.PowerShell.Commands.ImportModuleCommand\r\n\r\nPS5.1> Import-Module Microsoft.PowerShell.Security -RequiredVersion 3.0.0.0\r\nPS5.1> Get-PSDrive cert\r\n\r\nName           Used (GB)     Free (GB) Provider      Root                                                                                   CurrentLocation\r\n----           ---------     --------- --------      ----                                                                                   ---------------\r\nCert                                   Certificate   \\\r\n\r\n```\r\n\r\nHere's what I think is happening: PowerShell 7 modifies the value of `PSModulePath` for the special case of [launching Windows PowerShell from PowerShell 7](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_psmodulepath?view=powershell-7.3#starting-windows-powershell-from-powershell-7).  In this scenario, however, PowerShell 7 is launching `cmd`, not `PowerShell.exe`, so the special handling of `PSModulePath` doesn't happen, and Windows PowerShell launches with PowerShell 7 modules in its `PSModulePath`.  (What initially tipped me off was the surprise of seeing history-based prediction in Windows PowerShell.)\r\n\r\nSince the PowerShell 7 version of `Microsoft.PowerShell.Security` is the latest version available to it in this scenario, that's what Windows PowerShell tries to load.  Until 7.3.0-preview.7, Windows PowerShell was able to load this PowerShell 7 module.  Now, when it tries to import the PowerShell 7 version, it throws errors for the types that were moved into the module in #16355.\r\n\r\nIn the meantime, as a workaround, if you're able to modify the scripts that started failing on you, have them explicitly import version 3.0.0.0 of `Microsoft.PowerShell.Security` before attempting to access `cert:\\`",
      "created_at": "2022-11-12T10:14:27Z",
      "updated_at": "2022-11-12T10:14:27Z"
    }
  ],
  "created_at": "2022-11-11T02:38:43Z",
  "number": 18530,
  "state": "open",
  "title": "Cert:\\ PSDrive is unavailable on PowerShell 5.1 launched by cmd when cmd is launched on PowerShell 7.3",
  "updated_at": "2022-11-12T10:14:27Z"
}