{
  "_url": "https://github.com/PowerShell/PowerShell/issues/3867",
  "author": "daxian-dbw",
  "body": "Issue Summary\r\n----------------\r\nMy `prompt` function returns a multi-line string. On Linux, when typing any input, `PSReadline` tries to render the whole prompt string again, instead of just the portion that is shown on the current line, which results in a bad prompt:\r\n![image](https://cloud.githubusercontent.com/assets/127450/26474399/c046913c-4165-11e7-9eac-c340db738efb.png)\r\n\r\nFix\r\n---\r\nCheck whether the prompt is multi-line or not. If it is, then only use the part that is shown in the input line.\r\n\r\nAdditional Info\r\n----------------\r\nI am using VT100 escape sequences to colorize my prompt string, and I found that PSReadline doesn't work with VT100 on Unix, because it's calling `Console.Write(Char)` instead of `Console.Write(String)` (see code [here](https://github.com/PowerShell/PowerShell/blob/master/src/Microsoft.PowerShell.PSReadLine/ConsoleLib.cs#L1048)). I tried to fix that along with this PR, but it turns out to be not trivial, so I will postpone that fix to another PR.\r\nSince PSReadline doesn't work with VT100 on Unix yet, you need to make sure that the part of the prompt string shown on the input line does not contain any escape sequences. Otherwise, you will see random characters like in the above screenshot.\r\n\r\nPrompt function I use on Unix\r\n---------------------------------\r\nI think it would be useful to share the prompt function I'm using on Unix. It works fine with this fix.\r\n```\r\nfunction Prompt\r\n{\r\n    $id = 1\r\n    $historyItem = Get-History -Count 1\r\n    if ($historyItem)\r\n    {\r\n        $id = $historyItem.Id + 1\r\n    }\r\n\r\n    if ($host.UI.SupportsVirtualTerminal)\r\n    {\r\n        $CSI = [char]0x1b + '['\r\n        \"${CSI}00m${CSI}01;30m[$($executionContext.SessionState.Path.CurrentLocation)]${CSI}00m`nPS:${id}$('>' * ($nestedPromptLevel + 1)) \"\r\n    }\r\n    else\r\n    {\r\n        \r\n        Write-Host -ForegroundColor DarkGray \"[$($executionContext.SessionState.Path.CurrentLocation)]\"\r\n        \"PS:$id$('>' * ($nestedPromptLevel + 1)) \"\r\n    }\r\n}\r\n```",
  "closed_at": "2017-05-26T00:26:40Z",
  "comments": [
    {
      "author": "vors",
      "author_association": "COLLABORATOR",
      "body": "Yay! ref to the PSReadLine issue https://github.com/lzybkr/PSReadLine/issues/470",
      "created_at": "2017-05-25T23:53:25Z",
      "updated_at": "2017-05-25T23:53:25Z"
    }
  ],
  "created_at": "2017-05-25T23:47:25Z",
  "number": 3867,
  "state": "closed",
  "title": "Make PSReadline render correct portion of prompt on Unix when it's a multi-line string",
  "updated_at": "2017-05-26T00:26:43Z"
}