{
  "_url": "https://github.com/PowerShell/PowerShell/issues/8346",
  "author": "adamgauthier",
  "body": "## PR Summary\r\n\r\nThis PR removes a workaround that was added because of a bug in the underlying json deserializing library [Newtonsoft.Json](https://github.com/JamesNK/Newtonsoft.Json).\r\n\r\nIt is no longer required as [the bug](https://github.com/JamesNK/Newtonsoft.Json/issues/1321) has been fixed in [Newtonsoft.Json 10.0.3](https://github.com/JamesNK/Newtonsoft.Json/releases/tag/10.0.3), see fix [here](https://github.com/JamesNK/Newtonsoft.Json/commit/1a0ae2a42ddd69f2584424731ae3212363a2bd5c).\r\n\r\nThis workaround was added in #3823 and involves using a regex to detect a json array and calling `JArray.Parse` before deserialization to throw an exception on an invalid array. As a result, removing it will increase `ConvertFrom-Json` & `Invoke-RestMethod` performance. \r\n\r\n### Current behavior\r\n```powershell\r\nPS D:\\> ConvertFrom-Json '[\"1\",'\r\nConvertFrom-Json : Conversion from JSON failed with error: Unexpected end of content while loading JArray. Path '[0]', line 1, position 5.\r\nAt line:1 char:1\r\n+ ConvertFrom-Json '[\"1\",'\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : NotSpecified: (:) [ConvertFrom-Json], ArgumentException\r\n+ FullyQualifiedErrorId : System.ArgumentException,Microsoft.PowerShell.Commands.ConvertFromJsonCommand\r\n```\r\n\r\n\r\n### After workaround removal\r\n```powershell\r\nPS D:\\> ConvertFrom-Json '[\"1\",'\r\nConvertFrom-Json : Conversion from JSON failed with error: Unexpected end when reading token. Path ''.\r\nAt line:1 char:1\r\n+ ConvertFrom-Json '[\"1\",'\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : NotSpecified: (:) [ConvertFrom-Json], ArgumentException\r\n+ FullyQualifiedErrorId : System.ArgumentException,Microsoft.PowerShell.Commands.ConvertFromJsonCommand\r\n```\r\n\r\n## PR Checklist\r\n\r\n- [X] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [X] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [X] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [X] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [X] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` to the beginning of the title and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [X] Not Applicable\r\n- **Testing - New and feature**\r\n    - [X] Not Applicable or can only be tested interactively\r\n",
  "closed_at": "2018-11-30T11:49:34Z",
  "comments": [
    {
      "author": "adamgauthier",
      "author_association": "CONTRIBUTOR",
      "body": "@PaulHigin done!",
      "created_at": "2018-11-29T02:15:57Z",
      "updated_at": "2018-11-29T02:15:57Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@louistio Thanks for your contribution!",
      "created_at": "2018-11-30T11:49:51Z",
      "updated_at": "2018-11-30T11:49:51Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "It looks to me this PR causes the following feature-level test to fail:\r\nhttps://github.com/PowerShell/PowerShell/blob/3794a5e39f31ebacfc2ec2e9ad687c9bf3772cba/test/powershell/Modules/Microsoft.PowerShell.Utility/Pester.Commands.Cmdlets.Json.Tests.ps1#L1446-L1459\r\n\r\nThis PR didn't have [feature] tag in commit message, so the feature-level tests didn't run.\r\n\r\nHere is the failure:\r\n```\r\n2018-11-30T19:46:25.1215536Z     [-] ConvertFrom-Json deserializes an array of PSObjects (in multiple lines) as a single string. 32ms\r\n2018-11-30T19:46:25.1604605Z       JsonSerializationException: Unexpected end when reading JSON. Path '', line 1, position 3.\r\n2018-11-30T19:46:25.1617847Z       ArgumentException: Conversion from JSON failed with error: Unexpected end when reading JSON. Path '', line 1, position 3.\r\n2018-11-30T19:46:25.1618346Z       at <ScriptBlock>, /home/vsts/work/1/s/test/powershell/Modules/Microsoft.PowerShell.Utility/Pester.Commands.Cmdlets.Json.Tests.ps1: line 1457\r\n```\r\nAffected CIs:\r\n\r\nLinux CI: https://powershell.visualstudio.com/PowerShell/_build/results?buildId=7147\r\nmacOS CI: https://powershell.visualstudio.com/PowerShell/_build/results?buildId=7146\r\nWindows CI: https://powershell.visualstudio.com/PowerShell/_build/results?buildId=7148",
      "created_at": "2018-11-30T20:15:43Z",
      "updated_at": "2018-11-30T20:20:01Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "We already had feature tests for this case and they are failing after the removal of the workaround.  I'm reverting the change.",
      "created_at": "2018-11-30T20:56:59Z",
      "updated_at": "2018-11-30T20:56:59Z"
    },
    {
      "author": "adamgauthier",
      "author_association": "CONTRIBUTOR",
      "body": "I'm sorry about this inconvenience, I was not aware of the existence of this particular test and should have been.\r\n\r\nI debugged this issue locally as soon as I could, the new error is caused by yet another `Newtonsoft.Json` bug, which I have reported to their repository [here](https://github.com/JamesNK/Newtonsoft.Json/issues/1930). This means the workaround is still relevant to cover that other bug.\r\n\r\nSorry again.",
      "created_at": "2018-11-30T22:05:23Z",
      "updated_at": "2018-11-30T22:05:57Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@louistio \tNo problem, things happen.  To automatically run the tests, prefix the last commit with `[feature]`.\r\nI would be nice if the fix actually covered the scenario.",
      "created_at": "2018-12-01T00:44:57Z",
      "updated_at": "2018-12-01T00:44:57Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Oh, seems we need re-pack our tests or at least update the code comment. @louistio Could you please make PR and update the comment with new information?",
      "created_at": "2018-12-01T09:02:24Z",
      "updated_at": "2018-12-01T09:02:24Z"
    }
  ],
  "created_at": "2018-11-28T09:33:07Z",
  "number": 8346,
  "state": "closed",
  "title": "Remove workaround for fixed invalid json array deserializing bug",
  "updated_at": "2018-12-03T18:49:16Z"
}