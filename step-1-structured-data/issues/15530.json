{
  "_url": "https://github.com/PowerShell/PowerShell/issues/15530",
  "author": "springcomp",
  "body": "<!--\r\n\r\nFor Windows PowerShell 5.1 issues, suggestions, or feature requests please use the following link instead:\r\nWindows PowerShell [UserVoice](https://windowsserver.uservoice.com/forums/301869-powershell)\r\n\r\nThis repository is **ONLY** for PowerShell Core 6 and PowerShell 7+ issues.\r\n\r\n- Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- Search the existing issues.\r\n- Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- Refer to the [known issues](https://docs.microsoft.com/powershell/scripting/whats-new/known-issues-ps6).\r\n\r\n-->\r\n\r\nAlthough this works with Pwsh 7.1 the `Set-AzureStorageBlobContent` fails with an error on Pwsh 7.2.\r\nAs soon as the full path to the file used as the source of the blob to upload has more than 57 characters, the CmdLet fails.\r\n\r\n## Steps to reproduce\r\n\r\nHere is a handy script that will test various path lengths and upload a blob at a particular location.\r\nThis script will create a file named `_` in a subfolder of the current path named `a[*]` with a length computed so that the entire path has a specified number of characters.\r\n\r\nThis makes it easy to test various file uploads.\r\n\r\nPlease, run this script from a temporary empty folder to prevent conflict.\r\n\r\n```powershell\r\nConnect-AzAccount\r\n\r\n$storageAccount = Get-AzStorageAccount -ResourceGroup \"replace-resource-group-here\" -Name \"replace-account-name-here\"\r\n$containerName = \"replace-container-name-here\"\r\n\r\nFunction New-Path {\r\n    [CmdletBinding()]\r\n    param(\r\n        [Parameter(Position = 0)]\r\n        [int]$length = 57,\r\n        [Parameter(Position = 1)]\r\n        [string]$path = \"$PWD\"\r\n    )\r\n\r\n    $fileName = \"_\"\r\n    $len = $length - \"\\$($fileName)\".Length - \"$($path)\\\".Length\r\n    $name = \"\"; 1..$len |% { $name += \"a\" }\r\n    $newFolder = Join-Path -Path $path -ChildPath $name\r\n    $newPath = Join-Path -Path $newFolder -ChildPath $fileName\r\n\r\n    New-Item -ItemType Directory -Path $newFolder -EA SilentlyContinue | Out-Null\r\n    Set-Content -Path $newPath -Value \"_\"\r\n\r\n    Write-Output $newPath\r\n}\r\n\r\nFunction Test-UploadBlobContent {\r\n    [CmdletBinding()]\r\n    param(\r\n        [Parameter(Position = 0)]\r\n        [int]$length = 57,\r\n        [Parameter(Position = 1)]\r\n        [string]$path = \"$PWD\",\r\n        [string]$container = $containerName\r\n    )\r\n\r\n    try {\r\n        if (($path.Length + 4) -ge $length) {\r\n            Write-Host \"`$PWD length is $($PWD.Path.Length). Minimum allowed value is $($path.Length + 4). Please, specify a greater value for parameter '`$length'.\" -ForegroundColor Yellow\r\n            return\r\n        }\r\n\r\n        $path = New-Path -Length $length -Path $path\r\n\r\n        Write-Host \"Uploading file to blob storage. Length = $($path.Length)...\" -ForegroundColor Cyan\r\n\r\n        Set-AzStorageBlobContent `\r\n            -File $path `\r\n            -Container $container `\r\n            -Context $storageAccount.Context `\r\n            -Force | Out-Null\r\n        Write-Host \"Succeeded\" -ForegroundColor Green\r\n    }\r\n    catch\r\n    {\r\n        Write-Host \"Failed\" -ForegroundColor Red\r\n        Write-Host $_.Exception.Message -ForegroundColor Red\r\n    }\r\n}\r\n\r\n55..60 |% { Test-UploadBlobContent -Length $_  }\r\n```\r\n\r\nOnce run, you can remove the created folders using the following command:\r\n\r\n```powershell\r\nRemove-Item -Recurse -Force -Path aa*\r\n```\r\n\r\n## Expected behavior\r\n\r\nShould upload a new file to the blob storage.\r\n\r\n## Actual behavior\r\n\r\nInstead, as soon as the full path contains more than 57 characters, raises the error:\r\n\r\n`Length cannot be less than zero (Parameter 'Length')`\r\n\r\n## Environment data\r\n\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.0-daily20210515.2\r\nPSEdition                      Core\r\nGitCommitId                    7.2.0-daily20210515.2\r\nOS                             Microsoft Windows 10.0.18363\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\n\r\nModuleType Version    PreRelease Name\r\n---------- -------    ---------- ---- \r\nScript     2.3.0                 Az.Accounts\r\nScript     3.7.0                 Az.Storage\r\n```\r\n",
  "closed_at": null,
  "comments": [],
  "created_at": "2021-06-07T14:57:16Z",
  "number": 15530,
  "state": "open",
  "title": "Set-AzureStorageBlobContent raises an error 'Length cannot be less than zero' if full path contains more than 57 characters",
  "updated_at": "2021-06-07T15:02:35Z"
}