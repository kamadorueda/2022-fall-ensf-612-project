{
  "_url": "https://github.com/PowerShell/PowerShell/issues/5540",
  "author": "markekraus",
  "body": "ref #5464 , #2504, #3267\r\n\r\n* replaces `HttpListener` \"response\" tests with `WebListener`\r\n* Adds `/Response/` test to `WebListener`\r\n* removes `HtmlWebResponseObject` tests as HTML parsing will no longer be done by the web cmdlets https://github.com/PowerShell/PowerShell/issues/3267#issuecomment-286917402\r\n* test bodies that used the system new line have been replaced normalized with `` `n ``\r\n* multiple headers with the same name test enabled for windows (still pending for macOS/Linux)\r\n\r\nThis should alleviate some of the macOS HttpListener related failures.",
  "closed_at": "2017-12-04T17:52:15Z",
  "comments": [
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "AppVeyor CI fail is being addressed by ~#5542~ #5554",
      "created_at": "2017-11-25T01:35:11Z",
      "updated_at": "2017-11-28T01:37:09Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@markekraus Could you please rebase to pass CI Appveyor?",
      "created_at": "2017-11-29T05:48:36Z",
      "updated_at": "2017-11-29T05:48:36Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@iSazonov Rebase wont help this one. It already picked up #5554 in the last empty commit to re-run CI. The problem now is fail in #5567 (which is actually a dup of an older issue where I noted the same behavior randomly happening). \r\n\r\nI will rebase anyway in hopes that the WMF links are working now and we don't find some other transient test issue in the feature tests.",
      "created_at": "2017-11-29T10:03:52Z",
      "updated_at": "2017-11-29T10:03:52Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "The test run got a hard failure:\r\n```\r\n  WebListener -> /home/travis/build/PowerShell/PowerShell/test/tools/WebListener/bin/Linux/netcoreapp2.0/linux-x64/WebListener.dll\r\n  WebListener -> /home/travis/build/PowerShell/PowerShell/test/tools/WebListener/bin/\r\nUnhandled Exception: System.TypeInitializationException: The type initializer for 'System.Management.Automation.Tracing.PSEtwLog' threw an exception. ---> System.TypeInitializationException: The type initializer for 'System.Management.Automation.Tracing.PSSysLogProvider' threw an exception. ---> System.DllNotFoundException: Unable to load DLL 'psl-native': The specified module or one of its dependencies could not be found.\r\n (Exception from HRESULT: 0x8007007E)\r\n   at System.Management.Automation.Tracing.NativeMethods.OpenLog(IntPtr ident, SysLogPriority facility)\r\n   at System.Management.Automation.Tracing.SysLogProvider..ctor(String applicationId, PSLevel level, PSKeyword keywords, PSChannel channels)\r\n   at System.Management.Automation.Tracing.PSSysLogProvider..cctor()\r\n   --- End of inner exception stack trace ---\r\n   at System.Management.Automation.Tracing.PSSysLogProvider..ctor()\r\n   at System.Management.Automation.Tracing.PSEtwLog..cctor()\r\n   --- End of inner exception stack trace ---\r\n   at System.Management.Automation.Tracing.PSEtwLog.LogOperationalInformation(PSEventId id, PSOpcode opcode, PSTask task, PSKeyword keyword, Object[] args)\r\n   at Microsoft.PowerShell.UnmanagedPSEntry.Start(String consoleFilePath, String[] args, Int32 argc)\r\n   at Microsoft.PowerShell.ManagedPSEntry.Main(String[] args) in /home/travis/build/PowerShell/PowerShell/src/powershell/Program.cs:line 23\r\n```\r\n@markekraus I'm not sure how the `PSEtwLog` came in the play, but it unveils a bug in `SysLogProvider.cs`, where `libpsl-native` should be used instead of `psl-native`. I opened bug #5577 for that.",
      "created_at": "2017-11-29T17:58:44Z",
      "updated_at": "2017-11-29T17:58:44Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "Is there some reason we don't run the feature tests on every PR? I run into so many CI fails because most of the web cmdlet tests are gated behind the feature tag. Changes made in other PR's that affect the Feature tests are not being properly vetted. In the past even my own PRs have been approved with broken feature tests. ",
      "created_at": "2017-11-29T18:23:12Z",
      "updated_at": "2017-11-29T18:23:12Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "Feature test run takes more time and not every PR needs the full feature test run, so it's not on by default.\r\nIt can be turned on with the `[Feature]` tag, so the maintainer assigned to the PR or any reviewers of the PR can request a feature test run for the PR to be merged.",
      "created_at": "2017-11-29T18:56:49Z",
      "updated_at": "2017-11-30T17:12:29Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": ">I'm not sure how the PSEtwLog came in the play\r\n\r\n@dantraMSFT Have you any ideas why the PSEtwLog is activated from WebListener?",
      "created_at": "2017-11-30T10:28:50Z",
      "updated_at": "2017-11-30T10:28:50Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": " PSEtwLog is not being activated from WebListener...\r\nThis line\r\n\r\n```none\r\nWebListener -> /home/travis/build/PowerShell/PowerShell/test/tools/WebListener/bin/\r\n```\r\n\r\n indicates that the `Publish-PSTestTools` has completed:\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/7dce4116c7182c99db33c5ad202743abe7cc2d88/build.psm1#L960\r\n\r\nWebListener is not being run at that point. and the compile appears to be successful\r\n\r\nThis is failing sometime after `Publish-PSTestTools`  and before the pester tests start. After weblistener is compiled `Start-PSPester` builds the command line and path then starts a native execution of pwsh.  Plenty of places there for  PSEtwLog to trigger.",
      "created_at": "2017-11-30T10:38:00Z",
      "updated_at": "2017-11-30T10:38:00Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "The root cause of the loading failure was that one of our team members uploaded a `libpsl-native` nuget package that contains a corrupted Linux binary file. The package has been fixed.\r\nAs for #5577, .NET Core actually support lack of \"lib\" prefix in `DllImport` name (see https://github.com/dotnet/coreclr/pull/1248), but #5580 was merged anyways to make the naming consistent.",
      "created_at": "2017-11-30T16:23:33Z",
      "updated_at": "2017-11-30T16:23:33Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "thanks. This PR shouldn't have anything outstanding on it.",
      "created_at": "2017-11-30T16:29:12Z",
      "updated_at": "2017-11-30T16:29:12Z"
    }
  ],
  "created_at": "2017-11-24T21:52:55Z",
  "number": 5540,
  "state": "closed",
  "title": "Replace HttpListener Response Tests with WebListener",
  "updated_at": "2018-01-19T18:58:38Z"
}