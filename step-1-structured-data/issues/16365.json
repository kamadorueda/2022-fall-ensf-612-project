{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16365",
  "author": "Tjamat",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nSet up a list of computers\r\nPipe it to a foreach-object -Parallel with an Invoke-Command, specifying credentials, already stored in a variable `$cred`.\r\nExample:\r\n`$computerList |  %  -Parallel {Invoke-Command -ComputerName $_ -Credential $cred -ScriptBlock {ipconfig} }`\r\n\r\n\n\n### Expected behavior\n\n```console\nPowershell should behave in the same way whether or not -Parallel is specified.\r\nWithout -Parallel, Powershell processes every line sequentially successfully, with the payload written in the scriptblock parameter.\n```\n\n\n### Actual behavior\n\n```console\nPowershell gives out an error for each computer specified :\r\n\r\n> Invoke-Command: Cannot process argument transformation on parameter 'Credential'. A command that prompts the user failed because the host program or the command type does not support user interaction. The host was attempting to request confirmation with the following message: Enter your credentials.\n```\n\n\n### Error details\n\n```console\nException             :\r\n    Type              : System.Management.Automation.ParameterBindingArgumentTransformationException\r\n    Message           : Cannot process argument transformation on parameter 'Credential'. A command that prompts the\r\nuser failed because the host program or the command type does not support user interaction. The host was attempting to\r\nrequest confirmation with the following message: Enter your credentials.\r\n    ParameterName     : Credential\r\n    ParameterType     : pscredential\r\n    ErrorId           : ParameterArgumentTransformationError\r\n    Line              : 1\r\n    Offset            : 50\r\n    CommandInvocation :\r\n        MyCommand        : Invoke-Command\r\n        BoundParameters  :\r\n            Comparer : System.OrdinalIgnoreCaseComparer\r\n            Count    : 1\r\n            Keys     :\r\n                Length : 12\r\n            Values   :\r\n                Length      : 1\r\n                LongLength  : 1\r\n                Rank        : 1\r\n                SyncRoot    :\r\n                    Length : 9\r\n                IsFixedSize : True\r\n                Count       : 1\r\n            SyncRoot :\r\n                Comparer : System.OrdinalIgnoreCaseComparer\r\n                Count    : 1\r\n                Keys     :\r\n                    Length : 12\r\n                Values   :\r\n                    Length      : 1\r\n                    LongLength  : 1\r\n                    Rank        : 1\r\n                    SyncRoot    :\r\n                        Length : 9\r\n                    IsFixedSize : True\r\n                    Count       : 1\r\n                SyncRoot :\r\n                    Comparer : System.OrdinalIgnoreCaseComparer\r\n                    Count    : 1\r\n                    Keys     :\r\n                        Length : 12\r\n                    Values   :\r\n                        Length      : 1\r\n                        LongLength  : 1\r\n                        Rank        : 1\r\n                        SyncRoot    :\r\n                            Length : 9\r\n                        IsFixedSize : True\r\n                        Count       : 1\r\n                    SyncRoot :\r\n                        Comparer : System.OrdinalIgnoreCaseComparer\r\n                        Count    : 1\r\n                        Keys     :\r\n                            Length : 12\r\n                        Values   :\r\n                            Length      : 1\r\n                            LongLength  : 1\r\n                            Rank        : 1\r\n                            SyncRoot    :\r\n                                Length : 9\r\n                            IsFixedSize : True\r\n                            Count       : 1\r\n                        SyncRoot :\r\n                            Comparer : System.OrdinalIgnoreCaseComparer\r\n                            Count    : 1\r\n                            Keys     :\r\n                                Length : 12\r\n                            Values   :\r\n                                Length      : 1\r\n                                LongLength  : 1\r\n                                Rank        : 1\r\n                                SyncRoot    :\r\n                                    Length : 9\r\n                                IsFixedSize : True\r\n                                Count       : 1\r\n                            SyncRoot :\r\n                                Comparer : System.OrdinalIgnoreCaseComparer\r\n                                Count    : 1\r\n                                Keys     :\r\n                                    Length : 12\r\n                                Values   :\r\n                                    Length      : 1\r\n                                    LongLength  : 1\r\n                                    Rank        : 1\r\n                                    SyncRoot    : \u2026\r\n                                    IsFixedSize : True\r\n                                    Count       : 1\r\n                                SyncRoot :\r\n                                    Comparer : System.OrdinalIgnoreCaseComparer\r\n                                    Count    : 1\r\n                                    Keys     : \u2026\r\n                                    Values   : \u2026\r\n                                    SyncRoot : \u2026\r\n        ScriptLineNumber : 1\r\n        OffsetInLine     : 1\r\n        HistoryId        : 1\r\n        Line             : Invoke-Command -ComputerName $_ -Credential $cred -ScriptBlock {ipconfig}\r\n        PositionMessage  : At line:1 char:1\r\n                           + Invoke-Command -ComputerName $_ -Credential $cred -ScriptBlock { \u2026\r\n                           + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n        InvocationName   : Invoke-Command\r\n        PipelineLength   : 1\r\n        PipelinePosition : 1\r\n    ErrorRecord       :\r\n        Exception             :\r\n            Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n            Message : Cannot process argument transformation on parameter 'Credential'. A command that prompts the\r\nuser failed because the host program or the command type does not support user interaction. The host was attempting to\r\nrequest confirmation with the following message: Enter your credentials.\r\n            HResult : -2146233087\r\n        CategoryInfo          : InvalidData: (:) [Invoke-Command], ParentContainsErrorRecordException\r\n        FullyQualifiedErrorId : ParameterArgumentTransformationError,Microsoft.PowerShell.Commands.InvokeCommandCommand\r\n        InvocationInfo        :\r\n            MyCommand        : Invoke-Command\r\n            ScriptLineNumber : 1\r\n            OffsetInLine     : 50\r\n            HistoryId        : 1\r\n            Line             : Invoke-Command -ComputerName $_ -Credential $cred -ScriptBlock {ipconfig}\r\n            PositionMessage  : At line:1 char:50\r\n                               + Invoke-Command -ComputerName $_ -Credential $cred -ScriptBlock { \u2026\r\n                               +                                             ~~~~~\r\n            CommandOrigin    : Internal\r\n        ScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n    TargetSite        :\r\n        Name          : BindParameter\r\n        DeclaringType : System.Management.Automation.ParameterBinderBase, System.Management.Automation,\r\nVersion=7.1.5.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n        MemberType    : Method\r\n        Module        : System.Management.Automation.dll\r\n    StackTrace        :\r\n   at System.Management.Automation.ParameterBinderBase.BindParameter(CommandParameterInternal parameter,\r\nCompiledCommandParameter parameterMetadata, ParameterBindingFlags flags)\r\n   at System.Management.Automation.CmdletParameterBinderController.BindParameter(CommandParameterInternal argument,\r\nMergedCompiledCommandParameter parameter, ParameterBindingFlags flags)\r\n   at System.Management.Automation.CmdletParameterBinderController.BindParameter(UInt32 parameterSets,\r\nCommandParameterInternal argument, MergedCompiledCommandParameter parameter, ParameterBindingFlags flags)\r\n   at System.Management.Automation.CmdletParameterBinderController.BindNamedParameter(UInt32 parameterSets,\r\nCommandParameterInternal argument, MergedCompiledCommandParameter parameter)\r\n   at System.Management.Automation.ParameterBinderController.BindNamedParameters(UInt32 parameterSets, Collection`1\r\narguments)\r\n   at System.Management.Automation.CmdletParameterBinderController.BindCommandLineParametersNoValidation(Collection`1\r\narguments)\r\n   at System.Management.Automation.CmdletParameterBinderController.BindCommandLineParameters(Collection`1 arguments)\r\n   at System.Management.Automation.CommandProcessor.BindCommandLineParameters()\r\n   at System.Management.Automation.CommandProcessor.Prepare(IDictionary psDefaultParameterValues)\r\n   at System.Management.Automation.CommandProcessorBase.DoPrepare(IDictionary psDefaultParameterValues)\r\n   at System.Management.Automation.Internal.PipelineProcessor.Start(Boolean incomingStream)\r\n   at System.Management.Automation.Internal.PipelineProcessor.SynchronousExecuteEnumerate(Object input)\r\n--- End of stack trace from previous location ---\r\n   at System.Management.Automation.Internal.PipelineProcessor.SynchronousExecuteEnumerate(Object input)\r\n   at System.Management.Automation.PipelineOps.InvokePipeline(Object input, Boolean ignoreInput,\r\nCommandParameterInternal[][] pipeElements, CommandBaseAst[] pipeElementAsts, CommandRedirection[][]\r\ncommandRedirections, FunctionContext funcContext)\r\n   at System.Management.Automation.Interpreter.ActionCallInstruction`6.Run(InterpretedFrame frame)\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\r\n    Data              : System.Collections.ListDictionaryInternal\r\n    InnerException    :\r\n        Type        : System.Management.Automation.Host.HostException\r\n        ErrorRecord :\r\n            Exception             :\r\n                Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n                Message : A command that prompts the user failed because the host program or the command type does not\r\nsupport user interaction. The host was attempting to request confirmation with the following message: Enter your\r\ncredentials.\r\n                HResult : -2146233087\r\n            CategoryInfo          : NotImplemented: (:) [], ParentContainsErrorRecordException\r\n            FullyQualifiedErrorId : HostFunctionNotImplemented\r\n        TargetSite  :\r\n            Name          : ThrowPromptNotInteractive\r\n            DeclaringType : System.Management.Automation.Internal.Host.InternalHostUserInterface,\r\nSystem.Management.Automation, Version=7.1.5.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n            MemberType    : Method\r\n            Module        : System.Management.Automation.dll\r\n        StackTrace  :\r\n   at System.Management.Automation.Internal.Host.InternalHostUserInterface.ThrowPromptNotInteractive(String\r\npromptMessage)\r\n   at System.Management.Automation.Internal.Host.InternalHostUserInterface.PromptForCredential(String caption, String\r\nmessage, String userName, String targetName, PSCredentialTypes allowedCredentialTypes, PSCredentialUIOptions options)\r\n   at System.Management.Automation.Internal.Host.InternalHostUserInterface.PromptForCredential(String caption, String\r\nmessage, String userName, String targetName)\r\n   at System.Management.Automation.CredentialAttribute.Transform(EngineIntrinsics engineIntrinsics, Object inputData)\r\n   at System.Management.Automation.ParameterBinderBase.BindParameter(CommandParameterInternal parameter,\r\nCompiledCommandParameter parameterMetadata, ParameterBindingFlags flags)\r\n        Message     : A command that prompts the user failed because the host program or the command type does not\r\nsupport user interaction. The host was attempting to request confirmation with the following message: Enter your\r\ncredentials.\r\n        Source      : System.Management.Automation\r\n        HResult     : -2146233087\r\n    Source            : System.Management.Automation\r\n    HResult           : -2146233087\r\nCategoryInfo          : InvalidData: (:) [Invoke-Command], ParameterBindingArgumentTransformationException\r\nFullyQualifiedErrorId : ParameterArgumentTransformationError,Microsoft.PowerShell.Commands.InvokeCommandCommand\r\nInvocationInfo        :\r\n    MyCommand        : Invoke-Command\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 50\r\n    HistoryId        : 1\r\n    Line             : Invoke-Command -ComputerName $_ -Credential $cred -ScriptBlock {ipconfig}\r\n    PositionMessage  : At line:1 char:50\r\n                       + Invoke-Command -ComputerName $_ -Credential $cred -ScriptBlock { \u2026\r\n                       +                                             ~~~~~\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\n```\n\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.5\r\nPSEdition                      Core\r\nGitCommitId                    7.1.5\r\nOS                             Microsoft Windows 10.0.18363\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": "2021-11-03T17:01:41Z",
  "comments": [
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": ">Powershell should behave in the same way whether or not -Parallel is specified.\r\n\r\nThis is an incorrect expectation.  Running script in parallel sessions is different than running sequentially in a single session, and is documented as such.\r\n\r\nYou need to use the `$using` keyword to pass in variables.  The variables must be thread safe if mutable, but in this case the `$creds` variable is always read and should be safe for use.\r\n\r\n```powershell\r\n$cred = Get-Credential\r\n$computerList | % -Parallel {Invoke-Command -ComputerName $_ -Credential $using:cred -ScriptBlock {ipconfig} }\r\n```\r\n\r\nhttps://devblogs.microsoft.com/powershell/powershell-foreach-object-parallel-feature/\n\n<blockquote><img src=\"https://devblogs.microsoft.com/wp-content/uploads/sites/30/2018/09/Powershell_256.png\" width=\"48\" align=\"right\"><div><img src=\"https://devblogs.microsoft.com/powershell/wp-content/uploads/sites/30/2019/02/Powershell_2561.png\" height=\"14\"> PowerShell Team</div><div><strong><a href=\"https://devblogs.microsoft.com/powershell/powershell-foreach-object-parallel-feature/\">PowerShell ForEach-Object Parallel Feature</a></strong></div><div>PowerShell ForEach-Object Parallel Feature PowerShell 7.0 Preview 3 is now available with a new ForEach-Object Parallel Experimental feature. This feature is a great new tool for parallelizing work, but like any tool, it has its uses and drawbacks. This article describes this new feature,</div></blockquote>",
      "created_at": "2021-11-03T16:52:15Z",
      "updated_at": "2021-11-03T16:52:17Z"
    },
    {
      "author": "Tjamat",
      "author_association": "NONE",
      "body": "Hi @PaulHigin, thanks for your answer. I read the documentation but I thought the $using keyword was necessary only for the scriptblock part. Sorry for that misinterpretation. Regards",
      "created_at": "2021-11-03T17:04:11Z",
      "updated_at": "2021-11-03T17:04:11Z"
    }
  ],
  "created_at": "2021-11-03T16:18:26Z",
  "number": 16365,
  "state": "closed",
  "title": "Foreach parallel does not work credentials",
  "updated_at": "2021-11-03T18:26:28Z"
}