{
  "_url": "https://github.com/PowerShell/PowerShell/issues/1992",
  "author": "garethr",
  "body": "Dockerfile instructions each create a filesystem layer, and the current\nformulation leaves both a package cache and the powershell deb file to\nbulk out the image. The changes here mean that neither are saved in the\nfinal image. This shaves about 80MB from the final image in my testing.\n\nI've also added a dockerignore file. This ignores everything from the\ncurrent directory, which speeds up build time by not adding all the\nsource files from the top level directory to the build context.\n",
  "closed_at": "2016-09-13T01:43:57Z",
  "comments": [
    {
      "author": "msftclas",
      "author_association": "NONE",
      "body": "Hi **@garethr**, I'm your friendly neighborhood Microsoft Pull Request Bot (You can call me MSBOT). Thanks for your contribution!\n    <span>\n        In order for us to evaluate and accept your PR, we ask that you sign a contribution license agreement. It's all electronic and will take just minutes. I promise there's no faxing. https://cla.microsoft.com.\n    </span>\n\nTTYL, MSBOT;\n",
      "created_at": "2016-08-21T12:38:24Z",
      "updated_at": "2016-08-21T12:38:24Z"
    },
    {
      "author": "garethr",
      "author_association": "NONE",
      "body": "Note that this replaces https://github.com/PowerShell/PowerShell/pull/1988 which attempts a similar thing.\n",
      "created_at": "2016-08-21T12:39:24Z",
      "updated_at": "2016-08-21T12:39:24Z"
    },
    {
      "author": "msftclas",
      "author_association": "NONE",
      "body": "**@garethr**, Thanks for signing the contribution license agreement so quickly! Actual humans will now validate the agreement and then evaluate the PR.\n<br />Thanks, MSBOT;\n",
      "created_at": "2016-08-21T12:43:07Z",
      "updated_at": "2016-08-21T12:43:07Z"
    },
    {
      "author": "RobertKozak",
      "author_association": "NONE",
      "body": "I suggest the Dockerfile should look similar to this:\n\n```\nFROM ubuntu:16.04\n\nENV DEBIAN_FRONTEND noninteractive\n\nCOPY ./tools/*.sh ./tmp/\nRUN /bin/bash -c \"source ./tmp/download.sh\" && \\\n        /bin/bash -c \"source ./tmp/cleanup.sh\" && \\\n        rm ./tmp/*\n\nENTRYPOINT [\"powershell\"]\n```\n\nand the cleanup.sh look similar to this:\n\n```\n#!/usr/bin/env bash\n\n# Clean up packages\necho \"Cleaning up packages\"\ncase \"$OSTYPE\" in\n    linux*)\n        source /etc/os-release\n        case \"$ID\" in\n            centos)\n                ;;\n            ubuntu)\n                apt-get purge --quiet -y curl \n                apt-get clean --quiet\n                apt-get autoclean --quiet\n                rm -rf /var/lib/apt/lists/* /var/log/apt/* /var/log/dpkg.log\n                ;;\n            *)\n        esac\n        ;;\n    darwin*)\n        ;;\nesac\n```\n",
      "created_at": "2016-08-23T21:39:18Z",
      "updated_at": "2016-08-23T22:34:46Z"
    },
    {
      "author": "garethr",
      "author_association": "NONE",
      "body": "@andschwa I've updated the PR as discussed. So this now points at the download script and runs it. Which does mean testing this as is don't work until it's merged. So to test out the approach you can try using the local script.\n\nThe download script uses `sudo` unless it's already running as root.\n\n``` dockerfile\nFROM ubuntu:16.04\n\nRUN apt-get update && \\\n    apt-get install -y curl libunwind8 libicu55\nADD tools/download.sh /\nRUN chmod +x download.sh && \\\n    ./download.sh && \\\n    rm powershell_*.deb && \\\n    rm download.sh && \\\n    apt-get clean && \\\n    rm -rf /var/lib/apt/lists/*\n```\n\nYou'll also need to modify the `.gitignore` file to allow adding the download script from the local directory.\n\n```\n*\n!tools/download.sh\n```\n\nI'll add additional distros in a separate PR once this gets merged and you're happy with the general approach.\n",
      "created_at": "2016-09-01T10:47:49Z",
      "updated_at": "2016-09-01T10:47:49Z"
    },
    {
      "author": "RobertKozak",
      "author_association": "NONE",
      "body": "Is there a reason you are not combining the two RUN statements? Wouldn't it be better to put the ADD statement first and then combine the two RUN statements into one?\n",
      "created_at": "2016-09-01T18:03:30Z",
      "updated_at": "2016-09-01T18:03:30Z"
    },
    {
      "author": "garethr",
      "author_association": "NONE",
      "body": "@RobertKozak the Dockerfile in the PR doesn't do those things, the one in the comment is just for testing as described. The rationale for doing it that way was speed of feedback when making changes to the shell script. So the (slow) package installation got cached and I could hack on the download.sh script until I got everything working as intended.\n",
      "created_at": "2016-09-02T13:05:56Z",
      "updated_at": "2016-09-02T13:05:56Z"
    },
    {
      "author": "RobertKozak",
      "author_association": "NONE",
      "body": "@garethr Gotcha.\n",
      "created_at": "2016-09-02T17:35:58Z",
      "updated_at": "2016-09-02T17:35:58Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "Branch has conflicts, now waiting on author.\n",
      "created_at": "2016-09-06T18:47:16Z",
      "updated_at": "2016-09-06T18:47:16Z"
    },
    {
      "author": "RobertKozak",
      "author_association": "NONE",
      "body": "Do we need to keep curl? should you add an 'apt-get purge -y curl'? What about 'apt-get autoremove'\nI only ask if we want to make this image as small as possible.\n",
      "created_at": "2016-09-06T22:09:13Z",
      "updated_at": "2016-09-06T22:09:13Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "Honestly, please don't worry about this. As part of our automation, we (read: I) am working to right Dockerfiles that install everything necessary to run, build, and package PowerShell.\n",
      "created_at": "2016-09-06T22:47:03Z",
      "updated_at": "2016-09-06T22:47:03Z"
    },
    {
      "author": "andschwa",
      "author_association": "MEMBER",
      "body": "Thanks for the contribution! I have to close this as I had to implement similar logic but across the whole matrix. Cheers!\n",
      "created_at": "2016-09-13T01:43:57Z",
      "updated_at": "2016-09-13T01:43:57Z"
    }
  ],
  "created_at": "2016-08-21T12:38:19Z",
  "number": 1992,
  "state": "closed",
  "title": "Improve Dockerfile, reducing image size and build time",
  "updated_at": "2020-05-27T20:44:38Z"
}