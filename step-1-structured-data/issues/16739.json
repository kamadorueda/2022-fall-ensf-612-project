{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16739",
  "author": "penalvch-zz",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nAttempting to run New-NetQosPolicy command as an administrator, and in a scheduled task fails with noted error message. Same problem with Windows PowerShell 5.1.\r\nhttps://docs.microsoft.com/en-us/powershell/module/netqos/new-netqospolicy?view=windowsserver2019-ps\r\n\r\nScheduled task xml:\r\n```\r\n<?xml version=\"1.0\" encoding=\"UTF-16\"?>\r\n<Task version=\"1.4\" xmlns=\"http://schemas.microsoft.com/windows/2004/02/mit/task\">\r\n  <RegistrationInfo>\r\n    <Date>2021-12-22T16:06:10.889206</Date>\r\n    <Author>hostname\\admin</Author>\r\n    <URI>\\Custom\\test</URI>\r\n  </RegistrationInfo>\r\n  <Triggers>\r\n    <CalendarTrigger>\r\n      <StartBoundary>2021-12-23T20:00:01-05:00</StartBoundary>\r\n      <Enabled>true</Enabled>\r\n      <ScheduleByDay>\r\n        <DaysInterval>1</DaysInterval>\r\n      </ScheduleByDay>\r\n    </CalendarTrigger>\r\n  </Triggers>\r\n  <Principals>\r\n    <Principal id=\"Author\">\r\n      <UserId>S-1-5-21-4026033147-567229773-2407019803-1001</UserId>\r\n      <LogonType>Password</LogonType>\r\n      <RunLevel>HighestAvailable</RunLevel>\r\n    </Principal>\r\n  </Principals>\r\n  <Settings>\r\n    <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>\r\n    <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>\r\n    <StopIfGoingOnBatteries>true</StopIfGoingOnBatteries>\r\n    <AllowHardTerminate>false</AllowHardTerminate>\r\n    <StartWhenAvailable>true</StartWhenAvailable>\r\n    <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable>\r\n    <IdleSettings>\r\n      <StopOnIdleEnd>true</StopOnIdleEnd>\r\n      <RestartOnIdle>false</RestartOnIdle>\r\n    </IdleSettings>\r\n    <AllowStartOnDemand>true</AllowStartOnDemand>\r\n    <Enabled>true</Enabled>\r\n    <Hidden>false</Hidden>\r\n    <RunOnlyIfIdle>false</RunOnlyIfIdle>\r\n    <DisallowStartOnRemoteAppSession>false</DisallowStartOnRemoteAppSession>\r\n    <UseUnifiedSchedulingEngine>true</UseUnifiedSchedulingEngine>\r\n    <WakeToRun>false</WakeToRun>\r\n    <ExecutionTimeLimit>PT0S</ExecutionTimeLimit>\r\n    <Priority>7</Priority>\r\n  </Settings>\r\n  <Actions Context=\"Author\">\r\n    <Exec>\r\n      <Command>pwsh.exe</Command>\r\n      <Arguments>-nologo -windowstyle hidden -ExecutionPolicy Bypass -command \". c:\\scripts\\test.ps1; exit $LASTEXITCODE\"</Arguments>\r\n      <WorkingDirectory>c:\\scripts</WorkingDirectory>\r\n    </Exec>\r\n  </Actions>\r\n</Task>\r\n```\n\n### Expected behavior\n\n```console\nnew-netqospolicy -name test -ipport 443 -ipprotocol TCP -ThrottleRateActionBitsPerSecond 10000000 -NetworkProfile All                                                                                                                              Name           : test                                                                  Owner          : Group Policy (Machine)                                                   NetworkProfile : All                                                                      Precedence     : 127                                                                      JobObject      :                                                                          IPProtocol     : TCP                                                                      IPPort         : 443                                                                      ThrottleRate   : 10 MBits/sec                                                                                                                                                                                                                                                 PS C:\\Windows\\System32>\n```\n\n\n### Actual behavior\n\n```console\nMicrosoft.Management.Infrastructure.CimException: Access to a CIM resource was not available to the client.\r\n   at Microsoft.Management.Infrastructure.Internal.Operations.CimAsyncObserverProxyBase`1.ProcessNativeCallback(OperationCallbackProcessingContext callbackProcessingContext, T currentItem, Boolean moreResults, MiResult operationResult, String errorMessage, InstanceHandle errorDetailsHandle)\n```\n\n\n### Error details\n\n```console\nAccess to a CIM resource was not available to the client.\n```\n\n\n### Environment data\n\n```powershell\n$psversiontable\r\n\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.1\r\nPSEdition                      Core\r\nGitCommitId                    7.2.1\r\nOS                             Microsoft Windows 10.0.19044\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}       \r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": "2022-01-13T15:05:41Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": ">  Same problem with Windows PowerShell 5.1.\r\n\r\nThis says it is not pwsh issue. Please use other Windows support channels/forums.",
      "created_at": "2022-01-13T12:49:19Z",
      "updated_at": "2022-01-13T12:49:19Z"
    },
    {
      "author": "penalvch-zz",
      "author_association": "NONE",
      "body": "> > Same problem with Windows PowerShell 5.1.\r\n> \r\n> This says it is not pwsh issue. Please use other Windows support channels/forums.\r\n\r\nWill do, thanks!",
      "created_at": "2022-01-13T15:05:38Z",
      "updated_at": "2022-01-13T15:05:38Z"
    }
  ],
  "created_at": "2022-01-13T11:01:55Z",
  "number": 16739,
  "state": "closed",
  "title": "PWSH 7.2.1: New-NetQosPolicy: Access to a CIM resource was not available to the client.",
  "updated_at": "2022-01-13T15:05:44Z"
}