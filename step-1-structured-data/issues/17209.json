{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17209",
  "author": "ben-pulido",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\n@theJasonHelmick Per our conversation at the PS conference, please see the issue details below. Thanks for taking an interest!\r\n\r\nI'm running get user against the Graph web API using `invoke-restmethod.` In production, I would pull multiple users, so I was testing performance potential with `foreach-object -parallel` over my current `foreach ($i in $is) {}`. The iterated call using `-parallel` errored with _'CompactToken parsing failed with error code: 80049217.'_ To make sure I didn't have a stale token or syntax issue, I ran the same code without the -parallel switch The calls were successful. If I place the token string directly into the code when using '-parallel' the calls are also successful. All three scenarios are shown in screenshots below.\r\n\r\nIn our discussion, I mentioned I thought it was related to wrapping my token variable in '$()' but I've tried it the code just passing the variable directly without the wrap with the same results. It was a red herring with from extranious code. :)\n\n### Expected behavior\n\n```console\n1..2 | ForEach-Object -parallel { $account_params = @{\r\n>>         Headers     = @{Authorization = \"Bearer $GraphApiKey\" }\r\n>>         URI         = \"https://graph.microsoft.com/v1.0/users/test.user1@wirelessoneonline.com\"\r\n>>         Method      = 'GET'\r\n>>         ContentType = 'application/json'\r\n>>     }\r\n>>     Invoke-RestMethod @Account_params }\r\n\r\n@odata.context    : https://graph.microsoft.com/v1.0/$metadata#users/$entity\r\nbusinessPhones    : {}\r\ndisplayName       : Test User1\r\ngivenName         : Test\r\njobTitle          :\r\nmail              : test.user1@wirelessoneonline.com\r\nmobilePhone       :\r\nofficeLocation    :\r\npreferredLanguage :\r\nsurname           : User1\r\nuserPrincipalName : test.user1@wirelessoneonline.com\r\nid                : 1ff9a221-6c9f-4402-a737-aa48058c8eb3\r\n\r\n@odata.context    : https://graph.microsoft.com/v1.0/$metadata#users/$entity\r\nbusinessPhones    : {}\r\ndisplayName       : Test User1\r\ngivenName         : Test\r\njobTitle          :\r\nmail              : test.user1@wirelessoneonline.com\r\nmobilePhone       :\r\nofficeLocation    :\r\npreferredLanguage :\r\nsurname           : User1\r\nuserPrincipalName : test.user1@wirelessoneonline.com\r\nid                : 1ff9a221-6c9f-4402-a737-aa48058c8eb3\n```\n\n\n### Actual behavior\n\n```console\nC:\\> 1..2 | ForEach-Object -Parallel { $account_params = @{\r\n>>         Headers     = @{Authorization = \"Bearer $GraphApiKey\" }\r\n>>         URI         = \"https://graph.microsoft.com/v1.0/users/test.user1@wirelessoneonline.com\"\r\n>>         Method      = 'GET'\r\n>>         ContentType = 'application/json'\r\n>>     }\r\n>>     Invoke-RestMethod @Account_params }\r\nInvoke-RestMethod:\r\nLine |\r\n   7 |      Invoke-RestMethod @Account_params\r\n     |      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | {\"error\":{\"code\":\"InvalidAuthenticationToken\",\"message\":\"CompactToken parsing failed with error code: 80049217\",\"innerError\":{\"date\":\"2022-04-28T05:57:52\",\"request-id\":\"8029d99f-fdff-4f53-8de3-ece7bb49865a\",\"client-request-id\":\"8029d99f-fdff-4f53-8de3-ece7bb49865a\"}}}\r\nInvoke-RestMethod:\r\nLine |\r\n   7 |      Invoke-RestMethod @Account_params\r\n     |      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n     | {\"error\":{\"code\":\"InvalidAuthenticationToken\",\"message\":\"CompactToken parsing failed with error code: 80049217\",\"innerError\":{\"date\":\"2022-04-28T05:57:52\",\"request-id\":\"4fa35fd4-041e-4823-9bd9-33a9ad62b847\",\"client-request-id\":\"4fa35fd4-041e-4823-9bd9-33a9ad62b847\"}}}\r\nC:\\>\n```\n\n\n### Error details\n\n```console\nC:\\> get-error\r\n\r\nException             :\r\n    Type       : Microsoft.PowerShell.Commands.HttpResponseException\r\n    Response   : StatusCode: 401, ReasonPhrase: 'Unauthorized', Version: 1.1, Content: System.Net.Http.HttpConnectionResponseContent,\r\nHeaders:\r\n                 {\r\n                 Transfer-Encoding: chunked\r\n                 Strict-Transport-Security: max-age=31536000\r\n                 request-id: 4fa35fd4-041e-4823-9bd9-33a9ad62b847\r\n                 client-request-id: 4fa35fd4-041e-4823-9bd9-33a9ad62b847\r\n                 x-ms-ags-diagnostic: {\"ServerInfo\":{\"DataCenter\":\"West US\r\n2\",\"Slice\":\"E\",\"Ring\":\"1\",\"ScaleUnit\":\"001\",\"RoleInstance\":\"MW2PEPF000031CD\"}}\r\n                 WWW-Authenticate: Bearer realm=\"\", authorization_uri=\"https://login.microsoftonline.com/common/oauth2/authorize\",\r\nclient_id=\"00000003-0000-0000-c000-000000000000\"\r\n                 Date: Thu, 28 Apr 2022 05:57:51 GMT\r\n                 Content-Type: application/json\r\n                 }\r\n    TargetSite :\r\n        Name          : ThrowTerminatingError\r\n        DeclaringType : System.Management.Automation.MshCommandRuntime, System.Management.Automation, Version=7.2.3.500,\r\nCulture=neutral, PublicKeyToken=31bf3856ad364e35\r\n        MemberType    : Method\r\n        Module        : System.Management.Automation.dll\r\n    Message    : Response status code does not indicate success: 401 (Unauthorized).\r\n    Source     : System.Management.Automation\r\n    HResult    : -2146233088\r\n    StackTrace :\r\n   at System.Management.Automation.MshCommandRuntime.ThrowTerminatingError(ErrorRecord errorRecord)\r\nTargetObject          : Method: GET, RequestUri: 'https://graph.microsoft.com/v1.0/users/test.user1@wirelessoneonline.com', Version:\r\n1.1, Content: System.Net.Http.StringContent, Headers:\r\n                        {\r\n                        Authorization: Bearer\r\n                        User-Agent: Mozilla/5.0\r\n                        User-Agent: (Windows NT 10.0; Microsoft Windows 10.0.22000; en-US)\r\n                        User-Agent: PowerShell/7.2.3\r\n                        Content-Type: application/json\r\n                        Content-Length: 0\r\n                        }\r\nCategoryInfo          : InvalidOperation: (Method: GET, Reques\u2026ontent-Length: 0\r\n                        }:HttpRequestMessage) [Invoke-RestMethod], HttpResponseException\r\nFullyQualifiedErrorId : WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeRestMethodCommand\r\nErrorDetails          : {\"error\":{\"code\":\"InvalidAuthenticationToken\",\"message\":\"CompactToken parsing failed with error code: 80049217\r\n\",\"innerError\":{\"date\":\"2022-04-28T05:57:52\",\"request-id\":\"4fa35fd4-041e-4823-9bd9-33a9ad62b847\",\"client-request-id\":\"4fa35fd4-041e-48\r\n23-9bd9-33a9ad62b847\"}}}\r\nInvocationInfo        :\r\n    MyCommand        : Invoke-RestMethod\r\n    ScriptLineNumber : 7\r\n    OffsetInLine     : 5\r\n    HistoryId        : 1\r\n    Line             :     Invoke-RestMethod @Account_params\r\n    PositionMessage  : At line:7 char:5\r\n                       +     Invoke-RestMethod @Account_params\r\n                       +     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    InvocationName   : Invoke-RestMethod\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 7\n```\n\n\n### Environment data\n\n```powershell\nC:\\> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.3\r\nPSEdition                      Core\r\nGitCommitId                    7.2.3\r\nOS                             Microsoft Windows 10.0.22000\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n![image](https://user-images.githubusercontent.com/63937378/165687447-0ae10fda-49bc-4247-96ae-89d4b4605334.png)\r\n![image](https://user-images.githubusercontent.com/63937378/165687646-250fc775-af79-49a1-8975-a8a82998fe60.png)\r\n![Untitled](https://user-images.githubusercontent.com/63937378/165689363-56b6d428-6f37-4102-b24f-de5ba4090dc7.png)\r\n\r\n",
  "closed_at": "2022-04-29T00:25:06Z",
  "comments": [
    {
      "author": "jborean93",
      "author_association": "COLLABORATOR",
      "body": "You need to use `$using:VariableName`, `$using:GraphApiKey`, inside a `ForEach-Object -Parallel` block. This is because that parallel block is run in a completely new runspace without any of the session state of the caller. By adding the `$using:` prefix you tell PowerShell to pull this variable in the outside Runspace and inject it into the parallel run.",
      "created_at": "2022-04-28T08:45:16Z",
      "updated_at": "2022-04-28T08:45:16Z"
    }
  ],
  "created_at": "2022-04-28T06:23:43Z",
  "number": 17209,
  "state": "closed",
  "title": "The -parallel switch in foreach-object results in failed Graph authentication token parse when passed in a variable",
  "updated_at": "2022-04-29T00:25:06Z"
}