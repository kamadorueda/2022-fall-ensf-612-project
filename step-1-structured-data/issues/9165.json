{
  "_url": "https://github.com/PowerShell/PowerShell/issues/9165",
  "author": "iSazonov",
  "body": "<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\nReplace `StringBuilder` with stack allocated `Span<char>` to avoid extra allocation/copies during P/Invoke.\r\n\r\n## PR Context\r\n\r\nUsing StringBuilder in P/Invoke causes extra allocations and buffer copies.\r\nRelated #9139\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [ ] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n- **Testing - New and feature**\r\n    - [x] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [ ] [Add `[feature]` to your commit messages if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n",
  "closed_at": "2019-03-22T16:51:14Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Windows uses 8 Kb [buffer to read from console](https://github.com/PowerShell/PowerShell/blob/af0e95f8e23500d064d5af51d20471ece99eb152/src/Microsoft.PowerShell.ConsoleHost/host/msh/ConsoleHostUserInterface.cs#L1290)\r\nUnix uses 1 Kb [buffer to read from console](https://github.com/dotnet/corefx/blob/a10890f4ffe0fadf090c922578ba0e606ebdd16c/src/System.Console/src/System/IO/StdInReader.cs#L27)\r\n\r\nIf we could use a buffer of the same size on Windows, we could use a stackalloc instead of an ArrayPool.\r\nWe can?\r\n\r\nPerformance ArrayPool vs allocation https://adamsitnik.com/Array-Pool/ \r\nWith stackalloc we could be faster.",
      "created_at": "2019-03-19T12:48:17Z",
      "updated_at": "2019-03-19T14:37:06Z"
    },
    {
      "author": "lzybkr",
      "author_association": "MEMBER",
      "body": "@iSazonov - the `initialContent` parameter was an optimization where we displayed the prompt in native code where possible (no custom prompt) because startup was so slow. That optimization is no longer necessary, so it's safe to remove the code.\r\n\r\nAs for buffer Windows/Unix buffer sizes - I believe the code you're looking at only matters if `PSReadLine` is not in use, so it's mostly not interesting.",
      "created_at": "2019-03-20T01:03:40Z",
      "updated_at": "2019-03-20T01:03:40Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@lzybkr Thanks! Although you have approved this change, I still have to restore tab completion on Windows, yes?\r\nAlso make sense to unify the behavior for all platforms?",
      "created_at": "2019-03-20T03:11:02Z",
      "updated_at": "2019-03-20T03:11:02Z"
    },
    {
      "author": "lzybkr",
      "author_association": "MEMBER",
      "body": "Oh, I probably didn't look closely enough at this, you shouldn't regress tab completion w/o PSReadLine.\r\n\r\nI was thinking the `initialContent` parameter was introduced for the performance optimization I mentioned, but I'm probably misremembering, it seems like that parameter was always there in at least one place.",
      "created_at": "2019-03-20T04:09:25Z",
      "updated_at": "2019-03-20T04:09:25Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "The feature request to enhance Console.ReadKey() to complete at Tab.\r\nhttps://github.com/dotnet/corefx/issues/36175\r\n\r\nUpdate: already implemented!",
      "created_at": "2019-03-20T06:51:02Z",
      "updated_at": "2019-03-20T17:29:39Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I pushed new commit to revert previous changes and use stack edit buffer (size reduced from 8Kb to 1Kb).\r\nI could try to improve the code in ReadLineFromConsole() and above or leave it for follow PR.",
      "created_at": "2019-03-20T16:01:12Z",
      "updated_at": "2019-03-20T16:01:12Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@iSazonov Thank you for getting started on #9139 ! Now we have example code to follow :)",
      "created_at": "2019-03-22T16:52:17Z",
      "updated_at": "2019-03-22T16:52:17Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> On Windows, the cooked input mode supports ending on Tab to support tab completion in a cli like PowerShell or cmd, see here.\r\nOn Unix, cooked mode does not end on Tab and a cli typically ends up in raw mode if it wants tab completion.\r\n\r\n@lzybkr After some investigations I discovered that canonical (cooked) input mode on Unix may ends line input by __VEOL__ which can be set to <kbd>TAB</kbd> by termios API\r\nhttp://man7.org/linux/man-pages/man3/termios.3.html\r\nhttps://github.com/hyc/OpenSSH-LINEMODE/wiki\r\n\r\nIf this is the right direction I could open new tracking Issue.\r\n\r\nMaybe there is still a problem getting the cursor position.\r\nhttps://thoughtsordiscoveries.wordpress.com/2017/04/26/set-and-read-cursor-position-in-terminal-windows-and-linux/",
      "created_at": "2019-03-23T17:08:55Z",
      "updated_at": "2019-03-23T17:08:55Z"
    },
    {
      "author": "lzybkr",
      "author_association": "MEMBER",
      "body": "There's little harm in opening an issue, but I'd have a hard time justifying spending much time on that. Windows has the support because that code was written before PSReadLine existed.\r\n\r\nWe opted to more or less require PSReadLine on non-Windows because it wasn't hard to port and had all of the key functionality folks expect on non-Windows.",
      "created_at": "2019-03-24T17:37:51Z",
      "updated_at": "2019-03-24T17:37:51Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@lzybkr Thanks for your comment!\r\n\r\nI also discover that we call [TryInvokeUserDefinedReadLine()](https://github.com/PowerShell/PowerShell/blob/cd7d7797e49f9ac392a42b36e81f6f06dfa81b05/src/Microsoft.PowerShell.ConsoleHost/host/msh/ConsoleHostUserInterface.cs#L1806) for every new input line where we do search `PSConsoleHostReadLine`. This looks expensive. We could register PSConsoleHostReadLine() as a delegate on event onLoad() and unregister on event onUnload() in PSReadline module. Also we could use cached PowerShell object. What do you think?",
      "created_at": "2019-03-25T04:59:10Z",
      "updated_at": "2019-03-25T04:59:10Z"
    },
    {
      "author": "lzybkr",
      "author_association": "MEMBER",
      "body": "It\u2019s probably not worth the trouble.\r\n\r\nThe biggest performance problem was searching for external commands and that is no longer an issue, the search skips those now. \r\n\r\nI had a similar idea when we included PSReadLine in Windows and actually implemented my idea to call the C# api directly. It caused problems with custom scriptblock handlers. I decided that in this case it was best to keep the code simple. ",
      "created_at": "2019-03-25T14:19:54Z",
      "updated_at": "2019-03-25T14:19:54Z"
    }
  ],
  "created_at": "2019-03-19T06:54:54Z",
  "number": 9165,
  "state": "closed",
  "title": "Refactor ReadConsole P/Invoke in ConsoleHost",
  "updated_at": "2019-03-29T22:39:16Z"
}