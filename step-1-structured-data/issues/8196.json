{
  "_url": "https://github.com/PowerShell/PowerShell/issues/8196",
  "author": "bugale",
  "body": "## PR Summary\r\n\r\nFix #8193.\r\nOn stdin/stdout mode (without console), when a backspace was sent, the code tried to remove the last character in the current line string builder. this was true even when the string builder is empty, thus crashing.\r\nI fixed the issue by ignoring the backspace when the string builder is empty, not echoing it, and not trying to remove from the string builder.\r\n\r\n## PR Checklist\r\n\r\n- [X] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [X] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [X] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [X] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [X] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` to the beginning of the title and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [X] Not Applicable\r\n    - **OR**\r\n    - [ ] User-facing [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed - Issue link: \r\n- **Testing - New and feature**\r\n    - [ ] Not Applicable or can only be tested interactively\r\n    - **OR**\r\n    - [X] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [ ] [Add `[feature]` if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n",
  "closed_at": "2018-11-10T13:55:29Z",
  "comments": [
    {
      "author": "bugale",
      "author_association": "CONTRIBUTOR",
      "body": "How would you suggest testing it?\r\nSince the code uses consoleIn directly, it will be hard to write unittests for that.\r\nA system test (of opening powershell, redirecting its input, and writing backspace) is possible, but I don't see any existing test like that.",
      "created_at": "2018-11-07T09:26:28Z",
      "updated_at": "2018-11-07T09:26:28Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "New tests should be in https://github.com/PowerShell/PowerShell/blob/master/test/powershell/Host/ConsoleHost.Tests.ps1\r\nIn the file you can find samples with running PowerShell process with redirections.",
      "created_at": "2018-11-07T12:29:56Z",
      "updated_at": "2018-11-07T12:29:56Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@bugale for the test, you can do the same as your initial crash report but with PowerShell:\r\n\r\n```powershell\r\n$si = [System.Diagnostics.ProcessStartInfo]::new()\r\n$si.FileName = \"pwsh\"\r\n$si.RedirectStandardInput = $true\r\n$si.RedirectStandardOutput = $true\r\n$si.RedirectStandardError = $true\r\n$pwsh = [System.Diagnostics.Process]::Start($si)\r\n$pwsh.StandardInput.Write(\"`b\")\r\n$pwsh.StandardInput.Write(\"`b\")\r\n```\r\n\r\nThe second write causes a broken pipe on my macBook.  However, it doesn't fail on my Windows machine.",
      "created_at": "2018-11-08T05:36:47Z",
      "updated_at": "2018-11-08T05:36:47Z"
    },
    {
      "author": "msftclas",
      "author_association": "NONE",
      "body": "[![CLA assistant check](https://cla.opensource.microsoft.com/pull/badge/signed)](https://cla.opensource.microsoft.com/PowerShell/PowerShell?pullRequest=8196) <br/>All CLA requirements met.",
      "created_at": "2018-11-08T09:39:51Z",
      "updated_at": "2018-11-08T09:41:15Z"
    },
    {
      "author": "bugale",
      "author_association": "CONTRIBUTOR",
      "body": "I have added a test. I validated it fails before my change, and passes after it.\r\nUnfortunately, it takes 10 seconds to pass, but when the crash happens, it takes ~5 seconds, so I couldn't think of a better way.",
      "created_at": "2018-11-08T09:40:18Z",
      "updated_at": "2018-11-08T09:40:18Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> it takes 10 seconds to pass\r\n\r\nAre you sure that it is not timeout?",
      "created_at": "2018-11-08T12:10:28Z",
      "updated_at": "2018-11-08T12:10:28Z"
    },
    {
      "author": "bugale",
      "author_association": "CONTRIBUTOR",
      "body": "It is a timeout, for the function WaitForExit.\r\nI do something that crashes the shell without my fix, but it takes ~5 seconds to crash.\r\nSo in the test, I wait for the crash with a timeout of 10 seconds. If the timeout was reached, it means the process did not crash and there is no bug.\r\nWithout my fix, though, the shell crashes before the timeout passes, which fails the test.",
      "created_at": "2018-11-08T12:36:55Z",
      "updated_at": "2018-11-08T12:36:55Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "\ud83d\ude15 This is not a reliable test - we can get a \"race condition\". @SteveL-MSFT I believe we should think about xUnit test.",
      "created_at": "2018-11-08T13:08:43Z",
      "updated_at": "2018-11-08T13:08:43Z"
    },
    {
      "author": "bugale",
      "author_association": "CONTRIBUTOR",
      "body": "> \ud83d\ude15 This is not a reliable test - we can get a \"race condition\". @SteveL-MSFT I believe we should think about xUnit test.\r\n\r\nI changed it now to rely on the output",
      "created_at": "2018-11-08T13:54:51Z",
      "updated_at": "2018-11-08T13:54:51Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "PowerShell-CI-linux termporary failed and was restarted.",
      "created_at": "2018-11-08T14:32:37Z",
      "updated_at": "2018-11-08T14:32:37Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@bugale Thanks for your contribution!",
      "created_at": "2018-11-10T13:55:45Z",
      "updated_at": "2018-11-10T13:55:56Z"
    }
  ],
  "created_at": "2018-11-06T18:33:16Z",
  "number": 8196,
  "state": "closed",
  "title": "Ignoring backspace for empty lines on stdin/stdout mode",
  "updated_at": "2019-01-17T04:38:56Z"
}