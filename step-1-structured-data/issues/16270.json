{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16270",
  "author": "daxian-dbw",
  "body": "### Prerequisites\r\n\r\n- [X] Write a descriptive title.\r\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- [X] Search the existing issues.\r\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n\r\n### Steps to reproduce\r\n\r\n1. Open `pwsh`\r\n2. Run the following code\r\n    ```\r\n    Enable-RunspaceDebug -ProcessName powershell\r\n    ```\r\n3. The value to `-ProcessName` could be the name of any process that hosting PowerShell in it.\r\n\r\n--------------------------\r\n\r\nThis is because the debug preference cache file is set to be under the `ProgramFiles` folder, which requires administrator privilege to create and write to the file.\r\nOn Unix platforms, the file is set to be under `/bin`, and thus root privilege is required.\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/b4c5c29dff70f4cf06e60aa0f343a47123f34b37/src/System.Management.Automation/engine/hostifaces/LocalConnection.cs#L366-L367\r\n\r\nSo now, `Enable-RunspaceDebug -ProcessName powershell` has to be invoked with admin privilege on all platforms in order for it to work. It's not clear to me why the cache file is set to be under the `ProgramFiles` folder, and whether it's really needed.\r\n\r\n\r\n### Expected behavior\r\n\r\n```console\r\nCommand ran successful.\r\n```\r\n\r\n\r\n### Actual behavior\r\n\r\n```console\r\nPS:1> Enable-RunspaceDebug -ProcessName powershell\r\nEnable-RunspaceDebug: Failed to persist debug options for Process powershell.\r\n\r\n\r\nInnerException :\r\n    Type       : System.UnauthorizedAccessException\r\n    Message    : Access to the path 'C:\\Program Files\\WindowsPowerShell\\DebugPreference.clixml' is denied.\r\n```\r\n\r\n\r\n### Error details\r\n\r\n```console\r\nPS:2> Get-Error\r\n\r\nException             :\r\n    Type           : System.Management.Automation.PSInvalidOperationException\r\n    ErrorRecord    :\r\n        Exception             :\r\n            Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n            Message : Failed to persist debug options for Process powershell.\r\n            HResult : -2146233087\r\n        CategoryInfo          : InvalidOperation: (:) [], ParentContainsErrorRecordException\r\n        FullyQualifiedErrorId : InvalidOperation\r\n    Message        : Failed to persist debug options for Process powershell.\r\n    InnerException :\r\n        Type           : System.Management.Automation.CmdletInvocationException\r\n        ErrorRecord    :\r\n            Exception             :\r\n                Type       : System.UnauthorizedAccessException\r\n                TargetSite :\r\n                    Name          : CreateFile\r\n                    DeclaringType : Microsoft.Win32.SafeHandles.SafeFileHandle\r\n                    MemberType    : Method\r\n                    Module        : System.Private.CoreLib.dll\r\n                Message    : Access to the path 'C:\\Program Files\\WindowsPowerShell\\DebugPreference.clixml' is denied.\r\n                Source     : System.Private.CoreLib\r\n                HResult    : -2147024891\r\n                StackTrace :\r\n   at Microsoft.Win32.SafeHandles.SafeFileHandle.CreateFile(String fullPath, FileMode mode, FileAccess access, FileShare share, FileOptions options)\r\nin System.Private.CoreLib.dll:token 0x600011b+0xa1\r\n   at Microsoft.Win32.SafeHandles.SafeFileHandle.Open(String fullPath, FileMode mode, FileAccess access, FileShare share, FileOptions options, Int64\r\npreallocationSize) in System.Private.CoreLib.dll:token 0x600011a+0x6\r\n   at System.IO.Strategies.WindowsFileStreamStrategy..ctor(String path, FileMode mode, FileAccess access, FileShare share, FileOptions options,\r\nInt64 preallocationSize) in System.Private.CoreLib.dll:token 0x6005e2a+0x2b\r\n   at System.IO.Strategies.FileStreamHelpers.ChooseStrategyCore(String path, FileMode mode, FileAccess access, FileShare share, Int32 bufferSize,\r\nFileOptions options, Int64 preallocationSize) in System.Private.CoreLib.dll:token 0x6005d8c+0x28\r\n   at System.IO.FileStream..ctor(String path, FileMode mode, FileAccess access, FileShare share) in System.Private.CoreLib.dll:token 0x60059c8+0x0\r\n   at System.Management.Automation.PathUtils.MasterStreamOpen(PSCmdlet cmdlet, String filePath, Encoding resolvedEncoding, Boolean defaultEncoding,\r\nBoolean Append, Boolean Force, Boolean NoClobber, FileStream& fileStream, StreamWriter& streamWriter, FileInfo& readOnlyFileInfo, Boolean\r\nisLiteralPath) in System.Management.Automation.dll:token 0x6004241+0x68\r\n            CategoryInfo          : OpenError: (:) [Export-Clixml], UnauthorizedAccessException\r\n            FullyQualifiedErrorId : FileOpenFailure,Microsoft.PowerShell.Commands.ExportClixmlCommand\r\n            InvocationInfo        :\r\n                MyCommand       : Export-Clixml\r\n                HistoryId       : 1\r\n                InvocationName  : Export-Clixml\r\n                CommandOrigin   : Internal\r\n        TargetSite     :\r\n            Name          : Invoke\r\n            DeclaringType : System.Management.Automation.Runspaces.PipelineBase, System.Management.Automation, Version=7.2.0.9, Culture=neutral,\r\nPublicKeyToken=31bf3856ad364e35\r\n            MemberType    : Method\r\n            Module        : System.Management.Automation.dll\r\n        Message        : Access to the path 'C:\\Program Files\\WindowsPowerShell\\DebugPreference.clixml' is denied.\r\n        InnerException :\r\n            Type       : System.UnauthorizedAccessException\r\n            TargetSite :\r\n                Name          : CreateFile\r\n                DeclaringType : Microsoft.Win32.SafeHandles.SafeFileHandle\r\n                MemberType    : Method\r\n                Module        : System.Private.CoreLib.dll\r\n            Message    : Access to the path 'C:\\Program Files\\WindowsPowerShell\\DebugPreference.clixml' is denied.\r\n            Source     : System.Private.CoreLib\r\n            HResult    : -2147024891\r\n            StackTrace :\r\n   at Microsoft.Win32.SafeHandles.SafeFileHandle.CreateFile(String fullPath, FileMode mode, FileAccess access, FileShare share, FileOptions options)\r\nin System.Private.CoreLib.dll:token 0x600011b+0xa1\r\n   at Microsoft.Win32.SafeHandles.SafeFileHandle.Open(String fullPath, FileMode mode, FileAccess access, FileShare share, FileOptions options, Int64\r\npreallocationSize) in System.Private.CoreLib.dll:token 0x600011a+0x6\r\n   at System.IO.Strategies.WindowsFileStreamStrategy..ctor(String path, FileMode mode, FileAccess access, FileShare share, FileOptions options,\r\nInt64 preallocationSize) in System.Private.CoreLib.dll:token 0x6005e2a+0x2b\r\n   at System.IO.Strategies.FileStreamHelpers.ChooseStrategyCore(String path, FileMode mode, FileAccess access, FileShare share, Int32 bufferSize,\r\nFileOptions options, Int64 preallocationSize) in System.Private.CoreLib.dll:token 0x6005d8c+0x28\r\n   at System.IO.FileStream..ctor(String path, FileMode mode, FileAccess access, FileShare share) in System.Private.CoreLib.dll:token 0x60059c8+0x0\r\n   at System.Management.Automation.PathUtils.MasterStreamOpen(PSCmdlet cmdlet, String filePath, Encoding resolvedEncoding, Boolean defaultEncoding,\r\nBoolean Append, Boolean Force, Boolean NoClobber, FileStream& fileStream, StreamWriter& streamWriter, FileInfo& readOnlyFileInfo, Boolean\r\nisLiteralPath) in System.Management.Automation.dll:token 0x6004241+0x68\r\n        Source         : System.Management.Automation\r\n        HResult        : -2146233087\r\n        StackTrace     :\r\n   at System.Management.Automation.Runspaces.PipelineBase.Invoke(IEnumerable input) in System.Management.Automation.dll:token 0x600537f+0xb0\r\n   at System.Management.Automation.PowerShell.Worker.ConstructPipelineAndDoWork(Runspace rs, Boolean performSyncInvoke) in\r\nSystem.Management.Automation.dll:token 0x6006cf2+0x129\r\n   at System.Management.Automation.PowerShell.Worker.CreateRunspaceIfNeededAndDoWork(Runspace rsToUse, Boolean isSync) in\r\nSystem.Management.Automation.dll:token 0x6006cf0+0x94\r\n   at System.Management.Automation.PowerShell.CoreInvokeHelper[TInput,TOutput](PSDataCollection`1 input, PSDataCollection`1 output,\r\nPSInvocationSettings settings) in System.Management.Automation.dll:token 0x6002821+0xd8\r\n   at System.Management.Automation.PowerShell.CoreInvoke[TInput,TOutput](PSDataCollection`1 input, PSDataCollection`1 output, PSInvocationSettings\r\nsettings) in System.Management.Automation.dll:token 0x6002823+0x1ae\r\n   at System.Management.Automation.PowerShell.CoreInvoke[TOutput](IEnumerable input, PSDataCollection`1 output, PSInvocationSettings settings) in\r\nSystem.Management.Automation.dll:token 0x6002820+0x43\r\n   at System.Management.Automation.PowerShell.Invoke(IEnumerable input, PSInvocationSettings settings) in System.Management.Automation.dll:token\r\n0x60027e6+0x5\r\n   at System.Management.Automation.Runspaces.LocalRunspace.SetDebugPreference(String processName, List`1 appDomainName, Boolean enable) in\r\nSystem.Management.Automation.dll:token 0x60052cb+0x20b\r\n   at Microsoft.PowerShell.Commands.CommonRunspaceCommandBase.SetDebugPreferenceHelper(String processName, String[] appDomainName, Boolean enable,\r\nString fullyQualifiedErrorId) in Microsoft.PowerShell.Commands.Utility.dll:token 0x6000355+0x37\r\n    HResult        : -2146233079\r\nTargetObject          : Microsoft.PowerShell.Commands.EnableRunspaceDebugCommand\r\nCategoryInfo          : InvalidOperation: (Microsoft.PowerShel\u2026unspaceDebugCommand:EnableRunspaceDebugCommand) [Enable-RunspaceDebug],\r\nPSInvalidOperationException\r\nFullyQualifiedErrorId : EnableRunspaceDebugCommandPersistDebugPreferenceFailure,Microsoft.PowerShell.Commands.EnableRunspaceDebugCommand\r\nInvocationInfo        :\r\n    MyCommand        : Enable-RunspaceDebug\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 1\r\n    HistoryId        : 1\r\n    Line             : Enable-RunspaceDebug -ProcessName powershell\r\n    PositionMessage  : At line:1 char:1\r\n                       + Enable-RunspaceDebug -ProcessName powershell\r\n                       + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    InvocationName   : Enable-RunspaceDebug\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\nPipelineIterationInfo :\r\n```\r\n\r\n\r\n### Environment data\r\n\r\n```powershell\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.0-preview.10\r\nPSEdition                      Core\r\nGitCommitId                    7.2.0-preview.10\r\nOS                             Microsoft Windows 10.0.19043\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\n\r\n### Visuals\r\n\r\n![Animation](https://user-images.githubusercontent.com/127450/137822425-3c2eb993-85c1-4b32-808b-09ae437f6907.gif)\r\n\r\n\r\n",
  "closed_at": null,
  "comments": [
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@PaulHigin can you please take a look? Thanks!",
      "created_at": "2021-10-18T23:15:33Z",
      "updated_at": "2021-10-18T23:15:33Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "I am unable to repro this on Windows as the repro steps show.  $env:ProgramFiles is accessible for non-admin users.  I don't recall being involved in writing this code and don't know why programfiles location was chosen for persistence.",
      "created_at": "2021-10-18T23:54:30Z",
      "updated_at": "2021-10-18T23:54:30Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "Thanks @PaulHigin. I thought you might get involved in this code :)\r\nI can consistently repro this, in 7.2.0-preview.10 as well. I updated the issue description with a GIF in the `Visuals` section.\r\n\r\n\"Program Files\" doesn't seem to allow non-admin user to write:\r\n\r\n![image](https://user-images.githubusercontent.com/127450/137822710-3f210f57-02ea-445e-be5c-b735822f3752.png)\r\n",
      "created_at": "2021-10-19T00:07:28Z",
      "updated_at": "2021-10-19T00:10:59Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I can confirm original repro. Perhaps @PaulHigin already has the file enabled for writing.\r\n\r\n> don't know why programfiles location was chosen for persistence.\r\n\r\nHas Enable-RunspaceDebug anything else that requires elevated permissions? ",
      "created_at": "2021-10-19T05:17:51Z",
      "updated_at": "2021-10-19T05:19:45Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "I do see this on a new a VM with the latest image, so maybe it is a change in default permissions.  Anyway, it is an easy thing to fix where the cache file resides, and also seems like a low priority issue.\r\n\r\nThis code has been around at least since WindowsPowerShell 5, so it seems like a problem would have been noticed before.",
      "created_at": "2021-10-19T16:04:41Z",
      "updated_at": "2021-10-19T16:05:29Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@WG-Remoting\r\nRemoting working group agrees that this is a bug but not in the remoting layer.  Removing remoting label and adding debugging label.",
      "created_at": "2022-04-07T18:12:16Z",
      "updated_at": "2022-04-07T18:12:16Z"
    }
  ],
  "created_at": "2021-10-18T23:14:48Z",
  "number": 16270,
  "state": "open",
  "title": "`Enable-RunspaceDebug -ProcessName` fails on Windows and Unix platforms",
  "updated_at": "2022-04-07T18:12:17Z"
}