{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17868",
  "author": "SeeminglyScience",
  "body": "### Steps to reproduce\r\n\r\n1. Create a new scope\r\n2. Create a steppable pipeline and run begin\r\n3. Let that scope be cleaned up by the engine\r\n4. Run process on the pipeline created in step 2\r\n5. The scope in the steppable pipeline is not detached from global\r\n\r\n```powershell\r\nfunction testing { process { Get-Date } }\r\n$pipe = & {\r\n    $pipe = { testing }.GetSteppablePipeline('Internal')\r\n    $pipe.Begin($true)\r\n    return $pipe\r\n}\r\n\r\n& { $pipe.Process('some input') }\r\n```\r\n\r\n### Expected behavior\r\n\r\nMaybe an error message saying that the scope is no longer valid, or even just documentation saying this is results in undefined behavior. Best case scenario, it returns the date.\r\n\r\n### Actual behavior\r\n\r\n```console\r\nGet-Date:\r\nLine |\r\n   2 |  function testing { process { Get-Date }}\r\n     |                               ~~~~~~~~\r\n     | The term 'Get-Date' is not recognized as a name of a cmdlet, function, script file, or executable program.\r\nCheck the spelling of the name, or if a path was included, verify that the path is correct and try again.\r\n\r\nSuggestion [4,General]: The most similar commands are: Get-Date, Set-Date, Test-Date, Get-Dtc\r\n```\r\n\r\n\r\n### Error details\r\n\r\nAlso in a debug build this assert fails:\r\n\r\n<details>\r\n\r\n<summary>\r\n\r\n### Long call stack, click to expand</summary>\r\n\r\n```console\r\nProcess terminated. Assertion failed.\r\nThe scope specified to be set in CurrentScope is not in the global scope lineage. All scopes must originate from the global scope.\r\n   at System.Management.Automation.Diagnostics.Assert(Boolean condition, String whyThisShouldNeverHappen, String detailMessage) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\utils\\assert.cs:line 202\r\n   at System.Management.Automation.Diagnostics.Assert(Boolean condition, String whyThisShouldNeverHappen) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\utils\\assert.cs:line 134\r\n   at System.Management.Automation.SessionStateInternal.set_CurrentScope(SessionStateScope value) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\SessionStateScopeAPIs.cs:line 202\r\n   at System.Management.Automation.CommandProcessorBase.SetCurrentScopeToExecutionScope() in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\CommandProcessorBase.cs:line 363\r\n   at System.Management.Automation.CommandProcessorBase.DoExecute() in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\CommandProcessorBase.cs:line 563\r\n   at System.Management.Automation.Internal.PipelineProcessor.Inject(Object input, Boolean enumerate) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\pipeline.cs:line 1216\r\n   at System.Management.Automation.Internal.PipelineProcessor.Step(Object input) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\pipeline.cs:line 936\r\n   at System.Management.Automation.SteppablePipeline.Process(Object input) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\lang\\scriptblock.cs:line 1204\r\n   at System.Dynamic.UpdateDelegates.UpdateAndExecute2[T0,T1,TRet](CallSite site, T0 arg0, T1 arg1)\r\n   at System.Management.Automation.Interpreter.DynamicInstruction`3.Run(InterpretedFrame frame) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\interpreter\\DynamicInstructions.Generated.cs:line 166\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\interpreter\\ControlFlowInstructions.cs:line 355\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\interpreter\\ControlFlowInstructions.cs:line 355\r\n   at System.Management.Automation.Interpreter.Interpreter.Run(InterpretedFrame frame) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\interpreter\\Interpreter.cs:line 105\r\n   at System.Management.Automation.Interpreter.LightLambda.RunVoid1[T0](T0 arg0) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\interpreter\\LightLambda.Generated.cs:line 81\r\n   at System.Management.Automation.DlrScriptCommandProcessor.RunClause(Action`1 clause, Object dollarUnderbar, Object inputToProcess) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\ScriptCommandProcessor.cs:line 575\r\n   at System.Management.Automation.DlrScriptCommandProcessor.Complete() in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\ScriptCommandProcessor.cs:line 426\r\n   at System.Management.Automation.CommandProcessorBase.DoComplete() in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\CommandProcessorBase.cs:line 631\r\n   at System.Management.Automation.Internal.PipelineProcessor.DoCompleteCore(CommandProcessorBase commandRequestingUpstreamCommandsToStop) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\pipeline.cs:line 619\r\n   at System.Management.Automation.Internal.PipelineProcessor.SynchronousExecuteEnumerate(Object input) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\pipeline.cs:line 504   at System.Management.Automation.PipelineOps.InvokePipeline(Object input, Boolean ignoreInput, CommandParameterInternal[][] pipeElements, CommandBaseAst[] pipeElementAsts, CommandRedirection[][] commandRedirections, FunctionContext funcContext) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\runtime\\Operations\\MiscOps.cs:line 495\r\n   at System.Management.Automation.Interpreter.ActionCallInstruction`6.Run(InterpretedFrame frame) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\interpreter\\CallInstruction.Generated.cs:line 608\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\interpreter\\ControlFlowInstructions.cs:line 355\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\interpreter\\ControlFlowInstructions.cs:line 355\r\n   at System.Management.Automation.Interpreter.Interpreter.Run(InterpretedFrame frame) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\interpreter\\Interpreter.cs:line 105\r\n   at System.Management.Automation.Interpreter.LightLambda.RunVoid1[T0](T0 arg0) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\interpreter\\LightLambda.Generated.cs:line 81\r\n   at System.Management.Automation.DlrScriptCommandProcessor.RunClause(Action`1 clause, Object dollarUnderbar, Object inputToProcess) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\ScriptCommandProcessor.cs:line 575\r\n   at System.Management.Automation.DlrScriptCommandProcessor.Complete() in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\ScriptCommandProcessor.cs:line 426\r\n   at System.Management.Automation.CommandProcessorBase.DoComplete() in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\CommandProcessorBase.cs:line 631\r\n   at System.Management.Automation.Internal.PipelineProcessor.DoCompleteCore(CommandProcessorBase commandRequestingUpstreamCommandsToStop) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\pipeline.cs:line 619\r\n   at System.Management.Automation.Internal.PipelineProcessor.SynchronousExecuteEnumerate(Object input) in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\pipeline.cs:line 504   at System.Management.Automation.Runspaces.LocalPipeline.InvokeHelper() in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\hostifaces\\LocalPipeline.cs:line 400\r\n   at System.Management.Automation.Runspaces.LocalPipeline.InvokeThreadProc() in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\hostifaces\\LocalPipeline.cs:line 588\r\n   at System.Management.Automation.Runspaces.LocalPipeline.InvokeThreadProcImpersonate() in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\hostifaces\\LocalPipeline.cs:line 544\r\n   at System.Management.Automation.Runspaces.PipelineThread.WorkerProc() in C:\\Projects\\PowerShell\\src\\System.Management.Automation\\engine\\hostifaces\\LocalPipeline.cs:line 1217\r\n   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)\r\n```\r\n\r\n</details>\r\n\r\n### Environment data\r\n\r\n```powershell\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.3.0-preview.6\r\nPSEdition                      Core\r\nGitCommitId                    7.3.0-preview.6\r\nOS                             Microsoft Windows 10.0.19044\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\n\r\n### Visuals\r\n\r\n_No response_",
  "closed_at": null,
  "comments": [
    {
      "author": "SeeminglyScience",
      "author_association": "COLLABORATOR",
      "body": "Note that this kinda makes writing a class that utilizes steppable pipeline somewhat impossible. At least if the target command is defined within the same module as the class.",
      "created_at": "2022-08-10T19:27:06Z",
      "updated_at": "2022-08-10T19:27:06Z"
    }
  ],
  "created_at": "2022-08-10T19:21:25Z",
  "number": 17868,
  "state": "open",
  "title": "Using `SteppablePipeline` outside of the scope it was created in results in undefined behavior",
  "updated_at": "2022-08-10T19:27:06Z"
}