{
  "_url": "https://github.com/PowerShell/PowerShell/issues/5070",
  "author": "daxian-dbw",
  "body": "Fix #5029 \r\n\r\nThe Fix\r\n-------\r\n- Remove the check for `Visual C++ Redistributable`\r\n- Add a precheck for WMF 4.0 on Win7.\r\n\r\n`pwrshplugin.dll` has the following dependencies. All the `api-ms-win-crt-*` api sets are part of the `Universal C Runtime`. The plugin DLL doesn't depend on `Visual C++ Redistributable`.\r\n```\r\n    KERNEL32.dll\r\n    ole32.dll\r\n    WsmSvc.DLL\r\n    api-ms-win-crt-string-l1-1-0.dll\r\n    api-ms-win-crt-convert-l1-1-0.dll\r\n    api-ms-win-crt-heap-l1-1-0.dll\r\n    api-ms-win-crt-runtime-l1-1-0.dll\r\n    api-ms-win-crt-stdio-l1-1-0.dll\r\n    api-ms-win-crt-filesystem-l1-1-0.dll\r\n    ADVAPI32.dll\r\n    api-ms-win-crt-locale-l1-1-0.dll\r\n    api-ms-win-crt-multibyte-l1-1-0.dll\r\n```\r\n\r\nOn Win7, WMF 4.0 or higher version needs to be installed so that the WinRM can support the side-by-side remoting plugin. So I make the WMF 4.0 a prerequisite too. \r\nThe way to check PSv4 or above is to check the file version of `\\windows\\system32\\pwrshplugin.dll`. The file version for in-box PSv4 is `6.3.9600.16384`, for WMF 4.0 is `6.3.9600.16406`, and for PSv5+ is `10.0.xxx`. So we can check the MinVersion of the file `pwrshplugin.dll` to be `6.3.9600.16383` (means the version needs to be at least `6.3.9600.16384`).\r\n\r\n**I have verified that on 2012R2, Win8.1 and Win7 once `Universal C Runtime` is installed (it requires a lot of other KB's to be installed) and PSv4 or WMF 4 is available, PowerShell remoting works.**\r\n\r\nScreenshot Examples\r\n----------\r\n**On a machine that doesn't have `Universal C Runtime` installed:**\r\n![image](https://user-images.githubusercontent.com/127450/31361654-2aea10ea-ad09-11e7-893b-2fe0fc995548.png)\r\n\r\n**On Win7 that has `Universal C Runtime` installed but no WMF 4 or above**\r\n![image](https://user-images.githubusercontent.com/127450/31361689-63d9cc6a-ad09-11e7-82c9-8ed53a669d64.png)\r\n",
  "closed_at": "2017-10-10T23:40:08Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Interesting, can an user copy the link we show on error window? Can we do the link clickable?",
      "created_at": "2017-10-10T04:11:16Z",
      "updated_at": "2017-10-10T04:11:16Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@iSazonov unfortunately, the text the installer displays is not clickable or copyable.  Will have to research wix to figure out how to have a custom window that has a clickable link.",
      "created_at": "2017-10-10T04:34:04Z",
      "updated_at": "2017-10-10T04:34:04Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@iSazonov it's good that we are now using the short URL \"http://aka.ms/pscore6-prereq\". It mitigates the problem to some extent.",
      "created_at": "2017-10-10T04:38:14Z",
      "updated_at": "2017-10-10T04:38:14Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Can we use http://www.installsite.org/pages/en/msi/articles/careful-with-that-hyperlink-on-your-msi-dialog/index.htm ?\r\nAnother case is to create Open/Cancel buttons.",
      "created_at": "2017-10-10T05:55:05Z",
      "updated_at": "2017-10-10T05:56:05Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "Perhaps we should accept this PR as-is (barring any other concerns) and have a new PR/issue for the custom hyperlink control?",
      "created_at": "2017-10-10T16:20:31Z",
      "updated_at": "2017-10-10T16:20:31Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "We can not rush to the next Beta.9 release.",
      "created_at": "2017-10-10T17:31:47Z",
      "updated_at": "2017-10-10T17:31:47Z"
    },
    {
      "author": "bergmeister",
      "author_association": "CONTRIBUTOR",
      "body": "As far as I have seen the message dialog does not allow hyperlinks but the [WiX Cookbook](http://file.allitebooks.com/20160307/WiX%20Cookbook.pdf) gives examples on how to deal with hyperlinks in chapter 11:\r\n\r\nOne could add a custom action that opens the browser if the installation failed due to the pre-requisite check or embed the hyperlink in a custom WiX exit dialogue in case of failure.",
      "created_at": "2017-10-10T21:28:00Z",
      "updated_at": "2017-10-10T21:48:55Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@adityapatwardhan and @bergmeister Thanks for your feedback and I have addressed them. Please take another look.",
      "created_at": "2017-10-10T21:53:01Z",
      "updated_at": "2017-10-10T21:53:01Z"
    },
    {
      "author": "bergmeister",
      "author_association": "CONTRIBUTOR",
      "body": "@daxian-dbw Should we also add the new WMF download URLS to the installer tests as their purpose is simply to check that links are still working?",
      "created_at": "2017-10-10T22:38:13Z",
      "updated_at": "2017-10-10T22:53:42Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@daxian-dbw Please use `[Feature]` in the last git commit message so that the modified test is executed.",
      "created_at": "2017-10-10T22:49:51Z",
      "updated_at": "2017-10-10T22:49:51Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@bergmeister new tests are added to verify the WMF download URLs\r\n@adityapatwardhan the latest commit was pushed with `[Feature]` tag.",
      "created_at": "2017-10-10T22:58:43Z",
      "updated_at": "2017-10-10T22:58:43Z"
    },
    {
      "author": "bergmeister",
      "author_association": "CONTRIBUTOR",
      "body": "LGTM",
      "created_at": "2017-10-10T23:11:45Z",
      "updated_at": "2017-10-10T23:11:45Z"
    }
  ],
  "created_at": "2017-10-09T22:49:32Z",
  "number": 5070,
  "state": "closed",
  "title": "Fix the prerequisite check of MSI package",
  "updated_at": "2017-10-11T04:08:09Z"
}