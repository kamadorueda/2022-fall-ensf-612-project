{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17848",
  "author": "kahnman",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nWhen I try to run the following code using pwsh 7.2.5...\r\n``` powershell \r\n$myNumberString = 'My Number: '\r\n$myArray = @(1,2,3,4,5,6,7)\r\n$foreachScriptBlock = {\r\n    Write-Host \"$($using:myNumberString) $_\"\r\n}\r\n$foreachSplat = @{}\r\n$foreachSplat.Add('Parallel',$foreachScriptBlock)\r\n$myArray | ForEach-Object @foreachSplat\r\n```\r\n\r\nI get the errors:\r\n``` powershell\r\nInvalidOperation:\r\nLine |\r\n   2 |      Write-Host \"$($using:myNumberString) $_\"\r\n     |                    ~~~~~~~~~~~~~~~~~~~~~\r\n     | A Using variable cannot be retrieved. A Using variable can be used only with Invoke-Command, Start-Job, or InlineScript in the script workflow. When it is used with Invoke-Command, the Using variable is valid only if the script block is invoked on a remote computer.\r\n 1\r\nInvalidOperation:\r\nLine |\r\n   2 |      Write-Host \"$($using:myNumberString) $_\"\r\n     |                    ~~~~~~~~~~~~~~~~~~~~~\r\n     | A Using variable cannot be retrieved. A Using variable can be used only with Invoke-Command, Start-Job, or InlineScript in the script workflow. When it is used with Invoke-Command, the Using variable is valid only if the script block is invoked on a remote computer.\r\nInvalidOperation:\r\nLine |\r\n   2 |      Write-Host \"$($using:myNumberString) $_\"\r\n     |                    ~~~~~~~~~~~~~~~~~~~~~\r\n     | A Using variable cannot be retrieved. A Using variable can be used only with Invoke-Command, Start-Job, or InlineScript in the script workflow. When it is used with Invoke-Command, the Using variable is valid only if the script block is invoked on a remote computer.\r\n 3\r\n 2\r\nInvalidOperation:\r\nLine |\r\n   2 |      Write-Host \"$($using:myNumberString) $_\"\r\n     |                    ~~~~~~~~~~~~~~~~~~~~~\r\n     | A Using variable cannot be retrieved. A Using variable can be used only with Invoke-Command, Start-Job, or InlineScript in the script workflow. When it is used with Invoke-Command, the Using variable is valid only if the script block is invoked on a remote computer.\r\nInvalidOperation:\r\nLine |\r\n   2 |      Write-Host \"$($using:myNumberString) $_\"\r\n     |                    ~~~~~~~~~~~~~~~~~~~~~\r\n     | A Using variable cannot be retrieved. A Using variable can be used only with Invoke-Command, Start-Job, or InlineScript in the script workflow. When it is used with Invoke-Command, the Using variable is valid only if the script block is invoked on a remote computer.\r\n 5\r\n 4\r\nInvalidOperation:\r\nLine |\r\n   2 |      Write-Host \"$($using:myNumberString) $_\"\r\n     |                    ~~~~~~~~~~~~~~~~~~~~~\r\n     | A Using variable cannot be retrieved. A Using variable can be used only with Invoke-Command, Start-Job, or InlineScript in the script workflow. When it is used with Invoke-Command, the Using variable is valid only if the script block is invoked on a remote computer.\r\n 6\r\nInvalidOperation:\r\nLine |\r\n   2 |      Write-Host \"$($using:myNumberString) $_\"\r\n     |                    ~~~~~~~~~~~~~~~~~~~~~\r\n     | A Using variable cannot be retrieved. A Using variable can be used only with Invoke-Command, Start-Job, or InlineScript in the script workflow. When it is used with Invoke-Command, the Using variable is valid only if the script block is invoked on a remote computer.\r\n 7\r\n```\r\n\r\nNote that the above code works when run using pwsh 7.1.1.\n\n### Expected behavior\n\n```console\n> $myNumberString = 'My Number: '\r\n> $myArray = @(1,2,3,4,5,6,7)\r\n> $foreachScriptBlock = {\r\n>>     Write-Host \"$($using:myNumberString) $_\"\r\n>> }\r\n> $foreachSplat = @{}\r\n> $foreachSplat.Add('Parallel',$foreachScriptBlock)\r\n$myArray | ForEach-Object @foreachSplat\r\nMy Number:  1\r\nMy Number:  2\r\nMy Number:  5\r\nMy Number:  6\r\nMy Number:  3\r\nMy Number:  7\r\nMy Number:  4\n```\n\n\n### Actual behavior\n\n```console\nThe \"My Number: \" string is not written, only the numbers from $myArray. See the errors above.\n```\n\n\n### Error details\n\n```console\n> get-error\r\n\r\nException             :\r\n    Type        : System.Management.Automation.RuntimeException\r\n    ErrorRecord :\r\n        Exception             :\r\n            Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n            Message : A Using variable cannot be retrieved. A Using variable can be used only with Invoke-Command,\r\nStart-Job, or InlineScript in the script workflow. When it is used with Invoke-Command, the Using variable is valid\r\nonly if the script block is invoked on a remote computer.\r\n            HResult : -2146233087\r\n        CategoryInfo          : InvalidOperation: (:) [], ParentContainsErrorRecordException\r\n        FullyQualifiedErrorId : UsingWithoutInvokeCommand\r\n        InvocationInfo        :\r\n            ScriptLineNumber : 2\r\n            OffsetInLine     : 19\r\n            HistoryId        : -1\r\n            Line             :     Write-Host \"$($using:myNumberString) $_\"\r\n\r\n            PositionMessage  : At line:2 char:19\r\n                               +     Write-Host \"$($using:myNumberString) $_\"\r\n                               +                   ~~~~~~~~~~~~~~~~~~~~~\r\n            CommandOrigin    : Internal\r\n        ScriptStackTrace      : at <ScriptBlock>, <No file>: line 2\r\n    TargetSite  :\r\n        Name          : GetUsingValue\r\n        DeclaringType : System.Management.Automation.VariableOps, System.Management.Automation, Version=7.2.5.500,\r\nCulture=neutral, PublicKeyToken=31bf3856ad364e35\r\n        MemberType    : Method\r\n        Module        : System.Management.Automation.dll\r\n    Message     : A Using variable cannot be retrieved. A Using variable can be used only with Invoke-Command,\r\nStart-Job, or InlineScript in the script workflow. When it is used with Invoke-Command, the Using variable is valid\r\nonly if the script block is invoked on a remote computer.\r\n    Data        : System.Collections.ListDictionaryInternal\r\n    Source      : System.Management.Automation\r\n    HResult     : -2146233087\r\n    StackTrace  :\r\n   at System.Management.Automation.VariableOps.GetUsingValue(MutableTuple tuple, String usingExpressionKey, Int32\r\nindex, ExecutionContext context)\r\n   at System.Management.Automation.Interpreter.FuncCallInstruction`5.Run(InterpretedFrame frame)\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\r\nCategoryInfo          : InvalidOperation: (:) [], RuntimeException\r\nFullyQualifiedErrorId : UsingWithoutInvokeCommand\r\nInvocationInfo        :\r\n    ScriptLineNumber : 2\r\n    OffsetInLine     : 19\r\n    HistoryId        : -1\r\n    Line             :     Write-Host \"$($using:myNumberString) $_\"\r\n\r\n    PositionMessage  : At line:2 char:19\r\n                       +     Write-Host \"$($using:myNumberString) $_\"\r\n                       +                   ~~~~~~~~~~~~~~~~~~~~~\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 2\n```\n\n\n### Environment data\n\n```powershell\n> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.5\r\nPSEdition                      Core\r\nGitCommitId                    7.2.5\r\nOS                             Microsoft Windows 10.0.17763\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": "2022-08-05T02:58:07Z",
  "comments": [
    {
      "author": "237dmitry",
      "author_association": "NONE",
      "body": "Your example works without `$using`\r\n\r\n```powershell\r\n$myNumberString = 'My Number: '\r\n$myArray = @(1,2,3,4,5,6,7)\r\n\r\n# $foreachScriptBlock = [scriptblock]::Create( \"Write-Host $myNumberString `$_\" )\r\n$foreachScriptBlock = { \"Write-Host $myNumberString $_\" }\r\n\r\n$foreachSplat = @{}\r\n$foreachSplat.Add('Parallel',$foreachScriptBlock)\r\n\r\n$myArray | ForEach-Object @foreachSplat\r\n```",
      "created_at": "2022-08-04T15:55:08Z",
      "updated_at": "2022-08-04T15:55:08Z"
    },
    {
      "author": "jborean93",
      "author_association": "COLLABORATOR",
      "body": "This is a duplicate of https://github.com/PowerShell/PowerShell/issues/12378 which has been fixed in 7.3.x and I believe they are trying to backport the fix to the 7.2.x series but not sure on the status of that.",
      "created_at": "2022-08-04T18:57:51Z",
      "updated_at": "2022-08-04T18:57:51Z"
    },
    {
      "author": "kasini3000",
      "author_association": "NONE",
      "body": "```\r\n$myNumberString = 'My Number: '\r\n$myArray = @(1,2,3,4,5,6,7)\r\n$foreachScriptBlock = {\r\n    Write-Host \"$($using:myNumberString) $_\"\r\n}\r\n$foreachSplat = @{}\r\n$foreachSplat.Add('Parallel',$foreachScriptBlock)\r\n$myArray | ForEach-Object @foreachSplat\r\n```\r\nfrom i tested\uff0cps 7.2 ps6.2 has this problem.\r\nbut ps 7.0,ps7.1,ps7.3 normal\r\n\r\n------\r\n\r\n```powershell\r\n#but this code normal for all ps7\r\n$myNumberString = 'My Number: '\r\n$myArray = @(1,2,3,4,5,6,7)\r\n\r\n$myArray | ForEach-Object -Parallel {\r\n\tWrite-Host \"$($using:myNumberString) $_\"\r\n}\r\n```\r\n\r\n",
      "created_at": "2022-08-05T04:41:51Z",
      "updated_at": "2022-08-05T04:44:43Z"
    }
  ],
  "created_at": "2022-08-04T14:46:21Z",
  "number": 17848,
  "state": "closed",
  "title": "ForEach-Object Parallel Splat with ScriptBlock unable to access $using variables in pwsh 7.2.5",
  "updated_at": "2022-08-05T04:44:43Z"
}