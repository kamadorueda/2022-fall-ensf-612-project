{
  "_url": "https://github.com/PowerShell/PowerShell/issues/2071",
  "author": "glennsarti",
  "body": "## Steps to reproduce\n1. Install Ruby 2.3.0\n2. Create a file in the root of the repository `test.rb` with the following content\n\n``` ruby\nrequire 'open3'\nrequire 'timeout'\n\ncmd = 'powershell.exe -NoProfile -NonInteractive -NoLogo -ExecutionPolicy Bypass -Command -'\nstr1 = <<-CODE\n\n\nWrite-Output \"1\"\nWrite-Output \"2\"\nWrite-Output \"3\"\n\n\nCODE\n# Helper\ndef drain_pipe(pipe, iterations = 10)\n  output = []\n  0.upto(iterations) do\n    break if !is_readable?(pipe, 0.1)\n    l = pipe.gets\n    puts \"#{Time.now} PIPE> #{l}\"\n    output << l\n  end\n  output\nend\ndef self.is_readable?(stream, timeout = 0.5)\n  read_ready = IO.select([stream], [], [], timeout)\n  read_ready && stream == read_ready[0][0]\nend\n\n\n## Let's go\nputs \"Starting PS...\"\n@stdin, @stdout, @stderr, @ps_process = Open3.popen3(cmd)\n\nputs \"Enter to send STDIN\"\nblah = gets\n\nputs \"Sending STDIN...\"\n@stdin.puts(str1)\nsleep(2)\noutput = drain_pipe(@stdout)\n\nputs \"output = #{output}\"\n\nputs \"Enter to cleanup\"\nblah = gets\n\n#  CLEANUP\nputs \"Cleaning up...\"\n@stdin.puts \"\\nexit\\n\"\n@stdin.close\n@stdout.close\n@stderr.close\n\nbegin\nTimeout.timeout(3) do\n  puts \"Awaiting PowerShell process termination...\"\n  @exit_status = @ps_process.value\nend\nrescue Timeout::Error\nend\n\nexit_msg = \"PowerShell process exited: #{@exit_status}\" if @exit_status\nputs(exit_msg)\nif @ps_process.alive?\n  puts(\"Forcefully terminating PowerShell process.\")\n  Process.kill('KILL', @ps_process[:pid])\nend\n```\n1. run \n\n```\nruby test.rb\n```\n1. Press enter when prompted\n## Expected behavior\n\n```\nStarting PS...\nEnter to send STDIN\n\nSending STDIN...\n2016-08-25 16:10:24 -0700 PIPE> 1\n2016-08-25 16:10:24 -0700 PIPE> 2\n2016-08-25 16:10:24 -0700 PIPE> 3\noutput = [\"1\\n\", \"2\\n\", \"3\\n\"]\nEnter to cleanup\n\nCleaning up...\nAwaiting PowerShell process termination...\nPowerShell process exited: pid 2788 exit 0\n```\n## Actual behavior\n\n```\nStarting PS...\nEnter to send STDIN\n\nSending STDIN...\noutput = []\nEnter to cleanup\n\nCleaning up...\nAwaiting PowerShell process termination...\n\nForcefully terminating PowerShell process.\n```\n## Environment data\n\nDoesn't work\n\n```\nWindows 10 Enterprise\n\n\nName                           Value\n----                           -----\nPSVersion                      5.1.14393.82\nPSEdition                      Desktop\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\nBuildVersion                   10.0.14393.82\nCLRVersion                     4.0.30319.42000\nWSManStackVersion              3.0\nPSRemotingProtocolVersion      2.3\nSerializationVersion           1.1.0.1\n```\n\nDoes Work\n\n```\nServer 2012 R2\n\nName                           Value\n----                           -----\nPSVersion                      5.0.10586.117\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\nBuildVersion                   10.0.10586.117\nCLRVersion                     4.0.30319.34209\nWSManStackVersion              3.0\nPSRemotingProtocolVersion      2.3\nSerializationVersion           1.1.0.1\n\n```\n## Workaround\n\nModify the initial powershell command from\n`cmd = 'powershell.exe -NoProfile -NonInteractive -NoLogo -ExecutionPolicy Bypass -Command -'`\n\nto\n\n`cmd = 'powershell.exe -Version 2.0 -NoProfile -NonInteractive -NoLogo -ExecutionPolicy Bypass -Command -'`\n\nThis works on the Windows 10 system (PS 5.1)\n",
  "closed_at": "2016-09-27T18:20:43Z",
  "comments": [
    {
      "author": "glennsarti",
      "author_association": "NONE",
      "body": "May be linked to https://github.com/PowerShell/PowerShell/issues/1794\n",
      "created_at": "2016-08-25T23:26:06Z",
      "updated_at": "2016-08-25T23:26:06Z"
    },
    {
      "author": "glennsarti",
      "author_association": "NONE",
      "body": "Further investigation.\n\nI installed IONinja and sniffed the named pipes being used between ruby and powershell\n\n## Working test\n\nIn this case I used the `-Version 2.0` flag to the initial powershell call\nThis is the logfile from IO Ninja\n\n```\n09:39:30 +01:51.987   File #9: Server file opened: \\ruby00000000000013f4-00000000\n09:39:30 +01:51.988   File #10: Client file opened: \\ruby00000000000013f4-00000000\n09:39:30 +01:52.003   File #9: \n09:39:30 +01:52.002 > 0000  41 63 74 69 76 65 20 63 6f 64 65 20 70 61 67 65  Active code page\n                    > 0010  3a 20 38 35 30 0d 0a                             : 850..\n09:39:30 +01:52.003   File #10: \n09:39:30 +01:52.002 < 0000  41 63 74 69 76 65 20 63 6f 64 65 20 70 61 67 65  Active code page\n                    < 0010  3a 20 38 35 30 0d 0a                             : 850..\n09:39:30 +01:52.005   File closed\n09:39:30 +01:52.005   File #9: File closed\n09:39:31 +01:52.649   File #11: Server file opened: \\ruby0000000000001d98-00000000\n09:39:31 +01:52.649   File #12: Client file opened: \\ruby0000000000001d98-00000000\n09:39:31 +01:52.649   File #13: Server file opened: \\ruby0000000000001d98-00000001\n09:39:31 +01:52.649   File #14: Client file opened: \\ruby0000000000001d98-00000001\n09:39:31 +01:52.649   File #15: Server file opened: \\ruby0000000000001d98-00000002\n09:39:31 +01:52.649   File #16: Client file opened: \\ruby0000000000001d98-00000002\n09:39:35 +01:56.681   File #11: \n09:39:35 +01:56.681 > 0000  0a 0a 57 72 69 74 65 2d 4f 75 74 70 75 74 20 22  ..Write-Output \"\n                    > 0010  31 22 0a 57 72 69 74 65 2d 4f 75 74 70 75 74 20  1\".Write-Output \n                    > 0020  22 32 22 0a 57 72 69 74 65 2d 4f 75 74 70 75 74  \"2\".Write-Output\n                    > 0030  20 22 33 22 0a 0a 0a                              \"3\"...\n09:39:35 +01:56.681   File #12: \n09:39:35 +01:56.681 < 0000  0a 0a 57 72 69 74 65 2d 4f 75 74 70 75 74 20 22  ..Write-Output \"\n                    < 0010  31 22 0a 57 72 69 74 65 2d 4f 75 74 70 75 74 20  1\".Write-Output \n                    < 0020  22 32 22 0a 57 72 69 74 65 2d 4f 75 74 70 75 74  \"2\".Write-Output\n                    < 0030  20 22 33 22 0a 0a 0a                              \"3\"...\n09:39:35 +01:56.723   File #14: \n09:39:35 +01:56.729 < 0000  31 0d 0a 32 0d 0a 33 0d 0a                       1..2..3..\n09:39:37 +01:58.681   File #13: \n09:39:37 +01:58.681 > 0000  31 0d 0a 32 0d 0a 33 0d 0a                       1..2..3..\n09:40:26 +02:47.551   File #11: \n09:40:26 +02:47.551 > 0000  0a 65 78 69 74 0a                                .exit.\n09:40:26 +02:47.551   File #12: \n09:40:26 +02:47.551 < 0000  0a 65 78 69 74 0a                                .exit.\n09:40:26 +02:47.551   File closed\n09:40:26 +02:47.551   File #13: File closed\n09:40:26 +02:47.551   File #15: File closed\n09:40:26 +02:47.562   File #11: File closed\n09:40:26 +02:47.562   File #14: File closed\n09:40:26 +02:47.562   File #16: File closed\n```\n\nNote that `File #12` is the outbound pipe from ruby into powershell STDIN and `File #11` is in the inbound pipe into Powershell STDIN from ruby.  See that the content from `File #12` equals the content to `File #11`.\n\nThey appear out of order in the log because the timestamps are the same\n\nYou can see the inverse behaviour in `File #14` and `File #13` which his STDOUT pipe from powershell to ruby.  These are it the correct oder as you can see by the timestamps\n\n## Failing Test\n\nThis time I used the powershell command without a version specifier i.e. PS 5.1\nLog file\n\n```\n09:37:18 -00:20.199   Session started\n09:37:18 -00:20.199   Capture started with filter *ruby0000000000002a58-00000001*\n09:37:37 -00:00.720   Capture stopped\n09:37:38 +00:00.000   Session started\n09:37:38 +00:00.000   Capture started with filter *ruby00000000*\n09:37:57 +00:19.019   File #1: Server file opened: \\ruby000000000000334c-00000000\n09:37:57 +00:19.019   File #2: Client file opened: \\ruby000000000000334c-00000000\n09:37:57 +00:19.032   File #1: \n09:37:57 +00:19.032 > 0000  41 63 74 69 76 65 20 63 6f 64 65 20 70 61 67 65  Active code page\n                    > 0010  3a 20 38 35 30 0d 0a                             : 850..\n09:37:57 +00:19.032   File #2: \n09:37:57 +00:19.032 < 0000  41 63 74 69 76 65 20 63 6f 64 65 20 70 61 67 65  Active code page\n                    < 0010  3a 20 38 35 30 0d 0a                             : 850..\n09:37:57 +00:19.034   File closed\n09:37:57 +00:19.035   File #1: File closed\n09:37:58 +00:19.582   File #3: Server file opened: \\ruby0000000000001f9c-00000000\n09:37:58 +00:19.582   File #4: Client file opened: \\ruby0000000000001f9c-00000000\n09:37:58 +00:19.582   File #5: Server file opened: \\ruby0000000000001f9c-00000001\n09:37:58 +00:19.582   File #6: Client file opened: \\ruby0000000000001f9c-00000001\n09:37:58 +00:19.582   File #7: Server file opened: \\ruby0000000000001f9c-00000002\n09:37:58 +00:19.582   File #8: Client file opened: \\ruby0000000000001f9c-00000002\n09:38:09 +00:31.379   File #4: \n09:38:09 +00:31.379 < 0000  0a 0a 57 72 69 74 65 2d 4f 75 74 70 75 74 20 22  ..Write-Output \"\n                    < 0010  31 22 0a 57 72 69 74 65 2d 4f 75 74 70 75 74 20  1\".Write-Output \n                    < 0020  22 32 22 0a 57 72 69 74 65 2d 4f 75 74 70 75 74  \"2\".Write-Output\n09:38:28 +00:50.172 < 0030  20 22 33 22 0a 0a 0a 0a 65 78 69 74 0a            \"3\"....exit.\n09:38:28 +00:50.172   File closed\n09:38:28 +00:50.172   File #5: File closed\n09:38:28 +00:50.172   File #7: File closed\n09:38:31 +00:53.176   File #3: File closed\n09:38:31 +00:53.176   File #6: File closed\n09:38:31 +00:53.176   File #8: File closed\n```\n\nNote that `File #4` is the outbound pipe from ruby into powershell STDIN and `File #3` is in the inbound pipe into Powershell STDIN from ruby.\n\nSee that the data is put into the pipe but it never gets read out at the powershell pipe end.  This suggests there's something up with the pipe handling.\n",
      "created_at": "2016-08-26T16:58:11Z",
      "updated_at": "2016-08-26T16:58:11Z"
    },
    {
      "author": "lzybkr",
      "author_association": "MEMBER",
      "body": "I updated the repro making it slightly simpler (cloning puppetlabs-powershell wasn't necessary, just needed to add `require 'timeout'` to the script and it runs just fine with just `ruby` installed.\n\nWhen I run the modified repro, it does hang when running the in-box `powershell.exe`, but exits correctly with my fix to #2090.\n\nThat said, the output is still missing. I verified that PowerShell is receiving the command and executing them, but the ruby script stopped reading from `stdout` before the commands ran. I increased the timeout and verified the output was received.\n\nSo I think this issue is the same as #2090, but it would be great if you can confirm.\n",
      "created_at": "2016-08-31T01:24:04Z",
      "updated_at": "2016-08-31T01:24:04Z"
    }
  ],
  "created_at": "2016-08-25T23:23:48Z",
  "labels": [
    "Issue-Bug",
    "WG-Engine"
  ],
  "number": 2071,
  "state": "closed",
  "title": "(PS 5.1.14393) Passing commands via STDIN in Ruby does not seem to work",
  "updated_at": "2016-09-27T18:20:44Z"
}