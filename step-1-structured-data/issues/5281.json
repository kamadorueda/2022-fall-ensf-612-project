{
  "_url": "https://github.com/PowerShell/PowerShell/issues/5281",
  "author": "daxian-dbw",
  "body": "If you create a powershell instance and change its language mode to \u201cConstrainedLanguage\u201d, and then try a type conversion that is disallowed, then in the default powershell session where the language mode is \u201cFullLanguage\u201d, the same conversion will also fail.\r\n\r\nThe root cause is that powershell uses a global static type conversion delegate cache. The first type conversion attempt is banned as expected, but the delegate that throws \u201conly core type is allowed\u201d exception would be put in the cache. When we try the conversion again in the default session, the same delegate gets returned from the cache and thus throw the same exception even though it\u2019s currently in full language mode.\r\n\r\nThis doesn't seem like a real customer scenario, but it would cause issues to our test run because after testing some ConstrainedLanguage features with a powershell instance, some conversions will stop working in the default session.\r\n\r\nA workaround in test is to do a redundant `$ExecutionContext.SessionState.LanguageMode = \"FullLanguage\"` after my constrained language tests run to force resetting the cache.\r\n\r\nSteps to reproduce\r\n------------------\r\n\r\n```powershell\r\n$ps = [powershell]::Create()\r\n$ps.AddScript('$ExecutionContext.SessionState.LanguageMode = \"ConstrainedLanguage\"').Invoke()\r\n$ps.Commands.Clear()\r\n$ps.AddScript(\"[System.IO.FileInfo] 'foo'\").Invoke()\r\n \r\n[System.IO.FileInfo] 'foo'\r\n```\r\n\r\nExpected behavior\r\n-----------------\r\n\r\n```none\r\nPS> [System.IO.FileInfo] 'foo'\r\n\r\nMode                LastWriteTime         Length Name\r\n----                -------------         ------ ----\r\ndarhsl       12/31/1600   4:00 PM             () foo\r\n```\r\n\r\nActual behavior\r\n---------------\r\n\r\n```none\r\nPS> [System.IO.FileInfo] 'foo'\r\nCannot convert value to type \"System.IO.FileInfo\". Only core types are supported in this language mode.\r\nAt line:1 char:1\r\n+ [System.IO.FileInfo] 'foo'\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : InvalidArgument: (:) [], RuntimeException\r\n+ FullyQualifiedErrorId : ConversionSupportedOnlyToCoreTypes\r\n```\r\n\r\nEnvironment data\r\n----------------\r\n\r\n<!-- provide the output of $PSVersionTable -->\r\n\r\n```powershell\r\n> $PSVersionTable\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.0.0-beta.9\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.0-beta.9-22-g1c446c1be4ac10dd53a1f822e78801dc3da361d0\r\nOS                             Microsoft Windows 10.0.15063\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n",
  "closed_at": null,
  "comments": [],
  "created_at": "2017-10-31T16:31:34Z",
  "number": 5281,
  "state": "open",
  "title": "Conversion delegate cache cause conversion failures in the default session after using 'restricted language' in another runspace",
  "updated_at": "2017-10-31T16:33:41Z"
}