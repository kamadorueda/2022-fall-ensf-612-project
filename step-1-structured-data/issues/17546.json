{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17546",
  "author": "fflaten",
  "body": "### Prerequisites\r\n\r\n- [X] Write a descriptive title.\r\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- [X] Search the existing issues.\r\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n\r\n### Steps to reproduce\r\n\r\n```powershell\r\nfunction Test-EnumValidation {\r\n    param(\r\n        [ValidateSet([Microsoft.PowerShell.ExecutionPolicy]::Unrestricted, [Microsoft.PowerShell.ExecutionPolicy]::Undefined)]\r\n        [Microsoft.PowerShell.ExecutionPolicy]$Works,\r\n\r\n        [ValidateRange([Microsoft.PowerShell.ExecutionPolicy]::Unrestricted, [Microsoft.PowerShell.ExecutionPolicy]::Undefined)]\r\n        [Microsoft.PowerShell.ExecutionPolicy]$Fails\r\n    )\r\n}\r\n\r\n\r\n$m = New-Object System.Management.Automation.CommandMetaData (Get-Command Test-EnumValidation)\r\n$s = [System.Management.Automation.ProxyCommand]::Create($m)\r\n\r\n$function:proxy = [scriptblock]::Create($s)\r\n\r\n# fails with .ctor exception\r\nproxy\r\n\r\n# if we check the generated function, we see that `ValidateRange` got unquoted strings as arguments in the proxycommand\r\n$s\r\n\r\n...\r\nparam(\r\n    [ValidateSet('Unrestricted','Undefined')]\r\n    [Microsoft.PowerShell.ExecutionPolicy]\r\n    ${Works},\r\n\r\n    [ValidateRange(Unrestricted,Undefined)]\r\n    [Microsoft.PowerShell.ExecutionPolicy]\r\n    ${Fails})\r\n....\r\n```\r\n\r\n### Expected behavior\r\n\r\n`proxy` should work without errors\r\n\r\n\r\n### Actual behavior\r\n\r\n`proxy` throws MethodException due to missing overload.\r\n\r\n\r\n### Error details\r\n\r\n```powershell\r\nException             :\r\n    Type        : System.Management.Automation.MethodException\r\n    ErrorRecord :\r\n        Exception             :\r\n            Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n            Message : Cannot find an overload for \".ctor\" and the argument count: \"0\".\r\n            HResult : -2146233087\r\n        CategoryInfo          : NotSpecified: (:) [], ParentContainsErrorRecordException\r\n        FullyQualifiedErrorId : MethodCountCouldNotFindBest\r\n        InvocationInfo        :\r\n            ScriptLineNumber : 7\r\n            OffsetInLine     : 5\r\n            HistoryId        : -1\r\n            Line             : [ValidateRange(Unrestricted, Undefined)]\r\n\r\n            PositionMessage  : At line:7 char:5\r\n                               +     [ValidateRange(Unrestricted, Undefined)]\r\n                               +     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n            CommandOrigin    : Internal\r\n        ScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n    TargetSite  :\r\n        Name          : GetAttribute\r\n        DeclaringType : System.Management.Automation.Language.Compiler, System.Management.Automation, Version=7.2.4.500, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n        MemberType    : Method\r\n        Module        : System.Management.Automation.dll\r\n    Message     : Cannot find an overload for \".ctor\" and the argument count: \"0\".\r\n    Data        : System.Collections.ListDictionaryInternal\r\n    Source      : System.Management.Automation\r\n    HResult     : -2146233087\r\n    StackTrace  :\r\n   at System.Management.Automation.Language.Compiler.GetAttribute(AttributeAst attributeAst)\r\n   at System.Management.Automation.Language.AttributeAst.GetAttribute()\r\n   at System.Management.Automation.Language.Compiler.GetRuntimeDefinedParameter(ParameterAst parameterAst, Boolean& customParameterSet, Boolean& usesCmdletBinding)\r\n   at System.Management.Automation.Language.Compiler.GetParameterMetaData(ReadOnlyCollection`1 parameters, Boolean automaticPositions, Boolean& usesCmdletBinding)\r\n   at System.Management.Automation.Language.ScriptBlockAst.System.Management.Automation.Language.IParameterMetadataProvider.GetParameterMetadata(Boolean automaticPositions, Boolean& usesCmdletBinding)\r\n   at System.Management.Automation.CompiledScriptBlockData.InitializeMetadata()\r\n   at System.Management.Automation.CompiledScriptBlockData.get_ObsoleteAttribute()\r\n   at System.Management.Automation.DlrScriptCommandProcessor.Init()\r\n   at System.Management.Automation.CommandDiscovery.CreateCommandProcessorForScript(FunctionInfo functionInfo, ExecutionContext context, Boolean useNewScope, SessionStateInternal sessionState)\r\n   at System.Management.Automation.CommandDiscovery.LookupCommandProcessor(CommandInfo commandInfo, CommandOrigin commandOrigin, Nullable`1 useLocalScope, SessionStateInternal sessionState)\r\n   at System.Management.Automation.ExecutionContext.CreateCommand(String command, Boolean dotSource)\r\n   at System.Management.Automation.PipelineOps.AddCommand(PipelineProcessor pipe, CommandParameterInternal[] commandElements, CommandBaseAst commandBaseAst, CommandRedirection[] redirections, ExecutionCont\r\next context)\r\n   at System.Management.Automation.PipelineOps.InvokePipeline(Object input, Boolean ignoreInput, CommandParameterInternal[][] pipeElements, CommandBaseAst[] pipeElementAsts, CommandRedirection[][] commandR\r\nedirections, FunctionContext funcContext)\r\n   at System.Management.Automation.Interpreter.ActionCallInstruction`6.Run(InterpretedFrame frame)\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\r\nCategoryInfo          : NotSpecified: (:) [], MethodException\r\nFullyQualifiedErrorId : MethodCountCouldNotFindBest\r\nInvocationInfo        :\r\n    ScriptLineNumber : 7\r\n    OffsetInLine     : 5\r\n    HistoryId        : -1\r\n    Line             : [ValidateRange(Unrestricted, Undefined)]\r\n\r\n    PositionMessage  : At line:7 char:5\r\n                       +     [ValidateRange(Unrestricted, Undefined)]\r\n                       +     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n```\r\n\r\n\r\n### Environment data\r\n\r\n```powershell\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.4\r\nPSEdition                      Core\r\nGitCommitId                    7.2.4\r\nOS                             Microsoft Windows 10.0.22000\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\n\r\n### Visuals\r\n\r\n_No response_",
  "closed_at": "2022-07-20T03:50:18Z",
  "comments": [
    {
      "author": "fflaten",
      "author_association": "CONTRIBUTOR",
      "body": "Looks like it's missing another condition here. If `rangeType` is enum, prefix MinRange/MaxRange-values with `$\"[{rangeType.FullName}]::\"`\r\nhttps://github.com/PowerShell/PowerShell/blob/7dc4587014bfa22919c933607bf564f0ba53db2e/src/System.Management.Automation/engine/TypeMetadata.cs#L930-L945\r\n\r\n\r\n```powershell\r\n$m = New-Object System.Management.Automation.CommandMetaData (Get-Command Start-BitsTransfer)\r\n$m.Parameters['Fails'].Attributes[1] \r\n\r\n    MinRange  MaxRange TypeId\r\n    --------  -------- ------\r\nUnrestricted Undefined System.Management.Automation.ValidateRangeAttribute\r\n\r\n$m.Parameters['Fails'].Attributes[1].MaxRange.GetType()\r\n\r\nIsPublic IsSerial Name                                     BaseType\r\n-------- -------- ----                                     --------\r\nTrue     True     ExecutionPolicy                          System.Enum\r\n```\r\n",
      "created_at": "2022-06-21T16:58:39Z",
      "updated_at": "2022-06-21T19:22:39Z"
    },
    {
      "author": "fflaten",
      "author_association": "CONTRIBUTOR",
      "body": "Using ValidateRange with enum should be discouraged in it's current state due to poor usability.\r\n\r\n```powershell\r\n# This parameter\r\n[ValidateRange([Microsoft.PowerShell.ExecutionPolicy]::Unrestricted, [Microsoft.PowerShell.ExecutionPolicy]::AllSigned)]\r\n[Microsoft.PowerShell.ExecutionPolicy]$UntypedBroken\r\n\r\n# Will fail like this\r\n> test -UntypedBroken Bypass    \r\ntest: Cannot validate argument on parameter 'UntypedBroken'. The Bypass argument is greater than the maximum allowed range of AllSigned. Supply an argument that is less than or equal to AllSigned and then try the command again.\r\n```\r\n\r\nUnfortunately the tabcomplete is alphabetically sorted, so they'd have to get all enum-values to figure out the allowed range\r\n```powershell\r\n> test -UntypedBroken       \r\nAllSigned     Bypass        Default       RemoteSigned  Restricted    Undefined     Unrestricted\r\n\r\n> [enum]::GetValues([Microsoft.PowerShell.ExecutionPolicy])\r\nUnrestricted\r\nRemoteSigned\r\nAllSigned\r\nRestricted\r\nRestricted\r\nBypass\r\nUndefined\r\n```\r\n\r\nValidateSet at least shows the alliere values in the error.\n\r\n```\r\ntest: Cannot validate argument on parameter 'UntypedBroken'. The argument \"Bypass\" does not belong to the set \"Unrestricted,AllSigned\" specified by the ValidateSet attribute. Supply an argument that is in the set and then try the command again.\r\n```\r\n\r\nMaybe the error message should be fixed in a separate issue and PR to be more clear when using enum ranges? And/Or fix tabcompletion to only show values in range",
      "created_at": "2022-06-24T22:26:06Z",
      "updated_at": "2022-07-23T17:11:46Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:This issue was addressed in #17572, which has now been successfully released as `v7.3.0-preview.7`.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.3.0-preview.7)\n",
      "created_at": "2022-08-12T00:00:14Z",
      "updated_at": "2022-08-12T00:00:14Z"
    }
  ],
  "created_at": "2022-06-20T22:23:52Z",
  "labels": [
    "Resolution-Fixed"
  ],
  "number": 17546,
  "state": "closed",
  "title": "ProxyCommand breaks ValidateRange for enum-parameters",
  "updated_at": "2022-08-12T00:00:14Z"
}