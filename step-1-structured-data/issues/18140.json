{
  "_url": "https://github.com/PowerShell/PowerShell/issues/18140",
  "author": "SteveL-MSFT",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nAdd PS7 subsystem to sshd_config:\r\n\r\n```\r\nSubsystem\tpowershell\t/usr/local/microsoft/powershell/7-preview/pwsh -sshs -nologo -noprofile -configurationfile /Users/steve/test/demo.pssc\r\n```\r\n\r\nPoing to a pssc file:\r\n\r\n```powershell\r\n@{\r\n\r\n# Version number of the schema used for this document\r\nSchemaVersion = '2.0.0.0'\r\n\r\n# ID used to uniquely identify this document\r\nGUID = '86335646-db0a-455d-8332-01668112ba77'\r\n\r\n# Author of this document\r\nAuthor = 'slee'\r\n\r\n# Description of the functionality provided by these settings\r\n# Description = ''\r\n\r\n# Session type defaults to apply for this session configuration. Can be 'RestrictedRemoteServer' (recommended), 'Empty', or 'Default'\r\nSessionType = 'Default'\r\n\r\n# Directory to place session transcripts for this session configuration\r\n# TranscriptDirectory = 'C:\\Transcripts\\'\r\n\r\n# Whether to run this session configuration as the machine's (virtual) administrator account\r\n# RunAsVirtualAccount = $true\r\n\r\n# Scripts to run when applied to a session\r\nScriptsToProcess = '/Users/steve/test/pssc.ps1'\r\n\r\nModulesToImport = @()\r\n\r\n# User roles (security groups), and the role capabilities that should be applied to them when applied to a session\r\n# RoleDefinitions = @{ 'CONTOSO\\SqlAdmins' = @{ RoleCapabilities = 'SqlAdministration' }; 'CONTOSO\\SqlManaged' = @{ RoleCapabilityFiles = 'C:\\RoleCapability\\SqlManaged.psrc' }; 'CONTOSO\\ServerMonitors' = @{ VisibleCmdlets = 'Get-Process' } } \r\n\r\n# Language mode to apply when applied to a session. Can be 'NoLanguage' (recommended), 'RestrictedLanguage', 'ConstrainedLanguage', or 'FullLanguage'\r\nLanguageMode = 'RestrictedLanguage'\r\n\r\n# Cmdlets to make visible when applied to a session\r\nVisibleCmdlets = 'Get-Command', 'out-default', 'get-process'\r\n\r\n# Functions to make visible when applied to a session\r\nVisibleFunctions = 'Exit-Session'\r\n\r\n}\r\n```\r\n\r\nthe `pssc.ps1` simply contains:\r\n\r\n```powershell\r\nfunction Exit-Session {\r\n    exit\r\n}\r\n```\r\n\n\n### Expected behavior\n\n```console\nSuccessfully create session\n```\n\n\n### Actual behavior\n\n```console\nNew-PSSession: [localhost] The background process reported an error with the following message: Remote transport error: Running startup script threw an error: The specified module '/usr/local/microsoft/powershell/7-preview/Modules/Microsoft.WSMan.Management' was not loaded because no valid module file was found in any module directory...\n```\n\n\n### Error details\n\n```console\nException             :\r\n    Type        : System.Management.Automation.Remoting.PSRemotingTransportException\r\n    ErrorCode   : 2100\r\n    ErrorRecord :\r\n        Exception             :\r\n            Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n            Message : The background process reported an error with the following message: Remote transport error: Running startup script threw an error: The\r\nspecified module '/usr/local/microsoft/powershell/7-preview/Modules/Microsoft.WSMan.Management' was not loaded because no valid module file was found in any module\r\ndirectory...\r\n            HResult : -2146233087\r\n        CategoryInfo          : ResourceUnavailable: (:) [], ParentContainsErrorRecordException\r\n        FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException\r\n    Message     : The background process reported an error with the following message: Remote transport error: Running startup script threw an error: The specified\r\nmodule '/usr/local/microsoft/powershell/7-preview/Modules/Microsoft.WSMan.Management' was not loaded because no valid module file was found in any module directory...\r\n    HResult     : -2146233087\r\nTargetObject          : System.Management.Automation.RemoteRunspace\r\nCategoryInfo          : OpenError: (System.Management.A\u2026tion.RemoteRunspace:RemoteRunspace) [New-PSSession], PSRemotingTransportException\r\nFullyQualifiedErrorId : 2100,PSSessionOpenFailed\r\nErrorDetails          : [localhost] The background process reported an error with the following message: Remote transport error: Running startup script threw an\r\nerror: The specified module '/usr/local/microsoft/powershell/7-preview/Modules/Microsoft.WSMan.Management' was not loaded because no valid module file was found in\r\nany module directory...\r\nInvocationInfo        :\r\n    MyCommand        : New-PSSession\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 1\r\n    HistoryId        : 25\r\n    Line             : new-pssession -HostName . -UserName steve\r\n    PositionMessage  : At line:1 char:1\r\n                       + new-pssession -HostName . -UserName steve\r\n                       + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    InvocationName   : new-pssession\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\nPipelineIterationInfo :\n```\n\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.3.0-preview.8\r\nPSEdition                      Core\r\nGitCommitId                    7.3.0-preview.8\r\nOS                             Darwin 21.6.0 Darwin Kernel Version 21.6.0: Wed Aug 10 14:28:35 PDT 2022; root:xnu-8020.141.5~2/RELEASE_ARM64_T8101\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": null,
  "comments": [
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "This only occurs when `SessionType` is `Default`, setting it to `RestrictedRemoteServer` seems to work",
      "created_at": "2022-09-21T00:57:09Z",
      "updated_at": "2022-09-21T00:57:09Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "It seems that remote initial session state [explicitly imports engine modules where two are not on Unix systems](https://github.com/PowerShell/PowerShell/blob/6744ffb8261c27a2fe3d523df7a216cbab018ce4/src/System.Management.Automation/engine/InitialSessionState.cs#L4772-L4780).\r\n\r\nHowever, after removing those for Unix, it also looks like remote server mode [depends on `Select-Object` and `Measure-Object`](https://github.com/PowerShell/PowerShell/blob/7c624902e1dbb165b1fa0700df498a22c567b9f8/src/System.Management.Automation/engine/remoting/server/ServerRunspacePoolDriver.cs#L981-L1042) to handle command metadata so those cmdlets have to be available.",
      "created_at": "2022-09-21T03:47:19Z",
      "updated_at": "2022-09-21T03:47:19Z"
    }
  ],
  "created_at": "2022-09-21T00:17:58Z",
  "labels": [
    "WG-Remoting",
    "Needs-Triage"
  ],
  "number": 18140,
  "state": "open",
  "title": "Using a session configuration file with ssh remoting on mac fails",
  "updated_at": "2022-09-21T03:47:19Z"
}