{
  "_url": "https://github.com/PowerShell/PowerShell/issues/4029",
  "author": "tthoma24",
  "body": "<!--\r\n\r\nIf it is a bug report:\r\n- make sure you are able to repro it on the latest released version. \r\nYou can install the latest version from https://github.com/PowerShell/PowerShell/releases\r\n- Search the existing issues.\r\n- Refer to the [FAQ](../docs/FAQ.md).\r\n- Refer to the [known issues](../docs/KNOWNISSUES.md).\r\n- Fill out the following repro template\r\n\r\nIf it's not a bug, please remove the template and elaborate the issue in your own words.\r\n-->\r\n\r\nI believe this is related to #942, which is closed. Someone claimed this works from Ubuntu. Is this not supported on macOS, or is this a bug?\r\n\r\nSteps to reproduce\r\n------------------\r\n\r\n```\r\n$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://ps.compliance.protection.outlook.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection\r\n```\r\n\r\nExpected behavior\r\n-----------------\r\nSession would be initiated\r\n\r\nActual behavior\r\n---------------\r\n\r\n```\r\nUnhandled Exception: System.NullReferenceException: Object reference not set to an instance of an object.\r\n   at System.Management.Automation.Remoting.PrioritySendDataCollection.Clear()\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.CloseAsync()\r\n   at System.Management.Automation.Remoting.Client.WSManClientSessionTransportManager.CloseAsync()\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.Finalize()\r\nAbort trap: 6\r\n```\r\n\r\nEnvironment data\r\n----------------\r\n\r\n<!-- provide the output of $PSVersionTable -->\r\n\r\n```powershell\r\n> $PSVersionTable\r\n\r\nName                           Value                                                           \r\n----                           -----                                                           \r\nPSVersion                      6.0.0-beta                                                      \r\nPSEdition                      Core                                                            \r\nBuildVersion                   3.0.0.0                                                         \r\nCLRVersion                                                                                     \r\nGitCommitId                    v6.0.0-beta.2                                                   \r\nOS                             Darwin 17.0.0 Darwin Kernel Version 17.0.0: Mon May 29 20:35:...\r\nPlatform                       Unix                                                            \r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}                                         \r\nPSRemotingProtocolVersion      2.3                                                             \r\nSerializationVersion           1.1.0.1                                                         \r\nWSManStackVersion              3.0  \r\n```\r\n",
  "closed_at": "2018-01-05T01:13:45Z",
  "comments": [
    {
      "author": "tthoma24",
      "author_association": "NONE",
      "body": "#3476 may also be related, same issue on CentOS, and another reporter on macOS.",
      "created_at": "2017-06-17T05:21:37Z",
      "updated_at": "2017-06-17T05:21:37Z"
    },
    {
      "author": "tthoma24",
      "author_association": "NONE",
      "body": "I'm not sure what's meant when asked for a \"simpler repro,\" but I was able to reproduce my issue again in a VM running 10.12.6 and the beta 4 release of PowerShell.",
      "created_at": "2017-08-01T02:24:31Z",
      "updated_at": "2017-08-01T02:24:31Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "I've got this issue on macOS 10.12.6 and 10.13 with 6.0.0-rc\r\n\r\nThis is installing PowerShell via the macOS Installer Package. Apparently you can install it via Homebrew as well however the way that Homebrew opens up the permissions on some of the system binary directories (like /usr/local/bin) to make it group read/write is a security risk so I can't use it to test.\r\n\r\n```\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/kai> $PSVersionTable                                                  \r\n\r\nName                           Value                                           \r\n----                           -----                                           \r\nPSVersion                      6.0.0-rc                                        \r\nPSEdition                      Core                                            \r\nGitCommitId                    v6.0.0-rc                                       \r\nOS                             Darwin 16.7.0 Darwin Kernel Version 16.7.0: T...\r\nPlatform                       Unix                                            \r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}                         \r\nPSRemotingProtocolVersion      2.3                                             \r\nSerializationVersion           1.1.0.1                                         \r\nWSManStackVersion              3.0                                             \r\n\r\n\r\nPS /Users/kai> $UserCredential = Get-Credential                                 \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: admin@example.onmicrosoft.com\r\nPassword for user admin@example.onmicrosoft.com: ********\r\n\r\nPS /Users/kai> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid -Credential $UserCredential -Authentication Basic -AllowRedirection                                                                                          \r\n\r\nAn error has occurred that was not properly handled. Additional information is shown below. The PowerShell process will exit.\r\n\r\nUnhandled Exception: System.NullReferenceException: Object reference not set to an instance of an object.\r\n   at System.Management.Automation.Remoting.PrioritySendDataCollection.Clear()\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.CloseAsync()\r\n   at System.Management.Automation.Remoting.Client.WSManClientSessionTransportManager.CloseAsync()\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.Finalize()\r\nAbort trap: 6\r\n```",
      "created_at": "2017-11-22T23:34:31Z",
      "updated_at": "2017-11-22T23:35:32Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@SteveL-MSFT Related Issue #3476 was labeled as GA. Should we fix current Issue before GA too?",
      "created_at": "2017-11-23T03:50:00Z",
      "updated_at": "2017-11-23T03:50:00Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@dantraMSFT can you confirm with latest psl-omi-provider this works on macOS?",
      "created_at": "2017-11-23T21:21:28Z",
      "updated_at": "2017-11-23T21:21:28Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h Are you able to consistently repro the NullReferenceException?  I'm not able to repro it.",
      "created_at": "2017-11-28T19:04:35Z",
      "updated_at": "2017-11-28T19:04:35Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "I can consistently reproduce this on two separate Macs. One with macOS 10.12 and one with 10.13.\r\nIt happens every single time - as in I have never been able to establish a New-PSSession on either of the two Macs I use.\r\nI don't have a Linux workstation to test with the latest **psl-omi-provider** - I only have Ubuntu on Windows 10 available without creating a new VM for testing purposes.",
      "created_at": "2017-11-28T21:12:09Z",
      "updated_at": "2017-11-28T21:12:09Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "My environment is a pretty standard macOS installation with 10.12 or 10.13 and PowerShell 6.0.0-rc installed via the macOS Installer Package (.pkg) from the GitHub Releases page.\r\nI haven't built it from source or installed via Homebrew.\r\nSearching for more info on this error, in one thread (that I now can't find) someone reported that it was failing for them when they installed from the .pkg but when they installed from Homebrew it worked.",
      "created_at": "2017-11-28T21:20:53Z",
      "updated_at": "2017-11-28T21:20:53Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks, @kai-h, let me checkout out the pkg page. ",
      "created_at": "2017-11-28T22:11:24Z",
      "updated_at": "2017-11-28T22:11:24Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h, unfortunately, I'm still not able to repro it.  Would you change the file size and date stamps of libmi.dylib and libpsrpclient.dylib? \r\ncd $pshome\r\nls -l lib*\r\n",
      "created_at": "2017-11-28T23:37:01Z",
      "updated_at": "2017-11-28T23:37:01Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "```powershell\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/kai> cd $pshome                                                       \r\nPS /usr/local/microsoft/powershell/6.0.0-rc> ls -l lib*                         \r\n-rw-r--r--  1 root  wheel  2571480 31 Oct 17:27 libclrjit.dylib\r\n-rw-r--r--  1 root  wheel  6894904 31 Oct 17:27 libcoreclr.dylib\r\n-rw-r--r--  1 root  wheel   883740 31 Oct 17:27 libdbgshim.dylib\r\n-rw-r--r--  1 root  wheel   869664 31 Oct 17:27 libhostfxr.dylib\r\n-rw-r--r--  1 root  wheel  1006336 31 Oct 17:27 libhostpolicy.dylib\r\n-rw-r--r--  1 root  wheel   843792 14 Nov 11:37 libmi.dylib\r\n-rw-r--r--  1 root  wheel  3081760 31 Oct 17:27 libmscordaccore.dylib\r\n-rw-r--r--  1 root  wheel  2021168 31 Oct 17:27 libmscordbi.dylib\r\n-rw-r--r--  1 root  wheel    20568  4 Nov 09:08 libpsl-native.dylib\r\n-rw-r--r--  1 root  wheel   224784 15 Nov 07:39 libpsrpclient.dylib\r\n-rw-r--r--  1 root  wheel   553360 31 Oct 17:27 libsos.dylib\r\nPS /usr/local/microsoft/powershell/6.0.0-rc> \r\n```",
      "created_at": "2017-11-28T23:38:45Z",
      "updated_at": "2017-11-28T23:38:45Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h, Would you be willing to build a debug version and replace system.management.automation or let me send you one?  The NullReferenceException implies some other problem but I can't tell from the call stack where the exception is being thrown.",
      "created_at": "2017-11-28T23:42:19Z",
      "updated_at": "2017-11-28T23:42:43Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Sure thing, happy to help. I don't know how to build it (but I can probably work it out) or if you have a debug version you can send me, I'll install and run it.",
      "created_at": "2017-11-28T23:48:51Z",
      "updated_at": "2017-11-28T23:48:51Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "I'll get you a build tomorrow morning.  I want to see if there is any additional instrumentation that should be there.",
      "created_at": "2017-11-28T23:50:44Z",
      "updated_at": "2017-11-28T23:50:44Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Great, thanks. I really appreciate the attention that MSFT are giving to powershell on alternative platforms.",
      "created_at": "2017-11-28T23:51:36Z",
      "updated_at": "2017-11-28T23:51:36Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h What's the best way to get this binary to you?",
      "created_at": "2017-11-29T21:10:23Z",
      "updated_at": "2017-11-29T21:10:23Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "You can Dropbox or OneDrive it to me, or email it to kai at automatica dot com dot au\r\nThanks.\r\nI've just commented in #5561 that I have been able to reproduce the issue with a clean install of macOS 10.12.6 and a clean install of PowerShell 6.0.0-rc and nothing else on the system. ",
      "created_at": "2017-11-29T21:24:19Z",
      "updated_at": "2017-11-29T21:24:19Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h: Try these.  Place the PDB file in the same directory and repro the issue.  The only purpose of this is to get the exact line number in the call to Clear().\r\n\r\nhttps://www.dropbox.com/sh/rq8ct7xlnchs3hx/AAATnwMeMD4SD_Vwm4W1srboa?dl=0\r\n\r\n",
      "created_at": "2017-11-29T21:33:55Z",
      "updated_at": "2017-11-29T21:33:55Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Thank you for this. On my main Mac, I'm getting inconsistent results. The results below are on my main Mac. I will also run the debug build on the other Mac I set up this morning for testing.\r\nThe command I'm using to trigger it is:\r\n```powershell\r\n$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid -Credential $UserCredential -Authentication Basic -AllowRedirection\r\n```\r\nThe first time it runs, I get an error. The second time it runs I get an unhandled exception:\r\n```powershell\r\n[kai@blackmac ~]$ pwsh\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/kai> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid -Credential $UserCredential -Authentication Basic -AllowRedirection                                                                                              \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: user@example.com\r\nPassword for user user@example.com: ********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/kai> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid -Credential $UserCredential -Authentication Basic -AllowRedirection                                                                                              \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: admin@example.com\r\nPassword for user admin@example.com: ********\r\n\r\n\r\nAn error has occurred that was not properly handled. Additional information is shown below. The PowerShell process will exit.\r\n\r\nUnhandled Exception: System.NullReferenceException: Object reference not set to an instance of an object.\r\n   at System.Management.Automation.Remoting.PrioritySendDataCollection.Clear() in /PowerShell/src/System.Management.Automation/engine/remoting/fanin/PriorityCollection.cs:line 158\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.CloseAsync() in /PowerShell/src/System.Management.Automation/engine/remoting/fanin/BaseTransportManager.cs:line 949\r\n   at System.Management.Automation.Remoting.Client.WSManClientSessionTransportManager.CloseAsync() in /PowerShell/src/System.Management.Automation/engine/remoting/fanin/WSManTransportManager.cs:line 1219\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.Finalize() in /PowerShell/src/System.Management.Automation/engine/remoting/fanin/BaseTransportManager.cs:line 998\r\nAbort trap: 6\r\n```",
      "created_at": "2017-11-29T21:43:52Z",
      "updated_at": "2017-11-29T21:43:52Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Here are the results from the Mac with a clean install of macOS 10.12.6 and PowerShell 6.0.0-rc\r\n```powershell\r\nLast login: Thu Nov 30 08:48:11 on ttys000\r\nAdministrators-Mac-mini:~ admin$ pwsh\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/admin> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection                                                               \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: admin@example.com\r\nPassword for user admin@example.com: ********\r\n\r\n\r\nAn error has occurred that was not properly handled. Additional information is shown below. The PowerShell process will exit.\r\n\r\nUnhandled Exception: System.NullReferenceException: Object reference not set to an instance of an object.\r\n   at System.Management.Automation.Remoting.PrioritySendDataCollection.Clear() in /PowerShell/src/System.Management.Automation/engine/remoting/fanin/PriorityCollection.cs:line 158\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.CloseAsync() in /PowerShell/src/System.Management.Automation/engine/remoting/fanin/BaseTransportManager.cs:line 949\r\n   at System.Management.Automation.Remoting.Client.WSManClientSessionTransportManager.CloseAsync() in /PowerShell/src/System.Management.Automation/engine/remoting/fanin/WSManTransportManager.cs:line 1219\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.Finalize() in /PowerShell/src/System.Management.Automation/engine/remoting/fanin/BaseTransportManager.cs:line 998\r\nAbort trap: 6\r\nAdministrators-Mac-mini:~ admin$ \r\n```",
      "created_at": "2017-11-29T21:51:04Z",
      "updated_at": "2017-11-29T21:51:04Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h: Thanks, I'll send you another binary that handles this case and see where it takes us.",
      "created_at": "2017-11-29T22:02:44Z",
      "updated_at": "2017-11-29T22:02:44Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h: I updated the binaries. This is intended only to guard against the NullReferenceException to see where it takes us.  I'm looking at refactoring the finalizer next but that will take a little longer.\r\n\r\nThanks for your help and patience.",
      "created_at": "2017-11-29T23:29:18Z",
      "updated_at": "2017-11-29T23:29:34Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "re: updated binaries - do I use the same Dropbox link as above, or do you have a new link? When I download from the link above, the binaries are dated ~12 hours ago.",
      "created_at": "2017-11-30T00:21:58Z",
      "updated_at": "2017-11-30T00:22:31Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "Yes, it's the same link.",
      "created_at": "2017-11-30T00:24:56Z",
      "updated_at": "2017-11-30T00:24:56Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "This is what I'm getting on my laptop with 10.13.1 - note that this is not the same system I was testing on this morning. I'm out of the office at the moment and won't be back for ~6 hours so can't test on my main Mac.\r\n```powershell\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/kai> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid -Credential $UserCredential -Authentication Basic -AllowRedirection                                \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: user@example.com\r\nPassword for user user@example.com: ********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/kai> $PSVersionTable                                                  \r\n\r\nName                           Value                                           \r\n----                           -----                                           \r\nPSVersion                      6.0.0-rc                                        \r\nPSEdition                      Core                                            \r\nGitCommitId                    v6.0.0-rc                                       \r\nOS                             Darwin 17.2.0 Darwin Kernel Version 17.2.0: F...\r\nPlatform                       Unix                                            \r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}                         \r\nPSRemotingProtocolVersion      2.3                                             \r\nSerializationVersion           1.1.0.1                                         \r\nWSManStackVersion              3.0                                             \r\n```",
      "created_at": "2017-11-30T00:26:11Z",
      "updated_at": "2017-11-30T00:26:11Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "Can I assume you are using the binary I sent you?\r\nAnd libpsrpclient is this one?\r\n\r\n-rw-r--r--  1 root  wheel   224784 15 Nov 07:39 libpsrpclient.dylib\r\n",
      "created_at": "2017-11-30T00:29:11Z",
      "updated_at": "2017-11-30T00:29:11Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Yes, this is with the supplied binary:\r\n```powershell\r\nPS /Users/kai> cd $pshome                                                       \r\nPS /usr/local/microsoft/powershell/6.0.0-rc> ls -al libpsrpclient.dylib         \r\n-rw-r--r--  1 root  wheel  224784 15 Nov 07:39 libpsrpclient.dylib\r\n```",
      "created_at": "2017-11-30T00:30:55Z",
      "updated_at": "2017-11-30T00:30:55Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h  I'm going to need to do a little research.  I'll try to get back with something tomorrow.  When you get a minute, would you perform the same sequence twice to see what the second pass reports? I believe that's what you did in the other thread, right?",
      "created_at": "2017-11-30T01:41:47Z",
      "updated_at": "2017-11-30T01:41:47Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Thanks for this @dantraMSFT - I ran it three or four times (as it failed the second time on my other Mac) and it came up with the same error each time. When I get back to my office, I will test it again on the fresh Mac I've set up for this purpose.\r\nJust to confirm, here are the results on my laptop. Previously I have got different results depending on if there's a slash on the end if the ConnectionUri so I've tried it both ways below.\r\n\r\n```powershell\r\n[kai@hobbes ~]$ pwsh\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/kai> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid -Credential $UserCredential -Authentication Basic -AllowRedirection                                                                                                                \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: user@example.com\r\nPassword for user user@example.com: *********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/kai> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid -Credential $UserCredential -Authentication Basic -AllowRedirection                                                                                                                \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: user@example.com      \r\nPassword for user user@example.com: ********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/kai> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid -Credential $UserCredential -Authentication Basic -AllowRedirection                                                                                                                \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: user@example.com\r\nPassword for user user@example.com: ********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/kai> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection                                                                                                               \r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: user@example.com\r\nPassword for user user@example.com: ********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/kai> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection                               \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: user@example.com\r\nPassword for user user@example.com: ********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/kai> exit                                                             \r\n[kai@hobbes ~]$ \r\n```",
      "created_at": "2017-11-30T01:45:17Z",
      "updated_at": "2017-11-30T01:46:02Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "I'd like to suggest using Steve's suggestion of setting DYLD_LIBRARY_PATH.  There are two problems here, failure to load the binary and the NullReferenceException.  the private has a workaround around for the exception. I'd like to know if the path solves the load issue.  tomorrow is fine.\r\n\r\nexport DYLD_LIBRARY_PATH=/usr/local/microsoft/powershell/6.0.0-rc:${DYLD_LIBRARY_PATH}\r\npwsh\r\n$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection\r\n\r\nThanks,\r\nDan.",
      "created_at": "2017-11-30T02:37:38Z",
      "updated_at": "2017-11-30T02:37:38Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Using the new binaries from the Dropbox link (and I noticed there was a new .txt file that looked to really be a .exe format) gives me the WSMan missing error. I've ran the New-PSSession command three times in a row, and got the same error each time.\r\nThis is on the Mac I set up with clean macOS 10.12.6 and PowerShell 6.0.0-rc\r\n```powershell\r\nAdministrators-Mac-mini:~ admin$ export DYLD_LIBRARY_PATH=/usr/local/microsoft/powershell/6.0.0-rc:${DYLD_LIBRARY_PATH}\r\nAdministrators-Mac-mini:~ admin$ pwsh\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/admin> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection                             \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: admin@example.com\r\nPassword for user admin@example.com: ********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/admin> \r\n```",
      "created_at": "2017-11-30T20:56:46Z",
      "updated_at": "2017-11-30T20:56:46Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Just to confirm that it's not something else that's changed on this system, I deleted /usr/local/microsoft and reinstalled PowerShell 6.0.0-rc.\r\nI then re-ran the commands above and could replicate my original result:\r\nThis is with the standard distribution, not using the debug binaries.\r\n```powershell\r\nAdministrators-Mac-mini:~ admin$ export DYLD_LIBRARY_PATH=/usr/local/microsoft/powershell/6.0.0-rc:${DYLD_LIBRARY_PATH}\r\nAdministrators-Mac-mini:~ admin$ pwsh\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/admin> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection                             \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: admin@example.com\r\nPassword for user admin@example.com: ********\r\n\r\n\r\nAn error has occurred that was not properly handled. Additional information is shown below. The PowerShell process will exit.\r\n\r\nUnhandled Exception: System.NullReferenceException: Object reference not set to an instance of an object.\r\n   at System.Management.Automation.Remoting.PrioritySendDataCollection.Clear()\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.CloseAsync()\r\n   at System.Management.Automation.Remoting.Client.WSManClientSessionTransportManager.CloseAsync()\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.Finalize()\r\nAbort trap: 6\r\nAdministrators-Mac-mini:~ admin$ \r\n```",
      "created_at": "2017-11-30T21:01:32Z",
      "updated_at": "2017-11-30T21:01:32Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Here is a full set of steps showing the unhandled exception with the binaries in the original .pkg installer and then with the missing WSMan library after replacing with the new binaries downloaded from dropbox\r\n```powershell\r\nAdministrators-Mac-mini:~ admin$ export DYLD_LIBRARY_PATH=/usr/local/microsoft/powershell/6.0.0-rc:${DYLD_LIBRARY_PATH}\r\nAdministrators-Mac-mini:~ admin$ pwsh\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/admin> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection                             \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: admin@example.com\r\nPassword for user admin@example.com: ********\r\n\r\n\r\nAn error has occurred that was not properly handled. Additional information is shown below. The PowerShell process will exit.\r\n\r\nUnhandled Exception: System.NullReferenceException: Object reference not set to an instance of an object.\r\n   at System.Management.Automation.Remoting.PrioritySendDataCollection.Clear()\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.CloseAsync()\r\n   at System.Management.Automation.Remoting.Client.WSManClientSessionTransportManager.CloseAsync()\r\n   at System.Management.Automation.Remoting.Client.BaseClientTransportManager.Finalize()\r\nAbort trap: 6\r\nAdministrators-Mac-mini:~ admin$ echo $DYLD_LIBRARY_PATH \r\n/usr/local/microsoft/powershell/6.0.0-rc:\r\nAdministrators-Mac-mini:~ admin$ sudo cp ~/Downloads/SMA4MacOSDebug/* /usr/local/microsoft/powershell/6.0.0-rc/\r\nAdministrators-Mac-mini:~ admin$ ls -al /usr/local/microsoft/powershell/6.0.0-rc/System.Management.Automation.*\r\n-rw-r--r--@ 1 root  wheel  7247360  1 Dec 08:07 /usr/local/microsoft/powershell/6.0.0-rc/System.Management.Automation.dll\r\n-rw-------  1 root  wheel  2880420  1 Dec 08:07 /usr/local/microsoft/powershell/6.0.0-rc/System.Management.Automation.pdb\r\n-rw-------  1 root  wheel  7247360  1 Dec 08:07 /usr/local/microsoft/powershell/6.0.0-rc/System.Management.Automation.txt\r\n-rw-r--r--  1 root  wheel  7549764 18 Nov 12:29 /usr/local/microsoft/powershell/6.0.0-rc/System.Management.Automation.xml\r\nAdministrators-Mac-mini:~ admin$ pwsh\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/admin> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection                             \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: admin@example.com\r\nPassword for user admin@example.com: ********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/admin> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection                             \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: admin@example.com\r\nPassword for user admin@example.com: ********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/admin> \r\n```",
      "created_at": "2017-11-30T21:10:39Z",
      "updated_at": "2017-11-30T21:10:39Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "I can set up a TeamViewer connection to this Mac if you want - this is my lab/testing machine and there's nothing important or sensitive on it.",
      "created_at": "2017-11-30T21:13:03Z",
      "updated_at": "2017-11-30T21:13:03Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "if you grabbed the binary with this timestamp (11/30/2017  10:59), the change is in logging, not error output.\r\n\r\nRun Console\r\nSelect the device node\r\nenter pwsh in search\r\nThen repro.\r\nThe point of the change is to log the underlying DLLNotFoundException to see if it provides something more precise.  Depending on what's logged, I'll add additional exploratory collection.  \r\nI suspect this 'may' be in the coreclr but will need to collect data to prove/disprove it.",
      "created_at": "2017-11-30T21:17:48Z",
      "updated_at": "2017-11-30T21:17:48Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "In the .zip I downloaded from Dropbox, the .dll file has a timestamp of 29 November at 11:27 pm (GMT+11), the .pdb file has a timestamp of 30 November at 6:59 pm, as does the .txt file\r\nThe .txt file seems to be a .dll that's been renamed - should I rename it to .dll and replace the other one?\r\nHere are the three files I got in the .zip\r\n```\r\n-rw-------@ 1 admin  staff  7247360 29 Nov 23:27 System.Management.Automation.dll\r\n-rw-------@ 1 admin  staff  2880420 30 Nov 18:59 System.Management.Automation.pdb\r\n-rw-------@ 1 admin  staff  7247360 30 Nov 18:59 System.Management.Automation.txt\r\n```",
      "created_at": "2017-11-30T21:49:41Z",
      "updated_at": "2017-11-30T21:57:49Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Here's the output I got in the Console app:\r\n```\r\ndefault\t08:50:38.214680 +1100\tpwsh\t(v6.0.0-rc:1:10) [Perftrack_ConsoleStartupStart:PowershellConsoleStartup.WinStart.Informational] PowerShell console is starting up\r\ndefault\t08:50:39.589383 +1100\tpwsh\t(v6.0.0-rc:1:10) [Perftrack_ConsoleStartupStop:PowershellConsoleStartup.WinStop.Informational] PowerShell console is ready for user input\r\ndefault\t08:50:47.944249 +1100\tpwsh\t(v6.0.0-rc:A:10) [Activity] {3cb558e2-5fb5-4071-852d-f558dfd26912}\r\ndefault\t08:50:47.951699 +1100\tpwsh\t(v6.0.0-rc:A:10) [Activity] {3b96cea1-ca37-4a58-9e72-1adda0039606}\r\n```",
      "created_at": "2017-11-30T21:54:10Z",
      "updated_at": "2017-11-30T21:54:10Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "Hi @kai-h , it doesn't look like you had the latest binary.  I've updated them and gotten rid of the .txt file.",
      "created_at": "2017-11-30T23:26:22Z",
      "updated_at": "2017-11-30T23:26:22Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Here's the output from PowerShell with the new binaries\r\n```powershell\r\nAdministrators-Mac-mini:~ admin$ ls -al /usr/local/microsoft/powershell/6.0.0-rc/System.Management.Automation.*\r\n-rw-r--r--@ 1 root  wheel  7247360  1 Dec 10:28 /usr/local/microsoft/powershell/6.0.0-rc/System.Management.Automation.dll\r\n-rw-r--r--@ 1 root  wheel  2880420  1 Dec 10:28 /usr/local/microsoft/powershell/6.0.0-rc/System.Management.Automation.pdb\r\n-rw-r--r--  1 root  wheel  7549764 18 Nov 12:29 /usr/local/microsoft/powershell/6.0.0-rc/System.Management.Automation.xml\r\nAdministrators-Mac-mini:~ admin$ pwsh\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/admin> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection                                                                           \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: user@example.com\r\nPassword for user user@example.com: ********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/admin> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection                                                                           \r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: user@example.com\r\nPassword for user user@example.com: ********\r\n\r\nNew-PSSession : This parameter set requires WSMan, and no supported WSMan client library was found. WSMan is either not installed or unavailable for this system.\r\nAt line:1 char:12\r\n+ $Session = New-PSSession -ConfigurationName Microsoft.Exchange -Conne ...\r\n+            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ResourceUnavailable: (:) [New-PSSession], PSRemotingTransportException\r\n+ FullyQualifiedErrorId : System.Management.Automation.Remoting.PSRemotingDataStructureException,Microsoft.PowerShell.Commands.NewPSSessionCommand\r\n \r\nPS /Users/admin> \r\n```\r\nHere is the output from the Console app - there doesn't seem to be much useful information there. Just to confirm, I'm launching Console app, going to the search field in the top-right corner and typing pwsh. The search field then reads [ ANY v ] pwsh\r\n```\r\ndefault\t10:33:53.106238 +1100\tpwsh\t(v6.0.0-rc:1:10) [Perftrack_ConsoleStartupStart:PowershellConsoleStartup.WinStart.Informational] PowerShell console is starting up\r\ndefault\t10:33:54.469075 +1100\tpwsh\t(v6.0.0-rc:1:10) [Perftrack_ConsoleStartupStop:PowershellConsoleStartup.WinStop.Informational] PowerShell console is ready for user input\r\ndefault\t10:34:17.267079 +1100\tpwsh\t(v6.0.0-rc:A:10) [Activity] {b185c9a1-a8f0-4ce9-b4c8-5f4bcd1e4e0a}\r\ndefault\t10:34:17.267566 +1100\tpwsh\t(v6.0.0-rc:A:10) [Activity] {91c362e1-9e4f-4200-8172-f3e973bbc83f}\r\ndefault\t10:34:23.749279 +1100\tpwsh\t0x7fd577f09df0 opened /var/folders/0w/dkzqlxr56g56mp55cp80g9jh0000gn/C//mds/mdsObject.db: 4636 bytes\r\ndefault\t10:34:23.751680 +1100\tpwsh\t0x7fd577c848e0 opened /var/folders/0w/dkzqlxr56g56mp55cp80g9jh0000gn/C//mds/mdsDirectory.db: 50744 bytes\r\ndefault\t10:34:23.756564 +1100\tpwsh\t0x7fd577cabf40 opened /var/folders/0w/dkzqlxr56g56mp55cp80g9jh0000gn/C//mds/mdsDirectory.db: 50744 bytes\r\n```\r\n![screen shot 2017-12-01 at 10 34 38 am](https://user-images.githubusercontent.com/597823/33460668-46ebb5de-d683-11e7-913a-4a36ea4bfc1a.png)\r\n",
      "created_at": "2017-11-30T23:35:05Z",
      "updated_at": "2017-11-30T23:35:05Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h: My best guess at this point, is you're missing a dependency; most likely a dependency libmi needs.\r\n\r\nRun otool -L against libmi.dylib in the $PSHOME directory and verify the dependencies exist.\r\nThe two key dependencies are openssl 1.0.0 and libpam 3.0.0.\r\n\r\nI did place a new debug binary on dropbox yesterday evening that should produce a log event with the details of the DLLNotFound exception.",
      "created_at": "2017-12-01T17:22:31Z",
      "updated_at": "2017-12-01T17:22:31Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Apologies for not getting back to you sooner with the results. I think we're getting somewhere.\r\nHere are the otool results - I'm missing some openssl libraries:\r\n/usr/local/opt/openssl/lib/libcrypto.1.0.0.dylib\r\n/usr/local/opt/openssl/lib/libssl.1.0.0.dylib\r\n\r\n/usr/local/opt is not used by a default install of macOS. Third-party package managers (like MacPorts) will often use this as a base directory to install ports.\r\n\r\n```bash\r\nAdministrators-Mac-mini:6.0.0-rc admin$ otool -L libmi.dylib \r\nlibmi.dylib:\r\n\t@rpath/libmi.dylib (compatibility version 0.0.0, current version 0.0.0)\r\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1238.60.2)\r\n\t/usr/lib/libpam.2.dylib (compatibility version 3.0.0, current version 3.0.0)\r\n\t/usr/local/opt/openssl/lib/libssl.1.0.0.dylib (compatibility version 1.0.0, current version 1.0.0)\r\n\t/usr/local/opt/openssl/lib/libcrypto.1.0.0.dylib (compatibility version 1.0.0, current version 1.0.0)\r\n\t/usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.8)\r\nAdministrators-Mac-mini:6.0.0-rc admin$ ls -al /usr/lib/libSystem.B.dylib /usr/lib/libpam.2.dylib /usr/local/opt/openssl/lib/libssl.1.0.0.dylib /usr/local/opt/openssl/lib/libcrypto.1.0.0.dylib /usr/lib/libz.1.dylib \r\nls: /usr/local/opt/openssl/lib/libcrypto.1.0.0.dylib: No such file or directory\r\nls: /usr/local/opt/openssl/lib/libssl.1.0.0.dylib: No such file or directory\r\n-rwxr-xr-x  1 root  wheel   60848 15 Jul 14:28 /usr/lib/libSystem.B.dylib\r\n-rwxr-xr-x  1 root  wheel   80944 15 Jul 14:28 /usr/lib/libpam.2.dylib\r\n-rwxr-xr-x  1 root  wheel  177824 15 Jul 14:27 /usr/lib/libz.1.dylib\r\nAdministrators-Mac-mini:6.0.0-rc admin$ \r\n```\r\n",
      "created_at": "2017-12-04T11:40:59Z",
      "updated_at": "2017-12-04T11:40:59Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "re: the additional logging - here are the results from Console.app for pwsh when running New-PSSession\r\n```\r\ndefault\t22:42:03.819271 +1100\tpwsh\t(v6.0.0-rc:9:10) [Activity] {fea85396-1987-4184-8426-6ad299343660}\r\ndefault\t22:42:03.826683 +1100\tpwsh\t(v6.0.0-rc:9:10) [Activity] {4918362a-1786-4d43-84a6-162bc3105466}\r\nerror\t22:42:03.934752 +1100\tpwsh\t(v6.0.0-rc:9:10) [TransportError:None.Open.Error] Runspace Id: WSManAPIDataCommon.ctor Pipeline Id: WSManInitialize. WSMan reported an error with error code: -2146233052. %n Error message: Unable to load DLL 'libpsrpclient': The specified module or one of its dependencies could not be found.\r\n (Exception from HRESULT: 0x8007007E) %n StackTrace:    at System.Management.Automation.Remoting.Client.WSManNativeApi.WSManInitialize(Int32 flags, IntPtr& wsManAPIHandle)\r\n   at System.Management.Automation.Remoting.Client.WSManClientSessionTransportManager.WSManAPIDataCommon..ctor() in /PowerShell/src/System.Management.Automation/engine/remoting/fanin/WSManTransportManager.cs:line 2603\r\n```\r\n",
      "created_at": "2017-12-04T11:43:08Z",
      "updated_at": "2017-12-04T11:43:08Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Maybe related problem #5590 ",
      "created_at": "2017-12-04T12:31:45Z",
      "updated_at": "2017-12-04T12:31:45Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h can you try using brew to install OpenSSL? That should be the path brew adds the package. ",
      "created_at": "2017-12-04T12:39:39Z",
      "updated_at": "2017-12-04T12:39:39Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "We're making a bit of progress here. I generally use MacPorts for installing ports, not Homebrew as I consider Homebrew to be more of a security risk, and is not in keeping of long-standing Unix conventions.\r\nMy main issue with Homebrew is it changing permissions on system directories and that the project maintainers explicitly state that they DO NOT support using it with sudo.\r\n```\r\n==> The following existing directories will be made group writable:\r\n/usr/local/bin\r\n/usr/local/share\r\n/usr/local/share/man\r\n/usr/local/share/man/man1\r\n==> The following existing directories will have their owner set to admin:\r\n/usr/local/bin\r\n/usr/local/share\r\n/usr/local/share/man\r\n/usr/local/share/man/man1\r\n==> The following existing directories will have their group set to admin:\r\n/usr/local/bin\r\n/usr/local/share\r\n/usr/local/share/man\r\n/usr/local/share/man/man1\r\n```\r\nMacPorts installs it's ports in /opt/local and it keeps those directories owned by root which helps prevent anything malicious from dumping extraneous stuff in there (unless it's root already in which case you're already pwned)\r\n\r\nThat rant aside, here are my results running New-PSSession once I'd installed OpenSSL via Homebrew:\r\n\r\nShowing the libraries required according to otool are there:\r\n```\r\nAdministrators-Mac-mini:~ admin$ ls -al /usr/lib/libSystem.B.dylib /usr/lib/libpam.2.dylib /usr/local/opt/openssl/lib/libssl.1.0.0.dylib /usr/local/opt/openssl/lib/libcrypto.1.0.0.dylib /usr/lib/libz.1.dylib \r\n-rwxr-xr-x  1 root   wheel    60848 15 Jul 14:28 /usr/lib/libSystem.B.dylib\r\n-rwxr-xr-x  1 root   wheel    80944 15 Jul 14:28 /usr/lib/libpam.2.dylib\r\n-rwxr-xr-x  1 root   wheel   177824 15 Jul 14:27 /usr/lib/libz.1.dylib\r\n-r--r--r--  1 admin  admin  1991920  5 Dec 08:54 /usr/local/opt/openssl/lib/libcrypto.1.0.0.dylib\r\n-r--r--r--  1 admin  admin   385168  5 Dec 08:54 /usr/local/opt/openssl/lib/libssl.1.0.0.dylib\r\n```\r\nI was able to successfully create a new session with New-PSSession. When I ran Import-PSSession however it displayed the text-based progress bar as it imported modules and then it seemed to hang and didn't return to the command prompt:\r\n\r\n```\r\nAdministrators-Mac-mini:~ admin$ pwsh\r\nPowerShell v6.0.0-rc\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /Users/admin>   $PSVersionTable    \r\n\r\nName                           Value  \r\n----                           ----- \r\nPSVersion                      6.0.0-rc\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.0-rc\r\nOS                             Darwin 16.7.0 Darwin Kernel Version 16.7.0: Thu Jun 15 17:36:27 PDT 2017; root:xnu-3789.70.16~2/RELEASE_X86_64\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\nPS /Users/admin> $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection\r\n\r\nPowerShell credential request\r\nEnter your credentials.\r\nUser: kai@automatica.com.au\r\nPassword for user kai@automatica.com.au: ************\r\n\r\nPS /Users/admin> Import-PSSession $Session\r\n```\r\nAfter the Import-PSSession it didn't return.",
      "created_at": "2017-12-04T22:45:16Z",
      "updated_at": "2017-12-04T22:45:16Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h good to know on homebrew... i am very very new to macOS and only use it to work in this project \ud83d\ude04 . \r\n\r\nThe key to macports would be whether or not it would add the libraries to `/usr/local/opt/openssl/lib/`. if not, would it be possible to link `/usr/local/opt/openssl/lib/` fo the `lib` folder it *does* install (`ln-s` or something). If that's possible, than the package manager is somewhat irrelevant other than one being easier to use than the other for this scenario.\r\n\r\nas a test, can you just try this:\r\n\r\n```powershell\r\n$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UserCredential -Authentication Basic -AllowRedirection\r\n\r\nInvoke-Command -Session $Session -ScriptBlock { get-mailbox -ResultSize 1 } \r\n```",
      "created_at": "2017-12-04T22:52:49Z",
      "updated_at": "2017-12-04T22:52:49Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h: There's a bug in workaround I gave you. I'll give you another drop shortly to see if it resolves the problem of if there's something else going on.",
      "created_at": "2017-12-04T23:04:00Z",
      "updated_at": "2017-12-04T23:04:00Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "@markekraus - That command works in that when I give it my Office 365 credentials it displays lots of information about my user account and mailbox (I won't copy and paste it here) however it never returns to the command prompt. Even Ctrl+C doesn't kill it, the only solution appears to be to close the Terminal window.",
      "created_at": "2017-12-04T23:12:01Z",
      "updated_at": "2017-12-04T23:12:01Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "@markekraus - re symlinking to /usr/local/opt/openssl/lib \r\nMacPorts installs the OpenSSL libraries in /opt/local/lib - I could try symlinking this to /usr/local/opt/openssl/lib for testing purposes, however there are likely to be other libraries in here other than the OpenSSL libraries if the end user has installed more packages with MacPorts.",
      "created_at": "2017-12-04T23:14:45Z",
      "updated_at": "2017-12-04T23:14:45Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h: The updated binary and pdb file is on dropbox.",
      "created_at": "2017-12-04T23:51:20Z",
      "updated_at": "2017-12-04T23:51:20Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Thank you for the new binaries. I have installed them and now I don't get an error when I invoke New-PSSession and the following command runs and returns to the command prompt.\r\ne.g. If I then run Import-PSSession $PSSession, it imports the modules and returns me to the command prompt as expected.\r\n\r\nI haven't tried executing any further remote commands against Office 365 yet, except for the Invoke-Command listed above, which seems to behave as it should\r\n```\r\nInvoke-Command -Session $Session -ScriptBlock { get-mailbox -ResultSize 1 }\r\n```\r\nThis seems to give me a heap of information about my mailbox.\r\n\r\nAgain, thank you for the huge amount of work that must have gone in to supporting PowerShell on non-Windows platforms, and for the attention you have given to this particular issue.\r\n\r\nI would like to see the dependance on Homebrew installed OpenSSL libraries eliminated for the reasons mentioned above. I will test the workaround of symlinking the libraries from MacPorts (which does play nicely with sudo and doesn't change the ownership of system directories).\r\n\r\nFor the final release version, is it likely that PowerShell will ship with all the required dependancies, or will it rely on these libraries to be installed via 3rd party package managers?",
      "created_at": "2017-12-06T00:20:29Z",
      "updated_at": "2017-12-06T00:22:02Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h Go ahead and file an issue MacPorts/Homebrew.  Please include enough detail so a MacOS neophyte like myself can understand it. :)\r\n\r\nThanks again for all of your help tracking this down.",
      "created_at": "2017-12-06T00:42:40Z",
      "updated_at": "2017-12-06T00:42:40Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "@dantraMSFT - I will do. Thanks.",
      "created_at": "2017-12-06T00:44:46Z",
      "updated_at": "2017-12-06T00:44:46Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "I have logged issue #5634 regarding this.",
      "created_at": "2017-12-06T02:07:43Z",
      "updated_at": "2017-12-06T02:07:43Z"
    }
  ],
  "created_at": "2017-06-16T04:44:35Z",
  "labels": [
    "Issue-Bug",
    "OS-macOS",
    "Resolution-Fixed",
    "WG-Remoting"
  ],
  "number": 4029,
  "state": "closed",
  "title": "New-PSSession still fails with a NullReferenceException on macOS",
  "updated_at": "2018-01-05T08:41:46Z"
}