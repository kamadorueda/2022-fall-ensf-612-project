{
  "_url": "https://github.com/PowerShell/PowerShell/issues/5967",
  "author": "markekraus",
  "body": "<!--\r\n\r\nFor Windows PowerShell 5.1 issues, suggestions, or feature requests please use the following link instead:\r\n- Windows PowerShell [UserVoice](https://windowsserver.uservoice.com/forums/301869-powershell)\r\n\r\nIf it is a bug report:\r\n- make sure you are able to repro it on the latest released version. \r\nYou can install the latest version from https://github.com/PowerShell/PowerShell/releases\r\n- Search the existing issues.\r\n- Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- Refer to the [known issues](https://github.com/PowerShell/PowerShell/blob/master/docs/KNOWNISSUES.md).\r\n- Fill out the following repro template:\r\n\r\nIf it's not a bug, please remove the template and elaborate the issue in your own words.\r\n-->\r\n\r\nWhen a relative path redirect is sent in the `Location` response header and the `Authorization` header is supplied, `Invoke-WebRequest` and `Invoke-RestMethod` will fail to redirect unless the `-PreserveAuthorizationOnRedirect` parameter is supplied. This does not fail if the `Location:` supplies an absolute URL.\r\n\r\nThe problem is here:\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/beffdcf94d00b51d9339bb26dbc0e477cd147c92/src/Microsoft.PowerShell.Commands.Utility/commands/utility/WebCmdlet/Common/WebRequestPSCmdlet.Common.cs#L1214\r\n\r\nWe are taking the `Location` header and supplying it as is. When the `Location` header contains a relative path (`/get` for example instead of `https://httpbin.org/get`), this causes a `System.UriFormatException` on the following line\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/beffdcf94d00b51d9339bb26dbc0e477cd147c92/src/Microsoft.PowerShell.Commands.Utility/commands/utility/WebCmdlet/Common/WebRequestPSCmdlet.Common.cs#L661\r\n\r\nWe need to detect an relative URI and construct an absulute one if neccesary.\r\n\r\nThis is a regression from Windows PowerShell 5.1 introduced in #3885.\r\n\r\n\r\nSteps to reproduce\r\n------------------\r\n\r\n```powershell\r\n$uri = ' https://httpbin.org/relative-redirect/6'\r\n$headers = @{Authorization = \"Bearer foo\"}\r\nInvoke-WebRequest -Uri $uri -Headers $headers | Select-Object -ExpandProperty Content\r\n```\r\n\r\nExpected behavior\r\n-----------------\r\n\r\n```none\r\n{\r\n  \"args\": {},\r\n  \"headers\": {\r\n    \"Connection\": \"close\",\r\n    \"Host\": \"httpbin.org\",\r\n    \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Microsoft Windows 10.0.16299; en-US) PowerShell/6.0.0\"\r\n  },\r\n  \"origin\": \"209.205.125.102\",\r\n  \"url\": \"https://httpbin.org/get\"\r\n}\r\n```\r\n\r\nActual behavior\r\n---------------\r\n\r\n```none\r\nInvoke-WebRequest : Invalid URI: The hostname could not be parsed.\r\nAt line:1 char:1\r\n+ Invoke-WebRequest -Uri $uri -Headers $headers | Select-Object -Expand ...\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : NotSpecified: (:) [Invoke-WebRequest], UriFormatException\r\n+ FullyQualifiedErrorId : System.UriFormatException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand\r\n```\r\n\r\nEnvironment data\r\n----------------\r\n\r\n<!-- provide the output of $PSVersionTable -->\r\n\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.0.0\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.0\r\nOS                             Microsoft Windows 10.0.16299\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n",
  "closed_at": "2018-03-09T16:28:21Z",
  "comments": [],
  "created_at": "2018-01-20T20:22:08Z",
  "number": 5967,
  "state": "closed",
  "title": "Web Cmdlets Fail to Redirect to Relative Paths when Authorization Header Supplied but -PreserveAuthorizationOnRedirect Not Present",
  "updated_at": "2018-03-24T17:40:18Z"
}