{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16265",
  "author": "iSazonov",
  "body": "<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\nLatest PerfView doesn't load PDB files for PowerShell assemblies (SMA and other) without the fix.\r\n\r\nAfter adding PublishReadyToRunEmitSymbols I had to exclude NewtonSoft.JSON.dll from processing by crossgen2.exe because this broke PDB loading.\r\n\r\n## PR Context\r\n\r\n<!-- Provide a little reasoning as to why this Pull Request helps and why you have opened it. -->\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [x] None\r\n    - **OR**\r\n    - [ ] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n        - [ ] Experimental feature name(s): <!-- Experimental feature name(s) here -->\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n- **Testing - New and feature**\r\n    - [x] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [ ] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [ ] I have considered the user experience from a tooling perspective and opened an issue in the relevant tool repository. This may include:\r\n        - [ ] Impact on [PowerShell Editor Services](https://github.com/PowerShell/PowerShellEditorServices) which is used in the [PowerShell extension](https://github.com/PowerShell/vscode-powershell) for VSCode\r\n        (which runs in a different PS Host).\r\n            - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n        - [ ] Impact on Completions (both in the console and in editors) - one of PowerShell's most powerful features.\r\n            - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n        - [ ] Impact on [PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer) (which provides linting & formatting in the editor extensions).\r\n            - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n        - [ ] Impact on [EditorSyntax](https://github.com/PowerShell/EditorSyntax) (which provides syntax highlighting with in VSCode, GitHub, and many other editors).\r\n            - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n",
  "closed_at": "2021-10-23T09:46:01Z",
  "comments": [
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "This PR feels more like a workaround for yourself, rather than a complete fix for an issue:\r\n1. Did it work on previous older version of PerfView?\r\n2. What's the root cause? Could it be a problem with the latest PerfView?\r\n3. Removing `Newtonsoft.Json.dll` means it will not be pre-jitted, and that will impact the startup.\r\n\r\nGiven that, I will turn this into a draft for now.",
      "created_at": "2021-10-18T19:59:31Z",
      "updated_at": "2021-10-18T19:59:31Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> This PR feels more like a workaround for yourself, rather than a complete fix for an issue:\r\n> \r\n> 1. Did it work on previous older version of PerfView?\r\n\r\nNo, I started with old version (six months old).\r\n\r\nAlso there was a problem with .Net  https://github.com/dotnet/runtime/issues/53743\r\n\r\n> 2. What's the root cause? Could it be a problem with the latest PerfView?\r\n\r\nFor .Net 5.0 and crossgen 1.0, PerfView generated ni.pdb files for PowerShell assemblies on the fly.\r\nNow it doesn't. When I try to load SMA.pdb, I see \"Out of memory\" message in the Perfview log.\r\nAfter I manually processed the SMA with crossgen2.exe I get SMA.ni.dll (with exactly the same size as original one) and SMA.ni.pdb. After renaming SMA.ni.dll to SMA.dll PerfView loads SMA.ni.pdb and show all callsites in trace.\r\n\r\nI can not point a root of the issue since crossgen2.exe is not well documented. But I found a comment that now PDB files contain a reference to ni.pdb. This force me think that our crossgen process is out of date.\r\n\r\n> 3. Removing `Newtonsoft.Json.dll` means it will not be pre-jitted, and that will impact the startup.\r\n> \r\n\r\nI measured and don't see noticeable difference (81 vs 80 ms for reading/parsing pwsh config on my notebook). I guess Newtonsoft.Json implementation is not optimized for .Net at all.\r\n\r\n> Given that, I will turn this into a draft for now.\r\n\r\nI don't know how fix right the issue with Newtonsoft.Json.dll but I am sure we should enable PublishReadyToRunEmitSymbols.\r\nI think it is a time to migrate from Newtonsoft.Json.dll to System.Text.Json in the config R/W scenario. _10% to read json config at startup is too many/slow_. I hope System.Text.Json will be a bit faster.\r\n\r\nUpdate: I have refreshed my early experiment with using System.Text.Json from .Net 5 to .Net 6.0 RC2 and now I see good perf win for ReadValueFromFile() ~4x.",
      "created_at": "2021-10-19T08:50:15Z",
      "updated_at": "2021-10-19T15:30:36Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@daxian-dbw After thinking more I am sure the PublishReadyToRunEmitSymbols must be added to 7.2 release otherwise we will distribute \"broken\" PDB files.\r\nI guess we can not fix the issue with NewtonSoft.Json because it is not compiled for new .Net 6.0 format - in any case we have broken either pdb or ni.pdb scenario. I think to remove the NewtonSoft.Json workaround from the PR - it is for MSFT team conclusion (should we still crossgen the dll for Add-Type as comment in Build.psm1 say?).",
      "created_at": "2021-10-21T03:29:55Z",
      "updated_at": "2021-10-21T03:30:37Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "I will take a look tomorrow. The 7.2-rc.1 release build already started, but if this is proven to be really needed, we may still have time to include it in the GA release.",
      "created_at": "2021-10-21T05:30:37Z",
      "updated_at": "2021-10-21T05:30:37Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "This doesn't need to be included in 7.2 GA. PowerShell packages don't ship pdb files anyways.",
      "created_at": "2021-10-22T01:35:23Z",
      "updated_at": "2021-10-22T01:35:23Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> You are right, profiler needs the symbols generated by <PublishReadyToRunEmitSymbols> to examine the R2R files. However, those symbols are only useful for profiling the **startup scenario** of PowerShell because PowerShell enables tiered compilation which will overwrite the R2R code.\r\n\r\nIt is not only for startup scenario. It is for **all** scenarios including hosting. ([User should disable TC](https://docs.microsoft.com/en-us/dotnet/core/deploying/ready-to-run#symbol-generation-for-use-with-profilers))\r\nAnyone who is going to measure PowerShell or their .Net 6.0 hosting application will encounter this problem.\r\nNext version is LTS and it is not god to have broken pdbs for next 3 years.\r\n\r\n>  PowerShell packages don't ship pdb files anyways.\r\n\r\nI think they distributed by Microsoft Symbol servers. If no it must be.\r\n\r\nAlso I guess .Net are migrating to portable pdb format where possible https://github.com/dotnet/runtime/issues/45492\r\nWe use portable pdb for Unix but full for Windows. I think it is a time to use portable on Windows too.\r\n`<DebugType>portable</DebugType>` in PowerShell.Common.props\r\n\r\n[Official intention](https://github.com/dotnet/core/blob/main/Documentation/diagnostics/portable_pdb.md)\r\n\r\n\r\nWe run still crossgen for standard .Net dll-s. I think it should be removed.\r\nhttps://github.com/PowerShell/PowerShell/blob/612aade35623f4a06c7f3448e5bb07673d8c1eeb/build.psm1#L2498-L2499",
      "created_at": "2021-10-22T04:48:39Z",
      "updated_at": "2021-10-22T11:14:22Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "> It is not only for startup scenario. It is for all scenarios including hosting. (User should disable TC)\r\n\r\nPowerShell nuget packages use IL assemblies, not R2R images. So applications that hosting powershell using NuGet packages don't have this problem. They can choose to publish R2R images for their applications though, but that's nothing to do with the powershell build.\r\n\r\nToday PowerShell symbols are not distributed by any symbol servers. It's in our backlog.\r\nFor portable pdb on Windows, I think our build requires Windows pdb on Windows for APIScan and other compliance jobs, @TravisEz13 can share more insights regarding this.\r\n\r\n> We run still crossgen for standard .Net dll-s. I think it should be removed.\r\n\r\nDoes `<PublishReadyToRun>` generate R2R images for them all? Or, are those .NET runtime assemblies already in R2R image format?",
      "created_at": "2021-10-22T15:27:56Z",
      "updated_at": "2021-10-22T15:28:46Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> For portable pdb on Windows, I think our build requires Windows pdb on Windows for APIScan and other compliance jobs, @TravisEz13 can share more insights regarding this.\r\n\r\nIt is already in PowerShell.Common.props - for compliance and release build there are different conditions.",
      "created_at": "2021-10-22T18:01:11Z",
      "updated_at": "2021-10-22T18:01:11Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> Does `<PublishReadyToRun>` generate R2R images for them all? Or, are those .NET runtime assemblies already in R2R image format?\r\n\r\nYes, .Net 6.0 dll-s are already in R2R format.",
      "created_at": "2021-10-22T18:25:03Z",
      "updated_at": "2021-10-22T18:25:03Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "> Yes, .Net 6.0 dll-s are already in R2R format.\r\n\r\nCan you share the link to the documentation/issue/blog that confirms this? I have been assuming this but couldn't find an official confirmation.\r\n\r\nAs for portable pdb, I will leave it to @TravisEz13 to comment.",
      "created_at": "2021-10-22T18:51:16Z",
      "updated_at": "2021-10-22T18:51:16Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> Can you share the link to the documentation/issue/blog that confirms this?\r\n\r\nI can not find explicit post but I saw :-) I could open issue-question in Runtime repo if you want.\r\n\r\nNow I opened one dll in ILSpy and it show R2R\r\n![image](https://user-images.githubusercontent.com/22290914/138508867-837f11f1-9554-4cff-9438-18e27629db79.png)\r\n\r\n",
      "created_at": "2021-10-22T18:58:25Z",
      "updated_at": "2021-10-22T18:58:25Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "That's perfect! I have been looking for ways to deterministically know if an assembly is R2R image!\r\n\r\nIt seems the following 3 assemblies (at least) are not R2R image:\r\nSystem.Runtime.Extensions.dll\r\nSystem.IO.FileSystem.dll\r\nSystem.IO.FileSystem.Primitives.dll\r\n\r\nCan you verify with ILSpy?",
      "created_at": "2021-10-22T19:01:40Z",
      "updated_at": "2021-10-22T19:01:40Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Only System.IO.FileSystem.Primitives.dll is not crossgen2 as ILSpy shows.\r\n\r\nPerhaps PublishReadyToRun does crossgen for PowerShell. Will ask in Runtime.",
      "created_at": "2021-10-22T19:06:53Z",
      "updated_at": "2021-10-22T19:06:53Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "How come it doesn't show `Crossgen2` message to me? I'm using ILSpy version 7.1.0.6543. How to get the `Crossgen2 ...` message shown up?\r\n\r\n![image](https://user-images.githubusercontent.com/127450/138510028-12b50186-9d46-4a67-a133-190ee3e3ae9a.png)\r\n",
      "created_at": "2021-10-22T19:08:37Z",
      "updated_at": "2021-10-22T19:08:37Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "You need switch from C# to ReadyToRun in menu ",
      "created_at": "2021-10-22T19:11:29Z",
      "updated_at": "2021-10-22T19:11:29Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Issue in .Net Runtime https://github.com/dotnet/runtime/issues/60779",
      "created_at": "2021-10-22T19:15:11Z",
      "updated_at": "2021-10-22T19:42:36Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "System.IO.FileSystem.Primitives.dll is compiled for AnyCPU. So it can not be in R2R :-)",
      "created_at": "2021-10-22T19:21:19Z",
      "updated_at": "2021-10-22T19:21:19Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "> You need switch from C# to ReadyToRun in menu\r\n\r\nThanks! You are using 7.2-preview.1. I see the `ReadyToRun` option after switching to that version.\r\n\r\n> System.IO.FileSystem.Primitives.dll is compiled for AnyCPU. So it can not be in R2R :-)\r\n\r\nYeah. both `System.Runtime.Extensions.dll` and `System.IO.FileSystem.dll` are also targeting AnyCPU. If you see that differently, you must be using the assembly that are further processed by `Start-Crossgen` in powershell build.\r\n\r\nThe .NET team has [confirmed](https://github.com/dotnet/runtime/issues/60779) that ALL .NET 6 runtime assemblies should be R2R images.\r\nBased on that, I opened https://github.com/dotnet/runtime/issues/60782 to report the findings.\r\n**[Update]** It turns out this is by design because those assemblies as pure fa\u00e7ade assemblies.\r\n\r\nI have also verified that `<PublishReadyToRun>true</PublishReadyToRun>` actually crossgen'ed all the package assemblies pwsh depends on, including all that in the [$commonAssembliesForAddType](https://github.com/PowerShell/PowerShell/blob/e5d27d139c59a94931bf7767b7e17a4b3bc65d00/build.psm1#L2499-L2523) array today. The following is the pdb generated for those crossgen'ed assemblies.\r\n\r\n```\r\nInputObject                                           SideIndicator\r\n-----------                                           -------------\r\nMarkdig.Signed.ni.pdb                                 =>\r\nMicrosoft.ApplicationInsights.ni.pdb                  =>\r\nMicrosoft.CodeAnalysis.CSharp.ni.pdb                  =>\r\nMicrosoft.CodeAnalysis.ni.pdb                         =>\r\nMicrosoft.Extensions.ObjectPool.ni.pdb                =>\r\nMicrosoft.Management.Infrastructure.CimCmdlets.ni.pdb =>\r\nMicrosoft.Management.Infrastructure.Native.ni.pdb     =>\r\nMicrosoft.Management.Infrastructure.ni.pdb            =>\r\nMicrosoft.PowerShell.Commands.Diagnostics.ni.pdb      =>\r\nMicrosoft.PowerShell.Commands.Management.ni.pdb       =>\r\nMicrosoft.PowerShell.Commands.Utility.ni.pdb          =>\r\nMicrosoft.PowerShell.ConsoleHost.ni.pdb               =>\r\nMicrosoft.PowerShell.CoreCLR.Eventing.ni.pdb          =>\r\nMicrosoft.PowerShell.GraphicalHost.ni.pdb             =>\r\nMicrosoft.PowerShell.MarkdownRender.ni.pdb            =>\r\nMicrosoft.PowerShell.Security.ni.pdb                  =>\r\nMicrosoft.WSMan.Management.ni.pdb                     =>\r\nMicrosoft.WSMan.Runtime.ni.pdb                        =>\r\nNamotion.Reflection.ni.pdb                            =>\r\nNewtonsoft.Json.ni.pdb                                =>\r\nNJsonSchema.ni.pdb                                    =>\r\npwsh.ni.pdb                                           =>\r\nSystem.ComponentModel.Composition.ni.pdb              =>\r\nSystem.ComponentModel.Composition.Registration.ni.pdb =>\r\nSystem.Data.Odbc.ni.pdb                               =>\r\nSystem.Data.OleDb.ni.pdb                              =>\r\nSystem.Data.SqlClient.ni.pdb                          =>\r\nSystem.DirectoryServices.AccountManagement.ni.pdb     =>\r\nSystem.DirectoryServices.Protocols.ni.pdb             =>\r\nSystem.IO.Ports.ni.pdb                                =>\r\nSystem.Management.Automation.ni.pdb                   =>\r\nSystem.Management.ni.pdb                              =>\r\nSystem.Net.Http.WinHttpHandler.ni.pdb                 =>\r\nSystem.Private.ServiceModel.ni.pdb                    =>\r\nSystem.Reflection.Context.ni.pdb                      =>\r\nSystem.Runtime.Caching.ni.pdb                         =>\r\nSystem.ServiceModel.Syndication.ni.pdb                =>\r\nSystem.ServiceProcess.ServiceController.ni.pdb        =>\r\nSystem.Speech.ni.pdb                                  =>\r\n```\r\n\r\n\r\nGiven all above, I think we consider removing the `Start-CrossGen` code now. I will try working on that.",
      "created_at": "2021-10-22T19:44:35Z",
      "updated_at": "2021-10-22T21:19:35Z"
    }
  ],
  "created_at": "2021-10-18T13:31:41Z",
  "number": 16265,
  "state": "closed",
  "title": "Fix PerfView not load pdb",
  "updated_at": "2021-10-23T09:46:06Z"
}