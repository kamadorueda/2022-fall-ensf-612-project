{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16474",
  "author": "chscott",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\n```\r\nC:\\Temp> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.5\r\nPSEdition                      Core\r\nGitCommitId                    7.1.5\r\nOS                             Microsoft Windows 10.0.19042\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\nC:\\Temp> Import-Module -Name '.\\MyModule.dll' -Verbose\r\nVERBOSE: Loading module from path 'C:\\Temp\\MyModule.dll'.\r\n```\r\n\r\n```\r\nC:\\Temp> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.0\r\nPSEdition                      Core\r\nGitCommitId                    7.2.0\r\nOS                             Microsoft Windows 10.0.19042\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\nC:\\Temp> Import-Module -Name '.\\MyModule.dll' -Verbose\r\nVERBOSE: Loading module from path 'C:\\Temp\\MyModule.dll'.\r\nImport-Module: The type initializer for '<Module>' threw an exception.\r\n```\r\n\r\n[MyModule.zip](https://github.com/PowerShell/PowerShell/files/7540667/MyModule.zip)\r\n\n\n### Expected behavior\n\n```console\nThe module should load in 7.2.0.\n```\n\n\n### Actual behavior\n\n```console\nImport-Module: The type initializer for '<Module>' threw an exception.\n```\n\n\n### Error details\n\n_No response_\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.0\r\nPSEdition                      Core\r\nGitCommitId                    7.2.0\r\nOS                             Microsoft Windows 10.0.19042\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": "2021-11-17T04:00:47Z",
  "comments": [
    {
      "author": "SeeminglyScience",
      "author_association": "COLLABORATOR",
      "body": "Can you post the full error (e.g. `Get-Error`) and what `MyModule` is?",
      "created_at": "2021-11-15T18:45:56Z",
      "updated_at": "2021-11-15T18:45:56Z"
    },
    {
      "author": "chscott",
      "author_association": "NONE",
      "body": "> Can you post the full error (e.g. `Get-Error`) and what `MyModule` is?\r\n\r\nGet-Error output is below. This is a proprietary module my company markets, though this is a reduced version for demonstration purposes. The full version has the same problem.\r\n\r\nWe write the code in PowerShell syntax and then use a product called [PSProtector](https://www.psprotector.com/) to compile that down into a DLL. This has always worked great, but it breaks in 7.2.0. I'm not sure if the problem is on their side or here, so I've reported it in both places.\r\n\r\n```\r\nC:\\Temp> Get-Error\r\n\r\nException             :\r\n    Type           : System.TypeInitializationException\r\n    TypeName       : <Module>\r\n    TargetSite     :\r\n        Name          : GetActivationInfo\r\n        DeclaringType : System.RuntimeTypeHandle\r\n        MemberType    : Method\r\n        Module        : System.Private.CoreLib.dll\r\n    Message        : The type initializer for '<Module>' threw an exception.\r\n    InnerException :\r\n        Type           : System.TypeInitializationException\r\n        TypeName       : TMCTools.BitmapDictionary\r\n        TargetSite     :\r\n            Name          : ClearTemplate\r\n            DeclaringType : TMCTools.BitmapDictionary, TMCTools, Version=1.0.828.0, Culture=neutral, PublicKeyToken=null\r\n            MemberType    : Method\r\n            Module        : TMCTools.dll\r\n        Message        : The type initializer for 'TMCTools.BitmapDictionary' threw an exception.\r\n        InnerException :\r\n            Type           : System.BadImageFormatException\r\n            Message        : Could not load file or assembly 'TMCTools&, Culture=neutral, PublicKeyToken=null'. An attempt was made to load a program with an incorrect\r\nformat.\r\n            FileName       : TMCTools&, Culture=neutral, PublicKeyToken=null\r\n            TargetSite     :\r\n                Name          : InternalLoad\r\n                DeclaringType : System.Reflection.RuntimeAssembly, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\r\n                MemberType    : Method\r\n                Module        : System.Private.CoreLib.dll\r\n            InnerException :\r\n                Type       : System.BadImageFormatException\r\n                Message    : Bad IL format.\r\n                TargetSite :\r\n                    Name          : InternalLoad\r\n                    DeclaringType : System.Runtime.Loader.AssemblyLoadContext\r\n                    MemberType    : Method\r\n                    Module        : System.Private.CoreLib.dll\r\n                Source     : System.Private.CoreLib\r\n                HResult    : -2147024885\r\n                StackTrace :\r\n   at System.Runtime.Loader.AssemblyLoadContext.InternalLoad(ReadOnlySpan`1 arrAssembly, ReadOnlySpan`1 arrSymbols)\r\n   at System.Reflection.Assembly.Load(Byte[] rawAssembly, Byte[] rawSymbolStore)\r\n   at System.Reflection.Assembly.Load(Byte[] rawAssembly)\r\n   at TMCTools.BitmapDictionary.ClearTemplate(Object rootValues, ResolveEventArgs lastQuery)\r\n   at System.Runtime.Loader.AssemblyLoadContext.InvokeResolveEvent(ResolveEventHandler eventHandler, RuntimeAssembly assembly, String name)\r\n   at System.Runtime.Loader.AssemblyLoadContext.OnAssemblyResolve(RuntimeAssembly assembly, String assemblyFullName)\r\n            Source         : System.Private.CoreLib\r\n            HResult        : -2147024885\r\n            StackTrace     :\r\n   at System.Reflection.RuntimeAssembly.InternalLoad(ObjectHandleOnStack assemblyName, ObjectHandleOnStack requestingAssembly, StackCrawlMarkHandle stackMark, Boolean\r\nthrowOnFileNotFound, ObjectHandleOnStack assemblyLoadContext, ObjectHandleOnStack retAssembly)\r\n   at System.Reflection.RuntimeAssembly.InternalLoad(AssemblyName assemblyName, RuntimeAssembly requestingAssembly, StackCrawlMark& stackMark, Boolean\r\nthrowOnFileNotFound, AssemblyLoadContext assemblyLoadContext)\r\n   at System.Reflection.Assembly.Load(String assemblyString)\r\n   at TMCTools.BitmapDictionary..cctor()\r\n        Source         : TMCTools\r\n        HResult        : -2146233036\r\n        StackTrace     :\r\n   at TMCTools.BitmapDictionary.ClearTemplate()\r\n   at .cctor()\r\n    Source         : System.Private.CoreLib\r\n    HResult        : -2146233036\r\n    StackTrace     :\r\n   at System.RuntimeTypeHandle.GetActivationInfo(ObjectHandleOnStack pRuntimeType, (fnptr)* ppfnAllocator, Void** pvAllocatorFirstArg, (fnptr)* ppfnCtor, BOOL*\r\npfCtorIsPublic)\r\n   at System.RuntimeTypeHandle.GetActivationInfo(RuntimeType rt, (fnptr)& pfnAllocator, Void*& vAllocatorFirstArg, (fnptr)& pfnCtor, Boolean& ctorIsPublic)\r\n   at System.RuntimeType.ActivatorCache..ctor(RuntimeType rt)\r\n   at System.RuntimeType.CreateInstanceDefaultCtor(Boolean publicOnly, Boolean wrapExceptions)\r\n   at System.Management.Automation.Runspaces.PSSnapInHelpers.ExecuteModuleInitializer(Assembly assembly, IEnumerable`1 assemblyTypes)\r\n   at System.Management.Automation.Runspaces.PSSnapInHelpers.AnalyzeModuleAssemblyWithReflection(Assembly assembly, String name, PSSnapInInfo psSnapInInfo, PSModuleInfo\r\nmoduleInfo, String helpFile, Dictionary`2& cmdlets, Dictionary`2& aliases, Dictionary`2& providers)\r\n   at System.Management.Automation.Runspaces.PSSnapInHelpers.AnalyzePSSnapInAssembly(Assembly assembly, String name, PSSnapInInfo psSnapInInfo, PSModuleInfo moduleInfo,\r\nDictionary`2& cmdlets, Dictionary`2& aliases, Dictionary`2& providers, String& helpFile)\r\n   at System.Management.Automation.Runspaces.InitialSessionState.ImportCmdletsFromAssembly(Assembly assembly, PSModuleInfo module)\r\n   at Microsoft.PowerShell.Commands.ModuleCmdletBase.LoadBinaryModule(PSModuleInfo parentModule, String moduleName, String fileName, Assembly assemblyToLoad, String\r\nmoduleBase, SessionState ss, ImportModuleOptions options, ManifestProcessingFlags manifestProcessingFlags, String prefix, Boolean loadTypes, Boolean loadFormats, Boolean&\r\nfound, String shortModuleName, Boolean disableFormatUpdates)\r\n   at Microsoft.PowerShell.Commands.ModuleCmdletBase.LoadModule(PSModuleInfo parentModule, String fileName, String moduleBase, String prefix, SessionState ss, Object\r\nprivateData, ImportModuleOptions& options, ManifestProcessingFlags manifestProcessingFlags, Boolean& found, Boolean& moduleFileFound)\r\n   at Microsoft.PowerShell.Commands.ImportModuleCommand.ImportModule_LocallyViaName(ImportModuleOptions importModuleOptions, String name)\r\n   at Microsoft.PowerShell.Commands.ImportModuleCommand.ImportModule_LocallyViaName_WithTelemetry(ImportModuleOptions importModuleOptions, String name)\r\n   at Microsoft.PowerShell.Commands.ImportModuleCommand.ProcessRecord()\r\n   at System.Management.Automation.CommandProcessor.ProcessRecord()\r\nCategoryInfo          : NotSpecified: (:) [Import-Module], TypeInitializationException\r\nFullyQualifiedErrorId : System.TypeInitializationException,Microsoft.PowerShell.Commands.ImportModuleCommand\r\nInvocationInfo        :\r\n    MyCommand        : Import-Module\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 1\r\n    HistoryId        : 3\r\n    Line             : Import-Module -Name '.\\MyModule.dll' -Verbose\r\n    PositionMessage  : At line:1 char:1\r\n                       + Import-Module -Name '.\\MyModule.dll' -Verbose\r\n                       + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    InvocationName   : Import-Module\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n```",
      "created_at": "2021-11-15T19:01:34Z",
      "updated_at": "2021-11-15T19:01:34Z"
    },
    {
      "author": "SeeminglyScience",
      "author_association": "COLLABORATOR",
      "body": "> `Could not load file or assembly 'TMCTools&, Culture=neutral, PublicKeyToken=null'. An attempt was made to load a program with an incorrect\r\nformat.`\r\n\r\nLooks like it's trying to load a native lib with the wrong target architecture (well, the error can mean other things but it's commonly this).  Can you verify that you installed 7.2 with the same bitness you installed 7.1.5?",
      "created_at": "2021-11-15T19:04:36Z",
      "updated_at": "2021-11-15T19:05:38Z"
    },
    {
      "author": "chscott",
      "author_association": "NONE",
      "body": "> Looks like it's trying to load a native lib with the wrong target architecture (well, the error can mean other things but it's commonly this). Can you verify that you installed 7.2 with the same bitness you installed 7.1.5?\r\n\r\nI'm alternating between installing these:\r\n\r\n- PowerShell-7.2.0-win-x64.msi\r\n- PowerShell-7.1.5-win-x64.msi\r\n",
      "created_at": "2021-11-15T19:09:55Z",
      "updated_at": "2021-11-15T19:09:55Z"
    },
    {
      "author": "SeeminglyScience",
      "author_association": "COLLABORATOR",
      "body": "Then it's probably something they need to fix. It's likely that their obfuscation relies on an implementation detail in how CLI metadata is loaded which may have changed.  Ah especially with a `Bad IL format.` error I didn't see at first glance.",
      "created_at": "2021-11-15T19:16:41Z",
      "updated_at": "2021-11-15T19:16:41Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "By looking at the code within ILSpy, the failure happens when the code tries to load a resource satellite assembly (`TMCTools&`) from the embedded resource stream of the module dll. The relevant code snippet is as follows:\r\n\r\n```c#\r\n// From BitmapDictionary.ClearTemplate()\r\nStream manifestResourceStream = executingAssembly.GetManifestResourceStream(text);\r\nbyte[] rawAssembly = ResourceTable.ClearTemplate(97L, manifestResourceStream);\r\nreturn Assembly.Load(rawAssembly);\r\n```\r\nSo yeah, it's likely the code depends on an implementation detail that may have changed in .NET 6, and the tool owner needs to investigate further. The weird thing is, `97L` is passed to `ResourceTable.ClearTemplate` but is never used anywhere in the actual implementation of that method.",
      "created_at": "2021-11-16T01:43:43Z",
      "updated_at": "2021-11-16T01:44:39Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This issue has been marked as external and has not had any activity for **1 day**. It has been be closed for housekeeping purposes.",
      "created_at": "2021-11-17T04:00:44Z",
      "updated_at": "2021-11-17T04:00:44Z"
    }
  ],
  "created_at": "2021-11-15T17:53:10Z",
  "labels": [
    "Issue-Question",
    "Resolution-External",
    "WG-DevEx-SDK"
  ],
  "number": 16474,
  "state": "closed",
  "title": "Unable to load binary module in 7.2.0",
  "updated_at": "2021-11-17T04:00:47Z"
}