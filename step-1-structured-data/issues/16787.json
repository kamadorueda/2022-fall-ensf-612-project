{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16787",
  "author": "Parshyaa",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nI am experiencing an issue while running Powershell 7.0 on my Rhel Docker image. \r\nI installed every required resources like, \r\n1) https://github.com/powershell/powershell\r\n        From this link I have downloaded powershell-7.2.1-rhel.x.x86_64.rpm. The main Powershell core rpm package bundle for linux.\r\nThis seams to work, as I am able to run Pwsh on my RHEL image.\r\n2) Installed https://github.com/Microsoft/omi/releases/tag/v1.6.0 for connecting to my Windows Exchange server for running powershell on remote server from RHEL to Windowes.\r\n3)https://github.com/PowerShell/psl-omi-provider\r\n\r\nbut when I run the New-PSSession in the PWSH, I get this error, \r\n\r\nPS /> New-PSSession \r\nFailed to create iconv, 22 \r\nNew-PSSession:             \r\nPS /> \r\n\r\nI searched on internet got none of the solution working.\r\n\r\nPlease if you have any information so that I would be able to run this on my RHEL server.\r\n\r\n\r\n\n\n### Expected behavior\n\n```console\nTo create a PSSession\n```\n\n\n### Actual behavior\n\n```console\nGets error, \r\nFailed to create iconv, 22\n```\n\n\n### Error details\n\n```console\nFailed to create iconv, 22\n```\n\n\n### Environment data\n\n```powershell\nPS /> $psversiontable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.1\r\nPSEdition                      Core\r\nGitCommitId                    7.2.1\r\nOS                             Linux 4.4.115-boot2docker #1 SMP Thu Feb 8 17:36:45 UTC 2018\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": "2022-04-07T17:27:59Z",
  "comments": [
    {
      "author": "kasini3000",
      "author_association": "NONE",
      "body": "from linux ,use omi ,to win, i have similar question.  https://github.com/PowerShell/PowerShell/discussions/16623\r\nmark\uff0cthe problem may not be resolved soon",
      "created_at": "2022-01-22T06:14:25Z",
      "updated_at": "2022-01-22T06:14:25Z"
    },
    {
      "author": "jborean93",
      "author_association": "COLLABORATOR",
      "body": "This error comes from psl-omi-provider at https://github.com/PowerShell/psl-omi-provider/blob/59ab42f3bc769b1aa31c1181e3a97ea3e1b1c96e/src/BufferManipulation.c#L35-L39. It would indicate there's a problem calling [iconv_open](https://man7.org/linux/man-pages/man3/iconv_open.3.html) and the error code it's returning is `22` meaning invalid argument. Looking further back this function is called with `UTF-16LE` and `UTF-8`. It seems like `iconv_open` does not support either of these character sets or maybe the combination of both for your setup.\r\n\r\nYou can replicate this same call in pwsh with\r\n\r\n```powershell\r\nAdd-Type -Namespace Native -Name Methods -MemberDefinition @'\r\n[DllImport(\"libc\", SetLastError = true)]\r\nprivate static extern IntPtr iconv_open(string tocode, string fromcode);\r\n\r\npublic static IntPtr IconvOpen(string to, string from)\r\n{\r\n    IntPtr res = iconv_open(to, from);\r\n    if (res == new IntPtr(-1))\r\n    {\r\n        var ex = new System.ComponentModel.Win32Exception();\r\n        \r\n        throw new Exception(String.Format(\"iconv_open error {0} - {1}\", ex.NativeErrorCode, ex.Message));\r\n    }\r\n    \r\n    return res;\r\n}\r\n'@\r\n\r\n[Native.Methods]::IconvOpen(\"UTF-16LE\", \"UTF-8\")\r\n[Native.Methods]::IconvOpen(\"UTF-8\", \"UTF-16LE2\")\r\n```\r\n\r\nIf either of those 2 calls to `iconv_open` fail it will display the errorno and message, in your case it will most likely be `22 - Invalid argument`. I cannot replicate this at all even on a blank `centos:8` container (both return valid pointers) so not sure what's actually happening on your host. One thing to check is the contents of `/usr/lib64/gconv` to see what it contains. I can see `UNICODE.so`, `UTF-16.so` in that folder. Unfortunately at this point I don't fully understand the behaviour of iconv but the problem for this particular issue lies there and that's where you should investigate further.\r\n\r\nJust as a side note, the fact that this function is being reached is usually an indication that the underlying MI library failed for some reason and it is trying to convert the error code from UTF-16-LE encoded bytes to UTF-8 for consumption. There are numerous issues with MI on Linux and the provided one from pwsh is mostly a best effort attempt but not really that great. You could try my fork https://github.com/jborean93/omi through the [PSWSMan](https://www.powershellgallery.com/packages/PSWSMan/2.3.0) module. This is not supported by MS in any way and is mostly my attempt to [solve the various problems](https://github.com/jborean93/omi#changes-from-upstream-omi) MI has on Linux in relation to PowerShell remoting. It also doesn't really change `psl-omi-provider` very much so if the same error is occurring with my fork you will most like still see this error.\n\n<blockquote><img src=\"https://opengraph.githubassets.com/9c2227a9bafacb92749a8ed279b31a2ca2e8e5cde57c8b3c078fa25c72e5517c/PowerShell/psl-omi-provider\" width=\"48\" align=\"right\"><div><img src=\"https://github.githubassets.com/favicons/favicon.svg\" height=\"14\"> GitHub</div><div><strong><a href=\"https://github.com/PowerShell/psl-omi-provider\">psl-omi-provider/BufferManipulation.c at 59ab42f3bc769b1aa31c1181e3a97ea3e1b1c96e \u00b7 PowerShell/psl-omi-provider</a></strong></div><div>PSRP Linux support library. Contribute to PowerShell/psl-omi-provider development by creating an account on GitHub.</div></blockquote>\n<blockquote><img src=\"https://opengraph.githubassets.com/17d1db716a0bcb6c993b53bdb256341fed6b28c06e0b8fc7bbcefabef0ddf024/jborean93/omi\" width=\"48\" align=\"right\"><div><img src=\"https://github.githubassets.com/favicons/favicon.svg\" height=\"14\"> GitHub</div><div><strong><a href=\"https://github.com/jborean93/omi\">GitHub - jborean93/omi: Open Management Infrastructure</a></strong></div><div>Open Management Infrastructure. Contribute to jborean93/omi development by creating an account on GitHub.</div></blockquote>",
      "created_at": "2022-01-22T23:12:40Z",
      "updated_at": "2022-01-22T23:12:42Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@WG-Remoting\r\nNew-PSSession is no longer supported on non-Windows platforms, because OMI is no longer supported (#15310).  We hope that the community will pick up support for this using the new Custom Remote Connections support (#16923).",
      "created_at": "2022-04-07T17:27:59Z",
      "updated_at": "2022-04-07T17:27:59Z"
    }
  ],
  "created_at": "2022-01-21T15:23:45Z",
  "labels": [
    "Resolution-Answered",
    "WG-Remoting"
  ],
  "number": 16787,
  "state": "closed",
  "title": "Getting error while running Powershell on Linux",
  "updated_at": "2022-04-07T17:28:14Z"
}