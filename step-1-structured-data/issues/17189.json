{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17189",
  "author": "m1k0net",
  "body": "This corrects an issue where the movement of objects in the array to be sorted where removing duplicate elements may result in a side effect of objects being out of order for a unique stable sort as seen in issue #16907.  \r\n\r\nThis can be reproduced with the below code\r\n```powershell\r\n$Record1=[PSCustomObject]@{Key=\"A\";Record=\"A1\"}\r\n$Record2=[PSCustomObject]@{Key=\"A\";Record=\"A2\"}\r\n$Record3=[PSCustomObject]@{Key=\"B\";Record=\"B1\"}\r\n$Record4=[PSCustomObject]@{Key=\"B\";Record=\"B2\"}\r\n$Records = @($Record1,$Record2,$Record3,$Record4)\r\n$results = $Records | Sort-Object -Stable -Unique -Property Key\r\n$results  | Format-Table\r\n```\r\n\r\nThis results in \r\n```\r\nKey Record\r\n--- ------\r\nA   A1\r\nB   B2\r\n```\r\n\r\nWhere the expected results is.\r\n```\r\nKey Record\r\n--- ------\r\nA   A1\r\nB   B1\r\n```\r\n\r\nThis problem occurs when a duplicate element in the array is found and then replaced with an element from the end.  In the example above causing record B2 to be put in place of A2.  After that, record B2 is treated as the first object for the unique selection despite the stable flag being set to retain the order.",
  "closed_at": "2022-04-26T23:58:37Z",
  "comments": [
    {
      "author": "microsoft-cla-retired[bot]",
      "author_association": "NONE",
      "body": "[![CLA assistant check](https://cla.opensource.microsoft.com/pull/badge/signed)](https://cla.opensource.microsoft.com/PowerShell/PowerShell?pullRequest=17189) <br/>All CLA requirements met.",
      "created_at": "2022-04-25T00:35:31Z",
      "updated_at": "2022-04-25T00:37:23Z"
    },
    {
      "author": "m1k0net",
      "author_association": "CONTRIBUTOR",
      "body": "> The PR description should include an example of the problem being addressed.\r\n\r\nI have included a new pester test in the PR which correctly fails due to the unique stable sort being broken.  The test case below when running the released versions will result in the record \"A2\" being overwrote with B2.  This results in B2 being before record B1 causing B2 to be returned and thus not being stable. \r\n\r\n```powershell\r\n\t\t\t$Record1=[PSCustomObject]@{Key=\"A\";Record=\"A1\"}\r\n\t\t\t$Record2=[PSCustomObject]@{Key=\"A\";Record=\"A2\"}\r\n\t\t\t$Record3=[PSCustomObject]@{Key=\"B\";Record=\"B1\"}\r\n\t\t\t$Record4=[PSCustomObject]@{Key=\"B\";Record=\"B2\"}\r\n\t\t\t$Records = @($Record1,$Record2,$Record3,$Record4)\r\n\t\t\t$results = $Records | Sort-Object -Stable -Unique -Property Key\r\n```\r\n\r\nI believe this will result in a performance regression compared to the current code (Stable Unique only) but since the current results may be incorrect I am not sure if that is a fair comparison.",
      "created_at": "2022-04-25T20:50:00Z",
      "updated_at": "2022-04-25T20:50:00Z"
    },
    {
      "author": "m1k0net",
      "author_association": "CONTRIBUTOR",
      "body": "I rewrote the logic to avoid the use of RemoveAt in favor of array manipulation.  I expect it to be more favorable when there are a large amount of duplicate elements since elements are only moved when there is not a duplicate.",
      "created_at": "2022-04-25T22:01:06Z",
      "updated_at": "2022-04-25T22:01:06Z"
    },
    {
      "author": "pull-request-quantifier[bot]",
      "author_association": "NONE",
      "body": "### ![](https://img.shields.io/static/v1?label=Quantified&message=Extra%20Small&color=green)\r\n\r\nThis PR has `19` quantified lines of changes. In general, a change size of upto `200` lines is ideal for the best PR experience!\r\n\r\n------\r\n\r\n<details >\r\n    <summary display=\"inline\"> <strong>Quantification details</strong></summary>\r\n    <p />\r\n\r\n```\r\nLabel      : Extra Small\r\nSize       : +14 -5\r\nPercentile : 7.6%\r\n\r\nTotal files changed: 2\r\n\r\nChange summary by file extension:\r\n.cs : +5 -5\r\n.ps1 : +9 -0\r\n```\r\n> Change counts above are quantified counts, based on the [PullRequestQuantifier customizations](https://github.com/microsoft/PullRequestQuantifier/blob/main/docs/prquantifier-yaml.md).\r\n    \r\n</details>\r\n\r\n\r\n<details>\r\n    <summary display=\"inline\"> <strong>Why proper sizing of changes matters</strong> </summary>\r\n    <p/>\r\n    <p/>\r\n\r\nOptimal pull request sizes drive a better predictable PR flow as they strike a\r\nbalance between between PR complexity and PR review overhead. PRs within the\r\noptimal size (typical small, or medium sized PRs) mean:\r\n\r\n- Fast and predictable releases to production:\r\n  - Optimal size changes are more likely to be reviewed faster with fewer\r\niterations.\r\n  - Similarity in low PR complexity drives similar review times.\r\n- Review quality is likely higher as complexity is lower:\r\n  - Bugs are more likely to be detected.\r\n  - Code inconsistencies are more likely to be detetcted.\r\n- Knowledge sharing is improved within the participants:\r\n  - Small portions can be assimilated better.\r\n- Better engineering practices are exercised:\r\n  - Solving big problems by dividing them in well contained, smaller problems.\r\n  - Exercising separation of concerns within the code changes.\r\n\r\n#### What can I do to optimize my changes\r\n\r\n- Use the PullRequestQuantifier to quantify your PR accurately\r\n  - Create a context profile for your repo using the [context generator](https://github.com/microsoft/PullRequestQuantifier/releases)\r\n  - Exclude files that are not necessary to be reviewed or do not increase the review complexity. Example: Autogenerated code, docs, project IDE setting files, binaries, etc. Check out the `Excluded` section from your `prquantifier.yaml` context profile. \r\n  - Understand your typical change complexity, drive towards the desired complexity by adjusting the label mapping in your `prquantifier.yaml` context profile.\r\n  - Only use the labels that matter to you, [see context specification](./docs/prquantifier-yaml.md) to customize your `prquantifier.yaml` context profile.\r\n- Change your engineering behaviors\r\n  - For PRs that fall outside of the desired spectrum, review the details and check if:\r\n    - Your PR could be split in smaller, self-contained PRs instead\r\n    - Your PR only solves one particular issue. (For example, don't refactor and code new features in the same PR).\r\n\r\n#### How to interpret the change counts in git diff output\r\n\r\n- One line was added: `+1 -0`\r\n- One line was deleted: `+0 -1`\r\n- One line was modified: `+1 -1` (git diff doesn't know about modified, it will\r\ninterpret that line like one addition plus one deletion)\r\n- Change percentiles: Change characteristics (addition, deletion, modification)\r\nof this PR in relation to all other PRs within the repository.\r\n\r\n</details>\r\n\r\n<p />\r\n\r\n------\r\n\r\nWas this comment helpful? <a href=\"https://pullrequestquantifierfeedback.azurewebsites.net/feedback?payload=eyJBdXRob3JOYW1lIjoibTFrMG5ldCIsIlJlcG9zaXRvcnlMaW5rIjoiaHR0cHM6Ly9naXRodWIuY29tL1Bvd2VyU2hlbGwvUG93ZXJTaGVsbCIsIlB1bGxSZXF1ZXN0TGluayI6Imh0dHBzOi8vZ2l0aHViLmNvbS9Qb3dlclNoZWxsL1Bvd2VyU2hlbGwvcHVsbC8xNzE4OSIsIkV2ZW50VHlwZSI6IlRodW1ic1VwIn0=&amp;anonymous=True\" target=\"_blank\" title=\"Thumbs up\"><strong>:thumbsup:</strong></a> <a href=\"https://pullrequestquantifierfeedback.azurewebsites.net/feedback?payload=eyJBdXRob3JOYW1lIjoibTFrMG5ldCIsIlJlcG9zaXRvcnlMaW5rIjoiaHR0cHM6Ly9naXRodWIuY29tL1Bvd2VyU2hlbGwvUG93ZXJTaGVsbCIsIlB1bGxSZXF1ZXN0TGluayI6Imh0dHBzOi8vZ2l0aHViLmNvbS9Qb3dlclNoZWxsL1Bvd2VyU2hlbGwvcHVsbC8xNzE4OSIsIkV2ZW50VHlwZSI6Ik5ldXRyYWwifQ==&amp;anonymous=True\" target=\"_blank\" title=\"Neutral\"><strong>&nbsp;:ok_hand:</strong></a> <a href=\"https://pullrequestquantifierfeedback.azurewebsites.net/feedback?payload=eyJBdXRob3JOYW1lIjoibTFrMG5ldCIsIlJlcG9zaXRvcnlMaW5rIjoiaHR0cHM6Ly9naXRodWIuY29tL1Bvd2VyU2hlbGwvUG93ZXJTaGVsbCIsIlB1bGxSZXF1ZXN0TGluayI6Imh0dHBzOi8vZ2l0aHViLmNvbS9Qb3dlclNoZWxsL1Bvd2VyU2hlbGwvcHVsbC8xNzE4OSIsIkV2ZW50VHlwZSI6IlRodW1ic0Rvd24ifQ==&amp;anonymous=True\" target=\"_blank\" title=\"Thumbs down\"><strong>&nbsp;:thumbsdown:</strong></a> (<a href=\"MAILTO:prquantifier@microsoft.com\" title=\"Mail to prquantifier@microsoft.com\">Email</a>)\r\n[Customize PullRequestQuantifier](https://github.com/PowerShell/PowerShell/blob/master/.github/prquantifier.yaml) for this repository.\r\n\r\n",
      "created_at": "2022-04-26T14:08:11Z",
      "updated_at": "2022-04-26T14:08:11Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@m1k0net It doesn't matter if tests include an example of the problem being solved, that is expected.  The PR is not well formed if it does not include a description of the problem, or a link to an issue that describes the problem:\r\n\r\n- repro steps\r\n- results\r\n- expected results\r\n\r\nPlease include this in the PR description.",
      "created_at": "2022-04-26T15:54:45Z",
      "updated_at": "2022-04-26T15:54:45Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.3.0-preview.4` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.3.0-preview.4)\n",
      "created_at": "2022-05-23T16:20:56Z",
      "updated_at": "2022-05-23T16:20:56Z"
    }
  ],
  "created_at": "2022-04-25T00:35:19Z",
  "number": 17189,
  "state": "closed",
  "title": "Fix Stable Unique sort not being stable",
  "updated_at": "2022-05-23T16:20:56Z"
}