{
  "_url": "https://github.com/PowerShell/PowerShell/issues/2822",
  "author": "iSazonov",
  "body": "Close #2138\r\n(Reference #2800)\r\n\r\n1. All updates left in one thread. (The use of multiple threads was the main problem previous PR #2640)\r\n\r\n2. The timer is only used to set up a update flag. (According to my tests calling Datetime.Now() and verifing the time delta creates a much larger delay)\r\n\r\n3. The timer interval is set to 200 ms. I test intervals from 50 ms to 2000 ms. I don't see any differences on the screen with 100 ms and 200 ms. So I chose the more cost-effective option. @lzybkr What do you think about this?\r\n\r\n4. Removed unnecessary locks and updates. `WriteProgress` is executed as quickly as possible, as a result the entire script executes significantly faster.\r\n\r\n5. Performance tests:\r\n\r\n```powershell\r\nMeasure-Command { 1..1e4 | % { Write-Progress \"...\" -PercentComplete ($_*100/1e4)} }\r\n```\r\nAfter:\r\n```\r\nDays              : 0\r\nHours             : 0\r\nMinutes           : 0\r\nSeconds           : 1\r\nMilliseconds      : 26\r\nTicks             : 10269198\r\nTotalDays         : 1.18856458333333E-05\r\nTotalHours        : 0.0002852555\r\nTotalMinutes      : 0.01711533\r\nTotalSeconds      : 1.0269198\r\nTotalMilliseconds : 1026.9198\r\n```\r\nBefore:\r\n```\r\nDays              : 0\r\nHours             : 0\r\nMinutes           : 0\r\nSeconds           : 30\r\nMilliseconds      : 697\r\nTicks             : 306978612\r\nTotalDays         : 0.000355299319444444\r\nTotalHours        : 0.00852718366666667\r\nTotalMinutes      : 0.51163102\r\nTotalSeconds      : 30.6978612\r\nTotalMilliseconds : 30697.8612\r\n```\r\n\r\n6. The two problems are not addressed this PR:\r\n6.1 `Hung`  or  `Freeze`  of a progress pane. If Write-Progress is not called very frequently user sees that the pane freeze.\r\n6.2 If Write-Progress frequently updates a progress pane and the script make output to console the user sees that the display flickers. The following script illustrates this:\r\n```powershell\r\n1..1e4 | % { $_;Write-Progress \"...\" -PercentComplete ($_*100/1e4)}\r\n```",
  "closed_at": "2017-03-17T21:14:18Z",
  "comments": [
    {
      "author": "mirichmo",
      "author_association": "MEMBER",
      "body": "@vors Do you have any additional comments or requests for this PR?",
      "created_at": "2017-02-09T02:14:05Z",
      "updated_at": "2017-02-09T02:14:05Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@daxian-dbw  did a lot of the previous PR. Maybe he will help here too.",
      "created_at": "2017-02-09T04:57:32Z",
      "updated_at": "2017-02-09T04:57:32Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "appveyor is in waiting very long - I am trying restart.",
      "created_at": "2017-03-14T06:50:49Z",
      "updated_at": "2017-03-14T06:50:49Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@daxian-dbw Could you please continue the review?",
      "created_at": "2017-03-15T04:38:18Z",
      "updated_at": "2017-03-15T04:38:18Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@iSazonov Sorry for the delay. I'm currently busy on something, will get back to this ASAP.",
      "created_at": "2017-03-15T16:52:11Z",
      "updated_at": "2017-03-15T16:52:11Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "> The two problems are not addressed this PR:\r\n1 Hung or Freeze of a progress pane. If Write-Progress is not called very frequently user sees that the pane freeze.\r\n2 If Write-Progress frequently updates a progress pane and the script make output to console the user sees that the display flickers. The following script illustrates this:\r\n\r\nThanks for pointing out these 2 remaining pieces. I will not focus on the potential Freeze issue in this PR. As long as we have an issue tracking it, we can postpone the fix until we know more about how bad it will freeze the progress pane after this fix.\r\nAs for the flicking issue, I think it's fine. We probably can mitigate the issue by setting the time inverval to be 100ms, but I'm not sure if we can notice the difference.",
      "created_at": "2017-03-16T20:02:09Z",
      "updated_at": "2017-03-16T20:36:33Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I didn't saw difference between 100 ms and 200 ms on my computer in previous PR so I leave 200 ms. In previous PR @lzybkr made the change from 200 ms to 100 ms.  If we take into account the slow and heavily loaded computers, the better 200 ms. When 500 ms notable artifacts appears.",
      "created_at": "2017-03-17T10:48:39Z",
      "updated_at": "2017-03-17T10:56:34Z"
    },
    {
      "author": "lzybkr",
      "author_association": "MEMBER",
      "body": "I changed to 100ms because my test (I forget what it was exactly) didn't feel very smooth despite there being steady progress.",
      "created_at": "2017-03-17T16:45:43Z",
      "updated_at": "2017-03-17T16:45:43Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@iSazonov Thank you for pushing it through!\r\nI will close #2138 as the performance issue has been fixed. But we still have 2 issues that need to be tracked:\r\n1. Hung or Freeze of a progress pane. If Write-Progress is not called very frequently user sees that the pane freeze.\r\n2. If Write-Progress frequently updates a progress pane and the script make output to console the user sees that the display flickers.\r\n\r\nDo you mind opening a new issue tracking these 2 potential problems? It's possible that they will rarely be noticed and will become a wont-fix issue, but it's still better to keep them somewhere.",
      "created_at": "2017-03-17T21:18:54Z",
      "updated_at": "2017-03-17T21:18:54Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I believe we should still include:\r\n> ResetProgress() - the finished pipeline will remove the progress bar still unfinished pipeline from another runspace. The problem is only if the second runspace doesn't update its progress bar long. It seems we can ignore this. \r\n\r\nI shall create new tracking Issue.\r\n",
      "created_at": "2017-03-18T10:37:24Z",
      "updated_at": "2017-03-18T10:37:24Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@daxian-dbw Thanks for great comments and help!!! \ud83e\udd47 ",
      "created_at": "2017-03-18T10:40:15Z",
      "updated_at": "2017-03-18T10:40:15Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@daxian-dbw Please comment:\r\n\r\nRecently cmdlets (web cmdlets) can potentially create hundreds of thousands of `ProgressRecord` objects.\r\nIt looks like undue load on GC.\r\nShould we open an issue on this too?",
      "created_at": "2017-03-18T11:10:49Z",
      "updated_at": "2017-03-18T11:10:49Z"
    },
    {
      "author": "lzybkr",
      "author_association": "MEMBER",
      "body": "@iSazonov - thanks for noticing. Feel free to open an issue any time you notice significant memory allocation - the fixes are often simple, and the improvements are often measurable.",
      "created_at": "2017-03-19T06:27:42Z",
      "updated_at": "2017-03-19T06:27:42Z"
    },
    {
      "author": "oising",
      "author_association": "CONTRIBUTOR",
      "body": "A question - does the interrupt write all progress records since the last rendered one, or just the last one issued during the interval? I know that there is no hard requirement that sequential percentage-based progress records are going to increment but if we're doing the former, I might question the value of this. It seems only important to not miss out the \"Complete\" marker record, but others might be safely skipped. Thoughts? I haven't seen this discussed in any other threads.\r\n\r\nUPDATE: Oh, never mind -- I'm having a slow day today as I try to get back into work that involves thinking again. Of course you're not doing this.",
      "created_at": "2017-03-24T19:43:14Z",
      "updated_at": "2017-03-24T19:56:18Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "We do not collect ProgressRecords, each next entry updates previous in \"cache\", then on timer expire we render the \"cache\" and write to a console.\r\nAnd yes, we always preserve \"Complete\" ProgressRecord.",
      "created_at": "2017-03-24T20:06:41Z",
      "updated_at": "2017-03-24T20:06:41Z"
    }
  ],
  "created_at": "2016-12-01T15:52:43Z",
  "number": 2822,
  "state": "closed",
  "title": "Improve a progress pane performance (one thread)",
  "updated_at": "2020-04-17T12:16:12Z"
}