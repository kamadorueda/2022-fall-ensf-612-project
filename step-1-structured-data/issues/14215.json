{
  "_url": "https://github.com/PowerShell/PowerShell/issues/14215",
  "author": "DesertBear",
  "body": "<!--\r\n\r\nFor Windows PowerShell 5.1 issues, suggestions, or feature requests please use the following link instead:\r\nWindows PowerShell [UserVoice](https://windowsserver.uservoice.com/forums/301869-powershell)\r\n\r\nThis repository is **ONLY** for PowerShell Core 6 and PowerShell 7+ issues.\r\n\r\n- Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- Search the existing issues.\r\n- Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- Refer to the [known issues](https://docs.microsoft.com/powershell/scripting/whats-new/known-issues-ps6).\r\n\r\n-->\r\n\r\n## Steps to reproduce\r\n\r\nPowerShell 7.1.0 (Microsoft Store Version) is blocked by Windows Firewall, despite having a valid firewall rule.\r\n\r\nBelow is an example of a blocked connection Event ID, which in this case is blocking a _Resolve-DnsName_ query to a Quad9 DNS server (UDP Port 53).\r\n\r\n```\r\nTimeCreated : 20/11/2020 21:12:08\r\nMessage     : The Windows Filtering Platform has blocked a connection.\r\n\r\n              Application Information:\r\n                Process ID:             8564\r\n                Application Name:       \\device\\harddiskvolume3\\program files\\windowsapps\\microsoft.powershell_7.1.0.0_x64__8wekyb3d8bbwe\\pwsh.exe\r\n\r\n              Network Information:\r\n                Direction:              Outbound\r\n                Source Address:         192.168.1.13\r\n                Source Port:            51596\r\n                Destination Address:    9.9.9.9\r\n                Destination Port:               53\r\n                Protocol:               17\r\n\r\n              Filter Information:\r\n                Filter Run-Time ID:     76293\r\n                Layer Name:             Connect\r\n                Layer Run-Time ID:      48\r\nId          : 5157\r\n```\r\n\r\n\r\nThere are three ways to add a firewall rule to Windows Firewall:\r\n\r\n**1)** By using the program exe path.  For example, by applying the firewall rule to the below program path.\r\n\r\n`%ProgramFiles%\\WindowsApps\\Microsoft.PowerShell_7.1.0.0_x64__8wekyb3d8bbwe\\pwsh.exe`\r\n\r\nAlthough this method _can_ be used for Microsoft Store apps, it's very rarely used because many store apps put a version number in the file path.  Having a version number in the file path is problematic because every time the store app is updated, the path changes and therefore the firewall rule becomes invalid and requires manual configuration.  If Windows Firewall is set to block outbound connections that do not match a rule using Group Policy firewall rules (which have priority over local (PersistentStore) firewall rules), then the application will be automatically blocked every time it updates.  Therefore, instead if using this method, the below two methods are used instead.\r\n\r\n**Screenshot A:**\r\n![Screenshot A](https://user-images.githubusercontent.com/27423064/99883284-6cbe8b80-2c1e-11eb-807c-4b6f8ecda1ab.png)\r\n\r\n\r\n**2)** By using the app package name.  For example, by applying the firewall rule to the below app package name.\r\n\r\n`microsoft.powershell_8wekyb3d8bbwe`\r\n\r\nThis is the usual method for Microsoft Store apps when using the Windows Firewall UI.\r\n\r\n**Screenshot B:**\r\n![Screenshot B](https://user-images.githubusercontent.com/27423064/99883287-75af5d00-2c1e-11eb-98c8-a3a1dd930a0c.png)\r\n\r\n\r\n**3)** By using the app package SID.  For example, by applying the firewall rule to the below app package SID.\r\n\r\n`S-1-15-2-3474344596-1361774275-169937050-1715369765-655753896-4292765343-1302149271`\r\n\r\nThis method can also be used for Microsoft Store apps when using the Windows Firewall UI, however the app package name would normally be used instead of this.  This method however, would be used when using PowerShell to add Windows Firewall rules (I.E. When using the _-Package_ parameter with _New-NetFirewallRule/Set-NetFirewallRule_).\r\n\r\n**Screenshot C:**\r\n![Screenshot C](https://user-images.githubusercontent.com/27423064/99883297-8d86e100-2c1e-11eb-87af-ebba96b90236.png)\r\n\r\n\r\nBelow is an example of the PowerShell firewall rule that Microsoft adds to Windows Firewall during the Microsoft Store Version installation, which uses an app package SID to apply the rule to the app package name.\r\n\r\n**Screenshot D:**\r\n![Screenshot D](https://user-images.githubusercontent.com/27423064/99883300-92e42b80-2c1e-11eb-9601-1328df36af90.png)\r\n\r\n\r\nHowever, despite using a valid firewall rule in Windows Firewall, PowerShell 7.1 (Microsoft Store Version) is blocked if Windows Firewall is set to block outbound connections that do not match a rule.  It makes no difference whether the firewall rule used is the one that Microsoft adds to Windows Firewall during installation, or whether it's a manually created firewall rule.  When manually creating a rule, it also makes no difference whether applying the rule to the app package name or to the app package SID.  Only using a direct path to the exe allows connections.\r\n\r\nTherefore, it appears as though the _microsoft.powershell_8wekyb3d8bbwe_ app package name doesn't correctly point to the pwsh.exe and is preventing the firewall rule from being applied to the application.\r\n\r\n## Expected behavior\r\n\r\nWhen using either the default Microsoft firewall rule, or creating a Group Policy firewall rule based on app package name or app package SID, the firewall rule should work as intended.\r\n\r\n## Environment data\r\n\r\n<!-- provide the output of $PSVersionTable -->\r\n\r\n```\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.0\r\nPSEdition                      Core\r\nGitCommitId                    7.1.0\r\nOS                             Microsoft Windows 10.0.19042\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\n```\r\n",
  "closed_at": null,
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "/cc @SteveL-MSFT for information.",
      "created_at": "2020-11-22T19:13:15Z",
      "updated_at": "2020-11-22T19:13:15Z"
    },
    {
      "author": "tonyg00",
      "author_association": "NONE",
      "body": "If you also add the File Path and executable name the rule will work as that is what the firewall uses.",
      "created_at": "2021-06-10T16:35:20Z",
      "updated_at": "2021-06-10T16:35:20Z"
    },
    {
      "author": "DesertBear",
      "author_association": "NONE",
      "body": "See item \"**1**\" in the original post.  \r\n\r\n> _\"\u2026many store apps put a version number in the file path. Having a version number in the file path is problematic because every time the store app is updated, the path changes and therefore the firewall rule becomes invalid and requires manual configuration.\"_\r\n\r\n\r\nPowershell 7 is one of those apps that has a version number in the file path.  I.E.\r\n\r\n`%ProgramFiles%\\WindowsApps\\Microsoft.PowerShell_7.1.0.0_x64__8wekyb3d8bbwe\\pwsh.exe`\r\n\r\nThis is why it's necessary to use an app package name instead (see item \"**2**\" in the original post), so that every time the app is updated, the firewall rule still continues to work.  However, \"app package name\" or \"app package SID\" do not work as expected \u2013 hence the post.\r\n\r\n",
      "created_at": "2021-12-14T14:24:08Z",
      "updated_at": "2021-12-14T14:24:08Z"
    }
  ],
  "created_at": "2020-11-21T17:45:35Z",
  "labels": [
    "Issue-Question",
    "Area-Maintainers-Build"
  ],
  "number": 14215,
  "state": "open",
  "title": "PowerShell 7.1 (Microsoft Store Version) is Blocked by Windows Firewall",
  "updated_at": "2021-12-14T14:24:08Z"
}