{
  "_url": "https://github.com/PowerShell/PowerShell/issues/9007",
  "author": "TylerLeonhardt",
  "body": "<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\nThis PR totally refactors the `Enter-PSHostProcess` tests.\r\n\r\nfixes #8971\r\n\r\n## PR Context\r\n\r\nThe biggest change was that rather then sharing an instance of PowerShell, the tests will each have their own instance of PowerShell to interact with.\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n- **Testing - New and feature**\r\n    - [ ] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [x] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [x] [Add `[feature]` to your commit messages if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n",
  "closed_at": "2019-03-11T17:41:07Z",
  "comments": [
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "Just to be sure, I'd like to run CI a few times to see if the failure shows up. I'm going to \ud83d\ude34but if someone in some other place (where it's not late) wants to kick them off again by adding commits or something, that'd be helpful!",
      "created_at": "2019-02-28T07:06:26Z",
      "updated_at": "2019-02-28T07:06:26Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I'd can restart but it is already failed :-(",
      "created_at": "2019-02-28T12:38:18Z",
      "updated_at": "2019-02-28T12:38:54Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "Jeez... OK... Ran this like 20 times in a container and couldn't repro the issue.\r\n\r\nBack to the drawing board... ",
      "created_at": "2019-02-28T14:47:45Z",
      "updated_at": "2019-02-28T14:47:45Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "I _can_ repro the same problem if I do this:\r\n\r\n```pwsh\r\n> \"Enter-PSHostProcess -Id 40328 -ErrorAction Stop\r\n                  `$pid\r\n                  Exit-PSHostProcess\" >  test.ps1\r\n\r\n> ./test.ps1\r\n```",
      "created_at": "2019-02-28T15:10:12Z",
      "updated_at": "2019-02-28T15:10:12Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Looks tricky!\r\nPerhaps @JamesWTruher has ideas how make the tests reliable. ",
      "created_at": "2019-02-28T15:16:37Z",
      "updated_at": "2019-02-28T15:16:37Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "The odd thing is... I added `-ErrorAction Stop` to the `Enter-PSHostProcess`'s so this this failure is even more peculiar because `$pid` should never get run. It should stop executing when `Enter-PSHostProcess` fails...\r\n\r\n```pwsh\r\n\"Enter-PSHostProcess -Id $($pwsh.Id) -ErrorAction Stop\r\n`$pid\r\nExit-PSHostProcess\" | pwsh -c - | Should -Be $pwsh.Id\r\n``` \r\n\r\n```\r\nTEST FAILURES\r\nDescription: Can enter, exit, and re-enter another PSHost\r\nName:        Enter-PSHostProcess tests.By Process Id.Can enter, exit, and re-enter another PSHost\r\nmessage:\r\nExpected 872, but got '1432'.\r\nstack-trace:\r\nat <ScriptBlock>, D:\\a\\1\\s\\test\\powershell\\Modules\\Microsoft.PowerShell.Core\\Enter-PSHostProcess.Tests.ps1: line 47\r\n47:                 Exit-PSHostProcess\" | pwsh -c - | Should -Be $pwsh.Id\r\n```\r\n\r\nIn my local testing... I noticed that:\r\n\r\n`Expected 872, but got '1432'.`\r\n\r\n1432 was typically the `$pid` of the `pwsh` that executed `Enter-PSHostProcess` but that could be a red herring ",
      "created_at": "2019-02-28T15:17:57Z",
      "updated_at": "2019-02-28T15:19:50Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@TylerLeonhardt Maybe #1995?",
      "created_at": "2019-02-28T15:24:06Z",
      "updated_at": "2019-02-28T15:24:06Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@TylerLeonhardt does this repro the issue?\r\n```powershell\r\n@'\r\ntry {{\r\n    Enter-PSHostProcess -Id {0} -ErrorAction Stop\r\n    $pid\r\n}}\r\nfinally {{\r\n    Exit-PSHostProcess\r\n}}\r\n'@ -f $pwsh.Id | pwsh -c - | Should -Be $pwsh.Id\r\n```\r\nIn other words, is the -ErrorAction Stop behaving as we expect?",
      "created_at": "2019-02-28T15:27:14Z",
      "updated_at": "2019-02-28T15:38:52Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "@iSazonov  Maybe... but I had 100% success rate from 20 runs on my mac and in an ubuntu container.\r\n\r\n@vexx32 I'm open to give that a try... the test should still fail, but maybe we'll get more info as to why (also edited your comment to escape the {})",
      "created_at": "2019-02-28T15:29:19Z",
      "updated_at": "2019-02-28T15:39:14Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@TylerLeonhardt I suggest replace \"-c\" with \"-file\" to avoid escaping problem.",
      "created_at": "2019-02-28T15:39:31Z",
      "updated_at": "2019-02-28T15:39:31Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "@iSazonov \r\n> I suggest replace \"-c\" with \"-file\" to avoid escaping problem.\r\n\r\nSorry, where exactly?",
      "created_at": "2019-02-28T16:07:40Z",
      "updated_at": "2019-02-28T16:07:40Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "jeez... \r\n\r\n```\r\nDescription: Can enter, exit, and re-enter another PSHost\r\nName:        Enter-PSHostProcess tests.By Process Id.Can enter, exit, and re-enter another PSHost\r\nmessage:\r\nExpected 4564, but got $null.\r\nstack-trace:\r\nat <ScriptBlock>, D:\\a\\1\\s\\test\\powershell\\Modules\\Microsoft.PowerShell.Core\\Enter-PSHostProcess.Tests.ps1: line 56\r\n56: '@ -f $pwsh.Id | pwsh -c - | Should -Be $pwsh.Id\r\nDescription: Can enter and exit another Windows PowerShell PSHost\r\nName:        Enter-PSHostProcess tests.By Process Id.Can enter and exit another Windows PowerShell PSHost\r\nmessage:\r\nExpected 3752, but got $null.\r\nstack-trace:\r\nat <ScriptBlock>, D:\\a\\1\\s\\test\\powershell\\Modules\\Microsoft.PowerShell.Core\\Enter-PSHostProcess.Tests.ps1: line 93\r\n93: '@ -f $powershell.Id | pwsh -c - | Should -Be $powershell.Id\r\nDescription: Can enter, exit, and re-enter using CustomPipeName\r\nName:        Enter-PSHostProcess tests.By CustomPipeName.Can enter, exit, and re-enter using CustomPipeName\r\nmessage:\r\nExpected 360, but got $null.\r\nstack-trace:\r\nat <ScriptBlock>, D:\\a\\1\\s\\test\\powershell\\Modules\\Microsoft.PowerShell.Core\\Enter-PSHostProcess.Tests.ps1: line 139\r\n139: '@ -f $pipeName | pwsh -c - | Should -Be $pwsh.Id\r\n3 tests in test/powershell failed\r\nAt D:\\a\\1\\s\\build.psm1:1371 char:13\r\n+             throw \"$($x.'test-results'.failures) tests in $TestArea f ...\r\n+             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : OperationStopped: (3 tests in test/powershell failed:String) [], RuntimeException\r\n    + FullyQualifiedErrorId : 3 tests in test/powershell failed\r\n```",
      "created_at": "2019-02-28T16:59:15Z",
      "updated_at": "2019-02-28T16:59:15Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "If this succeeds CI, please restart a few times. I need \ud83d\ude34\r\n\r\nIf this works, I'll need to add a test to `Startup.Tests.ps1` to test that `pwsh -CustomPipeName foo` actually works. And can move the last test into that as well.",
      "created_at": "2019-03-01T08:45:58Z",
      "updated_at": "2019-03-01T08:45:58Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "it... passed once so far. Triggered again with some comments... now time for bed.",
      "created_at": "2019-03-01T09:08:25Z",
      "updated_at": "2019-03-01T09:12:10Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "I restarted CI-windows as you ask (previous was Ok).",
      "created_at": "2019-03-01T12:07:04Z",
      "updated_at": "2019-03-01T12:07:04Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "It looks like we are in business.\r\n\r\nLet me clean up the PR, and I'll remove the WIP. \r\n\r\nI'm going to run the tests... 2 more times at least",
      "created_at": "2019-03-01T15:45:41Z",
      "updated_at": "2019-03-01T15:45:41Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "...",
      "created_at": "2019-03-01T17:34:05Z",
      "updated_at": "2019-03-01T17:34:05Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "I'm going to introduce some retry logic (5 times). I think I've made it fail less... But I'm guessing the container just doesn't have enough power to properly and quickly context switch between processes ",
      "created_at": "2019-03-01T17:47:59Z",
      "updated_at": "2019-03-01T17:47:59Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "Cc @SteveL-MSFT ",
      "created_at": "2019-03-01T17:48:17Z",
      "updated_at": "2019-03-01T17:48:17Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> I'm guessing the container just doesn't have enough power to properly and quickly context switch between processes\r\n\r\nIsn't you fan ZX Spectrum? \ud83d\ude04 ",
      "created_at": "2019-03-01T17:53:52Z",
      "updated_at": "2019-03-01T17:53:52Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "Ok retry plan has worked. Gonna add a few more incremental commits to add comments and trigger CI again.",
      "created_at": "2019-03-01T19:26:56Z",
      "updated_at": "2019-03-01T19:26:56Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "I've removed WIP. Please review.",
      "created_at": "2019-03-01T21:40:14Z",
      "updated_at": "2019-03-01T21:40:14Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@TylerLeonhardt \tCan you make your membership in the PowerShell Org public?",
      "created_at": "2019-03-03T23:23:38Z",
      "updated_at": "2019-03-03T23:23:38Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "@TravisEz13 how do I do that?",
      "created_at": "2019-03-04T08:19:19Z",
      "updated_at": "2019-03-04T08:19:19Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "Go to the [people page and search for yourself](https://github.com/orgs/PowerShell/people?utf8=\u2713&query=tyler) and you can make your membership public there.",
      "created_at": "2019-03-04T19:15:05Z",
      "updated_at": "2019-03-04T19:15:05Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "I spoke to @PaulHigin about this and we agreed that since the tests have been reliable in this PR, we'll keep them in. If they become a problem again, we can remove the ones that use `*-PSHostProcess`",
      "created_at": "2019-03-06T23:57:33Z",
      "updated_at": "2019-03-06T23:57:33Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@TylerLeonhardt - To fix the static analysis CI - update the link to https://www.itprotoday.com/powershell/powershell-basics-remote-management",
      "created_at": "2019-03-07T20:38:46Z",
      "updated_at": "2019-03-07T20:38:46Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "Restarted Windows CI",
      "created_at": "2019-03-07T20:39:32Z",
      "updated_at": "2019-03-07T20:39:32Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@TravisEz13 can you update your review?",
      "created_at": "2019-03-07T21:26:55Z",
      "updated_at": "2019-03-07T21:26:55Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@TylerLeonhardt Just realized the tests that were changed are tagged as `Feature`. Please push an empty commit with the commit message as `[Feature]` to execute those tests.",
      "created_at": "2019-03-07T23:23:29Z",
      "updated_at": "2019-03-07T23:23:29Z"
    },
    {
      "author": "TylerLeonhardt",
      "author_association": "MEMBER",
      "body": "triggered",
      "created_at": "2019-03-08T00:08:48Z",
      "updated_at": "2019-03-08T00:08:48Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "This has become unreliable again.  I have filed #11168",
      "created_at": "2019-11-22T22:17:13Z",
      "updated_at": "2019-11-22T22:17:13Z"
    }
  ],
  "created_at": "2019-02-28T07:04:23Z",
  "number": 9007,
  "state": "closed",
  "title": "Fix Enter-PSHostProcess tests flakiness",
  "updated_at": "2019-11-22T22:17:13Z"
}