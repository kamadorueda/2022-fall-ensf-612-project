{
  "_url": "https://github.com/PowerShell/PowerShell/issues/12099",
  "author": "vexx32",
  "body": "# PR Summary\r\n\r\nIn c64a28eaf19f0b97edffd53222430687f3c59823, the img tag regex was changed to `<img\\s+[^\\s>]*>` to avoid a DoS issue.\r\n\r\nThis regex will not match common image tags that contain more than just the `src` attribute (e.g., `<img src=\"$url\" class=\"className\"/>`\r\n\r\nFix is to adjust the regex to not preclude spaces after other content in the tag.\r\n\r\n## PR Context\r\n\r\nResolves #12089 \r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [x] None\r\n    - **OR**\r\n    - [ ] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n        - [ ] Experimental feature name(s): <!-- Experimental feature name(s) here -->\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n- **Testing - New and feature**\r\n    - [ ] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [ ] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [x] I have considered the user experience from a tooling perspective and enumerated concerns in the summary. This may include:\r\n        - Impact on [PowerShell Editor Services](https://github.com/PowerShell/PowerShellEditorServices) which is used in the [PowerShell extension](https://github.com/PowerShell/vscode-powershell) for VSCode (which runs in a different PS Host).\r\n        - Impact on Completions (both in the console and in editors) - one of PowerShell's most powerful features.\r\n        - Impact on [PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer) (which provides linting & formatting in the editor extensions).\r\n        - Impact on [EditorSyntax](https://github.com/PowerShell/EditorSyntax) (which provides syntax highlighting with in VSCode, GitHub, and many other editors).\r\n",
  "closed_at": "2020-03-24T17:51:56Z",
  "comments": [
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@PoshChan please retry macos",
      "created_at": "2020-03-11T02:26:24Z",
      "updated_at": "2020-03-11T02:26:24Z"
    },
    {
      "author": "PoshChan",
      "author_association": "COLLABORATOR",
      "body": "@vexx32, successfully started retry of `PowerShell-CI-macOS`",
      "created_at": "2020-03-11T02:26:39Z",
      "updated_at": "2020-03-11T02:26:39Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "We have 6 Regex in the file. It would nice to add tests. xUnit could be most stable.",
      "created_at": "2020-03-11T05:52:34Z",
      "updated_at": "2020-03-11T05:52:34Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "There are no existing tests except the test to verify the last change didn't regress.  We should add tests, but as this is regression, and we are early in 7.1, my question is have you manually tested it.\r\n\r\nBut to port it to 7.0, we need to add tests to cover at least a couple of cases.\r\n\r\nhere is the test I added:  https://github.com/PowerShell/PowerShell/blob/920b671fb41bdaa3cfc0ce030a41e81c4860d330/test/powershell/Modules/Microsoft.PowerShell.Utility/WebCmdlets.Tests.ps1#L1904",
      "created_at": "2020-03-11T18:44:35Z",
      "updated_at": "2020-03-11T18:44:35Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@TravisEz13 yep I manually tested it with [regex101](https://regex101.com/r/54mXuy/12). On a page that contains a bunch of images (literally just [a page about travel blogs](https://www.travelblog.org/) with a bunch of pictures), here's the breakdown:\r\n\r\n\"Pathological\" regex from the test: \r\n\r\n- 2ms\r\n- 25 matches\r\n- 1708 steps\r\n\r\nCurrently-used regex in the codebase:\r\n\r\n- ~1ms\r\n- No matches\r\n- 1683 steps\r\n\r\nProposed new regex in this PR:\r\n\r\n- 1ms\r\n- 25 matches\r\n- 1708 steps\r\n\r\nThere may be a more effective test case available, but I just grabbed the first thing I could think of \ud83d\ude05 ",
      "created_at": "2020-03-11T19:12:06Z",
      "updated_at": "2020-03-11T19:13:12Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "for it to be pathological, you need to test it with the pathological case (lots of spaces after `img`)... but there is a test case for that.",
      "created_at": "2020-03-11T21:31:55Z",
      "updated_at": "2020-03-11T21:32:33Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@vexx32  if you aren't planning on adding the cases, can you open an issue to add the cases and port both PR's back to 7.0 after the cases have been added.",
      "created_at": "2020-03-11T21:35:31Z",
      "updated_at": "2020-03-11T21:35:31Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "I don't mind adding the cases, but I'm not really clear on where / how these cases are defined (would I need to add something to that Get-WebListenerUrl function?), or exactly what additional cases you're looking to have added here? Tests for something like `<img$(\" \" * 5000)src=\"dummyimage.png\"$(\" \" * 5000)class=\"classname\"/>`?",
      "created_at": "2020-03-11T22:27:24Z",
      "updated_at": "2020-03-11T22:28:57Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "Is there a compliance analyzer tool for Regex?",
      "created_at": "2020-03-12T03:22:21Z",
      "updated_at": "2020-03-12T03:22:21Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@vexx32 I think @TravisEz13 says that we could add tests like existing one for rest 5 Regex.",
      "created_at": "2020-03-12T03:32:22Z",
      "updated_at": "2020-03-12T03:32:22Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@iSazonov we are supposed to use a tool in azure.  It's public, but to use it free, we are supposed to use an internal version.  To use it, we need a test case (or a few) where the content going to the regex is in a file (separate file per case).   The tool is basically and AI and will vary the content of the file until all codepaths have been hit.   \r\n\r\nI'd really appreciate if someone added a case like this.  We could remove the pathological test cases if we had cases like this and those cases are unreliable.",
      "created_at": "2020-03-12T16:49:04Z",
      "updated_at": "2020-03-12T16:51:58Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@vexx32  for this (https://github.com/PowerShell/PowerShell/pull/12099#issuecomment-597911344) new case, we don't need to add a large number of spaces.  ",
      "created_at": "2020-03-12T16:50:38Z",
      "updated_at": "2020-03-12T16:50:38Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@TravisEz13 Do you ask to create one HTML test file per Regex from this 5 Regex in the PR? Should it be full featured HTML page or simple string like\r\n `<img class=\"image a11y-hidden\" src=\"https://mc.yandex.ru/watch/723233\"/>`",
      "created_at": "2020-03-13T10:02:52Z",
      "updated_at": "2020-03-13T10:02:52Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@iSazonov \r\nThis is the tool:  https://www.microsoft.com/en-us/security-risk-detection/\r\nThe description of the requirement are here:\r\nhttps://docs.microsoft.com/en-us/security-risk-detection/concepts/seed-files\n\n<blockquote><div>Microsoft Security Risk Detection</div><div><strong><a href=\"https://www.microsoft.com/en-us/security-risk-detection/\">Microsoft Security Risk Detection</a></strong></div><div>Security Risk Detection is Microsoft's unique fuzz testing service for finding security critical bugs in software, helping customers quickly adopt practices and technology battle-tested at Microsoft.</div></blockquote>\n<blockquote><img src=\"https://docs.microsoft.com/en-us/media/logos/logo-ms-social.png\" width=\"48\" align=\"right\"><div><strong><a href=\"https://docs.microsoft.com/en-us/security-risk-detection/concepts/seed-files\">Seed Files</a></strong></div><div>Guidelines and best practices to choosing the corpus of seed files to maximize fuzzing efficiency and results</div></blockquote>",
      "created_at": "2020-03-13T18:13:46Z",
      "updated_at": "2020-03-13T18:13:48Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@TravisEz13 The docs say that we could have up to 1000 seed files. I think we could create a list of sites based on different engines, grab pages from them to use as seed files. I believe it will be more productive and native than manually create HTML files.",
      "created_at": "2020-03-13T19:49:32Z",
      "updated_at": "2020-03-13T19:49:32Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@iSazonov The tool may allow that, but during our testing internet access is disabled.  So, the test would fail. (It may not be that way today, but it will be in the future.). The whole purpose of this tool is that it does the variation so that you don't have to produce every input. \r\n\r\nSee https://en.wikipedia.org/wiki/Fuzzing\r\n",
      "created_at": "2020-03-16T17:12:21Z",
      "updated_at": "2020-03-16T17:13:29Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@TravisEz13 My suggestion is not to access Internet at test time. My suggestion is:\r\n- create a list of popular sites based on different templates (Sharepoint and so on)\r\n- download pages from the sites\r\n- use these downloaded static html pages in tests",
      "created_at": "2020-03-16T17:32:45Z",
      "updated_at": "2020-03-16T17:32:45Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@iSazonov in theory that works, but there are legal issues with that.  Sharepoint is fine, but the other sites we may need to get the sites permission.",
      "created_at": "2020-03-16T20:35:16Z",
      "updated_at": "2020-03-16T20:35:16Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "Opened #12138; feel free to continue that discussion there, as it doesn't look like this will be a simple decision of what tests to add for this PR. \ud83d\ude42 ",
      "created_at": "2020-03-16T21:42:21Z",
      "updated_at": "2020-03-16T21:42:21Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@vexx32 Can you add a test like you were suggesting here: https://github.com/PowerShell/PowerShell/pull/12099#issuecomment-597911344 minus the spaces (that's already covered)",
      "created_at": "2020-03-16T21:50:31Z",
      "updated_at": "2020-03-16T21:50:57Z"
    },
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "Happy to, but I'm not not clear on how cases are added here, as it looks like the content generation is handled elsewhere. Can you point me to where that is?",
      "created_at": "2020-03-16T22:04:55Z",
      "updated_at": "2020-03-16T22:04:55Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "Here is the commit where I added the last test case and tho WebListener \"Controller\" that the test cases uses: https://github.com/PowerShell/PowerShell/commit/c64a28eaf19f0b97edffd53222430687f3c59823",
      "created_at": "2020-03-16T22:29:53Z",
      "updated_at": "2020-03-16T22:29:53Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": ">  in theory that works, but there are legal issues with that. Sharepoint is fine, but the other sites we may need to get the sites permission.\r\n\r\n@TravisEz13 If I understand right you will make the tests internally so the site list will be not public. We are not going to change, share or distribute the pages. We are not going to download any artifacts like pictures - we need only html. We are not going to check these sites and distribute any information about it - we are going to test only that our code works correctly on the data.",
      "created_at": "2020-03-17T03:10:00Z",
      "updated_at": "2020-03-17T03:10:00Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "I used fixing a conflict in your PR to partially fix a mistake I made...   Brought a test back, but pended it.\r\nrelated to https://github.com/PowerShell/PowerShell/issues/12155",
      "created_at": "2020-03-23T20:22:42Z",
      "updated_at": "2020-03-23T20:23:55Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.1.0-preview.2` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.1.0-preview.2)\n",
      "created_at": "2020-04-23T18:03:14Z",
      "updated_at": "2020-04-23T18:03:14Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.0.1` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.0.1)\n",
      "created_at": "2020-05-14T22:52:51Z",
      "updated_at": "2020-05-14T22:52:51Z"
    }
  ],
  "created_at": "2020-03-11T01:10:40Z",
  "number": 12099,
  "state": "closed",
  "title": "Fix <img /> detection regex in web cmdlets",
  "updated_at": "2020-05-14T22:52:51Z"
}