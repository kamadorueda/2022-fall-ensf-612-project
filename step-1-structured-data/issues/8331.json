{
  "_url": "https://github.com/PowerShell/PowerShell/issues/8331",
  "author": "SteveL-MSFT",
  "body": "## PR Summary\r\n\r\nAssemblies  loaded on startup impact startup time.  Sometimes we merge a commit that uses a new type that adds loading a new assembly on startup.  We need to catch these and decide if it's worth the impact or delay loading when possible.  There's some in this list that appear like they can be delay loaded.\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` to the beginning of the title and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] User-facing [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed - Issue link:\r\n- **Testing - New and feature**\r\n    - [ ] Not Applicable or can only be tested interactively\r\n    - **OR**\r\n    - [x] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [ ] [Add `[feature]` if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n",
  "closed_at": "2018-12-06T02:14:59Z",
  "comments": [
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "seems that 'System.Collections.Immutable.dll' is still being loaded on startup",
      "created_at": "2018-12-05T01:48:12Z",
      "updated_at": "2018-12-05T01:48:12Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "'System.Security.Cryptography.Algorithms.dll' also is still being loaded",
      "created_at": "2018-12-05T02:05:20Z",
      "updated_at": "2018-12-05T02:05:20Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "'System.Security.Permissions.dll' is also being loaded on Windows",
      "created_at": "2018-12-05T19:00:30Z",
      "updated_at": "2018-12-05T19:00:30Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "`Add-Type` is the only place where immutable type is used. However, `immutable.dll` is loaded at startup even on my local Linux machine. There should be a dependency to it from .NET Core on Unix platforms.\r\n\r\nFor `System.Security.Cryptography.Algorithms.dll` and `System.Security.Permissions.dll` on Windows, I don't get them loaded locally. Let me take a look at what the CI does.",
      "created_at": "2018-12-05T20:51:07Z",
      "updated_at": "2018-12-05T20:51:07Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "@SteveL-MSFT The additional loaded assemblies are resulted by the [profile optimization configured in powershell](https://github.com/PowerShell/PowerShell/blob/50890b5ae7387a61f9a9c3fdfe3644997f5819c5/src/Microsoft.PowerShell.ConsoleHost/host/msh/ConsoleHost.cs#L247-L250). The file `StartupProfileData-NonInteractive` records assemblies that are potentially used right after powershell starts. With this file being available, powershell will eagerly load those assemblies using multiple CPU cores, even though some assemblies are not really needed for the current use case.\r\n\r\nI updated the tests, and also made a change to correct the folder to store the 'StartupProfileData' files.\r\nFor convenience, I will just close this PR and submit a new one. The new PR is #8406.",
      "created_at": "2018-12-06T02:14:59Z",
      "updated_at": "2018-12-06T02:23:57Z"
    }
  ],
  "created_at": "2018-11-22T07:40:05Z",
  "number": 8331,
  "state": "closed",
  "title": "Add test to validate loaded assemblies and libraries on startup",
  "updated_at": "2020-06-06T02:29:02Z"
}