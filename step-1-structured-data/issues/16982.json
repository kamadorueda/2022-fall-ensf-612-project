{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16982",
  "author": "yaamas",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\n```powershell\r\nNew-AzVM -ResourceGroupName $rg -Name vm-demo-06 -Image Win2016Datacenter -Size Standard_D2s_v3\r\n```\n\n### Expected behavior\n\n```console\nCreate VM\n```\n\n\n### Actual behavior\n\n```console\nPS /home/cloud> New-AzVM -ResourceGroupName $rg -Name vm-demo-06 -Image Win2016Datacenter -Size Standard_D2s_v3\r\n\r\ncmdlet New-AzVM at command pipeline position 1\r\nSupply values for the following parameters:\r\nCredential\r\nUser: test    \r\nPassword for user test: ********************\r\n\r\nNew-AzVM: 'VMCustomization' is not enabled for the Subscription. Please register the Subscription for 'Microsoft.Compute/VMCustomizationPreview' to use the feature.\n```\n\n\n### Error details\n\n```console\nPS /home/cloud> Get-Error                                                                                               \r\n\r\nException             : \r\n    Type       : Microsoft.Rest.Azure.CloudException\r\n    Request    : \r\n        Method     : PUT\r\n        RequestUri : https://management.azure.com/subscriptions/0f39574d-d756-48cf-b622-0e27a6943bd2/resourceGroups/1-4013897f-playground-sandbox/providers/Microsoft.Compute/virtualMachines/vm-demo-04?api-version=2021-11-01\r\n        Content    : {\r\n                     \"properties\": {\r\n                     \"hardwareProfile\": {\r\n                     \"vmSize\": \"Standard_D2s_v3\",\r\n                     \"vmSizeProperties\": {}\r\n                     },\r\n                     \"storageProfile\": {\r\n                     \"imageReference\": {\r\n                     \"publisher\": \"Canonical\",\r\n                     \"offer\": \"UbuntuServer\",\r\n                     \"sku\": \"16.04-LTS\",\r\n                     \"version\": \"latest\"\r\n                     }\r\n                     },\r\n                     \"additionalCapabilities\": {},\r\n                     \"osProfile\": {\r\n                     \"computerName\": \"vm-demo-04\",\r\n                     \"adminUsername\": \"cloud\",\r\n                     \"adminPassword\": \"U*6*#4U^&hw&a#7h8KG7\",\r\n                     \"linuxConfiguration\": {\r\n                     \"ssh\": {}\r\n                     }\r\n                     },\r\n                     \"networkProfile\": {\r\n                     \"networkInterfaces\": [\r\n                     {\r\n                     \"id\": \"/subscriptions/0f39574d-d756-48cf-b622-0e27a6943bd2/resourceGroups/1-4013897f-playground-sandbox/providers/Microsoft.Network/networkInterfaces/vm-demo-04\"\r\n                     }\r\n                     ]\r\n                     }\r\n                     },\r\n                     \"location\": \"southcentralus\"\r\n                     }\r\n        Headers    : \r\n            x-ms-client-request-id : 24f82e2a-373c-4b08-9048-20374548888f\r\n            Accept-Language : en-US\r\n            Authorization : \u2026\r\n            User-Agent : FxVersion/6.0.21.52210 OSName/Linux OSVersion/Linux.5.4.0.1072.azure.75.18.04.1.Ubuntu.SMP.Wed.Mar.2.14.41.08.UTC.2022 Microsoft.Azure.Management.Compute.ComputeManagementClient/52.0.0 AzurePowershell/v7.3.0 \r\nAz.Accounts/2.7.3 Az.Compute/4.24.0 PSVersion/v7.2.1 ps-cloud-shell/0.1.0 Az.Resources/5.4.0\r\n            CommandName : New-AzVM\r\n            ParameterSetName : SimpleParameterSet\r\n            Content-Type : application/json; charset=utf-8\r\n            Content-Length : 831\r\n\r\n    Response   : \r\n        StatusCode   : BadRequest\r\n        ReasonPhrase : Bad Request\r\n        Content      : {\r\n                       \"error\": {\r\n                       \"code\": \"BadRequest\",\r\n                       \"message\": \"'VMCustomization' is not enabled for the Subscription. Please register the Subscription for 'Microsoft.Compute/VMCustomizationPreview' to use the feature.\"\r\n                       }\r\n                       }\r\n        Headers      : \r\n            Cache-Control : no-cache\r\n            Pragma : no-cache\r\n            x-ms-ratelimit-remaining-resource : Microsoft.Compute/PutVM3Min;300,Microsoft.Compute/PutVM30Min;1503\r\n            Strict-Transport-Security : max-age=31536000; includeSubDomains\r\n            x-ms-request-id : c2f518ff-30c7-4cd7-b4f5-4501b71f023f\r\n            Server : Microsoft-HTTPAPI/2.0 Microsoft-HTTPAPI/2.0\r\n            x-ms-ratelimit-remaining-subscription-writes : 1199\r\n            x-ms-correlation-request-id : c7c1f4e9-eee0-4004-ae55-d7b2156cd911\r\n            x-ms-routing-request-id : WESTUS:20220309T224033Z:c7c1f4e9-eee0-4004-ae55-d7b2156cd911\r\n            X-Content-Type-Options : nosniff\r\n            Date : Wed, 09 Mar 2022 22:40:32 GMT\r\n            Content-Length : 223\r\n            Content-Type : application/json; charset=utf-8\r\n            Expires : -1\r\n\r\n    Body       : Microsoft.Rest.Azure.CloudError\r\n    RequestId  : c2f518ff-30c7-4cd7-b4f5-4501b71f023f\r\n    TargetSite : \r\n        Name          : Wait\r\n        DeclaringType : Microsoft.Azure.Commands.Common.Strategies.SyncTaskScheduler\r\n        MemberType    : Method\r\n        Module        : Microsoft.Azure.PowerShell.Strategies.dll\r\n    Message    : 'VMCustomization' is not enabled for the Subscription. Please register the Subscription for 'Microsoft.Compute/VMCustomizationPreview' to use the feature.\r\n    Data       : System.Collections.ListDictionaryInternal\r\n    Source     : Microsoft.Azure.PowerShell.Strategies\r\n    HResult    : -2146233088\r\n    StackTrace : \r\n   at Microsoft.Azure.Commands.Common.Strategies.SyncTaskScheduler.Wait(Task task, Action progressUpdate)\r\n   at Microsoft.Azure.Commands.Common.Strategies.AsyncCmdletExtensions.CmdletStartAndWait(ICmdlet cmdlet, Func`2 createAndStartTask)\r\n   at Microsoft.Azure.Commands.Compute.Strategies.AsyncCmdletExtensions.StartAndWait[T](T cmdlet, Func`2 createAndStartTask)\r\n   at Microsoft.Azure.Commands.Compute.NewAzureVMCommand.ExecuteCmdlet()\r\n   at Microsoft.WindowsAzure.Commands.Utilities.Common.CmdletExtensions.<>c__3`1.<ExecuteSynchronouslyOrAsJob>b__3_0(T c)\r\n   at Microsoft.WindowsAzure.Commands.Utilities.Common.CmdletExtensions.ExecuteSynchronouslyOrAsJob[T](T cmdlet, Action`1 executor)\r\n   at Microsoft.WindowsAzure.Commands.Utilities.Common.CmdletExtensions.ExecuteSynchronouslyOrAsJob[T](T cmdlet)\r\n   at Microsoft.WindowsAzure.Commands.Utilities.Common.AzurePSCmdlet.ProcessRecord()\r\nCategoryInfo          : CloseError: (:) [New-AzVM], CloudException\r\nFullyQualifiedErrorId : Microsoft.Azure.Commands.Compute.NewAzureVMCommand\r\nInvocationInfo        : \r\n    MyCommand        : New-AzVM\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 1\r\n    HistoryId        : 25\r\n    Line             : New-AzVM `\r\n                       \r\n    PositionMessage  : At line:1 char:1\r\n                       + New-AzVM `\r\n                       + ~~~~~~~~~~\r\n    InvocationName   : New-AzVM\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\nPipelineIterationInfo :\n```\n\n\n### Environment data\n\n```powershell\nPS /home/cloud> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.1\r\nPSEdition                      Core\r\nGitCommitId                    7.2.1\r\nOS                             Linux 5.4.0-1072-azure #75~18.04.1-Ubuntu SMP Wed Mar 2 14:41:08 UTC 2022\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\nRelated\r\nhttps://github.com/Azure/CloudShell/issues/147\r\nhttps://github.com/Azure/CloudShell/issues/145\r\nhttps://github.com/Azure/azure-cli/issues/21224",
  "closed_at": "2022-03-11T12:00:42Z",
  "comments": [
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "The module is not in the repository. Please use Azure feedback to report the issue.",
      "created_at": "2022-03-10T05:33:36Z",
      "updated_at": "2022-03-10T05:33:36Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This issue has been marked as answered and has not had any activity for **1 day**. It has been closed for housekeeping purposes.",
      "created_at": "2022-03-11T12:00:41Z",
      "updated_at": "2022-03-11T12:00:41Z"
    },
    {
      "author": "doctordns",
      "author_association": "COLLABORATOR",
      "body": "The clue is in the error message: **Please register the Subscription for 'Microsoft.Compute/VMCustomizationPreview' to use the feature**.\r\n\r\nTo fix this, you go to the total and register the subscription for the VMCustomization Previe.\r\n\r\nSometimes, error messages are really good. The trick is to read them first.\r\n\r\n",
      "created_at": "2022-03-11T12:26:02Z",
      "updated_at": "2022-03-11T12:26:02Z"
    }
  ],
  "created_at": "2022-03-09T23:24:45Z",
  "number": 16982,
  "state": "closed",
  "title": "[BUG] Az.Compute module's NewAz-VM cmdlet fails to create new vm - \"New-AzVM: 'VMCustomization' is not enabled for the Subscription\" Error",
  "updated_at": "2022-03-11T12:26:02Z"
}