{
  "_url": "https://github.com/PowerShell/PowerShell/issues/4529",
  "author": "PaulHigin",
  "body": "This change addresses issue #4475.\r\n\r\nWhen creating the SSH child process for remoting the KeyFilePath parameter path was enclosed in double quotes to handle potential space characters in the file path.  The problem was that the new SSH child process creation code was leaving the quote characters in the key filepath causing SSH to fail to find the key file.  In addition KeyFilePath paths with space characters were not being handled correctly.\r\n\r\nWith this change the KeyFilePath parameter now works as expected:\r\n```powershell\r\nPS > New-PSSession -HostName Machine1 -UserName User1 -KeyFilePath c:\\users\\User1\\Keys\\User1Key\r\n\r\nPS > New-PSSession -HostName Machine2 -UserName User2 -KeyFilePath \"c:\\users\\User2\\My Keys\\User2Key\"\r\n```\r\nThis worked correctly on Windows and only failed on Linux systems using the new SSH process creation code.\r\n\r\n---\r\nI also noticed and fixed a problem where trying to back out of a SSH remoting password prompt resulted in a hang (until the 1 minute protocol timeout occurred).\r\n```powershell\r\nPS > New-PSSession -HostName Machine1 -UserName User1\r\nUser1@Machine1's password:  \r\nCtrl+C\r\n```\r\nThe problem was that the client side connection did not end.  Fix is to add CloseAsync override to close the connection.",
  "closed_at": "2017-08-15T16:42:29Z",
  "comments": [
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@adityapatwardhan \r\nCan this be merged?  Thanks.",
      "created_at": "2017-08-14T15:51:42Z",
      "updated_at": "2017-08-14T15:51:42Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@PaulHigin Can we add tests for this?",
      "created_at": "2017-08-14T16:49:31Z",
      "updated_at": "2017-08-14T16:49:31Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "#3904 ",
      "created_at": "2017-08-14T18:10:57Z",
      "updated_at": "2017-08-14T18:10:57Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "Thanks!",
      "created_at": "2017-08-15T16:58:23Z",
      "updated_at": "2017-08-15T16:58:23Z"
    },
    {
      "author": "Hema-dell",
      "author_association": "NONE",
      "body": "HI ,\r\nI have installed PoSH6 and 7 on Windows 10 box, and PoSh6 on linux box, trying to do remote throush PsSession using -keyfilepath, followed instructions for ssh as provided in  https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse, after following the instructions and providing this command : New-PSSession -HostName root@x.x.x.x:22 -KeyFilePath C:\\Users\\dell\\.ssh\\authorized_keys  i get prompt for password , i have copied authorized_keys into ./ssh folder of linux box too!!! why is it prompting for password?\n\n<blockquote><div><strong><a href=\"https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse\">Installation of OpenSSH For Windows</a></strong></div></blockquote>",
      "created_at": "2020-01-13T06:32:54Z",
      "updated_at": "2020-01-13T06:32:56Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@Hema-dell  It sounds like your sshd_config configuration file still allows password authentication and should be disabled.  FYI, I have a module with 'Enable-SSHRemomting' cmdlet that I have been working on.  It is not been published by you can experiment with it if you like:\r\nhttps://gist.github.com/PaulHigin/b12b552b12dc4e8c940efe4f402e5362\r\n\r\nWe decided not to touch general SSH settings, and assume that the user has it set up as needed.  The 'Enable-SSHRemoting' cmdlet merely updates the sshd_config file with subsytem entry that becomes a PowerShell SSH remoting end point, so that the machine can receive connections.\n\n<blockquote><img src=\"https://github.githubassets.com/images/modules/gists/gist-og-image.png\" width=\"48\" align=\"right\"><div><img src=\"https://github.githubassets.com/favicon.ico\" height=\"14\"> Gist</div><div><strong><a href=\"https://gist.github.com/PaulHigin/b12b552b12dc4e8c940efe4f402e5362\">PSRemotingTools module</a></strong></div><div>PSRemotingTools module. GitHub Gist: instantly share code, notes, and snippets.</div></blockquote>",
      "created_at": "2020-01-13T17:09:25Z",
      "updated_at": "2020-01-13T17:09:27Z"
    },
    {
      "author": "Hema-dell",
      "author_association": "NONE",
      "body": "Hi Paul!!,\r\nI tried the above steps as shared in the link by you ,however i am still unable to do pssession using -keyfilepath parameter!!!!, Need your help on this!!!!.\r\n\r\nThanks,\r\nHema-dell",
      "created_at": "2020-01-14T10:22:44Z",
      "updated_at": "2020-01-14T10:22:44Z"
    }
  ],
  "created_at": "2017-08-08T21:24:19Z",
  "number": 4529,
  "state": "closed",
  "title": "Fixes SSH Remoting KeyFilePath Parameter",
  "updated_at": "2020-01-14T10:22:44Z"
}