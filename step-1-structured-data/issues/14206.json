{
  "_url": "https://github.com/PowerShell/PowerShell/issues/14206",
  "author": "13thirteen",
  "body": "\r\nI'm trying to create a root CA certificate with a `Name Constraints` extension (`2.5.29.30`) containing zero-length token values. Adding `DirectoryName=`, `Email=` and `URL=` in the `Excluded` subtree ensures that the certificate may not be used to sign certificates for any names of these types (i.e. wildcard blacklisting).\r\n\r\nUnfortunately, `New-SelfSignedCertificate` removes these zero-length token values and only keeps tokens with a non-zero-length value. Removal of `DirectoryName=`, `Email=` and `URL=` in the `Excluded` subtree loosens the constraints and allows signing of certificates for arbitrary names of these types.\r\n\r\n## Steps to reproduce\r\n\r\n```powershell\r\n $rootCACert = New-SelfSignedCertificate -Subject \"My CA\" -KeyUsage CertSign, CRLSign -TextExtension @(\"2.5.29.19={critical}{text}ca=true&pathlength=0\", \"2.5.29.30={critical}{text}subtree=Include&DNS=example.com&subtree=Exclude&DirectoryName=&Email=&IPAddress=0.0.0.0,0.0.0.0&IPAddress=0:0:0:0:0:0:0:0,0:0:0:0:0:0:0:0&URL=\")\r\n Export-Certificate -Cert $rootCACert -FilePath \"ca.crt\" -Type CERT\r\n```\r\n\r\n## Expected behavior\r\nCreates a certificate with the following `Name Constraints` value:\r\n\r\n![image](https://user-images.githubusercontent.com/20041328/99806539-7375d180-2b3e-11eb-8be7-d4bbf1d03609.png)\r\n\r\n```none\r\nPermitted\r\n     [1]Subtrees (0..Max):\r\n          DNS Name=example.com\r\nExcluded\r\n     [1]Subtrees (0..Max):\r\n          Directory Address\r\n     [2]Subtrees (0..Max):\r\n          RFC822 Name=\r\n     [3]Subtrees (0..Max):\r\n          IP Address=0.0.0.0\r\n          Mask=0.0.0.0\r\n     [4]Subtrees (0..Max):\r\n          IP Address=0000:0000:0000:0000:0000:0000:0000:0000\r\n          Mask=0000:0000:0000:0000:0000:0000:0000:0000\r\n     [5]Subtrees (0..Max):\r\n          URL=\r\n```\r\n\r\n\r\n## Actual behavior\r\nCreates a certificate with the following `Name Constraints` value:\r\n\r\n![image](https://user-images.githubusercontent.com/20041328/99806591-85f00b00-2b3e-11eb-8950-703b2e1cd6d1.png)\r\n\r\n```none\r\nPermitted\r\n     [1]Subtrees (0..Max):\r\n          DNS Name=example.com\r\nExcluded\r\n     [1]Subtrees (0..Max):\r\n          IP Address=0.0.0.0\r\n          Mask=0.0.0.0\r\n     [2]Subtrees (0..Max):\r\n          IP Address=0000:0000:0000:0000:0000:0000:0000:0000\r\n          Mask=0000:0000:0000:0000:0000:0000:0000:0000\r\n```\r\n\r\n## Environment data\r\n\r\n<!-- provide the output of $PSVersionTable -->\r\n\r\n```none\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.0\r\nPSEdition                      Core\r\nGitCommitId                    7.1.0\r\nOS                             Microsoft Windows 10.0.18363\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\n```\r\n\r\n## Further Information\r\n* [New-SelfSignedCertificate docs about Name Constraints](https://github.com/MicrosoftDocs/windows-powershell-docs/blob/master/docset/windows/pkiclient/New-SelfSignedCertificate.md#user-content--textextension)\r\n* [RFC 5280 - Section 4.2.1.10 Name Constraints](https://tools.ietf.org/html/rfc5280#section-4.2.1.10)\r\n* [CA/Browser Forum - Baseline Requirements - Section 7.1.5 Name constraints](https://cabforum.org/wp-content/uploads/CA-Browser-Forum-BR-1.7.3.pdf#page=78)\r\n\r\nTo use `openssl` to produce an equivalent root CA certificate with `Name Constraints` containing zero-length token values (as shown here in Expected behavior):\r\nCreate the following openssl config file `ca.cnf`:\r\n```none\r\n[req]\r\ndefault_bits = 2048\r\ndefault_md = sha256\r\nprompt = no\r\ndistinguished_name = req_distinguished_name\r\nx509_extensions = v3_ca\r\n\r\n[req_distinguished_name]\r\nCN = My CA\r\n\r\n[v3_ca]\r\nextendedKeyUsage = clientAuth, serverAuth\r\nsubjectKeyIdentifier = hash\r\nkeyUsage = critical, cRLSign, keyCertSign\r\nbasicConstraints = critical, CA:true, pathlen:0\r\nnameConstraints = critical,@name_constraints\r\n\r\n[name_constraints]\r\npermitted;DNS.0=example.com\r\nexcluded;dirName.0=exclude_dirname\r\nexcluded;email.0=\r\nexcluded;IP.0=0.0.0.0/0.0.0.0\r\nexcluded;IP.1=0:0:0:0:0:0:0:0/0:0:0:0:0:0:0:0\r\nexcluded;URI.0=\r\n\r\n[exclude_dirname]\r\n```\r\nand then run\r\n```none\r\nopenssl genrsa -out ca.key 2048\r\nopenssl req -x509 -new -nodes -key ca.key -sha256 -days 365 -out ca.crt -config localhost.cnf -extensions v3_ca -subj \"/CN=My CA\"\r\n```\r\n",
  "closed_at": "2021-01-21T07:40:28Z",
  "comments": [
    {
      "author": "13thirteen",
      "author_association": "NONE",
      "body": "Also created a Windows Server / Powershell / UserVoice bug report:\r\nhttps://windowsserver.uservoice.com/forums/301869-powershell/suggestions/42009115-bug-new-selfsignedcertificate-removes-zero-length\n\n<blockquote><img src=\"https://s3.amazonaws.com/uploads.uservoice.com/logo/design_setting/268950/original/WinServer_122x21_logoOnly.png?1430517494\" width=\"48\" align=\"right\"><div>Windows Server</div><div><strong><a href=\"https://windowsserver.uservoice.com/forums/301869-powershell/suggestions/42009115-bug-new-selfsignedcertificate-removes-zero-length\">Bug: New-SelfSignedCertificate removes zero-length Name Constraints</a></strong></div><div>I'm trying to create a root CA certificate with a `Name Constraints` extension (`2.5.29.30`) containing zero-length token values. Adding `DirectoryName=`, `Email=` and `URL=` in the `Excluded` subtree ensures that the certificate may not be used to sign certificates for any names of these types (i.e. wildcard blacklisting).\n\nUnfortunately, New-SelfSignedCertificate removes these zero-length token values and only keeps tokens with a non-zero-length value. Removal of `DirectoryName=`, `Email=` and `URL=` in the `Excluded` subtree loosens the constraints and allows signing of certificates for arbitrary names of these types.\n\nSee https://github.com/PowerShell/PowerShell/issues/14206 for details.</div></blockquote>",
      "created_at": "2020-11-20T17:26:07Z",
      "updated_at": "2020-11-20T17:26:10Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "The cmdlet is not in the repo so close.",
      "created_at": "2021-01-21T07:40:28Z",
      "updated_at": "2021-01-21T07:40:28Z"
    }
  ],
  "created_at": "2020-11-20T14:15:23Z",
  "number": 14206,
  "state": "closed",
  "title": "New-SelfSignedCertificate removes zero-length Name Constraints",
  "updated_at": "2021-01-21T07:40:28Z"
}