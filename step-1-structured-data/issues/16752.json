{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16752",
  "author": "MartinGC94",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nI found this on Twitter: https://twitter.com/pronichkin/status/1476063320822419458\r\nSteps:\r\n1. Try to run this: `Test-WSMan -ComputerName Whatever -CertificateThumbprint Whatever -Authentication ClientCertificate`\r\n2. Note the failure to bind CertificateThumbprint\r\n3. Move `CertificateThumbprint` so it's the last parameter, like this: `Test-WSMan -ComputerName Whatever -Authentication ClientCertificate -CertificateThumbprint Whatever` and try again\r\n4. Note how it succeeds\r\n\r\nThe issue appears to be that the setter for `CertificateThumbprint` does some validation and assumes other properties have been set when it is getting bound. This works fine for the other wsman cmdlets because their default value for AuthenticationMechanism is set to Default, but Test-Wsman uses None by default.\r\n\r\nThe check is done here: https://github.com/PowerShell/PowerShell/blob/master/src/Microsoft.WSMan.Management/WsManHelper.cs#L636\r\nThe default value is set here: https://github.com/PowerShell/PowerShell/blob/master/src/Microsoft.WSMan.Management/PingWSMan.cs#L90\n\n### Expected behavior\n\n```console\nThe cmdlet works regardless of the parameter binding order\n```\n\n\n### Actual behavior\n\n```console\nTest-WSMan: Cannot bind parameter 'CertificateThumbprint' to the target. Exception setting \"CertificateThumbprint\": \"A CertificateThumbPrint cannot be specified when None is specified.\"\n```\n\n\n### Error details\n\n```console\nPS C:\\Users\\Martin> Get-Error\r\n\r\nException             :\r\n    Type              : System.Management.Automation.ParameterBindingException\r\n    Message           : Cannot bind parameter 'CertificateThumbprint' to the target. Exception setting \"CertificateThumbprint\": \"A CertificateThumbPrint cannot be specified when None is specified.\"\r\n    ParameterName     : CertificateThumbprint\r\n    ParameterType     : string\r\n    TypeSpecified     : string\r\n    ErrorId           : ParameterBindingFailed\r\n    Line              : 1\r\n    Offset            : 58\r\n    CommandInvocation :\r\n        MyCommand        : Test-WSMan\r\n        BoundParameters  :\r\n            Comparer : System.OrdinalIgnoreCaseComparer\r\n            Count    : 1\r\n            Keys     :\r\n                Length : 12\r\n            Values   :\r\n                Length : 8\r\n            SyncRoot :\r\n                Comparer : System.OrdinalIgnoreCaseComparer\r\n                Count    : 1\r\n                Keys     :\r\n                    Length : 12\r\n                Values   :\r\n                    Length : 8\r\n                SyncRoot :\r\n                    Comparer : System.OrdinalIgnoreCaseComparer\r\n                    Count    : 1\r\n                    Keys     :\r\n                        Length : 12\r\n                    Values   :\r\n                        Length : 8\r\n                    SyncRoot :\r\n                        Comparer : System.OrdinalIgnoreCaseComparer\r\n                        Count    : 1\r\n                        Keys     :\r\n                            Length : 12\r\n                        Values   :\r\n                            Length : 8\r\n                        SyncRoot :\r\n                            Comparer : System.OrdinalIgnoreCaseComparer\r\n                            Count    : 1\r\n                            Keys     :\r\n                                Length : 12\r\n                            Values   :\r\n                                Length : 8\r\n                            SyncRoot :\r\n                                Comparer : System.OrdinalIgnoreCaseComparer\r\n                                Count    : 1\r\n                                Keys     :\r\n                                    Length : 12\r\n                                Values   :\r\n                                    Length : 8\r\n                                SyncRoot :\r\n                                    Comparer : System.OrdinalIgnoreCaseComparer\r\n                                    Count    : 1\r\n                                    Keys     : \u2026\r\n                                    Values   : \u2026\r\n                                    SyncRoot : \u2026\r\n        ScriptLineNumber : 1\r\n        OffsetInLine     : 1\r\n        HistoryId        : 1\r\n        Line             : Test-WSMan -ComputerName Whatever -CertificateThumbprint Whatever -Authentication ClientCertificate\r\n        PositionMessage  : At line:1 char:1\r\n                           + Test-WSMan -ComputerName Whatever -CertificateThumbprint Whatever -Au \u2026\r\n                           + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n        InvocationName   : Test-WSMan\r\n        PipelineLength   : 1\r\n        PipelinePosition : 1\r\n    ErrorRecord       :\r\n        Exception             :\r\n            Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n            Message : Cannot bind parameter 'CertificateThumbprint' to the target. Exception setting \"CertificateThumbprint\": \"A CertificateThumbPrint cannot be specified when None is specified.\"\r\n            HResult : -2146233087\r\n        CategoryInfo          : WriteError: (:) [Test-WSMan], ParentContainsErrorRecordException\r\n        FullyQualifiedErrorId : ParameterBindingFailed,Microsoft.WSMan.Management.TestWSManCommand\r\n        InvocationInfo        :\r\n            MyCommand        : Test-WSMan\r\n            ScriptLineNumber : 1\r\n            OffsetInLine     : 58\r\n            HistoryId        : 1\r\n            Line             : Test-WSMan -ComputerName Whatever -CertificateThumbprint Whatever -Authentication ClientCertificate\r\n            PositionMessage  : At line:1 char:58\r\n                               + \u2026 -WSMan -ComputerName Whatever -CertificateThumbprint Whatever -Authen \u2026\r\n                               +                                                        ~~~~~~~~\r\n            CommandOrigin    : Internal\r\n        ScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n    TargetSite        :\r\n        Name          : BindParameter\r\n        DeclaringType : System.Management.Automation.ParameterBinderBase, System.Management.Automation, Version=7.2.0.10, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n        MemberType    : Method\r\n        Module        : System.Management.Automation.dll\r\n    Data              : System.Collections.ListDictionaryInternal\r\n    InnerException    :\r\n        Type           : System.Management.Automation.SetValueInvocationException\r\n        ErrorRecord    :\r\n            Exception             :\r\n                Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n                Message : Exception setting \"CertificateThumbprint\": \"A CertificateThumbPrint cannot be specified when None is specified.\"\r\n                HResult : -2146233087\r\n            CategoryInfo          : NotSpecified: (:) [], ParentContainsErrorRecordException\r\n            FullyQualifiedErrorId : CatchFromBaseAdapterSetValue\r\n        TargetSite     :\r\n            Name          : BindParameter\r\n            DeclaringType : System.Management.Automation.ReflectionParameterBinder, System.Management.Automation, Version=7.2.0.10, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n            MemberType    : Method\r\n            Module        : System.Management.Automation.dll\r\n        Message        : Exception setting \"CertificateThumbprint\": \"A CertificateThumbPrint cannot be specified when None is specified.\"\r\n        InnerException :\r\n            Type       : System.InvalidOperationException\r\n            TargetSite :\r\n                Name          : ValidateSpecifiedAuthentication\r\n                DeclaringType : Microsoft.WSMan.Management.WSManHelper, Microsoft.WSMan.Management, Version=7.2.0.10, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n                MemberType    : Method\r\n                Module        : Microsoft.WSMan.Management.dll\r\n            Message    : A CertificateThumbPrint cannot be specified when None is specified.\r\n            Source     : Microsoft.WSMan.Management\r\n            HResult    : -2146233079\r\n            StackTrace :\r\n   at Microsoft.WSMan.Management.WSManHelper.ValidateSpecifiedAuthentication(AuthenticationMechanism authentication, PSCredential credential, String certificateThumbprint)\r\n   at Microsoft.WSMan.Management.AuthenticatingWSManCommand.ValidateSpecifiedAuthentication()\r\n   at Microsoft.WSMan.Management.AuthenticatingWSManCommand.set_CertificateThumbprint(String value)\r\n   at System.Management.Automation.ReflectionParameterBinder.BindParameter(String name, Object value, CompiledCommandParameter parameterMetadata)\r\n        Source         : System.Management.Automation\r\n        HResult        : -2146233087\r\n        StackTrace     :\r\n   at System.Management.Automation.ReflectionParameterBinder.BindParameter(String name, Object value, CompiledCommandParameter parameterMetadata)\r\n   at System.Management.Automation.ParameterBinderBase.BindParameter(CommandParameterInternal parameter, CompiledCommandParameter parameterMetadata, ParameterBindingFlags flags)\r\n    Source            : System.Management.Automation\r\n    HResult           : -2146233087\r\n    StackTrace        :\r\n   at System.Management.Automation.ParameterBinderBase.BindParameter(CommandParameterInternal parameter, CompiledCommandParameter parameterMetadata, ParameterBindingFlags flags)\r\n   at System.Management.Automation.CmdletParameterBinderController.BindParameter(CommandParameterInternal argument, MergedCompiledCommandParameter parameter, ParameterBindingFlags flags)\r\n   at System.Management.Automation.CmdletParameterBinderController.BindParameter(UInt32 parameterSets, CommandParameterInternal argument, MergedCompiledCommandParameter parameter, ParameterBindingFlags flags)\r\n   at System.Management.Automation.CmdletParameterBinderController.BindNamedParameter(UInt32 parameterSets, CommandParameterInternal argument, MergedCompiledCommandParameter parameter)\r\n   at System.Management.Automation.ParameterBinderController.BindNamedParameters(UInt32 parameterSets, Collection`1 arguments)\r\n   at System.Management.Automation.CmdletParameterBinderController.BindCommandLineParametersNoValidation(Collection`1 arguments)\r\n   at System.Management.Automation.CmdletParameterBinderController.BindCommandLineParameters(Collection`1 arguments)\r\n   at System.Management.Automation.CommandProcessor.BindCommandLineParameters()\r\n   at System.Management.Automation.CommandProcessor.Prepare(IDictionary psDefaultParameterValues)\r\n   at System.Management.Automation.CommandProcessorBase.DoPrepare(IDictionary psDefaultParameterValues)\r\n   at System.Management.Automation.Internal.PipelineProcessor.Start(Boolean incomingStream)\r\n   at System.Management.Automation.Internal.PipelineProcessor.SynchronousExecuteEnumerate(Object input)\r\n--- End of stack trace from previous location ---\r\n   at System.Management.Automation.Internal.PipelineProcessor.SynchronousExecuteEnumerate(Object input)\r\n   at System.Management.Automation.PipelineOps.InvokePipeline(Object input, Boolean ignoreInput, CommandParameterInternal[][] pipeElements, CommandBaseAst[] pipeElementAsts, CommandRedirection[][] commandRedirections, FunctionContext funcContext)\r\n   at System.Management.Automation.Interpreter.ActionCallInstruction`6.Run(InterpretedFrame frame)\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\r\nCategoryInfo          : WriteError: (:) [Test-WSMan], ParameterBindingException\r\nFullyQualifiedErrorId : ParameterBindingFailed,Microsoft.WSMan.Management.TestWSManCommand\r\nInvocationInfo        :\r\n    MyCommand        : Test-WSMan\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 58\r\n    HistoryId        : 1\r\n    Line             : Test-WSMan -ComputerName Whatever -CertificateThumbprint Whatever -Authentication ClientCertificate\r\n    PositionMessage  : At line:1 char:58\r\n                       + \u2026 -WSMan -ComputerName Whatever -CertificateThumbprint Whatever -Authen \u2026\r\n                       +                                                        ~~~~~~~~\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\n```\n\n\n### Environment data\n\n```powershell\nPS C:\\Users\\Martin> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.0-preview.10\r\nPSEdition                      Core\r\nGitCommitId                    7.2.0-preview.10\r\nOS                             Microsoft Windows 10.0.19044\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": null,
  "comments": [],
  "created_at": "2022-01-15T02:32:20Z",
  "number": 16752,
  "state": "open",
  "title": "Test-WSMan throws an error if you use parameters in the wrong order",
  "updated_at": "2022-01-15T06:45:28Z"
}