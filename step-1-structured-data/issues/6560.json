{
  "_url": "https://github.com/PowerShell/PowerShell/issues/6560",
  "author": "ffeldhaus",
  "body": "## PR Summary\r\n\r\nFix #6543 \r\n\r\nThe [HTTP RFC does not require a Location header to be present for redirects](https://tools.ietf.org/html/rfc7231#section-6.4), thus it is required to check if the Location header is returned before using it. This pull request adds a check for the Location header.\r\n\r\nA test has been implemented to ensure that the issue does not show up again.\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` to the beginning of the title and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [X] Not Applicable\r\n- **Testing - New and feature**\r\n    - [x] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [x] [Add `[feature]` if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n",
  "closed_at": "2018-04-08T12:51:18Z",
  "comments": [
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "Hi @ffeldhaus ! Can you please add a test for this for both `Invoke-WebRequest` and `Invoke-RestMethod` so we can ensure future changes don't cause a regression?\r\n\r\nAlso, for this PR, make sure you include `[feature]` in the commit messages to ensure the web cmdlet tests run.\r\n\r\nThanks!",
      "created_at": "2018-04-04T14:48:52Z",
      "updated_at": "2018-04-04T14:49:02Z"
    },
    {
      "author": "ffeldhaus",
      "author_association": "CONTRIBUTOR",
      "body": "Hi @markekraus thanks for the suggestion. I already fixed the initial commit, I should have tested it before submitting it. I now confirmed that the fix is working and committed the correct fix.\r\n\r\nI would like to add a test, but as far as I understand WebListener, it always returns the Location header for Redirects. What would be the best way to make WebListener not return the Location header? If you can help me with the WebListener, I'd be glad to commit a test for both Cmdlets.",
      "created_at": "2018-04-04T15:27:28Z",
      "updated_at": "2018-04-04T15:27:28Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@ffeldhaus Have a look at the `/Response/` endpoint https://github.com/PowerShell/PowerShell/tree/master/test/tools/WebListener#response \r\nYou can have it return a redirect code without a Location header.\r\n\r\nsomething like this\r\n\r\n```powershell\r\n$uri = Get-WebListenerUrl -Test Response -Query @{statuscode = 301}\r\n{ Invoke-WebRequest -uri $uri -Headers @{Authorization = 'foo'} -ErroractionStop } |\r\n    Should -Throw -ErrorId 'WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand'\r\n```",
      "created_at": "2018-04-04T17:11:28Z",
      "updated_at": "2018-04-04T17:11:28Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@ffeldhaus It looks like an unintentional change was made in your last commit that deleted an unrelated file. Can you please revert the file?",
      "created_at": "2018-04-04T21:45:51Z",
      "updated_at": "2018-04-04T21:45:51Z"
    },
    {
      "author": "ffeldhaus",
      "author_association": "CONTRIBUTOR",
      "body": "I changed the status code to int and are using -Match now isntead of -Be for checking the Exception message. The reason is, that the Exception Message contains the Status Code with a space, e.g. `Temporary Redirect` and not `TemporaryRedirect` which is provided in `$redirectTests`.\r\n\r\nThe tests are still failing because `$redirectTests` contains an entry `relative` which is not a valid Status Code. I'm not sure how to handle this. In my opinion it would be better to not include `relative` in the list of `$redirectTests` or at least separate it into Status Codes to test for redirect and an additional `relative` redirect test.",
      "created_at": "2018-04-05T20:04:00Z",
      "updated_at": "2018-04-05T20:04:00Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@ffeldhaus for the `relative` issue, you could do \r\n\r\n```powershell\r\n# Skip relative test as it is not a valid response type.\r\nif ($redirectType -eq 'relative'){ return }\r\n```\r\n\r\nFor the error message. I'm not certain we should even test it. Ideally, that message would be localized so it would fail in another language. I think the other tests are sufficient to show we are getting the error condition we desire and not the unrelated one.",
      "created_at": "2018-04-05T20:44:19Z",
      "updated_at": "2018-04-05T20:44:19Z"
    },
    {
      "author": "ffeldhaus",
      "author_association": "CONTRIBUTOR",
      "body": "@markekraus Thanks for all the help! I'm a bit annoyed at myself for doing quite a few mistakes in such an easy fix and that you basically had to tell me what to do. For the next time, I hope I'm now better equipped to make a change.\r\n\r\nI think the pull request should be good to merge now.",
      "created_at": "2018-04-05T21:34:16Z",
      "updated_at": "2018-04-05T21:34:16Z"
    },
    {
      "author": "markekraus",
      "author_association": "CONTRIBUTOR",
      "body": "@ffeldhaus No worries! I should have provided clearer guidance in the Issue too prior to your PR. Also, making use of the WebListener isn't as straight forward as I'd like \ud83d\ude06 \r\n\r\nJust one more request to better comment in the tests why we are doing this and I'll be ready to approve.",
      "created_at": "2018-04-06T00:20:56Z",
      "updated_at": "2018-04-06T00:20:56Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "LGTM, assuming tests pass",
      "created_at": "2018-04-07T20:47:40Z",
      "updated_at": "2018-04-07T20:48:04Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@ffeldhaus Thanks for your contribution! Welcome back with new ones!",
      "created_at": "2018-04-08T12:52:20Z",
      "updated_at": "2018-04-08T12:52:20Z"
    }
  ],
  "created_at": "2018-04-04T14:23:33Z",
  "number": 6560,
  "state": "closed",
  "title": "Added check for existence of Location HTTP header before using it",
  "updated_at": "2018-04-08T12:52:20Z"
}