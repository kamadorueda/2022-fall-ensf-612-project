{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17052",
  "author": "nExoRek",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\n- include custom module with '#requires -module <name>' \r\n- run script\n\n### Expected behavior\n\n```console\nscript run flawlessly\n```\n\n\n### Actual behavior\n\n```console\nif run for the for the first time, error is cast and module fails:\r\n.\\manage-azure.ps1: The script 'manage-azure.ps1' cannot be run because the following modules that are specified by the \"#requires\" statements of the script are missing: eNLib.\r\n\r\nif run the same script for the second time - it runs as expected. similarly if i load module with import-module - all works fine. this is globally installed module:\r\nC:\\ :))o- get-module enlib |select path\r\n\r\nPath\r\n----\r\nC:\\Program Files\\WindowsPowerShell\\Modules\\eNLib\\1.3.21\\eNLib.psm1\r\n\r\ni've installed PS7 recently - there is no issues with PS5\n```\n\n\n### Error details\n\n```console\nException             :\r\n    Type             : System.Management.Automation.ScriptRequiresException\r\n    CommandName      : manage-azure.ps1\r\n    MissingPSSnapIns :\r\n        Length : 5\r\n    ErrorRecord      :\r\n        Exception             :\r\n            Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n            Message : The script 'manage-azure.ps1' cannot be run because the following modules that are specified by the \"#requires\"\r\nstatements of the script are missing: eNLib.\r\n            HResult : -2146233087\r\n        TargetObject          : manage-azure.ps1\r\n        CategoryInfo          : ResourceUnavailable: (manage-azure.ps1:String) [], ParentContainsErrorRecordException\r\n        FullyQualifiedErrorId : ScriptRequiresMissingModules\r\n        InvocationInfo        :\r\n            ScriptLineNumber : 1\r\n            OffsetInLine     : 1\r\n            HistoryId        : 1\r\n            Line             : .\\manage-azure.ps1\r\n            PositionMessage  : At line:1 char:1\r\n                               + .\\manage-azure.ps1\r\n                               + ~~~~~~~~~~~~~~~~~~\r\n            InvocationName   : .\\manage-azure.ps1\r\n            CommandOrigin    : Internal\r\n        ScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n    TargetSite       :\r\n        Name          : VerifyRequiredModules\r\n        DeclaringType : System.Management.Automation.CommandDiscovery, System.Management.Automation, Version=7.2.2.500, Culture=neutral,\r\nPublicKeyToken=31bf3856ad364e35\r\n        MemberType    : Method\r\n        Module        : System.Management.Automation.dll\r\n    Message          : The script 'manage-azure.ps1' cannot be run because the following modules that are specified by the \"#requires\"\r\nstatements of the script are missing: eNLib.\r\n    Data             : System.Collections.ListDictionaryInternal\r\n    Source           : System.Management.Automation\r\n    HResult          : -2146233087\r\n    StackTrace       :\r\n   at System.Management.Automation.CommandDiscovery.VerifyRequiredModules(ExternalScriptInfo scriptInfo, ExecutionContext context)\r\n   at System.Management.Automation.CommandDiscovery.VerifyScriptRequirements(ExternalScriptInfo scriptInfo, ExecutionContext context)\r\n   at System.Management.Automation.CommandDiscovery.CreateScriptProcessorForSingleShell(ExternalScriptInfo scriptInfo, ExecutionContext\r\ncontext, Boolean useLocalScope, SessionStateInternal sessionState)\r\n   at System.Management.Automation.CommandDiscovery.LookupCommandProcessor(CommandInfo commandInfo, CommandOrigin commandOrigin,\r\nNullable`1 useLocalScope, SessionStateInternal sessionState)\r\n   at System.Management.Automation.CommandDiscovery.LookupCommandProcessor(String commandName, CommandOrigin commandOrigin, Nullable`1\r\nuseLocalScope)\r\n   at System.Management.Automation.ExecutionContext.CreateCommand(String command, Boolean dotSource)\r\n   at System.Management.Automation.PipelineOps.AddCommand(PipelineProcessor pipe, CommandParameterInternal[] commandElements,\r\nCommandBaseAst commandBaseAst, CommandRedirection[] redirections, ExecutionContext context)\r\n   at System.Management.Automation.PipelineOps.InvokePipeline(Object input, Boolean ignoreInput, CommandParameterInternal[][]\r\npipeElements, CommandBaseAst[] pipeElementAsts, CommandRedirection[][] commandRedirections, FunctionContext funcContext)\r\n   at System.Management.Automation.Interpreter.ActionCallInstruction`6.Run(InterpretedFrame frame)\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\r\nTargetObject          : manage-azure.ps1\r\nCategoryInfo          : ResourceUnavailable: (manage-azure.ps1:String) [], ScriptRequiresException\r\nFullyQualifiedErrorId : ScriptRequiresMissingModules\r\nInvocationInfo        :\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 1\r\n    HistoryId        : 1\r\n    Line             : .\\manage-azure.ps1\r\n    PositionMessage  : At line:1 char:1\r\n                       + .\\manage-azure.ps1\r\n                       + ~~~~~~~~~~~~~~~~~~\r\n    InvocationName   : .\\manage-azure.ps1\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\n```\n\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.2\r\nPSEdition                      Core\r\nGitCommitId                    7.2.2\r\nOS                             Microsoft Windows 10.0.17763\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": null,
  "comments": [
    {
      "author": "kasini3000",
      "author_association": "NONE",
      "body": "powershell 7 \u2018s  $env:psmodulepath    is  different with powershell v5 .\r\ntry 'C:\\Program Files\\PowerShell\\Modules' if you sure it work. ",
      "created_at": "2022-03-24T11:14:02Z",
      "updated_at": "2022-03-24T11:14:02Z"
    },
    {
      "author": "nExoRek",
      "author_association": "NONE",
      "body": "thx for a hint but it shouldn't matter. both paths are in the variable:\r\nC:\\Users\\myuser\\Documents\\PowerShell\\Modules;C:\\Program Files\\PowerShell\\Modules;c:\\program files\\powershell\\7\\Modules;**C:\\Program Files\\WindowsPowerShell\\Modules**;C:\\windows\\system32\\WindowsPowerShell\\v1.0\\Modules;C:\\Program Files\\Microsoft Monitoring Agent\\Agent\\PowerShell\\\r\n\r\nand the fact that module is not found only with first run after launching the console, moreover - not always. sometimes it works, but in majority of cases it thorws an error. to me it looks like there was some very short timeout when PS is looking for modules. ",
      "created_at": "2022-03-24T12:42:02Z",
      "updated_at": "2022-03-24T12:43:33Z"
    }
  ],
  "created_at": "2022-03-23T17:12:09Z",
  "labels": [
    "Issue-Question",
    "WG-Engine",
    "Needs-Triage"
  ],
  "number": 17052,
  "state": "open",
  "title": "'#requires' not finding module with first run",
  "updated_at": "2022-03-24T12:43:33Z"
}