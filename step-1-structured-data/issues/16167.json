{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16167",
  "author": "lumarel",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nWrite a script, in which the `#Requires -Modules` statement is used. This example reflects the usage how I was made aware of this issue:\r\n```powershell\r\n#Requires -Modules VMware.VimAutomation.Core, ActiveDirectory\r\n\r\nConnect-VIServer vcenter.local\r\n\r\nGet-ADUser -Filter *\r\n```\r\n\r\nThe modules are installed and the CmdLets are working if used manually:\r\n```powershell\r\nPS C:\\> Get-Module VMware.VimAutomation.Core\r\n\r\nModuleType Version    PreRelease Name                                ExportedCommands\r\n---------- -------    ---------- ----                                ----------------\r\nScript     12.0.0.15\u2026            VMware.VimAutomation.Core           {Add-PassthroughD...}\r\n```\r\n```powershell\r\nPS C:\\> Get-Module ActiveDirectory\r\n\r\nModuleType Version    PreRelease Name                                ExportedCommands\r\n---------- -------    ---------- ----                                ----------------\r\nScript     1.0                   ActiveDirectory                     {Add-ADCentralAcce...}\r\n```\r\n\r\nThe `VMware.PowerCLI` module is installed directly as a Core module, the `ActiveDirectory` module uses the implicit remoting functionality and uses PowerShell 5.1\r\nThe problem with the directly loaded Core modules only happens if the script is launched via the VSCode `PowerShell Integrated Console` (with the installed PowerShell extension), the implicit remoting in every shell.\r\n\r\nTo get the 2nd error message I ran `Get-Module VMware.VimAutomation.Core` once to load the module.\r\n\r\nI hope this is enough information, if more is needed I will gladly provide it!\n\n### Expected behavior\n\n```console\nConnection to vCenter and output of all Users in the AD.\n```\n\n\n### Actual behavior\n\n```console\nResourceUnavailable: The script 'snapshot-alert.ps1' cannot be run because the following modules that are specified by the \"#requires\" statements of the script are missing: VMware.VimAutomation.Core.\r\n\r\nResourceUnavailable: The script 'snapshot-alert.ps1' cannot be run because the following modules that are specified by the \"#requires\" statements of the script are missing: ActiveDirectory.\n```\n\n\n### Error details\n\n```console\nType             : System.Management.Automation.ScriptRequiresException\r\nCommandName      : snapshot-alert.ps1\r\nMissingPSSnapIns : \r\n    Length : 25\r\nErrorRecord      : \r\n    Exception             : \r\n        Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n        Message : The script 'snapshot-alert.ps1' cannot be run because the following modules that are specified by the \"#requires\" statements of the script are missing: VMware.VimAutomation.Core.\r\n        HResult : -2146233087\r\n    TargetObject          : snapshot-alert.ps1\r\n    CategoryInfo          : ResourceUnavailable: (snapshot-alert.ps1:String) [], ParentContainsErrorRecordException\r\n    FullyQualifiedErrorId : ScriptRequiresMissingModules\r\nTargetSite       : \r\n    Name          : Invoke\r\n    DeclaringType : System.Management.Automation.Runspaces.PipelineBase, System.Management.Automation, Version=7.1.4.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n    MemberType    : Method\r\n    Module        : System.Management.Automation.dll\r\nStackTrace       : \r\n   at System.Management.Automation.Runspaces.PipelineBase.Invoke(IEnumerable input)\r\n   at System.Management.Automation.PowerShell.Worker.ConstructPipelineAndDoWork(Runspace rs, Boolean performSyncInvoke)\r\n   at System.Management.Automation.PowerShell.Worker.CreateRunspaceIfNeededAndDoWork(Runspace rsToUse, Boolean isSync)\r\n   at System.Management.Automation.PowerShell.CoreInvokeHelper[TInput,TOutput](PSDataCollection`1 input, PSDataCollection`1 output, PSInvocationSettings settings)\r\n   at System.Management.Automation.PowerShell.CoreInvoke[TInput,TOutput](PSDataCollection`1 input, PSDataCollection`1 output, PSInvocationSettings settings)\r\n   at System.Management.Automation.PowerShell.Invoke[T](IEnumerable input, PSInvocationSettings settings)\r\n   at Microsoft.PowerShell.EditorServices.Services.PowerShellContextService.<>c__DisplayClass93_0`1.<ExecuteCommandAsync>b__0() in D:\\a\\1\\s\\src\\PowerShellEditorServices\\Services\\PowerShellContext\\PowerShellContextService.cs:line 773\r\n   at System.Threading.Tasks.Task`1.InnerInvoke()\r\n   at System.Threading.ExecutionContext.RunFromThreadPoolDispatchLoop(Thread threadPoolThread, ExecutionContext executionContext, ContextCallback callback, Object state)\r\n--- End of stack trace from previous location ---\r\n   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.PowerShell.EditorServices.Services.PowerShellContextService.ExecuteCommandAsync[TResult](PSCommand psCommand, StringBuilder errorMessages, ExecutionOptions executionOptions, CancellationToken cancellationToken) in\r\nD:\\a\\1\\s\\src\\PowerShellEditorServices\\Services\\PowerShellContext\\PowerShellContextService.cs:line 772\r\n   at Microsoft.PowerShell.EditorServices.Services.PowerShellContextService.ExecuteCommandAsync[TResult](PSCommand psCommand, StringBuilder errorMessages, ExecutionOptions executionOptions, CancellationToken cancellationToken) in\r\nD:\\a\\1\\s\\src\\PowerShellEditorServices\\Services\\PowerShellContext\\PowerShellContextService.cs:line 830\r\nMessage          : The script 'snapshot-alert.ps1' cannot be run because the following modules that are specified by the \"#requires\" statements of the script are missing: VMware.VimAutomation.Core.\r\nSource           : System.Management.Automation\r\nHResult          : -2146233087\r\n\r\n\r\nType             : System.Management.Automation.ScriptRequiresException\r\nCommandName      : snapshot-alert.ps1\r\nMissingPSSnapIns : \r\n    Length : 15\r\nErrorRecord      : \r\n    Exception             : \r\n        Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n        Message : The script 'snapshot-alert.ps1' cannot be run because the following modules that are specified by the \"#requires\" statements of the script are missing: ActiveDirectory.\r\n        HResult : -2146233087\r\n    TargetObject          : snapshot-alert.ps1\r\n    CategoryInfo          : ResourceUnavailable: (snapshot-alert.ps1:String) [], ParentContainsErrorRecordException\r\n    FullyQualifiedErrorId : ScriptRequiresMissingModules\r\nTargetSite       : \r\n    Name          : Invoke\r\n    DeclaringType : System.Management.Automation.Runspaces.PipelineBase, System.Management.Automation, Version=7.1.4.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n    MemberType    : Method\r\n    Module        : System.Management.Automation.dll\r\nStackTrace       : \r\n   at System.Management.Automation.Runspaces.PipelineBase.Invoke(IEnumerable input)\r\n   at System.Management.Automation.PowerShell.Worker.ConstructPipelineAndDoWork(Runspace rs, Boolean performSyncInvoke)\r\n   at System.Management.Automation.PowerShell.Worker.CreateRunspaceIfNeededAndDoWork(Runspace rsToUse, Boolean isSync)\r\n   at System.Management.Automation.PowerShell.CoreInvokeHelper[TInput,TOutput](PSDataCollection`1 input, PSDataCollection`1 output, PSInvocationSettings settings)\r\n   at System.Management.Automation.PowerShell.CoreInvoke[TInput,TOutput](PSDataCollection`1 input, PSDataCollection`1 output, PSInvocationSettings settings)\r\n   at System.Management.Automation.PowerShell.Invoke[T](IEnumerable input, PSInvocationSettings settings)\r\n   at Microsoft.PowerShell.EditorServices.Services.PowerShellContextService.<>c__DisplayClass93_0`1.<ExecuteCommandAsync>b__0() in D:\\a\\1\\s\\src\\PowerShellEditorServices\\Services\\PowerShellContext\\PowerShellContextService.cs:line 773\r\n   at System.Threading.Tasks.Task`1.InnerInvoke()\r\n   at System.Threading.ExecutionContext.RunFromThreadPoolDispatchLoop(Thread threadPoolThread, ExecutionContext executionContext, ContextCallback callback, Object state)\r\n--- End of stack trace from previous location ---\r\n   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.PowerShell.EditorServices.Services.PowerShellContextService.ExecuteCommandAsync[TResult](PSCommand psCommand, StringBuilder errorMessages, ExecutionOptions executionOptions, CancellationToken cancellationToken) in\r\nD:\\a\\1\\s\\src\\PowerShellEditorServices\\Services\\PowerShellContext\\PowerShellContextService.cs:line 772\r\n   at Microsoft.PowerShell.EditorServices.Services.PowerShellContextService.ExecuteCommandAsync[TResult](PSCommand psCommand, StringBuilder errorMessages, ExecutionOptions executionOptions, CancellationToken cancellationToken) in\r\nD:\\a\\1\\s\\src\\PowerShellEditorServices\\Services\\PowerShellContext\\PowerShellContextService.cs:line 830\r\nMessage          : The script 'snapshot-alert.ps1' cannot be run because the following modules that are specified by the \"#requires\" statements of the script are missing: ActiveDirectory.\r\nSource           : System.Management.Automation\r\nHResult          : -2146233087\n```\n\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.1.4\r\nPSEdition                      Core\r\nGitCommitId                    7.1.4\r\nOS                             Microsoft Windows 10.0.14393\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\nOS-Type: Windows Server 2016\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": null,
  "comments": [],
  "created_at": "2021-09-28T09:12:43Z",
  "number": 16167,
  "state": "open",
  "title": "#Requires -Modules does not autoload modules and is unable to find implicit remoting modules",
  "updated_at": "2022-05-16T18:52:42Z"
}