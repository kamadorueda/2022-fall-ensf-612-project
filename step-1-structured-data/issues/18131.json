{
  "_url": "https://github.com/PowerShell/PowerShell/issues/18131",
  "author": "nightroman",
  "body": "### Prerequisites\r\n\r\n- [X] Write a descriptive title.\r\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- [X] Search the existing issues.\r\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n\r\n### Steps to reproduce\r\n\r\nRun the following commands\r\n\r\n```powershell\r\nAdd-Type -AssemblyName System.Windows.Forms\r\n[System.Windows.Forms.Application]::UserAppDataPath\r\n```\r\n\r\n### Expected behavior\r\n\r\nResult from PowerShell 5.1:\r\n\r\n```\r\nC:\\Users\\roman.kuzmin\\AppData\\Roaming\\Microsoft Corporation\\Microsoft\u00ae Windows\u00ae Operating System\\10.0.19041.1\r\n```\r\n\r\n### Actual behavior\r\n\r\n```\r\nOperationStopped: The directory name is invalid. : 'C:\\Users\\roman.kuzmin\\AppData\\Roaming\\Microsoft Corporation\\PowerShell\\7.2.6 SHA: eb2c4accddda2995e50cd349e655888500899d8b'\r\n```\r\n\r\n\r\n### Error details\r\n\r\n```console\r\nType           : System.Management.Automation.RuntimeException\r\nErrorRecord    :\r\n    Exception             :\r\n        Type       : System.IO.IOException\r\n        TargetSite :\r\n            Name          : CreateDirectory\r\n            DeclaringType : System.IO.FileSystem, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\r\n            MemberType    : Method\r\n            Module        : System.Private.CoreLib.dll\r\n        Message    : The directory name is invalid. : 'C:\\Users\\roman.kuzmin\\AppData\\Roaming\\Microsoft Corporation\\PowerShell\\7.2.6 SHA:\r\neb2c4accddda2995e50cd349e655888500899d8b'\r\n        Data       : System.Collections.ListDictionaryInternal\r\n        Source     : System.Private.CoreLib\r\n        HResult    : -2147024629\r\n        StackTrace :\r\n   at System.IO.FileSystem.CreateDirectory(String fullPath, Byte[] securityDescriptor)\r\n   at System.IO.Directory.CreateDirectory(String path)\r\n   at System.Windows.Forms.Application.GetDataPath(String basePath)\r\n   at System.Windows.Forms.Application.get_UserAppDataPath()\r\n   at System.Management.Automation.Interpreter.FuncCallInstruction`1.Run(InterpretedFrame frame)\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\r\n    CategoryInfo          : OperationStopped: (:) [], IOException\r\n    FullyQualifiedErrorId : System.IO.IOException\r\n    InvocationInfo        :\r\n        ScriptLineNumber : 1\r\n        OffsetInLine     : 1\r\n        HistoryId        : -1\r\n        Line             : [System.Windows.Forms.Application]::UserAppDataPath\r\n        PositionMessage  : At line:1 char:1\r\n                           + [System.Windows.Forms.Application]::UserAppDataPath\r\n                           + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n        CommandOrigin    : Internal\r\n    ScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\nTargetSite     :\r\n    Name          : Invoke\r\n    DeclaringType : System.Management.Automation.Runspaces.PipelineBase, System.Management.Automation, Version=7.2.6.500, Culture=neutral,\r\nPublicKeyToken=31bf3856ad364e35\r\n    MemberType    : Method\r\n    Module        : System.Management.Automation.dll\r\nMessage        : The directory name is invalid. : 'C:\\Users\\roman.kuzmin\\AppData\\Roaming\\Microsoft Corporation\\PowerShell\\7.2.6 SHA:\r\neb2c4accddda2995e50cd349e655888500899d8b'\r\nData           : System.Collections.ListDictionaryInternal\r\nInnerException :\r\n    Type       : System.IO.IOException\r\n    TargetSite :\r\n        Name          : CreateDirectory\r\n        DeclaringType : System.IO.FileSystem, System.Private.CoreLib, Version=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\r\n        MemberType    : Method\r\n        Module        : System.Private.CoreLib.dll\r\n    Message    : The directory name is invalid. : 'C:\\Users\\roman.kuzmin\\AppData\\Roaming\\Microsoft Corporation\\PowerShell\\7.2.6 SHA:\r\neb2c4accddda2995e50cd349e655888500899d8b'\r\n    Data       : System.Collections.ListDictionaryInternal\r\n    Source     : System.Private.CoreLib\r\n    HResult    : -2147024629\r\n    StackTrace :\r\n   at System.IO.FileSystem.CreateDirectory(String fullPath, Byte[] securityDescriptor)\r\n   at System.IO.Directory.CreateDirectory(String path)\r\n   at System.Windows.Forms.Application.GetDataPath(String basePath)\r\n   at System.Windows.Forms.Application.get_UserAppDataPath()\r\n   at System.Management.Automation.Interpreter.FuncCallInstruction`1.Run(InterpretedFrame frame)\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\r\nSource         : System.Management.Automation\r\nHResult        : -2146233087\r\nStackTrace     :\r\n   at System.Management.Automation.Runspaces.PipelineBase.Invoke(IEnumerable input)\r\n   at System.Management.Automation.Runspaces.Pipeline.Invoke()\r\n   at Microsoft.PowerShell.Executor.ExecuteCommandHelper(Pipeline tempPipeline, Exception& exceptionThrown, ExecutionOptions options)\r\n```\r\n\r\n\r\n### Environment data\r\n\r\n```\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.6\r\nPSEdition                      Core\r\nGitCommitId                    7.2.6\r\nOS                             Microsoft Windows 10.0.19044\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\n\r\n### Visuals\r\n\r\n_No response_",
  "closed_at": null,
  "comments": [
    {
      "author": "nightroman",
      "author_association": "NONE",
      "body": "This issue causes other issues. In particular it is not possible to use `Microsoft.VisualBasic.Logging.FileLogTraceListener` because its constructor calls `System.Windows.Forms.Application.UserAppDataPath`.",
      "created_at": "2022-09-20T05:51:28Z",
      "updated_at": "2022-09-20T05:51:49Z"
    },
    {
      "author": "fMichaleczek",
      "author_association": "NONE",
      "body": "There is more issues than UserAppDataPath : \r\n\r\n```\r\n>  Add-Type -AssemblyName System.Windows.Forms\r\n\r\n> [System.Windows.Forms.Application]::CommonAppDataPath\r\nOperationStopped: The directory name is invalid. : 'C:\\ProgramData\\Microsoft Corporation\\PowerShell\\7.2.6 SHA: eb2c4accddda2995e50cd349e655888500899d8b'\r\n\r\n> [System.Windows.Forms.Application]::UserAppDataPath\r\nOperationStopped: The directory name is invalid. : 'C:\\Users\\Flavien\\AppData\\Roaming\\Microsoft Corporation\\PowerShell\\7.2.6 SHA: eb2c4accddda2995e50cd349e655888500899d8b'\r\n\r\n> [System.Windows.Forms.Application]::LocalUserAppDataPath\r\nOperationStopped: The directory name is invalid. : 'C:\\Users\\Flavien\\AppData\\Local\\Microsoft Corporation\\PowerShell\\7.2.6 SHA: eb2c4accddda2995e50cd349e655888500899d8b'\r\n\r\n> [System.Windows.Forms.Application]::CommonAppDataRegistry.ToString()\r\nHKEY_LOCAL_MACHINE\\Software\\Microsoft Corporation\\PowerShell\\7.3.0-preview.6 SHA: bcafe74c174091a0f47cf7a5eeb4bca8aefa8718\r\n```\r\n\r\nThe documentation said if a path does not exist, one is created in the following format:\r\n\r\n_Base Path\\CompanyName\\ProductName\\ProductVersion_\r\n\r\nsource : [learn.microsoft.com|Application.UserAppDataPath](https://learn.microsoft.com/en-us/dotnet/api/system.windows.forms.application.userappdatapath?view=windowsdesktop-6.0#remarks)\r\n\r\nThe problem is located in pwsh.exe where the ProductVersion contains a \":\" colon.\r\n\r\n```\r\n> (Get-Command powershell.exe | Get-Item).VersionInfo.ProductVersion\r\n10.0.19041.1\r\n\r\n> (Get-Command pwsh.exe | Get-Item).VersionInfo.ProductVersion\r\n7.2.6 SHA: eb2c4accddda2995e50cd349e655888500899d8b\r\n```\r\n\r\n",
      "created_at": "2022-09-22T18:37:02Z",
      "updated_at": "2022-09-22T18:37:02Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "We followed .Net in this. In 7.0 they changed this to semantic version. We could do the same.\r\n\r\n----\r\n\r\nAlthough it is too reckless for WinForms to trust this attribute. I would advise you to open new issue there too.",
      "created_at": "2022-09-23T04:57:37Z",
      "updated_at": "2022-09-23T04:57:37Z"
    },
    {
      "author": "fMichaleczek",
      "author_association": "NONE",
      "body": "> We followed .Net in this. In 7.0 they changed this to semantic version. We could do the same.\r\n\r\n```\r\n> (Get-Command dotnet.exe | Get-Item).VersionInfo.ProductVersion\r\n7.0.0-preview.7.22375.6 @Commit: eecb02807867cad56cd05badddef65e432248b75\r\n```\r\n\r\nthere is a commit version but dotnet.exe isn't a Windows UI app model, and pwsh.exe is not a console app on Windows ?\r\n\r\n```\r\n> (Get-Item $PSHome\\System.Windows.Forms.dll).VersionInfo.ProductVersion\r\n7.0.0-preview.6.22351.2+f6720164c48ea0de634e574de94dd8450f761b25\r\n```\r\n> Although it is too reckless for WinForms to trust this attribute. I would advise you to open new issue there too.\r\n\r\nProductVersion is a special attribute for Windows UI app mode, it's not a free string in this context.\r\nI don't think we should ask to open a issue about a breaking in the Winforms .NET Framework 1.1 Application API.\r\n\r\n```\r\n> # List Product Version\r\n> (Get-Item $PSHome\\*.dll).VersionInfo.ProductVersion | Select-Object -Unique\r\n```",
      "created_at": "2022-09-23T17:58:26Z",
      "updated_at": "2022-09-23T17:58:26Z"
    }
  ],
  "created_at": "2022-09-20T05:46:25Z",
  "number": 18131,
  "state": "open",
  "title": "pwsh: cannot get System.Windows.Forms.Application.UserAppDataPath",
  "updated_at": "2022-09-23T17:58:26Z"
}