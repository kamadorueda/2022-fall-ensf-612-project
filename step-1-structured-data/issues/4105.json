{
  "_url": "https://github.com/PowerShell/PowerShell/issues/4105",
  "author": "rpsqrd",
  "body": ">Note: Ported from bug 11787772\r\n\r\nIf a PowerShell Session Configuration file references one or more role capability files in the RoleDefinitions field and those role capability files are stored in versioned module folders (e.g. `C:\\Program Files\\WindowsPowerShell\\Modules\\MyModuleName\\1.0.0\\RoleCapabilities\\MyRole.psrc`), PowerShell will be unable to find those role capability files and may fail to establish the PSSession.\r\n\r\nThe current workaround is to move the \"RoleCapabilities\" folder up one level so that it is under the main module folder, not a versioned subfolder, however this is not ideal for customers downloading modules that are already set up this way from the PowerShell Gallery or other repository. Customers on Windows 10 1703 or higher can also use the \"RoleCapabilityFiles\" parameter in the \"RoleDefinitions\" hashtable to explicitly select the role capability file to load, regardless of whether it is nested in a versioned folder or not.\r\n\r\nThis issue is filed to request that JEA search versioned subfolders in modules for role capability files to maintain compatibility with the PowerShell Gallery best practices.",
  "closed_at": null,
  "comments": [
    {
      "author": "briantist",
      "author_association": "NONE",
      "body": "This is a very poor experience. The JEA documentation doesn't mention this at all and acts as though you just need to have a module in the path. The worst part is that there's no great workaround that's consistent. \r\n\r\nI'm dealing with this now, trying to come up with a solution that accounts for an updated module with new or updated role configurations and it just sucks all around; makes it practically unusable for anyone who manages their modules with an actual repository!",
      "created_at": "2020-01-26T01:31:00Z",
      "updated_at": "2020-01-26T01:31:00Z"
    },
    {
      "author": "doctordns",
      "author_association": "COLLABORATOR",
      "body": "Using a 'random' module for this is really not a great design decision (with the benefit of hindsight) \r\n\r\nIn PowerShell 7, you just avoid using the module totally. Here is a sample that demonstrates this:\r\n\r\n```powershell\r\n\r\n# 1. Create Capabilities Folder\r\n$JEACF = \"C:\\JEACapabilities\"\r\nNew-Item -Path $JEACF -ItemType Directory | Out-Null\r\n\r\n# 2. Create Role Capabilities file in the folder\r\n$RCF = Join-Path -Path $JEACF -ChildPath \"RKDnsAsmins.psrc\"\r\n$RCHT = @{\r\n  Path            = $RCF\r\n  Author          = 'Reskit Administration'\r\n  CompanyName     = 'Reskit.Org' \r\n  Description     = 'Defines RKDnsAdmins role capabilities'\r\n  AliasDefinition = @{name='gh';value='Get-Help'}\r\n  ModulesToImport = 'Microsoft.PowerShell.Core','DnsServer'\r\n  VisibleCmdlets  = (\"Restart-Service\",\r\n                     @{ Name       = \"Restart-Computer\"; \r\n                        Parameters = @{Name = \"ComputerName\"}\r\n                        ValidateSet = 'DC1, DC2'},\r\n                      'DNSSERVER\\*')\r\n  VisibleExternalCommands = ('C:\\Windows\\System32\\whoami.exe')\r\n  VisibleFunctions = 'Get-HW'\r\n  FunctionDefinitions = @{\r\n    Name = 'Get-HW'\r\n    Scriptblock = {'Hello JEA World'}}\r\n}\r\nNew-PSRoleCapabilityFile @RCHT -verbose\r\n\r\n# 3. Create a JEA Session Configuration file\r\n$SCF = \"C:\\JEASessionConfiguration\"  # root location\r\n$P   = Join-Path -Path $SCF -ChildPath 'RKDnsAdmins.pssc' # get filename\r\n$RDHT = @{\r\n  'Reskit\\RKDnsAdmins' = @{'RoleCapabilityFiles' = 'C:\\JEACapabilities\\RKDnsAsmins.psrc'\r\n}\r\n$PSCHT= @{\r\n  Author              = 'DoctorDNS@Gmail.Com'\r\n  Description         = 'Session Definition for RKDnsAdmins'\r\n  SessionType         = 'RestrictedRemoteServer'   # ie JEA!\r\n  Path                = $P       # Role Capabilties file\r\n  RunAsVirtualAccount = $true\r\n  TranscriptDirectory = 'C:\\Foo\\JeaTranscripts'\r\n  RoleDefinitions     = $RDHT     # RKDnsAdmins role mapping\r\n}\r\nNew-PSSessionConfigurationFile @PSCHT\r\n\r\n# 4. Test the session configuration file\r\nTest-PSSessionConfigurationFile -Path $P \r\n\r\n# 5. Enable Remoting and Register the JEA Session Definition\r\nEnable-PSRemoting -Force \r\n  Out-Null\r\n$SCHT = @{\r\n  Path  = $P\r\n  Name  = 'RKDnsAdmins' \r\n  Force =  $true \r\n}\r\nRegister-PSSessionConfiguration @SCHT\r\n\r\n# 6. Check What the User Can Do\r\nGet-PSSessionCapability -ConfigurationName RkDnsAdmins -Username 'Reskit\\Jerryg' |\r\n  Sort-Object Module\r\n\r\n# 7. Create Credentials for user JerryG\r\n$U    = 'JerryG@Reskit.Org'\r\n$P    = ConvertTo-SecureString 'Pa$$w0rd' -AsPlainText -Force \r\n$Cred = New-Object System.Management.Automation.PSCredential $U,$P\r\n\r\n# 8. Define Three Script Blocks and an Invocation Splatting Hast Table\r\n$SB1   = {Get-Command}\r\n$SB2   = {Get-HW}\r\n$SB3   = {Get-Command -Name  '*-DNSSERVER*'}\r\n$ICMHT = @{\r\n  ComputerName      = 'DC1.Reskit.Org'\r\n  Credential        = $Cred \r\n  ConfigurationName = 'RKDnsAdmins' \r\n} \r\n\r\n# 12. How many Commands are available within the JEA session\r\nInvoke-Command -ScriptBlock $SB1 @ICMHT |\r\n  Sort-Object -Property Module |\r\n    Select-Object -First 15\r\n\r\n# 13. Invoke a JEA Defined Function in a JEA Ssession As JerryG\r\nInvoke-Command -ScriptBlock $SB2 @ICMHT\r\n\r\n# 14. Get DNSServer commands available to JerryG\r\n$C = Invoke-command -ScriptBlock $SB3 @ICMHT \r\n\"$($C.Count) DNS commands available\"\r\n\r\n# 15 Examine the contents of the Transcripts folder:\r\nGet-ChildItem -Path $PSCHT.TranscriptDirectory\r\n\r\n# 16. Examine a transcript\r\nGet-ChildItem -Path $PSCHT.TranscriptDirectory | \r\n  Select-Object -First 1  |\r\n     Get-Content \r\n```",
      "created_at": "2020-01-26T13:52:35Z",
      "updated_at": "2020-01-26T13:52:35Z"
    },
    {
      "author": "briantist",
      "author_association": "NONE",
      "body": "@doctordns I'm not using a \"random\" module. I see the value in having the option to define role capabilities outside of a module, particularly for roles that only restrict built-in cmdlets.\r\n\r\nBut I like the idea of packaging roles with modules when the roles are specific to the module's purpose and its commands. \r\n\r\nPutting them alongside makes sense, especially from the POV of coordination and packaging. If I add new commands to a module, up its version, and publish it, and I want a new role available to make use of them, I'd like that to come along _with_ the module.\r\n\r\nConversely, if I have to define it separately then \r\n1. there's no versioned/packaged format for the standalone directory full of unrelated roles\r\n2. if I put the new role definition in place before the module that supports it, it won't work\r\n3. having to change the session configuration is yet another change and applying it means restarting winrm which is disruptive.\r\n\r\nTrying to implement JEA, which is supported on 5.1, only to find that the entire module-searching that underpins its ability to find roles, doesn't actually support the same module paths that the entire rest of Windows PowerShell uses, is a very bad experience. It's set our project back by a lot. Even if we wanted to dump all the role configurations into a random directory, it would be an entirely different project to get PowerShell 7 out to all our environments and tested with existing workflows.\r\n\r\nI don't think that the role searching idea was problematic, it was just implemented in a way that somehow doesn't work with PowerShell's own package management, which is bonkers. I'm in awe that this has been known for years, and hasn't been fixed and backported.",
      "created_at": "2020-01-26T22:50:41Z",
      "updated_at": "2020-01-26T22:50:41Z"
    },
    {
      "author": "briantist",
      "author_association": "NONE",
      "body": "For anyone interested, I made a script that applies the workaround @rpsqrd mentioned, but continuously, by monitoring the module directories and symlinking a `RoleCapabilities` folder in the module folder, pointing to latest version of the module:\r\n\r\nhttps://github.com/briantist/jea-role-cap-hack\n\n<blockquote><img src=\"https://avatars3.githubusercontent.com/u/1260690?s=400&v=4\" width=\"48\" align=\"right\"><div><img src=\"https://github.githubassets.com/favicon.ico\" height=\"14\"> GitHub</div><div><strong><a href=\"https://github.com/briantist/jea-role-cap-hack\">briantist/jea-role-cap-hack</a></strong></div><div>Hacks a fix to JEA role capability searching in versioned PowerShell modules. - briantist/jea-role-cap-hack</div></blockquote>",
      "created_at": "2020-01-27T03:11:24Z",
      "updated_at": "2020-01-27T03:11:26Z"
    }
  ],
  "created_at": "2017-06-26T16:57:08Z",
  "labels": [
    "Issue-Bug",
    "WG-Security",
    "Consider-WindowsPowerShell51"
  ],
  "number": 4105,
  "state": "open",
  "title": "JEA role capabilities cannot be discovered if placed in a versioned module folder",
  "updated_at": "2021-03-09T22:33:26Z"
}