{
  "_url": "https://github.com/PowerShell/PowerShell/issues/15175",
  "author": "PaulHigin",
  "body": "<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\nThis fixes the SSH remoting hang issue: #15174 \r\n\r\n## PR Context\r\n\r\nIf an SSH remoting endpoint configuration (sshd_config file) is misconfigured, the ssh.exe client process used to make the ssh connection fails silently.  No error is emitted.  As a result, the PowerShell remoting layer waits indefinitely for protocol messages.\r\n\r\nI also noticed that the base transport manager message queue threads were not being cleaned up in this case, because a connection is never established and the normal protocol close processing never occurs.  So I have modified the code to ensure this clean up is done in this SSH connection failed case.\r\n\r\nAfter some discussion, the proposed fix is to add a `-ConnectingTimeout` parameter to SSH remoting that abandons a connection attempt after the timeout period.  The default value will be `infinite` so as not to introduce regressions.\r\n\r\nThis change will affect:\r\n```powershell\r\nEnter-PSSession SSH parameter set\r\nInvoke-PSSession SSH parameter set\r\nNew-PSSession SSH parameter set\r\nSSHConnectionInfo class\r\n```\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [ ] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [x] None\r\n    - **OR**\r\n    - [ ] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n        - [ ] Experimental feature name(s): <!-- Experimental feature name(s) here -->\r\n- **User-facing changes**\r\n    - [ ] Not Applicable\r\n    - **OR**\r\n    - [x] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: https://github.com/MicrosoftDocs/PowerShell-Docs/issues/7464\r\n- **Testing - New and feature**\r\n    - [x] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [x] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [ ] I have considered the user experience from a tooling perspective and opened an issue in the relevant tool repository. This may include:\r\n        - [ ] Impact on [PowerShell Editor Services](https://github.com/PowerShell/PowerShellEditorServices) which is used in the [PowerShell extension](https://github.com/PowerShell/vscode-powershell) for VSCode\r\n        (which runs in a different PS Host).\r\n            - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n        - [ ] Impact on Completions (both in the console and in editors) - one of PowerShell's most powerful features.\r\n            - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n        - [ ] Impact on [PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer) (which provides linting & formatting in the editor extensions).\r\n            - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n        - [ ] Impact on [EditorSyntax](https://github.com/PowerShell/EditorSyntax) (which provides syntax highlighting with in VSCode, GitHub, and many other editors).\r\n            - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n",
  "closed_at": "2021-04-13T22:36:37Z",
  "comments": [
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "Remoting working group: Please see solution proposal in PR Context section.",
      "created_at": "2021-04-07T16:37:41Z",
      "updated_at": "2021-04-07T16:37:41Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "Remoting working group:  The proposed fix to add a `-ConnectingTimeout` parameter to SSH remoting that abandons a connection attempt after the timeout period.  The default value will be `infinite` so it is not a breaking change.\r\n\r\nThis seems like a good fix.",
      "created_at": "2021-04-07T21:17:33Z",
      "updated_at": "2021-04-07T21:17:33Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "After some experimentation, it appears the random hang is during the connection close process, if the target is no longer responding.  The base transport manager already has code to handle this with a try/catch around the text writer object that sends the PSRP message.  However, the catch didn't include 'ObjectDisposedException' and after adding this in the handler, the hang appears to have gone away.",
      "created_at": "2021-04-12T23:48:11Z",
      "updated_at": "2021-04-12T23:48:11Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.2.0-preview.5` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.2.0-preview.5)\n",
      "created_at": "2021-04-14T23:59:38Z",
      "updated_at": "2021-04-14T23:59:38Z"
    }
  ],
  "created_at": "2021-04-06T19:47:39Z",
  "number": 15175,
  "state": "closed",
  "title": "Fix SSH remoting connection hang with misconfigured endpoint",
  "updated_at": "2021-04-14T23:59:38Z"
}