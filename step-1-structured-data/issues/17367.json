{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17367",
  "author": "marcgoff",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nAfter upgrading to Powershell 7.2.2, 7.2.3 or 7.2.4 when I run the Register-PSSessionConfiguration, it seems to complete with no errors from the command line, but I can no longer connect to the JEA configuration. This is a CI/CD deployment that has worked for months until we upgraded to 7.2.2 on the JEA server. The configuration will still work after the powershell upgrade from 7.2.1 until I reregister the configuration and then it will fail. It seems like something in the registration process. I also can uninstall post 7.2.1 versions, reinstall 7.2.1 and it will work again with no other changes.\r\n\r\nThe only other thing I noticed was that when I would register the configuration I would sometimes see two windows pop up in succession quickly with an error from pwsh.exe saying \"the argument 'icm' is not recognized as the name of a script file\". I'm attaching a screenshot. \r\n\r\nConnection command:\r\netsn cmjea.$env:USERDNSDOMAIN -ConfigurationName ums-cm-jea -UseSSL\n\n### Expected behavior\n\n```console\nJEA session ums-cm-jea would connect. I can connect to the standard WinRM session using \"etsn cmjea.$env:USERDNSDOMAIN -UseSSL\".\n```\n\n\n### Actual behavior\n\n```console\nReceive the following errors when trying to connect to the config:\r\n\r\netsn : Connecting to remote server cmjea.mydomain.com failed with the following error message : <f:WSManFault\r\nxmlns:f=\"http://schemas.microsoft.com/wbem/wsman/1/wsmanfault\" Code=\"2689860592\"\r\nMachine=\"cmjea.mydomain.com\"><f:Message><f:ProviderFault provider=\"UMS-CM-JEA\"\r\npath=\"C:\\Windows\\system32\\PowerShell\\7.2.4\\pwrshplugin.dll\"></f:ProviderFault></f:Message></f:WSManFault> For more\r\ninformation, see the about_Remote_Troubleshooting Help topic.\r\nAt line:1 char:1\r\n+ etsn cmjea.$env:USERDNSDOMAIN -ConfigurationName ums-cm-jea -UseSSL\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : InvalidArgument: (cmjea.mydomain.com:String) [Enter-PSSession], PSRemotingTransport\r\n   Exception\r\n    + FullyQualifiedErrorId : CreateRemoteRunspaceFailed\n```\n\n\n### Error details\n\n```console\nThere are events in the PowerShellCore/Operational log that are generated when registering the configuration indicating there is some problem. One references an issue connecting to localhost. I am able to connect to the default configurations via localhost.\r\n\r\nBelow are ethe events from newest to oldest:\r\n==================================\r\nLog Name:      PowerShellCore/Operational\r\nSource:        PowerShellCore\r\nDate:          5/17/2022 4:36:36 PM\r\nEvent ID:      4100\r\nTask Category: Executing Pipeline\r\nLevel:         Warning\r\nKeywords:      None\r\nUser:          CONTOSO\\my-adm\r\nComputer:      server.mydomain.com\r\nDescription:\r\nError Message = The running command stopped because the preference variable \"ErrorActionPreference\" or common parameter is set to Stop: [localhost] Connecting to remote server localhost failed with the following error message : <f:WSManFault xmlns:f=\"http://schemas.microsoft.com/wbem/wsman/1/wsmanfault\" Code=\"2689860592\" Machine=\"localhost\"><f:Message><f:ProviderFault provider=\"UMS-CM-JEA\" path=\"C:\\Windows\\system32\\PowerShell\\7.2.4\\pwrshplugin.dll\"></f:ProviderFault></f:Message></f:WSManFault> For more information, see the about_Remote_Troubleshooting Help topic.\r\nFully Qualified Error ID = -1605106704,PSSessionOpenFailed\r\nRecommended Action = \r\n\r\n\r\nContext:\r\n        Severity = Warning\r\n        Host Name = ConsoleHost\r\n        Host Version = 7.2.4\r\n        Host ID = 48dddc3b-232d-4c5f-9d6d-3f1c56b621c1\r\n        Host Application = C:\\Program Files\\PowerShell\\7\\pwsh.dll -WorkingDirectory ~\r\n        Engine Version = 7.2.4\r\n        Runspace ID = eee9a7a6-5768-411f-80b4-06f356a26ba1\r\n        Pipeline ID = 115\r\n        Command Name = New-PSSession\r\n        Command Type = Cmdlet\r\n        Script Name = \r\n        Command Path = \r\n        Sequence Number = 45\r\n        User = CONTOSO\\my-adm\r\n        Connected User = \r\n        Shell ID = Microsoft.PowerShell\r\n\r\n\r\nUser Data:\r\n\r\n\r\nEvent Xml:\r\n<Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\r\n  <System>\r\n    <Provider Name=\"PowerShellCore\" Guid=\"{f90714a8-5509-434a-bf6d-b1624c8a19a2}\" />\r\n    <EventID>4100</EventID>\r\n    <Version>1</Version>\r\n    <Level>3</Level>\r\n    <Task>106</Task>\r\n    <Opcode>19</Opcode>\r\n    <Keywords>0x0</Keywords>\r\n    <TimeCreated SystemTime=\"2022-05-17T20:36:36.9369428Z\" />\r\n    <EventRecordID>428267</EventRecordID>\r\n    <Correlation ActivityID=\"{e3e592f7-c42e-4002-aff6-f1885ab8923a}\" />\r\n    <Execution ProcessID=\"4056\" ThreadID=\"6764\" />\r\n    <Channel>PowerShellCore/Operational</Channel>\r\n    <Computer>server.mydomain.com</Computer>\r\n    <Security UserID=\"S-1-5-21-2147491999-1103789872-2603493700-327614\" />\r\n  </System>\r\n  <EventData>\r\n    <Data Name=\"ContextInfo\">        Severity = Warning\r\n        Host Name = ConsoleHost\r\n        Host Version = 7.2.4\r\n        Host ID = 48dddc3b-232d-4c5f-9d6d-3f1c56b621c1\r\n        Host Application = C:\\Program Files\\PowerShell\\7\\pwsh.dll -WorkingDirectory ~\r\n        Engine Version = 7.2.4\r\n        Runspace ID = eee9a7a6-5768-411f-80b4-06f356a26ba1\r\n        Pipeline ID = 115\r\n        Command Name = New-PSSession\r\n        Command Type = Cmdlet\r\n        Script Name = \r\n        Command Path = \r\n        Sequence Number = 45\r\n        User = CONTOSO\\my-adm\r\n        Connected User = \r\n        Shell ID = Microsoft.PowerShell\r\n</Data>\r\n    <Data Name=\"UserData\">\r\n    </Data>\r\n    <Data Name=\"Payload\">Error Message = The running command stopped because the preference variable \"ErrorActionPreference\" or common parameter is set to Stop: [localhost] Connecting to remote server localhost failed with the following error message : &lt;f:WSManFault xmlns:f=\"http://schemas.microsoft.com/wbem/wsman/1/wsmanfault\" Code=\"2689860592\" Machine=\"localhost\"&gt;&lt;f:Message&gt;&lt;f:ProviderFault provider=\"UMS-CM-JEA\" path=\"C:\\Windows\\system32\\PowerShell\\7.2.4\\pwrshplugin.dll\"&gt;&lt;/f:ProviderFault&gt;&lt;/f:Message&gt;&lt;/f:WSManFault&gt; For more information, see the about_Remote_Troubleshooting Help topic.\r\nFully Qualified Error ID = -1605106704,PSSessionOpenFailed\r\nRecommended Action = \r\n</Data>\r\n  </EventData>\r\n</Event>\r\n\r\nLog Name:      PowerShellCore/Operational\r\nSource:        PowerShellCore\r\nDate:          5/17/2022 4:36:36 PM\r\nEvent ID:      8197\r\nTask Category: Connect\r\nLevel:         Verbose\r\nKeywords:      None\r\nUser:          CONTOSO\\my-adm\r\nComputer:      server.mydomain.com\r\nDescription:\r\nRunspace state changed to Broken\r\nEvent Xml:\r\n<Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\r\n  <System>\r\n    <Provider Name=\"PowerShellCore\" Guid=\"{f90714a8-5509-434a-bf6d-b1624c8a19a2}\" />\r\n    <EventID>8197</EventID>\r\n    <Version>1</Version>\r\n    <Level>5</Level>\r\n    <Task>1</Task>\r\n    <Opcode>10</Opcode>\r\n    <Keywords>0x0</Keywords>\r\n    <TimeCreated SystemTime=\"2022-05-17T20:36:36.9366393Z\" />\r\n    <EventRecordID>428266</EventRecordID>\r\n    <Correlation ActivityID=\"{e3e592f7-c42e-4002-aff6-f1885ab8923a}\" />\r\n    <Execution ProcessID=\"4056\" ThreadID=\"7144\" />\r\n    <Channel>PowerShellCore/Operational</Channel>\r\n    <Computer>server.mydomain.com</Computer>\r\n    <Security UserID=\"S-1-5-21-2147491999-1103789872-2603493700-327614\" />\r\n  </System>\r\n  <EventData>\r\n    <Data Name=\"param1\">Broken</Data>\r\n  </EventData>\r\n</Event>\r\n\r\nLog Name:      PowerShellCore/Operational\r\nSource:        PowerShellCore\r\nDate:          5/17/2022 4:36:36 PM\r\nEvent ID:      32784\r\nTask Category: None\r\nLevel:         Error\r\nKeywords:      None\r\nUser:          CONTOSO\\my-adm\r\nComputer:      server.mydomain.com\r\nDescription:\r\nRunspace Id: e3e592f7-c42e-4002-aff6-f1885ab8923a Pipeline Id: 00000000-0000-0000-0000-000000000000. WSMan reported an error with error code: -1605106704. \r\n Error message: Connecting to remote server localhost failed with the following error message : <f:WSManFault xmlns:f=\"http://schemas.microsoft.com/wbem/wsman/1/wsmanfault\" Code=\"2689860592\" Machine=\"localhost\"><f:Message><f:ProviderFault provider=\"UMS-CM-JEA\" path=\"C:\\Windows\\system32\\PowerShell\\7.2.4\\pwrshplugin.dll\"></f:ProviderFault></f:Message></f:WSManFault> For more information, see the about_Remote_Troubleshooting Help topic. \r\n StackTrace: \r\nEvent Xml:\r\n<Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\r\n  <System>\r\n    <Provider Name=\"PowerShellCore\" Guid=\"{f90714a8-5509-434a-bf6d-b1624c8a19a2}\" />\r\n    <EventID>32784</EventID>\r\n    <Version>1</Version>\r\n    <Level>2</Level>\r\n    <Task>0</Task>\r\n    <Opcode>10</Opcode>\r\n    <Keywords>0x0</Keywords>\r\n    <TimeCreated SystemTime=\"2022-05-17T20:36:36.9365236Z\" />\r\n    <EventRecordID>428265</EventRecordID>\r\n    <Correlation ActivityID=\"{e3e592f7-c42e-4002-aff6-f1885ab8923a}\" />\r\n    <Execution ProcessID=\"4056\" ThreadID=\"7144\" />\r\n    <Channel>PowerShellCore/Operational</Channel>\r\n    <Computer>server.mydomain.com</Computer>\r\n    <Security UserID=\"S-1-5-21-2147491999-1103789872-2603493700-327614\" />\r\n  </System>\r\n  <EventData>\r\n    <Data Name=\"SessionId\">e3e592f7-c42e-4002-aff6-f1885ab8923a</Data>\r\n    <Data Name=\"PipelineId\">00000000-0000-0000-0000-000000000000</Data>\r\n    <Data Name=\"ErrorCode\">-1605106704</Data>\r\n    <Data Name=\"ErrorMessage\">Connecting to remote server localhost failed with the following error message : &lt;f:WSManFault xmlns:f=\"http://schemas.microsoft.com/wbem/wsman/1/wsmanfault\" Code=\"2689860592\" Machine=\"localhost\"&gt;&lt;f:Message&gt;&lt;f:ProviderFault provider=\"UMS-CM-JEA\" path=\"C:\\Windows\\system32\\PowerShell\\7.2.4\\pwrshplugin.dll\"&gt;&lt;/f:ProviderFault&gt;&lt;/f:Message&gt;&lt;/f:WSManFault&gt; For more information, see the about_Remote_Troubleshooting Help topic.</Data>\r\n    <Data Name=\"StackTrace\">\r\n    </Data>\r\n  </EventData>\r\n</Event>\r\n\r\nLog Name:      PowerShellCore/Operational\r\nSource:        PowerShellCore\r\nDate:          5/17/2022 4:36:36 PM\r\nEvent ID:      12039\r\nTask Category: None\r\nLevel:         Information\r\nKeywords:      None\r\nUser:          CONTOSO\\my-adm\r\nComputer:      server.mydomain.com\r\nDescription:\r\nModifying activity Id and correlating\r\nEvent Xml:\r\n<Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\r\n  <System>\r\n    <Provider Name=\"PowerShellCore\" Guid=\"{f90714a8-5509-434a-bf6d-b1624c8a19a2}\" />\r\n    <EventID>12039</EventID>\r\n    <Version>1</Version>\r\n    <Level>4</Level>\r\n    <Task>0</Task>\r\n    <Opcode>20</Opcode>\r\n    <Keywords>0x0</Keywords>\r\n    <TimeCreated SystemTime=\"2022-05-17T20:36:36.9365143Z\" />\r\n    <EventRecordID>428264</EventRecordID>\r\n    <Correlation ActivityID=\"{e3e592f7-c42e-4002-aff6-f1885ab8923a}\" />\r\n    <Execution ProcessID=\"4056\" ThreadID=\"7144\" />\r\n    <Channel>PowerShellCore/Operational</Channel>\r\n    <Computer>server.mydomain.com</Computer>\r\n    <Security UserID=\"S-1-5-21-2147491999-1103789872-2603493700-327614\" />\r\n  </System>\r\n  <EventData>\r\n  </EventData>\r\n</Event>\r\n\r\nLog Name:      PowerShellCore/Operational\r\nSource:        PowerShellCore\r\nDate:          5/17/2022 4:36:36 PM\r\nEvent ID:      8196\r\nTask Category: None\r\nLevel:         Information\r\nKeywords:      None\r\nUser:          CONTOSO\\my-adm\r\nComputer:      server.mydomain.com\r\nDescription:\r\nModifying activity Id and correlating\r\nEvent Xml:\r\n<Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\r\n  <System>\r\n    <Provider Name=\"PowerShellCore\" Guid=\"{f90714a8-5509-434a-bf6d-b1624c8a19a2}\" />\r\n    <EventID>8196</EventID>\r\n    <Version>1</Version>\r\n    <Level>4</Level>\r\n    <Task>0</Task>\r\n    <Opcode>20</Opcode>\r\n    <Keywords>0x0</Keywords>\r\n    <TimeCreated SystemTime=\"2022-05-17T20:36:36.9365122Z\" />\r\n    <EventRecordID>428263</EventRecordID>\r\n    <Correlation ActivityID=\"{e3e592f7-c42e-4002-aff6-f1885ab8923a}\" />\r\n    <Execution ProcessID=\"4056\" ThreadID=\"7144\" />\r\n    <Channel>PowerShellCore/Operational</Channel>\r\n    <Computer>server.mydomain.com</Computer>\r\n    <Security UserID=\"S-1-5-21-2147491999-1103789872-2603493700-327614\" />\r\n  </System>\r\n  <EventData>\r\n  </EventData>\r\n</Event>\r\n\r\nLog Name:      PowerShellCore/Operational\r\nSource:        PowerShellCore\r\nDate:          5/17/2022 4:36:36 PM\r\nEvent ID:      8197\r\nTask Category: Connect\r\nLevel:         Verbose\r\nKeywords:      None\r\nUser:          CONTOSO\\my-adm\r\nComputer:      server.mydomain.com\r\nDescription:\r\nRunspace state changed to Opening\r\nEvent Xml:\r\n<Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\r\n  <System>\r\n    <Provider Name=\"PowerShellCore\" Guid=\"{f90714a8-5509-434a-bf6d-b1624c8a19a2}\" />\r\n    <EventID>8197</EventID>\r\n    <Version>1</Version>\r\n    <Level>5</Level>\r\n    <Task>1</Task>\r\n    <Opcode>10</Opcode>\r\n    <Keywords>0x0</Keywords>\r\n    <TimeCreated SystemTime=\"2022-05-17T20:36:36.7011496Z\" />\r\n    <EventRecordID>428262</EventRecordID>\r\n    <Correlation ActivityID=\"{e3e592f7-c42e-4002-aff6-f1885ab8923a}\" />\r\n    <Execution ProcessID=\"4056\" ThreadID=\"6764\" />\r\n    <Channel>PowerShellCore/Operational</Channel>\r\n    <Computer>server.mydomain.com</Computer>\r\n    <Security UserID=\"S-1-5-21-2147491999-1103789872-2603493700-327614\" />\r\n  </System>\r\n  <EventData>\r\n    <Data Name=\"param1\">Opening</Data>\r\n  </EventData>\r\n</Event>\r\n\r\nLog Name:      PowerShellCore/Operational\r\nSource:        PowerShellCore\r\nDate:          5/17/2022 4:36:36 PM\r\nEvent ID:      8195\r\nTask Category: Connect\r\nLevel:         Verbose\r\nKeywords:      None\r\nUser:          CONTOSO\\my-adm\r\nComputer:      server.mydomain.com\r\nDescription:\r\nOpening RunspacePool\r\nEvent Xml:\r\n<Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\r\n  <System>\r\n    <Provider Name=\"PowerShellCore\" Guid=\"{f90714a8-5509-434a-bf6d-b1624c8a19a2}\" />\r\n    <EventID>8195</EventID>\r\n    <Version>1</Version>\r\n    <Level>5</Level>\r\n    <Task>1</Task>\r\n    <Opcode>10</Opcode>\r\n    <Keywords>0x0</Keywords>\r\n    <TimeCreated SystemTime=\"2022-05-17T20:36:36.7010924Z\" />\r\n    <EventRecordID>428261</EventRecordID>\r\n    <Correlation ActivityID=\"{e3e592f7-c42e-4002-aff6-f1885ab8923a}\" />\r\n    <Execution ProcessID=\"4056\" ThreadID=\"6764\" />\r\n    <Channel>PowerShellCore/Operational</Channel>\r\n    <Computer>server.mydomain.com</Computer>\r\n    <Security UserID=\"S-1-5-21-2147491999-1103789872-2603493700-327614\" />\r\n  </System>\r\n  <EventData>\r\n  </EventData>\r\n</Event>\r\n\r\nLog Name:      PowerShellCore/Operational\r\nSource:        PowerShellCore\r\nDate:          5/17/2022 4:36:36 PM\r\nEvent ID:      8194\r\nTask Category: Connect\r\nLevel:         Verbose\r\nKeywords:      None\r\nUser:          CONTOSO\\my-adm\r\nComputer:      server.mydomain.com\r\nDescription:\r\nCreating RunspacePool object \r\n \t InstanceId e3e592f7-c42e-4002-aff6-f1885ab8923a \r\n \t MinRunspaces 1 \r\n \t MaxRunspaces 1\r\nEvent Xml:\r\n<Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\r\n  <System>\r\n    <Provider Name=\"PowerShellCore\" Guid=\"{f90714a8-5509-434a-bf6d-b1624c8a19a2}\" />\r\n    <EventID>8194</EventID>\r\n    <Version>1</Version>\r\n    <Level>5</Level>\r\n    <Task>1</Task>\r\n    <Opcode>16</Opcode>\r\n    <Keywords>0x0</Keywords>\r\n    <TimeCreated SystemTime=\"2022-05-17T20:36:36.7005569Z\" />\r\n    <EventRecordID>428260</EventRecordID>\r\n    <Correlation ActivityID=\"{e3e592f7-c42e-4002-aff6-f1885ab8923a}\" />\r\n    <Execution ProcessID=\"4056\" ThreadID=\"6764\" />\r\n    <Channel>PowerShellCore/Operational</Channel>\r\n    <Computer>server.mydomain.com</Computer>\r\n    <Security UserID=\"S-1-5-21-2147491999-1103789872-2603493700-327614\" />\r\n  </System>\r\n  <EventData>\r\n    <Data Name=\"InstanceId\">e3e592f7-c42e-4002-aff6-f1885ab8923a</Data>\r\n    <Data Name=\"MaxRunspaces\">1</Data>\r\n    <Data Name=\"MinRunspaces\">1</Data>\r\n  </EventData>\r\n</Event>\r\n\r\nLog Name:      PowerShellCore/Operational\r\nSource:        PowerShellCore\r\nDate:          5/17/2022 4:36:36 PM\r\nEvent ID:      8193\r\nTask Category: Connect\r\nLevel:         Verbose\r\nKeywords:      None\r\nUser:          CONTOSO\\my-adm\r\nComputer:      server.mydomain.com\r\nDescription:\r\nCreating Runspace object \r\n \t Instance Id: e3a8b992-3755-491f-85cd-c4425679dd64\r\nEvent Xml:\r\n<Event xmlns=\"http://schemas.microsoft.com/win/2004/08/events/event\">\r\n  <System>\r\n    <Provider Name=\"PowerShellCore\" Guid=\"{f90714a8-5509-434a-bf6d-b1624c8a19a2}\" />\r\n    <EventID>8193</EventID>\r\n    <Version>1</Version>\r\n    <Level>5</Level>\r\n    <Task>1</Task>\r\n    <Opcode>16</Opcode>\r\n    <Keywords>0x0</Keywords>\r\n    <TimeCreated SystemTime=\"2022-05-17T20:36:36.7005390Z\" />\r\n    <EventRecordID>428259</EventRecordID>\r\n    <Correlation ActivityID=\"{e3a8b992-3755-491f-85cd-c4425679dd64}\" />\r\n    <Execution ProcessID=\"4056\" ThreadID=\"6764\" />\r\n    <Channel>PowerShellCore/Operational</Channel>\r\n    <Computer>server.mydomain.com</Computer>\r\n    <Security UserID=\"S-1-5-21-2147491999-1103789872-2603493700-327614\" />\r\n  </System>\r\n  <EventData>\r\n    <Data Name=\"param1\">e3a8b992-3755-491f-85cd-c4425679dd64</Data>\r\n  </EventData>\r\n</Event>\n```\n\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.4\r\nPSEdition                      Core\r\nGitCommitId                    7.2.4\r\nOS                             Microsoft Windows 10.0.20348\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n![Screenshot 2022-05-17 171359](https://user-images.githubusercontent.com/48156975/168911765-c77baffa-23be-43c8-84bf-46eb11952d92.png)\r\n",
  "closed_at": null,
  "comments": [
    {
      "author": "marcgoff",
      "author_association": "NONE",
      "body": "It also fails with PowerShell 7.0.11.",
      "created_at": "2022-05-18T18:24:13Z",
      "updated_at": "2022-05-18T18:24:13Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@marcgoff At first I thought this could be issue #17112.  But this problem only occurs on `7.3.0-preview` versions since that is when the 'clean block' experimental feature was added.  I am not able to repro this problem, but then I am not sure what steps you are taking to create the JEA endpoint.  Can you provide a simple repro that doesn't include any sensitive information?  Do you see this problem when you create the JEA configuration endpoint on the same local machine, and then connect to it?  Please provide repro steps.\r\n",
      "created_at": "2022-05-19T21:02:19Z",
      "updated_at": "2022-05-19T21:02:19Z"
    },
    {
      "author": "marcgoff",
      "author_association": "NONE",
      "body": "[JEA_Git_Issue-17367.zip](https://github.com/PowerShell/PowerShell/files/8758994/JEA_Git_Issue-17367.zip)\r\n@PaulHigin I've included a sanitized copy of the module and JEA config. I am using an AD group managed service account for this JEA config.\r\n\r\nI do see the issue if I create the JEA configuration endpoint on the same local machine, and then connect to it. The event logs seem to indicate it is a registration time problem, not a connectivity issue where local vs not would be an issue. ",
      "created_at": "2022-05-24T01:57:29Z",
      "updated_at": "2022-05-24T01:57:29Z"
    },
    {
      "author": "marcgoff",
      "author_association": "NONE",
      "body": "Adding the note about using a group managed service account made me think to try using a virtual account. The JEA configuration registered correctly when I did that. Switching it back to the gmsa caused the registration to fail again. Of course I can go back to 7.2.1 and it will register fine with the gmsa. I know 7.2.2 was a security related update. Was there a change that would cause gmsa accounts to no longer work? ",
      "created_at": "2022-05-24T02:03:46Z",
      "updated_at": "2022-05-24T02:03:46Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "I am not aware of any changes in PowerShell core that would affect remoting endpoint GMSA accounts.  There were no significant changes in remoting between 7.2.1 and 7.2.2, the primary change being upgraded dotNet binaries.  But the fact that GMSA remoting endpoints worked in 7.2.1 but not 7.2.2 is concerning, and I wonder if a change in dotNet may have caused the problem.\r\n\r\nThe endpoint failure appears to be when the JEA endpoint is being instantiated (e.g., New-PSSession -cn . -config myJEA).\r\nThis is done at the WSMan layer, and the WSMan team should look at it.\r\n`WSMan reported an error with error code: -1605106704.`\r\n\r\n@marcgoff I will try to contact someone on the WSMan team, but it might help if you contacted Microsoft customer support and created a ticket for this.",
      "created_at": "2022-05-24T22:15:49Z",
      "updated_at": "2022-05-24T22:15:49Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "I spoke with a WSMan team member and he thought this error was coming from the provider plugin.  I'll take a look at that next.",
      "created_at": "2022-05-25T00:26:48Z",
      "updated_at": "2022-05-25T00:26:48Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "@marcgoff  The logs show that the failure occurs when the endpoint is used, not registered.  But above, you say that the endpoint registration fails.  Please clarify this and include exact steps you take when registering the jea endpoint, and what error(s) you get that indicate the registration fails.",
      "created_at": "2022-05-25T15:50:20Z",
      "updated_at": "2022-05-25T15:50:20Z"
    },
    {
      "author": "marcgoff",
      "author_association": "NONE",
      "body": "The event log entries I added happen when I register the jea endpoint. The one I copy below does mention connecting to the localhost, but this action happens when registering and doesn't show up when I register it on 7.2.1.\r\n\r\n```\r\nLog Name:      PowerShellCore/Operational\r\nSource:        PowerShellCore\r\nDate:          5/17/2022 4:36:36 PM\r\nEvent ID:      32784\r\nTask Category: None\r\nLevel:         Error\r\nKeywords:      None\r\nUser:          CONTOSO\\my-adm\r\nComputer:      server.mydomain.com\r\nDescription:\r\nRunspace Id: e3e592f7-c42e-4002-aff6-f1885ab8923a Pipeline Id: 00000000-0000-0000-0000-000000000000. WSMan reported an error with error code: -1605106704. \r\n Error message: Connecting to remote server localhost failed with the following error message : <f:WSManFault xmlns:f=\"http://schemas.microsoft.com/wbem/wsman/1/wsmanfault\" Code=\"2689860592\" Machine=\"localhost\"><f:Message><f:ProviderFault provider=\"UMS-CM-JEA\" path=\"C:\\Windows\\system32\\PowerShell\\7.2.4\\pwrshplugin.dll\"></f:ProviderFault></f:Message></f:WSManFault> For more information, see the about_Remote_Troubleshooting Help topic. \r\n StackTrace: \r\n\r\n```",
      "created_at": "2022-05-25T18:52:18Z",
      "updated_at": "2022-05-25T18:52:18Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "That log entry may be a bit of a red herring.  `Register-PSSessionConfiguration` tries to connect to the new endpoint using implicit credentials, which may not work in all cases.\r\n\r\n- What error do you get when you run `Register-PSSessionConfiguration`, if any?\r\n- If registering gives no errors, do you see the endpoint when your run `Get-PSSessionConfiguration`?\r\n- What error do you get when you try to connect to the endpoint (assuming it is created)?\r\n\r\nAlso, when you are testing the endpoint on the same machine, and the connection does work, so you see a blank console window displayed while the remote connection exists (title: 'c:\\WINDOWS\\system32\\wsmprovhost.exe)?\r\n\r\nThe only recent change to the remoting endpoint plugin, is that it now always allocates a console (side effect you see a blank console window on the endpoint machine: https://github.com/PowerShell/PowerShell/issues/16763), and I am wondering if this may be causing the problem with GMSA accounts.",
      "created_at": "2022-05-25T20:13:22Z",
      "updated_at": "2022-05-25T20:13:22Z"
    },
    {
      "author": "marcgoff",
      "author_association": "NONE",
      "body": "There is no error on the console when I run the Register-PSSessionConfiguration on 7.2.2+, just the 3278 error event in the event log. It does not show me the warning that some of my modules use unapproved verbs like it does under 7.2.1.\r\n\r\nI do see the endpoint after registering, but it is missing all the gMSA stuff and looks very different.  \r\n\r\nHere is the 7.2.1 successful session config:\r\n`# ums-cm-jea Session Configuration 7.2.1\r\nPS C:\\Program Files\\PowerShell\\Modules\\UMS-CM-JEA\\0.113> Get-PSSessionConfiguration ums-cm-jea | select *\r\n\r\nGroupManagedServiceAccount    : CONTOSO\\gMSA-CM-JEA\r\nRoleDefinitions               : {CONTOSO\\gMSA-CM-JEA$, CONTOSO\\UMS-CMTSAutomation, CONTOSO\\CM-JEA-Gitrunner}\r\nCopyright                     : (c) 2022. All rights reserved.\r\nLanguageMode                  : NoLanguage\r\nExecutionPolicy               : AllSigned\r\nCompanyName                   : \r\nAliasDefinitions              : {Name, Value}\r\nAuthor                        : marc.goff\r\nSchemaVersion                 : 2.0.0.0\r\nGUID                          : 5ee9e3a5-431f-48ab-8fee-a62e6d5b5314\r\nSessionType                   : RestrictedRemoteServer\r\nTranscriptDirectory           : D:\\ProgramData\\JEAConfiguration\\Transcripts\\\r\nProcessIdleTimeoutSec         : 0\r\nSupportsOptions               : true\r\nOutputBufferingMode           : Block\r\nMaxShells                     : 2147483647\r\nAutoRestart                   : false\r\nMaxProcessesPerShell          : 2147483647\r\nRunAsPassword                 : System.Security.SecureString\r\nxmlns                         : http://schemas.microsoft.com/wbem/wsman/1/config/PluginConfiguration\r\nExactMatch                    : False\r\nXmlRenderingType              : text\r\nMaxMemoryPerShellMB           : 2147483647\r\nEnabled                       : True\r\nSecurityDescriptorSddl        : O:NSG:BAD:P(A;;GA;;;S-1-5-21-2147491999-1103789872-2603493700-495653)(A;;GA;;;S-1-5-21-2147491999-1103789872\r\n                                -2603493700-530175)(A;;GA;;;S-1-5-21-2147491999-1103789872-2603493700-530176)S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;\r\n                                ;WD)\r\nSDKVersion                    : 2\r\nArchitecture                  : 64\r\nRunAsUser                     : CONTOSO\\gMSA-CM-JEA$\r\nCapability                    : {Shell}\r\nMaxConcurrentCommandsPerShell : 2147483647\r\nParentResourceUri             : http://schemas.microsoft.com/powershell/UMS-CM-JEA\r\nName                          : UMS-CM-JEA\r\nRunAsVirtualAccount           : false\r\nMaxIdleTimeoutms              : 2147483647\r\nUseSharedProcess              : false\r\nIdleTimeoutms                 : 7200000\r\nlang                          : en-US\r\nPSVersion                     : 7.2\r\nUri                           : http://schemas.microsoft.com/powershell/UMS-CM-JEA\r\nResourceUri                   : http://schemas.microsoft.com/powershell/UMS-CM-JEA\r\nMaxConcurrentUsers            : 2147483647\r\nConfigFilePath                : C:\\Program Files\\PowerShell\\7\\SessionConfig\\UMS-CM-JEA_5ee9e3a5-431f-48ab-8fee-a62e6d5b5314.pssc\r\nMaxShellsPerUser              : 2147483647\r\nRunAsVirtualAccountGroups     :\r\nFilename                      : %windir%\\system32\\PowerShell\\7.2.1\\pwrshplugin.dll\r\nPermission                    : CONTOSO\\UMS-CMTSAutomation AccessAllowed, CONTOSO\\gMSA-CM-JEA$ AccessAllowed, CONTOSO\\CM-JEA-Gitrunner\r\n                                AccessAllowed\r\n`\r\n\r\nHere is the unsuccessful 7.2.2 session:\r\n\r\n`# ums-cm-jea Session Configuration 7.2.2\r\nPS C:\\Program Files\\PowerShell\\Modules\\UMS-CM-JEA\\0.113> Get-PSSessionConfiguration ums-cm-jea | select *\r\n\r\nRoleDefinitions               : {CONTOSO\\CM-JEA-Gitrunner, CONTOSO\\UMS-CMTSAutomation, CONTOSO\\gMSA-CM-JEA$}\r\nCopyright                     : (c) 2022. All rights reserved.\r\nLanguageMode                  : NoLanguage\r\nGUID                          : 5ee9e3a5-431f-48ab-8fee-a62e6d5b5314\r\nTranscriptDirectory           : D:\\ProgramData\\JEAConfiguration\\Transcripts\\\r\nCompanyName                   : \r\nSessionType                   : RestrictedRemoteServer\r\nAuthor                        : marc.goff\r\nSchemaVersion                 : 2.0.0.0\r\nAliasDefinitions              : {Name, Value}\r\nExecutionPolicy               : AllSigned\r\nGroupManagedServiceAccount    : CONTOSO\\gMSA-CM-JEA\r\nRunAsUser                     : CONTOSO\\gMSA-CM-JEA$\r\nResourceUri                   : http://schemas.microsoft.com/powershell/UMS-CM-JEA\r\nMaxProcessesPerShell          : 2147483647\r\nRunAsPassword                 : System.Security.SecureString\r\nSDKVersion                    : 2\r\nlang                          : en-US\r\nUseSharedProcess              : false\r\nArchitecture                  : 64\r\nMaxMemoryPerShellMB           : 2147483647\r\nPSVersion                     : 7.2\r\nProcessIdleTimeoutSec         : 0\r\nMaxShellsPerUser              : 2147483647\r\nOutputBufferingMode           : Block\r\nUri                           : http://schemas.microsoft.com/powershell/UMS-CM-JEA\r\nSupportsOptions               : true\r\nCapability                    : {Shell}\r\nIdleTimeoutms                 : 7200000\r\nxmlns                         : http://schemas.microsoft.com/wbem/wsman/1/config/PluginConfiguration\r\nExactMatch                    : False\r\nName                          : UMS-CM-JEA\r\nMaxConcurrentCommandsPerShell : 2147483647\r\nParentResourceUri             : http://schemas.microsoft.com/powershell/UMS-CM-JEA\r\nSecurityDescriptorSddl        : O:NSG:BAD:P(A;;GA;;;S-1-5-21-2147491999-1103789872-2603493700-495653)(A;;GA;;;S-1-5-21-\r\n                                2147491999-1103789872-2603493700-530175)(A;;GA;;;S-1-5-21-2147491999-1103789872-2603493\r\n                                700-530176)S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)\r\nMaxShells                     : 2147483647\r\nXmlRenderingType              : text\r\nEnabled                       : True\r\nMaxIdleTimeoutms              : 2147483647\r\nMaxConcurrentUsers            : 2147483647\r\nAutoRestart                   : false\r\nConfigFilePath                : C:\\Program\r\n                                Files\\PowerShell\\7\\SessionConfig\\UMS-CM-JEA_5ee9e3a5-431f-48ab-8fee-a62e6d5b5314.pssc\r\nRunAsVirtualAccount           : false\r\nRunAsVirtualAccountGroups     :\r\nFilename                      : %windir%\\system32\\PowerShell\\7.2.2\\pwrshplugin.dll\r\nPermission                    : CONTOSO\\UMS-CMTSAutomation AccessAllowed, CONTOSO\\gMSA-CM-JEA$ AccessAllowed,\r\n                                CONTOSO\\CM-JEA-Gitrunner AccessAllowed\r\n`\r\nThe error on connection is this one:\r\n\r\n`etsn : Connecting to remote server cmjea.mydomain.com failed with the following error message : <f:WSManFault\r\nxmlns:f=\"http://schemas.microsoft.com/wbem/wsman/1/wsmanfault\" Code=\"2689860592\"\r\nMachine=\"cmjea.mydomain.com\"><f:Message><f:ProviderFault provider=\"UMS-CM-JEA\"\r\npath=\"C:\\Windows\\system32\\PowerShell\\7.2.4\\pwrshplugin.dll\"></f:ProviderFault></f:Message></f:WSManFault> For more\r\ninformation, see the about_Remote_Troubleshooting Help topic.\r\nAt line:1 char:1\r\n+ etsn cmjea.$env:USERDNSDOMAIN -ConfigurationName ums-cm-jea -UseSSL\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : InvalidArgument: (cmjea.mydomain.com:String) [Enter-PSSession], PSRemotingTransport\r\n   Exception\r\n    + FullyQualifiedErrorId : CreateRemoteRunspaceFailed`\r\n\r\nWhen I create the session configuration under 7.2.1 I do not see a blank console window running c:\\WINDOWS\\system32\\wsmprovhost.exe, but I do see that process in taskmgr running as the gMSA account.\r\n\n\n<blockquote></blockquote>\n<blockquote></blockquote>\n<blockquote></blockquote>",
      "created_at": "2022-05-25T21:27:45Z",
      "updated_at": "2022-05-25T21:27:47Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "The two configurations are actually the same, but since they are stored as hashtable the order of items is different.  When I sort the items to be ordered the same, there is only one difference, they are using different plugin binaries:\r\n\r\n```powershell\r\nFilename : %windir%\\system32\\PowerShell\\7.2.1\\pwrshplugin.dll\r\nFilename : %windir%\\system32\\PowerShell\\7.2.2\\pwrshplugin.dll\r\n```\r\n@marcgoff  Can you try saving a copy of the `7.2.2` `pwrshplugin.dll` binary and replacing it the `7.2.1` `pwrshplugin.dll` binary, and then try creating the connection with the `7.2.2` PowerShell version again?\r\n\r\n",
      "created_at": "2022-05-25T23:18:53Z",
      "updated_at": "2022-05-25T23:18:53Z"
    },
    {
      "author": "marcgoff",
      "author_association": "NONE",
      "body": "Thanks for your help with this Paul.\r\nSorry, I didn't think to sort the session config hashtable. I guess I was too excited that I might have found a lead.\r\n\r\nThose dlls have the exact same file hash, so I don't think that is the issue:\r\nAlgorithm       Hash                                                                   Path\r\n---------       ----                                                                   ----\r\nSHA256          88892B5D0BD5F2C53A4F42A35404085C64ED1DE34FA1459708D52B3A7A799E40       C:\\Windows\\system32\\PowerShell\\7.2.1\\pwrshplugin.dll\r\n\r\nAlgorithm       Hash                                                                   Path\r\n---------       ----                                                                   ----\r\nSHA256          88892B5D0BD5F2C53A4F42A35404085C64ED1DE34FA1459708D52B3A7A799E40       C:\\Windows\\system32\\PowerShell\\7.2.3\\pwrshplugin.dll",
      "created_at": "2022-05-26T14:46:51Z",
      "updated_at": "2022-05-26T14:46:51Z"
    },
    {
      "author": "marcgoff",
      "author_association": "NONE",
      "body": "In setting up a fresh install to test this out with, I jogged my memory on what this issue relates to. When I originally set this up, I did not want the gMSA account to be a member of the local administrators group for security reasons. If it wasn't in the administrators group then the registration would fail. Somehow I finally found out that it needs to have write rights to the \"C:\\Windows\\System32\\Powershell\\7.2.1\" folder (my version at the time) for some reason. When I setup the CI/CD process I hard coded the path to that version rather than get the current version in code. When I granted that user the write rights to \"C:\\Windows\\System32\\Powershell\\7.2.4\" it worked again.\r\n\r\nNow that my memory has been jogged, I remember thinking at the time that I should create an issue here to figure out why the account needs write access to that folder. I add the gMSA to the users group so the account can read that folder with no issues. I had to add write for the registration to work.\r\n\r\nI have added the following to my CI/CD code to resolve my current issues:\r\n\r\n$Path=$env:SystemRoot+\"\\system32\\PowerShell\\\"+($PSVersionTable).PSVersion.ToString()\r\n$foldacl = Get-Acl $Path\r\n$newacl = New-Object system.security.accesscontrol.filesystemaccessrule(\"$env:USERDOMAIN\\$gMSA_Name`$\",\"Write, ReadAndExecute, Synchronize\", \"ContainerInherit, ObjectInherit\", \"None\", \"Allow\")\r\n$foldacl.SetAccessRule($newacl)\r\nSet-Acl -Path $Path -AclObject $foldacl\r\n",
      "created_at": "2022-05-26T19:53:25Z",
      "updated_at": "2022-05-26T19:54:26Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "Ok, thanks for the update.  The `C:\\Windows\\System32\\Powershell\\7.2.4` path needs to be writeable because that is where the configuration information, which the remote plugin needs, is stored.",
      "created_at": "2022-05-26T22:35:31Z",
      "updated_at": "2022-05-26T22:35:31Z"
    },
    {
      "author": "marcgoff",
      "author_association": "NONE",
      "body": "It seems like it has to always be writeable, not just during the session registration. As soon as I take the ACL away, I can no longer connect to that configuration. If I add the ACL back in it works again. No need to re-register the config or restart WinRM.\r\n\r\nIt seems like a strange requirement since there are only two files in the folder that don't ever get updated when a session connects, pwrshplugin.dll and RemotePowerShellConfig.txt. The text file hasn't been touched since the initial install of 7.2.4 9 days ago. What is it writing to this folder?\r\n\r\nHaving to use an admin account as the JEA user seems like an odd choice for a service like JEA that is supposed to be about limiting your security posture.",
      "created_at": "2022-05-27T02:04:51Z",
      "updated_at": "2022-05-27T02:09:39Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "Yeah, this doesn't seem right to me.  The decision to do this at `Enable-PSSession` runtime was made long ago and I am not sure it was fully thought through.  But it seems to me that this should be an install time write.  Adding maintainers.",
      "created_at": "2022-06-06T18:08:32Z",
      "updated_at": "2022-06-06T18:08:32Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "Maintainers discussed this issue. The RemotePowerShellConfig.txt cannot be dropped during installation as it contains dynamic content. We need to find a new way to update this information during runtime.",
      "created_at": "2022-06-07T20:02:39Z",
      "updated_at": "2022-06-07T20:02:39Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "Leaving the `Area-Maintainers-Build` label, because it seems wrong to place the PowerShell Core pwrshplugin.dll file in the system32 directory.  We need to look at changing build/install to place it in the normal publish location and update the endpoint xml config information to reflect that.",
      "created_at": "2022-06-07T20:06:04Z",
      "updated_at": "2022-06-07T20:06:04Z"
    },
    {
      "author": "PaulHigin",
      "author_association": "COLLABORATOR",
      "body": "MSIX does not support placing dynamically created files (such as 'RemotePowerShellConfig.txt') during installation.  So I think we are going to have to find some other location for this file during runtime.",
      "created_at": "2022-06-13T17:02:23Z",
      "updated_at": "2022-06-13T17:02:23Z"
    }
  ],
  "created_at": "2022-05-17T21:19:15Z",
  "number": 17367,
  "state": "open",
  "title": "JEA session configuration breaks after upgrading past 7.2.1",
  "updated_at": "2022-06-22T15:27:57Z"
}