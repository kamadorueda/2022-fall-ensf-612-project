{
  "_url": "https://github.com/PowerShell/PowerShell/issues/17627",
  "author": "ili101",
  "body": "### Prerequisites\r\n\r\n- [X] Write a descriptive title.\r\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\r\n- [X] Search the existing issues.\r\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\r\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\r\n\r\n### Steps to reproduce\r\n\r\n```pwsh\r\n$DataTable = [Data.DataTable]::new()\r\n$null = $DataTable.Columns.Add('Date', [DateTime])\r\n$Date = Get-Date\r\n$Row = $DataTable.Rows.Add($Date)\r\n\r\n$Row.Date = $Date # Error\r\n$Row['Date'] = $Date # Error\r\n$Row.Item('Date') = $Date # Works\r\n$Row.Date = [DateTime]$Date # Works\r\n```\r\n\r\nLast working versions \"PowerShell-7.2.0-preview.1\" and \"PowerShell-7.1.7\".\r\nFirst impacted version \"PowerShell-7.2.0-preview.2\".\r\n\r\n### Expected behavior\r\n\r\n`$Row.Date = $Date` will put the DateTime object in the DateTime column.\r\n\r\n\r\n### Actual behavior\r\n\r\nSetValueInvocationException: Exception setting \"Date\": \"Unable to cast object of type 'System.Management.Automation.PSObject' to type 'System.IConvertible'.Couldn't store <04/07/2022 19:42:04> in Date Column.  Expected type is DateTime.\"\r\n\r\n\r\n### Error details\r\n\r\n```console\r\nException             :\r\n    Type           : System.Management.Automation.SetValueInvocationException\r\n    ErrorRecord    :\r\n        Exception             :\r\n            Type    : System.Management.Automation.ParentContainsErrorRecordException\r\n            Message : Exception setting \"Date\": \"Unable to cast object of type 'System.Management.Automation.PSObject' to type 'System.IConvertible'.Couldn't store <04/07/2022\r\n19:58:39> in Date Column.  Expected type is DateTime.\"\r\n            HResult : -2146233087\r\n        CategoryInfo          : NotSpecified: (:) [], ParentContainsErrorRecordException\r\n        FullyQualifiedErrorId : CatchFromBaseAdapterSetValue\r\n        InvocationInfo        :\r\n            ScriptLineNumber : 5\r\n            OffsetInLine     : 1\r\n            HistoryId        : -1\r\n            ScriptName       : C:\\Users\\illym\\Desktop\\Temp\\PBug.ps1\r\n            Line             : $Row.Date = $Date\r\n            PositionMessage  : At C:\\Users\\illym\\Desktop\\Temp\\PBug.ps1:5 char:1\r\n                               + $Row.Date = $Date\r\n                               + ~~~~~~~~~~~~~~~~~\r\n            PSScriptRoot     : C:\\Users\\illym\\Desktop\\Temp\r\n            PSCommandPath    : C:\\Users\\illym\\Desktop\\Temp\\PBug.ps1\r\n            CommandOrigin    : Internal\r\n        ScriptStackTrace      : at <ScriptBlock>, C:\\Users\\illym\\Desktop\\Temp\\PBug.ps1: line 5\r\n                                at <ScriptBlock>, <No file>: line 1\r\n    TargetSite     :\r\n        Name          : BasePropertySet\r\n        DeclaringType : System.Management.Automation.Adapter, System.Management.Automation, Version=7.3.0.5, Culture=neutral, PublicKeyToken=31bf3856ad364e35\r\n        MemberType    : Method\r\n        Module        : System.Management.Automation.dll\r\n    Message        : Exception setting \"Date\": \"Unable to cast object of type 'System.Management.Automation.PSObject' to type 'System.IConvertible'.Couldn't store <04/07/2022\r\n19:58:39> in Date Column.  Expected type is DateTime.\"\r\n    Data           : System.Collections.ListDictionaryInternal\r\n    InnerException :\r\n        Type           : System.ArgumentException\r\n        Message        : Unable to cast object of type 'System.Management.Automation.PSObject' to type 'System.IConvertible'.Couldn't store <04/07/2022 19:58:39> in Date Column.\r\nExpected type is DateTime.\r\n        TargetSite     :\r\n            Name          : set_Item\r\n            DeclaringType : System.Data.DataColumn\r\n            MemberType    : Method\r\n            Module        : System.Data.Common.dll\r\n        InnerException :\r\n            Type       : System.InvalidCastException\r\n            TargetSite :\r\n                Name          : ChkCast_Helper\r\n                DeclaringType : System.Runtime.CompilerServices.CastHelpers, System.Private.CoreLib, Version=7.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\r\n                MemberType    : Method\r\n                Module        : System.Private.CoreLib.dll\r\n            Message    : Unable to cast object of type 'System.Management.Automation.PSObject' to type 'System.IConvertible'.\r\n            Source     : System.Private.CoreLib\r\n            HResult    : -2147467262\r\n            StackTrace :\r\n   at System.Data.Common.DateTimeStorage.Set(Int32 record, Object value)\r\n   at System.Data.DataColumn.set_Item(Int32 record, Object value)\r\n        Source         : System.Data.Common\r\n        HResult        : -2147024809\r\n        StackTrace     :\r\n   at System.Data.DataColumn.set_Item(Int32 record, Object value)\r\n   at System.Data.DataRow.set_Item(DataColumn column, Object value)\r\n   at System.Management.Automation.DataRowAdapter.PropertySet(PSProperty property, Object setValue, Boolean convertIfPossible)\r\n   at System.Management.Automation.Adapter.BasePropertySet(PSProperty property, Object setValue, Boolean convert)\r\n    Source         : System.Management.Automation\r\n    HResult        : -2146233087\r\n    StackTrace     :\r\n   at System.Management.Automation.Adapter.BasePropertySet(PSProperty property, Object setValue, Boolean convert)\r\n   at System.Management.Automation.PSProperty.SetAdaptedValue(Object setValue, Boolean shouldConvert)\r\n   at System.Management.Automation.PSProperty.set_Value(Object value)\r\n   at System.Management.Automation.Language.PSSetMemberBinder.SetAdaptedValue(Object obj, String member, Object value)\r\n   at System.Dynamic.UpdateDelegates.UpdateAndExecute2[T0,T1,TRet](CallSite site, T0 arg0, T1 arg1)\r\n   at System.Management.Automation.Interpreter.DynamicInstruction`3.Run(InterpretedFrame frame)\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\r\nCategoryInfo          : NotSpecified: (:) [], SetValueInvocationException\r\nFullyQualifiedErrorId : CatchFromBaseAdapterSetValue\r\nInvocationInfo        :\r\n    ScriptLineNumber : 5\r\n    OffsetInLine     : 1\r\n    HistoryId        : -1\r\n    ScriptName       : C:\\Users\\illym\\Desktop\\Temp\\PBug.ps1\r\n    Line             : $Row.Date = $Date\r\n    PositionMessage  : At C:\\Users\\illym\\Desktop\\Temp\\PBug.ps1:5 char:1\r\n                       + $Row.Date = $Date\r\n                       + ~~~~~~~~~~~~~~~~~\r\n    PSScriptRoot     : C:\\Users\\illym\\Desktop\\Temp\r\n    PSCommandPath    : C:\\Users\\illym\\Desktop\\Temp\\PBug.ps1\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, C:\\Users\\illym\\Desktop\\Temp\\PBug.ps1: line 5\r\n                        at <ScriptBlock>, <No file>: line 1\r\n```",
  "closed_at": null,
  "comments": [
    {
      "author": "fMichaleczek",
      "author_association": "NONE",
      "body": "The problem is about the DataRowAdapter :\r\n\r\n**datetime object OK**\r\n```\r\n$netNow = [datetime]::Now\r\n\r\n$dataTable = [System.Data.DataTable]::new()\r\n$col = $dataTable.Columns.Add('Date', [DateTime])\r\n$row = $dataTable.Rows.Add($netNow)\r\n$row.Date = $netNow # Works on PS5.1 and PS7.2\r\n```\r\n\r\n**Get-Date Command KO**\r\n```\r\n$psNow = Get-Date\r\n$dataTable = [System.Data.DataTable]::new()\r\n$col = $dataTable.Columns.Add('Date', [DateTime])\r\n$row = $dataTable.Rows.Add($psNow)\r\n$row.Date = $psNow # Works on PS5.1, Failed on PS7.2\r\n\r\n# SetValueInvocationException: Exception setting \"Date\": \"Unable to cast object of type 'System.Management.Automation.PSObject' to type 'System.IConvertible'.\r\n# Couldn't store <7/5/2022 03:36:38> in Date Column.  Expected type is DateTime.\"\r\n```\r\n\r\n**DirectoryInfo object OK**\r\n```\r\n$netDir = [System.IO.DirectoryInfo]$PSHome\r\n\r\n$dataTable = [System.Data.DataTable]::new()\r\n$col = $dataTable.Columns.Add('Dir', [System.IO.DirectoryInfo])\r\n$row = $dataTable.Rows.Add($netDir)\r\n$row.Dir = $netDir # Works on PS5.1 and PS7.2\r\n```\r\n\r\n**Get-Item -Directory KO**\r\n```\r\n$psDir = Get-Item $PSHome\r\n\r\n$dataTable = [System.Data.DataTable]::new()\r\n$col = $dataTable.Columns.Add('Dir', [System.IO.DirectoryInfo])\r\n$row = $dataTable.Rows.Add($psDir)\r\n$row.Dir = $psDir # Failed on PS5.1 and PS7.2\r\n\r\n# SetValueInvocationException: Exception setting \"Dir\": \"Type of value has a mismatch with column typeCouldn't store <C:\\Program Files\\PowerShell\\7> in Dir Column.  \r\n# Expected type is DirectoryInfo.\"\r\n```\r\n\r\nI patch DataRowAdapter and it resolve all previous cases (I'm not sure it should be corrected here). \r\n\r\n```\r\nnamespace System.Management.Automation\r\n{\r\n    internal class DataRowAdapter : PropertyOnlyAdapter\r\n    {\r\n        ...\r\n        \r\n        protected override void PropertySet(PSProperty property, object setValue, bool convertIfPossible)\r\n        {\r\n            DataRow dataRow = (DataRow)property.baseObject;\r\n            // dataRow[(string)property.adapterData] = setValue;\r\n            dataRow[(string)property.adapterData] = LanguagePrimitives.ConvertTo(setValue, Type.GetType(property.TypeNameOfValue));\r\n            return;\r\n        }\r\n    }\r\n}\r\n```",
      "created_at": "2022-07-04T17:36:19Z",
      "updated_at": "2022-07-05T01:55:45Z"
    }
  ],
  "created_at": "2022-07-04T16:56:23Z",
  "number": 17627,
  "state": "open",
  "title": "Regression bug 7.2.0 - Unable to cast DateTime into DataRow DateTime column",
  "updated_at": "2022-07-21T20:54:46Z"
}