{
  "_url": "https://github.com/PowerShell/PowerShell/issues/6890",
  "author": "dantraMSFT",
  "body": "## PR Summary\r\n\r\nFix https://github.com/PowerShell/PowerShell/issues/6779 regression.\r\n\r\nThe change to disallow Basic Auth over HTTP was not checking the scheme for the -Uri parameter. The result is Basic Auth connections over HTTPS via the -Uri parameter were disallowed.\r\n\r\nThe change adds the check for the scheme as well as useSSL.\r\n\r\n## PR Checklist\r\n\r\n- [X] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [X] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [X] [Change is not breaking](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)\r\n- [X] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [X] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` to the beginning of the title and remove the prefix when the PR is ready.\r\n- **User-facing changes**\r\n    - [ ] Not Applicable\r\n    - **OR**\r\n    - [ ] User-facing [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed - Issue link:\r\n- **Testing - New and feature**\r\n    - [ ] Not Applicable or can only be tested interactively\r\n    - **OR**\r\n    - [X] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n        - [X] [Add `[feature]` if the change is significant or affects feature tests](https://github.com/PowerShell/PowerShell/blob/master/docs/testing-guidelines/testing-guidelines.md#requesting-additional-tests-for-a-pr)\r\n",
  "closed_at": "2018-06-27T22:27:42Z",
  "comments": [
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "The test failure appears to be a variation of https://github.com/Microsoft/omi/issues/502 that is not covered by the fix.\r\n\r\nThis PR cannot be merged until the libmi issue is fixed since the new test hits this path. It appears to hit sporadically in release builds and consistently in debug builds.",
      "created_at": "2018-05-18T22:11:04Z",
      "updated_at": "2018-05-18T22:18:41Z"
    },
    {
      "author": "vors",
      "author_association": "COLLABORATOR",
      "body": "Can we at least merge it without tests, since the \"Blocker\" status is applicable to the tests flakiness as far as I understand?\r\n\r\nAs @kai-h pointed out in #7054\r\n> As I see it (which may or may not be correct), one of the primary use cases for PowerShell on non-Windows systems is for administering remote Windows systems, including Azure and Office 365.\r\n\r\nInability of connecting to office 365 remoting endpoints out of the box is a pretty concerning regression and impact the number of useful scenarios for pwsh.",
      "created_at": "2018-06-17T05:25:39Z",
      "updated_at": "2018-06-17T05:25:39Z"
    },
    {
      "author": "echobb8",
      "author_association": "NONE",
      "body": "What's the status on this? I need to connect to Office 365 from my Mac, but it fails: \"New-PSSession : Basic authentication is not supported over HTTP on Unix.\" \r\n\r\nIs there a workaround? ",
      "created_at": "2018-06-20T15:38:04Z",
      "updated_at": "2018-06-20T15:38:04Z"
    },
    {
      "author": "vors",
      "author_association": "COLLABORATOR",
      "body": "> Is there a workaround?\r\n\r\nUse PS version before 6.1.0-Preview3, i.e. 6.1.0-Preview2\r\nhttps://github.com/PowerShell/PowerShell/releases",
      "created_at": "2018-06-20T16:43:56Z",
      "updated_at": "2018-06-20T16:43:56Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "I will see if I can get the PR through today with the failing test marked as pending.",
      "created_at": "2018-06-20T16:57:28Z",
      "updated_at": "2018-06-20T16:57:28Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@dantraMSFT  Can you have a look, the PR is pulling 91 commits with 498 files.",
      "created_at": "2018-06-20T19:26:43Z",
      "updated_at": "2018-06-20T19:26:43Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "I removed the blocking label and disabled the test that hits the libmi issue (https://github.com/Microsoft/omi/issues/502 )",
      "created_at": "2018-06-20T19:42:24Z",
      "updated_at": "2018-06-20T19:42:24Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@adityapatwardhan Fixed",
      "created_at": "2018-06-20T20:10:24Z",
      "updated_at": "2018-06-20T20:10:24Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "Can we please explicitly have a test to connect to Office 365, or even Azure.\r\nWe just need to test that the connection attempt succeeds, it doesn't need to be given valid credentials as long as it doesn't throw a ConnectFailed error.\r\nThe remote session can be accessed via the following Connection URI for Office 365:\r\n```PowerShell\r\n-ConnectionUri https://outlook.office365.com/powershell-liveid/\r\n```\r\nor, for your code snippet:\r\n```PowerShell\r\n$uri = \"https://outlook.office365.com/powershell-liveid/\"\r\n```",
      "created_at": "2018-06-25T21:31:42Z",
      "updated_at": "2018-06-25T21:32:20Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> Can we please explicitly have a test to connect to Office 365\r\n\r\nAll tests using external resources is unstable. :confused: and daily/night builds frequently failed.\r\n\r\nPerhaps for the cases we could have optional test set in separate job.",
      "created_at": "2018-06-26T04:13:54Z",
      "updated_at": "2018-06-26T04:13:54Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "I suppose that the main thing is that PowerShell actually attempts to connect to a remote session, be it locally or on an actual remote system.\r\nIt would be wonderful however if the testing was able to qualify that it will connect successfully to Office 365, Azure or some other Microsoft endpoint that customers will be using PowerShell to manage.",
      "created_at": "2018-06-26T06:02:17Z",
      "updated_at": "2018-06-26T06:02:17Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@kai-h I will be creating tests that verify we can successfully connect to o365 but it won't be in the nightly build.  One reason is mentioned above but the primary one, for now,  is I don't want to expose o365 account information; even if only for testing purposes.\r\n\r\nThe tests will be checked in but will likely be conditioned on a custom JSON file that is not present in the public CI builds.\r\n\r\nThat's my working plan for now. If I come up with a cleaner solution, I'll post to this thread.",
      "created_at": "2018-06-26T17:57:39Z",
      "updated_at": "2018-06-26T17:58:08Z"
    },
    {
      "author": "kai-h",
      "author_association": "NONE",
      "body": "@dantraMSFT - Thanks, I understand given the reasons above.\r\nIn my testing, I've found that it's not necessary to supply valid credentials in testing if PowerShell can connect to Office 365. Even if you're supplying invalid credentials (e.g. user@example.com with password Password123), if PowerShell can at least initiate the connection attempt to Office 365, even if Office365 says invalid username or password, this shows that PowerShell can connect, however it can't test if any remote commands can be executed.",
      "created_at": "2018-06-26T22:01:24Z",
      "updated_at": "2018-06-26T22:01:24Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@dantraMSFT  Can you respond to @SteveL-MSFT  comment.",
      "created_at": "2018-06-27T17:55:32Z",
      "updated_at": "2018-06-27T17:55:32Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@adityapatwardhan Addressed Steve's comment.",
      "created_at": "2018-06-27T19:47:42Z",
      "updated_at": "2018-06-27T19:47:42Z"
    },
    {
      "author": "dantraMSFT",
      "author_association": "CONTRIBUTOR",
      "body": "@SteveL-MSFT Hmm, that's not how I interpreted the guidelines. \r\nThat said, forcing a throw isn't testing the cmdlet the way it's normally used. Additionally, using the guideline prevents testing non-terminating errors.",
      "created_at": "2018-06-27T20:29:28Z",
      "updated_at": "2018-06-27T20:29:28Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "@dantraMSFT let's defer this to the other discussion on validating terminating vs non-terminating.  I'll approve this PR as this isn't blocking.",
      "created_at": "2018-06-27T20:53:06Z",
      "updated_at": "2018-06-27T20:53:06Z"
    }
  ],
  "created_at": "2018-05-17T19:51:46Z",
  "number": 6890,
  "state": "closed",
  "title": "Allow Basic Auth over HTTPS",
  "updated_at": "2018-08-22T16:32:28Z"
}