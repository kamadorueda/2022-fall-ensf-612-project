{
  "_url": "https://github.com/PowerShell/PowerShell/issues/5719",
  "author": "diddledani",
  "body": "Attempting to build PowerShell on Ubuntu 16.04, the build works unless I specify `-PSModuleRestore` to get the PowerShellGet module installed. When I apply that flag the build will reliably fail at the fetch of PowerShellGet from the 'net. I've tried both `master` branch and the release tag `v6.0.0-rc.2`, with the same results in both instances. When the `-PSModuleRestore` flag is not supplied, the build succeeds but without PowerShellGet available.\r\n\r\nSteps to reproduce\r\n------------------\r\n\r\nAll steps on an ubuntu machine, using LXD for clean environment. (To get LXD setup correctly run `lxd init` and accept all the default choices.)\r\n\r\n```bash\r\nlxc launch ubuntu:16.04 powershell-build\r\nlxc exec powershell-build bash\r\ngit clone https://github.com/PowerShell/PowerShell.git\r\ncd PowerShell\r\n./tools/install-powershell.sh\r\npwsh\r\n```\r\n\r\n```powershell\r\nImport-Module ./build.psm1\r\nStart-PSBootstrap\r\nStart-PSBuild -CrossGen -PSModuleRestore\r\n```\r\n\r\nExpected behavior\r\n-----------------\r\n\r\nThe build should complete successfully including the PSModuleRestore step to provide PowerShellGet modules in the final package.\r\n\r\nActual behavior\r\n---------------\r\n\r\nThe PSModules fail to be downloaded and installed.\r\n\r\n```none\r\nVERBOSE: Using configuration 'Linux'\r\nVERBOSE: Top project directory is /root/PowerShell/src/powershell-unix\r\nVERBOSE: Using framework 'netcoreapp2.0'\r\nVERBOSE: Using runtime 'linux-x64'\r\nRun dotnet publish /property:GenerateFullPaths=true --configuration Linux --framework netcoreapp2.0 --runtime linux-x64 from /root/PowerShell/src/powershell-unix\r\nMicrosoft (R) Build Engine version 15.4.8.50001 for .NET Core\r\nCopyright (C) Microsoft Corporation. All rights reserved.\r\n\r\n  Microsoft.PowerShell.CoreCLR.Eventing -> /root/PowerShell/src/Microsoft.PowerShell.CoreCLR.Eventing/bin/Linux/netcoreapp2.0/Microsoft.PowerShell.CoreCLR.Eventing.dll\r\n  System.Management.Automation -> /root/PowerShell/src/System.Management.Automation/bin/Linux/netcoreapp2.0/System.Management.Automation.dll\r\n  Microsoft.PowerShell.PSReadLine -> /root/PowerShell/src/Microsoft.PowerShell.PSReadLine/bin/Linux/netcoreapp2.0/Microsoft.PowerShell.PSReadLine.dll\r\n  Microsoft.PowerShell.ConsoleHost -> /root/PowerShell/src/Microsoft.PowerShell.ConsoleHost/bin/Linux/netcoreapp2.0/Microsoft.PowerShell.ConsoleHost.dll\r\n  Microsoft.PowerShell.Commands.Utility -> /root/PowerShell/src/Microsoft.PowerShell.Commands.Utility/bin/Linux/netcoreapp2.0/Microsoft.PowerShell.Commands.Utility.dll\r\n  Microsoft.PowerShell.Security -> /root/PowerShell/src/Microsoft.PowerShell.Security/bin/Linux/netcoreapp2.0/Microsoft.PowerShell.Security.dll\r\n  Microsoft.PowerShell.Commands.Management -> /root/PowerShell/src/Microsoft.PowerShell.Commands.Management/bin/Linux/netcoreapp2.0/Microsoft.PowerShell.Commands.Management.dll\r\n  Microsoft.PowerShell.SDK -> /root/PowerShell/src/Microsoft.PowerShell.SDK/bin/Linux/netcoreapp2.0/Microsoft.PowerShell.SDK.dll\r\n  powershell-unix -> /root/PowerShell/src/powershell-unix/bin/Linux/netcoreapp2.0/linux-x64/pwsh.dll\r\n  powershell-unix -> /root/PowerShell/src/powershell-unix/bin/Linux/netcoreapp2.0/linux-x64/publish/\r\nVERBOSE: Matched CrossGen.exe: /root/.nuget/packages/runtime.linux-x64.microsoft.netcore.app/2.0.4/tools/crossgen\r\nVERBOSE: PowerShell Ngen assemblies have been generated. Deploying ...\r\npwsh.exe with ngen binaries is available at: /root/PowerShell/src/powershell-unix/bin/Linux/netcoreapp2.0/linux-x64/publish/pwsh\r\nRestore PowerShell modules to /root/PowerShell/src/powershell-unix/bin/Linux/netcoreapp2.0/linux-x64/publish\r\nName='PowerShellGet,Microsoft.PowerShell.Archive', Destination='/root/PowerShell/src/powershell-unix/bin/Linux/netcoreapp2.0/linux-x64/publish/Modules', Repository='PSGallery'\r\nrunning save-module PowerShellGet\r\nWARNING: Administrator rights are required to install or update. Log on to the computer with an account that has Administrator rights, and then try again, or install by adding \"-Scope CurrentUser\" to your command. You can also try running the Windows PowerShell session with elevated rights (Run as Administrator).                         PackageManagement\\Save-Package : Unable to save the module 'PowerShellGet'.                                      At /opt/microsoft/powershell/6.0.0-rc.2/Modules/PowerShellGet/1.6.0/PSModule.psm1:1835 char:21                   +             $null = PackageManagement\\Save-Package @PSBoundParameters                                          +                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                          + CategoryInfo          : InvalidOperation: (Microsoft.Power...ets.SavePackage:SavePackage) [Save-Package], Exception\r\n+ FullyQualifiedErrorId : ProviderFailToDownloadFile,Microsoft.PowerShell.PackageManagement.Cmdlets.SavePackage\r\n \r\nRemove-Item : Cannot find path '/root/PowerShell/src/powershell-unix/bin/Linux/netcoreapp2.0/linux-x64/publish/Modules/PowerShellGet' because it does not exist.\r\nAt /root/PowerShell/build.psm1:2530 char:13\r\n+             Remove-Item -Path $Destination\\$($_.Name)\\*\\PSGetModuleIn ...\r\n+             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : ObjectNotFound: (/root/PowerShel...s/PowerShellGet:String) [Remove-Item], ItemNotFoundException\r\n+ FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.RemoveItemCommand\r\n \r\nrunning save-module Microsoft.PowerShell.Archive\r\nWARNING: Administrator rights are required to install or update. Log on to the computer with an account that has Administrator rights, and then try again, or install by adding \"-Scope CurrentUser\" to your command. You can also try running the Windows PowerShell session with elevated rights (Run as Administrator).                         PackageManagement\\Save-Package : Unable to save the module 'Microsoft.PowerShell.Archive'.                       At /opt/microsoft/powershell/6.0.0-rc.2/Modules/PowerShellGet/1.6.0/PSModule.psm1:1835 char:21                   \r\n+             $null = PackageManagement\\Save-Package @PSBoundParameters\r\n+                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : InvalidOperation: (Microsoft.Power...ets.SavePackage:SavePackage) [Save-Package], Exception\r\n+ FullyQualifiedErrorId : ProviderFailToDownloadFile,Microsoft.PowerShell.PackageManagement.Cmdlets.SavePackage\r\n```\r\n\r\nEnvironment data\r\n----------------\r\n\r\n```powershell\r\n> $PSVersionTable\r\n\r\nName                           Value                                                                            \r\n----                           -----                                                                            \r\nPSVersion                      6.0.0-rc.2                                                                       \r\nPSEdition                      Core                                                                             \r\nGitCommitId                    v6.0.0-rc.2                                                                      \r\nOS                             Linux 4.13.0-19-generic #22-Ubuntu SMP Mon Dec 4 11:58:07 UTC 2017               \r\nPlatform                       Unix                                                                             \r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}                                                          \r\nPSRemotingProtocolVersion      2.3                                                                              \r\nSerializationVersion           1.1.0.1                                                                          \r\nWSManStackVersion              3.0\r\n```\r\n",
  "closed_at": "2021-05-24T17:59:08Z",
  "comments": [
    {
      "author": "SydneyhSmith",
      "author_association": "CONTRIBUTOR",
      "body": "Looks like this issue is pretty old, is this still an issue with PS7?",
      "created_at": "2021-05-24T15:34:08Z",
      "updated_at": "2021-05-24T15:34:08Z"
    },
    {
      "author": "diddledani",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for the bump. I've rechecked, and can confirm that the master branch now builds fine with the steps above.",
      "created_at": "2021-05-24T17:59:08Z",
      "updated_at": "2021-05-24T17:59:08Z"
    }
  ],
  "created_at": "2017-12-19T21:30:18Z",
  "number": 5719,
  "state": "closed",
  "title": "Building on Ubuntu 16.04 fails when `-PSModuleRestore` requested",
  "updated_at": "2021-05-24T17:59:08Z"
}