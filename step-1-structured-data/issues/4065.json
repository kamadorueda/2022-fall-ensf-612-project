{
  "_url": "https://github.com/PowerShell/PowerShell/issues/4065",
  "author": "paalbra",
  "body": "If Start-Transcript is ran without -Append and a user has write privileges on the file without write privileges on the parent folder, the file will be silently deleted without any kind of error message.\r\n\r\nSteps to reproduce\r\n------------------\r\n\r\nAs administrator create a folder and file with the privileges specified above. I'm assuming that a local user, \"myuser\" exist:\r\n```powershell\r\nmkdir \"c:\\test\\\"\r\nicacls.exe \"c:\\test\" \"/grant\" \"builtin\\administrators:(CI)(OI)(F)\" \"/inheritance:r\"\r\nicacls.exe \"c:\\test\" \"/grant\" \"myuser:(CI)(OI)(RX)\"\r\n\"\" | Out-File -Encoding \"ascii\" -LiteralPath \"c:\\test\\my-transcript.txt\"\r\nicacls.exe \"c:\\test\\my-transcript.txt\" \"/grant:r\" \"myuser:(F)\"\r\n```\r\n\r\nRun Start-Transcript as \"myuser\":\r\n```powershell\r\nStart-Transcript -LiteralPath \"c:\\test\\my-transcript.txt\"\r\nStop-Transcript\r\n```\r\n\r\nExpected behavior\r\n-----------------\r\n\r\nThe transcript should be written to c:\\test\\my-transcript.txt\r\n\r\nActual behavior\r\n---------------\r\n\r\nThe output states success, but the file is actually deleted.\r\n\r\n> PS C:\\> Start-Transcript -LiteralPath \"c:\\test\\my-transcript.txt\"\r\n> Transcript started, output file is c:\\test\\my-transcript.txt\r\n> \r\n> PS C:\\> Stop-Transcript\r\n> Transcript stopped, output file is C:\\test\\my-transcript.txt\r\n> \r\n> PS C:\\> Test-Path \"c:\\test\\my-transcript.txt\"\r\n> False\r\n\r\nEnvironment data\r\n----------------\r\nNot the newest PowerShell ...\r\n> PS C:\\> $PSVersionTable\r\n> \r\n> Name                           Value                                                                                                                                                                                                                                       \r\n> ----                           -----                                                                                                                                                                                                                                       \r\n> PSVersion                      5.1.14393.1358                                                                                                                                                                                                                              \r\n> PSEdition                      Desktop                                                                                                                                                                                                                                     \r\n> PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}                                                                                                                                                                                                                     \r\n> BuildVersion                   10.0.14393.1358                                                                                                                                                                                                                             \r\n> CLRVersion                     4.0.30319.42000                                                                                                                                                                                                                             \r\n> WSManStackVersion              3.0                                                                                                                                                                                                                                         \r\n> PSRemotingProtocolVersion      2.3                                                                                                                                                                                                                                         \r\n> SerializationVersion           1.1.0.1     \r\n\r\n... but you can clearly see the error in line 230 of StartTranscriptCmdlet.cs :\r\nhttps://github.com/PowerShell/PowerShell/blob/02b5f357a20e6dee9f8e60e3adb9025be3c94490/src/Microsoft.PowerShell.ConsoleHost/host/msh/StartTranscriptCmdlet.cs#L230\r\n\r\n```c#\r\n// If they didn't specify -Append, delete the file\r\nif (!_shouldAppend)\r\n{\r\n\tSystem.IO.File.Delete(effectiveFilePath);\r\n}\r\n```\r\n\r\nThis part of the code should rather write some sort of zero length content to the file. ",
  "closed_at": "2018-11-07T03:34:42Z",
  "comments": [
    {
      "author": "charlieschmidt",
      "author_association": "NONE",
      "body": "@paalbra are you able to reproduce this on a verison of powershell-core?  That line is correct - if the file exists, and the user hasn't said -Append (after some other conditions) - then delete the file before starting any of the real logic.   That wipes it out as expected.\r\n\r\nAnd fwiw, works for me on:\r\n\r\n```\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.0.0-beta\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.0-beta.7\r\nOS                             Darwin 17.2.0 Darwin Kernel Version 17.2.0: Sun Oct  1 00:46:50 PDT 2017; root:xnu-4570.20.62~10/RELEASE_X86_64\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```",
      "created_at": "2017-10-22T01:18:59Z",
      "updated_at": "2017-10-22T01:18:59Z"
    },
    {
      "author": "SteveL-MSFT",
      "author_association": "MEMBER",
      "body": "With beta.8, following the repro steps, it does delete the file if `-Append` is not used, as expected.  However, the transcript file does exist including a bunch of header information as well as the `stop-transcript` command.",
      "created_at": "2017-10-22T06:10:07Z",
      "updated_at": "2017-10-22T06:10:07Z"
    },
    {
      "author": "paalbra",
      "author_association": "CONTRIBUTOR",
      "body": "@SteveL-MSFT I just ran through the repro steps and the issue is still present in beta.8 (with some changes).\r\n\r\nDid you follow my steps all the way? What account did you use? The account I'm referring to as \"myuser\" should be an unprivileged account. The account doing the file access setup should be privileged (e.g. an administrator).\r\n\r\n@charlieschmidt You should not be able to do that. I believe you might have missed some of the file ACL setup as well?\r\n\r\nThe ACLs should become the following after setup:\r\n```\r\nPS C:\\Program Files\\PowerShell\\6.0.0-beta.8> icacls C:\\test\r\nC:\\test DESKTOP-IGCDSJ7\\myuser:(OI)(CI)(RX)\r\n        BUILTIN\\Administrators:(OI)(CI)(F)\r\n\r\nSuccessfully processed 1 files; Failed processing 0 files\r\nPS C:\\Program Files\\PowerShell\\6.0.0-beta.8> icacls C:\\test\\my-transcript.txt\r\nC:\\test\\my-transcript.txt DESKTOP-IGCDSJ7\\myuser:(F)\r\n                          DESKTOP-IGCDSJ7\\myuser:(I)(RX)\r\n                          BUILTIN\\Administrators:(I)(F)\r\n\r\nSuccessfully processed 1 files; Failed processing 0 files\r\n```\r\n\r\nWhen you start a transcript as \"myuser\" you now get the following in beta.8:\r\n```\r\nPS C:\\Program Files\\PowerShell\\6.0.0-beta.8> Start-Transcript -LiteralPath \"c:\\test\\my-transcript.txt\"\r\nStart-Transcript : Transcription cannot be started due to the error: Access to the path 'C:\\test\\my-transcript.txt' is\r\ndenied.\r\nAt line:1 char:1\r\n+ Start-Transcript -LiteralPath \"c:\\test\\my-transcript.txt\"\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    + CategoryInfo          : InvalidOperation: (:) [Start-Transcript], PSInvalidOperationException\r\n    + FullyQualifiedErrorId : CannotStartTranscription,Microsoft.PowerShell.Commands.StartTranscriptCommand\r\n\r\nPS C:\\Program Files\\PowerShell\\6.0.0-beta.8> Get-ChildItem -Force C:\\test\\\r\nPS C:\\Program Files\\PowerShell\\6.0.0-beta.8>\r\n```\r\n\r\nThere was no error before. So the silent part of my first reported issue is no longer the case.\r\n\r\nWhile it properly emits an error now there is still an issue that should be addressed. Start-Transcript should not delete the file. It should rather wipe the content of the file.\r\n\r\nVersion\r\n```\r\nPS C:\\Program Files\\PowerShell\\6.0.0-beta.8> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.0.0-beta.8\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.0-beta.8\r\nOS                             Microsoft Windows 10.0.15063\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```",
      "created_at": "2017-10-22T18:11:53Z",
      "updated_at": "2017-10-22T18:11:53Z"
    },
    {
      "author": "paalbra",
      "author_association": "CONTRIBUTOR",
      "body": "You could also reproduce this as an issue on Ubuntu. Since this is a different OS/filesystem the issue isn't completely the same. What happens on Ubuntu is that you won't be able to delete the file since this requires write permissions on the parent directory. This also wouldn't be an issue if Start-Transcript didn't try to delete the file.\r\n\r\n```\r\nmyuser@ubuntu:~$ sudo mkdir /test\r\nmyuser@ubuntu:~$ sudo touch /test/my-transcript.txt\r\nmyuser@ubuntu:~$ sudo chmod a+w /test/my-transcript.txt\r\nmyuser@ubuntu:~$ ls -la /test\r\ntotal 8\r\ndrwxr-xr-x  2 root root 4096 okt.  26 22:34 .\r\ndrwxr-xr-x 25 root root 4096 okt.  26 22:34 ..\r\n-rw-rw-rw-  1 root root    0 okt.  26 22:34 my-transcript.txt\r\nmyuser@ubuntu:~$ pwsh\r\nPowerShell 6.1.0\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\n\r\nhttps://aka.ms/pscore6-docs\r\nType 'help' to get help.\r\n\r\nPS /home/myuser> Start-Transcript -LiteralPath \"/test/my-transcript.txt\"\r\nStart-Transcript : Transcription cannot be started due to the error: Access to the path '/test/my-transcript.txt' is denied.\r\nAt line:1 char:1\r\n+ Start-Transcript -LiteralPath \"/test/my-transcript.txt\"\r\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : InvalidOperation: (:) [Start-Transcript], PSInvalidOperationException\r\n+ FullyQualifiedErrorId : CannotStartTranscription,Microsoft.PowerShell.Commands.StartTranscriptCommand\r\n \r\nPS /home/myuser> Stop-Transcript\r\nStop-Transcript : An error occurred stopping transcription: The host is not currently transcribing.\r\nAt line:1 char:1\r\n+ Stop-Transcript\r\n+ ~~~~~~~~~~~~~~~\r\n+ CategoryInfo          : InvalidOperation: (:) [Stop-Transcript], PSInvalidOperationException\r\n+ FullyQualifiedErrorId : InvalidOperation,Microsoft.PowerShell.Commands.StopTranscriptCommand\r\n \r\nPS /home/myuser> Get-ChildItem /test/\r\n\r\n\r\n    Directory: /test\r\n\r\n\r\nMode                LastWriteTime         Length Name\r\n----                -------------         ------ ----\r\n------         10/26/18  10:34 PM              0 my-transcript.txt\r\n\r\n\r\nPS /home/myuser> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.1.0\r\nPSEdition                      Core\r\nGitCommitId                    6.1.0\r\nOS                             Linux 4.15.0-38-generic #41-Ubuntu SMP Wed Oct 10 10:59:38 UTC 2018\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```",
      "created_at": "2018-10-26T20:47:48Z",
      "updated_at": "2018-10-26T20:47:48Z"
    }
  ],
  "created_at": "2017-06-21T16:08:00Z",
  "number": 4065,
  "state": "closed",
  "title": "Start-Transcript might silently delete the output file",
  "updated_at": "2018-11-07T03:34:42Z"
}