{
  "_url": "https://github.com/PowerShell/PowerShell/issues/12797",
  "author": "iSazonov",
  "body": "<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\nFix #9127. \r\n\r\nBefore the fix we check an item existence relative to _system_ CWD. After the fix we do the check based on current _runspace_ CWD. \r\n\r\n## PR Context\r\n\r\n<!-- Provide a little reasoning as to why this Pull Request helps and why you have opened it. -->\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [x] None\r\n    - **OR**\r\n    - [ ] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n        - [ ] Experimental feature name(s): <!-- Experimental feature name(s) here -->\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n- **Testing - New and feature**\r\n    - [ ] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [x] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [ ] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [ ] I have considered the user experience from a tooling perspective and enumerated concerns in the summary. This may include:\r\n        - Impact on [PowerShell Editor Services](https://github.com/PowerShell/PowerShellEditorServices) which is used in the [PowerShell extension](https://github.com/PowerShell/vscode-powershell) for VSCode (which runs in a different PS Host).\r\n        - Impact on Completions (both in the console and in editors) - one of PowerShell's most powerful features.\r\n        - Impact on [PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer) (which provides linting & formatting in the editor extensions).\r\n        - Impact on [EditorSyntax](https://github.com/PowerShell/EditorSyntax) (which provides syntax highlighting with in VSCode, GitHub, and many other editors).\r\n",
  "closed_at": "2020-06-01T20:12:28Z",
  "comments": [
    {
      "author": "vexx32",
      "author_association": "COLLABORATOR",
      "body": "@iSazonov thanks for taking the time to sort this one out. \ud83d\ude0a \r\n\r\nQuick question -- should / will this affect the `-ItemType Junction` / `-ItemType Hardlink` modes for `New-Item` and should we be testing those here as well?",
      "created_at": "2020-05-26T17:00:15Z",
      "updated_at": "2020-05-26T17:00:15Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@iSazonov Please have a look at the test failure",
      "created_at": "2020-05-28T20:37:00Z",
      "updated_at": "2020-05-28T20:37:00Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@mklement0 Could you please help with the MacOs fail? Do you have any thoughts?",
      "created_at": "2020-05-29T05:35:40Z",
      "updated_at": "2020-05-29T05:35:40Z"
    },
    {
      "author": "adityapatwardhan",
      "author_association": "MEMBER",
      "body": "@iSazonov Thank you for your contribution!",
      "created_at": "2020-06-01T20:12:49Z",
      "updated_at": "2020-06-01T20:12:49Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.1.0-preview.4` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.1.0-preview.4)\n",
      "created_at": "2020-06-25T19:06:47Z",
      "updated_at": "2020-06-25T19:06:47Z"
    },
    {
      "author": "MatejKafka",
      "author_association": "NONE",
      "body": "Is this really how relative path for symlink should behave? This PR changes the behavior of the checks from having `-Target` relative to .NET CWD to PowerShell CWD, but it's still inconsistent with how filesystem actually resolves the symlink.\r\n\r\nRelative path in the symlink target is resolved by filesystem relative **to the directory containing the symlink**, not relative to CWD of pwsh instance that created it.\r\n\r\n---\r\n\r\nThis should create a working directory symlink:\r\n```\r\nmkdir ./test\r\nmkdir ./test/dir\r\nni -Type SymbolicLink ./test/dir_link -Target ./dir\r\n```\r\nInstead, the check uses path relative to current working directory (`./dir`) instead of relative to symlink path (`./test/dir`).",
      "created_at": "2021-04-14T02:09:45Z",
      "updated_at": "2021-04-14T02:19:29Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "@MatejKafka Please create new issue if you see an inconsistency.",
      "created_at": "2021-04-14T05:29:10Z",
      "updated_at": "2021-04-14T05:29:10Z"
    },
    {
      "author": "mklement0",
      "author_association": "CONTRIBUTOR",
      "body": "@MatejKafka, while you are correct, this problem doesn't currently surface, although there are related ones:\r\n\r\nWith respect to _creating_ the symlink, i.e. what target path is stored in its definition:\r\n\r\n* On Windows, the relative path is stored as-is (excepting possible path-separator normalization) in the new symlink - which is indeed what should happen.\r\n\r\n  * However, a relative path that starts with a _name_ rather than `.\\` causes problematic behavior with `Get-ChildItem` - see #15161.\r\n\r\n* On Unix-like platforms, unexpected resolution to a full path happens before the symlink is created, which is a bug, and was reported in #15233.\r\n\r\nWith respect to _validating the existence_ of the target path on creation:\r\n\r\n* This validation - which should indeed happen relative to the _symlink_'s location -  is currently broken on all platforms,  so that targeting a non-existing path is quietly possible, with the exception of using full paths with non-existent drive names / UNC paths.\r\n\r\n  * While this is _sometimes_ desired, it should be an _opt-in_, and on Windows presents the additional challenge of then needing to specify whether the hypothetical future target is a _file_ or a _directory_.\r\n\r\n  * See https://github.com/PowerShell/PowerShell/issues/9067#issuecomment-470140963\r\n\r\n\r\n",
      "created_at": "2021-04-14T17:45:39Z",
      "updated_at": "2021-04-14T18:08:01Z"
    },
    {
      "author": "MatejKafka",
      "author_association": "NONE",
      "body": "@mklement0 Actually, I think it currently surfaces. Because the checks are relative to cwd, they incorrectly detect whether the target is file or directory. Let me try to illustrate it with more examples:\r\n\r\n(I'll use D:\\test as our testing directory to make it clear when I'm talking about absolute paths)\r\n\r\n1)\r\n```\r\nmkdir D:/test\r\nmkdir D:/test/dir\r\nni -Type SymbolicLink D:/test/dir_link -Target ./dir\r\n```\r\nExpected: directory symlink to `D:/test/dir`, with target `./dir`\r\nGot: **file** symlink to `D:/test/dir`, with target `./dir`\r\nThe target type detection code checks the relative path `./dir` (`D:/dir`), which doesn't exist, so the symlink incorrectly defaults to **file symlink**.\r\n\r\n2)\r\n```\r\nmkdir D:/test\r\nmkdir D:/test/dir\r\ncd D:/test\r\nni -Type SymbolicLink D:/test/dir_link -Target ./dir\r\n```\r\nExpected: directory symlink to `D:/test/dir`, with target `./dir`\r\nGot: what I expected\r\nOnly difference from previous example is the `cd D:/test`. This correctly creates a directory symlink, because the code checks type of target for `./dir` (`D:/test/dir`), which now matches the real target.\r\n\r\n3)\r\n```\r\nmkdir D:/test/subdir\r\nmkdir D:/test/item # <-- directory\r\nni D:/test/subdir/item # <-- file\r\ncd D:/test\r\nni -Type SymbolicLink D:/test/subdir/item_link -Target ./item\r\n```\r\nExpected: file symlink to `D:/test/subdir/item`, with target `./item`\r\nGot: **directory** symlink `D:/test/subdir/item`, with target `./item`\r\nThe the file `D:/test/item` is used for target check, it's a directory, so a directory symlink is created (but the actual target is `D:/test/subdir/item`, which is a file).\r\n\r\n---\r\n\r\nThere are 2 possible correct behaviors I see here:\r\n1) Set absolute path as a symlink target, and resolve the target path to be absolute. This effectively prevents PowerShell from creating symlinks with relative paths to target, but still solves this issue.\r\n2) Allow relative paths, but when checking for target type (file/directory), use the path `Join-Path $Path $Target` internally, but still write `$Target` as provided by user (relative) into the symlink itself. This is imo the better solution, allows the user to create symlinks with relative paths, but still correctly detects the type.",
      "created_at": "2021-04-14T22:26:35Z",
      "updated_at": "2021-04-14T22:36:06Z"
    },
    {
      "author": "mklement0",
      "author_association": "CONTRIBUTOR",
      "body": "Good point, @MatejKafka. As @iSazonov has advised, please create a new issue with your findings.",
      "created_at": "2021-04-14T22:33:44Z",
      "updated_at": "2021-04-14T22:33:44Z"
    }
  ],
  "created_at": "2020-05-26T16:17:51Z",
  "number": 12797,
  "state": "closed",
  "title": "Fix New-Item to create symlink to relative path target",
  "updated_at": "2021-04-14T22:36:06Z"
}