{
  "_url": "https://github.com/PowerShell/PowerShell/issues/16907",
  "author": "m1k0net",
  "body": "### Prerequisites\n\n- [X] Write a descriptive title.\n- [X] Make sure you are able to repro it on the [latest released version](https://github.com/PowerShell/PowerShell/releases)\n- [X] Search the existing issues.\n- [X] Refer to the [FAQ](https://github.com/PowerShell/PowerShell/blob/master/docs/FAQ.md).\n- [X] Refer to [Differences between Windows PowerShell 5.1 and PowerShell](https://docs.microsoft.com/powershell/scripting/whats-new/differences-from-windows-powershell).\n\n### Steps to reproduce\n\nWhen running data through Sort-Object -Stable -Unique given a specific property the returned results do not appear to be the 1st element seen from a stable sort.  Also modifying modifying the input data for an unrelated record effects the records of another.  Below is some sample code that can be used to reproduce the issue.  The only difference from the data in the 1st set to the 2nd is the last row was changed from 2021 to 2015 which is effecting the file1 key but the file0 key is consistently showing the last item.  The rest of the records appear to process correctly.\r\n\r\n```powershell\r\n$Data=\"Key,Path,Size\r\nfile1,C:\\folder\\2015,10\r\nfile1,C:\\folder\\2018,10\r\nfile1,C:\\folder\\2020,10\r\nfile2,C:\\folder\\2014,10\r\nfile2,C:\\folder\\2019,10\r\nfile4,C:\\folder\\2020,10\r\nfile4,C:\\folder\\2017,10\r\nfile4,C:\\folder\\2020,10\r\nfile4,C:\\folder\\2019,10\r\nfile4,C:\\folder\\2021,10\r\nfile0,C:\\folder\\2015,10\r\nfile0,C:\\folder\\2018,10\r\nfile0,C:\\folder\\2020,10\r\nfile2,C:\\folder\\2022,10\r\nfile3,C:\\folder\\2019,10\r\nfile3,C:\\folder\\2018,10\r\nfile3,C:\\folder\\2019,10\r\nfile3,C:\\folder\\2020,10\r\nfile3,C:\\folder\\2022,10\r\nfile3,C:\\folder\\2021,10\"\r\n$List=$Data | ConvertFrom-Csv  \r\n$SortedList=$List | Sort-Object Path -Descending\r\nWrite-Host \"Sorted List:\"\r\n$SortedList | Format-Table\r\nWrite-Host \"Unique List:\"\r\n$SortedList | Sort-Object Key -Unique -Stable | Format-Table\r\n\r\n\r\n$list[19].Path=\"C:\\folder\\2015\"\r\n$SortedList=$List | Sort-Object Path -Descending\r\nWrite-Host \"Sorted List:\"\r\n$SortedList | Format-Table\r\nWrite-Host \"Unique List:\"\r\n$SortedList | Sort-Object Key -Unique -Stable | Format-Table```\r\n\n\n### Expected behavior\n\n```console\nKey   Path           Size\r\n---   ----           ----\r\nfile0 C:\\folder\\2020 10\r\nfile1 C:\\folder\\2020 10\r\nfile2 C:\\folder\\2022 10\r\nfile3 C:\\folder\\2022 10\r\nfile4 C:\\folder\\2021 10\n```\n\n\n### Actual behavior\n\n```console\nCase 1:\r\nKey   Path           Size\r\n---   ----           ----\r\nfile0 C:\\folder\\2015 10\r\nfile1 C:\\folder\\2015 10\r\nfile2 C:\\folder\\2022 10\r\nfile3 C:\\folder\\2022 10\r\nfile4 C:\\folder\\2021 10\r\n\r\nCase 2:\r\nKey   Path           Size\r\n---   ----           ----\r\nfile0 C:\\folder\\2015 10\r\nfile1 C:\\folder\\2020 10\r\nfile2 C:\\folder\\2022 10\r\nfile3 C:\\folder\\2022 10\r\nfile4 C:\\folder\\2021 10\n```\n\n\n### Error details\n\n_No response_\n\n### Environment data\n\n```powershell\nName                           Value\r\n----                           -----\r\nPSVersion                      7.2.1\r\nPSEdition                      Core\r\nGitCommitId                    7.2.1\r\nOS                             Microsoft Windows 10.0.19043\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.3.0-preview.1\r\nPSEdition                      Core\r\nGitCommitId                    7.3.0-preview.1\r\nOS                             Microsoft Windows 10.0.19043\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\n```\n\n\n### Visuals\n\n_No response_",
  "closed_at": "2022-04-27T23:05:00Z",
  "comments": [
    {
      "author": "m1k0net",
      "author_association": "CONTRIBUTOR",
      "body": "I believe I found the issue.  In Sort-Object.cs when a duplicate is found an item is taken from the end of the array and moved to the current position.  This has the side effect of breaking stable sorts because the source array is being re-ordered.  Below is the relevant code.  I believe a fix would just be instead of re-ordering the array just skip to the next record.  It seems that would be quicker and save on the data copying but I don't know enough C# to know if that is proper.\r\n\r\n```c#\r\n                   if (dataIndex != dataToSort.Count - discardedDuplicates)\r\n                    {\r\n                        // When discarding duplicates, replace them with an item at the end of the list and\r\n                        // adjust our counter so that we check the item we just swapped in next\r\n                        dataToSort[dataIndex] = dataToSort[dataToSort.Count - discardedDuplicates];\r\n                        dataIndex--;\r\n                    }\r\n```\r\n\r\nI have created the below targeted test case for the issue.  Currently the test fails since the Record \"B2\" is returned instead of \"B1\".\r\n\r\n```powershell\r\n    It \"Sort-Object with Uniqe Stable should return proper records\"{\r\n        $Record1=[PSCustomObject]@{Key=\"A\";Record=\"A1\"}\r\n        $Record2=[PSCustomObject]@{Key=\"A\";Record=\"A2\"}\r\n        $Record3=[PSCustomObject]@{Key=\"B\";Record=\"B1\"}\r\n        $Record4=[PSCustomObject]@{Key=\"B\";Record=\"B2\"}\r\n        $Records = @($Record1,$Record2,$Record3,$Record4)\r\n        $results = $Records | Sort-Object -Stable -Unique -Property Key\r\n\r\n        $results[0] | Should -Be $Records[0]\r\n        $results[1] | Should -Be $Records[2]\r\n    }\r\n```\r\n\r\n",
      "created_at": "2022-04-17T23:31:16Z",
      "updated_at": "2022-04-17T23:31:16Z"
    },
    {
      "author": "m1k0net",
      "author_association": "CONTRIBUTOR",
      "body": "This was resolved in PR #17189",
      "created_at": "2022-04-27T23:05:00Z",
      "updated_at": "2022-04-27T23:05:00Z"
    }
  ],
  "created_at": "2022-02-23T13:48:57Z",
  "number": 16907,
  "state": "closed",
  "title": "Sort-Object -Stable -Unique is not always stable",
  "updated_at": "2022-04-28T14:45:30Z"
}