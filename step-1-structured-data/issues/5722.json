{
  "_url": "https://github.com/PowerShell/PowerShell/issues/5722",
  "author": "aetos382",
  "body": "Description\r\n------------------\r\n\r\nWhen creating a remote sessions to multiple computers and running Invoke-Command, if different versions of PowerShell are installed on those machines and the session to newer machine is passed first to the -Session parameter, I can't use $Using variable.\r\n\r\nI expect to get same result regardless of the order of the arguments.\r\n\r\nI think that the error was due to incompatibility between $PSVersionTable.PSRemotingProtocolVersion on these machines.\r\n\r\nThis problem does not occur in PowerShell 6.0 and 5.1 because these PSRemotingProtocolVersion are same.\r\nFor combinations such as 6.0 and 4.0, 5.1 and 4.0, be careful with the order of the -Session arguments.\r\n\r\nSteps to reproduce\r\n------------------\r\n\r\n```powershell\r\n$cred = Get-Credential\r\n\r\n# Windows Server 2012 R2\r\n$older_session = New-PSSession -ComputerName 'computer.running.windows.server.2012.r2' -Credential $cred\r\n\r\n# PSRemotingProtocolVersion = 2.2\r\nInvoke-Command -Session $older_session -ScriptBlock { $PSVersionTable }\r\n\r\n# Windows Server 2016 (1607)\r\n$newer_session = New-PSSession -ComputerName 'computer.running.windows.server.2016.1607' -Credential $cred\r\n\r\n# PSRemotingProtocolVersion = 2.3\r\nInvoke-Command -Session $newer_session -ScriptBlock { $PSVersionTable }\r\n\r\n$x = 1\r\n\r\nInvoke-Command -Session $newer_session, $older_session -ScriptBlock { $Using:x }\r\n```\r\n\r\nExpected behavior\r\n-----------------\r\n\r\n```none\r\n1\r\n1\r\n```\r\n\r\nActual behavior\r\n---------------\r\n\r\n```none\r\n1\r\nA Using variable cannot be retrieved. A Using variable can be used only with Invoke-Command, Start-Job, or InlineScript in the script wo\r\nrkflow. When it is used with Invoke-Command, the Using variable is valid only if the script block is invoked on a remote computer.\r\n    + CategoryInfo          : InvalidOperation: (:) []\u3001RuntimeException\r\n    + FullyQualifiedErrorId : UsingWithoutInvokeCommand\r\n    + PSComputerName        : computer.running.windows.server.2012.r2\r\n```\r\n\r\nWorkaround\r\n----------------\r\n\r\nPass the sessions to the -Session parameter in order of PSRemotingProtocolVersion.\r\n\r\n```powershell\r\nInvoke-Command -Session $older_session, $newer_session -ScriptBlock { $Using:x }\r\n```\r\n\r\nOr sort the sessions\r\n\r\n```powershell\r\n$sessions = $sessions | Sort-Object -Property @{\r\n    Expression = { Invoke-Command -Session $_ -ScriptBlock { $PSVersionTable.PSRemotingProtocolVersion } }\r\n    Ascending = $true\r\n}\r\n\r\nInvoke-Command -Session $sessions -ScriptBlock { $Using:x }\r\n```\r\n\r\nEnvironment data\r\n----------------\r\n\r\nLocal machine:\r\n```powershell\r\n> $PSVersionTable\r\nName                           Value\r\n----                           -----\r\nPSVersion                      6.0.0-rc.2\r\nPSEdition                      Core\r\nGitCommitId                    v6.0.0-rc.2\r\nOS                             Microsoft Windows 10.0.16299\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n```\r\n\r\nOlder machine (Windows Server 2012 R2):\r\n```powershell\r\nName                           Value                                                                                                    \r\n----                           -----                                                                                                    \r\nPSRemotingProtocolVersion      2.2                                                                                                      \r\nBuildVersion                   6.3.9600.18773                                                                                           \r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0}                                                                                     \r\nPSVersion                      4.0                                                                                                      \r\nCLRVersion                     4.0.30319.42000                                                                                          \r\nWSManStackVersion              3.0                                                                                                      \r\nSerializationVersion           1.1.0.1 \r\n```\r\n\r\nNewer machine (Windows Server 2016 1607):\r\n```powershell\r\nName                           Value                                                                                                    \r\n----                           -----                                                                                                    \r\nPSRemotingProtocolVersion      2.3                                                                                                      \r\nBuildVersion                   10.0.14393.693                                                                                           \r\nPSVersion                      5.1.14393.693                                                                                            \r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}                                                                                  \r\nPSEdition                      Desktop                                                                                                  \r\nCLRVersion                     4.0.30319.42000                                                                                          \r\nWSManStackVersion              3.0                                                                                                      \r\nSerializationVersion           1.1.0.1   \r\n```",
  "closed_at": null,
  "comments": [],
  "created_at": "2017-12-20T10:11:36Z",
  "number": 5722,
  "state": "open",
  "title": "$Using variable is not available when run Invoke-Command to different versions of PowerShell.",
  "updated_at": "2017-12-20T17:03:36Z"
}