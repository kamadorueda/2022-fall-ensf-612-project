{
  "_url": "https://github.com/PowerShell/PowerShell/issues/11804",
  "author": "Spectre-007",
  "body": "#Steps to reproduce\r\n\r\n```powershell 7 \r\nCreate a connection to a SQL Server and run a command from the SQLserver module\r\n$connectionString = \"Server=<servername>,14481;database=hoclusters;Integrated Security=True;Persist Security Info=True;User ID=$user;Password=$pwd\"\r\n$sqlConnection = New-Object System.Data.SqlClient.SqlConnection $connectionString\r\n$SqlCmd = New-Object System.Data.SqlClient.SqlCommand\r\n$SqlCmd.Connection = $SqlConnection\r\n$SqlCmd.CommandTimeout = 0\r\n\r\ninvoke-sqlcmd -serverinstance '<servername>,14481' -database 'master' -query \"select @@servername\" -QueryTimeout 60\r\n\r\n\r\n```\r\n\r\n# Expected behavior\r\n\r\n```\r\ninvoke-sqlcmd command to return server name after successful connection\r\n\r\n```\r\n\r\n# Actual behavior\r\n\r\n```\r\nA connection is established but the pre-login handshake times out\r\n```\r\n\r\n# Environment data\r\n\r\n<!-- Name                           Value\r\n----                           -----\r\nPSVersion                      7.0.0-rc.2\r\nPSEdition                      Core\r\nGitCommitId                    7.0.0-rc.2\r\nOS                             Microsoft Windows 10.0.17763\r\nPlatform                       Win32NT\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0\r\n\r\n PS /> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      7.0.0-rc.2\r\nPSEdition                      Core\r\nGitCommitId                    7.0.0-rc.2\r\nOS                             Linux 3.10.0-1062.9.1.el7.x86_64 #1 SMP Fri Dec 6 15:49:49 UTC 2019\r\nPlatform                       Unix\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0\u2026}\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\nWSManStackVersion              3.0-->\r\n\r\n```\r\nException             : \r\n    Type           : Microsoft.SqlServer.Management.Common.ConnectionFailureException\r\n    TargetSite     : \r\n        Name          : Connect\r\n        DeclaringType : Microsoft.SqlServer.Management.Common.ConnectionManager\r\n        MemberType    : Method\r\n        Module        : Microsoft.SqlServer.ConnectionInfo.dll\r\n    StackTrace     : \r\n   at Microsoft.SqlServer.Management.Common.ConnectionManager.Connect()\r\n   at Microsoft.SqlServer.Management.PowerShell.SmoCmdlet.ConnectToServer(String instance, PSCredential cred, Nullable`1 timeout)\r\n   at Microsoft.SqlServer.Management.PowerShell.SmoContextSensitiveTargetedWithServerInstanceCmdlet`1.ResolveTargets()+MoveNext()\r\n    Message        : Failed to connect to server <servername>,14481.\r\n    InnerException : \r\n        Type               : System.Data.SqlClient.SqlException\r\n        Errors             : \r\n            Source  : Core .Net SqlClient Data Provider\r\n            Number  : 258\r\n            Class   : 20\r\n            Server  : <servername>,14481\r\n            Message : A connection was successfully established with the server, but then an error occurred during the pre-login handshake. (provider: SSL Provider, error:\r\n0 - The wait operation timed out.)\r\n        ClientConnectionId : d95f684b-ab07-4bb7-9f0f-cfa4c9517b1e\r\n        Class              : 20\r\n        Number             : 258\r\n        Server             : <servername>,14481\r\n        Source             : Core .Net SqlClient Data Provider\r\n        ErrorCode          : -2146232060\r\n        TargetSite         : Void .ctor(System.Data.ProviderBase.DbConnectionPoolIdentity, System.Data.SqlClient.SqlConnectionString, System.Data.SqlClient.SqlCredential,\r\nSystem.Object, System.String, System.Security.SecureString, Boolean, System.Data.SqlClient.SqlConnectionString, System.Data.SqlClient.SessionData, Boolean, System.String)\r\n        StackTrace         : \r\n   at System.Data.SqlClient.SqlInternalConnectionTds..ctor(DbConnectionPoolIdentity identity, SqlConnectionString connectionOptions, SqlCredential credential, Object\r\nproviderInfo, String newPassword, SecureString newSecurePassword, Boolean redirectedUserInstance, SqlConnectionString userConnectionOptions, SessionData\r\nreconnectSessionData, Boolean applyTransientFaultHandling, String accessToken)\r\n   at System.Data.SqlClient.SqlConnectionFactory.CreateConnection(DbConnectionOptions options, DbConnectionPoolKey poolKey, Object poolGroupProviderInfo, DbConnectionPool\r\npool, DbConnection owningConnection, DbConnectionOptions userOptions)\r\n   at System.Data.ProviderBase.DbConnectionFactory.CreatePooledConnection(DbConnectionPool pool, DbConnection owningObject, DbConnectionOptions options,\r\nDbConnectionPoolKey poolKey, DbConnectionOptions userOptions)\r\n   at System.Data.ProviderBase.DbConnectionPool.CreateObject(DbConnection owningObject, DbConnectionOptions userOptions, DbConnectionInternal oldConnection)\r\n   at System.Data.ProviderBase.DbConnectionPool.UserCreateRequest(DbConnection owningObject, DbConnectionOptions userOptions, DbConnectionInternal oldConnection)\r\n   at System.Data.ProviderBase.DbConnectionPool.TryGetConnection(DbConnection owningObject, UInt32 waitForMultipleObjectsTimeout, Boolean allowCreate, Boolean\r\nonlyOneCheckConnection, DbConnectionOptions userOptions, DbConnectionInternal& connection)\r\n   at System.Data.ProviderBase.DbConnectionPool.TryGetConnection(DbConnection owningObject, TaskCompletionSource`1 retry, DbConnectionOptions userOptions,\r\nDbConnectionInternal& connection)\r\n   at System.Data.ProviderBase.DbConnectionFactory.TryGetConnection(DbConnection owningConnection, TaskCompletionSource`1 retry, DbConnectionOptions userOptions,\r\nDbConnectionInternal oldConnection, DbConnectionInternal& connection)\r\n   at System.Data.ProviderBase.DbConnectionInternal.TryOpenConnectionInternal(DbConnection outerConnection, DbConnectionFactory connectionFactory, TaskCompletionSource`1\r\nretry, DbConnectionOptions userOptions)\r\n   at System.Data.ProviderBase.DbConnectionClosed.TryOpenConnection(DbConnection outerConnection, DbConnectionFactory connectionFactory, TaskCompletionSource`1 retry,\r\nDbConnectionOptions userOptions)\r\n   at System.Data.SqlClient.SqlConnection.TryOpen(TaskCompletionSource`1 retry)\r\n   at System.Data.SqlClient.SqlConnection.Open()\r\n   at Microsoft.SqlServer.Management.Common.ConnectionManager.InternalConnect()\r\n   at Microsoft.SqlServer.Management.Common.ConnectionManager.Connect()\r\n        Message            : A connection was successfully established with the server, but then an error occurred during the pre-login handshake. (provider: SSL Provider,\r\nerror: 0 - The wait operation timed out.)\r\n        Data               : System.Collections.ListDictionaryInternal\r\n        InnerException     : \r\n            Type            : System.ComponentModel.Win32Exception\r\n            NativeErrorCode : 258\r\n            ErrorCode       : -2147467259\r\n            Message         : The wait operation timed out.\r\n            HResult         : -2147467259\r\n        HResult            : -2146232060\r\n    Source         : Microsoft.SqlServer.ConnectionInfo\r\n    HResult        : -2146233087\r\nTargetObject          : <servername>,14481\r\nCategoryInfo          : ObjectNotFound: (<servername>,14481:String) [Read-SqlTableData], ConnectionFailureException\r\nFullyQualifiedErrorId : ConnectionToServerFailed,Microsoft.SqlServer.Management.PowerShell.ReadSqlTableData\r\nInvocationInfo        : \r\n    MyCommand        : Read-SqlTableData\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 1\r\n    HistoryId        : 11\r\n    Line             : Read-SqlTableData -ServerInstance '<servername>,14481' -DatabaseName ho_cpu_wait -SchemaName \"dbo\" -TableName \"table1\"\r\n    PositionMessage  : At line:1 char:1\r\n                       + Read-SqlTableData -ServerInstance '<servername>. \u2026\r\n                       + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n    InvocationName   : Read-SqlTableData\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\nPipelineIterationInfo : \r\n\r\n```\r\n",
  "closed_at": "2020-05-09T12:00:25Z",
  "comments": [
    {
      "author": "Spectre-007",
      "author_association": "NONE",
      "body": "Did I do something wrong with the initial issue report?",
      "created_at": "2020-02-17T17:22:18Z",
      "updated_at": "2020-02-17T17:22:18Z"
    },
    {
      "author": "mklement0",
      "author_association": "CONTRIBUTOR",
      "body": "Your problem sounds like it may be specific to your environment as opposed to exhibiting a problem with PowerShell itself - only the latter issues should be reported here.\r\n\r\nPerhaps the \"Support\" link on the new-issue page (https://github.com/PowerShell/PowerShell/blob/master/.github/SUPPORT.md) may have given you the idea that posting a support question here is appropriate.\r\n\r\nI agree that the information there is misleading, which [has been pointed out before](https://github.com/PowerShell/PowerShell/pull/11153#issuecomment-557585631)  (/cc @SteveL-MSFT).\r\n\r\nHere's the relevant information:\r\n\r\n---\r\n\r\nIf you believe that you've found a problem _with PowerShell itself_ and have _reproducible steps_ to demonstrate it:\r\n\r\n- Search the [existing issues](https://github.com/PowerShell/PowerShell/issues) to see if your problem has already been reported.\r\n\r\n- If not, make sure you are able to repro it on the [latest released or preview version](https://github.com/PowerShell/PowerShell/releases) and, if so, [create a new bug-report issue](https://github.com/PowerShell/PowerShell/issues/new?assignees=&labels=Issue-Question&template=Bug_Report.md) with your repro steps.\r\n\r\n\r\nOtherwise, do _not_ post here and instead ask the community for support:\r\n\r\n* [Slack](https://join.slack.com/t/powershell/shared_invite/enQtMzA3MDcxNTM5MTkxLTBmMWIyNzhkYzVjNGRiOTgxZmFlN2E0ZmVmOWU5NDczNTY2NDFhZjFlZTM1MTZiMWIzZDcwMGYzNjQ3YTRkNWM) and [Discord](https://discordapp.com/invite/AtzXnJM) Community Chat - interactive chat with other PowerShell enthusiasts. Both Slack and Discord are bridged via a bot and can seamlessly talk to each other.\r\n\r\n* [StackOverflow.com](https://stackoverflow.com/questions/tagged/powershell) and [PowerShell.org Forum](https://powershell.org/forums/) - search or post new general PowerShell usage questions\r\n\r\nSee also: the [official support lifecycle and policy](https://docs.microsoft.com/en-us/powershell/scripting/powershell-support-lifecycle).\n\n<blockquote><img src=\"https://repository-images.githubusercontent.com/49609581/96590180-07d7-11ea-89b1-2f719dc4bb9c\" width=\"48\" align=\"right\"><div><img src=\"https://github.githubassets.com/favicon.ico\" height=\"14\"> GitHub</div><div><strong><a href=\"https://github.com/PowerShell/PowerShell\">PowerShell/PowerShell</a></strong></div><div>PowerShell for every system! Contribute to PowerShell/PowerShell development by creating an account on GitHub.</div></blockquote>",
      "created_at": "2020-02-18T03:37:29Z",
      "updated_at": "2020-02-18T03:37:32Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "This issue has been marked as answered and has not had any activity for **1 day**. It has been closed for housekeeping purposes.",
      "created_at": "2020-05-09T12:00:24Z",
      "updated_at": "2020-05-09T12:00:24Z"
    }
  ],
  "created_at": "2020-02-07T14:02:15Z",
  "labels": [
    "Issue-Question",
    "Resolution-Answered"
  ],
  "number": 11804,
  "state": "closed",
  "title": "Intermittent or no connection established to SQL Server",
  "updated_at": "2020-05-09T12:00:25Z"
}