{
  "_url": "https://github.com/PowerShell/PowerShell/issues/11787",
  "author": "daxian-dbw",
  "body": "<!-- Anything that looks like this is a comment and can't be seen after the Pull Request is created. -->\r\n\r\n# PR Summary\r\n\r\nFix `NativeDllHandler` to not throw when file is not found.\r\n\r\nToday, the `NativeDllHandler` calls `NativeLibrary.Load(fullName)` even if the file doesn't exist. This is not right, it should return `IntPtr.Zero` to let the runtime try the next resolution approach, if there is one.\r\nAlso, this behavior results in the exception message to be `Unable to load DLL 'F:\\win-x64\\nativedll.dll' or one of its dependencies: The specified module could not be found`, which is confusing because there was never an explicit loading of a dll with that path.\r\nThe real exception generated from runtime should be `Unable to load DLL 'nativedll' or one of its dependencies: The specified module could not be found.`\r\n\r\n## PR Checklist\r\n\r\n- [x] [PR has a meaningful title](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n    - Use the present tense and imperative mood when describing your changes\r\n- [x] [Summarized changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] [Make sure all `.h`, `.cpp`, `.cs`, `.ps1` and `.psm1` files have the correct copyright header](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n- [x] This PR is ready to merge and is not [Work in Progress](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---work-in-progress).\r\n    - If the PR is work in progress, please add the prefix `WIP:` or `[ WIP ]` to the beginning of the title (the `WIP` bot will keep its status check at `Pending` while the prefix is present) and remove the prefix when the PR is ready.\r\n- **[Breaking changes](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#making-breaking-changes)**\r\n    - [x] None\r\n    - **OR**\r\n    - [ ] [Experimental feature(s) needed](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/staging/reference/6/Microsoft.PowerShell.Core/About/about_Experimental_Features.md)\r\n        - [ ] Experimental feature name(s): <!-- Experimental feature name(s) here -->\r\n- **User-facing changes**\r\n    - [x] Not Applicable\r\n    - **OR**\r\n    - [ ] [Documentation needed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#pull-request---submission)\r\n        - [ ] Issue filed: <!-- Number/link of that issue here -->\r\n- **Testing - New and feature**\r\n    - [x] N/A or can only be tested interactively\r\n    - **OR**\r\n    - [ ] [Make sure you've added a new test if existing tests do not effectively test the code changed](https://github.com/PowerShell/PowerShell/blob/master/.github/CONTRIBUTING.md#before-submitting)\r\n- **Tooling**\r\n    - [x] I have considered the user experience from a tooling perspective and don't believe tooling will be impacted.\r\n    - **OR**\r\n    - [ ] I have considered the user experience from a tooling perspective and enumerated concerns in the summary. This may include:\r\n        - Impact on [PowerShell Editor Services](https://github.com/PowerShell/PowerShellEditorServices) which is used in the [PowerShell extension](https://github.com/PowerShell/vscode-powershell) for VSCode (which runs in a different PS Host).\r\n        - Impact on Completions (both in the console and in editors) - one of PowerShell's most powerful features.\r\n        - Impact on [PSScriptAnalyzer](https://github.com/PowerShell/PSScriptAnalyzer) (which provides linting & formatting in the editor extensions).\r\n        - Impact on [EditorSyntax](https://github.com/PowerShell/EditorSyntax) (which provides syntax highlighting with in VSCode, GitHub, and many other editors).\r\n",
  "closed_at": "2020-02-07T20:03:16Z",
  "comments": [
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": "<!--[AutoMerge]-->\nHello @TravisEz13!\n\nBecause this pull request has the `AutoMerge` label, I will be glad to assist with helping to merge this pull request once all check-in policies pass.\n\nDo note that I've been instructed to only help merge pull requests of this repository that have been opened for at least **24 hours**, a condition that will be fulfilled in about 23 hours 19 minutes. No worries though, I will be back when the time is right! :wink:\n\n##### p.s. you can customize the way I help with merging this pull request, such as holding this pull request until a specific person approves. Simply @mention me (`@msftbot`) and give me an instruction to get started! Learn more [here](https://github.com/OfficeDev/office-ui-fabric-react/wiki/Advanced-auto-merge).",
      "created_at": "2020-02-05T23:30:43Z",
      "updated_at": "2020-02-05T23:30:43Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> Today, the NativeDllHandler calls NativeLibrary.Load(fullName) even if the file doesn't exist. This is not right, it should return IntPtr.Zero to let the runtime try the next resolution approach, if there is one.\r\n\r\n> https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.nativelibrary.load?view=netcore-3.1\r\n\r\nDocs says NativeLibrary.Load() throws DllNotFoundException if the file does not exist.\r\nSo the exception is a root cause of the issue.\r\nI suggest to use NativeLibrary.TryLoad() method to avoid explicit file existence check. This also addresses BadImageFormatException if a file.dll exists but it is not valid dll.\n\n<blockquote><img src=\"https://docs.microsoft.com/en-us/media/logos/logo-ms-social.png\" width=\"48\" align=\"right\"><div><strong><a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.nativelibrary.load\">NativeLibrary.Load Method (System.Runtime.InteropServices)</a></strong></div><div><p sourcefile=\"api/System.Runtime.InteropServices.NativeLibrary.Load.yml\" sourcestartlinenumber=\"1\" jsonPath=\"/members/0/summary\">Provides a simple API for loading a native library that wraps the OS loader and uses default flags.</p>\n</div></blockquote>",
      "created_at": "2020-02-06T06:37:00Z",
      "updated_at": "2020-02-06T06:37:03Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": ">  avoid explicit file existence check.\r\n\r\n@iSazonov How would that add any benefit? There will be a file check in `NativeLibrary.TryLoad()` anyways. It makes more sense to check here and avoid an unnecessary method call (p/invoke).",
      "created_at": "2020-02-06T19:32:19Z",
      "updated_at": "2020-02-06T19:32:19Z"
    },
    {
      "author": "TravisEz13",
      "author_association": "MEMBER",
      "body": "@msftclas make sure @PaulHigin has a chance to review before you merge\r\n",
      "created_at": "2020-02-06T21:21:07Z",
      "updated_at": "2020-02-06T21:21:07Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> How would that add any benefit? There will be a file check in NativeLibrary.TryLoad() anyways. It makes more sense to check here and avoid an unnecessary method call (p/invoke).\r\n\r\nThe resolver is _last resort resolver_. In most scenarios all native dll-s are loaded before the resolver. The resolver is called only for one scenario - last attempt to load arch-dependent native dll. Normally the attempt is successful and we do not need to check for the dll file before p/invoke. Any fail in native dll loading is rare and it is _a bug_ (we should again not worry about dll file check)  - either dll is absent or corrupted - both these cases TryLoad() can catch.",
      "created_at": "2020-02-07T04:26:51Z",
      "updated_at": "2020-02-07T04:26:51Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "> The resolver is last resort resolver.\r\n\r\nThis is just the current runtime behavior. It's possible another resolving approach could be added after the `ResolvingUnmanagedDll` event in future. And that won't be a breaking change unless the handler registered to the event is not returning `IntPtr.Zero` when it fails to resolve.\r\n\r\nThis cause problem to application that hosts powershell, e.g. dotnet-interactive. Both the application code and powershell is using the default load context, so this event handler will kick in for all native library loading, even if it's triggered by the application code instead of a powershell module. With the current code, the exception thrown from this handler is super confusing, also the stack trace makes PowerShell look like a culprit to blame.\r\n\r\n> both these cases TryLoad() can catch.\r\n\r\nUsing `TryLoad` here is wrong because it will never throw an exception even if the DLL exists but somehow cannot be loaded.\r\nWhen the file actually exists, an exception should be thrown when it cannot be loaded.",
      "created_at": "2020-02-07T18:39:48Z",
      "updated_at": "2020-02-07T18:40:00Z"
    },
    {
      "author": "iSazonov",
      "author_association": "COLLABORATOR",
      "body": "> so this event handler will kick in for all native library loading, even if it's triggered by the application code instead of a powershell module.\r\n\r\nIn the case we should catch and log any exception and continue resolving process.",
      "created_at": "2020-02-07T19:06:16Z",
      "updated_at": "2020-02-07T19:06:16Z"
    },
    {
      "author": "daxian-dbw",
      "author_association": "MEMBER",
      "body": "Actually, on a second thought, I think you are right about using `TryLoad`.\r\nIf we cannot load the DLL (loading fails), it also indicates the resolution failed, isn't it?\r\nIn that case, it's better to let the runtime to throw the general exception `Unable to load DLL 'nativedll'` instead of PowerShell throwing out an exception with a specific path, because that path might not mean for a native DLL at all.\r\n\r\nI will update the code. Thanks @iSazonov!",
      "created_at": "2020-02-07T19:31:00Z",
      "updated_at": "2020-02-07T20:24:34Z"
    },
    {
      "author": "msftbot[bot]",
      "author_association": "NONE",
      "body": ":tada:`v7.0.0-rc.3` has been released which incorporates this pull request.:tada:\n\nHandy links:\n* [Release Notes](https://github.com/PowerShell/PowerShell/releases/tag/v7.0.0-rc.3)\n",
      "created_at": "2020-02-21T23:55:42Z",
      "updated_at": "2020-02-21T23:55:42Z"
    }
  ],
  "created_at": "2020-02-05T22:50:33Z",
  "number": 11787,
  "state": "closed",
  "title": "Fix `NativeDllHandler` to not throw when file is not found",
  "updated_at": "2020-02-21T23:55:42Z"
}