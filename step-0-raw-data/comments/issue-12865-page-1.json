[
  {
    "author_association": "COLLABORATOR",
    "body": "Part of the problem is that `GetMergedCommandParameterMetadataSafely` isn't actually safe due to #4003.  Since getting parameter metadata can cause PowerShell code to be invoked (dynamic params), if you just make the dictionary itself thread safe you're more than likely going to see a lot more harder to track state corruption.\r\n\r\nA simplish fix would be for PSSA to maintain it's own `ConcurrentDictionary<CommandInfo, Dictionary<string, ParameterMetadata>>`.  Though iirc that API doesn't actually ensure that two \"create\" delegates won't run concurrently, just that the actual dictionary add won't.  If that's correct then you'd probably have to roll your own version with a lock.\r\n\r\nAs for fixing the problem in PowerShell itself, I think fixing #4003 is the only option.  That said, there's a reason it's sat open for almost three years, it's difficult to solve without a probably sizable (but sort of unknowable) break.",
    "created_at": "2020-06-08T17:06:34Z",
    "html_url": "https://github.com/PowerShell/PowerShell/pull/12865#issuecomment-640756253",
    "id": 640756253,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/12865",
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0MDc1NjI1Mw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/640756253/reactions"
    },
    "updated_at": "2020-06-08T17:06:34Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/640756253",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/24977523?v=4",
      "events_url": "https://api.github.com/users/SeeminglyScience/events{/privacy}",
      "followers_url": "https://api.github.com/users/SeeminglyScience/followers",
      "following_url": "https://api.github.com/users/SeeminglyScience/following{/other_user}",
      "gists_url": "https://api.github.com/users/SeeminglyScience/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SeeminglyScience",
      "id": 24977523,
      "login": "SeeminglyScience",
      "node_id": "MDQ6VXNlcjI0OTc3NTIz",
      "organizations_url": "https://api.github.com/users/SeeminglyScience/orgs",
      "received_events_url": "https://api.github.com/users/SeeminglyScience/received_events",
      "repos_url": "https://api.github.com/users/SeeminglyScience/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SeeminglyScience/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SeeminglyScience/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SeeminglyScience"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "@SeeminglyScience Thanks for the valuable input and specific references. :-)\r\nI remember talking to @daxian-dbw about this issue in a general way where it happened in a different scenario (`Test-ModuleManifest` was not thread safe and could be fixed in PSSA by limiting its concurrency in https://github.com/PowerShell/PSScriptAnalyzer/pull/1258). In this scenario the parameters property comes from the CommandInfo cache of PSSA where limiting concurrency is not only hard from a consumers point of view but also comes with performance implications (a lot of the perf improvements in recent version were done by getting rid of fat locks and using .Net's built in and thread safe `ConcurrentDictionary`)...\r\nA suggestion was also to try to force evaluation of the property in the runspace that originally created it. I tried to call the `.Parameters` property right after `Get-Command` gets queried the first time and do something with so that the compiler doesn't optimize the call away and this did not help. All I can think of now is to add the parameters to the cache as well (bad in terms of memory usage) or not use the cache in this instance.",
    "created_at": "2020-06-12T23:18:43Z",
    "html_url": "https://github.com/PowerShell/PowerShell/pull/12865#issuecomment-643518752",
    "id": 643518752,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/12865",
    "node_id": "MDEyOklzc3VlQ29tbWVudDY0MzUxODc1Mg==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/643518752/reactions"
    },
    "updated_at": "2020-06-13T11:34:31Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/643518752",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/9250262?v=4",
      "events_url": "https://api.github.com/users/bergmeister/events{/privacy}",
      "followers_url": "https://api.github.com/users/bergmeister/followers",
      "following_url": "https://api.github.com/users/bergmeister/following{/other_user}",
      "gists_url": "https://api.github.com/users/bergmeister/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/bergmeister",
      "id": 9250262,
      "login": "bergmeister",
      "node_id": "MDQ6VXNlcjkyNTAyNjI=",
      "organizations_url": "https://api.github.com/users/bergmeister/orgs",
      "received_events_url": "https://api.github.com/users/bergmeister/received_events",
      "repos_url": "https://api.github.com/users/bergmeister/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/bergmeister/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bergmeister/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/bergmeister"
    }
  },
  {
    "author_association": "NONE",
    "body": "This pull request has been automatically marked as stale because it has been marked as requiring author feedback but has not had any activity for **15 days**. It will be closed if no further activity occurs **within 10 days of this comment**.",
    "created_at": "2020-07-01T20:00:12Z",
    "html_url": "https://github.com/PowerShell/PowerShell/pull/12865#issuecomment-652618389",
    "id": 652618389,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/12865",
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1MjYxODM4OQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/652618389/reactions"
    },
    "updated_at": "2020-07-01T20:00:12Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/652618389",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/in/26612?v=4",
      "events_url": "https://api.github.com/users/msftbot%5Bbot%5D/events{/privacy}",
      "followers_url": "https://api.github.com/users/msftbot%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/msftbot%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/msftbot%5Bbot%5D/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/apps/msftbot",
      "id": 48340428,
      "login": "msftbot[bot]",
      "node_id": "MDM6Qm90NDgzNDA0Mjg=",
      "organizations_url": "https://api.github.com/users/msftbot%5Bbot%5D/orgs",
      "received_events_url": "https://api.github.com/users/msftbot%5Bbot%5D/received_events",
      "repos_url": "https://api.github.com/users/msftbot%5Bbot%5D/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/msftbot%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/msftbot%5Bbot%5D/subscriptions",
      "type": "Bot",
      "url": "https://api.github.com/users/msftbot%5Bbot%5D"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "Closing as PSSA implemented the workarouns to catch the exception when it happens for a command from the cache and just ask for a fresh new object.\r\nSince the other referenced PowerShell issue where the root cause lies, is still open, I'll close the PR then",
    "created_at": "2020-07-01T22:12:07Z",
    "html_url": "https://github.com/PowerShell/PowerShell/pull/12865#issuecomment-652671600",
    "id": 652671600,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/12865",
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1MjY3MTYwMA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/652671600/reactions"
    },
    "updated_at": "2020-07-01T22:12:07Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/652671600",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/9250262?v=4",
      "events_url": "https://api.github.com/users/bergmeister/events{/privacy}",
      "followers_url": "https://api.github.com/users/bergmeister/followers",
      "following_url": "https://api.github.com/users/bergmeister/following{/other_user}",
      "gists_url": "https://api.github.com/users/bergmeister/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/bergmeister",
      "id": 9250262,
      "login": "bergmeister",
      "node_id": "MDQ6VXNlcjkyNTAyNjI=",
      "organizations_url": "https://api.github.com/users/bergmeister/orgs",
      "received_events_url": "https://api.github.com/users/bergmeister/received_events",
      "repos_url": "https://api.github.com/users/bergmeister/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/bergmeister/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bergmeister/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/bergmeister"
    }
  }
]
