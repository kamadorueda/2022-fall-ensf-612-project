[
  {
    "author_association": "COLLABORATOR",
    "body": "I don't think the second and third examples will ever be comparable.  The main difference iirc is that the `-match` operator will always build a hashtable and save it to `$matches`.\r\n\r\nIt'd be nice if `$matches` could be generated on demand, like a new `PSVariable` implementation that builds the hashtable in the `Value` getter (assuming it hasn't already been set externally)  Not sure how feasible (or worth it) that is.",
    "created_at": "2019-02-26T03:36:36Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8977#issuecomment-467281223",
    "id": 467281223,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8977",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzI4MTIyMw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467281223/reactions"
    },
    "updated_at": "2019-02-26T03:36:36Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467281223",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/24977523?v=4",
      "events_url": "https://api.github.com/users/SeeminglyScience/events{/privacy}",
      "followers_url": "https://api.github.com/users/SeeminglyScience/followers",
      "following_url": "https://api.github.com/users/SeeminglyScience/following{/other_user}",
      "gists_url": "https://api.github.com/users/SeeminglyScience/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SeeminglyScience",
      "id": 24977523,
      "login": "SeeminglyScience",
      "node_id": "MDQ6VXNlcjI0OTc3NTIz",
      "organizations_url": "https://api.github.com/users/SeeminglyScience/orgs",
      "received_events_url": "https://api.github.com/users/SeeminglyScience/received_events",
      "repos_url": "https://api.github.com/users/SeeminglyScience/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SeeminglyScience/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SeeminglyScience/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SeeminglyScience"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "Good point about the extra effort required to construct the `$Matches` hashtable, @SeeminglyScience, but do you think that alone explains _how much_ slower `-match` is (a factor of almost 8)?\r\n(And your suggestion of populating `$Matches` only on demand is also worth considering).\r\n\r\nWhat is the `// TODO: replace this with faster code` source-code comment trying to tell us?",
    "created_at": "2019-02-26T04:03:44Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8977#issuecomment-467286086",
    "id": 467286086,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8977",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzI4NjA4Ng==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467286086/reactions"
    },
    "updated_at": "2019-02-26T04:17:25Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467286086",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/588825?v=4",
      "events_url": "https://api.github.com/users/mklement0/events{/privacy}",
      "followers_url": "https://api.github.com/users/mklement0/followers",
      "following_url": "https://api.github.com/users/mklement0/following{/other_user}",
      "gists_url": "https://api.github.com/users/mklement0/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mklement0",
      "id": 588825,
      "login": "mklement0",
      "node_id": "MDQ6VXNlcjU4ODgyNQ==",
      "organizations_url": "https://api.github.com/users/mklement0/orgs",
      "received_events_url": "https://api.github.com/users/mklement0/received_events",
      "repos_url": "https://api.github.com/users/mklement0/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mklement0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mklement0/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mklement0"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "> do you think that alone explains _how much_ slower `-match` is (a factor of almost 8)?\r\n\r\nAt that scale yeah it wouldn't surprise me.  That's *a whole lot* of unused hashtables. You could always comment out that code and see if it's closer.\r\n\r\n> What is the `// TODO: replace this with faster code` source-code comment trying to tell us?\r\n\r\nI would guess that you wouldn't see any performance benefits for this scenario in that snippet.  The loop will already be fully compiled after a certain number of loops (I think somewhere around 32 loops?) Keep in mind that the same message is also above the expression creation for `-like` and `-join` (probably more as well)",
    "created_at": "2019-02-26T04:22:43Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8977#issuecomment-467289403",
    "id": 467289403,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8977",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzI4OTQwMw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467289403/reactions"
    },
    "updated_at": "2019-02-26T04:23:13Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467289403",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/24977523?v=4",
      "events_url": "https://api.github.com/users/SeeminglyScience/events{/privacy}",
      "followers_url": "https://api.github.com/users/SeeminglyScience/followers",
      "following_url": "https://api.github.com/users/SeeminglyScience/following{/other_user}",
      "gists_url": "https://api.github.com/users/SeeminglyScience/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SeeminglyScience",
      "id": 24977523,
      "login": "SeeminglyScience",
      "node_id": "MDQ6VXNlcjI0OTc3NTIz",
      "organizations_url": "https://api.github.com/users/SeeminglyScience/orgs",
      "received_events_url": "https://api.github.com/users/SeeminglyScience/received_events",
      "repos_url": "https://api.github.com/users/SeeminglyScience/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SeeminglyScience/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SeeminglyScience/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SeeminglyScience"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "What optimization do you ask? You do manual optimization by moving regex creation out of cycle. Such automatic optimization would be in c# compiler but not in PowerShell. Or do you want always compile regex? Perhaps we could use static regex and benefit from .Net Core cache for regex.",
    "created_at": "2019-02-26T05:04:04Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8977#issuecomment-467296575",
    "id": 467296575,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8977",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzI5NjU3NQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467296575/reactions"
    },
    "updated_at": "2019-02-26T05:04:04Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467296575",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22290914?v=4",
      "events_url": "https://api.github.com/users/iSazonov/events{/privacy}",
      "followers_url": "https://api.github.com/users/iSazonov/followers",
      "following_url": "https://api.github.com/users/iSazonov/following{/other_user}",
      "gists_url": "https://api.github.com/users/iSazonov/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/iSazonov",
      "id": 22290914,
      "login": "iSazonov",
      "node_id": "MDQ6VXNlcjIyMjkwOTE0",
      "organizations_url": "https://api.github.com/users/iSazonov/orgs",
      "received_events_url": "https://api.github.com/users/iSazonov/received_events",
      "repos_url": "https://api.github.com/users/iSazonov/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/iSazonov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iSazonov/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/iSazonov"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "Your hunch was correct, @SeeminglyScience: it is the `$Matches` construction that is the major factor in the slow-down (it's even easy to verify that without source-code changes, by wrapping the LHS into an array: `, $s -match $re`, which bypasses `$Matches`); it also explains why `-replace` is much less affected.\r\n\r\nWith `$Matches` out of the picture, the slow-down goes from about 8-fold down to about 30% in my tests, which is much more reasonable.\r\n\r\nI definitely like the idea of on-demand construction of `$Matches` - though I doubt that anyone cares enough to pursue this.\r\n\r\n@iSazonov: Based on the initial benchmarks, I wrongly concluded that precompiled regexes weren't used as-is, but they are.\r\n\r\nIf you use a string-literal regex with `switch`, the static `[regex]::Match()` is called in every iteration, but in .NET Core the automatic caching of compiled-behind-the-scenes regexes is quite efficient, so that using a precompiled regex yields only a modest speed improvement (it's much more pronounced in Windows PowerShell).\r\n\r\nAnyway, I'll close this, but I'll create a new, generic issue as a reminder that there may be performance gains to be had across the board by addressing  the `// TODO: replace this with faster code` comments.\r\n",
    "created_at": "2019-02-26T16:54:14Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8977#issuecomment-467519886",
    "id": 467519886,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8977",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzUxOTg4Ng==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467519886/reactions"
    },
    "updated_at": "2019-02-26T16:54:39Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467519886",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/588825?v=4",
      "events_url": "https://api.github.com/users/mklement0/events{/privacy}",
      "followers_url": "https://api.github.com/users/mklement0/followers",
      "following_url": "https://api.github.com/users/mklement0/following{/other_user}",
      "gists_url": "https://api.github.com/users/mklement0/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mklement0",
      "id": 588825,
      "login": "mklement0",
      "node_id": "MDQ6VXNlcjU4ODgyNQ==",
      "organizations_url": "https://api.github.com/users/mklement0/orgs",
      "received_events_url": "https://api.github.com/users/mklement0/received_events",
      "repos_url": "https://api.github.com/users/mklement0/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mklement0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mklement0/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mklement0"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "@mklement0 I remember Jason comment for me that we could remove the TODO comments because perhaps there does not exist direct and simple performance optimizations. So I think no need create new meta issue for this. Make sense to create new tracking issue for \"on-demand construction of $Matches\".",
    "created_at": "2019-02-26T17:40:29Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8977#issuecomment-467538237",
    "id": 467538237,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8977",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzUzODIzNw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467538237/reactions"
    },
    "updated_at": "2019-02-26T17:40:29Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467538237",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22290914?v=4",
      "events_url": "https://api.github.com/users/iSazonov/events{/privacy}",
      "followers_url": "https://api.github.com/users/iSazonov/followers",
      "following_url": "https://api.github.com/users/iSazonov/following{/other_user}",
      "gists_url": "https://api.github.com/users/iSazonov/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/iSazonov",
      "id": 22290914,
      "login": "iSazonov",
      "node_id": "MDQ6VXNlcjIyMjkwOTE0",
      "organizations_url": "https://api.github.com/users/iSazonov/orgs",
      "received_events_url": "https://api.github.com/users/iSazonov/received_events",
      "repos_url": "https://api.github.com/users/iSazonov/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/iSazonov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iSazonov/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/iSazonov"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "@iSazonov: Oops! Too late: #8989 - but I'll update the issue with your comments.",
    "created_at": "2019-02-26T18:13:53Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8977#issuecomment-467550579",
    "id": 467550579,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8977",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzU1MDU3OQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467550579/reactions"
    },
    "updated_at": "2019-02-26T18:13:53Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467550579",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/588825?v=4",
      "events_url": "https://api.github.com/users/mklement0/events{/privacy}",
      "followers_url": "https://api.github.com/users/mklement0/followers",
      "following_url": "https://api.github.com/users/mklement0/following{/other_user}",
      "gists_url": "https://api.github.com/users/mklement0/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mklement0",
      "id": 588825,
      "login": "mklement0",
      "node_id": "MDQ6VXNlcjU4ODgyNQ==",
      "organizations_url": "https://api.github.com/users/mklement0/orgs",
      "received_events_url": "https://api.github.com/users/mklement0/received_events",
      "repos_url": "https://api.github.com/users/mklement0/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mklement0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mklement0/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mklement0"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "@iSazonov:\r\n\r\n> Make sense to create new tracking issue for \"on-demand construction of $Matches\".\r\n\r\nAfter mulling this over some more, I'm no longer convinced it is a worthwhile effort, so I'll let it go (though, obviously, feel free to pick it up yourself).",
    "created_at": "2019-02-26T19:16:32Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8977#issuecomment-467573731",
    "id": 467573731,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8977",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzU3MzczMQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467573731/reactions"
    },
    "updated_at": "2019-02-26T19:16:32Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/467573731",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/588825?v=4",
      "events_url": "https://api.github.com/users/mklement0/events{/privacy}",
      "followers_url": "https://api.github.com/users/mklement0/followers",
      "following_url": "https://api.github.com/users/mklement0/following{/other_user}",
      "gists_url": "https://api.github.com/users/mklement0/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mklement0",
      "id": 588825,
      "login": "mklement0",
      "node_id": "MDQ6VXNlcjU4ODgyNQ==",
      "organizations_url": "https://api.github.com/users/mklement0/orgs",
      "received_events_url": "https://api.github.com/users/mklement0/received_events",
      "repos_url": "https://api.github.com/users/mklement0/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mklement0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mklement0/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mklement0"
    }
  }
]
