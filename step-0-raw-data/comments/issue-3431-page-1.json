[
  {
    "author_association": "NONE",
    "body": "To clarify, the same issue occurs when using modules defined via `New-Module`.\r\n\r\n```powershell\r\n$m = New-Module -ScriptBlock {\r\n    Function With-Foo {\r\n        param([ScriptBlock]$fn)\r\n        $foo = 4\r\n        &$fn\r\n    }\r\n}\r\n\r\nWith-Foo { Write-Host $foo }\r\n```\r\n\r\nwill not output anything.",
    "created_at": "2017-03-27T14:04:07Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/3431#issuecomment-289463248",
    "id": 289463248,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/3431",
    "node_id": "MDEyOklzc3VlQ29tbWVudDI4OTQ2MzI0OA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/289463248/reactions"
    },
    "updated_at": "2017-03-27T14:04:07Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/289463248",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/5000133?v=4",
      "events_url": "https://api.github.com/users/Flonk/events{/privacy}",
      "followers_url": "https://api.github.com/users/Flonk/followers",
      "following_url": "https://api.github.com/users/Flonk/following{/other_user}",
      "gists_url": "https://api.github.com/users/Flonk/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/Flonk",
      "id": 5000133,
      "login": "Flonk",
      "node_id": "MDQ6VXNlcjUwMDAxMzM=",
      "organizations_url": "https://api.github.com/users/Flonk/orgs",
      "received_events_url": "https://api.github.com/users/Flonk/received_events",
      "repos_url": "https://api.github.com/users/Flonk/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/Flonk/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Flonk/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/Flonk"
    }
  },
  {
    "author_association": "MEMBER",
    "body": "A script block is associated with the SessionState that it was created in, and it will execute in that same SessionState, because the script block is very likely depending on the state (functions, variables and etc) of the SessionState it was created in.\r\n\r\nIn your example, `With-Foo` will run in the module SessionState while `{write-host $foo}` is defined in a different SessionState, and thus it won't be able to see the variables defined in the module SessionState when running within `With-Foo`.\r\n\r\nHere is an example to demonstrate that:\r\n```\r\nPS:1> $m = New-Module -ScriptBlock {\r\n>>     Function With-Foo {\r\n>>         param([ScriptBlock]$fn)\r\n>>         $foo = 4\r\n>>         &$fn\r\n>>     }\r\n>> }\r\nPS:2> & { $foo = 100; With-Foo { Write-Host $foo } }\r\n100\r\nPS:3>\r\n```\r\n\r\nTo achieve what you expect, you can define `With-Foo` like this:\r\n```\r\n$m = New-Module -ScriptBlock {\r\n    Function With-Foo {\r\n        param([ScriptBlock]$fn)\r\n        $foo = 4\r\n        $newfn = $fn.Ast.GetScriptBlock() # create a new script block via the AST\r\n        & $newfn\r\n    }\r\n}\r\n```\r\nThen you will get what you expect:\r\n```\r\nPS:1> $m = New-Module -ScriptBlock {\r\n>>     Function With-Foo {\r\n>>         param([ScriptBlock]$fn)\r\n>>         $foo = 4\r\n>>         $newfn = $fn.Ast.GetScriptBlock() # create a new script block via the AST\r\n>>         & $newfn\r\n>>     }\r\n>> }\r\nPS:2>\r\nPS:2> With-Foo { Write-Host $foo }\r\n4\r\nPS:3>\r\n```",
    "created_at": "2017-03-27T20:08:35Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/3431#issuecomment-289570205",
    "id": 289570205,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/3431",
    "node_id": "MDEyOklzc3VlQ29tbWVudDI4OTU3MDIwNQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 3,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 3,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/289570205/reactions"
    },
    "updated_at": "2017-03-27T20:09:49Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/289570205",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/127450?v=4",
      "events_url": "https://api.github.com/users/daxian-dbw/events{/privacy}",
      "followers_url": "https://api.github.com/users/daxian-dbw/followers",
      "following_url": "https://api.github.com/users/daxian-dbw/following{/other_user}",
      "gists_url": "https://api.github.com/users/daxian-dbw/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/daxian-dbw",
      "id": 127450,
      "login": "daxian-dbw",
      "node_id": "MDQ6VXNlcjEyNzQ1MA==",
      "organizations_url": "https://api.github.com/users/daxian-dbw/orgs",
      "received_events_url": "https://api.github.com/users/daxian-dbw/received_events",
      "repos_url": "https://api.github.com/users/daxian-dbw/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/daxian-dbw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/daxian-dbw/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/daxian-dbw"
    }
  }
]
