[
  {
    "author_association": "NONE",
    "body": "I made a small script which use the Win32 API _WNetAddConnection2A_ under the hood.\r\n\r\nCan you try it ? \r\nI put all URL references and use enums, so in case, you want to change some parameters and debug.\r\nThe code in PSDrive is located here, if you want to check the default \r\nhttps://github.com/PowerShell/PowerShell/blob/b70f06ccc6041281b0f4dc6eaeefdbe5c649636d/src/System.Management.Automation/namespaces/FileSystemProvider.cs#L666\r\n\r\nCan you also compare with a _net use_ inside a cmd ? \r\n\r\nIf the problem is in the win32 API, that's a Windows bug.\r\n\r\n```\r\nAdd-Type -TypeDefinition @'\r\n\r\nusing System;\r\nusing System.Runtime.InteropServices;\r\n\r\nnamespace Utils \r\n{\r\n    public class Native\r\n    {\r\n        [DllImport(\"Mpr.dll\", EntryPoint = \"WNetAddConnection2\", CallingConvention = CallingConvention.Winapi)]\r\n        public static extern int WNetAddConnection2(NetResource lpNetResource,\r\n                                                    string lpPassword,\r\n                                                    string lpUsername,\r\n                                                    UInt32 dwFlags);\r\n                                                     \r\n        [DllImport(\"Mpr.dll\", EntryPoint = \"WNetCancelConnection2\",CallingConvention = CallingConvention.Winapi)]\r\n        public static extern int WNetCancelConnection2(string lpName,\r\n                                                       UInt32 dwFlags,\r\n                                                       Boolean fForce);\r\n    }\r\n\r\n    [StructLayout(LayoutKind.Sequential)]\r\n    public class NetResource\r\n    {\r\n        public int dwScope;\r\n        public int dwType;\r\n        public int dwDisplayType;\r\n        public int dwUsage;\r\n        public string lpLocalName;\r\n        public string lpRemoteName;\r\n        public string lpComment;\r\n        public string lpProvider;\r\n    }\r\n    \r\n    public enum ResourceScope\r\n    {\r\n        CONNECTED  = 0x00000001,\r\n        GLOBALNET  = 0x00000002,\r\n        REMEMBERED = 0x00000003\r\n    }\r\n\r\n    public enum ResourceType\r\n    {\r\n        ANY,\r\n        DISK,\r\n        PRINT\r\n    };\r\n\r\n    public enum ResourceUsage\r\n    {\r\n        CONNECTABLE   = 0x00000001,\r\n        CONTAINER     = 0x00000002\r\n    };\r\n\r\n    public enum ResourceDisplayType\r\n    {\r\n        GENERIC,\r\n        DOMAIN,\r\n        SERVER,\r\n        SHARE\r\n    };\r\n    \r\n    public enum Connect\r\n    {\r\n        UPDATE_PROFILE = 0x00000001,\r\n        UPDATE_RECENT  = 0x00000002,\r\n        TEMPORARY      = 0x00000004,\r\n        INTERACTIVE    = 0x00000008,\r\n        PROMPT         = 0x00000010,\r\n        REDIRECT       = 0x00000080,\r\n        CURRENT_MEDIA  = 0x00000200,\r\n        COMMANDLINE    = 0x00000800,\r\n        CMD_SAVECRED   = 0x00001000,\r\n        CRED_RESET     = 0x00002000\r\n    };\r\n    \r\n}\r\n\r\n'@\r\n\r\n$username  = 'ComputerName\\UserName'\r\n$password  = 'Passw@rd'\r\n$driveName = 'R:'\r\n$sharePath = '\\\\ComputerName\\Share'\r\n\r\n# see https://docs.microsoft.com/en-us/windows/win32/api/winnetwk/nf-winnetwk-wnetcancelconnection2a\r\n[Utils.Native]::WNetCancelConnection2($driveName, 0, $true) | Out-Null\r\n\r\n# see https://docs.microsoft.com/en-us/windows/win32/api/winnetwk/ns-winnetwk-netresourcea\r\n$netResource = [Utils.NetResource]@{\r\n    dwScope       = [Utils.ResourceScope]::GLOBALNET\r\n    dwType        = [Utils.ResourceType]::DISK\r\n    dwDisplayType = [Utils.ResourceDisplayType]::GENERIC\r\n    dwUsage       = [Utils.ResourceUsage]::CONNECTABLE\r\n    lpLocalName   = $driveName\r\n    lpRemoteName  = $sharePath\r\n}\r\n\r\n# see https://docs.microsoft.com/en-us/windows/win32/api/winnetwk/nf-winnetwk-wnetaddconnection2a\r\n$result = [Utils.Native]::WNetAddConnection2($netResource, $password, $username, [Utils.Connect]::TEMPORARY)\r\nif ($result -ne 0) {\r\n    Write-Host \"Error $result :\" ([System.ComponentModel.Win32Exception]::new($result)).Message\r\n}\r\n```\r\n",
    "created_at": "2021-08-12T21:08:42Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/15913#issuecomment-897969267",
    "id": 897969267,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15913",
    "node_id": "IC_kwDOAvT7bc41hexz",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/897969267/reactions"
    },
    "updated_at": "2021-08-12T21:08:42Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/897969267",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/6187529?v=4",
      "events_url": "https://api.github.com/users/fMichaleczek/events{/privacy}",
      "followers_url": "https://api.github.com/users/fMichaleczek/followers",
      "following_url": "https://api.github.com/users/fMichaleczek/following{/other_user}",
      "gists_url": "https://api.github.com/users/fMichaleczek/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/fMichaleczek",
      "id": 6187529,
      "login": "fMichaleczek",
      "node_id": "MDQ6VXNlcjYxODc1Mjk=",
      "organizations_url": "https://api.github.com/users/fMichaleczek/orgs",
      "received_events_url": "https://api.github.com/users/fMichaleczek/received_events",
      "repos_url": "https://api.github.com/users/fMichaleczek/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/fMichaleczek/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fMichaleczek/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/fMichaleczek"
    }
  },
  {
    "author_association": "NONE",
    "body": "Thanks for your work and answering @fMichaleczek !\r\nWhen I use `net use` like this:\r\n```Batch\r\nnet use U: \\\\172.16.19.250\\client1 /user:backup1 \"4c&[rvPh0m[0yGb)\" /persistent:No\r\n```\r\n**No ID 4625 are generating**. 1 ID 4776 and 1 ID 4624 are generate. \r\n\r\nWhen I use your script, with `Windows PowerShell 5.1`, `PWSH 7.1` and `7.2 Preview 8`, 1 ID 4776 and 1 ID 4624. **No ID 4625 are generating**. It works.\r\n\r\nI have just one question, when I use `New-PSDrive -Name \"SaveBackup\" -PSProvider \"FileSystem\" -Root \"\\\\$smbServer\\client1\" -Credential $credObject` I am using `-Root` option. It's important for us to havenâ€™t a drive letter. It's possible to do the same with your syntax? I'm not used to this way of doing.\r\n\r\nOut of my case, do you think this problem can be fixed (Powershell teams or Windows teams)?",
    "created_at": "2021-08-13T08:01:54Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/15913#issuecomment-898267253",
    "id": 898267253,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15913",
    "node_id": "IC_kwDOAvT7bc41inh1",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/898267253/reactions"
    },
    "updated_at": "2021-08-13T08:01:54Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/898267253",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/88830012?v=4",
      "events_url": "https://api.github.com/users/clementbey/events{/privacy}",
      "followers_url": "https://api.github.com/users/clementbey/followers",
      "following_url": "https://api.github.com/users/clementbey/following{/other_user}",
      "gists_url": "https://api.github.com/users/clementbey/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/clementbey",
      "id": 88830012,
      "login": "clementbey",
      "node_id": "MDQ6VXNlcjg4ODMwMDEy",
      "organizations_url": "https://api.github.com/users/clementbey/orgs",
      "received_events_url": "https://api.github.com/users/clementbey/received_events",
      "repos_url": "https://api.github.com/users/clementbey/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/clementbey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/clementbey/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/clementbey"
    }
  },
  {
    "author_association": "NONE",
    "body": "@clementbey I will continue to investigate (need to build a lab to reproduce). But the Win32 API works as expected. The problem seems located  in the PowerShell basecode. I hope to make a workaround function and propose a solution to the PowerShell Teams.\r\n/cc @SteveL-MSFT ",
    "created_at": "2021-08-13T09:33:17Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/15913#issuecomment-898327671",
    "id": 898327671,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15913",
    "node_id": "IC_kwDOAvT7bc41i2R3",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 2,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 2,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/898327671/reactions"
    },
    "updated_at": "2021-08-13T09:52:24Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/898327671",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/6187529?v=4",
      "events_url": "https://api.github.com/users/fMichaleczek/events{/privacy}",
      "followers_url": "https://api.github.com/users/fMichaleczek/followers",
      "following_url": "https://api.github.com/users/fMichaleczek/following{/other_user}",
      "gists_url": "https://api.github.com/users/fMichaleczek/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/fMichaleczek",
      "id": 6187529,
      "login": "fMichaleczek",
      "node_id": "MDQ6VXNlcjYxODc1Mjk=",
      "organizations_url": "https://api.github.com/users/fMichaleczek/orgs",
      "received_events_url": "https://api.github.com/users/fMichaleczek/received_events",
      "repos_url": "https://api.github.com/users/fMichaleczek/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/fMichaleczek/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fMichaleczek/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/fMichaleczek"
    }
  },
  {
    "author_association": "NONE",
    "body": "Hello @fMichaleczek (and happy new year),\r\nAny news or plan about this issue ? ",
    "created_at": "2022-01-05T15:49:33Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/15913#issuecomment-1005844180",
    "id": 1005844180,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15913",
    "node_id": "IC_kwDOAvT7bc478_bU",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1005844180/reactions"
    },
    "updated_at": "2022-01-05T15:49:33Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1005844180",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/88830012?v=4",
      "events_url": "https://api.github.com/users/clementbey/events{/privacy}",
      "followers_url": "https://api.github.com/users/clementbey/followers",
      "following_url": "https://api.github.com/users/clementbey/following{/other_user}",
      "gists_url": "https://api.github.com/users/clementbey/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/clementbey",
      "id": 88830012,
      "login": "clementbey",
      "node_id": "MDQ6VXNlcjg4ODMwMDEy",
      "organizations_url": "https://api.github.com/users/clementbey/orgs",
      "received_events_url": "https://api.github.com/users/clementbey/received_events",
      "repos_url": "https://api.github.com/users/clementbey/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/clementbey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/clementbey/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/clementbey"
    }
  }
]
