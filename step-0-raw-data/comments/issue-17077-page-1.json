[
  {
    "author_association": "COLLABORATOR",
    "body": "Ooh, that's a fun one. \r\n\r\nI'm not sure there's going to be able to be a solution to this.\r\n\r\nPowerShell scriptblocks are bound to the runspace they're created in by design, so yeah attaching a script method to an object and trying to use that in another runspace is going to cause some issues.\r\n\r\nMight be something for the documentation of `ForEach-Object` to mention, there's a fair few pitfalls you can hit with `-Parallel` ðŸ˜” ",
    "created_at": "2022-03-29T12:51:00Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17077#issuecomment-1081832142",
    "id": 1081832142,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17077",
    "node_id": "IC_kwDOAvT7bc5Ae3LO",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 4,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 4,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1081832142/reactions"
    },
    "updated_at": "2022-03-29T12:51:00Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1081832142",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/32407840?v=4",
      "events_url": "https://api.github.com/users/vexx32/events{/privacy}",
      "followers_url": "https://api.github.com/users/vexx32/followers",
      "following_url": "https://api.github.com/users/vexx32/following{/other_user}",
      "gists_url": "https://api.github.com/users/vexx32/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/vexx32",
      "id": 32407840,
      "login": "vexx32",
      "node_id": "MDQ6VXNlcjMyNDA3ODQw",
      "organizations_url": "https://api.github.com/users/vexx32/orgs",
      "received_events_url": "https://api.github.com/users/vexx32/received_events",
      "repos_url": "https://api.github.com/users/vexx32/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/vexx32/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vexx32/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/vexx32"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "I agree it's unlikely to be fixable. A better error message would be ideal though. A NRE should probably never be surfaced to user code. If I had to guess, it's due to the bound runspace no longer existing.\r\n\r\n`Get-Error` results for `$res[0].GetA()` gives a better stack trace:\r\n\r\n```python\r\nException             :\r\n    Type       : System.NullReferenceException\r\n    TargetSite :\r\n        Name          : InvokeWithPipe\r\n        DeclaringType : scriptblock\r\n        MemberType    : Method\r\n        Module        : System.Management.Automation.dll\r\n    Message    : Object reference not set to an instance of an object.\r\n    Data       : System.Collections.ListDictionaryInternal\r\n    Source     : System.Management.Automation\r\n    HResult    : -2147467261\r\n    StackTrace :\r\n   at System.Management.Automation.ScriptBlock.InvokeWithPipe(Boolean useLocalScope, ErrorHandlingBehavior errorHandlingBehavior, Object\r\ndollarUnder, Object input, Object scriptThis, Pipe outputPipe, InvocationInfo invocationInfo, Boolean propagateAllExceptionsToTop, List`1\r\nvariablesToDefine, Dictionary`2 functionsToDefine, Object[] args)\r\n   at System.Management.Automation.ScriptBlock.DoInvokeReturnAsIs(Boolean useLocalScope, ErrorHandlingBehavior errorHandlingBehavior,\r\nObject dollarUnder, Object input, Object scriptThis, Object[] args)\r\n   at System.Management.Automation.PSScriptMethod.InvokeScript(String methodName, ScriptBlock script, Object this, Object[] arguments)\r\n   at System.Management.Automation.PSScriptMethod.Invoke(Object[] arguments)\r\n   at System.Dynamic.UpdateDelegates.UpdateAndExecute1[T0,TRet](CallSite site, T0 arg0)\r\n   at System.Management.Automation.Interpreter.DynamicInstruction`2.Run(InterpretedFrame frame)\r\n   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\r\nCategoryInfo          : OperationStopped: (:) [], NullReferenceException\r\nFullyQualifiedErrorId : System.NullReferenceException\r\nInvocationInfo        :\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 1\r\n    HistoryId        : -1\r\n    Line             : $res[0].GetA()\r\n    PositionMessage  : At line:1 char:1\r\n                       + $res[0].GetA()\r\n                       + ~~~~~~~~~~~~~~\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n```",
    "created_at": "2022-03-29T13:54:09Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17077#issuecomment-1081902394",
    "id": 1081902394,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17077",
    "node_id": "IC_kwDOAvT7bc5AfIU6",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 4,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 4,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1081902394/reactions"
    },
    "updated_at": "2022-03-29T13:55:02Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1081902394",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/24977523?v=4",
      "events_url": "https://api.github.com/users/SeeminglyScience/events{/privacy}",
      "followers_url": "https://api.github.com/users/SeeminglyScience/followers",
      "following_url": "https://api.github.com/users/SeeminglyScience/following{/other_user}",
      "gists_url": "https://api.github.com/users/SeeminglyScience/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SeeminglyScience",
      "id": 24977523,
      "login": "SeeminglyScience",
      "node_id": "MDQ6VXNlcjI0OTc3NTIz",
      "organizations_url": "https://api.github.com/users/SeeminglyScience/orgs",
      "received_events_url": "https://api.github.com/users/SeeminglyScience/received_events",
      "repos_url": "https://api.github.com/users/SeeminglyScience/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SeeminglyScience/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SeeminglyScience/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SeeminglyScience"
    }
  },
  {
    "author_association": "NONE",
    "body": "I understand the runspace issue on the scriptblocks.\r\nThough, sometimes a workaround is as good as a fix ðŸ˜…. What about recreating the Scriptblocks in the new runspace when `ForEach-Object` pushes the objects back to the pipeline?\r\nAn *ugly as hell* example:\r\n```pwsh\r\n> $res = 1..3 | % -Parallel { $o = [pscustomobject]@{'a'=$_}; `\r\n                      Add-Member -InputObject $o -Type ScriptMethod -Name GetA -Value {$this.a} -force -PassThru} `\r\n            | % { # postprocessing to fix scriptblocks by creating a copy into this runspace\r\n            foreach ( $name in ($_ | Get-Member -MemberType ScriptMethod).name)\r\n            {\r\n                 Add-Member -InputObject $_ -MemberType ScriptMethod -Name $name `\r\n                            -Value ([ScriptBlock]::Create($_.$name.Script)) -Force -PassThru \r\n            }}\r\n> $res.GetA()\r\n1\r\n3\r\n2\r\n```\r\nNote that `ScriptMethods` and `ScriptProperties` often only reference `$this` contents.",
    "created_at": "2022-03-30T07:17:47Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17077#issuecomment-1082715435",
    "id": 1082715435,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17077",
    "node_id": "IC_kwDOAvT7bc5AiO0r",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1082715435/reactions"
    },
    "updated_at": "2022-03-30T07:17:47Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1082715435",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/45819833?v=4",
      "events_url": "https://api.github.com/users/MiguelBarro/events{/privacy}",
      "followers_url": "https://api.github.com/users/MiguelBarro/followers",
      "following_url": "https://api.github.com/users/MiguelBarro/following{/other_user}",
      "gists_url": "https://api.github.com/users/MiguelBarro/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/MiguelBarro",
      "id": 45819833,
      "login": "MiguelBarro",
      "node_id": "MDQ6VXNlcjQ1ODE5ODMz",
      "organizations_url": "https://api.github.com/users/MiguelBarro/orgs",
      "received_events_url": "https://api.github.com/users/MiguelBarro/received_events",
      "repos_url": "https://api.github.com/users/MiguelBarro/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/MiguelBarro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MiguelBarro/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/MiguelBarro"
    }
  },
  {
    "author_association": "NONE",
    "body": ".net has parrallel array named ConcurrentBag. I'm guessing that you want an object's property to be a concurrent array.\r\nI remember that the manual suggested:\r\nThread-safe objects, such as thread-safe queues, thread-safe stacks, thread-safe hash tables, should only be used in foreach-object -Parallel.\r\n",
    "created_at": "2022-03-30T16:40:44Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17077#issuecomment-1083372572",
    "id": 1083372572,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17077",
    "node_id": "IC_kwDOAvT7bc5AkvQc",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1083372572/reactions"
    },
    "updated_at": "2022-03-30T17:11:49Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1083372572",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/65390418?v=4",
      "events_url": "https://api.github.com/users/kasini3000/events{/privacy}",
      "followers_url": "https://api.github.com/users/kasini3000/followers",
      "following_url": "https://api.github.com/users/kasini3000/following{/other_user}",
      "gists_url": "https://api.github.com/users/kasini3000/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/kasini3000",
      "id": 65390418,
      "login": "kasini3000",
      "node_id": "MDQ6VXNlcjY1MzkwNDE4",
      "organizations_url": "https://api.github.com/users/kasini3000/orgs",
      "received_events_url": "https://api.github.com/users/kasini3000/received_events",
      "repos_url": "https://api.github.com/users/kasini3000/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/kasini3000/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kasini3000/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/kasini3000"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "/cc @PaulHigin is there something we can do here to give the user a better error message, perhaps?",
    "created_at": "2022-03-31T22:14:03Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17077#issuecomment-1085179910",
    "id": 1085179910,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17077",
    "node_id": "IC_kwDOAvT7bc5ArogG",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1085179910/reactions"
    },
    "updated_at": "2022-03-31T22:14:27Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1085179910",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/32407840?v=4",
      "events_url": "https://api.github.com/users/vexx32/events{/privacy}",
      "followers_url": "https://api.github.com/users/vexx32/followers",
      "following_url": "https://api.github.com/users/vexx32/following{/other_user}",
      "gists_url": "https://api.github.com/users/vexx32/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/vexx32",
      "id": 32407840,
      "login": "vexx32",
      "node_id": "MDQ6VXNlcjMyNDA3ODQw",
      "organizations_url": "https://api.github.com/users/vexx32/orgs",
      "received_events_url": "https://api.github.com/users/vexx32/received_events",
      "repos_url": "https://api.github.com/users/vexx32/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/vexx32/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vexx32/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/vexx32"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "We already search the Ast for some known thread safety issues in the scriptlbock, but missed this case.  I agree that this should be included.  ",
    "created_at": "2022-03-31T22:42:53Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17077#issuecomment-1085200397",
    "id": 1085200397,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17077",
    "node_id": "IC_kwDOAvT7bc5ArtgN",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1085200397/reactions"
    },
    "updated_at": "2022-03-31T22:42:53Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1085200397",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/14019529?v=4",
      "events_url": "https://api.github.com/users/PaulHigin/events{/privacy}",
      "followers_url": "https://api.github.com/users/PaulHigin/followers",
      "following_url": "https://api.github.com/users/PaulHigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulHigin/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/PaulHigin",
      "id": 14019529,
      "login": "PaulHigin",
      "node_id": "MDQ6VXNlcjE0MDE5NTI5",
      "organizations_url": "https://api.github.com/users/PaulHigin/orgs",
      "received_events_url": "https://api.github.com/users/PaulHigin/received_events",
      "repos_url": "https://api.github.com/users/PaulHigin/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/PaulHigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulHigin/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/PaulHigin"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "WG-Engine:\r\n\r\nWe don't think it's likely this could easily work as might be expected, but we think it's reasonable that we could provide a more informative error message to users when this is attempted. Exposing a NullReferenceException in this case is a bug, and we should have a null check here so that we can give a better error message.\r\n\r\nThe underlying issue appears to be that the ScriptMethods are attached to a secondary runspace created by ForEach-Object -Parallel, and then called after the secondary runspaces are disposed, creating the scenario where the runspace the scriptblock is bound to has been destroyed.\r\n\r\n/cc @sdwheeler it would probably be a good idea to mention in the documentation for `-Parallel` and also the documentation for `Add-Member` that objects with attached script methods cannot be safely passed between runspaces.",
    "created_at": "2022-03-31T23:35:22Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17077#issuecomment-1085231548",
    "id": 1085231548,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17077",
    "node_id": "IC_kwDOAvT7bc5Ar1G8",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1085231548/reactions"
    },
    "updated_at": "2022-03-31T23:35:22Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1085231548",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/32407840?v=4",
      "events_url": "https://api.github.com/users/vexx32/events{/privacy}",
      "followers_url": "https://api.github.com/users/vexx32/followers",
      "following_url": "https://api.github.com/users/vexx32/following{/other_user}",
      "gists_url": "https://api.github.com/users/vexx32/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/vexx32",
      "id": 32407840,
      "login": "vexx32",
      "node_id": "MDQ6VXNlcjMyNDA3ODQw",
      "organizations_url": "https://api.github.com/users/vexx32/orgs",
      "received_events_url": "https://api.github.com/users/vexx32/received_events",
      "repos_url": "https://api.github.com/users/vexx32/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/vexx32/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vexx32/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/vexx32"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "@vexx32 @PaulHigin Could someone file a [docs issue](https://github.com/MicrosoftDocs/PowerShell-Docs/issues/new/choose) and include the pertinent details?",
    "created_at": "2022-04-01T13:32:44Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17077#issuecomment-1085904810",
    "id": 1085904810,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17077",
    "node_id": "IC_kwDOAvT7bc5AuZeq",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1085904810/reactions"
    },
    "updated_at": "2022-04-01T13:32:44Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1085904810",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/19415881?v=4",
      "events_url": "https://api.github.com/users/sdwheeler/events{/privacy}",
      "followers_url": "https://api.github.com/users/sdwheeler/followers",
      "following_url": "https://api.github.com/users/sdwheeler/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdwheeler/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/sdwheeler",
      "id": 19415881,
      "login": "sdwheeler",
      "node_id": "MDQ6VXNlcjE5NDE1ODgx",
      "organizations_url": "https://api.github.com/users/sdwheeler/orgs",
      "received_events_url": "https://api.github.com/users/sdwheeler/received_events",
      "repos_url": "https://api.github.com/users/sdwheeler/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/sdwheeler/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdwheeler/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/sdwheeler"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "Doc issue: https://github.com/MicrosoftDocs/PowerShell-Docs/issues/8713",
    "created_at": "2022-04-01T20:50:19Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17077#issuecomment-1086311759",
    "id": 1086311759,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17077",
    "node_id": "IC_kwDOAvT7bc5Av81P",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1086311759/reactions"
    },
    "updated_at": "2022-04-01T20:50:19Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1086311759",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/32407840?v=4",
      "events_url": "https://api.github.com/users/vexx32/events{/privacy}",
      "followers_url": "https://api.github.com/users/vexx32/followers",
      "following_url": "https://api.github.com/users/vexx32/following{/other_user}",
      "gists_url": "https://api.github.com/users/vexx32/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/vexx32",
      "id": 32407840,
      "login": "vexx32",
      "node_id": "MDQ6VXNlcjMyNDA3ODQw",
      "organizations_url": "https://api.github.com/users/vexx32/orgs",
      "received_events_url": "https://api.github.com/users/vexx32/received_events",
      "repos_url": "https://api.github.com/users/vexx32/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/vexx32/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vexx32/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/vexx32"
    }
  }
]
