[
  {
    "author_association": "MEMBER",
    "body": ">   $output = & $using:f1Func $_\r\n\r\nThe `FunctionInfo` object is passed to different Runspace’s for execution, so it’s highly likely that you were experiencing state corruption because of that.\r\n\r\nThere is a concept of “Runspace affinity” – a script block is associated with the Runspace where it was created, so when it’s running in a different Runspace, the script block will be marshalled back to the Runspace where it was created to execute. This design is built on the assumption that a script block created in a Runspace is likely to depend on resources only available in that Runsapce at the run time. However, in practice, this causes a lot problems when you share a script block among multiple Runsapces. Here are some issues tracking this on GitHub: #4003, #7626.\r\n\r\nSimply put, this may cause the session state of the original Runspace, where the script block was created, to be corrupted, and thus you will see errors like “Write-Host is not recognized as the name of a cmdlet” because the command lookup through scopes failed (the script block could be running with a dangling scope that was remove from the chain prematurely).\r\n\r\nSo, the solution is to not share script block among Runspace’s. Instead, share the AST among those Runsapce’s. In your case, it would be something like this:\r\n\r\n```\r\n$f1Func = Get-Command -Name \"f1\"\r\n$f1BodyAst = $f1Func.ScriptBlock.Ast.Body\r\n\r\n$job = $inputs | ForEach-Object -AsJob -ThrottleLimit 2 -Parallel {\r\n    if (-not $global:f1Func)\r\n    {\r\n        $ast = $using:f1BodyAst\r\n        # this creates a new script block in the Runspace where it’s supposed to be running. \r\n        $global:f1Func = $ast.GetScriptBlock()\r\n    }\r\n\r\n    $output = & $global:f1Func $_\r\n    if ($output -eq $null)\r\n    {\r\n        # do something\r\n    }\r\n}\r\n```\r\n\r\n@PaulHigin did some work to disallow passing script block with `$using` when using `ForEach-Object -Parallel` (code is [here](https://github.com/PowerShell/PowerShell/blob/7dc4587014bfa22919c933607bf564f0ba53db2e/src/System.Management.Automation/engine/InternalCommands.cs#L432-L443)), but I guess it should **disallow FunctionInfo, FilterInfo, and ExternalScriptBlockInfo** too.\r\n\r\n![image](https://user-images.githubusercontent.com/127450/141601255-cf08257b-8d00-4579-8d50-7b22aaeb2be7.png)\r\n\r\nAlso, it would be nice to document the workaround using AST for scenarios like this one, and make the error message thrown from PowerShell points to the that doc, so the user can learn about this workaround.",
    "created_at": "2021-11-13T01:50:27Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/16461#issuecomment-967759037",
    "id": 967759037,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/16461",
    "node_id": "IC_kwDOAvT7bc45rtS9",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/967759037/reactions"
    },
    "updated_at": "2021-11-15T01:13:31Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/967759037",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/127450?v=4",
      "events_url": "https://api.github.com/users/daxian-dbw/events{/privacy}",
      "followers_url": "https://api.github.com/users/daxian-dbw/followers",
      "following_url": "https://api.github.com/users/daxian-dbw/following{/other_user}",
      "gists_url": "https://api.github.com/users/daxian-dbw/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/daxian-dbw",
      "id": 127450,
      "login": "daxian-dbw",
      "node_id": "MDQ6VXNlcjEyNzQ1MA==",
      "organizations_url": "https://api.github.com/users/daxian-dbw/orgs",
      "received_events_url": "https://api.github.com/users/daxian-dbw/received_events",
      "repos_url": "https://api.github.com/users/daxian-dbw/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/daxian-dbw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/daxian-dbw/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/daxian-dbw"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "> Instead, share the AST among those Runsapce’s. In your case, it would be something like this:\r\n\r\nIf it is an unambiguous match we could do it automatically. Simply banning these constructs is bad UX. It would be much easier for users to use intuitive explicit constructs and the Engine would convert this into the correct implementation.",
    "created_at": "2021-11-13T06:05:59Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/16461#issuecomment-967789293",
    "id": 967789293,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/16461",
    "node_id": "IC_kwDOAvT7bc45r0rt",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/967789293/reactions"
    },
    "updated_at": "2021-11-13T06:05:59Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/967789293",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22290914?v=4",
      "events_url": "https://api.github.com/users/iSazonov/events{/privacy}",
      "followers_url": "https://api.github.com/users/iSazonov/followers",
      "following_url": "https://api.github.com/users/iSazonov/following{/other_user}",
      "gists_url": "https://api.github.com/users/iSazonov/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/iSazonov",
      "id": 22290914,
      "login": "iSazonov",
      "node_id": "MDQ6VXNlcjIyMjkwOTE0",
      "organizations_url": "https://api.github.com/users/iSazonov/orgs",
      "received_events_url": "https://api.github.com/users/iSazonov/received_events",
      "repos_url": "https://api.github.com/users/iSazonov/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/iSazonov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iSazonov/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/iSazonov"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "> If it is an unambiguous match we could do it automatically. Simply banning these constructs is bad UX. It would be much easier for users to use intuitive explicit constructs and the Engine would convert this into the correct implementation.\r\n\r\nI fear that if that's done automatically it will lead to a lot of confusion about why the function can't access the state it previously could. While the error isn't great UX, it happens at design time and is instantly clear what is wrong. Plus the work around makes it a lot easier to understand that it won't work exactly the same.",
    "created_at": "2021-11-13T14:40:22Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/16461#issuecomment-968078811",
    "id": 968078811,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/16461",
    "node_id": "IC_kwDOAvT7bc45s7Xb",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/968078811/reactions"
    },
    "updated_at": "2021-11-13T14:40:22Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/968078811",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/24977523?v=4",
      "events_url": "https://api.github.com/users/SeeminglyScience/events{/privacy}",
      "followers_url": "https://api.github.com/users/SeeminglyScience/followers",
      "following_url": "https://api.github.com/users/SeeminglyScience/following{/other_user}",
      "gists_url": "https://api.github.com/users/SeeminglyScience/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SeeminglyScience",
      "id": 24977523,
      "login": "SeeminglyScience",
      "node_id": "MDQ6VXNlcjI0OTc3NTIz",
      "organizations_url": "https://api.github.com/users/SeeminglyScience/orgs",
      "received_events_url": "https://api.github.com/users/SeeminglyScience/received_events",
      "repos_url": "https://api.github.com/users/SeeminglyScience/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SeeminglyScience/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SeeminglyScience/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SeeminglyScience"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "> I fear that if that's done automatically it will lead to a lot of confusion about why the function can't access the state it previously could.\r\n\r\nWhy? `$Using` assumes coping an entity to _another_ context. \r\nOne more option we discussed already is to clone whole context. It is slow to start but this could be useful in some scenarios.\r\n\r\nI don't like workarounds in languages. Languages are designed _to make things easier_. If a consumer has to make workarounds, it means the language creator did not think the language or its implementation through.",
    "created_at": "2021-11-13T17:30:57Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/16461#issuecomment-968104898",
    "id": 968104898,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/16461",
    "node_id": "IC_kwDOAvT7bc45tBvC",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/968104898/reactions"
    },
    "updated_at": "2021-11-13T17:30:57Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/968104898",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22290914?v=4",
      "events_url": "https://api.github.com/users/iSazonov/events{/privacy}",
      "followers_url": "https://api.github.com/users/iSazonov/followers",
      "following_url": "https://api.github.com/users/iSazonov/following{/other_user}",
      "gists_url": "https://api.github.com/users/iSazonov/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/iSazonov",
      "id": 22290914,
      "login": "iSazonov",
      "node_id": "MDQ6VXNlcjIyMjkwOTE0",
      "organizations_url": "https://api.github.com/users/iSazonov/orgs",
      "received_events_url": "https://api.github.com/users/iSazonov/received_events",
      "repos_url": "https://api.github.com/users/iSazonov/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/iSazonov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iSazonov/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/iSazonov"
    }
  },
  {
    "author_association": "MEMBER",
    "body": "This is a workaround to a bug, and that bug will be fixed at some point, even though it's low priority today.",
    "created_at": "2021-11-13T17:50:37Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/16461#issuecomment-968107849",
    "id": 968107849,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/16461",
    "node_id": "IC_kwDOAvT7bc45tCdJ",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/968107849/reactions"
    },
    "updated_at": "2021-11-15T01:13:57Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/968107849",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/127450?v=4",
      "events_url": "https://api.github.com/users/daxian-dbw/events{/privacy}",
      "followers_url": "https://api.github.com/users/daxian-dbw/followers",
      "following_url": "https://api.github.com/users/daxian-dbw/following{/other_user}",
      "gists_url": "https://api.github.com/users/daxian-dbw/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/daxian-dbw",
      "id": 127450,
      "login": "daxian-dbw",
      "node_id": "MDQ6VXNlcjEyNzQ1MA==",
      "organizations_url": "https://api.github.com/users/daxian-dbw/orgs",
      "received_events_url": "https://api.github.com/users/daxian-dbw/received_events",
      "repos_url": "https://api.github.com/users/daxian-dbw/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/daxian-dbw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/daxian-dbw/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/daxian-dbw"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "> Why? `$Using` assumes coping an entity to _another_ context. \r\n\r\nIt did with serialization, with thread jobs it doesn't imply a copy/clone.\r\n\r\n> I don't like workarounds in languages. Languages are designed _to make things easier_. If a consumer has to make workarounds, it means the language creator did not think the language or its implementation through.\r\n\r\nI don't disagree, but they're still preferred until the right solution is determined.\r\n\r\n",
    "created_at": "2021-11-13T18:15:12Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/16461#issuecomment-968111802",
    "id": 968111802,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/16461",
    "node_id": "IC_kwDOAvT7bc45tDa6",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/968111802/reactions"
    },
    "updated_at": "2021-11-13T18:15:12Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/968111802",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/24977523?v=4",
      "events_url": "https://api.github.com/users/SeeminglyScience/events{/privacy}",
      "followers_url": "https://api.github.com/users/SeeminglyScience/followers",
      "following_url": "https://api.github.com/users/SeeminglyScience/following{/other_user}",
      "gists_url": "https://api.github.com/users/SeeminglyScience/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SeeminglyScience",
      "id": 24977523,
      "login": "SeeminglyScience",
      "node_id": "MDQ6VXNlcjI0OTc3NTIz",
      "organizations_url": "https://api.github.com/users/SeeminglyScience/orgs",
      "received_events_url": "https://api.github.com/users/SeeminglyScience/received_events",
      "repos_url": "https://api.github.com/users/SeeminglyScience/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SeeminglyScience/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SeeminglyScience/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SeeminglyScience"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "This has nothing to do with the remoting system, so changing working group to core cmdlets.\r\n\r\nIt looks like there are two issues here with the `$using:` keyword.\r\n\r\nOne is using unsafe objects (objects with runspace affinity and/or with thread safety issues).  This can be mitigated by detecting the use of these new objects and providing a useful error message.\r\n\r\nThe other is the (reasonable) expectation that parallel running runspaces share the same state as the runspace hosting the `foreach-object -parallel` call, and is captured in this issue (#12240).  Unfortunately, this has been considered lower priority and I have not been able to work on it yet.\r\n\r\nIt should be noted that these issues are not unique to `foreach-object -parallel`, and are simply inherent weaknesses of PowerShell threading and script execution model.  ",
    "created_at": "2021-11-15T18:19:35Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/16461#issuecomment-969188681",
    "id": 969188681,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/16461",
    "node_id": "IC_kwDOAvT7bc45xKVJ",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/969188681/reactions"
    },
    "updated_at": "2021-11-15T18:19:35Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/969188681",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/14019529?v=4",
      "events_url": "https://api.github.com/users/PaulHigin/events{/privacy}",
      "followers_url": "https://api.github.com/users/PaulHigin/followers",
      "following_url": "https://api.github.com/users/PaulHigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulHigin/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/PaulHigin",
      "id": 14019529,
      "login": "PaulHigin",
      "node_id": "MDQ6VXNlcjE0MDE5NTI5",
      "organizations_url": "https://api.github.com/users/PaulHigin/orgs",
      "received_events_url": "https://api.github.com/users/PaulHigin/received_events",
      "repos_url": "https://api.github.com/users/PaulHigin/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/PaulHigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulHigin/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/PaulHigin"
    }
  }
]
