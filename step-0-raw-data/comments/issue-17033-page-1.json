[
  {
    "author_association": "COLLABORATOR",
    "body": "The problem here is that PowerShell is calling `CreateProcessWithLogon` directly and then getting the [dotnet Process object](https://github.com/PowerShell/PowerShell/blob/8ad642013a5495ce102d9857afb4dcb9a44dc00f/src/Microsoft.PowerShell.Commands.Management/commands/management/Process.cs#L2571-L2572) manually. Dotnet will attempt to open a new handle on that process but it will fail causing the problem you see here. Unfortunately I'm not aware of any public way to create the `Process` object from a handle returned by the various `CreateProcess` APIs. I'm not actually sure why .NET calls the API directly instead of going through the .NET process itself but there might be that I'm not aware off.\r\n\r\nI see some potential fixes for this\r\n\r\n* Have PowerShell use .NET to spawn the process with the credentials so the Process object it gets back has full control over the object and can be waited on\r\n* Have PowerShell return the process handle from it's internal calls and use that in the wait job builder\r\n* Petition .NET to create a public API that can construct a Process object from an IntPtr/SafeHandle that PowerShell provides\r\n* Don't use ~PowerShell~ (sorry meant Start-Process) for this task\r\n\r\nThe first is probably the easiest to implement and would simplify the code. I'm just not sure why it's there in the first place so there potentially might be a scenario with `Start-Process` that is not achievable through .NET. The 2nd is also doable but doesn't help the `-PassThru` scenario as the process object you get back will be under the same limitations you see today. It will be enough to wait on but some actions won't be available. I have no idea how feasible the 3rd option is, I've certainly wanted something like this before but it's a Windows specific feature and might require a lot of work to expose properly there. The 4th doesn't really help PowerShell but certainly an option to get your code working today.",
    "created_at": "2022-03-20T02:19:09Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17033#issuecomment-1073150791",
    "id": 1073150791,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17033",
    "node_id": "IC_kwDOAvT7bc4_9vtH",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1073150791/reactions"
    },
    "updated_at": "2022-03-20T02:30:00Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1073150791",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "There were many limitations in .Net Framework and .Net Core Process class implementation. As a result, we have a low-level implementation that comes from Windows PowerShell. Now we could review new implementation in .Net 6+. I think we can move to .Net implementation with some minor breaking changes. Perhaps we could resolve many issues and requested enhancements with Start-Process in the time. Unfortunately, I did not find support earlier when I tried to do this job.",
    "created_at": "2022-03-20T16:53:02Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17033#issuecomment-1073289850",
    "id": 1073289850,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17033",
    "node_id": "IC_kwDOAvT7bc4_-Rp6",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1073289850/reactions"
    },
    "updated_at": "2022-03-20T16:53:02Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1073289850",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22290914?v=4",
      "events_url": "https://api.github.com/users/iSazonov/events{/privacy}",
      "followers_url": "https://api.github.com/users/iSazonov/followers",
      "following_url": "https://api.github.com/users/iSazonov/following{/other_user}",
      "gists_url": "https://api.github.com/users/iSazonov/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/iSazonov",
      "id": 22290914,
      "login": "iSazonov",
      "node_id": "MDQ6VXNlcjIyMjkwOTE0",
      "organizations_url": "https://api.github.com/users/iSazonov/orgs",
      "received_events_url": "https://api.github.com/users/iSazonov/received_events",
      "repos_url": "https://api.github.com/users/iSazonov/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/iSazonov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iSazonov/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/iSazonov"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "Submitted to the Cmdlet Working Group for review.",
    "created_at": "2022-11-03T15:59:38Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17033#issuecomment-1302327814",
    "id": 1302327814,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17033",
    "node_id": "IC_kwDOAvT7bc5Nn_IG",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1302327814/reactions"
    },
    "updated_at": "2022-11-03T15:59:38Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1302327814",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/12089920?v=4",
      "events_url": "https://api.github.com/users/jdhitsolutions/events{/privacy}",
      "followers_url": "https://api.github.com/users/jdhitsolutions/followers",
      "following_url": "https://api.github.com/users/jdhitsolutions/following{/other_user}",
      "gists_url": "https://api.github.com/users/jdhitsolutions/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jdhitsolutions",
      "id": 12089920,
      "login": "jdhitsolutions",
      "node_id": "MDQ6VXNlcjEyMDg5OTIw",
      "organizations_url": "https://api.github.com/users/jdhitsolutions/orgs",
      "received_events_url": "https://api.github.com/users/jdhitsolutions/received_events",
      "repos_url": "https://api.github.com/users/jdhitsolutions/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jdhitsolutions/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jdhitsolutions/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jdhitsolutions"
    }
  }
]
