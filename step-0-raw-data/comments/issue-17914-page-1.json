[
  {
    "author_association": "COLLABORATOR",
    "body": "It could be a threading issue where doing `($using:result).count += 1` is encountering a race condition where\r\n\r\n* Thread A gets value of result.count (1)\r\n* Thread B gets value of result.count (1) - this happens before Thread A increments the value but after it gets the original value\r\n* Thread A increments and sets value (2)\r\n* Thread B increments and sets value (2)\r\n\r\nNotice how instead of the value being 3 it's still 2.\r\n\r\nThe += is not an atomic operation so you can have threads stepping over each other at any point in time. The only real way to avoid such a thing is to use a locking mechanism, like a mutex, to ensure that the counter stages are incremented exclusively.\r\n\r\n```powershell\r\n$result = @{\r\n    start = 0\r\n    end = 100000\r\n    count = 0\r\n    concurrent = 100\r\n    lock = [System.Threading.Mutex]::new($false)\r\n}\r\n\r\n($result.start)..($result.end) | ForEach-Object -Parallel {\r\n    $null = ($using:result).lock.WaitOne()\r\n    try {\r\n        ($using:result).count += 1\r\n    }\r\n    finally {\r\n        ($using:result).lock.ReleaseMutex()\r\n    }\r\n} -ThrottleLimit $result.concurrent\r\n\r\n$result.count\r\n```\r\n\r\nThe downside of this approach is it slows down the parallel work because they need to essentially wait and run the things step by step rather than in parallel. If you can avoid it I will but if you need to access the same resource exclusively in parallel you have no other way.",
    "created_at": "2022-08-17T19:12:44Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17914#issuecomment-1218394427",
    "id": 1218394427,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17914",
    "node_id": "IC_kwDOAvT7bc5Inzk7",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1218394427/reactions"
    },
    "updated_at": "2022-08-17T19:12:44Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1218394427",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "NONE",
    "body": "@jborean93 \r\nDoes using ConcurrentDictionary from [Thread Safe Collections](http://msdn.microsoft.com/en-us/library/dd997305(v=vs.110).aspx) and then TryGetValue,TryUpdate methods could work here? My attempt failed but I'm feeling that my code is just wrong.\r\n\r\nMore info: https://devblogs.microsoft.com/powershell/powershell-foreach-object-parallel-feature/\n\n<blockquote><img src=\"https://devblogs.microsoft.com/powershell/wp-content/uploads/sites/30/2018/09/Powershell_256.png\" width=\"48\" align=\"right\"><div><img src=\"https://devblogs.microsoft.com/powershell/wp-content/uploads/sites/30/2019/02/Powershell_2561.png\" height=\"14\"> PowerShell Team</div><div><strong><a href=\"https://devblogs.microsoft.com/powershell/powershell-foreach-object-parallel-feature/\">PowerShell ForEach-Object Parallel Feature</a></strong></div><div>PowerShell ForEach-Object Parallel Feature PowerShell 7.0 Preview 3 is now available with a new ForEach-Object Parallel Experimental feature. This feature is a great new tool for parallelizing work, but like any tool, it has its uses and drawbacks. This article describes this new feature,</div></blockquote>",
    "created_at": "2022-08-18T00:28:08Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17914#issuecomment-1218759711",
    "id": 1218759711,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17914",
    "node_id": "IC_kwDOAvT7bc5IpMwf",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1218759711/reactions"
    },
    "updated_at": "2022-08-18T00:28:10Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1218759711",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/365255?v=4",
      "events_url": "https://api.github.com/users/ALIENQuake/events{/privacy}",
      "followers_url": "https://api.github.com/users/ALIENQuake/followers",
      "following_url": "https://api.github.com/users/ALIENQuake/following{/other_user}",
      "gists_url": "https://api.github.com/users/ALIENQuake/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/ALIENQuake",
      "id": 365255,
      "login": "ALIENQuake",
      "node_id": "MDQ6VXNlcjM2NTI1NQ==",
      "organizations_url": "https://api.github.com/users/ALIENQuake/orgs",
      "received_events_url": "https://api.github.com/users/ALIENQuake/received_events",
      "repos_url": "https://api.github.com/users/ALIENQuake/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/ALIENQuake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ALIENQuake/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/ALIENQuake"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "At least here I don't think so, `+=` isn't an atomic operation, the code still needs to:\r\n\r\n* Get the original value from the dict\r\n* Increment the value\r\n* Set the new value to the dict\r\n\r\nThe problem is the getting and setting are 2 distinct operations. If those types had something like `($using:result).TryUpdate('count', {$_ + 1})` where the TryUpdate is doing the locking internally and calling the delegate to update the value but AFAIK this isn't possible through any builtin type.\r\n\r\nWhat you could do is use something like a `ConcurrentBag` and just add a random value and get the final count at the end\r\n\r\n```powershell\r\n$result = @{\r\n    start = 0\r\n    end = 100000\r\n    count = [System.Collections.Concurrent.ConcurrentBag[Object]]::new()\r\n    concurrent = 100\r\n}\r\n\r\n($result.start)..($result.end) | ForEach-Object -Parallel {\r\n    ($using:result).count.Add($null)\r\n} -ThrottleLimit $result.concurrent\r\n\r\n$result.count.Count\r\n```\r\n\r\nThe downside is you now have a collection storing useless values and taking up memory for no reason. It still does the locking for you internally so technically simpler code.\r\n\r\nDepending on OPs use case it may be possible, it sounds like this is just an example to reproduce their problem and they have an actual scenario that may find some use using some of the thread safe collections. But without knowing what the actual scenario is it's hard to recommend something.",
    "created_at": "2022-08-18T00:39:53Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17914#issuecomment-1218781590",
    "id": 1218781590,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17914",
    "node_id": "IC_kwDOAvT7bc5IpSGW",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 2,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 2,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1218781590/reactions"
    },
    "updated_at": "2022-08-18T00:41:29Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1218781590",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "NONE",
    "body": "> Depending on OPs use case it may be possible, it sounds like this is just an example to reproduce their problem and they have an actual scenario that may find some use using some of the thread safe collections. But without knowing what the actual scenario is it's hard to recommend something.\r\n\r\nExactly as you said, use case of what we're doing here calling a child script with various parameters. Co-worker running this was using latest and was finding that various instances were missing, so this was an attempt to put together a test case that would show the issue without all the overhead. I've made note of the thread safety issue and will reattempt with that in place to ensure it is still occurring in our environment. ",
    "created_at": "2022-08-18T12:53:15Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17914#issuecomment-1219456778",
    "id": 1219456778,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17914",
    "node_id": "IC_kwDOAvT7bc5Ir28K",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1219456778/reactions"
    },
    "updated_at": "2022-08-18T12:53:15Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1219456778",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/18336724?v=4",
      "events_url": "https://api.github.com/users/pirion/events{/privacy}",
      "followers_url": "https://api.github.com/users/pirion/followers",
      "following_url": "https://api.github.com/users/pirion/following{/other_user}",
      "gists_url": "https://api.github.com/users/pirion/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/pirion",
      "id": 18336724,
      "login": "pirion",
      "node_id": "MDQ6VXNlcjE4MzM2NzI0",
      "organizations_url": "https://api.github.com/users/pirion/orgs",
      "received_events_url": "https://api.github.com/users/pirion/received_events",
      "repos_url": "https://api.github.com/users/pirion/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/pirion/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pirion/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/pirion"
    }
  },
  {
    "author_association": "NONE",
    "body": "This issue has been marked as answered and has not had any activity for **1 day**. It has been closed for housekeeping purposes.",
    "created_at": "2022-08-20T00:01:16Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17914#issuecomment-1221179155",
    "id": 1221179155,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17914",
    "node_id": "IC_kwDOAvT7bc5IybcT",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1221179155/reactions"
    },
    "updated_at": "2022-08-20T00:01:16Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1221179155",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/in/26612?v=4",
      "events_url": "https://api.github.com/users/msftbot%5Bbot%5D/events{/privacy}",
      "followers_url": "https://api.github.com/users/msftbot%5Bbot%5D/followers",
      "following_url": "https://api.github.com/users/msftbot%5Bbot%5D/following{/other_user}",
      "gists_url": "https://api.github.com/users/msftbot%5Bbot%5D/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/apps/msftbot",
      "id": 48340428,
      "login": "msftbot[bot]",
      "node_id": "MDM6Qm90NDgzNDA0Mjg=",
      "organizations_url": "https://api.github.com/users/msftbot%5Bbot%5D/orgs",
      "received_events_url": "https://api.github.com/users/msftbot%5Bbot%5D/received_events",
      "repos_url": "https://api.github.com/users/msftbot%5Bbot%5D/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/msftbot%5Bbot%5D/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/msftbot%5Bbot%5D/subscriptions",
      "type": "Bot",
      "url": "https://api.github.com/users/msftbot%5Bbot%5D"
    }
  }
]
