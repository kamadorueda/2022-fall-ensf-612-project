[
  {
    "author_association": "CONTRIBUTOR",
    "body": "Cc: @BrucePay ",
    "created_at": "2018-10-02T08:05:11Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/7921#issuecomment-426185468",
    "id": 426185468,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/7921",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNjE4NTQ2OA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426185468/reactions"
    },
    "updated_at": "2018-10-02T08:05:11Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426185468",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/12897753?v=4",
      "events_url": "https://api.github.com/users/kvprasoon/events{/privacy}",
      "followers_url": "https://api.github.com/users/kvprasoon/followers",
      "following_url": "https://api.github.com/users/kvprasoon/following{/other_user}",
      "gists_url": "https://api.github.com/users/kvprasoon/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/kvprasoon",
      "id": 12897753,
      "login": "kvprasoon",
      "node_id": "MDQ6VXNlcjEyODk3NzUz",
      "organizations_url": "https://api.github.com/users/kvprasoon/orgs",
      "received_events_url": "https://api.github.com/users/kvprasoon/received_events",
      "repos_url": "https://api.github.com/users/kvprasoon/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/kvprasoon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kvprasoon/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/kvprasoon"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "> ... to implement PSRP over SSH in a third party Python library \r\n\r\n> ... unfortunately MS-PSRP is somewhat out of date and only has info for WSMan and pre 2.3 protocol changes\r\n\r\nPerhaps @dantraMSFT and @PaulHigin can make some helpful comments.",
    "created_at": "2018-10-02T09:31:25Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/7921#issuecomment-426209768",
    "id": 426209768,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/7921",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNjIwOTc2OA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426209768/reactions"
    },
    "updated_at": "2018-10-02T09:31:25Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426209768",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22290914?v=4",
      "events_url": "https://api.github.com/users/iSazonov/events{/privacy}",
      "followers_url": "https://api.github.com/users/iSazonov/followers",
      "following_url": "https://api.github.com/users/iSazonov/following{/other_user}",
      "gists_url": "https://api.github.com/users/iSazonov/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/iSazonov",
      "id": 22290914,
      "login": "iSazonov",
      "node_id": "MDQ6VXNlcjIyMjkwOTE0",
      "organizations_url": "https://api.github.com/users/iSazonov/orgs",
      "received_events_url": "https://api.github.com/users/iSazonov/received_events",
      "repos_url": "https://api.github.com/users/iSazonov/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/iSazonov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iSazonov/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/iSazonov"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "MS-PSRP document only describes the remoting protocol and is transport agnostic.  I believe the document includes examples using WSMan transport but the protocol is not dependent on WSMan.\r\n\r\nThe protocol is at version 2.3 so the document is up to date.  PSCore6 currently has an SSH based transport implementation and you can take a look at that as an example.  The PSRP protocol did not have to change to support the SSH transport.  \r\n\r\nImplementing PSRP is pretty involving, as you are experiencing.  The OutOfProc transport is a good way to see how a transport supports PSRP and what messages are sent/received.  But you also need to look at runspace, command, and protocol state machine implementations (client and server) to get all of the details.  I am not sure how you want to implement PSRP for Python, or whether it really makes sense.  Maybe you can provide more details in what you hope to do.  ",
    "created_at": "2018-10-02T21:59:00Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/7921#issuecomment-426444817",
    "id": 426444817,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/7921",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNjQ0NDgxNw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426444817/reactions"
    },
    "updated_at": "2018-10-02T21:59:00Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426444817",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/14019529?v=4",
      "events_url": "https://api.github.com/users/PaulHigin/events{/privacy}",
      "followers_url": "https://api.github.com/users/PaulHigin/followers",
      "following_url": "https://api.github.com/users/PaulHigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulHigin/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/PaulHigin",
      "id": 14019529,
      "login": "PaulHigin",
      "node_id": "MDQ6VXNlcjE0MDE5NTI5",
      "organizations_url": "https://api.github.com/users/PaulHigin/orgs",
      "received_events_url": "https://api.github.com/users/PaulHigin/received_events",
      "repos_url": "https://api.github.com/users/PaulHigin/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/PaulHigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulHigin/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/PaulHigin"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "Hey Paul\r\n\r\nThanks for the reply, here are some more details\r\n\r\n> MS-PSRP document only describes the remoting protocol and is transport agnostic. I believe the document includes examples using WSMan transport but the protocol is not dependent on WSMan.\r\n\r\nThat is true to an extent but it doesn't have any details around the types of payloads that are sent when using SSH or other OutOfProc transport options. Using https://msdn.microsoft.com/en-us/library/ee175932.aspx as an example, all the steps revolve around what WSMan messages encapsulate the PSRP message fragments which don't really relate to other transports.\r\n\r\nAdding to this, the MS-PSRP docs has dedicated sections around rules for WSMan messages https://msdn.microsoft.com/en-us/library/dd356495.aspx but no equivalent for the OutOfProc payloads.\r\n\r\n> The protocol is at version 2.3 so the document is up to date\r\n\r\nThis isn't really a big issue but there are definitely sections of the docs that do no indicate that 2.3 is a valid protocol number, or even when it was added and what changes it contains. For example, the rules for sending a SessionCapability message say that protocolversion MUST be 2.1 or 2.2 which we know to be false https://msdn.microsoft.com/en-us/library/ee441993.aspx.\r\n\r\n> Implementing PSRP is pretty involving, as you are experiencing\r\n\r\nI've got a working Python implementation for running over WSMan https://github.com/jborean93/pypsrp. This is just trying to take it to the next step and look at supporting SSH as a transport option and also as a mere curiosity for me to see how the underlying protocol actually works.\r\n\r\n> But you also need to look at runspace, command, and protocol state machine implementations (client and server) to get all of the details\r\n\r\nI don't have a desire to implement a server side implementation, I'm really just interested in a client side implementation.\r\n\r\n> I am not sure how you want to implement PSRP for Python, or whether it really makes sense. Maybe you can provide more details in what you hope to do.\r\n\r\nI work on the Ansible project and it uses Python so having a Python library to call is a lot easier than trying to marshal the objects from Python to pwsh and get that to make the calls. The other issue with using native pwsh right now is that the WinRM support is quite limited, IIRC it still doesn't support things like CredSSP and the last time I looked at OMI it was a bit of a handful to actually install.\r\n\r\nTraditionally we just use the base WinRM layer but PSRP offers a few extra features that we are interested in looking at like JEA, Configuration Endpoints, persisting the connection, secure string serialization, and maybe SSH through PSRP (if I can get this working :)). I'm sure there are current bugs in the current pypsrp library but it so far has worked for what I need and I wanted to take it to the next level and support SSH with PowerShell Core.\r\n\r\nMy confusion really revolves around when to use what OutOfProc payload and the general workflow.",
    "created_at": "2018-10-02T22:17:47Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/7921#issuecomment-426449360",
    "id": 426449360,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/7921",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNjQ0OTM2MA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426449360/reactions"
    },
    "updated_at": "2018-10-02T22:17:47Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426449360",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "I believe I figured out my issue and have been able to move on. The default byte representation of a uuid/guid between Python and .NET is different, Python represents the bytes of a UUID in big endianess while .NET seems to be little endian. For example, here's how we can convert a uuid string to bytes for the PSRP message packet;\r\n\r\n```\r\nimport binascii\r\nimport uuid\r\n\r\ntest = uuid.UUID(\"fa960460-60ca-4ed0-a710-2b000b0df684\")\r\nprint(binascii.hexlify(test.bytes).upper())\r\n# FA96046060CA4ED0A7102B000B0DF684\r\n\r\n# we need to use bytes_le instead to get the little endian byte format\r\nprint(binascii.hexlify(test.bytes_le).upper())\r\n# 600496FACA60D04EA7102B000B0DF684\r\n```\r\n\r\nWhen comparing against .NET, `ToByteArray()` uses little endian for the int and short parts\r\n\r\n```\r\n$test = [Guid]\"fa960460-60ca-4ed0-a710-2b000b0df684\"\r\n[System.BitConverter]::ToString($test.ToByteArray()).Replace(\"-\", \"\")\r\n# 600496FACA60D04EA7102B000B0DF684\r\n```\r\n\r\nThe reason why this was an issue is that when sending the `<Command PSGuid='...' />` payload, the PSGuid element is a string and the service will create the command manager with that ID. When sending the `<Data Stream='Default' PSGuid='...'>CreatePipeline fragment</Data>` fragment, the Pipeline id that's part of the PSRP message header is in bytes form. The Python side packed it using the default `bytes` endianess which is big but when .NET goes to unpack the bytes it expects the little form causing the GUID to be invalid.\r\n\r\nOnce changing my code to use `bytes_le`, I am able to start the pipeline and receive the output like expected. I'm curious as to why I never saw this issue with WSMan but it could just be a difference of how the WSMan handler get's the GUIDs compared to the OutOfProc payloads.\r\n\r\nFeel free to close this issue @PaulHigin unless you want to investigate this further. I should be able to achieve what I want now I'm able to execute commands.",
    "created_at": "2018-10-03T23:55:20Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/7921#issuecomment-426841097",
    "id": 426841097,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/7921",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNjg0MTA5Nw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426841097/reactions"
    },
    "updated_at": "2018-10-03T23:55:20Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426841097",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "> The default byte representation of a uuid/guid between Python and .NET is different,\r\n\r\n@jborean93 You can look how CoreFX or PowerShell resolve such problems. \r\nhttps://github.com/PowerShell/PowerShell-Native/blob/master/src/libpsl-native/src/setdate.cpp#L42\r\n",
    "created_at": "2018-10-04T05:00:38Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/7921#issuecomment-426885912",
    "id": 426885912,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/7921",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNjg4NTkxMg==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426885912/reactions"
    },
    "updated_at": "2018-10-04T05:01:23Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/426885912",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22290914?v=4",
      "events_url": "https://api.github.com/users/iSazonov/events{/privacy}",
      "followers_url": "https://api.github.com/users/iSazonov/followers",
      "following_url": "https://api.github.com/users/iSazonov/following{/other_user}",
      "gists_url": "https://api.github.com/users/iSazonov/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/iSazonov",
      "id": 22290914,
      "login": "iSazonov",
      "node_id": "MDQ6VXNlcjIyMjkwOTE0",
      "organizations_url": "https://api.github.com/users/iSazonov/orgs",
      "received_events_url": "https://api.github.com/users/iSazonov/received_events",
      "repos_url": "https://api.github.com/users/iSazonov/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/iSazonov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iSazonov/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/iSazonov"
    }
  },
  {
    "author_association": "MEMBER",
    "body": "@jborean93 glad you were able to resolve this!  I would be interested in knowing once you have a working solution for Python for PSRP over SSH! :)",
    "created_at": "2018-10-05T21:29:39Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/7921#issuecomment-427504126",
    "id": 427504126,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/7921",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNzUwNDEyNg==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/427504126/reactions"
    },
    "updated_at": "2018-10-05T21:29:39Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/427504126",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/11859881?v=4",
      "events_url": "https://api.github.com/users/SteveL-MSFT/events{/privacy}",
      "followers_url": "https://api.github.com/users/SteveL-MSFT/followers",
      "following_url": "https://api.github.com/users/SteveL-MSFT/following{/other_user}",
      "gists_url": "https://api.github.com/users/SteveL-MSFT/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SteveL-MSFT",
      "id": 11859881,
      "login": "SteveL-MSFT",
      "node_id": "MDQ6VXNlcjExODU5ODgx",
      "organizations_url": "https://api.github.com/users/SteveL-MSFT/orgs",
      "received_events_url": "https://api.github.com/users/SteveL-MSFT/received_events",
      "repos_url": "https://api.github.com/users/SteveL-MSFT/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SteveL-MSFT/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SteveL-MSFT/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SteveL-MSFT"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "@SteveL-MSFT no worries, will send through some details here once I have a proper solution. Right now it's just some mess put on top of my existing code and needs some cleanup before I'm ready to release it.",
    "created_at": "2018-10-05T21:34:14Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/7921#issuecomment-427505204",
    "id": 427505204,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/7921",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNzUwNTIwNA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 2,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 2,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/427505204/reactions"
    },
    "updated_at": "2018-10-05T21:34:14Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/427505204",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  }
]
