[
  {
    "author_association": "NONE",
    "body": "It looks like the following might be relevant to answering this question:\r\n\r\n* The time spent on script module compilation affects parallelization differently from the time spent executing a script module's scriptblock.  (I think importing Pester is mostly spent compiling, while importing `slowLoading.psm1` is mostly spent executing the scriptblock.)\r\n* Importing a module in one runspace slows the execution of code in another runspace that uses that module.\r\n\r\nBelow are the results of some tests related to these aspects.\r\n\r\n### .OpenAsync() with slowLoading.psm1\r\n\r\nIt looks like `.OpenAsync()` parallelizes importing of `slowLoading.psm1` nicely.  [parallelLoadModule.ps1](https://gist.github.com/alx9r/c24bf08fd22af7e88f3a17e720215f63) is a demonstration.  Here is the output of two test runs on a 16-core processor:\r\n\r\n\r\n```none\r\nBaseline w/ $p overridden to 1\r\n\r\nProcessorCount: 1\r\n54ms : OpenAsync()\r\n68ms : WaitAll()\r\n4018ms : done\r\n```\r\n\r\n```none\r\nProcessorCount: 16\r\n44ms : OpenAsync()\r\n219ms : WaitAll()\r\n7060ms : done\r\n```\r\n\r\nOpening 16x runspaces took 1.75x as long.  The CPU utilization reflects that all processors are used in parallel:\r\n\r\n![image](https://user-images.githubusercontent.com/11237922/41488271-9ed8b3de-70a0-11e8-87a8-346b0ad28390.png)\r\n\r\n\r\nThis seems like good news for parallelized importing of script modules.  However, `slowLoading.psm1` isn't a very good stand-in for real-world modules.\r\n\r\n### .OpenAsync() w/ Pester\r\n\r\nPester is a real-world script module that takes some time to import.\r\n\r\nChanging the call in parallelModuleLoad.ps1 to `Import-Module $modulePath` and `.ImportPSModule($modulePath)` to `Import-Module Pester` and `.ImportPSModule('Pester')`, respectively, causes Pester to be imported into each of the runspaces when `.OpenAsync()` is called.   Here are the corresponding tests runs:\r\n\r\n```none\r\nBaseline w/ $p overridden to 1\r\n\r\nProcessorCount: 1\r\n46ms : OpenAsync()\r\n59ms : WaitAll()\r\n991ms : done\r\n```\r\n\r\n```none\r\nProcessorCount: 16\r\n59ms : OpenAsync()\r\n234ms : WaitAll()\r\n7627ms : done\r\n```\r\n\r\nOpening 16x runspaces that have Pester imported took 7.69x as long.  The CPU utilization reflects some parallelization occuring:\r\n\r\n![image](https://user-images.githubusercontent.com/11237922/41488479-4b5e2116-70a1-11e8-813a-fd01a104069d.png)\r\n\r\n\r\n\r\n### .OpenAsync() w/ Pester while Running Pester\r\n\r\nIt's likely that code in a script module will be executed while another runspace is importing that module.\r\n\r\n[This test](https://gist.github.com/alx9r/de92c472060a574dbb6633e000dde3e7) profiles importing Pester into a number of runspaces while the first runspace performs CPU-bound execution using Pester.  The results from a typical test run are as follows:\r\n\r\n```none\r\nProcessorCount: 16\r\n59ms : OpenAsync()\r\n7229ms : importing done\r\nthroughput while importing: 143 iterations/s\r\nthroughput while solo: 246 iterations/s\r\n```\r\n\r\nThe time taken to import Pester into the 16 runspaces took about the same time as when Pester code was not simultaneously being executed (7229ms vs. 7627ms).  On the other hand, the single-threaded throughput of Pester code while other runspaces were importing Pester was 0.58x the throughput of that code when executed solo.\r\n\r\nThis seems to point to the following:\r\n\r\n1. There is some sort of performance interaction between runspaces using the same module.\r\n2. Executing code using a module in one runspace *does not* slow loading of that module in another runspace.\r\n3. Importing a module into one runspace *does* slow code executing using that module in another runspace.\r\n",
    "created_at": "2018-06-15T21:02:22Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/7035#issuecomment-397741477",
    "id": 397741477,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/7035",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5Nzc0MTQ3Nw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/397741477/reactions"
    },
    "updated_at": "2018-06-15T21:02:22Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/397741477",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/11237922?v=4",
      "events_url": "https://api.github.com/users/alx9r/events{/privacy}",
      "followers_url": "https://api.github.com/users/alx9r/followers",
      "following_url": "https://api.github.com/users/alx9r/following{/other_user}",
      "gists_url": "https://api.github.com/users/alx9r/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/alx9r",
      "id": 11237922,
      "login": "alx9r",
      "node_id": "MDQ6VXNlcjExMjM3OTIy",
      "organizations_url": "https://api.github.com/users/alx9r/orgs",
      "received_events_url": "https://api.github.com/users/alx9r/received_events",
      "repos_url": "https://api.github.com/users/alx9r/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/alx9r/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alx9r/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/alx9r"
    }
  },
  {
    "author_association": "NONE",
    "body": "Per #7153, sharing an `AuthorizationManager` object amongst `Runspace`s being opened causes contention.  I wonder if `RunspacePool` uses a single `AuthorizationManager` when opening runspaces.",
    "created_at": "2018-06-23T14:35:50Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/7035#issuecomment-399682931",
    "id": 399682931,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/7035",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5OTY4MjkzMQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/399682931/reactions"
    },
    "updated_at": "2018-06-23T14:35:50Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/399682931",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/11237922?v=4",
      "events_url": "https://api.github.com/users/alx9r/events{/privacy}",
      "followers_url": "https://api.github.com/users/alx9r/followers",
      "following_url": "https://api.github.com/users/alx9r/following{/other_user}",
      "gists_url": "https://api.github.com/users/alx9r/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/alx9r",
      "id": 11237922,
      "login": "alx9r",
      "node_id": "MDQ6VXNlcjExMjM3OTIy",
      "organizations_url": "https://api.github.com/users/alx9r/orgs",
      "received_events_url": "https://api.github.com/users/alx9r/received_events",
      "repos_url": "https://api.github.com/users/alx9r/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/alx9r/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alx9r/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/alx9r"
    }
  }
]
