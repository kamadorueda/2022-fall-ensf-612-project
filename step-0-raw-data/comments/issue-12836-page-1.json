[
  {
    "author_association": "NONE",
    "body": "[WindowsIdentity.RunImpersonated](https://docs.microsoft.com/en-us/dotnet/api/system.security.principal.windowsidentity.runimpersonated?view=netcore-3.1) seems to be the replacement; see <https://github.com/dotnet/runtime/issues/35389> and <https://github.com/dotnet/runtime/issues/20647#issuecomment-454860914>.\r\n\r\nBe careful to get the first argument from the WindowsIdentity.AccessToken property rather than WindowsIdentity.Token, which returns an IntPtr and can cause the token handle to be closed too early if PowerShell helpfully converts the IntPtr to a SafeAccessTokenHandle.",
    "created_at": "2020-05-29T11:24:24Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/12836#issuecomment-635920654",
    "id": 635920654,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/12836",
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNTkyMDY1NA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/635920654/reactions"
    },
    "updated_at": "2020-05-29T11:24:24Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/635920654",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/46201428?v=4",
      "events_url": "https://api.github.com/users/KalleOlaviNiemitalo/events{/privacy}",
      "followers_url": "https://api.github.com/users/KalleOlaviNiemitalo/followers",
      "following_url": "https://api.github.com/users/KalleOlaviNiemitalo/following{/other_user}",
      "gists_url": "https://api.github.com/users/KalleOlaviNiemitalo/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/KalleOlaviNiemitalo",
      "id": 46201428,
      "login": "KalleOlaviNiemitalo",
      "node_id": "MDQ6VXNlcjQ2MjAxNDI4",
      "organizations_url": "https://api.github.com/users/KalleOlaviNiemitalo/orgs",
      "received_events_url": "https://api.github.com/users/KalleOlaviNiemitalo/received_events",
      "repos_url": "https://api.github.com/users/KalleOlaviNiemitalo/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/KalleOlaviNiemitalo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/KalleOlaviNiemitalo/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/KalleOlaviNiemitalo"
    }
  },
  {
    "author_association": "NONE",
    "body": "> \r\n> \r\n> [WindowsIdentity.RunImpersonated](https://docs.microsoft.com/en-us/dotnet/api/system.security.principal.windowsidentity.runimpersonated?view=netcore-3.1) seems to be the replacement; see [dotnet/runtime#35389](https://github.com/dotnet/runtime/issues/35389) and [dotnet/runtime#20647 (comment)](https://github.com/dotnet/runtime/issues/20647#issuecomment-454860914).\r\n> \r\n> Be careful to get the first argument from the WindowsIdentity.AccessToken property rather than WindowsIdentity.Token, which returns an IntPtr and can cause the token handle to be closed too early if PowerShell helpfully converts the IntPtr to a SafeAccessTokenHandle.\r\n\r\nThe problem with this is, that you can only call SafeAccessTokenHandle in PS7 - but not before. So using this script on several thousand computers at the same time is nearly impossible. OK - making a workaround with a second import shouldn't be that much trouble, but it's inconvenient, that it is not compatible.\r\n\r\nThank you for your fast reply, Kalle :)",
    "created_at": "2020-05-29T13:12:28Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/12836#issuecomment-635964725",
    "id": 635964725,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/12836",
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNTk2NDcyNQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/635964725/reactions"
    },
    "updated_at": "2020-05-29T13:12:28Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/635964725",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/30444694?v=4",
      "events_url": "https://api.github.com/users/andreasgottwald/events{/privacy}",
      "followers_url": "https://api.github.com/users/andreasgottwald/followers",
      "following_url": "https://api.github.com/users/andreasgottwald/following{/other_user}",
      "gists_url": "https://api.github.com/users/andreasgottwald/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/andreasgottwald",
      "id": 30444694,
      "login": "andreasgottwald",
      "node_id": "MDQ6VXNlcjMwNDQ0Njk0",
      "organizations_url": "https://api.github.com/users/andreasgottwald/orgs",
      "received_events_url": "https://api.github.com/users/andreasgottwald/received_events",
      "repos_url": "https://api.github.com/users/andreasgottwald/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/andreasgottwald/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/andreasgottwald/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/andreasgottwald"
    }
  },
  {
    "author_association": "NONE",
    "body": "> The problem with this is, that you can only call SafeAccessTokenHandle in PS7 - but not before.\r\n\r\nWindowsIdentity.RunImpersonated seems to be working OK on Windows PowerShell 5.1 with .NET Framework 4.8:\r\n\r\n```\r\nPS C:\\> $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.18362.752\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.18362.752\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\n\r\n\r\nPS C:\\> Set-StrictMode -Version 5.1\r\nPS C:\\> $identity = [System.Security.Principal.WindowsIdentity]::GetCurrent()\r\nPS C:\\> [System.Security.Principal.WindowsIdentity]::RunImpersonated($identity.AccessToken, {})\r\n```\r\n\r\nAccording to [Windows PowerShell System Requirements](<https://docs.microsoft.com/powershell/scripting/windows-powershell/install/windows-powershell-system-requirements?view=powershell-5.1#microsoft-net-framework-requirements> \"Windows PowerShell System Requirements - PowerShell | Microsoft Docs\"), Windows PowerShell 5.1 requires .NET Framework 4.5. The [WindowsIdentity.RunImpersonated](<https://docs.microsoft.com/dotnet/api/system.security.principal.windowsidentity.runimpersonated?view=netframework-4.6> \"WindowsIdentity.RunImpersonated Method (System.Security.Principal) | Microsoft Docs\") methods were added in .NET Framework 4.6, so I suppose you cannot rely on them being available on infrequently-updated computers. .NET Framework 4.5.2 on Windows Server 2012 or 2012 R2 seems to remain supported for few years still.",
    "created_at": "2020-05-29T13:35:16Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/12836#issuecomment-635975878",
    "id": 635975878,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/12836",
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNTk3NTg3OA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/635975878/reactions"
    },
    "updated_at": "2020-05-29T13:35:16Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/635975878",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/46201428?v=4",
      "events_url": "https://api.github.com/users/KalleOlaviNiemitalo/events{/privacy}",
      "followers_url": "https://api.github.com/users/KalleOlaviNiemitalo/followers",
      "following_url": "https://api.github.com/users/KalleOlaviNiemitalo/following{/other_user}",
      "gists_url": "https://api.github.com/users/KalleOlaviNiemitalo/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/KalleOlaviNiemitalo",
      "id": 46201428,
      "login": "KalleOlaviNiemitalo",
      "node_id": "MDQ6VXNlcjQ2MjAxNDI4",
      "organizations_url": "https://api.github.com/users/KalleOlaviNiemitalo/orgs",
      "received_events_url": "https://api.github.com/users/KalleOlaviNiemitalo/received_events",
      "repos_url": "https://api.github.com/users/KalleOlaviNiemitalo/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/KalleOlaviNiemitalo/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/KalleOlaviNiemitalo/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/KalleOlaviNiemitalo"
    }
  }
]
