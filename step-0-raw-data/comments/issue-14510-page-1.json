[
  {
    "author_association": "NONE",
    "body": "I tried to simplify my example by removing the `-ComputerName` parameter. But without that parameter the example works as expected. So the problem might be related to the serialization that occurs during remoting.",
    "created_at": "2020-12-30T07:55:44Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14510#issuecomment-752365143",
    "id": 752365143,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14510",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjM2NTE0Mw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/752365143/reactions"
    },
    "updated_at": "2020-12-30T07:58:01Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/752365143",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/88013?v=4",
      "events_url": "https://api.github.com/users/ljb/events{/privacy}",
      "followers_url": "https://api.github.com/users/ljb/followers",
      "following_url": "https://api.github.com/users/ljb/following{/other_user}",
      "gists_url": "https://api.github.com/users/ljb/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/ljb",
      "id": 88013,
      "login": "ljb",
      "node_id": "MDQ6VXNlcjg4MDEz",
      "organizations_url": "https://api.github.com/users/ljb/orgs",
      "received_events_url": "https://api.github.com/users/ljb/received_events",
      "repos_url": "https://api.github.com/users/ljb/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/ljb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ljb/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/ljb"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "Good point, @ljb - you can also demonstrate the problem with a background job, where serialization is involved too:\r\n\r\n```powershell\r\n$automationNull = [System.Management.Automation.Internal.AutomationNull]::Value\r\n\r\n# Note: At least one additional argument is required to trigger the symptom.\r\n$htArgs = @{ ArgumentList = $automationNull, 'foo' }\r\n\r\n# Note: [System.Management.Automation.Internal.AutomationNull]::Value is treated\r\n#       like $null in expression contexts.\r\n$sb = { $null -eq $args[0] ? '(null)' : $args[0].GetType().Name }\r\n\r\n# OK - direct argument passing:\r\nStart-Job $sb -ArgumentList $automationNull, 'foo' |\r\n  Receive-Job -Wait -AutoRemoveJob | Should -Be '(null)'\r\n\r\n# !! BROKEN - via splatting:\r\nStart-Job $sb @htArgs |\r\n  Receive-Job -Wait -AutoRemoveJob | Should -Be '(null)'\r\n```\r\n\r\nIn effect, `[System.Management.Automation.Internal.AutomationNull]::Value` turns into a _regular_ `[PSCustomObject]` instance (without properties) on deserialization.\r\n\r\n",
    "created_at": "2020-12-30T14:46:10Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14510#issuecomment-752646318",
    "id": 752646318,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14510",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjY0NjMxOA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/752646318/reactions"
    },
    "updated_at": "2020-12-30T17:55:52Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/752646318",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/588825?v=4",
      "events_url": "https://api.github.com/users/mklement0/events{/privacy}",
      "followers_url": "https://api.github.com/users/mklement0/followers",
      "following_url": "https://api.github.com/users/mklement0/following{/other_user}",
      "gists_url": "https://api.github.com/users/mklement0/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mklement0",
      "id": 588825,
      "login": "mklement0",
      "node_id": "MDQ6VXNlcjU4ODgyNQ==",
      "organizations_url": "https://api.github.com/users/mklement0/orgs",
      "received_events_url": "https://api.github.com/users/mklement0/received_events",
      "repos_url": "https://api.github.com/users/mklement0/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mklement0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mklement0/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mklement0"
    }
  },
  {
    "author_association": "NONE",
    "body": "Another similar case is when the using scope is used together with `Invoke-Command`:\r\n```Powershell\r\n$values = [System.Management.Automation.Internal.AutomationNull]::Value\r\nInvoke-Command -ComputerName \"some-machine\" {\r\n    $localValues = $using:values\r\n    Write-Host \"Is empty string: $('' -eq $localValues)\"\r\n    Write-Host \"Type: $($localValues.GetType())\"\r\n}\r\n```\r\nThis will result in the following:\r\n```\r\nIs empty string: True\r\nType: System.Management.Automation.PSCustomObject\r\n```\r\n\r\nThis has nothing to do with splatting. But it might be caused by the same underlying circumstances as the splatting examples.",
    "created_at": "2020-12-30T17:36:27Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14510#issuecomment-752701024",
    "id": 752701024,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14510",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjcwMTAyNA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/752701024/reactions"
    },
    "updated_at": "2020-12-30T17:36:27Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/752701024",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/88013?v=4",
      "events_url": "https://api.github.com/users/ljb/events{/privacy}",
      "followers_url": "https://api.github.com/users/ljb/followers",
      "following_url": "https://api.github.com/users/ljb/following{/other_user}",
      "gists_url": "https://api.github.com/users/ljb/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/ljb",
      "id": 88013,
      "login": "ljb",
      "node_id": "MDQ6VXNlcjg4MDEz",
      "organizations_url": "https://api.github.com/users/ljb/orgs",
      "received_events_url": "https://api.github.com/users/ljb/received_events",
      "repos_url": "https://api.github.com/users/ljb/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/ljb/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ljb/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/ljb"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "Yes, the common denominator is the cross-process (whether locally or across machine boundaries) serialization infrastructure, which also applies to the `$using:` \"scope\"; again, the problem can also be demonstrated with a background job:\r\n\r\n```powershell\r\n$automationNull = [System.Management.Automation.Internal.AutomationNull]::Value\r\nStart-Job { ($using:automationNull).GetType().Name } | Receive-Job -Wait -AutoRemoveJob # -> 'PSCustomObject`\r\n```\r\n\r\nSplatting only _surfaces_ the symptom, because it seems to bypass code used in _direct_ argument binding that (surprisingly) converts `[System.Management.Automation.Internal.AutomationNull]::Value` to `$null`. Similarly, no such conversion happens with `$using:`.\r\n\r\nWithout having done thorough analysis, here's my guess as to why this happens:\r\n\r\n* _In-process_ it is _reference equality_ based on the _singleton_ `[System.Management.Automation.Internal.AutomationNull]::Value` that is used to detect such values (and  treats them as a collection with no properties and no elements).\r\n\r\n* The serialization infrastructure is apparently not aware of this special value, and serializes it as a regular `[psobject]` instance (with a static, property-less  `[System.Management.Automation.PSCustomObject]` instance as its base object). The _rehydrated_ regular `[pscustomobject]` instance is obviously _not_ the same as `[System.Management.Automation.Internal.AutomationNull]::Value` in the target process, and therefore not recognized as such.\r\n\r\nIn short: Given that the in-process `[System.Management.Automation.PSCustomObject]`  has no distinguishing characteristics other than being a _singleton_,  fixing this would require extending the serialization infrastructure to be aware of and correctly handle this value.\r\n\r\nHowever: `[System.Management.Automation.Internal.AutomationNull]::Value` _does_ differ in its serialized form from an empty `[psobject]` instance, so _perhaps_ this existing differing representation is enough to unequivocally identify `[System.Management.Automation.Internal.AutomationNull]::Value` on rehydration, which then wouldn't require extending the remoting protocol:\r\n\r\n```powershell\r\n[System.Management.Automation.PSSerializer]::Serialize(@([System.Management.Automation.Internal.AutomationNull]::Value, [psobject]::new()))\r\n```\r\n\r\n<sup>Note that parameter `[System.Management.Automation.Internal.AutomationNull]::Value` or even `@([System.Management.Automation.Internal.AutomationNull]::Value)` alone wouldn't work, because conversion to `$null` / no-element enumeration to an empty array would kick in.</sup>\r\n\r\nThe above yields the following; note how the `[psobject]` instance is simply represented as an empty `<Object>` element, unlike automation null:\r\n\r\n```none\r\n<Objs Version=\"1.1.0.1\" xmlns=\"http://schemas.microsoft.com/powershell/2004/04\">\r\n  <Obj RefId=\"0\">\r\n    <TN RefId=\"0\">\r\n      <T>System.Object[]</T>\r\n      <T>System.Array</T>\r\n      <T>System.Object</T>\r\n    </TN>\r\n    <LST>\r\n      <Obj RefId=\"1\">\r\n        <TN RefId=\"1\">\r\n          <T>System.Management.Automation.PSCustomObject</T>\r\n          <T>System.Object</T>\r\n        </TN>\r\n      </Obj>\r\n      <Obj RefId=\"2\">\r\n        <TNRef RefId=\"1\" />\r\n      </Obj>\r\n    </LST>\r\n  </Obj>\r\n</Objs>\r\n```",
    "created_at": "2020-12-30T18:56:03Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14510#issuecomment-752723734",
    "id": 752723734,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14510",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjcyMzczNA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/752723734/reactions"
    },
    "updated_at": "2020-12-30T21:16:44Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/752723734",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/588825?v=4",
      "events_url": "https://api.github.com/users/mklement0/events{/privacy}",
      "followers_url": "https://api.github.com/users/mklement0/followers",
      "following_url": "https://api.github.com/users/mklement0/following{/other_user}",
      "gists_url": "https://api.github.com/users/mklement0/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mklement0",
      "id": 588825,
      "login": "mklement0",
      "node_id": "MDQ6VXNlcjU4ODgyNQ==",
      "organizations_url": "https://api.github.com/users/mklement0/orgs",
      "received_events_url": "https://api.github.com/users/mklement0/received_events",
      "repos_url": "https://api.github.com/users/mklement0/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mklement0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mklement0/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mklement0"
    }
  }
]
