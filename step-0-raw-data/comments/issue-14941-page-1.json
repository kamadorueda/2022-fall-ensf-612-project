[
  {
    "author_association": "COLLABORATOR",
    "body": "Just to give a trivial example of when this can be a problem, my default code page is 437 and running this in pwsh will output `?` because the character `Ǿ` isn't in that codepage.\r\n\r\n```powershell\r\n$cmd = '[Console]::WriteLine([string][char]0x01FE)'  # Ǿ\r\n\r\n$encCmd = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($cmd))\r\npwsh.exe -EncodedCommand $encCmd\r\n```\r\n\r\nNote: This is highly dependent on the child process and how it's outputting the data. In this case this replicates the behaviour when the child process would open the STDOUT stream as a file and write raw bytes based on the console cp, or even `WriteConsoleA`.\r\n\r\nAdding more confusion to the mix running `[Console]::OutputEncoding = [Text.Encoding]::UTF8` seems to actually affect the child process' .NET Console OutputEncoding but the native methods (`chcp`/PInvoke) do not.\r\n\r\n```powershell\r\n$cmd = '[Console]::WriteLine([string][char]0x01FE)'  # Ǿ\r\n\r\n# chcp 65001  # Does not work as well as the PInvoke SetConsoleOutputCP(65001) method above\r\n[Console]::OutputEncoding = [Text.UTF8Encoding]::new($false)\r\n\r\n$encCmd = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($cmd))\r\npwsh.exe -EncodedCommand $encCmd\r\n```\r\n\r\nIt seems like there's some inheritance going on with .NET that I just don't understand yet. The raw console output CP that Win32 reports is still the original value but setting `[Console]::OutputEncoding` does affect child .NET processes.",
    "created_at": "2021-03-04T02:02:29Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790225777",
    "id": 790225777,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDIyNTc3Nw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790225777/reactions"
    },
    "updated_at": "2021-03-04T02:02:29Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790225777",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "MEMBER",
    "body": "@jborean93 I don't believe PowerShell is doing anything here.  Can you write a simple C# app w/o PowerShell and see if it repros?  At least we can determine if it's .NET doing something.",
    "created_at": "2021-03-04T02:12:31Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790229802",
    "id": 790229802,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDIyOTgwMg==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790229802/reactions"
    },
    "updated_at": "2021-03-04T02:12:31Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790229802",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/11859881?v=4",
      "events_url": "https://api.github.com/users/SteveL-MSFT/events{/privacy}",
      "followers_url": "https://api.github.com/users/SteveL-MSFT/followers",
      "following_url": "https://api.github.com/users/SteveL-MSFT/following{/other_user}",
      "gists_url": "https://api.github.com/users/SteveL-MSFT/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SteveL-MSFT",
      "id": 11859881,
      "login": "SteveL-MSFT",
      "node_id": "MDQ6VXNlcjExODU5ODgx",
      "organizations_url": "https://api.github.com/users/SteveL-MSFT/orgs",
      "received_events_url": "https://api.github.com/users/SteveL-MSFT/received_events",
      "repos_url": "https://api.github.com/users/SteveL-MSFT/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SteveL-MSFT/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SteveL-MSFT/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SteveL-MSFT"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "@jborean93, I haven't looked at the details yet, but I wonder if https://stackoverflow.com/a/65986012/45375 helps; in short, running `chcp`  from _inside_ PowerShell is ineffective, due to .NET's caching of encodings in the `[Console]` class.\r\n\r\nWith respect to what `chcp` reports, it is, perhaps surprisingly, `[Console]::InputEncoding` that matters.\r\n\r\n<blockquote><img src=\"https://cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon@2.png?v=73d79a89bded\" width=\"48\" align=\"right\"><div>Stack Overflow</div><div><strong><a href=\"https://stackoverflow.com/questions/65982138/use-haskell-to-output-utf8-string-in-the-powershell-on-windows-10\">Use Haskell to Output Utf8 String in the PowerShell on Windows 10</a></strong></div><div>Here is the code.\r\nmodule Lib\r\n    ( someFunc\r\n    ) where\r\n\r\nsomeFunc :: IO ()\r\nsomeFunc = putStrLn &quot;你好&quot;\r\n\r\nI tried to run the program in the PowerShell on Windows 10.\r\nchcp 936\r\nstack run\r\n\r\nAnd the </div></blockquote>",
    "created_at": "2021-03-04T02:19:57Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790232784",
    "id": 790232784,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDIzMjc4NA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790232784/reactions"
    },
    "updated_at": "2021-03-04T02:41:29Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790232784",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/588825?v=4",
      "events_url": "https://api.github.com/users/mklement0/events{/privacy}",
      "followers_url": "https://api.github.com/users/mklement0/followers",
      "following_url": "https://api.github.com/users/mklement0/following{/other_user}",
      "gists_url": "https://api.github.com/users/mklement0/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mklement0",
      "id": 588825,
      "login": "mklement0",
      "node_id": "MDQ6VXNlcjU4ODgyNQ==",
      "organizations_url": "https://api.github.com/users/mklement0/orgs",
      "received_events_url": "https://api.github.com/users/mklement0/received_events",
      "repos_url": "https://api.github.com/users/mklement0/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mklement0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mklement0/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mklement0"
    }
  },
  {
    "author_association": "MEMBER",
    "body": "Although perhaps a bit counter-intuitive, it does seem that [InputEncoding](https://github.com/dotnet/runtime/blob/79ae74f5ca5c8a6fe3a48935e85bd7374959c570/src/libraries/System.Console/src/System/ConsolePal.Windows.cs#L107) does call `SetConsoleCP`.  ",
    "created_at": "2021-03-04T02:31:38Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790239090",
    "id": 790239090,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDIzOTA5MA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790239090/reactions"
    },
    "updated_at": "2021-03-04T02:31:38Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790239090",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/11859881?v=4",
      "events_url": "https://api.github.com/users/SteveL-MSFT/events{/privacy}",
      "followers_url": "https://api.github.com/users/SteveL-MSFT/followers",
      "following_url": "https://api.github.com/users/SteveL-MSFT/following{/other_user}",
      "gists_url": "https://api.github.com/users/SteveL-MSFT/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SteveL-MSFT",
      "id": 11859881,
      "login": "SteveL-MSFT",
      "node_id": "MDQ6VXNlcjExODU5ODgx",
      "organizations_url": "https://api.github.com/users/SteveL-MSFT/orgs",
      "received_events_url": "https://api.github.com/users/SteveL-MSFT/received_events",
      "repos_url": "https://api.github.com/users/SteveL-MSFT/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SteveL-MSFT/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SteveL-MSFT/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SteveL-MSFT"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "@SteveL-MSFT I thought it was something up with .NET but if I was to compile this code (with the 5.0.1 sdk) and run it works without any problems:\r\n\r\n```csharp\r\nusing System;\r\nusing System.Runtime.InteropServices;\r\n\r\nnamespace myApp\r\n{\r\n    public class NativeMethods\r\n    {\r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern uint GetConsoleCP();\r\n\r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern uint GetConsoleOutputCP();\r\n            \r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern bool SetConsoleCP(\r\n            uint wCodePageID);\r\n            \r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern bool SetConsoleOutputCP(\r\n            uint wCodePageID);\r\n    }\r\n\r\n    class Program\r\n    {\r\n        static void Main(string[] args)\r\n        {\r\n            Console.WriteLine(NativeMethods.GetConsoleOutputCP().ToString());\r\n            NativeMethods.SetConsoleOutputCP(65001);\r\n            Console.WriteLine(NativeMethods.GetConsoleOutputCP().ToString());\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nIf I was to run the equivalent (below) of that in PowerShell I get the same encoding (437) in my output instead of the one I set.\r\n\r\n```powershell\r\nAdd-Type -TypeDefinition @'\r\nusing System;\r\nusing System.Runtime.InteropServices;\r\n\r\nnamespace RawConsole\r\n{\r\n    public class NativeMethods\r\n    {\r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern uint GetConsoleCP();\r\n\r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern uint GetConsoleOutputCP();\r\n            \r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern bool SetConsoleCP(\r\n            uint wCodePageID);\r\n            \r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern bool SetConsoleOutputCP(\r\n            uint wCodePageID);\r\n    }\r\n}\r\n'@\r\n\r\n[RawConsole.NativeMethods]::GetConsoleOutputCP()\r\n[RawConsole.NativeMethods]::SetConsoleOutputCP(65001)\r\n[RawConsole.NativeMethods]::GetConsoleOutputCP()\r\n```\r\n\r\n> @jborean93, I haven't looked at the details yet, but I wonder if https://stackoverflow.com/a/65986012/45375 helps; in short, running chcp from inside PowerShell is ineffective, due to .NET's caching of encodings in the [Console] class.\r\n\r\nIt would be the case if I was using `[Console]::OutputEncoding` to check the value I set. In this case I'm going straight to the source with PInvoke to call `GetConsoleOutputCP()` and it's not being changed.\r\n\r\n> Although perhaps a bit counter-intuitive, it does seem that InputEncoding does call SetConsoleCP.\r\n\r\nThere are 2 cp APIs, `SetConsoleCP` which corresponds with the input code page and `SetConsoleOutputCP` which is the output codepage. `chcp` sets them both but the output it reports on is based on the value of `GetConsoleCP()`.\r\n\r\n<blockquote><img src=\"https://cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon@2.png?v=73d79a89bded\" width=\"48\" align=\"right\"><div>Stack Overflow</div><div><strong><a href=\"https://stackoverflow.com/questions/65982138/use-haskell-to-output-utf8-string-in-the-powershell-on-windows-10\">Use Haskell to Output Utf8 String in the PowerShell on Windows 10</a></strong></div><div>Here is the code.\r\nmodule Lib\r\n    ( someFunc\r\n    ) where\r\n\r\nsomeFunc :: IO ()\r\nsomeFunc = putStrLn &quot;你好&quot;\r\n\r\nI tried to run the program in the PowerShell on Windows 10.\r\nchcp 936\r\nstack run\r\n\r\nAnd the </div></blockquote>",
    "created_at": "2021-03-04T02:33:34Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790239823",
    "id": 790239823,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDIzOTgyMw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790239823/reactions"
    },
    "updated_at": "2021-03-04T02:34:47Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790239823",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "MEMBER",
    "body": "PowerShell does have the `$OutputEncoding` automatic variable which is set on initial state and can be set by assigning it a value.  However, calling the Win32 API directly won't update this variable.  The PowerShell native command processor relies on this variable value.",
    "created_at": "2021-03-04T02:37:57Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790241461",
    "id": 790241461,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDI0MTQ2MQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790241461/reactions"
    },
    "updated_at": "2021-03-04T02:37:57Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790241461",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/11859881?v=4",
      "events_url": "https://api.github.com/users/SteveL-MSFT/events{/privacy}",
      "followers_url": "https://api.github.com/users/SteveL-MSFT/followers",
      "following_url": "https://api.github.com/users/SteveL-MSFT/following{/other_user}",
      "gists_url": "https://api.github.com/users/SteveL-MSFT/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SteveL-MSFT",
      "id": 11859881,
      "login": "SteveL-MSFT",
      "node_id": "MDQ6VXNlcjExODU5ODgx",
      "organizations_url": "https://api.github.com/users/SteveL-MSFT/orgs",
      "received_events_url": "https://api.github.com/users/SteveL-MSFT/received_events",
      "repos_url": "https://api.github.com/users/SteveL-MSFT/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SteveL-MSFT/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SteveL-MSFT/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SteveL-MSFT"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "`$OutputEncoding` AFAIK just controls the encoding PowerShell uses when it's piping data into a native command like `\"test\" | something.exe`. It seems like the .NET code has changed quite a lot from the Framework days so it could explain the difference between Windows PowerShell and PowerShell. I'll have to look into it a bit more and see if it explains what is happening.",
    "created_at": "2021-03-04T02:39:08Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790241871",
    "id": 790241871,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDI0MTg3MQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790241871/reactions"
    },
    "updated_at": "2021-03-04T02:39:08Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790241871",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "Trying to clear out any confusion there are 2 codepages associated with the console, the input and output codepage. For those 2 cp's I know of 3 \"native\" ways of setting them\r\n\r\n|Method|Input|Output|Notes|\r\n|-|-|-|-|\r\n|PInvoke|SetConsoleCP|SetConsoleOutputCP|I would consider this the absolute truth, it sources the data from the console itself and is how the other methods ultimately get/set the cp|\r\n|chcp|chcp <num>|chcp <num>|This sets both the input/output in 1 command. Running `chcp` by itself only reports the input value though|\r\n|.NET|`[Console]::InputEncoding`|`[Console]::OutputEncoding`|The value of these are cached, once it is retrieved once it will stay that way unless they were set in .NET itself||\r\n\r\nI could be wrong here but from observation the output code page is important here. If something is writing bytes directly to the conhost STDOUT pipe (like `[Console]::WriteLine` does) then it's the value of the output cp that decodes the bytes back to text. If the bytes sent don't match up with what encoded it then we will get back garbage text.\r\n\r\nTo illustrate this a bite more let's say we run `[Console]::WriteLine('café'). here is what happens in the .NET land\r\n\r\n* `Console.WriteLine` calls `Console.Out.WriteLine`\r\n* `Console.Out` is a `SyncTextWriter` stream\r\n* This stream will encode any strings using the `Console.OutputEncoding` value set\r\n  * `Console.OutputEncoding` is cached so on the first call it will source the cp from `GetConsoleOutputCP()` which happens when pwsh first starts up\r\n* The bytes are then written to a ConsoleStream which is based on a file handle for the STDOUT pipe\r\n* This \"pipe\" sends the bytes to conhost\r\n* Conhost will use the value of `GetConsoleOutputCP()` to decode those bytes back to text\r\n* Conhost will then print that text to the screen buffer\r\n\r\nIn Windows PowerShell, all 3 methods work to change the console input/output codepage. I can use all 3 to set the console output cp to UTF-8 so that my example in https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790225777 outputs the proper character.\r\n\r\nIn PowerShell the 3 methods work for getting/setting the input console codepage but the output one is complex. Setting the output cp does not work with the PInvoke or chcp way. I can do `[Console]::OutputEncoding = [Text.Encoding]::UTF8` and it does actually work. Looking at the code setting `[Console]::OutputEncoding` is just flushing the existing out/err pipes and then calling `SetConsoleCP()` so I'm confused as to why I cannot just do that in PowerShell itself.\r\n\r\nTaking out the `Console` class althogether and I can show another example that fails on PowerShell but works on Windows PowerShell.\r\n\r\n```powershell\r\nAdd-Type -TypeDefinition @'\r\nusing Microsoft.Win32.SafeHandles;\r\nusing System;\r\nusing System.Runtime.InteropServices;\r\n\r\nnamespace RawConsole\r\n{\r\n    public class NativeMethods\r\n    {\r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern SafeFileHandle GetStdHandle(\r\n            int nStdHandle);\r\n            \r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern bool SetConsoleOutputCP(\r\n            uint wCodePageID);\r\n    }\r\n}\r\n'@\r\n\r\n$stdoutHandle = [RawConsole.NativeMethods]::GetStdHandle(-11)\r\n$fs = [IO.FileStream]::New($stdoutHandle, 'Write')\r\n\r\n[RawConsole.NativeMethods]::SetConsoleOutputCP(65001)\r\n$data = [Text.Encoding]::UTF8.GetBytes('café')\r\n$fs.Write($data, 0, $data.Length)\r\n$fs.Flush()\r\n\r\n# This outputs 'caf├⌐' which is the UTF-8 bytes of my input decoded using cp 437\r\n```\r\n\r\nDoing the exact same with with PowerShell out of the picture and it works just fine\r\n\r\n```csharp\r\nusing Microsoft.Win32.SafeHandles;\r\nusing System;\r\nusing System.IO;\r\nusing System.Runtime.InteropServices;\r\nusing System.Text;\r\n\r\nnamespace myApp\r\n{\r\n    public class NativeMethods\r\n    {\r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern int GetConsoleOutputCP();\r\n    \r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern SafeFileHandle GetStdHandle(\r\n            int nStdHandle);\r\n            \r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern bool SetConsoleOutputCP(\r\n            int wCodePageID);\r\n    }\r\n\r\n    class Program\r\n    {\r\n        static void Main(string[] args)\r\n        {\r\n            Console.WriteLine(NativeMethods.GetConsoleOutputCP());  // Just verifies the original was 437 in my case\r\n\r\n            using (SafeFileHandle stdoutHandle = NativeMethods.GetStdHandle(-11))\r\n            using (FileStream fs = new FileStream(stdoutHandle, FileAccess.Write))\r\n            {\r\n                NativeMethods.SetConsoleOutputCP(65001);\r\n                \r\n                byte[] data = Encoding.UTF8.GetBytes(\"café\");\r\n                fs.Write(data, 0, data.Length);\r\n                fs.Flush();\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nSo ultimately I have 2 questions:\r\n\r\n* Why does PInvoke `SetConsoleOutputCP()` not work when calling from PowerShell (Windows PowerShell is fine)\r\n* Why does `[Console]::OutputEncoding = ...` work in PowerShell but the PInvoke method does not\r\n  * It essentially does the same thing\r\n\r\nGranted these are edge cases and it looks like doing `[Console]::OutputEncoding = ...` works for the majority of scenarios. What I really want to understand is why that's the case.",
    "created_at": "2021-03-04T03:40:15Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790265561",
    "id": 790265561,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDI2NTU2MQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790265561/reactions"
    },
    "updated_at": "2021-03-04T03:52:34Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790265561",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "Final thing to add it seems like this is only a problem if I'm calling `SetConsoleOutputCP()` directly from PowerShell.\r\n\r\nThe following does work and replicates the behaviour I'm seeing when running my pure .NET binary.\r\n\r\n```powershell\r\nAdd-Type -TypeDefinition @'\r\nusing Microsoft.Win32.SafeHandles;\r\nusing System;\r\nusing System.IO;\r\nusing System.Runtime.InteropServices;\r\nusing System.Text;\r\n\r\nnamespace RawConsole\r\n{\r\n    public class NativeMethods\r\n    {\r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern int GetConsoleOutputCP();\r\n\r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern SafeFileHandle GetStdHandle(\r\n            int nStdHandle);\r\n            \r\n        [DllImport(\"Kernel32.dll\")]\r\n        public static extern bool SetConsoleOutputCP(\r\n            int wCodePageID);\r\n    }\r\n    \r\n    public class Program\r\n    {\r\n        public static void Main(string value, Encoding encoding)\r\n        {\r\n            Console.WriteLine(NativeMethods.GetConsoleOutputCP().ToString());\r\n            NativeMethods.SetConsoleOutputCP(encoding.CodePage);\r\n            Console.WriteLine(NativeMethods.GetConsoleOutputCP().ToString());  // It actually updates here!\r\n\r\n            using (SafeFileHandle stdoutHandle = NativeMethods.GetStdHandle(-11))\r\n            using (FileStream fs = new FileStream(stdoutHandle, FileAccess.Write))\r\n            {                \r\n                byte[] data = encoding.GetBytes(value);\r\n                fs.Write(data, 0, data.Length);\r\n                fs.Flush();\r\n            }\r\n        }\r\n    }\r\n}\r\n'@\r\n\r\n[RawConsole.Program]::Main('café', [Text.Encoding]::UTF8)\r\n```\r\n\r\nIs my PInvoke definition wrong, am I calling it incorrectly in Powershell? Is PowerShell resetting my codepage in between statements?",
    "created_at": "2021-03-04T03:48:19Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790267979",
    "id": 790267979,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDI2Nzk3OQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790267979/reactions"
    },
    "updated_at": "2021-03-04T03:49:11Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790267979",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "Thanks to @SeeminglyScience (once again!) the issue comes down to `PSReadLine` resetting the console codepage after every statement (maybe command I'm not 100% sure). So by setting it through `chcp` or PInvoke it is actually being sent to conhost PSReadLine is just setting it back afterwards before I go to check the value.\r\n\r\n@SteveL-MSFT I can raise this issue in the PSReadLine repository but I assume it's expected behaviour and you are just expected to use `[Console]::OutputEncoding` to set this value going forward so will hold off unless you want me to open it.",
    "created_at": "2021-03-04T05:07:57Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790295525",
    "id": 790295525,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDI5NTUyNQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 1,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 2,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790295525/reactions"
    },
    "updated_at": "2021-03-04T05:08:42Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790295525",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "> `PSReadLine` resetting the console codepage after every statement (maybe command I'm not 100% sure).\r\n\r\nIt would be between interactive evals, if it's happening between statements then I can't explain why disabling PSRL fixes it tbh. Make sure your paste isn't being translated into multiple `ReadLine` loops (e.g. right clicking or ctrl v in some terminal apps).  Easiest way is to try it all on one line with semi colons or wrap in `& { }`.",
    "created_at": "2021-03-04T05:23:29Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790301377",
    "id": 790301377,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDMwMTM3Nw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790301377/reactions"
    },
    "updated_at": "2021-03-04T05:23:29Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790301377",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/24977523?v=4",
      "events_url": "https://api.github.com/users/SeeminglyScience/events{/privacy}",
      "followers_url": "https://api.github.com/users/SeeminglyScience/followers",
      "following_url": "https://api.github.com/users/SeeminglyScience/following{/other_user}",
      "gists_url": "https://api.github.com/users/SeeminglyScience/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SeeminglyScience",
      "id": 24977523,
      "login": "SeeminglyScience",
      "node_id": "MDQ6VXNlcjI0OTc3NTIz",
      "organizations_url": "https://api.github.com/users/SeeminglyScience/orgs",
      "received_events_url": "https://api.github.com/users/SeeminglyScience/received_events",
      "repos_url": "https://api.github.com/users/SeeminglyScience/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SeeminglyScience/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SeeminglyScience/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SeeminglyScience"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "Yea I am just copy and pasting my examples so that would explain it even more.",
    "created_at": "2021-03-04T05:27:48Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790303304",
    "id": 790303304,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDMwMzMwNA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790303304/reactions"
    },
    "updated_at": "2021-03-04T05:27:48Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790303304",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "Great sleuthing, but do we know _why_ PSReadLine does that? Just to guard against external programs changing the code page?\r\n",
    "created_at": "2021-03-04T13:29:34Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790618408",
    "id": 790618408,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDYxODQwOA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790618408/reactions"
    },
    "updated_at": "2021-03-04T13:29:34Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790618408",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/588825?v=4",
      "events_url": "https://api.github.com/users/mklement0/events{/privacy}",
      "followers_url": "https://api.github.com/users/mklement0/followers",
      "following_url": "https://api.github.com/users/mklement0/following{/other_user}",
      "gists_url": "https://api.github.com/users/mklement0/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mklement0",
      "id": 588825,
      "login": "mklement0",
      "node_id": "MDQ6VXNlcjU4ODgyNQ==",
      "organizations_url": "https://api.github.com/users/mklement0/orgs",
      "received_events_url": "https://api.github.com/users/mklement0/received_events",
      "repos_url": "https://api.github.com/users/mklement0/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mklement0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mklement0/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mklement0"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "It saves the [initial output encoding on first `ReadLine`](https://github.com/PowerShell/PSReadLine/blob/f8fb650774a0c0e9421d9389f4a6dee5b8718b07/PSReadLine/ReadLine.cs#L710) call, and then resets it back to that [after every `ReadLine` finishes](https://github.com/PowerShell/PSReadLine/blob/f8fb650774a0c0e9421d9389f4a6dee5b8718b07/PSReadLine/ReadLine.cs#L441).\r\n\r\nIt can probably be updated to allow for mid-process encoding customizations.\r\n\r\nI think the why is that it forces UTF8 for prompt rendering? Can't remember, but something like that.",
    "created_at": "2021-03-04T13:42:58Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-790626769",
    "id": 790626769,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MDYyNjc2OQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790626769/reactions"
    },
    "updated_at": "2021-03-04T13:44:32Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/790626769",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/24977523?v=4",
      "events_url": "https://api.github.com/users/SeeminglyScience/events{/privacy}",
      "followers_url": "https://api.github.com/users/SeeminglyScience/followers",
      "following_url": "https://api.github.com/users/SeeminglyScience/following{/other_user}",
      "gists_url": "https://api.github.com/users/SeeminglyScience/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SeeminglyScience",
      "id": 24977523,
      "login": "SeeminglyScience",
      "node_id": "MDQ6VXNlcjI0OTc3NTIz",
      "organizations_url": "https://api.github.com/users/SeeminglyScience/orgs",
      "received_events_url": "https://api.github.com/users/SeeminglyScience/received_events",
      "repos_url": "https://api.github.com/users/SeeminglyScience/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SeeminglyScience/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SeeminglyScience/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SeeminglyScience"
    }
  },
  {
    "author_association": "MEMBER",
    "body": "Looking at git blame, it seems https://github.com/PowerShell/PSReadLine/commit/c3868e125069d87adbc5ee8f0274762a99510957 to address an issue with CJK chars coming from native commands",
    "created_at": "2021-03-05T00:12:36Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/14941#issuecomment-791045343",
    "id": 791045343,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/14941",
    "node_id": "MDEyOklzc3VlQ29tbWVudDc5MTA0NTM0Mw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/791045343/reactions"
    },
    "updated_at": "2021-03-05T00:12:36Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/791045343",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/11859881?v=4",
      "events_url": "https://api.github.com/users/SteveL-MSFT/events{/privacy}",
      "followers_url": "https://api.github.com/users/SteveL-MSFT/followers",
      "following_url": "https://api.github.com/users/SteveL-MSFT/following{/other_user}",
      "gists_url": "https://api.github.com/users/SteveL-MSFT/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SteveL-MSFT",
      "id": 11859881,
      "login": "SteveL-MSFT",
      "node_id": "MDQ6VXNlcjExODU5ODgx",
      "organizations_url": "https://api.github.com/users/SteveL-MSFT/orgs",
      "received_events_url": "https://api.github.com/users/SteveL-MSFT/received_events",
      "repos_url": "https://api.github.com/users/SteveL-MSFT/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SteveL-MSFT/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SteveL-MSFT/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SteveL-MSFT"
    }
  }
]
