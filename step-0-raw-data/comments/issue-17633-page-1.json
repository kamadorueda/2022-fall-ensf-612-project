[
  {
    "author_association": "NONE",
    "body": "Reading through the stack trace again, it seems that `PowerShell.Stop()` called in `HandleBreak` thread runs almost to the end, but gets stuck waiting for the pipeline to finish. My guess would be that the nested runspace thread responsible for running the pipeline is stuck waiting for host input and doesn't \"notice\" that it should end. The question then probably is, why does this work when there's only one runspace involved, but not when there's a nested runspace?\r\n\r\nIs it incorrect to call `PowerShell.Stop()` in the `StopProcessing` handler, or is this an internal PowerShell issue and this is supposed to work?",
    "created_at": "2022-07-05T21:59:41Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17633#issuecomment-1175542493",
    "id": 1175542493,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17633",
    "node_id": "IC_kwDOAvT7bc5GEVrd",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1175542493/reactions"
    },
    "updated_at": "2022-07-05T22:00:21Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1175542493",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/6414091?v=4",
      "events_url": "https://api.github.com/users/MatejKafka/events{/privacy}",
      "followers_url": "https://api.github.com/users/MatejKafka/followers",
      "following_url": "https://api.github.com/users/MatejKafka/following{/other_user}",
      "gists_url": "https://api.github.com/users/MatejKafka/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/MatejKafka",
      "id": 6414091,
      "login": "MatejKafka",
      "node_id": "MDQ6VXNlcjY0MTQwOTE=",
      "organizations_url": "https://api.github.com/users/MatejKafka/orgs",
      "received_events_url": "https://api.github.com/users/MatejKafka/received_events",
      "repos_url": "https://api.github.com/users/MatejKafka/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/MatejKafka/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MatejKafka/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/MatejKafka"
    }
  },
  {
    "author_association": "NONE",
    "body": "If you use the async methods PowerShell.BeginStop and PowerShell.EndStop, it's working as expected.\r\n\r\n![image](https://user-images.githubusercontent.com/6187529/177456064-e356e11f-95e5-4b88-8b07-cd57e12935f3.png)\r\n\r\n\r\n```cs\r\nusing System;\r\nusing System.Management.Automation;\r\nusing System.Management.Automation.Runspaces;\r\n\r\n[Cmdlet(VerbsLifecycle.Invoke, \"RunspacePrompt\")]\r\npublic class InvokeRunspacePrompt : PSCmdlet, IDisposable {\r\n    private readonly PowerShell _ps = PowerShell.Create();\r\n    protected override void BeginProcessing() {\r\n        base.BeginProcessing();\r\n        _ps.Runspace = RunspaceFactory.CreateRunspace(Host);\r\n        _ps.Runspace.Open();\r\n        _ps.AddScript(@\"$Host.UI.Write('Input: '); $Host.UI.ReadLine()\");\r\n        Console.WriteLine(\"Invoking\");\r\n        _ps.Invoke();\r\n    }\r\n\r\n    protected override void StopProcessing() {\r\n        base.StopProcessing();\r\n        _ps.BeginStop(ar => { _ps.EndStop(ar); /*System.Threading.Thread.Sleep(30000);*/ Console.WriteLine(\"PS Stopped\") ;}, null);\r\n        Console.WriteLine(\"StopProcessing Done.\");\r\n    }\r\n\r\n    public void Dispose() {\r\n        _ps.Runspace?.Dispose();\r\n        _ps.Dispose();\r\n    }\r\n}\r\n```",
    "created_at": "2022-07-06T02:46:42Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17633#issuecomment-1175718196",
    "id": 1175718196,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17633",
    "node_id": "IC_kwDOAvT7bc5GFAk0",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1175718196/reactions"
    },
    "updated_at": "2022-07-06T02:57:43Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1175718196",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/6187529?v=4",
      "events_url": "https://api.github.com/users/fMichaleczek/events{/privacy}",
      "followers_url": "https://api.github.com/users/fMichaleczek/followers",
      "following_url": "https://api.github.com/users/fMichaleczek/following{/other_user}",
      "gists_url": "https://api.github.com/users/fMichaleczek/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/fMichaleczek",
      "id": 6187529,
      "login": "fMichaleczek",
      "node_id": "MDQ6VXNlcjYxODc1Mjk=",
      "organizations_url": "https://api.github.com/users/fMichaleczek/orgs",
      "received_events_url": "https://api.github.com/users/fMichaleczek/received_events",
      "repos_url": "https://api.github.com/users/fMichaleczek/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/fMichaleczek/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fMichaleczek/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/fMichaleczek"
    }
  },
  {
    "author_association": "NONE",
    "body": "@fMichaleczek This almost works, but it seems there's a race condition between the child runspace starting to run another command and getting stopped. Try changing\r\n```c#\r\n_ps.AddScript(@\"$Host.UI.Write('Input: '); $Host.UI.ReadLine()\");\r\n```\r\nto\r\n```c#\r\n_ps.AddScript(@\"$Host.UI.Write('Input: '); $Host.UI.ReadLine(); $Host.UI.Write('Input done.')\");\r\n```\r\n\r\nAt least on my machine, the second input prompt triggers before the runspace is stopped:\r\n![image](https://user-images.githubusercontent.com/6414091/177525309-2c53d5b9-6fb4-4479-be4f-d08d2f0e31ce.png)\r\n",
    "created_at": "2022-07-06T10:01:17Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/17633#issuecomment-1176030681",
    "id": 1176030681,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/17633",
    "node_id": "IC_kwDOAvT7bc5GGM3Z",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1176030681/reactions"
    },
    "updated_at": "2022-07-06T10:01:17Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/1176030681",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/6414091?v=4",
      "events_url": "https://api.github.com/users/MatejKafka/events{/privacy}",
      "followers_url": "https://api.github.com/users/MatejKafka/followers",
      "following_url": "https://api.github.com/users/MatejKafka/following{/other_user}",
      "gists_url": "https://api.github.com/users/MatejKafka/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/MatejKafka",
      "id": 6414091,
      "login": "MatejKafka",
      "node_id": "MDQ6VXNlcjY0MTQwOTE=",
      "organizations_url": "https://api.github.com/users/MatejKafka/orgs",
      "received_events_url": "https://api.github.com/users/MatejKafka/received_events",
      "repos_url": "https://api.github.com/users/MatejKafka/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/MatejKafka/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MatejKafka/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/MatejKafka"
    }
  }
]
