[
  {
    "author_association": "COLLABORATOR",
    "body": "> tries to move the tests for OneDrive paths so that they don't cause side effects for existing tests.\r\n\r\nAre there really side effects from the tests?",
    "created_at": "2021-05-27T06:39:02Z",
    "html_url": "https://github.com/PowerShell/PowerShell/pull/15467#issuecomment-849371289",
    "id": 849371289,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15467",
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0OTM3MTI4OQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/849371289/reactions"
    },
    "updated_at": "2021-05-27T06:39:02Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/849371289",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22290914?v=4",
      "events_url": "https://api.github.com/users/iSazonov/events{/privacy}",
      "followers_url": "https://api.github.com/users/iSazonov/followers",
      "following_url": "https://api.github.com/users/iSazonov/following{/other_user}",
      "gists_url": "https://api.github.com/users/iSazonov/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/iSazonov",
      "id": 22290914,
      "login": "iSazonov",
      "node_id": "MDQ6VXNlcjIyMjkwOTE0",
      "organizations_url": "https://api.github.com/users/iSazonov/orgs",
      "received_events_url": "https://api.github.com/users/iSazonov/received_events",
      "repos_url": "https://api.github.com/users/iSazonov/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/iSazonov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iSazonov/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/iSazonov"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "I think it is impossible to have reparse points for UNC paths (I mean source path, UNC path is possible as target for symbolic links). If it is true we can do:\r\n```c#\r\n        private const string ExtendedDevicePathPrefix = @\"\\\\?\\\";\r\n        private const string UncPathPrefix = @\"\\\\\";\r\n        private const string UncDevicePrefixToInsert = @\"?\\UNC\\\";\r\n        private const string UncExtendedPathPrefix = @\"\\\\?\\UNC\\\";\r\n        private const string DevicePathPrefix = @\"\\\\.\\\";\r\n\r\n        // \\\\?\\, \\\\.\\, \\??\\\r\n        private const int DevicePrefixLength = 4;\r\n\r\n        private static string EnsureExtendedPrefix(string path)\r\n        {\r\n            if (IsPartiallyQualified(path) || IsDevice(path))\r\n                return path;\r\n\r\n            // Given \\\\server\\share in longpath becomes \\\\?\\UNC\\server\\share\r\n            if (path.StartsWith(UncPathPrefix, StringComparison.OrdinalIgnoreCase))\r\n                return path.Insert(2, UncDevicePrefixToInsert);\r\n\r\n            return ExtendedDevicePathPrefix + path;\r\n        }\r\n\r\n        private static bool IsDevice(string path)\r\n        {\r\n            return IsExtended(path)\r\n                ||\r\n                (\r\n                    path.Length >= DevicePrefixLength\r\n                    && IsDirectorySeparator(path[0])\r\n                    && IsDirectorySeparator(path[1])\r\n                    && (path[2] == '.' || path[2] == '?')\r\n                    && IsDirectorySeparator(path[3])\r\n                );\r\n        }\r\n\r\n        private static bool IsExtended(string path)\r\n        {\r\n            return path.Length >= DevicePrefixLength\r\n                && path[0] == '\\\\'\r\n                && (path[1] == '\\\\' || path[1] == '?')\r\n                && path[2] == '?'\r\n                && path[3] == '\\\\';\r\n        }\r\n\r\n\r\n        internal static bool IsReparsePointLikeSymlink(FileSystemInfo fileInfo)\r\n        {\r\n#if UNIX\r\n            // Reparse point on Unix is a symlink.\r\n            return IsReparsePoint(fileInfo);\r\n#else\r\n            if (InternalTestHooks.OneDriveTestOn && fileInfo.Name == InternalTestHooks.OneDriveTestSymlinkName)\r\n            {\r\n                return !InternalTestHooks.OneDriveTestRecurseOn;\r\n            }\r\n\r\n            WIN32_FIND_DATA data = default;\r\n            string fullPath = Path.TrimEndingDirectorySeparator(fileInfo.FullName);\r\n\r\n            if (fullPath.Length > MAX_PATH)\r\n            {\r\n                fullPath = EnsureExtendedPrefix(fullPath);\r\n            }\r\n\r\n            using (var handle = FindFirstFileEx(fullPath, FINDEX_INFO_LEVELS.FindExInfoBasic, ref data, FINDEX_SEARCH_OPS.FindExSearchNameMatch, IntPtr.Zero, 0))\r\n            ...\r\n```\r\n\r\nIf there is a reparse point at the end of this long path - the scenario was never covered by tests. ",
    "created_at": "2021-05-27T07:34:46Z",
    "html_url": "https://github.com/PowerShell/PowerShell/pull/15467#issuecomment-849408170",
    "id": 849408170,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15467",
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0OTQwODE3MA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/849408170/reactions"
    },
    "updated_at": "2021-05-30T14:01:36Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/849408170",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22290914?v=4",
      "events_url": "https://api.github.com/users/iSazonov/events{/privacy}",
      "followers_url": "https://api.github.com/users/iSazonov/followers",
      "following_url": "https://api.github.com/users/iSazonov/following{/other_user}",
      "gists_url": "https://api.github.com/users/iSazonov/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/iSazonov",
      "id": 22290914,
      "login": "iSazonov",
      "node_id": "MDQ6VXNlcjIyMjkwOTE0",
      "organizations_url": "https://api.github.com/users/iSazonov/orgs",
      "received_events_url": "https://api.github.com/users/iSazonov/received_events",
      "repos_url": "https://api.github.com/users/iSazonov/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/iSazonov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iSazonov/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/iSazonov"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "> I think it is impossible to have reparse points for UNC paths\r\n\r\nIt's still possible to have a reparse point over a UNC path. How the client interprets a symlink does differ but that doesn't really matter in this case. The code is just checking to see whether it needs to go into the target and delete the contents or just the reparse point.\r\n\r\nBut by adding the `!IsReparsePoint(fileInfo)` check here you do avoid having to then make yet another Win32 call if it isn't a reparse point which is nice. The only time `FindFirstFileEx` is needed is if the dir has a reparse point and the code needs to clarify whether the reparse point is one drive or app exec link reparse point. It's a pity `System.IO.DirectoryInfo` doesn't expose the `dwReserved0` field publicly meaning all this code wouldn't be needed.",
    "created_at": "2021-05-30T02:08:40Z",
    "html_url": "https://github.com/PowerShell/PowerShell/pull/15467#issuecomment-850927768",
    "id": 850927768,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15467",
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MDkyNzc2OA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/850927768/reactions"
    },
    "updated_at": "2021-05-30T02:08:40Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/850927768",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "> It's still possible to have a reparse point over a UNC path.\r\n\r\nReparse point is a feature _local_ NTFS - we can have UNC as target but not as _source_. In the context we check the source.",
    "created_at": "2021-05-30T07:27:07Z",
    "html_url": "https://github.com/PowerShell/PowerShell/pull/15467#issuecomment-850955701",
    "id": 850955701,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15467",
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MDk1NTcwMQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/850955701/reactions"
    },
    "updated_at": "2021-05-30T07:27:07Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/850955701",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22290914?v=4",
      "events_url": "https://api.github.com/users/iSazonov/events{/privacy}",
      "followers_url": "https://api.github.com/users/iSazonov/followers",
      "following_url": "https://api.github.com/users/iSazonov/following{/other_user}",
      "gists_url": "https://api.github.com/users/iSazonov/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/iSazonov",
      "id": 22290914,
      "login": "iSazonov",
      "node_id": "MDQ6VXNlcjIyMjkwOTE0",
      "organizations_url": "https://api.github.com/users/iSazonov/orgs",
      "received_events_url": "https://api.github.com/users/iSazonov/received_events",
      "repos_url": "https://api.github.com/users/iSazonov/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/iSazonov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iSazonov/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/iSazonov"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "It might be a feature of local NTFS but the same attributes are exposed over SMB. So you can enumerate a network path over SMB that contains a OneDrive link which appear as a reparse point but still needs those further checks that the function does. My comment merely tries to confirm that the reparse check can still occur beforehand to reduce the extra Win32 call if the item isn’t a reparse point.",
    "created_at": "2021-05-30T08:44:28Z",
    "html_url": "https://github.com/PowerShell/PowerShell/pull/15467#issuecomment-850964340",
    "id": 850964340,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15467",
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MDk2NDM0MA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/850964340/reactions"
    },
    "updated_at": "2021-05-30T08:44:28Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/850964340",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8462645?v=4",
      "events_url": "https://api.github.com/users/jborean93/events{/privacy}",
      "followers_url": "https://api.github.com/users/jborean93/followers",
      "following_url": "https://api.github.com/users/jborean93/following{/other_user}",
      "gists_url": "https://api.github.com/users/jborean93/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jborean93",
      "id": 8462645,
      "login": "jborean93",
      "node_id": "MDQ6VXNlcjg0NjI2NDU=",
      "organizations_url": "https://api.github.com/users/jborean93/orgs",
      "received_events_url": "https://api.github.com/users/jborean93/received_events",
      "repos_url": "https://api.github.com/users/jborean93/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jborean93/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jborean93/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jborean93"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "For history. I found PR where the test was added. https://github.com/PowerShell/PowerShell/commit/ce4c35b9ed42a582e0a00bdd90b410f6c23b788c#diff-08b9d853f19b7b63dfb6b0fa7b634db55f2a20aeed01ffb5855b3e5b0da3431b There we also added EnsureLongPathPrefixIfNeeded() with simple normalization. It is 6.0 Beta.3 time.\r\nLater in https://github.com/PowerShell/PowerShell/commit/81244fb9077847dda892c5eff621933354ff4212#diff-08b9d853f19b7b63dfb6b0fa7b634db55f2a20aeed01ffb5855b3e5b0da3431b we migrated to .Net API. It is v6.1.0-preview.4. So the simple normalization worked only in 6.0.\r\n\r\n----\r\n\r\nI played with mount points over network and this works as @jborean93 pointed (thanks!).\r\n\r\nSo I think we should use already tested .Net code\r\nhttps://github.com/dotnet/runtime/blob/95a4476b91827e6f707744fab6e9d87df870407a/src/libraries/Common/src/System/IO/PathInternal.Windows.cs#L77-L112.\r\n\r\nI updated my proposal above.\r\n\r\n----\r\n\r\nNow we have an issue in .Net Runtime repository where we are discussing new API for symbolic links and probably reparse points too. Perhaps we get this in .Net 6.0. I hope the new API allows us to remove all p/invokes in PowerShell (in the area).\r\n\n\n<blockquote><img src=\"https://opengraph.githubassets.com/f1f3306a3d0bc92eac578a58e8b405303f49878dfdcb7efb1b9c674ad61bee02/dotnet/runtime\" width=\"48\" align=\"right\"><div><img src=\"https://github.githubassets.com/favicons/favicon.svg\" height=\"14\"> GitHub</div><div><strong><a href=\"https://github.com/dotnet/runtime\">dotnet/runtime</a></strong></div><div>.NET is a cross-platform runtime for cloud, mobile, desktop, and IoT apps. - dotnet/runtime</div></blockquote>",
    "created_at": "2021-05-30T14:10:31Z",
    "html_url": "https://github.com/PowerShell/PowerShell/pull/15467#issuecomment-851006648",
    "id": 851006648,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15467",
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MTAwNjY0OA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/851006648/reactions"
    },
    "updated_at": "2021-05-30T14:10:34Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/851006648",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22290914?v=4",
      "events_url": "https://api.github.com/users/iSazonov/events{/privacy}",
      "followers_url": "https://api.github.com/users/iSazonov/followers",
      "following_url": "https://api.github.com/users/iSazonov/following{/other_user}",
      "gists_url": "https://api.github.com/users/iSazonov/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/iSazonov",
      "id": 22290914,
      "login": "iSazonov",
      "node_id": "MDQ6VXNlcjIyMjkwOTE0",
      "organizations_url": "https://api.github.com/users/iSazonov/orgs",
      "received_events_url": "https://api.github.com/users/iSazonov/received_events",
      "repos_url": "https://api.github.com/users/iSazonov/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/iSazonov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/iSazonov/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/iSazonov"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "Closing in favour of https://github.com/PowerShell/PowerShell/pull/15546.",
    "created_at": "2021-06-08T21:31:59Z",
    "html_url": "https://github.com/PowerShell/PowerShell/pull/15467#issuecomment-857173387",
    "id": 857173387,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15467",
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1NzE3MzM4Nw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/857173387/reactions"
    },
    "updated_at": "2021-06-08T21:31:59Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/857173387",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/7009879?v=4",
      "events_url": "https://api.github.com/users/rjmholt/events{/privacy}",
      "followers_url": "https://api.github.com/users/rjmholt/followers",
      "following_url": "https://api.github.com/users/rjmholt/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjmholt/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/rjmholt",
      "id": 7009879,
      "login": "rjmholt",
      "node_id": "MDQ6VXNlcjcwMDk4Nzk=",
      "organizations_url": "https://api.github.com/users/rjmholt/orgs",
      "received_events_url": "https://api.github.com/users/rjmholt/received_events",
      "repos_url": "https://api.github.com/users/rjmholt/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/rjmholt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjmholt/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/rjmholt"
    }
  }
]
