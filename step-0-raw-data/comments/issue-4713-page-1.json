[
  {
    "author_association": "CONTRIBUTOR",
    "body": "I can't speak to the underlying design issues (how things _should_ work in this case), but I can offer a pointer:\r\n\r\nYour code would work if you put the module code into a `*.psm1` file instead and import it with `Import-Module` or `using module`.\r\n\r\nNote that only with `using module` is the module's custom class truly imported into the caller's scope and accessible as `[c]` (modules neither by default export custom classes nor allow their explicit exporting; they're imported (implicitly) only with a `using module` statement, which is used at _parse_ time and must be the very 1st statement in the script).",
    "created_at": "2017-09-01T19:54:31Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/4713#issuecomment-326670316",
    "id": 326670316,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/4713",
    "node_id": "MDEyOklzc3VlQ29tbWVudDMyNjY3MDMxNg==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 2,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 2,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/326670316/reactions"
    },
    "updated_at": "2017-09-01T19:54:31Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/326670316",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/588825?v=4",
      "events_url": "https://api.github.com/users/mklement0/events{/privacy}",
      "followers_url": "https://api.github.com/users/mklement0/followers",
      "following_url": "https://api.github.com/users/mklement0/following{/other_user}",
      "gists_url": "https://api.github.com/users/mklement0/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/mklement0",
      "id": 588825,
      "login": "mklement0",
      "node_id": "MDQ6VXNlcjU4ODgyNQ==",
      "organizations_url": "https://api.github.com/users/mklement0/orgs",
      "received_events_url": "https://api.github.com/users/mklement0/received_events",
      "repos_url": "https://api.github.com/users/mklement0/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/mklement0/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mklement0/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/mklement0"
    }
  },
  {
    "author_association": "NONE",
    "body": ">Your code would work if you put the module code into a *.psm1 file instead and import it with Import-Module...\r\n\r\nInteresting.  I confirmed this behavior.  I wonder if there is a good reason for the discrepancy in behaviors between the `.psm1`-backed and dynamic modules.\r\n\r\n",
    "created_at": "2017-09-01T20:30:09Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/4713#issuecomment-326677138",
    "id": 326677138,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/4713",
    "node_id": "MDEyOklzc3VlQ29tbWVudDMyNjY3NzEzOA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/326677138/reactions"
    },
    "updated_at": "2017-09-01T20:30:09Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/326677138",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/11237922?v=4",
      "events_url": "https://api.github.com/users/alx9r/events{/privacy}",
      "followers_url": "https://api.github.com/users/alx9r/followers",
      "following_url": "https://api.github.com/users/alx9r/following{/other_user}",
      "gists_url": "https://api.github.com/users/alx9r/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/alx9r",
      "id": 11237922,
      "login": "alx9r",
      "node_id": "MDQ6VXNlcjExMjM3OTIy",
      "organizations_url": "https://api.github.com/users/alx9r/orgs",
      "received_events_url": "https://api.github.com/users/alx9r/received_events",
      "repos_url": "https://api.github.com/users/alx9r/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/alx9r/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alx9r/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/alx9r"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "@daxian-dbw I remember discussing this with you. What are the exact mechanics here?",
    "created_at": "2018-04-19T18:23:06Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/4713#issuecomment-382834151",
    "id": 382834151,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/4713",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MjgzNDE1MQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/382834151/reactions"
    },
    "updated_at": "2018-04-19T18:23:06Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/382834151",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/7009879?v=4",
      "events_url": "https://api.github.com/users/rjmholt/events{/privacy}",
      "followers_url": "https://api.github.com/users/rjmholt/followers",
      "following_url": "https://api.github.com/users/rjmholt/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjmholt/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/rjmholt",
      "id": 7009879,
      "login": "rjmholt",
      "node_id": "MDQ6VXNlcjcwMDk4Nzk=",
      "organizations_url": "https://api.github.com/users/rjmholt/orgs",
      "received_events_url": "https://api.github.com/users/rjmholt/received_events",
      "repos_url": "https://api.github.com/users/rjmholt/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/rjmholt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjmholt/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/rjmholt"
    }
  },
  {
    "author_association": "MEMBER",
    "body": "This issue is a duplicate of #2841 \r\n\r\nAll classes in a script block, including those in the nested script blocks, are emitted when the top level script block (`scriptblockast.Parent == null`) is compiled. After emitting the dyanmic types, the compiler will generate code to initialize the produced types when the top-level script block runs, of which one task is to associate thsoe types with the current active session state, so instances of those types can run methods using that session state.\r\n\r\nThis casues a problem to `New-Module m { class c { ... } }`, where the class `c` is supposed to be associated with the module session state when it's evaluated within `New-Module`, but it has already been associated with the active session state when running the top-level scirpt block `New-Module`.\r\nThe instance of `foo` cannot find `Invoke-Something` because it's not using the module session state when running `Invoke()`.\r\n\r\nWhen `Invoke()` runs, it's actually using the outer session state to resolve the command, and in this case, if `Invoke-Something` is defined in the scope chain in the outer session state, then it will find it. See the below code for comparison.\r\n```\r\n& {\r\n function Invoke-Something { \"Something\" }\r\n New-Module m {\r\n     class c {\r\n         [object] Invoke () { return Invoke-Something }\r\n     }\r\n     function New-InstanceOfC { [c]::new() }\r\n } | Out-Null\r\n (New-InstanceOfC).Invoke()\r\n }\r\nSomething\r\n```",
    "created_at": "2018-05-02T23:46:08Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/4713#issuecomment-386154839",
    "id": 386154839,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/4713",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4NjE1NDgzOQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/386154839/reactions"
    },
    "updated_at": "2018-05-02T23:46:08Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/386154839",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/127450?v=4",
      "events_url": "https://api.github.com/users/daxian-dbw/events{/privacy}",
      "followers_url": "https://api.github.com/users/daxian-dbw/followers",
      "following_url": "https://api.github.com/users/daxian-dbw/following{/other_user}",
      "gists_url": "https://api.github.com/users/daxian-dbw/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/daxian-dbw",
      "id": 127450,
      "login": "daxian-dbw",
      "node_id": "MDQ6VXNlcjEyNzQ1MA==",
      "organizations_url": "https://api.github.com/users/daxian-dbw/orgs",
      "received_events_url": "https://api.github.com/users/daxian-dbw/received_events",
      "repos_url": "https://api.github.com/users/daxian-dbw/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/daxian-dbw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/daxian-dbw/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/daxian-dbw"
    }
  }
]
