[
  {
    "author_association": "NONE",
    "body": "Here is the similar script with runspaces but without runspace pools.\r\nIt has no obvious leaks in tested v6, v5, v2.\r\n\r\nThus, runspace pools look responsible for leaks.\r\n\r\n```powershell\r\n# This script uses [PowerShell] without runspace pools. Printed handle and\r\n# memory numbers stay within reasonable ranges. Stop manually by Ctrl+C or\r\n# close the console.\r\n\r\nfor() {\r\n\t$ps1 = [PowerShell]::Create()\r\n\r\n\t$job1 = $ps1.AddScript('Get-Date').BeginInvoke()\r\n\t$null = $job1.AsyncWaitHandle.WaitOne()\r\n\t$result = $ps1.EndInvoke($job1)\r\n\r\n\t$ps1.Dispose()\r\n\r\n\t$p = Get-Process -Id $PID\r\n\t\"$result Handles: $($p.HandleCount) Memory: $($p.PrivateMemorySize64 / 1mb) mb\"\r\n}\r\n```\r\n",
    "created_at": "2017-12-26T18:29:53Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/5746#issuecomment-353998531",
    "id": 353998531,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/5746",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1Mzk5ODUzMQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/353998531/reactions"
    },
    "updated_at": "2017-12-26T18:29:53Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/353998531",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/927533?v=4",
      "events_url": "https://api.github.com/users/nightroman/events{/privacy}",
      "followers_url": "https://api.github.com/users/nightroman/followers",
      "following_url": "https://api.github.com/users/nightroman/following{/other_user}",
      "gists_url": "https://api.github.com/users/nightroman/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/nightroman",
      "id": 927533,
      "login": "nightroman",
      "node_id": "MDQ6VXNlcjkyNzUzMw==",
      "organizations_url": "https://api.github.com/users/nightroman/orgs",
      "received_events_url": "https://api.github.com/users/nightroman/received_events",
      "repos_url": "https://api.github.com/users/nightroman/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/nightroman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nightroman/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/nightroman"
    }
  },
  {
    "author_association": "NONE",
    "body": "Oh wow, interesting!",
    "created_at": "2017-12-26T18:35:29Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/5746#issuecomment-353999134",
    "id": 353999134,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/5746",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1Mzk5OTEzNA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/353999134/reactions"
    },
    "updated_at": "2017-12-26T18:35:29Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/353999134",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8278033?v=4",
      "events_url": "https://api.github.com/users/potatoqualitee/events{/privacy}",
      "followers_url": "https://api.github.com/users/potatoqualitee/followers",
      "following_url": "https://api.github.com/users/potatoqualitee/following{/other_user}",
      "gists_url": "https://api.github.com/users/potatoqualitee/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/potatoqualitee",
      "id": 8278033,
      "login": "potatoqualitee",
      "node_id": "MDQ6VXNlcjgyNzgwMzM=",
      "organizations_url": "https://api.github.com/users/potatoqualitee/orgs",
      "received_events_url": "https://api.github.com/users/potatoqualitee/received_events",
      "repos_url": "https://api.github.com/users/potatoqualitee/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/potatoqualitee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/potatoqualitee/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/potatoqualitee"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "In many cases, calling `Close()` or `Dispose()` amount to the same thing but not with a `RunspacePool`.  You need to call `Dispose()`.  Try this:\r\n\r\n```posh\r\nfor() {\r\n    $pool = [RunspaceFactory]::CreateRunspacePool(1, 2)\r\n    $pool.Open()\r\n\r\n    $ps1 = [PowerShell]::Create()\r\n    $ps1.RunspacePool = $pool\r\n\r\n    $job1 = $ps1.AddScript('Get-Date').BeginInvoke()\r\n    $null = $job1.AsyncWaitHandle.WaitOne()\r\n    $result = $ps1.EndInvoke($job1)\r\n\r\n    $ps1.Dispose()\r\n    $pool.Dispose()\r\n    $p = Get-Process -Id $PID\r\n    \"$result Handles: $($p.HandleCount) Memory: $($p.PrivateMemorySize64 / 1mb) mb\"\r\n    $p = $result = $null\r\n    [System.GC]::Collect()\r\n}\r\n```\r\nAlso, when testing for memory leaks I like to invoke the GC regularly to reduce potential confusion by observing garbage accruing (which will get collected at some later time).",
    "created_at": "2017-12-26T19:07:26Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/5746#issuecomment-354002092",
    "id": 354002092,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/5746",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NDAwMjA5Mg==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 2,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 2,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354002092/reactions"
    },
    "updated_at": "2017-12-26T19:10:22Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354002092",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/5177512?v=4",
      "events_url": "https://api.github.com/users/rkeithhill/events{/privacy}",
      "followers_url": "https://api.github.com/users/rkeithhill/followers",
      "following_url": "https://api.github.com/users/rkeithhill/following{/other_user}",
      "gists_url": "https://api.github.com/users/rkeithhill/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/rkeithhill",
      "id": 5177512,
      "login": "rkeithhill",
      "node_id": "MDQ6VXNlcjUxNzc1MTI=",
      "organizations_url": "https://api.github.com/users/rkeithhill/orgs",
      "received_events_url": "https://api.github.com/users/rkeithhill/received_events",
      "repos_url": "https://api.github.com/users/rkeithhill/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/rkeithhill/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rkeithhill/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/rkeithhill"
    }
  },
  {
    "author_association": "NONE",
    "body": "It's a very good news!\r\n\r\n> In many cases, calling Close() or Dispose() amount to the same thing but not with a RunspacePool. You need to call Dispose()\r\n\r\nIs this by design or a bug?\r\n",
    "created_at": "2017-12-26T19:24:15Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/5746#issuecomment-354003795",
    "id": 354003795,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/5746",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NDAwMzc5NQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354003795/reactions"
    },
    "updated_at": "2017-12-26T19:24:15Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354003795",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/927533?v=4",
      "events_url": "https://api.github.com/users/nightroman/events{/privacy}",
      "followers_url": "https://api.github.com/users/nightroman/followers",
      "following_url": "https://api.github.com/users/nightroman/following{/other_user}",
      "gists_url": "https://api.github.com/users/nightroman/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/nightroman",
      "id": 927533,
      "login": "nightroman",
      "node_id": "MDQ6VXNlcjkyNzUzMw==",
      "organizations_url": "https://api.github.com/users/nightroman/orgs",
      "received_events_url": "https://api.github.com/users/nightroman/received_events",
      "repos_url": "https://api.github.com/users/nightroman/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/nightroman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nightroman/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/nightroman"
    }
  },
  {
    "author_association": "NONE",
    "body": "By the way!!  The initial sample code does shows memory leak in Windows 10 Insider Build 17046 when executing in Windows PowerShell 5.1.\r\n\r\n```\r\nPS [441] > $PSVersionTable\r\n\r\nName                           Value\r\n----                           -----\r\nPSVersion                      5.1.17046.1000\r\nPSEdition                      Desktop\r\nPSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}\r\nBuildVersion                   10.0.17046.1000\r\nCLRVersion                     4.0.30319.42000\r\nWSManStackVersion              3.0\r\nPSRemotingProtocolVersion      2.3\r\nSerializationVersion           1.1.0.1\r\n\r\n```",
    "created_at": "2017-12-26T19:28:04Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/5746#issuecomment-354004185",
    "id": 354004185,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/5746",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NDAwNDE4NQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354004185/reactions"
    },
    "updated_at": "2017-12-26T19:28:04Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354004185",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/19892435?v=4",
      "events_url": "https://api.github.com/users/MaximoTrinidad/events{/privacy}",
      "followers_url": "https://api.github.com/users/MaximoTrinidad/followers",
      "following_url": "https://api.github.com/users/MaximoTrinidad/following{/other_user}",
      "gists_url": "https://api.github.com/users/MaximoTrinidad/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/MaximoTrinidad",
      "id": 19892435,
      "login": "MaximoTrinidad",
      "node_id": "MDQ6VXNlcjE5ODkyNDM1",
      "organizations_url": "https://api.github.com/users/MaximoTrinidad/orgs",
      "received_events_url": "https://api.github.com/users/MaximoTrinidad/received_events",
      "repos_url": "https://api.github.com/users/MaximoTrinidad/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/MaximoTrinidad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MaximoTrinidad/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/MaximoTrinidad"
    }
  },
  {
    "author_association": "NONE",
    "body": "Good one @rkeithhill!  Thanks.",
    "created_at": "2017-12-26T19:30:05Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/5746#issuecomment-354004392",
    "id": 354004392,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/5746",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NDAwNDM5Mg==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354004392/reactions"
    },
    "updated_at": "2017-12-26T19:30:05Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354004392",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/19892435?v=4",
      "events_url": "https://api.github.com/users/MaximoTrinidad/events{/privacy}",
      "followers_url": "https://api.github.com/users/MaximoTrinidad/followers",
      "following_url": "https://api.github.com/users/MaximoTrinidad/following{/other_user}",
      "gists_url": "https://api.github.com/users/MaximoTrinidad/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/MaximoTrinidad",
      "id": 19892435,
      "login": "MaximoTrinidad",
      "node_id": "MDQ6VXNlcjE5ODkyNDM1",
      "organizations_url": "https://api.github.com/users/MaximoTrinidad/orgs",
      "received_events_url": "https://api.github.com/users/MaximoTrinidad/received_events",
      "repos_url": "https://api.github.com/users/MaximoTrinidad/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/MaximoTrinidad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MaximoTrinidad/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/MaximoTrinidad"
    }
  },
  {
    "author_association": "NONE",
    "body": "Unfortunately, I've experienced leaks with \r\n\r\n``` powershell \r\n$pool.Close() \r\n$pool.Dispose()\r\n```\r\n\r\nExecuting GC cleanup within the runspace scriptblock cleared it up but slowed things down dramatically.",
    "created_at": "2017-12-26T19:32:15Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/5746#issuecomment-354004608",
    "id": 354004608,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/5746",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NDAwNDYwOA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354004608/reactions"
    },
    "updated_at": "2017-12-26T19:32:15Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354004608",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/8278033?v=4",
      "events_url": "https://api.github.com/users/potatoqualitee/events{/privacy}",
      "followers_url": "https://api.github.com/users/potatoqualitee/followers",
      "following_url": "https://api.github.com/users/potatoqualitee/following{/other_user}",
      "gists_url": "https://api.github.com/users/potatoqualitee/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/potatoqualitee",
      "id": 8278033,
      "login": "potatoqualitee",
      "node_id": "MDQ6VXNlcjgyNzgwMzM=",
      "organizations_url": "https://api.github.com/users/potatoqualitee/orgs",
      "received_events_url": "https://api.github.com/users/potatoqualitee/received_events",
      "repos_url": "https://api.github.com/users/potatoqualitee/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/potatoqualitee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/potatoqualitee/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/potatoqualitee"
    }
  },
  {
    "author_association": "NONE",
    "body": "Also, the fact that v2 does not show leaks with the same code is interesting.",
    "created_at": "2017-12-26T19:33:52Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/5746#issuecomment-354004779",
    "id": 354004779,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/5746",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NDAwNDc3OQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354004779/reactions"
    },
    "updated_at": "2017-12-26T19:33:52Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354004779",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/927533?v=4",
      "events_url": "https://api.github.com/users/nightroman/events{/privacy}",
      "followers_url": "https://api.github.com/users/nightroman/followers",
      "following_url": "https://api.github.com/users/nightroman/following{/other_user}",
      "gists_url": "https://api.github.com/users/nightroman/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/nightroman",
      "id": 927533,
      "login": "nightroman",
      "node_id": "MDQ6VXNlcjkyNzUzMw==",
      "organizations_url": "https://api.github.com/users/nightroman/orgs",
      "received_events_url": "https://api.github.com/users/nightroman/received_events",
      "repos_url": "https://api.github.com/users/nightroman/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/nightroman/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nightroman/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/nightroman"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "@potatoqualitee I would not generally recommend putting GC collect calls in production code because that subverts the GC's (generally good) algorithms for when a GC is needed.  But for memory hoard detection, it is useful to eliminate the \"non-determinism\" of the GC.\r\n\r\nAlso, if you call `RunspacePool.Dispose()` it [internally calls](https://github.com/PowerShell/PowerShell/blob/master/src/System.Management.Automation/engine/hostifaces/RunspacePoolInternal.cs#L830) `Close()` so there is no need to call `Close()` before `Dispose()` AFAICT.\r\n\r\n@nightroman \r\n> Is this by design or a bug?\r\n\r\nThe [design guidelines](https://docs.microsoft.com/en-us/dotnet/standard/design-guidelines/dispose-pattern) say this:\r\n\r\n> ✓ CONSIDER providing method Close(), in addition to the Dispose(), if close is standard terminology in the area. \r\nWhen doing so, it is important that you make the Close implementation identical to Dispose and consider implementing the IDisposable.Dispose method explicitly. \r\n\r\nSince this is a \"guideline\" (CONSIDER vs DO or DO NOT), I wouldn't consider it a bug - bad form perhaps unless there is a way to re-open a closed RunspacePool but I don't see that functionality.\r\n\r\nP.S. Whenever I see \"DO or DO NOT\", I reflexively want to add \"there is no try\".  Hmm...",
    "created_at": "2017-12-26T21:39:10Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/5746#issuecomment-354015893",
    "id": 354015893,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/5746",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1NDAxNTg5Mw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354015893/reactions"
    },
    "updated_at": "2017-12-26T21:39:10Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/354015893",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/5177512?v=4",
      "events_url": "https://api.github.com/users/rkeithhill/events{/privacy}",
      "followers_url": "https://api.github.com/users/rkeithhill/followers",
      "following_url": "https://api.github.com/users/rkeithhill/following{/other_user}",
      "gists_url": "https://api.github.com/users/rkeithhill/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/rkeithhill",
      "id": 5177512,
      "login": "rkeithhill",
      "node_id": "MDQ6VXNlcjUxNzc1MTI=",
      "organizations_url": "https://api.github.com/users/rkeithhill/orgs",
      "received_events_url": "https://api.github.com/users/rkeithhill/received_events",
      "repos_url": "https://api.github.com/users/rkeithhill/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/rkeithhill/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rkeithhill/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/rkeithhill"
    }
  }
]
