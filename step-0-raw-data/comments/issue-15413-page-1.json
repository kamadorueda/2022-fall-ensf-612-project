[
  {
    "author_association": "CONTRIBUTOR",
    "body": "I'd say this is related to #11202, #12427 and maybe more issues. It seems the focus has been too much on WinPSCompat in those issues while ignoring the fact that `Get-FormatData` might have been broken for years when using third-party custom controls - even in Windows PowerShell as shown in https://github.com/PowerShell/PowerShell/issues/11202#issuecomment-558830772 also",
    "created_at": "2021-05-17T17:45:54Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/15413#issuecomment-842513324",
    "id": 842513324,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15413",
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MjUxMzMyNA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/842513324/reactions"
    },
    "updated_at": "2021-05-17T20:01:01Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/842513324",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/3436158?v=4",
      "events_url": "https://api.github.com/users/fflaten/events{/privacy}",
      "followers_url": "https://api.github.com/users/fflaten/followers",
      "following_url": "https://api.github.com/users/fflaten/following{/other_user}",
      "gists_url": "https://api.github.com/users/fflaten/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/fflaten",
      "id": 3436158,
      "login": "fflaten",
      "node_id": "MDQ6VXNlcjM0MzYxNTg=",
      "organizations_url": "https://api.github.com/users/fflaten/orgs",
      "received_events_url": "https://api.github.com/users/fflaten/received_events",
      "repos_url": "https://api.github.com/users/fflaten/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/fflaten/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fflaten/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/fflaten"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "Full stack trace (from `Get-Error`):\r\n\r\n```\r\nException             :\r\n    Type       : System.InvalidCastException\r\n    TargetSite :\r\n        Name          : ChkCast_Helper\r\n        DeclaringType : System.Runtime.CompilerServices.CastHelpers, System.Private.CoreLib,\r\nVersion=6.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\r\n        MemberType    : Method\r\n        Module        : System.Private.CoreLib.dll\r\n    StackTrace :\r\n   at System.Management.Automation.CustomItemBase.Create(FormatToken token)\r\n   at System.Management.Automation.CustomControlEntry..ctor(ComplexControlEntryDefinition entry)\r\n   at System.Management.Automation.CustomControl..ctor(ComplexControlBody body, ViewDefinition\r\nviewDefinition)\r\n   at Microsoft.PowerShell.Commands.GetFormatDataCommand.ProcessRecord()\r\n   at System.Management.Automation.Cmdlet.DoProcessRecord()\r\n   at System.Management.Automation.CommandProcessor.ProcessRecord()\r\n    Message    : Unable to cast object of type\r\n'Microsoft.PowerShell.Commands.Internal.Format.ControlReference' to type\r\n'Microsoft.PowerShell.Commands.Internal.Format.ComplexControlBody'.\r\n    Source     : System.Private.CoreLib\r\n    HResult    : -2147467262\r\nCategoryInfo          : NotSpecified: (:) [Get-FormatData], InvalidCastException\r\nFullyQualifiedErrorId :\r\nSystem.InvalidCastException,Microsoft.PowerShell.Commands.GetFormatDataCommand\r\nInvocationInfo        :\r\n    MyCommand        : Get-FormatData\r\n    ScriptLineNumber : 1\r\n    OffsetInLine     : 10\r\n    HistoryId        : 8\r\n    Line             : $after = Get-FormatData\r\n    PositionMessage  : At line:1 char:10\r\n                       + $after = Get-FormatData\r\n                       +          ~~~~~~~~~~~~~~\r\n    InvocationName   : Get-FormatData\r\n    CommandOrigin    : Internal\r\nScriptStackTrace      : at <ScriptBlock>, <No file>: line 1\r\n```\r\n\r\nThat's this method:\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/658837323599ab1c7a81fe66fcd43f7420e4402b/src/System.Management.Automation/FormatAndOutput/common/DisplayDatabase/displayDescriptionData_Complex.cs#L175-L246\r\n\r\nSpecifically, when debugging it, we hit this line:\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/658837323599ab1c7a81fe66fcd43f7420e4402b/src/System.Management.Automation/FormatAndOutput/common/DisplayDatabase/displayDescriptionData_Complex.cs#L231\r\n\r\nOn that line in this instance, `cpt.control` is of type `Microsoft.PowerShell.Commands.Internal.Format.ControlReference`, which has no cast to `Microsoft.PowerShell.Commands.Internal.Format.ControlBody`. Instead it looks like it might want to use this method:\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/658837323599ab1c7a81fe66fcd43f7420e4402b/src/System.Management.Automation/FormatAndOutput/common/DisplayDatabase/typeDataQuery.cs#L643-L654\r\n\r\nI have no experience with that code unfortunately, so I'm not sure to what extent those changes would fix things. Certainly it seems that the `ResolveControlReference()` method requires more context than we currently have where the code fails.",
    "created_at": "2021-05-25T20:34:42Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/15413#issuecomment-848241635",
    "id": 848241635,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15413",
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0ODI0MTYzNQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/848241635/reactions"
    },
    "updated_at": "2021-05-25T20:36:03Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/848241635",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/7009879?v=4",
      "events_url": "https://api.github.com/users/rjmholt/events{/privacy}",
      "followers_url": "https://api.github.com/users/rjmholt/followers",
      "following_url": "https://api.github.com/users/rjmholt/following{/other_user}",
      "gists_url": "https://api.github.com/users/rjmholt/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/rjmholt",
      "id": 7009879,
      "login": "rjmholt",
      "node_id": "MDQ6VXNlcjcwMDk4Nzk=",
      "organizations_url": "https://api.github.com/users/rjmholt/orgs",
      "received_events_url": "https://api.github.com/users/rjmholt/received_events",
      "repos_url": "https://api.github.com/users/rjmholt/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/rjmholt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rjmholt/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/rjmholt"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the triage and acknowledgement of the bug :)\r\n\r\nI can add that formatdata using CustomControl are often never shown by `Get-FormatData`, even when embedding the customcontrols. Views using the other PSControl-classes behaves as they should.\r\n\r\nNot sure if this is caused by the same part or if it should be a different issue.",
    "created_at": "2021-05-30T22:24:05Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/15413#issuecomment-851070316",
    "id": 851070316,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/15413",
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MTA3MDMxNg==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/851070316/reactions"
    },
    "updated_at": "2021-06-12T23:38:35Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/851070316",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/3436158?v=4",
      "events_url": "https://api.github.com/users/fflaten/events{/privacy}",
      "followers_url": "https://api.github.com/users/fflaten/followers",
      "following_url": "https://api.github.com/users/fflaten/following{/other_user}",
      "gists_url": "https://api.github.com/users/fflaten/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/fflaten",
      "id": 3436158,
      "login": "fflaten",
      "node_id": "MDQ6VXNlcjM0MzYxNTg=",
      "organizations_url": "https://api.github.com/users/fflaten/orgs",
      "received_events_url": "https://api.github.com/users/fflaten/received_events",
      "repos_url": "https://api.github.com/users/fflaten/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/fflaten/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fflaten/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/fflaten"
    }
  }
]
