[
  {
    "author_association": "MEMBER",
    "body": "cc @TravisEz13 @PaulHigin ",
    "created_at": "2018-10-31T00:49:51Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8150#issuecomment-434522334",
    "id": 434522334,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8150",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDUyMjMzNA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434522334/reactions"
    },
    "updated_at": "2018-10-31T00:49:51Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434522334",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/11859881?v=4",
      "events_url": "https://api.github.com/users/SteveL-MSFT/events{/privacy}",
      "followers_url": "https://api.github.com/users/SteveL-MSFT/followers",
      "following_url": "https://api.github.com/users/SteveL-MSFT/following{/other_user}",
      "gists_url": "https://api.github.com/users/SteveL-MSFT/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/SteveL-MSFT",
      "id": 11859881,
      "login": "SteveL-MSFT",
      "node_id": "MDQ6VXNlcjExODU5ODgx",
      "organizations_url": "https://api.github.com/users/SteveL-MSFT/orgs",
      "received_events_url": "https://api.github.com/users/SteveL-MSFT/received_events",
      "repos_url": "https://api.github.com/users/SteveL-MSFT/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/SteveL-MSFT/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/SteveL-MSFT/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/SteveL-MSFT"
    }
  },
  {
    "author_association": "MEMBER",
    "body": "@OmerYa Please be sure to follow our security issue reporting process documented here: https://github.com/PowerShell/PowerShell/blob/master/docs/maintainers/issue-management.md#security-vulnerabilities",
    "created_at": "2018-10-31T00:52:46Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8150#issuecomment-434522775",
    "id": 434522775,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8150",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDUyMjc3NQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434522775/reactions"
    },
    "updated_at": "2018-10-31T00:52:46Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434522775",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/10873629?v=4",
      "events_url": "https://api.github.com/users/TravisEz13/events{/privacy}",
      "followers_url": "https://api.github.com/users/TravisEz13/followers",
      "following_url": "https://api.github.com/users/TravisEz13/following{/other_user}",
      "gists_url": "https://api.github.com/users/TravisEz13/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/TravisEz13",
      "id": 10873629,
      "login": "TravisEz13",
      "node_id": "MDQ6VXNlcjEwODczNjI5",
      "organizations_url": "https://api.github.com/users/TravisEz13/orgs",
      "received_events_url": "https://api.github.com/users/TravisEz13/received_events",
      "repos_url": "https://api.github.com/users/TravisEz13/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/TravisEz13/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TravisEz13/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/TravisEz13"
    }
  },
  {
    "author_association": "NONE",
    "body": "@TravisEz13 The issue was already reported to Microsoft Security Response Center and got approval for publishing.",
    "created_at": "2018-10-31T07:23:48Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8150#issuecomment-434586709",
    "id": 434586709,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8150",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDU4NjcwOQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434586709/reactions"
    },
    "updated_at": "2018-10-31T07:23:48Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434586709",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22572520?v=4",
      "events_url": "https://api.github.com/users/OmerYa/events{/privacy}",
      "followers_url": "https://api.github.com/users/OmerYa/followers",
      "following_url": "https://api.github.com/users/OmerYa/following{/other_user}",
      "gists_url": "https://api.github.com/users/OmerYa/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/OmerYa",
      "id": 22572520,
      "login": "OmerYa",
      "node_id": "MDQ6VXNlcjIyNTcyNTIw",
      "organizations_url": "https://api.github.com/users/OmerYa/orgs",
      "received_events_url": "https://api.github.com/users/OmerYa/received_events",
      "repos_url": "https://api.github.com/users/OmerYa/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/OmerYa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/OmerYa/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/OmerYa"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "Thanks @OmerYa.\r\n\r\nThe AMSI bypass via dotNet reflection (as reported by Matt Graeber) is a known issue.\r\n\r\n`Powershell's responsibility is to accurately report through AMSI the exact command being executed and this is the \"bug\" I ask to address. On the example above, Powershell sends the obfuscated command to AMSI (which causes Windows Defender to miss the malicious content).`\r\n\r\nI don't agree with this.  AV engines have signatures based on commands typed at the command line and scripts as they are run, and I feel that shouldn't change.  In any case changing it will break existing AV signatures.  In addition, a high degree of obfuscation can, in itself, be an indicator of malicious code.\r\n\r\nI am not sure I understand your comments on the use of ScanContent.  Can you provide examples in your description where ScanContent is not covering executing script?\r\n\r\n",
    "created_at": "2018-10-31T16:55:16Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8150#issuecomment-434765035",
    "id": 434765035,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8150",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDc2NTAzNQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434765035/reactions"
    },
    "updated_at": "2018-10-31T16:55:16Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434765035",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/14019529?v=4",
      "events_url": "https://api.github.com/users/PaulHigin/events{/privacy}",
      "followers_url": "https://api.github.com/users/PaulHigin/followers",
      "following_url": "https://api.github.com/users/PaulHigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulHigin/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/PaulHigin",
      "id": 14019529,
      "login": "PaulHigin",
      "node_id": "MDQ6VXNlcjE0MDE5NTI5",
      "organizations_url": "https://api.github.com/users/PaulHigin/orgs",
      "received_events_url": "https://api.github.com/users/PaulHigin/received_events",
      "repos_url": "https://api.github.com/users/PaulHigin/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/PaulHigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulHigin/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/PaulHigin"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "I think I mis-read the idea of providing non-obfuscated text to AMSI.  If we do it in a new stream then we are adding information and not changing existing reporting.  I think this would be a definite improvement since it means giving more information to AV engines.",
    "created_at": "2018-10-31T22:52:54Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8150#issuecomment-434874823",
    "id": 434874823,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8150",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDg3NDgyMw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434874823/reactions"
    },
    "updated_at": "2018-10-31T22:52:54Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434874823",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/14019529?v=4",
      "events_url": "https://api.github.com/users/PaulHigin/events{/privacy}",
      "followers_url": "https://api.github.com/users/PaulHigin/followers",
      "following_url": "https://api.github.com/users/PaulHigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulHigin/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/PaulHigin",
      "id": 14019529,
      "login": "PaulHigin",
      "node_id": "MDQ6VXNlcjE0MDE5NTI5",
      "organizations_url": "https://api.github.com/users/PaulHigin/orgs",
      "received_events_url": "https://api.github.com/users/PaulHigin/received_events",
      "repos_url": "https://api.github.com/users/PaulHigin/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/PaulHigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulHigin/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/PaulHigin"
    }
  },
  {
    "author_association": "NONE",
    "body": "That is where I was aiming - adding more information to AV engines.\r\n\r\nThe current implementation missed in three major cases as I outlined above. The first two issues arise from the position ScanContent is being called right now - before ScriptBlock compilation. This compilation happens only if command discovery decides to use a DlrCommandProcessor. If on the other hand the command discovery creates CommandProcessor or NativeCommandProcessor to handle the command, the script won't be sent to ScanContent at all.\r\n\r\nThe third issue I mention is about binding - consider the following code (variation on the above script):\r\n```\r\n$s = 'System.Management .Aut'\r\n$s += 'omation.A'\r\n$s += 'msiUtils'\r\n[Ref].Assembly.GetType($s)\r\n```\r\nIt won't be considered obfuscated as all it uses is string concatenation though it achieves the same result (and bypasses Defender's signature). The reason this script bypasses detection is because Defender receives `[Ref].Assembly.GetType($s)` where `$s` has no meaning for it though it contains a string that otherwise would have been blocked.\r\nSince `$s` is a bound parameter, it's value is known only during runtime and not before compilation (when ScanContent is called). I suggest tracking bound invocations on top of the current ScanContent calls. @LeeHolmes has some very good suggestions on how this can be implemented.\r\n\r\nThe runtime behavior is even more dangerous - consider the following code:\r\n```\r\n$s = 'System.String'\r\n[Ref].Assembly.GetType($s)\r\n$s = 'System.Management .Aut'\r\n$s += 'omation.A'\r\n$s += 'msiUtils'\r\n[Ref].Assembly.GetType($s)\r\n```\r\nSince the same line of code `[Ref].Assembly.GetType($s)` is called twice (correct me if I'm wrong) - the code will be cached. The first time it is called $s will contain legitimate string but on the second call it will fetch a dangerous object that should be blocked. The only way to track this behavior is if the call to ScanContent happens right before the bound invocation when the variable value is known.",
    "created_at": "2018-11-01T09:54:46Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8150#issuecomment-434990064",
    "id": 434990064,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8150",
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzNDk5MDA2NA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 1,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 1,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434990064/reactions"
    },
    "updated_at": "2018-11-01T09:54:46Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/434990064",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/22572520?v=4",
      "events_url": "https://api.github.com/users/OmerYa/events{/privacy}",
      "followers_url": "https://api.github.com/users/OmerYa/followers",
      "following_url": "https://api.github.com/users/OmerYa/following{/other_user}",
      "gists_url": "https://api.github.com/users/OmerYa/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/OmerYa",
      "id": 22572520,
      "login": "OmerYa",
      "node_id": "MDQ6VXNlcjIyNTcyNTIw",
      "organizations_url": "https://api.github.com/users/OmerYa/orgs",
      "received_events_url": "https://api.github.com/users/OmerYa/received_events",
      "repos_url": "https://api.github.com/users/OmerYa/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/OmerYa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/OmerYa/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/OmerYa"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "WG-Security:\r\nWe want to accommodate AMSI providers, and this sounds like a reasonable request.  Marking it as an enhancement for 7.2 consideration.\r\n\r\nThis is an impactful change that needs to be coordinated with AMSI providers, since we assume requires re-training and perhaps include tags to define the reporting format.",
    "created_at": "2021-06-21T21:21:44Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8150#issuecomment-865353386",
    "id": 865353386,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8150",
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2NTM1MzM4Ng==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/865353386/reactions"
    },
    "updated_at": "2021-06-21T21:21:44Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/865353386",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/14019529?v=4",
      "events_url": "https://api.github.com/users/PaulHigin/events{/privacy}",
      "followers_url": "https://api.github.com/users/PaulHigin/followers",
      "following_url": "https://api.github.com/users/PaulHigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulHigin/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/PaulHigin",
      "id": 14019529,
      "login": "PaulHigin",
      "node_id": "MDQ6VXNlcjE0MDE5NTI5",
      "organizations_url": "https://api.github.com/users/PaulHigin/orgs",
      "received_events_url": "https://api.github.com/users/PaulHigin/received_events",
      "repos_url": "https://api.github.com/users/PaulHigin/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/PaulHigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulHigin/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/PaulHigin"
    }
  },
  {
    "author_association": "COLLABORATOR",
    "body": "WG-Security\r\nMoving to 7.3 consider.",
    "created_at": "2021-08-23T21:19:52Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/8150#issuecomment-904141195",
    "id": 904141195,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/8150",
    "node_id": "IC_kwDOAvT7bc415BmL",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/904141195/reactions"
    },
    "updated_at": "2021-08-23T21:19:52Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/904141195",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/14019529?v=4",
      "events_url": "https://api.github.com/users/PaulHigin/events{/privacy}",
      "followers_url": "https://api.github.com/users/PaulHigin/followers",
      "following_url": "https://api.github.com/users/PaulHigin/following{/other_user}",
      "gists_url": "https://api.github.com/users/PaulHigin/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/PaulHigin",
      "id": 14019529,
      "login": "PaulHigin",
      "node_id": "MDQ6VXNlcjE0MDE5NTI5",
      "organizations_url": "https://api.github.com/users/PaulHigin/orgs",
      "received_events_url": "https://api.github.com/users/PaulHigin/received_events",
      "repos_url": "https://api.github.com/users/PaulHigin/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/PaulHigin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PaulHigin/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/PaulHigin"
    }
  }
]
