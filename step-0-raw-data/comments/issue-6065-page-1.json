[
  {
    "author_association": "CONTRIBUTOR",
    "body": "Hmm I'd have to craft an endpoint to reproduce this. I suspect it is due to our striping of authorization headers on redirect. Rather than letting HttpClient handle the redirect, we handle it manual to prevent authorization headers from being sent. i suspect that when we do that, somehow the cookies are not being set on the cookie container.",
    "created_at": "2018-01-29T23:35:15Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/6065#issuecomment-361424389",
    "id": 361424389,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/6065",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MTQyNDM4OQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/361424389/reactions"
    },
    "updated_at": "2018-01-29T23:35:15Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/361424389",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/6509955?v=4",
      "events_url": "https://api.github.com/users/markekraus/events{/privacy}",
      "followers_url": "https://api.github.com/users/markekraus/followers",
      "following_url": "https://api.github.com/users/markekraus/following{/other_user}",
      "gists_url": "https://api.github.com/users/markekraus/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/markekraus",
      "id": 6509955,
      "login": "markekraus",
      "node_id": "MDQ6VXNlcjY1MDk5NTU=",
      "organizations_url": "https://api.github.com/users/markekraus/orgs",
      "received_events_url": "https://api.github.com/users/markekraus/received_events",
      "repos_url": "https://api.github.com/users/markekraus/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/markekraus/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/markekraus/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/markekraus"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "After creating a custom endpoint, I am not able to reproduce this issue. \r\n\r\nUpon further checking the code, we are setting the `HttpClientHandler.CookieContainer` to the `WebSession.Cookies` every time we build the request.\r\n\r\nhttps://github.com/PowerShell/PowerShell/blob/bd865280f36ea127414395d724cff1c778ddba73/src/Microsoft.PowerShell.Commands.Utility/commands/utility/WebCmdlet/Common/WebRequestPSCmdlet.Common.cs#L898\r\n\r\nI'm using this simple ASP.NET app https://github.com/markekraus/RedirectCookieAuth/\r\n\r\nthen in PowerShell 6.0.1:\r\n\r\n```powershell\r\n$uri = 'http://localhost:5000/api/Redirect'\r\n$username = \"username\"\r\n$password = \"password\"\r\n$pair = \"${username}:${password}\"\r\n$bytes = [System.Text.Encoding]::ASCII.GetBytes($pair)\r\n$base64 = [System.Convert]::ToBase64String($bytes)\r\n$basicAuth = \"Basic $base64\"\r\n$headers = @{ Authorization = $basicAuth }\r\nInvoke-WebRequest -Uri $uri -Headers $headers -OutFile \"c:\\temp\\output.json\" -SessionVariable cookie_jar\r\nGet-Content \"c:\\temp\\output.json\" | ConvertFrom-Json | ConvertTo-Json\r\n``` \r\n\r\nresult:\r\n\r\n```json\r\n{\r\n  \"args\": {},\r\n  \"origin\": \"::1\",\r\n  \"headers\": {\r\n    \"Cookie\": \"special=test123\",\r\n    \"Host\": \"localhost:5000\",\r\n    \"Connection\": \"Keep-Alive\",\r\n    \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Microsoft Windows 10.0.16299; en-US) PowerShell/6.0.1\"\r\n  },\r\n  \"method\": \"GET\",\r\n  \"url\": \"http://localhost:5000/api/Get/\"\r\n}\r\n```\r\n\r\nBasically, `http://localhost:5000/api/Redirect` sets the `special` cookie to `test123` then redirects to `http://localhost:5000/api/Get/` which then spits out the details of the request, including the headers. You can see in the headers collection the `Cookie` request header shows the `special=test123` value.",
    "created_at": "2018-01-30T00:35:06Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/6065#issuecomment-361435767",
    "id": 361435767,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/6065",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MTQzNTc2Nw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/361435767/reactions"
    },
    "updated_at": "2018-01-30T00:35:06Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/361435767",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/6509955?v=4",
      "events_url": "https://api.github.com/users/markekraus/events{/privacy}",
      "followers_url": "https://api.github.com/users/markekraus/followers",
      "following_url": "https://api.github.com/users/markekraus/following{/other_user}",
      "gists_url": "https://api.github.com/users/markekraus/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/markekraus",
      "id": 6509955,
      "login": "markekraus",
      "node_id": "MDQ6VXNlcjY1MDk5NTU=",
      "organizations_url": "https://api.github.com/users/markekraus/orgs",
      "received_events_url": "https://api.github.com/users/markekraus/received_events",
      "repos_url": "https://api.github.com/users/markekraus/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/markekraus/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/markekraus/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/markekraus"
    }
  },
  {
    "author_association": "NONE",
    "body": "Thanks @markekraus. Something else must be going on in my environment.\r\n",
    "created_at": "2018-03-27T21:52:20Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/6065#issuecomment-376688030",
    "id": 376688030,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/6065",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3NjY4ODAzMA==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/376688030/reactions"
    },
    "updated_at": "2018-03-27T21:52:20Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/376688030",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/814813?v=4",
      "events_url": "https://api.github.com/users/nutjob4life/events{/privacy}",
      "followers_url": "https://api.github.com/users/nutjob4life/followers",
      "following_url": "https://api.github.com/users/nutjob4life/following{/other_user}",
      "gists_url": "https://api.github.com/users/nutjob4life/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/nutjob4life",
      "id": 814813,
      "login": "nutjob4life",
      "node_id": "MDQ6VXNlcjgxNDgxMw==",
      "organizations_url": "https://api.github.com/users/nutjob4life/orgs",
      "received_events_url": "https://api.github.com/users/nutjob4life/received_events",
      "repos_url": "https://api.github.com/users/nutjob4life/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/nutjob4life/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nutjob4life/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/nutjob4life"
    }
  },
  {
    "author_association": "NONE",
    "body": "Hello, I stumbled on this issue and can provide more context: if I submit a request with an Authentication header to a non IIS webserver, and the web server does not return a cookie, the subsequent request fails because the Authentication header is now missing, causing a http 401 (access denied).\r\nA workaround is to use the MaximumRedirection option: \r\n`invoke-webrequest -method get -uri \"-host_stripped-\" -MaximumRedirection 0 -erroraction silentlycontinue -errorvariable redirecterror` \r\nand use the Location value to create a new request (with Authentication header) until I no longer receive HTTP 301 or HTTP 302 and then return the final result.\r\n\r\nHere is an example of the requests on our server:\r\nFirst request\r\nGET https://-host_stripped-.com/api/device HTTP/1.1\r\nAuthorization: Basic -stripped-\r\nUser-Agent: Mozilla/5.0 (Windows NT; Windows NT 10.0; nl-BE) WindowsPowerShell/5.1.15063.936\r\nContent-Type: application/json; charset=utf-8\r\nHost: -host_stripped-.com\r\n\r\nFirst response\r\nHTTP/1.1 302 Found\r\nServer: nginx\r\nDate: Wed, 18 Apr 2018 22:44:35 GMT\r\nContent-Type: application/json\r\nConnection: keep-alive\r\nLocation: /api/device?limit=100\r\nCache-Control: private, no-cache, must-revalidate, no-store, max-age=0, post-check=0, pre-check=0\r\nX-status-message: device index requires a limit\r\nX-status-code: FOUND\r\nVary: Accept-Encoding\r\nStrict-Transport-Security: max-age=157680000\r\nContent-Length: 3121\r\n----json file---\r\n\r\nSecond request, append previous 'Location' value in uri\r\nGET https://-host_stripped-.com/api/device?limit=100 HTTP/1.1\r\nAuthorization: Basic -stripped-\r\nUser-Agent: Mozilla/5.0 (Windows NT; Windows NT 10.0; nl-BE) WindowsPowerShell/5.1.15063.936\r\nContent-Type: application/json; charset=utf-8\r\nHost: -host_stripped_.com\r\n\r\nSecond response\r\nHTTP/1.1 200 OK\r\nServer: nginx\r\nDate: Wed, 18 Apr 2018 23:02:11 GMT\r\nContent-Type: application/json\r\nConnection: keep-alive\r\nCache-Control: private, no-cache, must-revalidate, no-store, max-age=0, post-check=0, pre-check=0\r\nX-status-message: device index found with 5052 resources.\r\nX-status-code: OK\r\nVary: Accept-Encoding\r\nStrict-Transport-Security: max-age=157680000\r\nContent-Length: 9290\r\n--json file---\r\n",
    "created_at": "2018-04-18T23:09:39Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/6065#issuecomment-382557336",
    "id": 382557336,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/6065",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MjU1NzMzNg==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/382557336/reactions"
    },
    "updated_at": "2018-04-18T23:09:39Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/382557336",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/34503431?v=4",
      "events_url": "https://api.github.com/users/trir262/events{/privacy}",
      "followers_url": "https://api.github.com/users/trir262/followers",
      "following_url": "https://api.github.com/users/trir262/following{/other_user}",
      "gists_url": "https://api.github.com/users/trir262/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/trir262",
      "id": 34503431,
      "login": "trir262",
      "node_id": "MDQ6VXNlcjM0NTAzNDMx",
      "organizations_url": "https://api.github.com/users/trir262/orgs",
      "received_events_url": "https://api.github.com/users/trir262/received_events",
      "repos_url": "https://api.github.com/users/trir262/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/trir262/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/trir262/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/trir262"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "@trir262 When the web endpoint redirects and you supply and authorization header, you need to use the `-PreserveAuthorizationOnRedirect` switch or else the Authorization header will be stripped as a security measure.\r\n\r\nWorking example:\r\n\r\n```powershell\r\nInvoke-WebRequest -Uri 'https://httpbin.org/redirect-to?url=https://httpbin.org/basic-auth/user/passwd' -Header @{Authorization = 'Basic dXNlcjpwYXNzd2Q=' } -PreserveAuthorizationOnRedirect\r\n```\r\n\r\nThis 302 redirects to an authentication endpoint and preserves the Authorization header. Issuing the same command without `-PreserveAuthorizationOnRedirect` will result in a 401 response.\r\n\r\n\r\n\r\n[More Info.](https://get-powershellblog.blogspot.com/2017/12/powershell-core-web-cmdlets-in-depth_24.html#L17)",
    "created_at": "2018-04-19T00:07:04Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/6065#issuecomment-382567317",
    "id": 382567317,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/6065",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MjU2NzMxNw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/382567317/reactions"
    },
    "updated_at": "2018-04-19T00:07:04Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/382567317",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/6509955?v=4",
      "events_url": "https://api.github.com/users/markekraus/events{/privacy}",
      "followers_url": "https://api.github.com/users/markekraus/followers",
      "following_url": "https://api.github.com/users/markekraus/following{/other_user}",
      "gists_url": "https://api.github.com/users/markekraus/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/markekraus",
      "id": 6509955,
      "login": "markekraus",
      "node_id": "MDQ6VXNlcjY1MDk5NTU=",
      "organizations_url": "https://api.github.com/users/markekraus/orgs",
      "received_events_url": "https://api.github.com/users/markekraus/received_events",
      "repos_url": "https://api.github.com/users/markekraus/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/markekraus/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/markekraus/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/markekraus"
    }
  },
  {
    "author_association": "NONE",
    "body": "Thank you @markekraus ! This option is indeed what I was looking for. Unfortunately 5.1 does not have this.\r\nApologies for the confusion.",
    "created_at": "2018-04-19T05:41:51Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/6065#issuecomment-382616753",
    "id": 382616753,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/6065",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MjYxNjc1Mw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/382616753/reactions"
    },
    "updated_at": "2018-04-19T06:23:45Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/382616753",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/34503431?v=4",
      "events_url": "https://api.github.com/users/trir262/events{/privacy}",
      "followers_url": "https://api.github.com/users/trir262/followers",
      "following_url": "https://api.github.com/users/trir262/following{/other_user}",
      "gists_url": "https://api.github.com/users/trir262/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/trir262",
      "id": 34503431,
      "login": "trir262",
      "node_id": "MDQ6VXNlcjM0NTAzNDMx",
      "organizations_url": "https://api.github.com/users/trir262/orgs",
      "received_events_url": "https://api.github.com/users/trir262/received_events",
      "repos_url": "https://api.github.com/users/trir262/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/trir262/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/trir262/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/trir262"
    }
  },
  {
    "author_association": "CONTRIBUTOR",
    "body": "@trir262 Correct. This is a new feature added in PowerShell 6.0.0. If this is an impacting issue for you in 5.1, I would suggest opening a [UserVoice](https://windowsserver.uservoice.com/forums/301869-powershell) or perhaps voting on an existing one.",
    "created_at": "2018-04-19T09:10:47Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/6065#issuecomment-382665956",
    "id": 382665956,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/6065",
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MjY2NTk1Ng==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/382665956/reactions"
    },
    "updated_at": "2018-04-19T09:10:47Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/382665956",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/6509955?v=4",
      "events_url": "https://api.github.com/users/markekraus/events{/privacy}",
      "followers_url": "https://api.github.com/users/markekraus/followers",
      "following_url": "https://api.github.com/users/markekraus/following{/other_user}",
      "gists_url": "https://api.github.com/users/markekraus/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/markekraus",
      "id": 6509955,
      "login": "markekraus",
      "node_id": "MDQ6VXNlcjY1MDk5NTU=",
      "organizations_url": "https://api.github.com/users/markekraus/orgs",
      "received_events_url": "https://api.github.com/users/markekraus/received_events",
      "repos_url": "https://api.github.com/users/markekraus/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/markekraus/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/markekraus/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/markekraus"
    }
  }
]
