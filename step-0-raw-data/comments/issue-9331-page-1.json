[
  {
    "author_association": "NONE",
    "body": "Does anyone have an answer to this question?",
    "created_at": "2019-09-18T11:55:45Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/9331#issuecomment-532650993",
    "id": 532650993,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/9331",
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMjY1MDk5Mw==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/532650993/reactions"
    },
    "updated_at": "2019-09-18T11:55:45Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/532650993",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/3007180?v=4",
      "events_url": "https://api.github.com/users/jonkeda/events{/privacy}",
      "followers_url": "https://api.github.com/users/jonkeda/followers",
      "following_url": "https://api.github.com/users/jonkeda/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonkeda/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/jonkeda",
      "id": 3007180,
      "login": "jonkeda",
      "node_id": "MDQ6VXNlcjMwMDcxODA=",
      "organizations_url": "https://api.github.com/users/jonkeda/orgs",
      "received_events_url": "https://api.github.com/users/jonkeda/received_events",
      "repos_url": "https://api.github.com/users/jonkeda/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/jonkeda/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonkeda/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/jonkeda"
    }
  },
  {
    "author_association": "NONE",
    "body": "I posted this question on stack overflow: https://stackoverflow.com/questions/57331089/sspi-sql-access-fails-in-remote-powershell-request-due-to-double-hop-failure-co\r\n\r\nit was suggested to check for the SPN and authentication scheme. will reply here if i make progress.\n\n<blockquote><img src=\"https://cdn.sstatic.net/Sites/stackoverflow/img/apple-touch-icon@2.png?v=73d79a89bded\" width=\"48\" align=\"right\"><div>Stack Overflow</div><div><strong><a href=\"https://stackoverflow.com/questions/57331089/sspi-sql-access-fails-in-remote-powershell-request-due-to-double-hop-failure-co\">SSPI sql access fails in remote powershell request due to double-hop failure, constrained delegation</a></strong></div><div>We are trying to run an automated install from serverA on remote serverB which needs to talk to sql serverC using windows authentication.\n\nInvoke-Command -ComputerName serverB -ScriptBlock {\n\n    $...</div></blockquote>",
    "created_at": "2019-09-20T18:24:12Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/9331#issuecomment-533661411",
    "id": 533661411,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/9331",
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMzY2MTQxMQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/533661411/reactions"
    },
    "updated_at": "2019-09-20T18:24:14Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/533661411",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/20322509?v=4",
      "events_url": "https://api.github.com/users/lachlann562/events{/privacy}",
      "followers_url": "https://api.github.com/users/lachlann562/followers",
      "following_url": "https://api.github.com/users/lachlann562/following{/other_user}",
      "gists_url": "https://api.github.com/users/lachlann562/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/lachlann562",
      "id": 20322509,
      "login": "lachlann562",
      "node_id": "MDQ6VXNlcjIwMzIyNTA5",
      "organizations_url": "https://api.github.com/users/lachlann562/orgs",
      "received_events_url": "https://api.github.com/users/lachlann562/received_events",
      "repos_url": "https://api.github.com/users/lachlann562/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/lachlann562/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lachlann562/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/lachlann562"
    }
  },
  {
    "author_association": "NONE",
    "body": "We finally got this to work:\r\n1) Register the SPN for sql server in active directory using:\r\n`\r\nSetSPN â€“A MSSQLSvc/<sqlserver>.<DomainName>:<port> <sql service AccountName>\r\n`\r\n2) enable kerberos delagation for server \"B\" in active directory. Enable the option \"trust this computer for delegation to any server (Kerberos only)\" in the delegation tab of the computer account.\r\n\r\nsee https://support.microsoft.com/en-ca/help/909801/how-to-make-sure-that-you-are-using-kerberos-authentication-when-you-c\r\n\r\nthe following code can be used to test if the connection is possible to be made using kerberose (when not using double hop), look at the auth_scheme column:\r\n ```\r\n   $conn = new-object System.Data.SqlClient.SqlConnection 'Data Source=demodbca02\\demo16;Initial Catalog=master;Integrated Security=SSPI'\r\n    $conn.open()\r\n    $cmd = New-Object System.Data.SqlClient.SqlCommand 'select * from sys.dm_exec_connections where session_id=@@spid',$conn\r\n    #get field name/positions\r\n\t$SQLReader = $cmd.ExecuteReader()\r\n    $columns = @()\r\n\tfor ($i = 0 ; $i -lt $SQLReader.FieldCount ; $I++)\r\n\t{\r\n\t\t$columns += $SQLReader.GetName($i)\r\n\t}\r\n    #$SQLReader.Read()\r\n\tforeach ($row in $SQLReader)\r\n\t{\r\n        $info = @{}\r\n\t\tforeach ($col in $columns)\r\n\t\t{\r\n\t\t\t$info[$col] = $row.Item($col)\r\n\t\t}\r\n\t\t\t\t\r\n\t\t[pscustomobject]$info\r\n\t\t\t\t\r\n\t}\r\n    $SQLReader.Close()\r\n    $conn.Dispose()\r\n\r\n```\r\n\r\nhere is minimal code to test double-hop for sql\r\n```\r\n#run from server a\r\n\r\nInvoke-Command -ComputerName serverB -ScriptBlock {\r\n    \r\n    $conn = new-object System.Data.SqlClient.SqlConnection 'Data Source=ServerC;Initial Catalog=master;Integrated Security=SSPI'\r\n    try\r\n    {\r\n        $conn.open()\r\n    } finally {\r\n        $conn | Remove-SQLConnection\r\n    }\r\n\r\n} -Credential $cred \r\n```\r\n<blockquote><img src=\"//www.microsoft.com/favicon.ico?v2\" width=\"48\" align=\"right\"></blockquote>",
    "created_at": "2019-09-20T19:41:01Z",
    "html_url": "https://github.com/PowerShell/PowerShell/issues/9331#issuecomment-533684701",
    "id": 533684701,
    "issue_url": "https://api.github.com/repos/PowerShell/PowerShell/issues/9331",
    "node_id": "MDEyOklzc3VlQ29tbWVudDUzMzY4NDcwMQ==",
    "performed_via_github_app": null,
    "reactions": {
      "+1": 0,
      "-1": 0,
      "confused": 0,
      "eyes": 0,
      "heart": 0,
      "hooray": 0,
      "laugh": 0,
      "rocket": 0,
      "total_count": 0,
      "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/533684701/reactions"
    },
    "updated_at": "2019-09-20T20:19:46Z",
    "url": "https://api.github.com/repos/PowerShell/PowerShell/issues/comments/533684701",
    "user": {
      "avatar_url": "https://avatars.githubusercontent.com/u/20322509?v=4",
      "events_url": "https://api.github.com/users/lachlann562/events{/privacy}",
      "followers_url": "https://api.github.com/users/lachlann562/followers",
      "following_url": "https://api.github.com/users/lachlann562/following{/other_user}",
      "gists_url": "https://api.github.com/users/lachlann562/gists{/gist_id}",
      "gravatar_id": "",
      "html_url": "https://github.com/lachlann562",
      "id": 20322509,
      "login": "lachlann562",
      "node_id": "MDQ6VXNlcjIwMzIyNTA5",
      "organizations_url": "https://api.github.com/users/lachlann562/orgs",
      "received_events_url": "https://api.github.com/users/lachlann562/received_events",
      "repos_url": "https://api.github.com/users/lachlann562/repos",
      "site_admin": false,
      "starred_url": "https://api.github.com/users/lachlann562/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lachlann562/subscriptions",
      "type": "User",
      "url": "https://api.github.com/users/lachlann562"
    }
  }
]
